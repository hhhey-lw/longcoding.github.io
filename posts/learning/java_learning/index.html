<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Java学习笔记 | LongCoding&#39;s Blog</title>
<meta name="keywords" content="Java">
<meta name="description" content="Java 反射
它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。
1. 动态加载类
在运行时根据类名动态加载类，而不是在编译时硬编码类名。 &ndash; 插件化架构：根据配置文件或用户输入动态加载类。
2. 创建对象
通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。

工厂模式：根据配置动态创建对象。
依赖注入框架：Spring 通过反射创建 Bean 实例。

3. 调用方法
通过反射可以在运行时动态调用对象的方法，即使方法是私有的。

测试框架：JUnit 通过反射调用测试方法。

4. 访问字段
通过反射可以在运行时动态访问对象的字段，即使字段是私有的

序列化和反序列化：通过反射访问对象的字段。
对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。

7. 注解处理
通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。
24/4/14
1️⃣ 反射的作用

获取类中的所有信息(e.g.持久化、IDE的代码提示)

 1Field[] fields = cls.getDeclaredFields();
 2for (int i = 0; i &lt; fields.length; i&#43;&#43;) {
 3    fields[i].setAccessible(true);
 4    // String name = fields[i].getName();  // 属性名 第一次先生成列名
 5    Object value = fields[i].get(obj);
 6    bw.append(value.toString());
 7    if (i &lt; fields.length - 1) {
 8        bw.append(&#34;, &#34;);
 9    }
10}
11bw.newLine();

结合配置文件动态创建对象

 1Properties prop = new Properties();
 2
 3String filename = &#34;prop.properties&#34;;
 4FileInputStream is = new FileInputStream(filename);
 5
 6prop.load(is);
 7
 8String classname = prop.getProperty(&#34;classname&#34;);
 9String method = prop.getProperty(&#34;method&#34;);
10String name = prop.getProperty(&#34;name&#34;);
11
12Class cls = Class.forName(classname);
13Constructor con = cls.getDeclaredConstructor();
14Object o = con.newInstance();
15
16Method setName = cls.getMethod(&#34;setName&#34;, String.class);
17setName.invoke(o, name);
18
19Method met = cls.getDeclaredMethod(method);
20met.invoke(o);
2️⃣ 获取Class的三种方式">
<meta name="author" content="LongWei">
<link rel="canonical" href="http://121.40.252.207/posts/learning/java_learning/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://121.40.252.207/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://121.40.252.207/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://121.40.252.207/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://121.40.252.207/apple-touch-icon.png">
<link rel="mask-icon" href="http://121.40.252.207/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://121.40.252.207/posts/learning/java_learning/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://121.40.252.207/posts/learning/java_learning/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="Java学习笔记">
  <meta property="og:description" content="Java 反射 它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。
1. 动态加载类
在运行时根据类名动态加载类，而不是在编译时硬编码类名。 – 插件化架构：根据配置文件或用户输入动态加载类。
2. 创建对象
通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。
工厂模式：根据配置动态创建对象。 依赖注入框架：Spring 通过反射创建 Bean 实例。 3. 调用方法
通过反射可以在运行时动态调用对象的方法，即使方法是私有的。
测试框架：JUnit 通过反射调用测试方法。 4. 访问字段
通过反射可以在运行时动态访问对象的字段，即使字段是私有的
序列化和反序列化：通过反射访问对象的字段。 对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。 7. 注解处理
通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。
24/4/14
1️⃣ 反射的作用
获取类中的所有信息(e.g.持久化、IDE的代码提示) 1Field[] fields = cls.getDeclaredFields(); 2for (int i = 0; i &lt; fields.length; i&#43;&#43;) { 3 fields[i].setAccessible(true); 4 // String name = fields[i].getName(); // 属性名 第一次先生成列名 5 Object value = fields[i].get(obj); 6 bw.append(value.toString()); 7 if (i &lt; fields.length - 1) { 8 bw.append(&#34;, &#34;); 9 } 10} 11bw.newLine(); 结合配置文件动态创建对象 1Properties prop = new Properties(); 2 3String filename = &#34;prop.properties&#34;; 4FileInputStream is = new FileInputStream(filename); 5 6prop.load(is); 7 8String classname = prop.getProperty(&#34;classname&#34;); 9String method = prop.getProperty(&#34;method&#34;); 10String name = prop.getProperty(&#34;name&#34;); 11 12Class cls = Class.forName(classname); 13Constructor con = cls.getDeclaredConstructor(); 14Object o = con.newInstance(); 15 16Method setName = cls.getMethod(&#34;setName&#34;, String.class); 17setName.invoke(o, name); 18 19Method met = cls.getDeclaredMethod(method); 20met.invoke(o); 2️⃣ 获取Class的三种方式">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-04-19T00:00:00+00:00">
    <meta property="article:tag" content="Java">
      <meta property="og:image" content="http://121.40.252.207/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://121.40.252.207/papermod-cover.png">
<meta name="twitter:title" content="Java学习笔记">
<meta name="twitter:description" content="Java 反射
它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。
1. 动态加载类
在运行时根据类名动态加载类，而不是在编译时硬编码类名。 &ndash; 插件化架构：根据配置文件或用户输入动态加载类。
2. 创建对象
通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。

工厂模式：根据配置动态创建对象。
依赖注入框架：Spring 通过反射创建 Bean 实例。

3. 调用方法
通过反射可以在运行时动态调用对象的方法，即使方法是私有的。

测试框架：JUnit 通过反射调用测试方法。

4. 访问字段
通过反射可以在运行时动态访问对象的字段，即使字段是私有的

序列化和反序列化：通过反射访问对象的字段。
对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。

7. 注解处理
通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。
24/4/14
1️⃣ 反射的作用

获取类中的所有信息(e.g.持久化、IDE的代码提示)

 1Field[] fields = cls.getDeclaredFields();
 2for (int i = 0; i &lt; fields.length; i&#43;&#43;) {
 3    fields[i].setAccessible(true);
 4    // String name = fields[i].getName();  // 属性名 第一次先生成列名
 5    Object value = fields[i].get(obj);
 6    bw.append(value.toString());
 7    if (i &lt; fields.length - 1) {
 8        bw.append(&#34;, &#34;);
 9    }
10}
11bw.newLine();

结合配置文件动态创建对象

 1Properties prop = new Properties();
 2
 3String filename = &#34;prop.properties&#34;;
 4FileInputStream is = new FileInputStream(filename);
 5
 6prop.load(is);
 7
 8String classname = prop.getProperty(&#34;classname&#34;);
 9String method = prop.getProperty(&#34;method&#34;);
10String name = prop.getProperty(&#34;name&#34;);
11
12Class cls = Class.forName(classname);
13Constructor con = cls.getDeclaredConstructor();
14Object o = con.newInstance();
15
16Method setName = cls.getMethod(&#34;setName&#34;, String.class);
17setName.invoke(o, name);
18
19Method met = cls.getDeclaredMethod(method);
20met.invoke(o);
2️⃣ 获取Class的三种方式">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://121.40.252.207/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Java学习笔记",
      "item": "http://121.40.252.207/posts/learning/java_learning/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Java学习笔记",
  "name": "Java学习笔记",
  "description": "Java 反射 它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。\n1. 动态加载类\n在运行时根据类名动态加载类，而不是在编译时硬编码类名。 \u0026ndash; 插件化架构：根据配置文件或用户输入动态加载类。\n2. 创建对象\n通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。\n工厂模式：根据配置动态创建对象。 依赖注入框架：Spring 通过反射创建 Bean 实例。 3. 调用方法\n通过反射可以在运行时动态调用对象的方法，即使方法是私有的。\n测试框架：JUnit 通过反射调用测试方法。 4. 访问字段\n通过反射可以在运行时动态访问对象的字段，即使字段是私有的\n序列化和反序列化：通过反射访问对象的字段。 对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。 7. 注解处理\n通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。\n24/4/14\n1️⃣ 反射的作用\n获取类中的所有信息(e.g.持久化、IDE的代码提示) 1Field[] fields = cls.getDeclaredFields(); 2for (int i = 0; i \u0026lt; fields.length; i++) { 3 fields[i].setAccessible(true); 4 // String name = fields[i].getName(); // 属性名 第一次先生成列名 5 Object value = fields[i].get(obj); 6 bw.append(value.toString()); 7 if (i \u0026lt; fields.length - 1) { 8 bw.append(\u0026#34;, \u0026#34;); 9 } 10} 11bw.newLine(); 结合配置文件动态创建对象 1Properties prop = new Properties(); 2 3String filename = \u0026#34;prop.properties\u0026#34;; 4FileInputStream is = new FileInputStream(filename); 5 6prop.load(is); 7 8String classname = prop.getProperty(\u0026#34;classname\u0026#34;); 9String method = prop.getProperty(\u0026#34;method\u0026#34;); 10String name = prop.getProperty(\u0026#34;name\u0026#34;); 11 12Class cls = Class.forName(classname); 13Constructor con = cls.getDeclaredConstructor(); 14Object o = con.newInstance(); 15 16Method setName = cls.getMethod(\u0026#34;setName\u0026#34;, String.class); 17setName.invoke(o, name); 18 19Method met = cls.getDeclaredMethod(method); 20met.invoke(o); 2️⃣ 获取Class的三种方式\n",
  "keywords": [
    "Java"
  ],
  "articleBody": "Java 反射 它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。\n1. 动态加载类\n在运行时根据类名动态加载类，而不是在编译时硬编码类名。 – 插件化架构：根据配置文件或用户输入动态加载类。\n2. 创建对象\n通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。\n工厂模式：根据配置动态创建对象。 依赖注入框架：Spring 通过反射创建 Bean 实例。 3. 调用方法\n通过反射可以在运行时动态调用对象的方法，即使方法是私有的。\n测试框架：JUnit 通过反射调用测试方法。 4. 访问字段\n通过反射可以在运行时动态访问对象的字段，即使字段是私有的\n序列化和反序列化：通过反射访问对象的字段。 对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。 7. 注解处理\n通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。\n24/4/14\n1️⃣ 反射的作用\n获取类中的所有信息(e.g.持久化、IDE的代码提示) 1Field[] fields = cls.getDeclaredFields(); 2for (int i = 0; i \u003c fields.length; i++) { 3 fields[i].setAccessible(true); 4 // String name = fields[i].getName(); // 属性名 第一次先生成列名 5 Object value = fields[i].get(obj); 6 bw.append(value.toString()); 7 if (i \u003c fields.length - 1) { 8 bw.append(\", \"); 9 } 10} 11bw.newLine(); 结合配置文件动态创建对象 1Properties prop = new Properties(); 2 3String filename = \"prop.properties\"; 4FileInputStream is = new FileInputStream(filename); 5 6prop.load(is); 7 8String classname = prop.getProperty(\"classname\"); 9String method = prop.getProperty(\"method\"); 10String name = prop.getProperty(\"name\"); 11 12Class cls = Class.forName(classname); 13Constructor con = cls.getDeclaredConstructor(); 14Object o = con.newInstance(); 15 16Method setName = cls.getMethod(\"setName\", String.class); 17setName.invoke(o, name); 18 19Method met = cls.getDeclaredMethod(method); 20met.invoke(o); 2️⃣ 获取Class的三种方式\nClass.forname(“全类名”) 类名.class 对象.getClass() 3️⃣ 常用信息\nConstructor(构造器) Parameter(方法参数) Field(成员变量) Modifiers(权限修饰符) Method(成员方法) Declared(用于获取私有信息) Java 动态代理 无侵入的给代码添加额外的功能\n流程：\n准备：具体行为对象 + 抽象行为接口 + 代理类 执行：数据 =\u003e 代理类(抽象行为接口) =\u003e InvocationHandler.invoke 钩子之类的，插入代码\n1public interface Star (抽象接口，定义行为) 2public class BigStar implements Star (具体类名，实现行为) 3 4 5/* 6* ClassLoader: 用于加载代理类的类加载器 (具体) 7* Interface : 代理类需要实现的接口列表 (抽象) 8* InvocationHandler: execute proxy task 9*/ 10Star star = (Star) Proxy.newProxyInstance( 11 bigStar.getClass().getClassLoader(), 12 new Class[]{Star.class}, 13 new InvocationHandler() { 14 @Override 15 public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { 16 if (method.getName().equals(\"sing\")) { 17 System.out.println(\"准备话筒，收钱\"); 18 }else if (method.getName().equals(\"dance\")) { 19 System.out.println(\"准备舞台，收钱\"); 20 } 21 22 return method.invoke(bigStar, args); 23 } 24 } 25); 26 27// 使用代理 28BigStar kun = new BigStar(\"KunKun\"); 29Star proxy = ProxyUtil.createProxy(kun); 30String result = proxy.sing(\"只因你太美\"); 31System.out.println(result); Java 泛型 类型参数化\n1️⃣ 编译时检查\n不符合的编译通过不了\n2️⃣ 代码复用\n1public static \u003cT extends Number\u003e Double add(T a, T b) { 2 return a.doubleValue() + b.doubleValue(); 3} 4 5// 函数签名 用于限定参数类型 6// int float double 都OK 泛型类 1// Class指定的T会传递给成员变量和成员方法 2public class GenericClass \u003cT\u003e{ 3 private T good; 4 5 public T getGood(T var) { 6 System.out.println(var); 7 return this.good; 8 } 9 10 public void setGood(T good) { 11 this.good = good; 12 } 13} 14 15// 指定多个泛型类型 16public class MultiGenericClass\u003cK, V\u003e { 17 private K key; 18 private V value; 19 20 public K getKey() { 21 return key; 22 } 23 24 public void setKey(K key) { 25 this.key = key; 26 } 27 28 public V getValue(K key) { 29 return value; 30 } 31 32 public void setValue(V value) { 33 this.value = value; 34 } 35} 泛型接口 1// 就是实例化对象时 再指定参数类型 2public interface GenericInterface \u003cK, V\u003e{ 3 public abstract V getValue(K key); 4} 5 6class myMap\u003cK, V\u003e implements GenericInterface\u003cK, V\u003e { 7 8 private HashMap\u003cK, V\u003e map = new HashMap\u003c\u003e(); 9 10 @Override 11 public V getValue(K key) { 12 return map.get(key); 13 } 14 15 public void put(K key, V value) { 16 map.put(key, value); 17 } 18} 泛型方法 函数签名表示此方法是泛型方法，并且这个与Class的无关，限定在方法部分 作用范围！！！\n1// 泛型结合反射，动态创建对象，可以进行初始化 2public \u003cT\u003e T getObject(Class\u003cT\u003e c) throws NoSuchMethodException { 3 Constructor\u003cT\u003e constructor = c.getConstructor(); 4 T t = constructor.newInstance(); 5 return t; 6} 7 8public static \u003cT extends Number\u003e Double add(T a, T b) { 9 return a.doubleValue() + b.doubleValue(); 10} 泛型边界 1// ？ 是 父类 - 下界 2public static void funcAAA(List\u003c? super Student\u003e sList){ 3 System.out.println(sList); 4} 5 6// ？ 是 子类 - 上界 7public static void funcAA(List\u003c? extends Person\u003e pList){ 8 System.out.println(pList); 9} 泛型擦除：\n​\t为了兼容java没有泛型特性的老版本。在编译阶段会进行所谓的“类型擦除”。将所有的泛型表示（尖括号中的内容）都替换为具体的类型（其对应的原生态类型）、\n消除类型参数声明，即删除\u003c\u003e及其包围的部分。 据类型参数的上下界推断并替换所有的类型参数为原生态类型(往父类转，更包容) 自动产生“桥接方法”以保证擦除类型后的代码仍然具有泛型的“多态性” ​\n无限制类型擦除 - 和\u003c?\u003e的类型参数都被替换为Object\n有限制类型擦除 - 和\u003c? extends Number\u003e的类型参数被替换为Number，\n​\t\u003c? super Number\u003e被替换为Object\n桥接 - 编译阶段类型擦除时执行\n保证多态特性 - 因为可以多个子类继承父类，父类的类型又是泛型，不能被某个子类的泛型限制住！\n1// 父类定义 2class Pair\u003cT\u003e { 3 private T value; 4 public T getValue() { 5 return value; 6 } 7 public void setValue(T value) { 8 this.value = value; 9 } 10} 11 12// 子类定义 13class DateInter extends Pair\u003cDate\u003e { 14 15 @Override 16 public void setValue(Date value) { 17 super.setValue(value); 18 } 19 20 @Override 21 public Date getValue() { 22 return super.getValue(); 23 } 24} 25 26// 编译时 类型擦除后 27class Pair { 28 private Object value; 29 public Object getValue() { 30 return value; 31 } 32 public void setValue(Object value) { 33 this.value = value; 34 } 35} 生成中间的桥接方法，进行连接，维护多态性。\nJava 注解 1@Target({ElementType.METHOD, ElementType.PARAMETER})\t// 放置在哪 2@Retention(RetentionPolicy.RUNTIME)\t// 存活时间 3public @interface Log { 4 // 模块 5 String title() default \"\"; 6 7 // 功能 8 BusinessType businessType() default BusinessType.OTHER; 9 10 // 操作人员 11 OperatorType operatorType() default OperatorType.MANGE; 12 13 // 是否保存请求参数 14 boolean isSaveRequestData() default true; 15} 与AOP结合，实现切入\n1@Aspect\t// 给Spring托管，并且此注解标识这个类实现切入功能 2@Component 3public class LogAspect { 4 5 @Pointcut(\"@annotation(log_aop.Log)\")\t// 检测带有@Log注解的部分 6 public void logPointCut(){} 7 8 9 @Before(\"logPointCut()\")\t// 在切入点前执行操作 10 public void logPointCutBefore(JoinPoint joinPoint) { 11 System.out.println(\"在切入点前先执行\"); 12 MethodSignature signature = (MethodSignature) joinPoint.getSignature(); 13 Method method = signature.getMethod(); 14 15 System.out.println(method.getName()); 16 Log annotation = method.getAnnotation(Log.class); 17 if (annotation != null) { 18 System.out.println(annotation.title()); 19 System.out.println(annotation.isSaveRequestData()); 20 System.out.println(annotation.businessType()); 21 System.out.println(annotation.operatorType()); 22 } else { 23 System.err.println(\"没有获取到注解信息\"); 24 } 25 } 26} Spring Boot 简单实现\n1@RestController 2public class Controller { 3 4 @Log(title = \"模拟查询信息\", businessType = BusinessType.SELECT, operatorType = OperatorType.PERSON) 5 @GetMapping(\"/test\") 6 public Map\u003cString, Object\u003e test() { 7 System.out.println(\"执行处理请求操作\"); 8 HashMap\u003cString, Object\u003e map = new HashMap\u003c\u003e(); 9 map.put(\"code\", 200); 10 map.put(\"msg\", \"success\"); 11 12 return map; 13 } 14 15} Java 多线程 创建线程的三种方式 - 单继承多实现\n1public class ThreadFirstWay extends Thread{ 2 3 @Override 4 public void run() { 5 for (int i = 0; i \u003c 20; i++) { 6 System.out.println(this.getName() + \" print : \" + i); 7 } 8 } 9} 10 11new ThreadFirstWay().start() 12 13// 更灵活 14------------------------------------------------------- 15public class ThreadSecondWay implements Runnable{ 16 17 @Override 18 public void run() { 19 for (int i = 0; i \u003c 20; i++) { 20 Thread thread = Thread.currentThread(); 21 System.out.println(thread.getName() + \" print : \" + i); 22 } 23 } 24} 25 26new Thread(new ThreadSecondWay()).start() 27 28// 返回结果 29------------------------------------------------------- 30class MyCallable implements Callable\u003cInteger\u003e { 31 32 @Override 33 public Integer call() throws Exception { 34 int sum = 0; 35 for (int i = 0; i \u003c 20; i++) { 36 sum += i; 37 } 38 return sum; 39 } 40} 41 42MyCallable callable = new MyCallable(); 43FutureTask\u003cInteger\u003e task = new FutureTask\u003c\u003e(callable); 44 45Thread thread1 = new Thread(task); 46thread1.start(); 47 48Integer result = task.get(); 49System.out.println(result); 线程池 1// newCachedThreadPool: 会复用之前的线程(空闲, 超出时间会关闭) 2// newFixedThreadPool: 固定线程数，任务在阻塞队列中排队 3 4ExecutorService threadPool = Executors.newFixedThreadPool(2); 5threadPool.submit(new MyRunnable(\"@Run 1\")); 6 7// 更详细 8------------------------------------------------------- 9ThreadPoolExecutor threadPool = new ThreadPoolExecutor( 10 corePoolSize=2,\t// 核心线程 11 maximumPoolSize=3, // 临时线程 12 KeepAliveTime=60, // 临时线程存活时间 13 TimeUnit.SECONDS, 14 new ArrayBlockingQueue\u003c\u003e(3), // 阻塞队列 15 new ThreadPoolExecutor.AbortPolicy() // 默认抛出异常 16); 17 18threadPool.execute(new TestRunnable(\"@Runnable 1\")); 单生产单消费者 使用 synchronized(唯一对象) 实现临界区\n1// 单生产单消费的同步 2class Desk { 3 // 简化版 1有，0无 4 public static int foodFlag = 0; 5 6 // 总个数 7 public final static int total = 10; 8 9 // 剩余数 10 public static int count = 10; 11 12 // 锁 13 public static Object lock = new Object(); 14} 15 16// 消费者 17class Consumer extends Thread { 18 19 @SneakyThrows 20 @Override 21 public void run() { 22 while (true) { 23 synchronized (Desk.lock) { 24 // 美食家是否吃饱 25 if (Desk.count == 0) { 26 break; 27 } else { 28 // 是否做好食物 29 if(Desk.foodFlag == 0) { 30 // 等待生产者制作食物 31 Desk.lock.wait(); 32 }else { 33 // 消耗掉一份食物 34 Desk.count--; 35 36 // 吃食物 37 System.out.println(\"消费者正在吃第\" + (Desk.total-Desk.count) + \"碗食物\"); 38 39 // 通知生产者制作食物 40 Desk.lock.notifyAll(); 41 42 // 是否存在食物 43 Desk.foodFlag = 0; 44 } 45 } 46 } 47 } 48 } 49 50} 51 52 53class Producer extends Thread { 54 @SneakyThrows 55 @Override 56 public void run() { 57 while (true) { 58 // 占用桌子 59 synchronized (Desk.lock) { 60 // 美食家是否吃饱 61 if(Desk.count == 0) { 62 break; 63 }else { 64 // 上份食物是否存在 65 if(Desk.foodFlag == 1) { 66 // 等食物被吃 67 Desk.lock.wait(); 68 } else { // 制作食物 69 System.out.println(\"生产者制作第\" + (Desk.total - Desk.count + 1) + \"份食物\"); 70 71 Desk.foodFlag = 1; 72 73 Desk.lock.notifyAll(); 74 } 75 } 76 } 77 } 78 } 79} 简单抽奖 1// 简单考虑 100%中奖 2class LotteryBox extends Thread { 3 public final static int[] Pond = {2, 5, 10, 20, 50, 100, 200, 300, 500, 1000}; 4 5 public static int[] count = {10, 9, 8, 7, 6, 5, 4, 3, 2, 1}; 6 7 public static int totalNumber = 100; 8 public static Set\u003cInteger\u003e[] winningNumber = new Set[count.length]; 9 public static List\u003cInteger\u003e number = new ArrayList\u003c\u003e(); 10 11 public static int numberIdx = 0; 12 13 public static ReentrantLock lock = new ReentrantLock(); 14 15 public static void initData() { 16 // 初始化数组中的每个 Set 17 for (int i = 0; i \u003c winningNumber.length; i++) { 18 winningNumber[i] = new HashSet\u003c\u003e(); 19 } 20 21 for (int i = 1; i \u003c= totalNumber; i++) { 22 number.add(i); 23 } 24 25 Collections.shuffle(number); 26 27 int idx = 0; 28 // 指定中奖号码 29 for (int i = 0; i \u003c count.length; i++) { 30 for (int j = 0; j \u003c count[i]; j++) { 31 winningNumber[i].add(number.get(idx)); 32 idx += 1; 33 } 34 } 35 36 Collections.shuffle(number); 37 } 38 39 40 @Override 41 public void run() { 42 while (true) { 43 LotteryBox.lock.lock(); 44 if (LotteryBox.numberIdx \u003c LotteryBox.totalNumber) { 45 46 int n = number.get(LotteryBox.numberIdx); 47 LotteryBox.numberIdx += 1; 48 LotteryBox.lock.unlock(); 49 50 int rank = -1; 51 for (int j = 0; j \u003c winningNumber.length; j++) { 52 if (winningNumber[j].contains(n)) { 53 rank = j; 54 } 55 } 56 57 if (rank == -1) { 58 System.out.println(getName() + \"抽到的\" + n + \"号码没有中奖！\"); 59 } else { 60 System.out.println(getName() + \"抽到的\" + n + \"号码中了\" + Pond[rank] + \"元\"); 61 } 62 } else { 63 LotteryBox.lock.unlock(); 64 System.out.println(getName() + \": 奖池已经抽取完毕！\"); 65 break; 66 } 67 } 68 } 69} 邮件服务 ArrayBlockingQueue 资源不够，会自动阻塞和唤醒线程\n1package thread; 2 3import lombok.AllArgsConstructor; 4import lombok.Data; 5import lombok.NoArgsConstructor; 6import lombok.SneakyThrows; 7 8import java.io.Serializable; 9import java.util.concurrent.ArrayBlockingQueue; 10import java.util.concurrent.ExecutorService; 11import java.util.concurrent.Executors; 12 13/** 14 * Date: 2024/4/19 15 */ 16public class EmailServer { 17 public static void main(String[] args) throws InterruptedException { 18 MailService service = new MailService(); 19 20 ExecutorService threadPool = Executors.newFixedThreadPool(2); 21 22 ConsumeEmailQueue runnable1 = new ConsumeEmailQueue(\"@服务1\", service); 23 ConsumeEmailQueue runnable2 = new ConsumeEmailQueue(\"$服务2\", service); 24 threadPool.submit(runnable1); 25 threadPool.submit(runnable2); 26 27 for (int i = 0; i \u003c 5; i++) { 28 Email email = new Email(\"title\"+i, \"content\"+i); 29 MailQueue.getMailQueue().produce(email); 30 Thread.sleep(3000); 31 } 32 } 33} 34 35 36class MailService { 37 public void sendEmail(Email email) { 38 System.out.println(\"-------------------------\"); 39 System.out.println(\"来新邮件了！\"); 40 System.out.println(email); 41 System.out.println(\"-------------------------\"); 42 } 43} 44 45class ConsumeEmailQueue implements Runnable { 46 private MailService mailService; 47 private String name; 48 49 public ConsumeEmailQueue(String name, MailService mailService) { 50 this.name = name; 51 this.mailService = mailService; 52 } 53 54 @SneakyThrows 55 @Override 56 public void run() { 57 while (true) { 58 Email email = MailQueue.getMailQueue().consume(); 59 if (email != null) { 60 System.out.println(name + \"取走了一封邮件\"); 61 System.out.println(\"剩余邮件: \" + MailQueue.getMailQueue().size()); 62 mailService.sendEmail(email); 63 } 64 System.out.println(\"消费者检查了一轮\\n\"); 65 } 66 } 67} 68 69@Data 70@NoArgsConstructor 71@AllArgsConstructor 72class Email implements Serializable { 73 private String title; 74 private String content; 75} 76 77class MailQueue { 78 // 队列大小 79 public static int QUEUE_MAX_SIZE = 1000; 80 81 // 阻塞队列 82 public static ArrayBlockingQueue\u003cEmail\u003e blockingQueue = new ArrayBlockingQueue\u003c\u003e(100); 83 84 // 私有化构造器 85 private MailQueue() { 86 } 87 // 实现单例模式 88 private static class SingletonHolder { 89 private static MailQueue mailQueue = new MailQueue(); 90 } 91 92 public static MailQueue getMailQueue() { 93 return SingletonHolder.mailQueue; 94 } 95 96 // 生产 97 public void produce(Email email) throws InterruptedException { 98 blockingQueue.put(email); 99 } 100 101 // 消费 102 public Email consume() throws InterruptedException { 103 return blockingQueue.take(); 104 } 105 106 public int size() { 107 return blockingQueue.size(); 108 } 109} Java Websocket 简易共享聊天室 服务端 1// 自定义终端配置类，目的就是在建立连接时，保存一些数据以供访问 - httpSession 保存了请求的信息 2public class GetHttpSessionConfigurator extends ServerEndpointConfig.Configurator { 3 @Override 4 public void modifyHandshake(ServerEndpointConfig sec, HandshakeRequest request, HandshakeResponse response) { 5 HttpSession httpSession = (HttpSession) request.getHttpSession(); 6 sec.getUserProperties().put(HttpSession.class.getName(), httpSession); 7 } 8} 1// 一个Endpoint == 一个客户端 2// 服务终端对象， configurator关联自定义的配置器类，目的是让 WebSocket 会话能够访问存储在 HTTP 会话中的数据 3@ServerEndpoint(value = \"/chat\", configurator = GetHttpSessionConfigurator.class) 4@Component 5public class ChatEndpoint { 6 // 维护一份共享的连接终端在线信息。 多个线程频繁地访问和修改共享的键值对集合时，ConcurrentHashMap 是一个合适的选择 7 private static Map\u003cString, ChatEndpoint\u003e onlineUsers= new ConcurrentHashMap\u003c\u003e(); // user =\u003e endpoint 8 9 // 用来发送信息给对应终端 10 private Session session; 11 12 // 用来获取请求的信息，标识发送对象 13 private HttpSession httpSession; 14 15 // 首次连接， 在HTTP握手连接时已经把放入config中 16 @OnOpen 17 public void onOpen(Session session, EndpointConfig config) { 18 // 初始化数据 19 this.session = session; 20 HttpSession httpSession = (HttpSession) config.getUserProperties().get(HttpSession.class.getName()); 21 this.httpSession = httpSession; 22 23 String user = (String) httpSession.getAttribute(\"user\"); 24 onlineUsers.put(user, this); 25 26 // 广播通知 更新在线用户，让别人知道你上线了 27 String message = MessageUtils.getMessage(true, null, getAllOnlineUsers()); 28 broadcastAllUsers(message); 29 } 30 31 // 广播信息给所有在线用户 32 private void broadcastAllUsers(String message) { 33 try { 34 Set\u003cString\u003e names = onlineUsers.keySet(); 35 for (String name : names) { 36 ChatEndpoint chatEndpoint = onlineUsers.get(name); 37 chatEndpoint.session.getBasicRemote().sendText(message); // @@@ 核心发送信息的代码 38 } 39 } catch (IOException e) { 40 e.printStackTrace(); 41 } 42 } 43 44 // 获取所有在线用户 45 private Set\u003cString\u003e getAllOnlineUsers() { 46 return onlineUsers.keySet(); 47 } 48 49 // @@@ 核心 =\u003e 转发信息 50 @OnMessage 51 public void onMessage(String message, Session session) { 52 try { 53 ObjectMapper mapper = new ObjectMapper(); 54 Message msg = mapper.readValue(message, Message.class); 55 String toName = msg.getToName(); 56 String data = msg.getMessage(); 57 String user = (String) httpSession.getAttribute(\"user\"); 58 String resultMsg = MessageUtils.getMessage(false, user, data); 59 60 onlineUsers.get(toName).session.getBasicRemote().sendText(resultMsg); 61 } catch (IOException e) { 62 e.printStackTrace(); 63 } 64 } 65 66 @OnClose 67 public void onClose(Session session) { 68 String user = (String) httpSession.getAttribute(\"user\"); 69 onlineUsers.remove(user); 70 71 String message = MessageUtils.getMessage(true, null, getAllOnlineUsers()); 72 broadcastAllUsers(message); 73 } 74} 客户端 1var ws = new WebSocket(\"ws://localhost:8080/chat\"); 2 ws.onopen = function (e) { 3 $(\"#username\").html(\"用户：\"+ username +\"在线\"); 4 } 5 //接受消息 6 ws.onmessage = function (ev) { 7 var datastr = ev.data; 8 var res = JSON.parse(datastr); 9 //判断是否是系统消息 10 if(res.system){ 11 //好友列表 12 //系统广播 13 var names = res.message; 14 var userlistStr = \"\"; 15 var broadcastListStr = \"\"; 16 for (var name of names){ 17 if (name != username){ 18 userlistStr += \"\"+ name +\"\"; 19 broadcastListStr += \"\"+ name +\"上线了\n\"; 20 } 21 }; 22 $(\"#hylist\").html(userlistStr); 23 $(\"#xtlist\").html(broadcastListStr); 24 25 }else { 26 //不是系统消息 27 var str = \"\"+ res.message +\"\"; 28 if (toName == res.fromName) 29 $(\"#content\").append(str); 30 31 var chatdata = sessionStorage.getItem(res.fromName); 32 if (chatdata != null){ 33 str = chatdata + str; 34 } 35 sessionStorage.setItem(res.fromName, str); 36 37 }; 38 } 39 40 ws.onclose = function (ev) { 41 $(\"#username\").html(\"用户：\"+ username +\"离线\"); 42 } 43 44 showChat = function(name){ 45 // alert(\"dsaad\"); 46 toName = name; 47 //清空聊天区 48 $(\"#content\").html(\"\"); 49 $(\"#new\").html(\"当前正与\"+toName+\"聊天\"); 50 var chatdata = sessionStorage.getItem(toName); 51 if (chatdata != null){ 52 $(\"#content\").html(chatdata); 53 } 54 }; 55 //发送消息 56 $(\"#submit\").click(function () { 57 //获取输入的内容 58 var data = $(\"#input_text\").val(); 59 $(\"#input_text\").val(\"\"); 60 var json = {\"toName\": toName ,\"message\": data}; 61 //将数据展示在聊天区 62 var str = \"\"+ data +\"\"; 63 $(\"#content\").append(str); 64 65 var chatdata = sessionStorage.getItem(toName); 66 if (chatdata != null){ 67 str = chatdata + str; 68 } 69 sessionStorage.setItem(toName,str); 70 //发送数据 71 ws.send(JSON.stringify(json)); 72 }) 伪代码框架 服务器端\n1public class GetHttpSessionConfigurator extends ServerEndpointConfig.Configurator { 2 @Override 3 public void modifyHandshake() { 4\t// 保存请求的信息，后续访问 5 } 6} 7 8// 一个Endpoint == 一个客户端， value==url 9// 服务终端 configurator关联自定义的配置器类，目的是让 WebSocket 会话能够访问存储在 HTTP 会话中的数据 10@ServerEndpoint(value = \"/chat\", configurator = GetHttpSessionConfigurator.class) 11@Component 12public class ChatEndpoint { 13 14 // 首次连接， 在HTTP握手连接时已经把放入config中 15 @OnOpen 16 public void onOpen(Session session, EndpointConfig config) { 17 // 会话建立逻辑 18 } 19 20 // @@@ 核心 =\u003e 转发信息 chatEndpoint.session.getBasicRemote().sendText(message); @@@ 核心发送信息的代码 21 @OnMessage 22 public void onMessage(String message, Session session) { 23 // 接受终端消息逻辑 24 } 25 26 @OnClose 27 public void onClose(Session session) { 28\t// 会话关闭逻辑 29 } 30} 客户端\n1var ws = new WebSocket(\"ws://localhost:8080/chat\"); 2 3ws.onopen = function (e) { 4 // 会话建立逻辑 5} 6 7ws.onmessage = function (ev) { 8 // 消息接收逻辑 9} 10 11ws.onclose = function (ev) { 12 // 会话关闭逻辑 13} 14 15// 主动发送数据 16// ws.send(JSON.stringify(data)); Nginx 1# 正向代理 2Client Server 3X1 \\\\ 4X2 == =\u003e T(VPN) =\u003e Y 5X3 // 6 7# 反向代理 8 // Y1 9X == =\u003e T(Nginx) =\u003e == Y2 10 \\\\ Y3 nginx启停\n注意linux权限，若无权限，则加sudo\n1nginx -s ${signal} 2quit: 停止 3reload: 重新加载配置文件 nginx 配置\n1# 全局配置信息 2worker_processes auto; # main进程 { 多个worker进程 } 3 4events { 5\tworker_connections 1024; # 网络连接数 6} 7 8http { 9\t... 10\tserver{ ... } 11\tserver{ ... } 12} 1server { 2 listen 80 default_server;\t# 监听ipv4-端口(80) 3 listen [::]:80 default_server;\t# 监听ipv6-端口(80) 4 5\troot /var/www/html;\t# 为请求提供文件的根目录 6\tindex index.html index.htm index.nginx-debian.html; # 定义了当请求为目录时，默认尝试返回的文件列表 7 8\tserver_name _; 9\tlocation / {\t# 对于根URL（即/）的请求的处理规则 10 # 尝试按顺序找到对应的文件或目录，如果都找不到，则返回404错误（未找到） 11 try_files $uri $uri/ =404; 12 } 反向代理\n1# nginx.config 中 2 3http { 4\t... 5\tupstream backend {\t# default weight=1, 默认进行轮询 6\tip_hash; // 终端ip和服务器ip绑定到一起 7\tserver ?.?.?.?:? weight=?; 8\tserver ?.?.?.?:?; 9\tserver ?.?.?.?:?; 10\t} 11\t12\tserver { 13\t... 14\tlocation /app { 15\tproxy_pass http://backend/; 16\t} 17\t} 18\t... 19} 解释：⭐upstream ? { … } 定义了上游服务器信息，ip_hash的作用就是让终端和某个服务器绑定(解决session问题)，weight参数是分发数量的权重，默认1，越大往这个服务器分发的任务越多。 ⭐server中添加映射 location /app 将访问nginx.ip:80/app的请求转发给 http ://backend/ 的服务，进行均衡负载。\n练习\n1️⃣ 0.0.0.0 表示本机127.0.0.1和ip-v4\n2️⃣ 创建多个Flask服务，模拟多个后端服务器，实验均衡负载\n1from flask import Flask 2 3app = Flask(__name__) 4 5@app.route('/') 6def hello_world(): 7 return 'Hello, 800?' 8 9if __name__ == '__main__': 10 app.run(host='0.0.0.0', port=800?) 11 12# 终端运行 python .\\main8000.py --port=8000 MybatisPlus springboot application.yaml 配置\n1mybatis-plus: 2 type-aliases-package: com/yoo/entity 3 mapper-locations: classpath:/mapper/**.xml 4 configuration: 5 map-underscore-to-camel-case: true Mapper模板增强：SQL语句：查询字段、筛选条件 - SQL片段分离\n1@TableName(\"user\") // 类-绑定数据库-表 2Class User{...} 3 4// BaseMapper 内置大量基本的SQL模板 5@Mapper 6public interface UserMapper extends BaseMapper\u003cUser\u003e {} 7 8// example 9QueryWrapper wrapper = new QueryWrapper();\t// 条件包装器 10wrapper.select(\"name, age, email\");\t// 显示指定查询字段 11wrapper.ge(\"age\", 23);\t// 条件 greater than 12List list = userMapper.selectList(wrapper); 混合自定义SQL.xml 配置和模板\n1@Mapper 2public interface UserMapper extends BaseMapper\u003cUser\u003e { 3 Type methodID(...params); 4 int UPDATEID(@Param(Constants.WRAPPER) LambdaQueryWrapper\u003cUser\u003e wrapper, ...params); 5} 6 7// Associated XML file 8\u003c? id=\"methodID\" resultType=\"Type\"\u003e 9 SQL Segment 10\u003c/?\u003e 11 12// use Wrapper to build condition 13\u003cupdate id=\"UPDATEID\"\u003e 14 UPDATE `table_name` 15 SET ... 16\t${ew.customSqlSegment} 17\u003c/update\u003e Service模板增强\n1// interface extends template abstract method 2@Service 3public interface IUserService extends IService\u003cUser\u003e {} 4 5// class extends template implement method 6@Service 7public class UserPOServiceImpl extends ServiceImpl\u003cUserPOMapper, UserPO\u003e implements IUserPOService { 8 @Override 9 public List\u003cUserPO\u003e queryUserByBalance(int minBalance, int maxBalance) { 10 // lambdaQuery is method in ServiceImpl super class IService 11 return lambdaQuery() 12 .between(UserPO::getBalance, (double)minBalance, (double)maxBalance) 13 .list(); 14 } 15} knife4j 接口说明文档\n1@Api() 2@RestController 3@RequestMapping() 4class Controller { 5 6 @ApiOperation() 7 @RequestMapping() 8 public void method() {} 9 10} 11 12@ApiModel() 13class Bean{ 14 @ApiModelProperty() 15 private Type Field; 16} 批量操作\n1MySQL connection URL: add parameter rewriteBatchedStatements=true 2 3userSerivice.saveBatch() 4 5// MySQL开启批量操作，MybatisPlus再执行batch级的SQL ⭐ 静态的SQL，避免Service中相互依赖\n1Db.lambdaQuery(AddressPO.class) 2 .eq(AddressPO::getUserId, user.getId()) 3 .list(); 4 5// =\u003e 最终调用AddressPOMapper执行基本SQL操作 6 7// AddressPO @TableName(\"address\") =\u003e 关联数据库表，下划线转驼峰 8 9// iService 和 ServiceImpl 封装了基本的SQL操作 枚举\n1// application.yaml 2mybatis-plus: 3 configuration: 4 default-enum-type-handler: com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler 1// 定义状态 2@Getter 3public enum UserStatus { 4 NORMAL(1, \"正常\"), 5 FREEZE(2, \"冻结\"); 6 7 @EnumValue\t// 与数据库的转换 8 private final int value; 9 @JsonValue // 响应结果的转换 10 private final String desc; 11 12 UserStatus(int value, String desc) { 13 this.value = value; 14 this.desc = desc; 15 } 16} 17 18// e.g. Freeze user 19lambdaUpdate() 20 .eq(UserPO::getId, id) 21 .set(UserPO::getStatus, UserStatus.FREEZE) 22 .update(); ⭐ 分页\n1// 注入分页配置，添加分页拦截器 2@Configuration 3public class MyBatisConfig { 4 5 @Bean 6 public MybatisPlusInterceptor mybatisPlusInterceptor() { 7 MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor(); 8 9 PaginationInnerInterceptor paginationInnerInterceptor = new PaginationInnerInterceptor(); 10 paginationInnerInterceptor.setDbType(DbType.MYSQL); 11 paginationInnerInterceptor.setMaxLimit(1000L); 12 13 mybatisPlusInterceptor.addInnerInterceptor(paginationInnerInterceptor); 14 15 return mybatisPlusInterceptor; 16 } 17 18} 1// 准备Page信息条件 2Page\u003cAddressPO\u003e page = Page.of(pageNum, pageSize); 3page.addOrder(OrderItem.desc(\"id\")); // 根据xxx降序/升序 4// 执行查询 5Page\u003cAddressPO\u003e addressPOPage = lambdaQuery().page(page); 6 7return addressPOPage.getRecords(); 封装PageQuery和PageDTO\n1@Data 2class PageQuery { 3 // properity: 4 pageSize, pageNum, sortBy, isAsc ... 5 // method: 6 public \u003cPO\u003e Page\u003cPO\u003e toMpPage(){ 7 // 1. 分页条件 8 Page\u003cPO\u003e page = Page.of(pageNum, pageSize); 9 // 2. 排序条件 10 if (StrUtil.isNotBlank(sortBy)) { 11 page.addOrder(new OrderItem().setColumn(sortBy).setAsc(isAsc)); 12 } 13 return page; 14 } 15 16 ... // 多态性质 17 public \u003cPO\u003e Page\u003cPO\u003e toMpPage(String sortBy, Boolean isAsc) { 18 return toMpPage(new OrderItem().setColumn(sortBy).setAsc(isAsc)); 19 } 20 ... // 默认排序... 21} 22 23@Data 24class UserQuery extends PageQuery { 25 // properity: 查询条件 26 name, id, xxx 27} 28 29// use example 30构建UserQuery, 初始化好查询参数 =\u003e 调用UserService.method(userQuery) 31method(userQuery) =\u003e userQuery.toMpPage() =\u003e Page\u003cPO\u003e p =\u003e lambdaQuery.condition().page(p) =\u003e getRecords() 32分步构建：页面配置(复用) + 查询条件(继承额外加) 1@Data 2public class PageDTO\u003cT\u003e { 3 4 private Long total; 5 6 private Long pages; 7 8 private List\u003cT\u003e list; 9 10 // 泛型不指定参数类型， PO=\u003eVO转换器传入 11\tpublic static \u003cPO, VO\u003e PageDTO\u003cVO\u003e of (Page\u003cPO\u003e p, Class\u003cVO\u003e clazz, Function\u003cPO, VO\u003e converter) { 12 PageDTO\u003cVO\u003e voPageDTO = new PageDTO\u003c\u003e(); 13 // 基本信息 14 voPageDTO.setTotal(p.getTotal()); 15 voPageDTO.setPages(p.getPages()); 16 17 List\u003cPO\u003e poList = p.getRecords(); 18 if (CollectionUtils.isEmpty(poList)) { 19 voPageDTO.setList(Collections.emptyList()); 20 return voPageDTO; 21 } 22 23 // 拷贝数据 24 List\u003cVO\u003e list = poList.stream().map(converter).collect(Collectors.toList()); 25 voPageDTO.setList(list); 26 27 return voPageDTO; 28 } Spring Cloud 父 pom\n1\u003cproperties\u003e 2 \u003cmaven.compiler.source\u003e11\u003c/maven.compiler.source\u003e 3 \u003cmaven.compiler.target\u003e11\u003c/maven.compiler.target\u003e 4 \u003cproject.build.sourceEncoding\u003eUTF-8\u003c/project.build.sourceEncoding\u003e 5 \u003cproject.reporting.outputEncoding\u003eUTF-8\u003c/project.reporting.outputEncoding\u003e 6 \u003corg.projectlombok.version\u003e1.18.20\u003c/org.projectlombok.version\u003e 7 \u003cspring-cloud.version\u003e2021.0.3\u003c/spring-cloud.version\u003e 8 \u003cspring-cloud-alibaba.version\u003e2021.0.4.0\u003c/spring-cloud-alibaba.version\u003e 9 \u003cmybatis-plus.version\u003e3.4.3\u003c/mybatis-plus.version\u003e 10 \u003chutool.version\u003e5.8.25\u003c/hutool.version\u003e 11 \u003cmysql.version\u003e8.0.23\u003c/mysql.version\u003e 12 \u003cknife4j.version\u003e4.3.0\u003c/knife4j.version\u003e 13\u003c/properties\u003e 14 15 16\u003cdependencyManagement\u003e 17 \u003cdependencies\u003e 18 \u003cdependency\u003e 19 ... 20 \u003c/dependency\u003e 21 \u003c/dependencies\u003e 22\u003c/dependencyManagement\u003e 子项目 pom\n1\u003cparent\u003e 2 \u003cartifactId\u003esuper artifactId\u003c/artifactId\u003e 3 \u003cgroupId\u003ecom.yoo\u003c/groupId\u003e 4 \u003cversion\u003e1.0-SNAPSHOT\u003c/version\u003e 5\u003c/parent\u003e 统一dependency version\n垂直划分项目\nUser-Service nacos托管微服务IP地址\n1java: 2\tcom: 3 yoo: 4 controller: SpringMVC 5 service: IService + ServiceImpl 6 mapper: BaseMapper 7 client: @Openfeign, remote call 8 domain: 9 po: properity object reflex database table 10 vo: value object, only show required properity 11 12---------------------------------- 13 14resource: 15\tapplication.yaml: 16\tserver: 17 port: 18 19 spring: 20 application: 21 name: user-service # service-name 22 profiles: 23 active: dev 24 datasource: 25 url: 26 driver-class-name: 27 username: 28 password: 29\t# ⭐ cloud service ip address 30 cloud: 31 nacos: 32 server-addr: 127.0.0.1 33 34 mybatis-plus: 35 configuration: 36\t# 枚举字段类型映射到数据库表指定类型， 下划线转驼峰 37 default-enum-type-handler: com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler 38 global-config: 39 db-config: 40 update-strategy: not_null 41 id-type: auto 42 43 knife4j: 44 enable: true 45 openapi: 46 title: 用户服务接口文档 47 description: \"信息\" 48 email: 1410124534@qq.com 49 concat: longwei 50 group: 51 default: 52 group-name: default 53 api-rule: package 54 api-rule-resources: 55 - com.yoo.controller OpenFeign 远程调用微服务 Step 1. pom添加对应依赖\n1 2\u003cdependency\u003e 3 \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e 4 \u003cartifactId\u003espring-cloud-starter-openfeign\u003c/artifactId\u003e 5\u003c/dependency\u003e 6 7 8\u003cdependency\u003e 9 \u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e 10 \u003cartifactId\u003espring-cloud-starter-loadbalancer\u003c/artifactId\u003e 11\u003c/dependency\u003e Step 2. 开启Openfeign功能\n1@EnableFeignClients 2... 3public class xxxApplicaiotn { 4 ... 5} Step 3. 编写Openfeign调用接口\n1@FeignClient(value = \"order-service\") 2public interface OrderClient { 3 4 @GetMapping(\"/order/{id}\") 5 List\u003cOrderVO\u003e getOrderByUserId(@PathVariable(\"id\") Long userId); 6 7} 8 9// @Interface : @XXXMapping(\"/{param}\") \u003c=== 10// || 11// Method : (@PathVariable(\"param\") Type name) Gateway setup 前端统一请求 =\u003e8080网关 =\u003e 分发调度给微服务 类似nginx\ndependencies\n1 2 3 org.springframework.cloud 4 spring-cloud-starter-gateway 5 6 7 8 com.alibaba.cloud 9 spring-cloud-starter-alibaba-nacos-discovery 10 11 12 13 org.springframework.cloud 14 spring-cloud-starter-loadbalancer 15 ⭐⭐⭐application.yaml 配置转发接口映射\n1server: 2 port: 8080 3 4spring: 5 application: 6 name: gateway-service 7 cloud: 8 nacos: 9 server-addr: 127.0.0.1 10 gateway: 11 routes: ### 路由 12 - id: item 13 uri: lb://user-service 14 predicates: 15 - Path=/user/** 16 17 - id: order 18 uri: lb://order-service 19 predicates: 20 - Path=/order/** StarterClass\n1@SpringBootApplication 2public class GatewayApplication { 3 public static void main(String[] args) { 4 SpringApplication.run(GatewayApplication.class, args); 5 } 6} 网关登录统一拦截 好比于守卫，统一校验登录Token，进行放行或者拦截\npom 依赖 支持yaml读取配置\n1 2 org.springframework.boot 3 spring-boot-configuration-processor 4 true 5 application.yaml\n1hm: 2 auth: 3 excludePaths: # 无需登录校验的路径 4 - /user/login 5 - /item/search 6 - /test/** 属性类\n1@Data 2@Component 3@ConfigurationProperties(prefix = \"hm.auth\") 4public class AuthProperties { 5 private List\u003cString\u003e includePaths; 6 private List\u003cString\u003e excludePaths; 7} GlobalFilter 全局拦截\n先根据配置文件，决定是否拦截，拦=\u003e检查Token=\u003e存入信息在Header =\u003e 微服务(从Header中拿取信息)\n1@Component 2@RequiredArgsConstructor 3public class AuthGlobalFilter implements GlobalFilter, Ordered { 4 // 已加入Spring容器 5 private final AuthProperties authProperties; 6 // 未加入，手动new 7 private final AntPathMatcher antPathMatcher = new AntPathMatcher(); 8 9 @Override 10 public Mono\u003cVoid\u003e filter(ServerWebExchange exchange, GatewayFilterChain chain) { 11 // 获取request对象 12 ServerHttpRequest request = exchange.getRequest(); 13 // 判断路径是否需要拦截 14 if(isExclude(request.getPath().toString())) { 15 // 放行 16 return chain.filter(exchange); 17 } 18 // 获取Header中的Token 19 String token = null; 20 List\u003cString\u003e headers = request.getHeaders().get(\"authorization\"); 21 if(!CollUtil.isEmpty(headers)) { 22 token = headers.get(0); 23 } 24 Long userId = null; 25 // 简单模拟JwtToken校验 26 if(token != null \u0026\u0026 token.equals(\"hello\")) { 27 // 校验成功 28 userId = 1L; 29 } else { 30 // 校验失败 =\u003e 直接返回UNAUTHORIZED状态码 31 ServerHttpResponse response = exchange.getResponse(); 32 response.setStatusCode(HttpStatus.UNAUTHORIZED); 33 return response.setComplete(); 34 } 35 36 String userInfo = userId.toString(); 37 38 // 将用户信息存储在转发请求头中 39 ServerWebExchange ex = exchange.mutate() 40 .request(builder -\u003e { 41 builder.header(\"user-info\", userInfo); 42 }) 43 .build(); 44 45 return chain.filter(ex); 46 } 47 48 private boolean isExclude(String path) { 49 for (String pathPattern : authProperties.getExcludePaths()) { 50 if (antPathMatcher.match(pathPattern, path)) { 51 return true; 52 } 53 } 54 return false; 55 } 56 57 @Override 58 public int getOrder() { 59 return 0; 60 } 61} Service Interceptor ThreadLocal，线程自己的独享空间，用来存储请求中携带的信息\n1public class UserContext { 2 3 private static final ThreadLocal\u003cLong\u003e tl = new ThreadLocal\u003c\u003e(); 4 5 public static void setUserId(Long userId) { 6 tl.set(userId); 7 } 8 9 public static Long getUserId() { 10 return tl.get(); 11 } 12 13 public static void removeUserId(){ 14 tl.remove(); 15 } 16 17} 执行服务前，将request header中携带的信息取出来\n1public class UserInfoInterceptor implements HandlerInterceptor { 2 3 @Override 4 public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { 5 String userId = request.getHeader(\"user-info\"); 6 if (StrUtil.isNotBlank(userId)) { 7 UserContext.setUserId(Long.parseLong(userId)); 8 } 9 return true; 10 } 11 12 @Override 13 public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { 14 UserContext.removeUserId(); 15 } 16} 抽取公共部分 common-service 1com.yoo.common.xxx 其他module只要在pom内引用就行\n公共部分如何区别不同的服务 - 有些子模块需要但另一些子模块不需要的Class（这个类会被Spring托管，但不想注入Spring容器中）\n1@ConditionalOnClass(DispatherServlet.class) 在其他微服务加上，显示指定配置文件位置\nspring.factories\n1org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.yoo.common.config.MvcConfig RabbitMQ 1publisher =\u003e exchanger =\u003e queue =\u003e consumer exchanger:\nfanout exchanger: 广播 direct exchanger：根据key发送给对应queue topic exchanger: 根据key进行匹配一组符合的queue 消息订阅\n1@RabbitListener(queues = \"???\") 2public T method(...) { 3 // 4} 消息发布\n1# 直接发送给Queue 2rabbitTemplate.convertAndSend(queueName, message) 3 4# 发送给交换机 5rabbitTemplate.convertAndSend(ExchangeName, \"RoutingKey\", MessageObject) 消息格式转换\nObject =\u003e Binary 将发送的对象序列化为JSON格式字符串？\n1@Bean 2... 3return new Jackson2JSONMessageConverter() 队列交换机和绑定\n1@Bean 2public Queue orderQueue() { 3 return new Queue(\"orderQueue\", true); 4} 5 6// Spring 容器会确保同一个 @Bean 方法只会被调用一次，返回的对象会被缓存并重复使用 7@Bean 8public DirectExchange orderExchange() { 9 return new DirectExchange(\"orderExchange\", true, false); 10} 11 12@Bean 13public Binding binding() { 14 return BindingBuilder.bind(orderQueue()).to(orderExchange()).with(\"orderRoutingKey\"); 15} 可靠传输\n1# 发送确认 2publisher-confirm-type: none|correlated|simple 3 4none: 无确认机制，性能最好，不可靠 5correlated: 异步关联确认,不阻塞线程,高可靠性,性能中、异步回调场景 6simple: 同步阻塞确认,阻塞线程,性能底，可靠。 7 8# 接收确认 9ackknowledge-mode: none|manual|auto 10none: 无确认机制 11manual: 手工ack 12auto: 自动ack，根据抛出的异常类型，决定重发还是reject 13 14 15# 重连配置 16retry: 17\tenabled: true # 启用重试机制 18\tinitial-interval: 1000ms # 第一次失败等待的时长 19\tmultiplier: 1 # 每次失败等待时间成x倍增长 20\tmax-attempts: 3 # 最大重试次数 21\tstateless: false # 22\t23# 如果接口幂等(调用多次都不会重复扣款) =\u003e stateless:true 每次重试都是独立的，不保留状态 ⭐性能高 24# 非幂等操作（多次执行可能有副作用） 25stateless:false # 带状态 死信交换机\n定义交换机和队列\n1@Bean 2public DirectExchange createDLExchanger() { 3 return ExchangeBuilder.directExchange(\"dl.direct\").build(); 4} 5 6@Bean 7public Queue createDLQueue() { 8 // 队列信息是否持久化到磁盘? durable(持久化?) 9 return QueueBuilder.nonDurable(\"dl.queue\").build(); 10} 11 12@Bean 13public Binding toBindingDL() { 14 return BindingBuilder.bind(createDLQueue()).to(createDLExchanger()).with(\"dlRoutingKey\"); 15} 16 17// ----------------------- 18 19@Bean 20public FanoutExchange createTTLExchanger() { 21 return ExchangeBuilder.fanoutExchange(\"ttl.fanout\").build(); 22} 23 24@Bean 25public Queue createTTLQueue() { 26 // 队列信息是否持久化到磁盘? durable(持久化?) 27 return QueueBuilder.nonDurable(\"ttl.queue\").deadLetterExchange(\"dl.direct\").deadLetterRoutingKey(\"dlRoutingKey\").build(); 28} 29 30@Bean 31public Binding toBinding() { 32 return BindingBuilder.bind(createTTLQueue()).to(createTTLExchanger()); 33} 步骤1：发送信息并设置过期时间\n1// 1:未付款; 2.已付款 ... 2// 模拟用户下单 3redisTemplate.opsForValue().set(\"order:userId:status\", \"1\"); 4// ... 扣货物库存 -1 5 6MessageProperties properties = new MessageProperties(); 7properties.setExpiration(\"20000\"); // 20秒过期，过期后进入死信队列 8 9Map\u003cString, String\u003e map = new HashMap\u003c\u003e(); 10map.put(\"code\", \"200\"); 11map.put(\"msg\", \"Hi, RabbitMQ. This is a dead letter.\"); 12 13ObjectMapper mapper = new ObjectMapper(); 14 15String msgContent = mapper.writeValueAsString(map); 16Message message = new Message(msgContent.getBytes(), properties); 17rabbitTemplate.convertAndSend(\"ttl.fanout\", \"\", message); 步骤2：用户调用接口进行付款\n1// 数据库 2// .... 3 4// 模拟付款成功 5redisTemplate.opsForValue().set(\"order:userId:status\", \"2\"); 步骤3：死信队列 处理逻辑\n1@RabbitListener(queues = \"dl.queue\") 2public void deadLetterQueue(Message message) throws IOException { 3 ObjectMapper mapper = new ObjectMapper(); 4 Map\u003cString, String\u003e msg = mapper.readValue(message.getBody(), Map.class); 5 6 System.out.println(\"receive Msg ... @@@\"); 7 System.out.println(msg.get(\"code\")); 8 System.out.println(msg.get(\"msg\")); 9 10 String status = redisTemplate.opsForValue().get(\"order:userId:status\"); 11 if (status.equals(\"1\")) { 12 // ... 还原货物库存 +1 13 return; 14 }else if (status.equals(\"2\")){ 15 // 订单支付完成，实现收尾工作 16 System.out.println(\"订单已支付，生成后续...\"); 17 } 18} 解耦各个部分。\n苍穹外卖 AOP使用-自动补全参数共同信息 1// 自定义注解 2@Target(ElementType.METHOD) 3@Retention(RetentionPolicy.RUNTIME) 4public @interface AutoFill { 5 OperationType value(); 6} 1@Aspect // !!! 交给Spring托管 2@Component 3public class AutoFillAspect { 4 5 // 任何 returnType package.?.class.method(params) \u0026\u0026 with annotation 6 @Pointcut(\"execution(* com.hmwm.service.*.*(..)) \u0026\u0026 @annotation(com.hmwm.common.AutoFill)\") 7 public void autoFillPointCut(){} 8 9 @Before(\"autoFillPointCut()\") 10 public void autoFill(JoinPoint joinPoint) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException { 11 System.err.println(\"Start fill common field.\"); 12 13 // get method annotation value 14 MethodSignature signature = (MethodSignature) joinPoint.getSignature(); 15 AutoFill annotation = signature.getMethod().getAnnotation(AutoFill.class); 16 OperationType operationType = annotation.value(); 17 18 // 拦截的method的参数列表 19 Object[] args = joinPoint.getArgs(); 20 if (args==null \u0026\u0026 args.length==0) { 21 System.out.println(\"current method not params\"); 22 return; 23 } 24 // 第一个⭐参数⭐ 需要填充的对象. 提前交流指定:这里为User Obj 25 Object arg = args[0]; 26 27 LocalDateTime now = LocalDateTime.now(); 28 // Long currentId = BaseContext.getCurrentId(); 29 30 // 给这个arg填充值 31 if (operationType == OperationType.INSERT) { 32 // getDeclaredMethod(method_name, params_type) 33 Method setCreateTime = arg.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME.getMethodName(), Date.class); 34 Method setUpdateTime = arg.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME.getMethodName(), Date.class); 35 36 // method-obj: invoke(object, params) 方法(对象, 参数) 37 setCreateTime.invoke(arg, Date.from(now.atZone(ZoneId.systemDefault()).toInstant())); 38 setUpdateTime.invoke(arg, Date.from(now.atZone(ZoneId.systemDefault()).toInstant())); 39 } 40 41 } 1@AutoFill(OperationType.INSERT) 2public String addUser(User user) { 3 return user.toString(); 4} 枚举类\n1// 枚举类在 Java 中是通过 enum 关键字定义的，但它本质上是一个类。每个枚举常量都是该枚举类的一个实例。 2public enum AutoFillConstant { 3 SET_CREATE_TIME(\"setCreateTime\"), 4 SET_UPDATE_TIME(\"setUpdateTime\"); 5 6 private String methodName; // 存储方法名的字段 7 8 // 构造函数 9 AutoFillConstant(String methodName) { 10 this.methodName = methodName; 11 System.out.println(\"AutoFillConstant: \" + methodName); 12 } 13 14 // 获取方法名 15 public String getMethodName() { 16 return methodName; 17 } 18} 定时任务 利用@Scheduled注解\n1@Component 2public class ScheduledTask { 3 // 秒 分 时 天 周 月 年 年/月/日 时/分/秒 4 @Scheduled(cron = \"0 * * * * ? \") // 这里 xxxx/xx/xx xx:xx:x0 执行 5 public void processTimeOutOrder() { 6 System.err.println(\"process Timeout task ...\"); 7 } 8 9} ThreadLocal-线程专享资源 可以请求来的时候存储一些 环境变量 ThreadLocal\n1public class BaseContext { 2 public static ThreadLocal\u003cLong\u003e threadLocal = new ThreadLocal\u003c\u003e(); 3 4 public static void setCurrentId(Long id) { 5 threadLocal.set(id); 6 } 7 8 public static Long getCurrentId() { 9 return threadLocal.get(); 10 } 11 12 public static void removeCurrentId() { 13 threadLocal.remove(); 14 } 15} Websocket 1@Component 2@ServerEndpoint(\"/websocket\") 3public class MyWebSocketEndpoint { 4 5 // 会话对象 server:client == 1:n 6 private static Map\u003cString, Session\u003e sessionMap = new HashMap\u003c\u003e(); 7 8 9 @OnOpen 10 public void onOpen(Session session) { 11 System.out.println(\"onOpen: \" + session.getId()); 12 sessionMap.put(session.getId(), session); 13 sendMsg(\"Hi, can I help you?\", session.getId()); 14 } 15 16 @OnMessage 17 public void onMessage(String message, Session session) { 18 System.out.println(\"receive Message: \" + message); 19 sendMsg(\"Yse! I am thinking ... this question!\", session.getId()); 20 } 21 22 @OnClose 23 public void OnClose(Session session) { 24 sendMsg(\"Bye!\", session.getId()); 25 System.out.println(\"OnClose: \" + session.getId()); 26 sessionMap.remove(session.getId()); 27 } 28 29 public void sendMsg(String msg, String sid) { 30 try { 31 sessionMap.get(sid).getBasicRemote().sendText(msg); // 向session对象sendTest 32 } catch (IOException e) { 33 e.printStackTrace(); 34 } 35 } 36 37} 文件下载功能 很简单，利用Response进行。 需要设置response内容格式和response-header\n1ClassPathResource resource = new ClassPathResource(\"static/file_name.zip\"); 2if (!resource.exists()) { 3 System.err.println(\"file not exists!\"); 4 return ResponseEntity.notFound().build(); 5} 6 7HttpHeaders headers = new HttpHeaders(); 8headers.add(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"file_name.zip\\\"\"); // attachment 附件 9 10return ResponseEntity.ok() 11 .headers(headers) // \u003c= header 12 .contentType(MediaType.APPLICATION_OCTET_STREAM) // \u003c= contentType stream流式 13 .body(resource); // \u003c= file Excel处理 1org.apache.poi // 利用这个Apache POI package 1XSSFWorkbook excel = new XSSFWorkbook(); // 类似excel文件 2XSSFSheet sheet = excel.createSheet(\"sheet1\"); // sheet 3 4XSSFRow row1 = sheet.createRow(0); 5row1.createCell(1).setCellValue(\"姓名\"); 6row1.createCell(2).setCellValue(\"年纪\"); 7row1.createCell(3).setCellValue(\"城市\"); 8 9XSSFRow row2 = sheet.createRow(1); 10row2.createCell(1).setCellValue(\"韦龙\"); 11row2.createCell(2).setCellValue(23); 12row2.createCell(3).setCellValue(\"桂林\"); 13 14XSSFRow row3 = sheet.createRow(2); 15row3.createCell(1).setCellValue(\"张三\"); 16row3.createCell(2).setCellValue(23); 17row3.createCell(3).setCellValue(\"杭州\"); 18 19File file = new File(\"static/staff_info.xlsx\"); 20FileOutputStream stream = new FileOutputStream(file); 21excel.write(stream); 22 23stream.close(); 24excel.close(); ",
  "wordCount" : "5142",
  "inLanguage": "en",
  "image": "http://121.40.252.207/papermod-cover.png","datePublished": "2024-04-19T00:00:00Z",
  "dateModified": "2024-04-19T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://121.40.252.207/posts/learning/java_learning/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://121.40.252.207/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://121.40.252.207/" accesskey="h" title="𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰&#39;𝓼 𝓑𝓵𝓸𝓰 (Alt + H)">
                <img src="http://121.40.252.207/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰&#39;𝓼 𝓑𝓵𝓸𝓰</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://121.40.252.207/index.html" title="🏡 Home">
                    <span>🏡 Home</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/archives/" title="📃 Archive">
                    <span>📃 Archive</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/tags/" title="📑 Tags">
                    <span>📑 Tags</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/categories/" title="🗒️ Categories">
                    <span>🗒️ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/search/" title="🔍 Search">
                    <span>🔍 Search</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/about/" title="👨🏻‍🎓 About Me">
                    <span>👨🏻‍🎓 About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://121.40.252.207/">Home</a>&nbsp;»&nbsp;<a href="http://121.40.252.207/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Java学习笔记
    </h1>
    <div class="post-meta"><span title='2024-04-19 00:00:00 +0000 UTC'>April 19, 2024</span>&nbsp;·&nbsp;25 min&nbsp;·&nbsp;5142 words&nbsp;·&nbsp;LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#java-%e5%8f%8d%e5%b0%84" aria-label="Java 反射">Java 反射</a></li>
                <li>
                    <a href="#java-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" aria-label="Java 动态代理">Java 动态代理</a></li>
                <li>
                    <a href="#java-%e6%b3%9b%e5%9e%8b" aria-label="Java 泛型">Java 泛型</a></li>
                <li>
                    <a href="#java-%e6%b3%a8%e8%a7%a3" aria-label="Java 注解">Java 注解</a></li>
                <li>
                    <a href="#java-%e5%a4%9a%e7%ba%bf%e7%a8%8b" aria-label="Java 多线程">Java 多线程</a><ul>
                        
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b%e7%9a%84%e4%b8%89%e7%a7%8d%e6%96%b9%e5%bc%8f" aria-label="创建线程的三种方式">创建线程的三种方式</a></li>
                <li>
                    <a href="#%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="线程池">线程池</a></li>
                <li>
                    <a href="#%e5%8d%95%e7%94%9f%e4%ba%a7%e5%8d%95%e6%b6%88%e8%b4%b9%e8%80%85" aria-label="单生产单消费者">单生产单消费者</a></li>
                <li>
                    <a href="#%e7%ae%80%e5%8d%95%e6%8a%bd%e5%a5%96" aria-label="简单抽奖">简单抽奖</a></li>
                <li>
                    <a href="#%e9%82%ae%e4%bb%b6%e6%9c%8d%e5%8a%a1" aria-label="邮件服务">邮件服务</a></li></ul>
                </li>
                <li>
                    <a href="#java-websocket" aria-label="Java Websocket">Java Websocket</a><ul>
                        
                <li>
                    <a href="#%e7%ae%80%e6%98%93%e5%85%b1%e4%ba%ab%e8%81%8a%e5%a4%a9%e5%ae%a4" aria-label="简易共享聊天室">简易共享聊天室</a><ul>
                        
                <li>
                    <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" aria-label="服务端">服务端</a></li>
                <li>
                    <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af" aria-label="客户端">客户端</a></li>
                <li>
                    <a href="#%e4%bc%aa%e4%bb%a3%e7%a0%81%e6%a1%86%e6%9e%b6" aria-label="伪代码框架">伪代码框架</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#nginx" aria-label="Nginx">Nginx</a></li>
                <li>
                    <a href="#mybatisplus" aria-label="MybatisPlus">MybatisPlus</a></li>
                <li>
                    <a href="#spring-cloud" aria-label="Spring Cloud">Spring Cloud</a><ul>
                        
                <li>
                    <a href="#user-service" aria-label="User-Service">User-Service</a><ul>
                        
                <li>
                    <a href="#openfeign-%e8%bf%9c%e7%a8%8b%e8%b0%83%e7%94%a8%e5%be%ae%e6%9c%8d%e5%8a%a1" aria-label="OpenFeign 远程调用微服务">OpenFeign 远程调用微服务</a></li></ul>
                </li>
                <li>
                    <a href="#gateway-setup" aria-label="Gateway setup">Gateway setup</a></li>
                <li>
                    <a href="#%e7%bd%91%e5%85%b3%e7%99%bb%e5%bd%95%e7%bb%9f%e4%b8%80%e6%8b%a6%e6%88%aa" aria-label="网关登录统一拦截">网关登录统一拦截</a></li>
                <li>
                    <a href="#service-interceptor" aria-label="Service Interceptor">Service Interceptor</a></li>
                <li>
                    <a href="#%e6%8a%bd%e5%8f%96%e5%85%ac%e5%85%b1%e9%83%a8%e5%88%86" aria-label="抽取公共部分">抽取公共部分</a></li>
                <li>
                    <a href="#common-service" aria-label="common-service">common-service</a></li></ul>
                </li>
                <li>
                    <a href="#rabbitmq" aria-label="RabbitMQ">RabbitMQ</a></li>
                <li>
                    <a href="#%e8%8b%8d%e7%a9%b9%e5%a4%96%e5%8d%96" aria-label="苍穹外卖">苍穹外卖</a><ul>
                        
                <li>
                    <a href="#aop%e4%bd%bf%e7%94%a8-%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e5%8f%82%e6%95%b0%e5%85%b1%e5%90%8c%e4%bf%a1%e6%81%af" aria-label="AOP使用-自动补全参数共同信息">AOP使用-自动补全参数共同信息</a></li>
                <li>
                    <a href="#%e5%ae%9a%e6%97%b6%e4%bb%bb%e5%8a%a1" aria-label="定时任务">定时任务</a></li>
                <li>
                    <a href="#threadlocal-%e7%ba%bf%e7%a8%8b%e4%b8%93%e4%ba%ab%e8%b5%84%e6%ba%90" aria-label="ThreadLocal-线程专享资源">ThreadLocal-线程专享资源</a></li>
                <li>
                    <a href="#websocket" aria-label="Websocket">Websocket</a></li>
                <li>
                    <a href="#%e6%96%87%e4%bb%b6%e4%b8%8b%e8%bd%bd%e5%8a%9f%e8%83%bd" aria-label="文件下载功能">文件下载功能</a></li>
                <li>
                    <a href="#excel%e5%a4%84%e7%90%86" aria-label="Excel处理">Excel处理</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="java-反射">Java 反射<a hidden class="anchor" aria-hidden="true" href="#java-反射">#</a></h3>
<p>它提供了动态性和灵活性，使得程序可以在运行时动态地加载类、调用方法、访问字段等，而不需要在编译时确定这些操作。</p>
<p><strong>1. 动态加载类</strong></p>
<p>在运行时根据类名动态加载类，而不是在编译时硬编码类名。 &ndash; 插件化架构：根据配置文件或用户输入动态加载类。</p>
<p><strong>2. 创建对象</strong></p>
<p>通过反射可以在运行时动态创建对象，即使类的构造函数是私有的。</p>
<ul>
<li>工厂模式：根据配置动态创建对象。</li>
<li>依赖注入框架：Spring 通过反射创建 Bean 实例。</li>
</ul>
<p><strong>3. 调用方法</strong></p>
<p>通过反射可以在运行时动态调用对象的方法，即使方法是私有的。</p>
<ul>
<li>测试框架：JUnit 通过反射调用测试方法。</li>
</ul>
<p><strong>4. 访问字段</strong></p>
<p>通过反射可以在运行时动态访问对象的字段，即使字段是私有的</p>
<ul>
<li>序列化和反序列化：通过反射访问对象的字段。</li>
<li>对象关系映射（ORM）：Hibernate 通过反射访问实体类的字段。</li>
</ul>
<p><strong>7. 注解处理</strong></p>
<p>通过反射可以获取类、方法、字段上的注解，并根据注解执行相应的逻辑。</p>
<p><em>24/4/14</em></p>
<p>1️⃣ <strong>反射的作用</strong></p>
<ul>
<li>获取类中的所有信息(e.g.持久化、IDE的代码提示)</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fields</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// String name = fields[i].getName();  // 属性名 第一次先生成列名</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fields</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">bw</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fields</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">bw</span><span class="p">.</span><span class="na">append</span><span class="p">(</span><span class="s">&#34;, &#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">bw</span><span class="p">.</span><span class="na">newLine</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>结合配置文件动态创建对象</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Properties</span><span class="w"> </span><span class="n">prop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Properties</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;prop.properties&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">prop</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">is</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">classname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;classname&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;method&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prop</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">Class</span><span class="w"> </span><span class="n">cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">classname</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">Constructor</span><span class="w"> </span><span class="n">con</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">con</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">setName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;setName&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="n">setName</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">Method</span><span class="w"> </span><span class="n">met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cls</span><span class="p">.</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="n">method</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">met</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>2️⃣ <strong>获取Class的三种方式</strong></p>
<ul>
<li>Class.forname(&ldquo;全类名&rdquo;)</li>
<li>类名.class</li>
<li>对象.getClass()</li>
</ul>
<p>3️⃣  <strong>常用信息</strong></p>
<ul>
<li><em>Constructor(构造器)  Parameter(方法参数)  Field(成员变量)  Modifiers(权限修饰符)  Method(成员方法)  Declared(用于获取私有信息)</em></li>
</ul>
<hr>
<h3 id="java-动态代理">Java 动态代理<a hidden class="anchor" aria-hidden="true" href="#java-动态代理">#</a></h3>
<p><em><strong>无侵入的给代码添加额外的功能</strong></em></p>
<p>流程：</p>
<ul>
<li>准备：具体行为对象 + 抽象行为接口 + 代理类</li>
<li>执行：数据 =&gt; 代理类(抽象行为接口) =&gt; InvocationHandler.invoke</li>
</ul>
<p>钩子之类的，插入代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nf">Star</span><span class="w">                 </span><span class="p">(</span><span class="n">抽象接口</span><span class="err">，</span><span class="n">定义行为</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BigStar</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="nf">Star</span><span class="w">  </span><span class="p">(</span><span class="n">具体类名</span><span class="err">，</span><span class="n">实现行为</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="cm">/*
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">* ClassLoader: 用于加载代理类的类加载器 (具体)
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">* Interface  : 代理类需要实现的接口列表 (抽象)
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">* InvocationHandler:  execute proxy task
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">*/</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">Star</span><span class="w"> </span><span class="n">star</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Star</span><span class="p">)</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">bigStar</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Class</span><span class="o">[]</span><span class="p">{</span><span class="n">Star</span><span class="p">.</span><span class="na">class</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">InvocationHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">proxy</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;sing&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;准备话筒，收钱&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;dance&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;准备舞台，收钱&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bigStar</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="c1">// 使用代理</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="n">BigStar</span><span class="w"> </span><span class="n">kun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigStar</span><span class="p">(</span><span class="s">&#34;KunKun&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="n">Star</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ProxyUtil</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">kun</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxy</span><span class="p">.</span><span class="na">sing</span><span class="p">(</span><span class="s">&#34;只因你太美&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="java-泛型">Java 泛型<a hidden class="anchor" aria-hidden="true" href="#java-泛型">#</a></h3>
<p><em>类型参数化</em></p>
<p>1️⃣ <strong>编译时检查</strong></p>
<p>不符合的编译通过不了</p>
<p>2️⃣ <strong>代码复用</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Double</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">doubleValue</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">doubleValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 函数签名 &lt;T extends Number&gt; 用于限定参数类型</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// int float double 都OK</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>泛型类</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// Class指定的T会传递给成员变量和成员方法</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GenericClass</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">good</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getGood</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">var</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">var</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">good</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setGood</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">good</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">good</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 指定多个泛型类型</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MultiGenericClass</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="nf">getKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">key</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setKey</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>泛型接口</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 就是实例化对象时 再指定参数类型</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">GenericInterface</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">myMap</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GenericInterface</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="nf">getValue</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="n">K</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>泛型方法</strong></li>
</ul>
<p>函数签名<T>表示此方法是泛型方法，并且这个<T>与Class的<T>无关，<strong>限定在方法部分</strong>    作用范围！！！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 泛型结合反射，动态创建对象，可以进行初始化</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getObject</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Constructor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="na">getConstructor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor</span><span class="p">.</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Number</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Double</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="na">doubleValue</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="na">doubleValue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>泛型边界</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ？ 是 父类  - 下界</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">funcAAA</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">super</span><span class="w"> </span><span class="n">Student</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sList</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">sList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// ？ 是 子类  - 上界</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">funcAA</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Person</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pList</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">pList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>泛型擦除：</strong></p>
<p>​	为了兼容java没有泛型特性的老版本。在<strong>编译阶段</strong>会进行所谓的“<strong>类型擦除</strong>”。将所有的泛型表示（尖括号中的内容）都替换为具体的类型（其对应的原生态类型）、</p>
<ul>
<li>消除类型参数声明，即删除<code>&lt;&gt;</code>及其包围的部分。</li>
<li>据类型参数的上下界推断并替换所有的类型参数为原生态类型(往父类转，更包容)</li>
<li>自动产生“<strong>桥接方法</strong>”以保证擦除类型后的代码仍然具有泛型的“多态性”</li>
</ul>
<p>​</p>
<p>无限制类型擦除  - <code>&lt;T&gt;</code>和<code>&lt;?&gt;</code>的类型参数都被替换为Object</p>
<p>有限制类型擦除 - <code>&lt;T extends Number&gt;</code>和<code>&lt;? extends Number&gt;</code>的类型参数被替换为<code>Number</code>，</p>
<p>​				  			<code>&lt;? super Number&gt;</code>被替换为Object</p>
<p><strong><em>桥接</em>   - <em>编译阶段类型擦除时执行</em></strong></p>
<p>保证多态特性  - 因为可以多个子类继承父类，父类的类型又是泛型，不能被某个子类的泛型限制住！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 父类定义</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Pair</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">T</span><span class="w">  </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 子类定义</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">DateInter</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Pair</span><span class="o">&lt;</span><span class="n">Date</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">setValue</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">  
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="nf">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">getValue</span><span class="p">();</span><span class="w">  
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// 编译时 类型擦除后</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Pair</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setValue</span><span class="p">(</span><span class="n">Object</span><span class="w">  </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">  
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image-20240415172031269" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/Fmw2-h00HMxs2uUZTveY1PTAqy-n"></p>
<p>生成中间的桥接方法，进行连接，维护多态性。</p>
<p><img alt="image-20241122125640349" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FvPTfqXKkhldWbQH1j_oVNE67cz8"></p>
<hr>
<h3 id="java-注解">Java 注解<a hidden class="anchor" aria-hidden="true" href="#java-注解">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">,</span><span class="w"> </span><span class="n">ElementType</span><span class="p">.</span><span class="na">PARAMETER</span><span class="p">})</span><span class="w">	</span><span class="c1">// 放置在哪</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">						</span><span class="c1">// 存活时间</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 模块</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">title</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// 功能</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="n">BusinessType</span><span class="w"> </span><span class="nf">businessType</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">BusinessType</span><span class="p">.</span><span class="na">OTHER</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// 操作人员</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">OperatorType</span><span class="w"> </span><span class="nf">operatorType</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">MANGE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="c1">// 是否保存请求参数</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSaveRequestData</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>与AOP结合，实现切入</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Aspect</span><span class="w">				</span><span class="c1">// 给Spring托管，并且此注解标识这个类实现切入功能</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LogAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Pointcut</span><span class="p">(</span><span class="s">&#34;@annotation(log_aop.Log)&#34;</span><span class="p">)</span><span class="w">	</span><span class="c1">// 检测带有@Log注解的部分</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logPointCut</span><span class="p">(){}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;logPointCut()&#34;</span><span class="p">)</span><span class="w">				</span><span class="c1">// 在切入点前执行操作</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">logPointCutBefore</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;在切入点前先执行&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">MethodSignature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getSignature</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signature</span><span class="p">.</span><span class="na">getMethod</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">Log</span><span class="w"> </span><span class="n">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">Log</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">annotation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">annotation</span><span class="p">.</span><span class="na">title</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">annotation</span><span class="p">.</span><span class="na">isSaveRequestData</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">annotation</span><span class="p">.</span><span class="na">businessType</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">annotation</span><span class="p">.</span><span class="na">operatorType</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;没有获取到注解信息&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Spring Boot 简单实现</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Controller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Log</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;模拟查询信息&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">businessType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BusinessType</span><span class="p">.</span><span class="na">SELECT</span><span class="p">,</span><span class="w"> </span><span class="n">operatorType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OperatorType</span><span class="p">.</span><span class="na">PERSON</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/test&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;执行处理请求操作&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;code&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">200</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;msg&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;success&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="java-多线程">Java 多线程<a hidden class="anchor" aria-hidden="true" href="#java-多线程">#</a></h3>
<h4 id="创建线程的三种方式"><em>创建线程的三种方式</em><a hidden class="anchor" aria-hidden="true" href="#创建线程的三种方式">#</a></h4>
<p><em>- 单继承多实现</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ThreadFirstWay</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; print : &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="k">new</span><span class="w"> </span><span class="n">ThreadFirstWay</span><span class="p">().</span><span class="na">start</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 更灵活</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="o">-------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ThreadSecondWay</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">thread</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; print : &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ThreadSecondWay</span><span class="p">()).</span><span class="na">start</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="c1">// 返回结果</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="o">-------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">MyCallable</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">20</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">            </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w"></span><span class="n">MyCallable</span><span class="w"> </span><span class="n">callable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyCallable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">callable</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="w"> </span><span class="n">thread1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">task</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w"></span><span class="n">thread1</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w"></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image-20250109195552849" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmUwuBD8Gl3L03PtKFZK7pUFjpPO"></p>
<h4 id="线程池"><em><strong>线程池</strong></em><a hidden class="anchor" aria-hidden="true" href="#线程池">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// newCachedThreadPool: 会复用之前的线程(空闲, 超出时间会关闭)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// newFixedThreadPool: 固定线程数，任务在阻塞队列中排队</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">threadPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">threadPool</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyRunnable</span><span class="p">(</span><span class="s">&#34;@Run 1&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 更详细</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="o">-------------------------------------------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">ThreadPoolExecutor</span><span class="w"> </span><span class="n">threadPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">corePoolSize</span><span class="o">=</span><span class="n">2</span><span class="p">,</span><span class="w">	</span><span class="c1">// 核心线程</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">maximumPoolSize</span><span class="o">=</span><span class="n">3</span><span class="p">,</span><span class="w">  </span><span class="c1">// 临时线程</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">KeepAliveTime</span><span class="o">=</span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="c1">// 临时线程存活时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">3</span><span class="p">),</span><span class="w">  </span><span class="c1">// 阻塞队列 </span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">AbortPolicy</span><span class="p">()</span><span class="w"> </span><span class="c1">// 默认抛出异常</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="n">threadPool</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TestRunnable</span><span class="p">(</span><span class="s">&#34;@Runnable 1&#34;</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><h4 id="单生产单消费者"><strong>单生产单消费者</strong><a hidden class="anchor" aria-hidden="true" href="#单生产单消费者">#</a></h4>
<p>使用 <strong>synchronized(唯一对象)</strong> 实现临界区</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 单生产单消费的同步</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Desk</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// 简化版 1有，0无</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">foodFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// 总个数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="c1">// 剩余数</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="c1">// 锁</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 消费者</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Consumer</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nd">@SneakyThrows</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">                </span><span class="c1">// 美食家是否吃饱</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">                    </span><span class="c1">// 是否做好食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">foodFlag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">                        </span><span class="c1">// 等待生产者制作食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">                        </span><span class="c1">// 消耗掉一份食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">count</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">                        </span><span class="c1">// 吃食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;消费者正在吃第&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">total</span><span class="o">-</span><span class="n">Desk</span><span class="p">.</span><span class="na">count</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;碗食物&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">                        </span><span class="c1">// 通知生产者制作食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">                        </span><span class="c1">// 是否存在食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">foodFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Producer</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">    </span><span class="nd">@SneakyThrows</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">            </span><span class="c1">// 占用桌子</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">                </span><span class="c1">// 美食家是否吃饱</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">                    </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">                    </span><span class="c1">// 上份食物是否存在</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">foodFlag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">                        </span><span class="c1">// 等食物被吃</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 制作食物</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">                        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;生产者制作第&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">Desk</span><span class="p">.</span><span class="na">total</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Desk</span><span class="p">.</span><span class="na">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;份食物&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">foodFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">                        </span><span class="n">Desk</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="简单抽奖"><strong>简单抽奖</strong><a hidden class="anchor" aria-hidden="true" href="#简单抽奖">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 简单考虑 100%中奖</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">LotteryBox</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">Pond</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">20</span><span class="p">,</span><span class="w"> </span><span class="n">50</span><span class="p">,</span><span class="w"> </span><span class="n">100</span><span class="p">,</span><span class="w"> </span><span class="n">200</span><span class="p">,</span><span class="w"> </span><span class="n">300</span><span class="p">,</span><span class="w"> </span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="n">1000</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">9</span><span class="p">,</span><span class="w"> </span><span class="n">8</span><span class="p">,</span><span class="w"> </span><span class="n">7</span><span class="p">,</span><span class="w"> </span><span class="n">6</span><span class="p">,</span><span class="w"> </span><span class="n">5</span><span class="p">,</span><span class="w"> </span><span class="n">4</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">totalNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[]</span><span class="w"> </span><span class="n">winningNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Set</span><span class="o">[</span><span class="n">count</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">numberIdx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// 初始化数组中的每个 Set</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">winningNumber</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">winningNumber</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">totalNumber</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">number</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">Collections</span><span class="p">.</span><span class="na">shuffle</span><span class="p">(</span><span class="n">number</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="c1">// 指定中奖号码</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">count</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">                </span><span class="n">winningNumber</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">number</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">                </span><span class="n">idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="n">Collections</span><span class="p">.</span><span class="na">shuffle</span><span class="p">(</span><span class="n">number</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">            </span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">numberIdx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">totalNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">numberIdx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">                </span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">numberIdx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">                </span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">winningNumber</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">winningNumber</span><span class="o">[</span><span class="n">j</span><span class="o">]</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">                        </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rank</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;抽到的&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;号码没有中奖！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;抽到的&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;号码中了&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Pond</span><span class="o">[</span><span class="n">rank</span><span class="o">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;元&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">                </span><span class="n">LotteryBox</span><span class="p">.</span><span class="na">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;: 奖池已经抽取完毕！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="邮件服务"><em><strong>邮件服务</strong></em><a hidden class="anchor" aria-hidden="true" href="#邮件服务">#</a></h4>
<p><em><strong>ArrayBlockingQueue 资源不够，会自动阻塞和唤醒线程</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kn">package</span><span class="w"> </span><span class="nn">thread</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">lombok.AllArgsConstructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">lombok.Data</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">lombok.NoArgsConstructor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">lombok.SneakyThrows</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.Serializable</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ArrayBlockingQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ExecutorService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Executors</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="cm"> * Date: 2024/4/19
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EmailServer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="n">MailService</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MailService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">threadPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newFixedThreadPool</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="n">ConsumeEmailQueue</span><span class="w"> </span><span class="n">runnable1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConsumeEmailQueue</span><span class="p">(</span><span class="s">&#34;@服务1&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">ConsumeEmailQueue</span><span class="w"> </span><span class="n">runnable2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConsumeEmailQueue</span><span class="p">(</span><span class="s">&#34;$服务2&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">threadPool</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">runnable1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">threadPool</span><span class="p">.</span><span class="na">submit</span><span class="p">(</span><span class="n">runnable2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">5</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">            </span><span class="n">Email</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Email</span><span class="p">(</span><span class="s">&#34;title&#34;</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;content&#34;</span><span class="o">+</span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">            </span><span class="n">MailQueue</span><span class="p">.</span><span class="na">getMailQueue</span><span class="p">().</span><span class="na">produce</span><span class="p">(</span><span class="n">email</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">3000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">MailService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendEmail</span><span class="p">(</span><span class="n">Email</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;-------------------------&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;来新邮件了！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">email</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;-------------------------&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">ConsumeEmailQueue</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">MailService</span><span class="w"> </span><span class="n">mailService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ConsumeEmailQueue</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">MailService</span><span class="w"> </span><span class="n">mailService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mailService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mailService</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="nd">@SneakyThrows</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">            </span><span class="n">Email</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MailQueue</span><span class="p">.</span><span class="na">getMailQueue</span><span class="p">().</span><span class="na">consume</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">email</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;取走了一封邮件&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;剩余邮件: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MailQueue</span><span class="p">.</span><span class="na">getMailQueue</span><span class="p">().</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">                </span><span class="n">mailService</span><span class="p">.</span><span class="na">sendEmail</span><span class="p">(</span><span class="n">email</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;消费者检查了一轮\n&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w"></span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w"></span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w"></span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Email</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Serializable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">content</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">MailQueue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">    </span><span class="c1">// 队列大小</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">QUEUE_MAX_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1000</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">    </span><span class="c1">// 阻塞队列</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="n">Email</span><span class="o">&gt;</span><span class="w"> </span><span class="n">blockingQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">    </span><span class="c1">// 私有化构造器</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="nf">MailQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">    </span><span class="c1">// 实现单例模式</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SingletonHolder</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MailQueue</span><span class="w"> </span><span class="n">mailQueue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MailQueue</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MailQueue</span><span class="w"> </span><span class="nf">getMailQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">SingletonHolder</span><span class="p">.</span><span class="na">mailQueue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="c1">// 生产</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">produce</span><span class="p">(</span><span class="n">Email</span><span class="w"> </span><span class="n">email</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">        </span><span class="n">blockingQueue</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">email</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">    </span><span class="c1">// 消费</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Email</span><span class="w"> </span><span class="nf">consume</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">blockingQueue</span><span class="p">.</span><span class="na">take</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">blockingQueue</span><span class="p">.</span><span class="na">size</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="java-websocket">Java Websocket<a hidden class="anchor" aria-hidden="true" href="#java-websocket">#</a></h3>
<h4 id="简易共享聊天室"><strong>简易共享聊天室</strong><a hidden class="anchor" aria-hidden="true" href="#简易共享聊天室">#</a></h4>
<h5 id="服务端">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 自定义终端配置类，目的就是在建立连接时，保存一些数据以供访问  - httpSession 保存了请求的信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GetHttpSessionConfigurator</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ServerEndpointConfig</span><span class="p">.</span><span class="na">Configurator</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">modifyHandshake</span><span class="p">(</span><span class="n">ServerEndpointConfig</span><span class="w"> </span><span class="n">sec</span><span class="p">,</span><span class="w"> </span><span class="n">HandshakeRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HandshakeResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">        </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">httpSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpSession</span><span class="p">)</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHttpSession</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">        </span><span class="n">sec</span><span class="p">.</span><span class="na">getUserProperties</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">HttpSession</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">httpSession</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 一个Endpoint == 一个客户端</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 服务终端对象， configurator关联自定义的配置器类，目的是让 WebSocket 会话能够访问存储在 HTTP 会话中的数据</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/chat&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">configurator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetHttpSessionConfigurator</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChatEndpoint</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// 维护一份共享的连接终端在线信息。  多个线程频繁地访问和修改共享的键值对集合时，ConcurrentHashMap 是一个合适的选择</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ChatEndpoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">onlineUsers</span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// user =&gt; endpoint</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="c1">// 用来发送信息给对应终端</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="c1">// 用来获取请求的信息，标识发送对象</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">httpSession</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 首次连接， 在HTTP握手连接时已经把&lt;username, HttpSession&gt;放入config中</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@OnOpen</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">EndpointConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="c1">// 初始化数据</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">HttpSession</span><span class="w"> </span><span class="n">httpSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">HttpSession</span><span class="p">)</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">getUserProperties</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">HttpSession</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">httpSession</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">httpSession</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">httpSession</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// 广播通知 更新在线用户，让别人知道你上线了</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageUtils</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">getAllOnlineUsers</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">broadcastAllUsers</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="c1">// 广播信息给所有在线用户</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">broadcastAllUsers</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">keySet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">names</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">                </span><span class="n">ChatEndpoint</span><span class="w"> </span><span class="n">chatEndpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">                </span><span class="n">chatEndpoint</span><span class="p">.</span><span class="na">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w"> </span><span class="c1">// @@@ 核心发送信息的代码</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">    </span><span class="c1">// 获取所有在线用户</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getAllOnlineUsers</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">keySet</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="c1">// @@@ 核心 =&gt; 转发信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="nd">@OnMessage</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">            </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">            </span><span class="n">Message</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">toName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getToName</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getMessage</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">httpSession</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">resultMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageUtils</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">            </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">toName</span><span class="p">).</span><span class="na">session</span><span class="p">.</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">resultMsg</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">    </span><span class="nd">@OnClose</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">httpSession</span><span class="p">.</span><span class="na">getAttribute</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">        </span><span class="n">onlineUsers</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessageUtils</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">getAllOnlineUsers</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">        </span><span class="n">broadcastAllUsers</span><span class="p">(</span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h5 id="客户端"><em><strong>客户端</strong></em><a hidden class="anchor" aria-hidden="true" href="#客户端">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&#34;ws://localhost:8080/chat&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">        <span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#username&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&#34;用户：&#34;</span><span class="o">+</span> <span class="nx">username</span> <span class="o">+</span><span class="s2">&#34;&lt;span&gt;在线&lt;/span&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="c1">//接受消息
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c1"></span>        <span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            <span class="kd">var</span> <span class="nx">datastr</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">            <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">datastr</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">            <span class="c1">//判断是否是系统消息
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1"></span>            <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">system</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">                <span class="c1">//好友列表
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"></span>                <span class="c1">//系统广播
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"></span>                <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">                <span class="kd">var</span> <span class="nx">userlistStr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">                <span class="kd">var</span> <span class="nx">broadcastListStr</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">names</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">username</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">                        <span class="nx">userlistStr</span> <span class="o">+=</span> <span class="s2">&#34;&lt;a onclick=&#39;showChat(\&#34;&#34;</span><span class="o">+</span><span class="nx">name</span><span class="o">+</span><span class="s2">&#34;\&#34;)&#39;&gt;&#34;</span><span class="o">+</span> <span class="nx">name</span> <span class="o">+</span><span class="s2">&#34;&lt;/a&gt;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">                        <span class="nx">broadcastListStr</span> <span class="o">+=</span> <span class="s2">&#34;&lt;p&gt;&#34;</span><span class="o">+</span> <span class="nx">name</span> <span class="o">+</span><span class="s2">&#34;上线了&lt;/p&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                <span class="p">};</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">                <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#hylist&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">userlistStr</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">                <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#xtlist&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">broadcastListStr</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">
</span></span><span class="line"><span class="ln">25</span><span class="cl">            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">                <span class="c1">//不是系统消息
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="c1"></span>                <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&#34;&lt;span id=&#39;mes_left&#39;&gt;&#34;</span><span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span><span class="s2">&#34;&lt;/span&gt;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">toName</span> <span class="o">==</span> <span class="nx">res</span><span class="p">.</span><span class="nx">fromName</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">                    <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#content&#34;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">
</span></span><span class="line"><span class="ln">31</span><span class="cl">                <span class="kd">var</span> <span class="nx">chatdata</span> <span class="o">=</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fromName</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">chatdata</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">                    <span class="nx">str</span> <span class="o">=</span> <span class="nx">chatdata</span> <span class="o">+</span> <span class="nx">str</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">                <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">fromName</span><span class="p">,</span> <span class="nx">str</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">
</span></span><span class="line"><span class="ln">37</span><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">
</span></span><span class="line"><span class="ln">40</span><span class="cl">        <span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#username&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&#34;用户：&#34;</span><span class="o">+</span> <span class="nx">username</span> <span class="o">+</span><span class="s2">&#34;&lt;span&gt;离线&lt;/span&gt;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="nx">showChat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">            <span class="c1">// alert(&#34;dsaad&#34;);
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="c1"></span>            <span class="nx">toName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">            <span class="c1">//清空聊天区
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="c1"></span>            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#content&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#new&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&#34;当前正与&#34;</span><span class="o">+</span><span class="nx">toName</span><span class="o">+</span><span class="s2">&#34;聊天&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">            <span class="kd">var</span> <span class="nx">chatdata</span> <span class="o">=</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">toName</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">chatdata</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">                <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#content&#34;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">chatdata</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">        <span class="c1">//发送消息
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="c1"></span>        <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#submit&#34;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">57</span><span class="cl">            <span class="c1">//获取输入的内容
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="c1"></span>            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#input_text&#34;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">59</span><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#input_text&#34;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">60</span><span class="cl">            <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;toName&#34;</span><span class="o">:</span> <span class="nx">toName</span> <span class="p">,</span><span class="s2">&#34;message&#34;</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">61</span><span class="cl">            <span class="c1">//将数据展示在聊天区
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="c1"></span>            <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&#34;&lt;span id=&#39;mes_right&#39;&gt;&#34;</span><span class="o">+</span> <span class="nx">data</span> <span class="o">+</span><span class="s2">&#34;&lt;/span&gt;&lt;/br&gt;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">63</span><span class="cl">            <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;#content&#34;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">64</span><span class="cl">
</span></span><span class="line"><span class="ln">65</span><span class="cl">            <span class="kd">var</span> <span class="nx">chatdata</span> <span class="o">=</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">toName</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">66</span><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">chatdata</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">67</span><span class="cl">                <span class="nx">str</span> <span class="o">=</span> <span class="nx">chatdata</span> <span class="o">+</span> <span class="nx">str</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">68</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">69</span><span class="cl">            <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">toName</span><span class="p">,</span><span class="nx">str</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">70</span><span class="cl">            <span class="c1">//发送数据
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="c1"></span>            <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">));</span>
</span></span><span class="line"><span class="ln">72</span><span class="cl">        <span class="p">})</span>
</span></span></code></pre></div><h5 id="伪代码框架">伪代码框架<a hidden class="anchor" aria-hidden="true" href="#伪代码框架">#</a></h5>
<p><em><strong>服务器端</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GetHttpSessionConfigurator</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ServerEndpointConfig</span><span class="p">.</span><span class="na">Configurator</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">modifyHandshake</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">		</span><span class="c1">// 保存请求的信息，后续访问</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 一个Endpoint == 一个客户端， value==url</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 服务终端 configurator关联自定义的配置器类，目的是让 WebSocket 会话能够访问存储在 HTTP 会话中的数据</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;/chat&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">configurator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetHttpSessionConfigurator</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ChatEndpoint</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// 首次连接， 在HTTP握手连接时已经把&lt;username, HttpSession&gt;放入config中</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nd">@OnOpen</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">,</span><span class="w"> </span><span class="n">EndpointConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="c1">// 会话建立逻辑</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// @@@ 核心 =&gt; 转发信息  chatEndpoint.session.getBasicRemote().sendText(message); @@@ 核心发送信息的代码</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="nd">@OnMessage</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// 接受终端消息逻辑</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nd">@OnClose</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onClose</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">		</span><span class="c1">// 会话关闭逻辑</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>客户端</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&#34;ws://localhost:8080/chat&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="c1">// 会话建立逻辑
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="c1">// 消息接收逻辑
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="c1">// 会话关闭逻辑
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="c1">// 主动发送数据
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1">// ws.send(JSON.stringify(data));
</span></span></span></code></pre></div><hr>
<h3 id="nginx">Nginx<a hidden class="anchor" aria-hidden="true" href="#nginx">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 正向代理</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">Client</span>            <span class="n">Server</span>  
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">X1</span> \\
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">X2</span> <span class="o">==</span> <span class="o">=&gt;</span>  <span class="n">T</span><span class="p">(</span><span class="n">VPN</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Y</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">X3</span> <span class="o">//</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="c1"># 反向代理</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">                      <span class="o">//</span>  <span class="n">Y1</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">X</span> <span class="o">==</span> <span class="o">=&gt;</span>  <span class="n">T</span><span class="p">(</span><span class="n">Nginx</span><span class="p">)</span> <span class="o">=&gt;</span>  <span class="o">==</span>  <span class="n">Y2</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">                      \\  <span class="n">Y3</span>
</span></span></code></pre></div><p><em><strong>nginx启停</strong></em></p>
<p>注意linux权限，若无权限，则加sudo</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln">1</span><span class="cl">nginx -s ${signal}
</span></span><span class="line"><span class="ln">2</span><span class="cl">quit: 停止
</span></span><span class="line"><span class="ln">3</span><span class="cl">reload: 重新加载配置文件
</span></span></code></pre></div><p><em><strong>nginx 配置</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl"># 全局配置信息
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">worker_processes auto; # main进程 { 多个worker进程 }
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">events {
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	worker_connections 1024;   # 网络连接数
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">}
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">http {
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">	...
</span></span><span class="line"><span class="ln">10</span><span class="cl">	server{ ... }
</span></span><span class="line"><span class="ln">11</span><span class="cl">	server{ ... }
</span></span><span class="line"><span class="ln">12</span><span class="cl">}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl">server {
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">        listen 80 default_server;	# 监听ipv4-端口(80)  
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">        listen [::]:80 default_server;	# 监听ipv6-端口(80)
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">		root /var/www/html;		# 为请求提供文件的根目录
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		index index.html index.htm index.nginx-debian.html;  # 定义了当请求为目录时，默认尝试返回的文件列表
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">		server_name _;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">		location / {	# 对于根URL（即/）的请求的处理规则
</span></span><span class="line"><span class="ln">10</span><span class="cl">                # 尝试按顺序找到对应的文件或目录，如果都找不到，则返回404错误（未找到）
</span></span><span class="line"><span class="ln">11</span><span class="cl">                try_files $uri $uri/ =404;
</span></span><span class="line"><span class="ln">12</span><span class="cl">        }   
</span></span></code></pre></div><p><em><strong>反向代理</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl"># nginx.config 中
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">http {
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">	...
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">	upstream backend {	# default weight=1, 默认进行轮询
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">		ip_hash; // 终端ip和服务器ip绑定到一起
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">		server ?.?.?.?:? weight=?;
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">		server ?.?.?.?:?;
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">		server ?.?.?.?:?;
</span></span><span class="line"><span class="ln">10</span><span class="cl">	}
</span></span><span class="line"><span class="ln">11</span><span class="cl">	
</span></span><span class="line"><span class="ln">12</span><span class="cl">	server {
</span></span><span class="line"><span class="ln">13</span><span class="cl">		...
</span></span><span class="line"><span class="ln">14</span><span class="cl">		location /app {
</span></span><span class="line"><span class="ln">15</span><span class="cl">			proxy_pass http://backend/;
</span></span><span class="line"><span class="ln">16</span><span class="cl">		}
</span></span><span class="line"><span class="ln">17</span><span class="cl">	}
</span></span><span class="line"><span class="ln">18</span><span class="cl">	...
</span></span><span class="line"><span class="ln">19</span><span class="cl">}
</span></span></code></pre></div><p>解释：⭐upstream ? { &hellip; } 定义了上游服务器信息，ip_hash的作用就是让终端和某个服务器绑定(解决session问题)，weight参数是分发数量的权重，默认1，越大往这个服务器分发的任务越多。 ⭐server中添加映射 location /app 将访问nginx.ip:80/app的请求转发给 http ://backend/ 的服务，进行均衡负载。</p>
<p><em><strong>练习</strong></em></p>
<p>1️⃣ 0.0.0.0 表示本机127.0.0.1和ip-v4</p>
<p>2️⃣ 创建多个Flask服务，模拟多个后端服务器，实验均衡负载</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hello, 800?&#39;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">800</span><span class="err">?</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="c1"># 终端运行 python .\main8000.py --port=8000</span>
</span></span></code></pre></div><h3 id="mybatisplus">MybatisPlus<a hidden class="anchor" aria-hidden="true" href="#mybatisplus">#</a></h3>
<p><em>springboot application.yaml 配置</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">mybatis-plus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com/yoo/entity</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="nt">mapper-locations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:/mapper/**.xml</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="nt">map-underscore-to-camel-case</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>Mapper模板增强：SQL语句：查询字段、筛选条件  - SQL片段分离</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@TableName</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 类-绑定数据库-表</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">Class</span><span class="w"> </span><span class="n">User</span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// BaseMapper 内置大量基本的SQL模板</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nd">@Mapper</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserMapper</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseMapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// example</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">QueryWrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">QueryWrapper</span><span class="p">();</span><span class="w">	</span><span class="c1">// 条件包装器</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">wrapper</span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="s">&#34;name, age, email&#34;</span><span class="p">);</span><span class="w">			</span><span class="c1">// 显示指定查询字段</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">wrapper</span><span class="p">.</span><span class="na">ge</span><span class="p">(</span><span class="s">&#34;age&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">23</span><span class="p">);</span><span class="w">						</span><span class="c1">// 条件 greater than</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">List</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">selectList</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>混合自定义SQL.xml 配置和模板</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Mapper</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserMapper</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">BaseMapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="nf">methodID</span><span class="p">(...</span><span class="na">params</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">UPDATEID</span><span class="p">(</span><span class="nd">@Param</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">WRAPPER</span><span class="p">)</span><span class="w"> </span><span class="n">LambdaQueryWrapper</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="na">params</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// Associated XML file</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="o">&lt;?</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s">&#34;methodID&#34;</span><span class="w"> </span><span class="n">resultType</span><span class="o">=</span><span class="s">&#34;Type&#34;</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">SQL</span><span class="w"> </span><span class="n">Segment</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="o">&lt;/?&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// use Wrapper to build condition</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">update</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s">&#34;UPDATEID&#34;</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="n">UPDATE</span><span class="w"> </span><span class="err">`</span><span class="n">table_name</span><span class="err">`</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="n">SET</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">	</span><span class="n">$</span><span class="p">{</span><span class="n">ew</span><span class="p">.</span><span class="na">customSqlSegment</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">update</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>Service模板增强</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// interface extends template abstract method</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IUserService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">IService</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// class extends template implement method</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserPOServiceImpl</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ServiceImpl</span><span class="o">&lt;</span><span class="n">UserPOMapper</span><span class="p">,</span><span class="w"> </span><span class="n">UserPO</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IUserPOService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">UserPO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryUserByBalance</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">minBalance</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">maxBalance</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// lambdaQuery is method in ServiceImpl super class IService</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">between</span><span class="p">(</span><span class="n">UserPO</span><span class="p">::</span><span class="n">getBalance</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">minBalance</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">maxBalance</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>knife4j 接口说明文档</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Api</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@RestController</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@RequestMapping</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Controller</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@ApiOperation</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@RequestMapping</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">method</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nd">@ApiModel</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">Bean</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nd">@ApiModelProperty</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">Field</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>批量操作</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">MySQL</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">URL</span><span class="p">:</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="n">parameter</span><span class="w"> </span><span class="n">rewriteBatchedStatements</span><span class="o">=</span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">userSerivice</span><span class="p">.</span><span class="na">saveBatch</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// MySQL开启批量操作，MybatisPlus再执行batch级的SQL</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>⭐ 静态的SQL，避免Service中相互依赖</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Db</span><span class="p">.</span><span class="na">lambdaQuery</span><span class="p">(</span><span class="n">AddressPO</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">AddressPO</span><span class="p">::</span><span class="n">getUserId</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">list</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; 最终调用AddressPOMapper执行基本SQL操作</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// AddressPO @TableName(&#34;address&#34;) =&gt; 关联数据库表，下划线转驼峰</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="c1">// iService 和 ServiceImpl 封装了基本的SQL操作</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>枚举</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// application.yaml</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">mybatis</span><span class="o">-</span><span class="n">plus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="n">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="k">default</span><span class="o">-</span><span class="kd">enum</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">handler</span><span class="p">:</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">baomidou</span><span class="p">.</span><span class="na">mybatisplus</span><span class="p">.</span><span class="na">core</span><span class="p">.</span><span class="na">handlers</span><span class="p">.</span><span class="na">MybatisEnumTypeHandler</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 定义状态</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">UserStatus</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">NORMAL</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;正常&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">FREEZE</span><span class="p">(</span><span class="n">2</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;冻结&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@EnumValue</span><span class="w">	</span><span class="c1">// 与数据库的转换</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@JsonValue</span><span class="w">  </span><span class="c1">// 响应结果的转换</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">UserStatus</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// e.g.  Freeze user</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">UserPO</span><span class="p">::</span><span class="n">getId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">UserPO</span><span class="p">::</span><span class="n">getStatus</span><span class="p">,</span><span class="w"> </span><span class="n">UserStatus</span><span class="p">.</span><span class="na">FREEZE</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>⭐ <em><strong>分页</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 注入分页配置，添加分页拦截器</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Configuration</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyBatisConfig</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MybatisPlusInterceptor</span><span class="w"> </span><span class="nf">mybatisPlusInterceptor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">MybatisPlusInterceptor</span><span class="w"> </span><span class="n">mybatisPlusInterceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MybatisPlusInterceptor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">PaginationInnerInterceptor</span><span class="w"> </span><span class="n">paginationInnerInterceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PaginationInnerInterceptor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">paginationInnerInterceptor</span><span class="p">.</span><span class="na">setDbType</span><span class="p">(</span><span class="n">DbType</span><span class="p">.</span><span class="na">MYSQL</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">paginationInnerInterceptor</span><span class="p">.</span><span class="na">setMaxLimit</span><span class="p">(</span><span class="n">1000L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">mybatisPlusInterceptor</span><span class="p">.</span><span class="na">addInnerInterceptor</span><span class="p">(</span><span class="n">paginationInnerInterceptor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mybatisPlusInterceptor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 准备Page信息条件</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">Page</span><span class="o">&lt;</span><span class="n">AddressPO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Page</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">pageNum</span><span class="p">,</span><span class="w"> </span><span class="n">pageSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">page</span><span class="p">.</span><span class="na">addOrder</span><span class="p">(</span><span class="n">OrderItem</span><span class="p">.</span><span class="na">desc</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">));</span><span class="w">  </span><span class="c1">// 根据xxx降序/升序</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 执行查询</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="n">Page</span><span class="o">&lt;</span><span class="n">AddressPO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">addressPOPage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">().</span><span class="na">page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">addressPOPage</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><hr>
<p><em><strong>封装PageQuery和PageDTO</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">PageQuery</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// properity:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">pageSize</span><span class="p">,</span><span class="w"> </span><span class="n">pageNum</span><span class="p">,</span><span class="w"> </span><span class="n">sortBy</span><span class="p">,</span><span class="w"> </span><span class="n">isAsc</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="c1">// method:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">toMpPage</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="c1">// 1. 分页条件</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Page</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">pageNum</span><span class="p">,</span><span class="w"> </span><span class="n">pageSize</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// 2. 排序条件</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">sortBy</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">            </span><span class="n">page</span><span class="p">.</span><span class="na">addOrder</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">().</span><span class="na">setColumn</span><span class="p">(</span><span class="n">sortBy</span><span class="p">).</span><span class="na">setAsc</span><span class="p">(</span><span class="n">isAsc</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">page</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// 多态性质</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">toMpPage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">sortBy</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="n">isAsc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">toMpPage</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">().</span><span class="na">setColumn</span><span class="p">(</span><span class="n">sortBy</span><span class="p">).</span><span class="na">setAsc</span><span class="p">(</span><span class="n">isAsc</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="c1">// 默认排序...</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">UserQuery</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PageQuery</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="c1">// properity: 查询条件</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">xxx</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="c1">// use example</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="n">构建UserQuery</span><span class="p">,</span><span class="w"> </span><span class="n">初始化好查询参数</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">调用UserService</span><span class="p">.</span><span class="na">method</span><span class="p">(</span><span class="n">userQuery</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="n">method</span><span class="p">(</span><span class="n">userQuery</span><span class="p">)</span><span class="w">  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">userQuery</span><span class="p">.</span><span class="na">toMpPage</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">.</span><span class="na">condition</span><span class="p">().</span><span class="na">page</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">getRecords</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="n">分步构建</span><span class="err">：</span><span class="n">页面配置</span><span class="p">(</span><span class="n">复用</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">查询条件</span><span class="p">(</span><span class="n">继承额外加</span><span class="p">)</span><span class="w">        
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PageDTO</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">total</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// 泛型不指定参数类型， PO=&gt;VO转换器传入 </span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PO</span><span class="p">,</span><span class="w"> </span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PageDTO</span><span class="o">&lt;</span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">of</span><span class="w"> </span><span class="p">(</span><span class="n">Page</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">PO</span><span class="p">,</span><span class="w"> </span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">converter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">PageDTO</span><span class="o">&lt;</span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">voPageDTO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PageDTO</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// 基本信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">voPageDTO</span><span class="p">.</span><span class="na">setTotal</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getTotal</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">voPageDTO</span><span class="p">.</span><span class="na">setPages</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="na">getPages</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">PO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">poList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">getRecords</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CollectionUtils</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">poList</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="n">voPageDTO</span><span class="p">.</span><span class="na">setList</span><span class="p">(</span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">voPageDTO</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// 拷贝数据</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">VO</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poList</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">converter</span><span class="p">).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">voPageDTO</span><span class="p">.</span><span class="na">setList</span><span class="p">(</span><span class="n">list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">voPageDTO</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="spring-cloud">Spring Cloud<a hidden class="anchor" aria-hidden="true" href="#spring-cloud">#</a></h3>
<p><u><em>父 pom</em></u></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;</span><span class="n">properties</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">maven</span><span class="p">.</span><span class="na">compiler</span><span class="p">.</span><span class="na">source</span><span class="o">&gt;</span><span class="n">11</span><span class="o">&lt;/</span><span class="n">maven</span><span class="p">.</span><span class="na">compiler</span><span class="p">.</span><span class="na">source</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">maven</span><span class="p">.</span><span class="na">compiler</span><span class="p">.</span><span class="na">target</span><span class="o">&gt;</span><span class="n">11</span><span class="o">&lt;/</span><span class="n">maven</span><span class="p">.</span><span class="na">compiler</span><span class="p">.</span><span class="na">target</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">project</span><span class="p">.</span><span class="na">build</span><span class="p">.</span><span class="na">sourceEncoding</span><span class="o">&gt;</span><span class="n">UTF</span><span class="o">-</span><span class="n">8</span><span class="o">&lt;/</span><span class="n">project</span><span class="p">.</span><span class="na">build</span><span class="p">.</span><span class="na">sourceEncoding</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">project</span><span class="p">.</span><span class="na">reporting</span><span class="p">.</span><span class="na">outputEncoding</span><span class="o">&gt;</span><span class="n">UTF</span><span class="o">-</span><span class="n">8</span><span class="o">&lt;/</span><span class="n">project</span><span class="p">.</span><span class="na">reporting</span><span class="p">.</span><span class="na">outputEncoding</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">projectlombok</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">1</span><span class="p">.</span><span class="na">18</span><span class="p">.</span><span class="na">20</span><span class="o">&lt;/</span><span class="n">org</span><span class="p">.</span><span class="na">projectlombok</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">2021</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">3</span><span class="o">&lt;/</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">alibaba</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">2021</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">4</span><span class="p">.</span><span class="na">0</span><span class="o">&lt;/</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">alibaba</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">mybatis</span><span class="o">-</span><span class="n">plus</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">3</span><span class="p">.</span><span class="na">4</span><span class="p">.</span><span class="na">3</span><span class="o">&lt;/</span><span class="n">mybatis</span><span class="o">-</span><span class="n">plus</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">hutool</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">5</span><span class="p">.</span><span class="na">8</span><span class="p">.</span><span class="na">25</span><span class="o">&lt;/</span><span class="n">hutool</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">mysql</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">8</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">23</span><span class="o">&lt;/</span><span class="n">mysql</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">knife4j</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="n">4</span><span class="p">.</span><span class="na">3</span><span class="p">.</span><span class="na">0</span><span class="o">&lt;/</span><span class="n">knife4j</span><span class="p">.</span><span class="na">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">properties</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="o">&lt;!--</span><span class="w"> </span><span class="n">对依赖包进行管理</span><span class="w"> </span><span class="o">--&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">dependencyManagement</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">dependencies</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    	</span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="o">&lt;/</span><span class="n">dependencies</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">dependencyManagement</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p><u><em>子项目 pom</em></u></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="o">&lt;</span><span class="n">parent</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="kd">super</span><span class="w"> </span><span class="n">artifactId</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="p">.</span><span class="na">yoo</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;</span><span class="n">1</span><span class="p">.</span><span class="na">0</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="o">&lt;/</span><span class="n">version</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">parent</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>统一dependency version</strong></em></p>
<p><strong>垂直划分项目</strong></p>
<h4 id="user-service">User-Service<a hidden class="anchor" aria-hidden="true" href="#user-service">#</a></h4>
<p><em>nacos托管微服务IP地址</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nl">java</span><span class="p">:</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">	</span><span class="n">com</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">        </span><span class="n">yoo</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">            </span><span class="n">controller</span><span class="p">:</span><span class="w"> </span><span class="n">SpringMVC</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">            </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="n">IService</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ServiceImpl</span><span class="w">   
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="n">mapper</span><span class="p">:</span><span class="w"> </span><span class="n">BaseMapper</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">client</span><span class="p">:</span><span class="w"> </span><span class="nd">@Openfeign</span><span class="p">,</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="n">call</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="n">domain</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                   </span><span class="n">po</span><span class="p">:</span><span class="w"> </span><span class="n">properity</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">reflex</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">table</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                   </span><span class="n">vo</span><span class="p">:</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">only</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="n">properity</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="o">----------------------------------</span><span class="w">                       
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                       
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="nl">resource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">	</span><span class="n">application</span><span class="p">.</span><span class="na">yaml</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">		</span><span class="n">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">  			</span><span class="n">port</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="nl">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">          </span><span class="n">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">user</span><span class="o">-</span><span class="n">service</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">service</span><span class="o">-</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">          </span><span class="n">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="n">active</span><span class="p">:</span><span class="w"> </span><span class="n">dev</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">          </span><span class="n">datasource</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="n">url</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="n">driver</span><span class="o">-</span><span class="kd">class</span><span class="err">-</span><span class="nc">name</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="n">username</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">            </span><span class="n">password</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">		  </span><span class="err">#</span><span class="w"> </span><span class="err">⭐</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">address</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">          </span><span class="n">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">              </span><span class="n">server</span><span class="o">-</span><span class="n">addr</span><span class="p">:</span><span class="w"> </span><span class="n">127</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">0</span><span class="p">.</span><span class="na">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="n">mybatis</span><span class="o">-</span><span class="n">plus</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">      </span><span class="n">configuration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">		</span><span class="err">#</span><span class="w"> </span><span class="n">枚举字段类型映射到数据库表指定类型</span><span class="err">，</span><span class="w"> </span><span class="n">下划线转驼峰</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="k">default</span><span class="o">-</span><span class="kd">enum</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">handler</span><span class="p">:</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">baomidou</span><span class="p">.</span><span class="na">mybatisplus</span><span class="p">.</span><span class="na">core</span><span class="p">.</span><span class="na">handlers</span><span class="p">.</span><span class="na">MybatisEnumTypeHandler</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="n">global</span><span class="o">-</span><span class="n">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">db</span><span class="o">-</span><span class="n">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">          </span><span class="n">update</span><span class="o">-</span><span class="n">strategy</span><span class="p">:</span><span class="w"> </span><span class="n">not_null</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">          </span><span class="n">id</span><span class="o">-</span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">auto</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="nl">knife4j</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">      </span><span class="n">enable</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">      </span><span class="n">openapi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="n">title</span><span class="p">:</span><span class="w"> </span><span class="n">用户服务接口文档</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="n">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;信息&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="n">email</span><span class="p">:</span><span class="w"> </span><span class="n">1410124534</span><span class="nd">@qq.com</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="n">concat</span><span class="p">:</span><span class="w"> </span><span class="n">longwei</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="n">group</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">          </span><span class="k">default</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">            </span><span class="n">group</span><span class="o">-</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="k">default</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">            </span><span class="n">api</span><span class="o">-</span><span class="n">rule</span><span class="p">:</span><span class="w"> </span><span class="kn">package</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">            </span><span class="nn">api</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">yoo</span><span class="p">.</span><span class="na">controller</span><span class="w">
</span></span></span></code></pre></div><h5 id="openfeign-远程调用微服务"><em><strong>OpenFeign 远程调用微服务</strong></em><a hidden class="anchor" aria-hidden="true" href="#openfeign-远程调用微服务">#</a></h5>
<p><em>Step 1.</em>  <em><u>pom添加对应依赖</u></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="o">&lt;!--</span><span class="w"> </span><span class="n">openfeign</span><span class="w"> </span><span class="o">--&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">openfeign</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="o">&lt;!--</span><span class="w"> </span><span class="n">loadbalancer</span><span class="w"> </span><span class="o">--&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">loadbalancer</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p><em>Step 2.</em> <em><u>开启Openfeign功能</u></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@EnableFeignClients</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">xxxApplicaiotn</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em>Step 3.  <u>编写Openfeign调用接口</u></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;order-service&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">OrderClient</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;/order/{id}&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">OrderVO</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getOrderByUserId</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">)</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">  
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// @Interface : @XXXMapping(&#34;/{param}&#34;)     &lt;===</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">//                                             ||</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// Method     : (@PathVariable(&#34;param&#34;) Type name)</span><span class="w">
</span></span></span></code></pre></div><hr>
<h4 id="gateway-setup">Gateway setup<a hidden class="anchor" aria-hidden="true" href="#gateway-setup">#</a></h4>
<p><em><strong>前端统一请求 =&gt;8080网关 =&gt; 分发调度给微服务</strong></em>   <em>类似nginx</em></p>
<p><em>dependencies</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c">&lt;!--网关--&gt;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="c">&lt;!--nacos discovery--&gt;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c">&lt;!--负载均衡--&gt;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-loadbalancer<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>⭐⭐⭐<em>application.yaml</em>  配置转发接口映射</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">gateway-service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">      </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">  </span><span class="c">### 路由</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">item</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://user-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span>- <span class="l">Path=/user/**</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">order</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://order-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span>- <span class="l">Path=/order/**</span><span class="w">
</span></span></span></code></pre></div><p><em>StarterClass</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@SpringBootApplication</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GatewayApplication</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">GatewayApplication</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h4 id="网关登录统一拦截">网关登录统一拦截<a hidden class="anchor" aria-hidden="true" href="#网关登录统一拦截">#</a></h4>
<p><em>好比于守卫，统一校验登录Token，进行放行或者拦截</em></p>
<p><em>pom 依赖</em>    <em>支持yaml读取配置</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">    <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p><em>application.yaml</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">hm</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">auth</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nt">excludePaths</span><span class="p">:</span><span class="w"> </span><span class="c"># 无需登录校验的路径</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">      </span>- <span class="l">/user/login</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">      </span>- <span class="l">/item/search</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">      </span>- <span class="l">/test/**</span><span class="w">
</span></span></span></code></pre></div><p><em>属性类</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;hm.auth&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthProperties</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">includePaths</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">excludePaths</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em>GlobalFilter</em> <em>全局拦截</em></p>
<p>先根据配置文件，决定是否拦截，拦=&gt;检查Token=&gt;存入信息在Header =&gt; 微服务(从Header中拿取信息)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@RequiredArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthGlobalFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GlobalFilter</span><span class="p">,</span><span class="w"> </span><span class="n">Ordered</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// 已加入Spring容器</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AuthProperties</span><span class="w"> </span><span class="n">authProperties</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// 未加入，手动new</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AntPathMatcher</span><span class="w"> </span><span class="n">antPathMatcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AntPathMatcher</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">ServerWebExchange</span><span class="w"> </span><span class="n">exchange</span><span class="p">,</span><span class="w"> </span><span class="n">GatewayFilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="c1">// 获取request对象</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">ServerHttpRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// 判断路径是否需要拦截</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">isExclude</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getPath</span><span class="p">().</span><span class="na">toString</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="c1">// 放行</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="c1">// 获取Header中的Token</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;authorization&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CollUtil</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">(</span><span class="n">headers</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">headers</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="c1">// 简单模拟JwtToken校验</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="c1">// 校验成功</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">            </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1L</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">            </span><span class="c1">// 校验失败 =&gt; 直接返回UNAUTHORIZED状态码</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">ServerHttpResponse</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">setStatusCode</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">UNAUTHORIZED</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">setComplete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userId</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="c1">// 将用户信息存储在转发请求头中</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">ServerWebExchange</span><span class="w"> </span><span class="n">ex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">mutate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">builder</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">                    </span><span class="n">builder</span><span class="p">.</span><span class="na">header</span><span class="p">(</span><span class="s">&#34;user-info&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userInfo</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">                </span><span class="p">})</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isExclude</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">pathPattern</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">authProperties</span><span class="p">.</span><span class="na">getExcludePaths</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">antPathMatcher</span><span class="p">.</span><span class="na">match</span><span class="p">(</span><span class="n">pathPattern</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getOrder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h4 id="service-interceptor">Service Interceptor<a hidden class="anchor" aria-hidden="true" href="#service-interceptor">#</a></h4>
<p>ThreadLocal，线程自己的独享空间，用来存储请求中携带的信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w">  </span><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUserId</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">tl</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">getUserId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">tl</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeUserId</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">tl</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>执行服务前，将request header中携带的信息取出来</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserInfoInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HandlerInterceptor</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">preHandle</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&#34;user-info&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">UserContext</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="na">parseLong</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterCompletion</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">UserContext</span><span class="p">.</span><span class="na">removeUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h4 id="抽取公共部分">抽取公共部分<a hidden class="anchor" aria-hidden="true" href="#抽取公共部分">#</a></h4>
<h4 id="common-service">common-service<a hidden class="anchor" aria-hidden="true" href="#common-service">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">com</span><span class="p">.</span><span class="na">yoo</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">xxx</span><span class="w">
</span></span></span></code></pre></div><p>其他module只要在pom内引用就行</p>
<p>公共部分如何区别不同的服务 - 有些子模块需要但另一些子模块不需要的Class（这个类会被Spring托管，但不想注入Spring容器中）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@ConditionalOnClass</span><span class="p">(</span><span class="n">DispatherServlet</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>在其他微服务加上，显示指定配置文件位置</p>
<p><strong>spring.factories</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="l">org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.yoo.common.config.MvcConfig</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="rabbitmq">RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#rabbitmq">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">publisher</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">exchanger</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="w">
</span></span></span></code></pre></div><p>exchanger:</p>
<ul>
<li>fanout exchanger:  广播</li>
<li>direct exchanger：根据key发送给对应queue</li>
<li>topic exchanger: 根据key进行匹配一组符合的queue</li>
</ul>
<p>消息订阅</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;???&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">method</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="c1">// </span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>消息发布</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">直接发送给Queue</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">queueName</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">发送给交换机</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ExchangeName</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;RoutingKey&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">MessageObject</span><span class="p">)</span><span class="w">    
</span></span></span></code></pre></div><p>消息格式转换</p>
<p>Object =&gt; Binary  将发送的对象序列化为JSON格式字符串？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Jackson2JSONMessageConverter</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>队列交换机和绑定</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Queue</span><span class="w"> </span><span class="nf">orderQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Queue</span><span class="p">(</span><span class="s">&#34;orderQueue&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// Spring 容器会确保同一个 @Bean 方法只会被调用一次，返回的对象会被缓存并重复使用</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">DirectExchange</span><span class="w"> </span><span class="nf">orderExchange</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DirectExchange</span><span class="p">(</span><span class="s">&#34;orderExchange&#34;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Binding</span><span class="w"> </span><span class="nf">binding</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BindingBuilder</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">orderQueue</span><span class="p">()).</span><span class="na">to</span><span class="p">(</span><span class="n">orderExchange</span><span class="p">()).</span><span class="na">with</span><span class="p">(</span><span class="s">&#34;orderRoutingKey&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<p>可靠传输</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c"># 发送确认</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">publisher-confirm-type</span><span class="p">:</span><span class="w"> </span><span class="l">none|correlated|simple</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">none</span><span class="p">:</span><span class="w"> </span><span class="l">无确认机制，性能最好，不可靠</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nt">correlated</span><span class="p">:</span><span class="w"> </span><span class="l">异步关联确认,不阻塞线程,高可靠性,性能中、异步回调场景</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nt">simple</span><span class="p">:</span><span class="w"> </span><span class="l">同步阻塞确认,阻塞线程,性能底，可靠。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c"># 接收确认</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">ackknowledge-mode</span><span class="p">:</span><span class="w"> </span><span class="l">none|manual|auto</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nt">none</span><span class="p">:</span><span class="w"> </span><span class="l">无确认机制</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nt">manual</span><span class="p">:</span><span class="w"> </span><span class="l">手工ack</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">auto</span><span class="p">:</span><span class="w"> </span><span class="l">自动ack，根据抛出的异常类型，决定重发还是reject</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c"># 重连配置</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="nt">retry</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">	</span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># 启用重试机制</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">	</span><span class="nt">initial-interval</span><span class="p">:</span><span class="w"> </span><span class="l">1000ms</span><span class="w"> </span><span class="c"># 第一次失败等待的时长</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">	</span><span class="nt">multiplier</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 每次失败等待时间成x倍增长</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">	</span><span class="nt">max-attempts</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 最大重试次数</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">	</span><span class="nt">stateless</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># </span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="c"># 如果接口幂等(调用多次都不会重复扣款) =&gt; stateless:true 每次重试都是独立的，不保留状态 ⭐性能高</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="c"># 非幂等操作（多次执行可能有副作用）</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="l">stateless:false</span><span class="w"> </span><span class="c"># 带状态</span><span class="w">
</span></span></span></code></pre></div><p><strong>死信交换机</strong></p>
<p><img alt="image-20250113195557165" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/Fpey0H8HmDHLDSYiTZer2GyQEx8P"></p>
<p>定义交换机和队列</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">DirectExchange</span><span class="w"> </span><span class="nf">createDLExchanger</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ExchangeBuilder</span><span class="p">.</span><span class="na">directExchange</span><span class="p">(</span><span class="s">&#34;dl.direct&#34;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Queue</span><span class="w"> </span><span class="nf">createDLQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 队列信息是否持久化到磁盘? durable(持久化?)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">QueueBuilder</span><span class="p">.</span><span class="na">nonDurable</span><span class="p">(</span><span class="s">&#34;dl.queue&#34;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Binding</span><span class="w"> </span><span class="nf">toBindingDL</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BindingBuilder</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">createDLQueue</span><span class="p">()).</span><span class="na">to</span><span class="p">(</span><span class="n">createDLExchanger</span><span class="p">()).</span><span class="na">with</span><span class="p">(</span><span class="s">&#34;dlRoutingKey&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// -----------------------</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">FanoutExchange</span><span class="w"> </span><span class="nf">createTTLExchanger</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ExchangeBuilder</span><span class="p">.</span><span class="na">fanoutExchange</span><span class="p">(</span><span class="s">&#34;ttl.fanout&#34;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Queue</span><span class="w"> </span><span class="nf">createTTLQueue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="c1">// 队列信息是否持久化到磁盘? durable(持久化?)</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">QueueBuilder</span><span class="p">.</span><span class="na">nonDurable</span><span class="p">(</span><span class="s">&#34;ttl.queue&#34;</span><span class="p">).</span><span class="na">deadLetterExchange</span><span class="p">(</span><span class="s">&#34;dl.direct&#34;</span><span class="p">).</span><span class="na">deadLetterRoutingKey</span><span class="p">(</span><span class="s">&#34;dlRoutingKey&#34;</span><span class="p">).</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Binding</span><span class="w"> </span><span class="nf">toBinding</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BindingBuilder</span><span class="p">.</span><span class="na">bind</span><span class="p">(</span><span class="n">createTTLQueue</span><span class="p">()).</span><span class="na">to</span><span class="p">(</span><span class="n">createTTLExchanger</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>步骤1：发送信息并设置过期时间</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1:未付款; 2.已付款 ...</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 模拟用户下单</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;order:userId:status&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// ... 扣货物库存  -1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">MessageProperties</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MessageProperties</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">properties</span><span class="p">.</span><span class="na">setExpiration</span><span class="p">(</span><span class="s">&#34;20000&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 20秒过期，过期后进入死信队列</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;code&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;200&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;msg&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Hi, RabbitMQ. This is a dead letter.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">msgContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="p">.</span><span class="na">writeValueAsString</span><span class="p">(</span><span class="n">map</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Message</span><span class="p">(</span><span class="n">msgContent</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(),</span><span class="w"> </span><span class="n">properties</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&#34;ttl.fanout&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>步骤2：用户调用接口进行付款</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 数据库</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// ....</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 模拟付款成功</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="s">&#34;order:userId:status&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;2&#34;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>步骤3：死信队列 处理逻辑</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;dl.queue&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">deadLetterQueue</span><span class="p">(</span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">ObjectMapper</span><span class="w"> </span><span class="n">mapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ObjectMapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapper</span><span class="p">.</span><span class="na">readValue</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;receive Msg ... @@@&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;code&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;msg&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;order:userId:status&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// ... 还原货物库存  +1</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;2&#34;</span><span class="p">)){</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// 订单支付完成，实现收尾工作</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;订单已支付，生成后续...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>解耦各个部分。</p>
<hr>
<h3 id="苍穹外卖">苍穹外卖<a hidden class="anchor" aria-hidden="true" href="#苍穹外卖">#</a></h3>
<h4 id="aop使用-自动补全参数共同信息">AOP使用-自动补全参数共同信息<a hidden class="anchor" aria-hidden="true" href="#aop使用-自动补全参数共同信息">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 自定义注解</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">METHOD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">AutoFill</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">OperationType</span><span class="w"> </span><span class="nf">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Aspect</span><span class="w">  </span><span class="c1">// !!! 交给Spring托管</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AutoFillAspect</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="c1">// 任何 returnType package.?.class.method(params)  &amp;&amp; with annotation</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Pointcut</span><span class="p">(</span><span class="s">&#34;execution(* com.hmwm.service.*.*(..)) &amp;&amp; @annotation(com.hmwm.common.AutoFill)&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">autoFillPointCut</span><span class="p">(){}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&#34;autoFillPointCut()&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">autoFill</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">NoSuchMethodException</span><span class="p">,</span><span class="w"> </span><span class="n">InvocationTargetException</span><span class="p">,</span><span class="w"> </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Start fill common field.&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// get method annotation value</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">MethodSignature</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MethodSignature</span><span class="p">)</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getSignature</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">AutoFill</span><span class="w"> </span><span class="n">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">signature</span><span class="p">.</span><span class="na">getMethod</span><span class="p">().</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">AutoFill</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="n">OperationType</span><span class="w"> </span><span class="n">operationType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">annotation</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="c1">// 拦截的method的参数列表</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">getArgs</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="o">==</span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="na">length</span><span class="o">==</span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;current method not params&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="c1">// 第一个⭐参数⭐ 需要填充的对象. 提前交流指定:这里为User Obj</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="c1">// Long currentId = BaseContext.getCurrentId();</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// 给这个arg填充值</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">operationType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OperationType</span><span class="p">.</span><span class="na">INSERT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="c1">// getDeclaredMethod(method_name, params_type)</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">setCreateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="n">AutoFillConstant</span><span class="p">.</span><span class="na">SET_CREATE_TIME</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">(),</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="n">Method</span><span class="w"> </span><span class="n">setUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getDeclaredMethod</span><span class="p">(</span><span class="n">AutoFillConstant</span><span class="p">.</span><span class="na">SET_UPDATE_TIME</span><span class="p">.</span><span class="na">getMethodName</span><span class="p">(),</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">            </span><span class="c1">// method-obj: invoke(object, params) 方法(对象, 参数)</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="n">setCreateTime</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">atZone</span><span class="p">(</span><span class="n">ZoneId</span><span class="p">.</span><span class="na">systemDefault</span><span class="p">()).</span><span class="na">toInstant</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="n">setUpdateTime</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">atZone</span><span class="p">(</span><span class="n">ZoneId</span><span class="p">.</span><span class="na">systemDefault</span><span class="p">()).</span><span class="na">toInstant</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@AutoFill</span><span class="p">(</span><span class="n">OperationType</span><span class="p">.</span><span class="na">INSERT</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">addUser</span><span class="p">(</span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>枚举类</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 枚举类在 Java 中是通过 enum 关键字定义的，但它本质上是一个类。每个枚举常量都是该枚举类的一个实例。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">AutoFillConstant</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">SET_CREATE_TIME</span><span class="p">(</span><span class="s">&#34;setCreateTime&#34;</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">SET_UPDATE_TIME</span><span class="p">(</span><span class="s">&#34;setUpdateTime&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="p">;</span><span class="w"> </span><span class="c1">// 存储方法名的字段</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 构造函数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">AutoFillConstant</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">methodName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">methodName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">methodName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;AutoFillConstant: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">methodName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// 获取方法名</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getMethodName</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">methodName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h4 id="定时任务">定时任务<a hidden class="anchor" aria-hidden="true" href="#定时任务">#</a></h4>
<p>利用@Scheduled注解</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ScheduledTask</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="c1">// 秒 分 时 天 周 月 年                     年/月/日  时/分/秒</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 * * * * ? &#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 这里 xxxx/xx/xx xx:xx:x0 执行</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processTimeOutOrder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;process Timeout task ...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="threadlocal-线程专享资源">ThreadLocal-线程专享资源<a hidden class="anchor" aria-hidden="true" href="#threadlocal-线程专享资源">#</a></h4>
<p>可以请求来的时候存储一些 环境变量  ThreadLocal&lt;Object&gt;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BaseContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">threadLocal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ThreadLocal</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCurrentId</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">threadLocal</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="nf">getCurrentId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">threadLocal</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeCurrentId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">threadLocal</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="websocket">Websocket<a hidden class="anchor" aria-hidden="true" href="#websocket">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Component</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@ServerEndpoint</span><span class="p">(</span><span class="s">&#34;/websocket&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyWebSocketEndpoint</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="c1">// 会话对象  server:client == 1:n</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sessionMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@OnOpen</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onOpen</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;onOpen: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">session</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">sendMsg</span><span class="p">(</span><span class="s">&#34;Hi, can I help you?&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@OnMessage</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;receive Message: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="n">sendMsg</span><span class="p">(</span><span class="s">&#34;Yse! I am thinking ... this question!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="nd">@OnClose</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">OnClose</span><span class="p">(</span><span class="n">Session</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">sendMsg</span><span class="p">(</span><span class="s">&#34;Bye!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;OnClose: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMsg</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">sessionMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">sid</span><span class="p">).</span><span class="na">getBasicRemote</span><span class="p">().</span><span class="na">sendText</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span><span class="w">  </span><span class="c1">// 向session对象sendTest</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="文件下载功能">文件下载功能<a hidden class="anchor" aria-hidden="true" href="#文件下载功能">#</a></h4>
<p>很简单，利用Response进行。 需要设置response内容格式和response-header</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">ClassPathResource</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathResource</span><span class="p">(</span><span class="s">&#34;static/file_name.zip&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">resource</span><span class="p">.</span><span class="na">exists</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;file not exists!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">notFound</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">HttpHeaders</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHeaders</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">headers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">HttpHeaders</span><span class="p">.</span><span class="na">CONTENT_DISPOSITION</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;attachment; filename=\&#34;file_name.zip\&#34;&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// attachment 附件</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">ResponseEntity</span><span class="p">.</span><span class="na">ok</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span><span class="w">  </span><span class="c1">// &lt;= header</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_OCTET_STREAM</span><span class="p">)</span><span class="w"> </span><span class="c1">// &lt;= contentType stream流式</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">body</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;= file</span><span class="w">
</span></span></span></code></pre></div><h4 id="excel处理">Excel处理<a hidden class="anchor" aria-hidden="true" href="#excel处理">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">poi</span><span class="w"> </span><span class="c1">// 利用这个Apache POI package</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">XSSFWorkbook</span><span class="w"> </span><span class="n">excel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XSSFWorkbook</span><span class="p">();</span><span class="w"> </span><span class="c1">// 类似excel文件</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">XSSFSheet</span><span class="w"> </span><span class="n">sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excel</span><span class="p">.</span><span class="na">createSheet</span><span class="p">(</span><span class="s">&#34;sheet1&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// sheet</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">XSSFRow</span><span class="w"> </span><span class="n">row1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sheet</span><span class="p">.</span><span class="na">createRow</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">row1</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">1</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;姓名&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">row1</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">2</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;年纪&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">row1</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">3</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;城市&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">XSSFRow</span><span class="w"> </span><span class="n">row2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sheet</span><span class="p">.</span><span class="na">createRow</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">row2</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">1</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;韦龙&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">row2</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">2</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="n">23</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">row2</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">3</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;桂林&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">XSSFRow</span><span class="w"> </span><span class="n">row3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sheet</span><span class="p">.</span><span class="na">createRow</span><span class="p">(</span><span class="n">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">row3</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">1</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;张三&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">row3</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">2</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="n">23</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="n">row3</span><span class="p">.</span><span class="na">createCell</span><span class="p">(</span><span class="n">3</span><span class="p">).</span><span class="na">setCellValue</span><span class="p">(</span><span class="s">&#34;杭州&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&#34;static/staff_info.xlsx&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="p">(</span><span class="n">file</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="n">excel</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="n">stream</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="n">excel</span><span class="p">.</span><span class="na">close</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://121.40.252.207/tags/java/">Java</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://121.40.252.207/posts/learning/ecg_exp/">
    <span class="title">« Prev</span>
    <br>
    <span>ECG论文和实验</span>
  </a>
  <a class="next" href="http://121.40.252.207/posts/learning/paper_reading1/">
    <span class="title">Next »</span>
    <br>
    <span>深度学习论文汇总1</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://121.40.252.207/">LongCoding&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
