<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>LongCoding&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="高频SQL50题
查询
Where&amp;GroupBy&amp;HAVING
SELECT id, revenue  # 某个用户2021年可能有多项记录
FROM users
Where year = 2021

SELECT id, SUM(revenue) 
FROM users
Where year = 2021  # 1. 先筛选出此年份所有记录
Group By id        # 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。

SELECT id
FROM users
Where year = 2021          # 1. 先筛选记录
Group By id                # 2. 分组
HAVING SUM(revenue) &gt; 1000  #  3. 聚合分组字段记录 并 判断
查找没买过东西的顾客
# 1. NOT EXISTS
SELECT `name` AS `Customers`
FROM `Customers` AS c
WHERE NOT EXISTS (
    SELECT `customerId`
    FROM `Orders` AS o
    Where o.customerId = c.id    
)

# 2. Left Join 
# example
SELECT c.id AS id, c.name, o.id AS oid
FROM customers AS c LEFT JOIN orders AS o
on c.id = o.customerId 

SELECT `name` as `Customers`
FROM customers AS c LEFT JOIN orders AS o
on c.id = o.customerId 
WHERE o.id is NULL
计算特殊奖金
编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 奇数 并且他的名字不是以 &#39;M&#39; 开头，那么他的奖金是他工资的 100% ，否则奖金为 0 。">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/learning/sql%E5%AD%A6%E4%B9%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.488b476fe12f895e41e7473bc23e9831609c74c2bdb368da996800ef083721e1.css" integrity="sha256-SItHb&#43;EviV5B50c7wj6YMWCcdMK9s2jamWgA7wg3IeE=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/learning/sql%E5%AD%A6%E4%B9%A0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
 <script type="text/javascript"
         async
         src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
 MathJax.Hub.Config({
   tex2jax: {
     inlineMath: [['$','$'], ['\\(','\\)']],
     displayMath: [['$$','$$'], ['\[\[','\]\]']],
     processEscapes: true,
     processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
<meta property="og:url" content="http://localhost:1313/posts/learning/sql%E5%AD%A6%E4%B9%A0/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="LongCoding&#39;s Blog">
  <meta property="og:description" content="高频SQL50题 查询 Where&amp;GroupBy&amp;HAVING SELECT id, revenue # 某个用户2021年可能有多项记录 FROM users Where year = 2021 SELECT id, SUM(revenue) FROM users Where year = 2021 # 1. 先筛选出此年份所有记录 Group By id # 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。 SELECT id FROM users Where year = 2021 # 1. 先筛选记录 Group By id # 2. 分组 HAVING SUM(revenue) &gt; 1000 # 3. 聚合分组字段记录 并 判断 查找没买过东西的顾客 # 1. NOT EXISTS SELECT `name` AS `Customers` FROM `Customers` AS c WHERE NOT EXISTS ( SELECT `customerId` FROM `Orders` AS o Where o.customerId = c.id ) # 2. Left Join # example SELECT c.id AS id, c.name, o.id AS oid FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId SELECT `name` as `Customers` FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId WHERE o.id is NULL 计算特殊奖金 编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 奇数 并且他的名字不是以 &#39;M&#39; 开头，那么他的奖金是他工资的 100% ，否则奖金为 0 。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="">
<meta name="twitter:description" content="高频SQL50题
查询
Where&amp;GroupBy&amp;HAVING
SELECT id, revenue  # 某个用户2021年可能有多项记录
FROM users
Where year = 2021

SELECT id, SUM(revenue) 
FROM users
Where year = 2021  # 1. 先筛选出此年份所有记录
Group By id        # 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。

SELECT id
FROM users
Where year = 2021          # 1. 先筛选记录
Group By id                # 2. 分组
HAVING SUM(revenue) &gt; 1000  #  3. 聚合分组字段记录 并 判断
查找没买过东西的顾客
# 1. NOT EXISTS
SELECT `name` AS `Customers`
FROM `Customers` AS c
WHERE NOT EXISTS (
    SELECT `customerId`
    FROM `Orders` AS o
    Where o.customerId = c.id    
)

# 2. Left Join 
# example
SELECT c.id AS id, c.name, o.id AS oid
FROM customers AS c LEFT JOIN orders AS o
on c.id = o.customerId 

SELECT `name` as `Customers`
FROM customers AS c LEFT JOIN orders AS o
on c.id = o.customerId 
WHERE o.id is NULL
计算特殊奖金
编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 奇数 并且他的名字不是以 &#39;M&#39; 开头，那么他的奖金是他工资的 100% ，否则奖金为 0 。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "",
      "item": "http://localhost:1313/posts/learning/sql%E5%AD%A6%E4%B9%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "name": "",
  "description": "高频SQL50题 查询 Where\u0026amp;GroupBy\u0026amp;HAVING SELECT id, revenue # 某个用户2021年可能有多项记录 FROM users Where year = 2021 SELECT id, SUM(revenue) FROM users Where year = 2021 # 1. 先筛选出此年份所有记录 Group By id # 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。 SELECT id FROM users Where year = 2021 # 1. 先筛选记录 Group By id # 2. 分组 HAVING SUM(revenue) \u0026gt; 1000 # 3. 聚合分组字段记录 并 判断 查找没买过东西的顾客 # 1. NOT EXISTS SELECT `name` AS `Customers` FROM `Customers` AS c WHERE NOT EXISTS ( SELECT `customerId` FROM `Orders` AS o Where o.customerId = c.id ) # 2. Left Join # example SELECT c.id AS id, c.name, o.id AS oid FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId SELECT `name` as `Customers` FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId WHERE o.id is NULL 计算特殊奖金 编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 奇数 并且他的名字不是以 'M' 开头，那么他的奖金是他工资的 100% ，否则奖金为 0 。\n",
  "keywords": [
    
  ],
  "articleBody": "高频SQL50题 查询 Where\u0026GroupBy\u0026HAVING SELECT id, revenue # 某个用户2021年可能有多项记录 FROM users Where year = 2021 SELECT id, SUM(revenue) FROM users Where year = 2021 # 1. 先筛选出此年份所有记录 Group By id # 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。 SELECT id FROM users Where year = 2021 # 1. 先筛选记录 Group By id # 2. 分组 HAVING SUM(revenue) \u003e 1000 # 3. 聚合分组字段记录 并 判断 查找没买过东西的顾客 # 1. NOT EXISTS SELECT `name` AS `Customers` FROM `Customers` AS c WHERE NOT EXISTS ( SELECT `customerId` FROM `Orders` AS o Where o.customerId = c.id ) # 2. Left Join # example SELECT c.id AS id, c.name, o.id AS oid FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId SELECT `name` as `Customers` FROM customers AS c LEFT JOIN orders AS o on c.id = o.customerId WHERE o.id is NULL 计算特殊奖金 编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 奇数 并且他的名字不是以 'M' 开头，那么他的奖金是他工资的 100% ，否则奖金为 0 。\n返回的结果按照 employee_id 排序。\nIF用法 IF(condition, True, False) AS alias\nselect `employee_id`, IF(name not like 'M%' and employee_id%2 = 1, salary, 0) AS `bonus` from Employees Order by employee_id ASC 购买了产品 A 和产品 B 却没有购买产品 C 的顾客 Where 中 多重 判断\nselect customer_id, customer_name from Customers as c where exists ( select o.customer_id from Orders as o where o.customer_id=c.customer_id and product_name = 'A' ) and exists ( select o.customer_id from Orders as o where o.customer_id=c.customer_id and product_name = 'B' ) and not exists ( select o.customer_id from Orders as o where o.customer_id=c.customer_id and product_name = 'C' ) Order By c.customer_id ASC 连表，分组判断\nSELECT c.customer_id, c.customer_name FROM `Orders` as o left join `Customers` as c on o.customer_id = c.customer_id Group By o.customer_id HAVING SUM(product_name = 'A') \u003e 0 and SUM(product_name = 'B') \u003e 0 and SUM(product_name = 'C') = 0 Order By c.customer_id ASC [o.id, o.customerId, o.product_name, c.customerId, c.name] 1 1 'A' 1 X 2 1 'B' 1 X 3 2 'A' 2 Y 4 2 'B' 2 Y 5 2 'C' 2 Y Group By c.customerId 1 1 'A' 1 X 2 1 'B' 1 X 3 2 'A' 2 Y 4 2 'B' 2 Y 5 2 'C' 2 Y SUM(express condition) ? condition # 对于String是统计条数 每位学生成绩最好的科目 所有有相同科目成绩一样，选择科目id小的\n+---------------+---------+ | Column Name | Type | +---------------+---------+ | student_id | int | | course_id | int | | grade | int | +---------------+---------+ # 1\n# 查某学生成绩最好的那些科目，因为可能有重复的 SELECT student_id, MAX(grade) AS grade From Enrollments Group By student_id # 2\n# 查某学生最好的那些科目中 courseId最小的 SELECT student_id, MIN(courseId) AS course_id, grade From Enrollments # 行 =\u003e 最好的那些科目 Where (student_id, grade) in ( SELECT student_id, MAX(grade) AS grade From Enrollments Group By student_id ) Group By student_id Order By student_id ASC 连接 Left Join\n拓展左边，即使右表某些行不存在（会出现重复行）\n=\u003e **Right Join **同理\nSELECT * FROM `customers` as c LEFT JOIN orders as o ON c.id = o.customerId Inner Join =\u003e 只展示左右表均成功对接上的行\n没有卖出的商家 写一个解决方案, 报告所有在 2020 年度没有任何卖出的卖家的名字。\n返回结果按照 seller_name 升序排列。\nSELECT seller_name FROM Seller WHERE seller_id not in ( SELECT DISTINCT Orders.seller_id FROM Orders WHERE Orders.sale_date like '2020%' ) ORDER By seller_name ASC 排名靠前的旅行者 返回的结果表单，以 travelled_distance 降序排列 ，如果有两个或者更多的用户旅行了相同的距离, 那么再以 name 升序排列 。\nSELECT name, COALESCE(SUM(distance), 0) AS travelled_distance From Users Left join Rides On Rides.user_id = Users.id Group By Rides.user_id ORDER BY travelled_distance DESC, name ASC; # 使用别名排序 607. 销售员 编写解决方案，找出没有任何与名为 “RED” 的公司相关的订单的所有销售人员的姓名。\nSELECT name FROM SalesPerson WHERE sales_id not in ( SELECT DISTINCT Orders.sales_id FROM Orders LEFT JOIN Company ON Orders.com_id = Company.com_id WHERE name = 'RED' ) 计算布尔表达式的值 输入：\rVariables 表:\r+------+-------+\r| name | value |\r+------+-------+\r| x | 66 |\r| y | 77 |\r+------+-------+\rExpressions 表:\r+--------------+----------+---------------+\r| left_operand | operator | right_operand |\r+--------------+----------+---------------+\r| x | \u003e | y |\r| x | \u003c | y |\r| x | = | y |\r| y | \u003e | x |\r| y | \u003c | x |\r| x | = | x |\r+--------------+----------+---------------+\r输出:\r+--------------+----------+---------------+-------+\r| left_operand | operator | right_operand | value |\r+--------------+----------+---------------+-------+\r| x | \u003e | y | false |\r| x | \u003c | y | true |\r| x | = | y | false |\r| y | \u003e | x | true |\r| y | \u003c | x | false |\r| x | = | x | true |\r+--------------+----------+---------------+-------+ SELECT e.left_operand, e.operator, e.right_operand, CASE e.operator WHEN '\u003e' THEN IF(v1.value\u003ev2.value, 'true', 'false') WHEN '\u003c' THEN IF(v1.value\u003cv2.value, 'true', 'false') ELSE IF(v1.value=v2.value, 'true', 'false') END value FROM Expressions e LEFT JOIN Variables v1 ON e.left_operand = v1.name LEFT JOIN Variables v2 ON e.right_operand = v2.name 考点：多重连表 e.(…)v1.(…)v2.(…)\n条件判断表达式\ncase [sign]\n​\twhen exp then result[if(exp, true, false)]\n​\twhen exp then result\n​\telse result\nend\n查询球队积分 分别查询主队得分和客队得分。再进行汇总统计\nIFNULL(SUM(num_points), 0) # IFNULL(Origin, NULL-value)\nSELECT t.team_id, t.team_name, IFNULL(SUM(num_points), 0) as num_points FROM Teams AS t LEFT JOIN ( SELECT host_team AS team_id, CASE WHEN host_goals \u003e guest_goals THEN 3 WHEN host_goals = guest_goals THEN 1 END AS num_points FROM Matches UNION ALL SELECT guest_team AS team_id, CASE WHEN guest_goals \u003e host_goals THEN 3 WHEN host_goals = guest_goals THEN 1 END AS num_points FROM Matches ) AS m ON t.team_id = m.team_id Group By t.team_id Order BY num_points DESC, t.team_id ASC # 1. LEFT JOIN 将相关的右表补充至左表 ！若1vN则产生重复记录(聚合该记录)\n# 2. UNION(ALL) 两张表需字段相同，上下拼接为一张表，ALL则保留重复记录\n# 3. case 空条件\n​\twhen ? then x\n​\t…\n​\tELSE y\n​\tend\n聚合函数 2020最后一次登录 SELECT MAX(Feild) # \u003c= 只要组内最大的记录 Min(Feild) # \u003c= 只要组内最小的记录 ... Group By 仓库经理 SELECT Warehouse.name AS warehouse_name, SUM(units*Products.Width*Products.Length*Products.Height) AS volume # 聚合组内数据 FROM Warehouse LEFT JOIN Products ON Warehouse.product_id = Products.product_id # 补齐信息 Group By Warehouse.name # 分组 订单最多的客户 SELECT customer_number FROM Orders GROUP BY customer_number ORDER BY COUNT(*) DESC # 对组进行排序 LIMIT 1 # Top位置 SELECT o.customer_number FROM ( SELECT customer_number, COUNT(*) AS count_number FROM Orders GROUP BY customer_number ) o ORDER BY o.count_number DESC LIMIT 1 查找每个员工花费的总时间 多次分组 \u0026 聚合\nSELECT `day`, emp_id, SUM(out_time-in_time) FROM Employees GROUP BY emp_id, event_day 及时食物配送 考点：计算公式\n#1 ROUND(X*100, 2) 33.33\n#2 SUM(IF(X, 1, 0)) / COUNT(ID)\n按列操作\nSELECT ROUND((SUM(IF(order_date = customer_pref_delivery_date, 1, 0)))/COUNT(delivery_id)*100, 2) AS immediate_percentage FROM Delivery 苹果和桔子 SELECT sale_date, (SUM(IF(fruit='apples', sold_num, 0)) - SUM(IF(fruit='oranges', sold_num, 0))) AS diff FROM Sales Group By sale_date ⭐ 分别聚合组内不同条件的记录\n两个人的通话记录 考点，多次分组进行聚合统计。\n题干中，呼叫与接收不分。\nSELECT from_id AS person1, to_id AS person2, COUNT(*) AS call_count,SUM(duration) AS total_duration FROM ( SELECT IF(from_id \u003c to_id, from_id, to_id) AS from_id, IF(from_id \u003c to_id, to_id, from_id) AS to_id, duration FROM Calls ) AS c Group BY from_id, to_id 排序和分组 银行账户概要 II 编写解决方案, 报告余额高于 10000 的所有用户的名字和余额. 账户的余额等于包含该账户的所有交易的总和\nSELECT name, balance FROM Users LEFT JOIN ( SELECT account, SUM(amount) AS balance FROM Transactions Group BY account) AS trans On Users.account = trans.account Where balance \u003e 10000 查找重复的电子邮箱 编写解决方案来报告所有重复的电子邮件\nSELECT email AS Email FROM Person Group By email HAVING count(*) \u003e 1 合作过至少三次的演员和导演 编写解决方案找出合作过至少三次的演员和导演的 id 对 (actor_id, director_id)\nSELECT actor_id, director_id FROM ActorDirector GROUP BY actor_id, director_id HAVING COUNT(*) \u003e= 3 消费者下单频率\n67月，每个月均消费至少100的用户\nSELECT o.customer_id, name FROM () AS o LEFT JOIN Customers ON o.customer_id = Customers.customer_id # 其中 SELECT customer_id, order_date, (quantity*price) AS cost FROM Orders LEFT JOIN Product ON Orders.product_id = Product.product_id WHERE month(order_date) in (6,7) Group BY customer_id HAVING SUM(IF(month(order_date) = 6, cost, 0)) \u003e= 100 and SUM(IF(month(order_date) = 7, cost, 0)) \u003e= 100 可以放心投资的国家 分步实现：\n1️⃣ 将呼叫\\接听联合\n2️⃣ 将对应人员及其国家准备好\n3️⃣ 再次连接，并按国家分组且聚合(HAVING进行条件筛选)\nSELECT name as country FROM ( SELECT caller_id AS call_id, duration FROM Calls UNION ALL SELECT callee_id AS call_id, duration FROM Calls ) a LEFT JOIN ( SELECT id, Country.name FROM Person LEFT JOIN Country on SUBSTR(phone_number, 1, 3) = country_code ) b ON a.call_id = b.id Group BY name HAVING AVG(duration) \u003e (SELECT AVG(duration) FROM Calls) 高级查询和连接 HAVING 子句用来对 聚合结果 进行过滤，而 HAVING 子句无法直接使用非聚合列\n页面推荐 编写解决方案，向user_id = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。\n先find他的所有朋友。 他-\u003e朋友 and 朋友 -\u003e\nSELECT DISTINCT page_id as recommended_page FROM (SELECT user2_id as user_id FROM Friendship WHERE user1_id = 1 UNION SELECT user1_id as user_id FROM Friendship WHERE user2_id = 1) AS fs LEFT JOIN Likes ls ON fs.user_id = ls.user_id WHERE page_id not in ( SELECT page_id FROM Likes WHERE user_id = 1 ) ORDER BY recommended_page ASC 树节点 CASE … END 按列来，每次处理列的一个元素\nSELECT id AS `id`, CASE WHEN id = 1 THEN \"Root\" WHEN id in (SELECT atree.p_id FROM tree atree) THEN \"Inner\" ELSE \"Leaf\" END AS type FROM Tree 游戏玩法分析 III 编写一个解决方案，同时报告每组玩家和日期，以及玩家到 目前为止 玩了多少游戏。也就是说，玩家在该日期之前所玩的游戏总数。详细情况请查看示例。\n利用笛卡尔积， 自己跟自己所有的记录进行连接。暴力遍历\nSELECT a1.player_id, a1.event_date, SUM(a2.games_played) AS games_played_so_far FROM Activity a1, Activity a2 # 笛卡儿积，o(n) x o(n) = o(n^2) 条纪录 WHERE a1.player_id = a2.player_id and a1.event_date \u003e= a2.event_date # 只要自己和自己进行连接的记录 GROUP BY a1.player_id, a1.event_date 大满贯数量 编写解决方案，找出每一个球员赢得大满贯比赛的次数。结果不包含没有赢得比赛的球员的ID 。\n思路： 行 -\u003e 列 再聚合\nPlayers 表：\r+-----------+-------------+\r| player_id | player_name |\r+-----------+-------------+\r| 1 | Nadal |\r| 2 | Federer |\r| 3 | Novak |\r+-----------+-------------+\rChampionships 表：\r+------+-----------+---------+---------+---------+\r| year | Wimbledon | Fr_open | US_open | Au_open |\r+------+-----------+---------+---------+---------+\r| 2018 | 1 | 1 | 1 | 1 |\r| 2019 | 1 | 1 | 2 | 2 |\r| 2020 | 2 | 1 | 2 | 2 |\r+------+-----------+---------+---------+---------+\r输出：\r+-----------+-------------+-------------------+\r| player_id | player_name | grand_slams_count |\r+-----------+-------------+-------------------+\r| 2 | Federer | 5 |\r| 1 | Nadal | 7 |\r+-----------+-------------+-------------------+ SELECT res.player_id, ps.player_name, res.grand_slams_count FROM ( SELECT player_id, COUNT(*) AS grand_slams_count FROM ( SELECT Wimbledon player_id FROM Championships UNION ALL SELECT Fr_open player_id FROM Championships UNION ALL SELECT US_open player_id FROM Championships UNION ALL SELECT Au_open player_id FROM Championships ) AS rec GROUP BY rec.player_id ) AS res LEFT JOIN Players AS ps ON res.player_id = ps.player_id 应该被禁止的 Leetflex 账户 编写解决方案，查找那些应该被禁止的Leetflex帐户编号 account_id 。 如果某个帐户在某一时刻从两个不同的网络地址登录了，则这个帐户应该被禁止。\nLogInfo table:\r+------------+------------+---------------------+---------------------+\r| account_id | ip_address | login | logout |\r+------------+------------+---------------------+---------------------+\r| 1 | 1 | 2021-02-01 09:00:00 | 2021-02-01 09:30:00 |\r| 1 | 2 | 2021-02-01 08:00:00 | 2021-02-01 11:30:00 |\r| 2 | 6 | 2021-02-01 20:30:00 | 2021-02-01 22:00:00 |\r| 2 | 7 | 2021-02-02 20:30:00 | 2021-02-02 22:00:00 |\r| 3 | 9 | 2021-02-01 16:00:00 | 2021-02-01 16:59:59 |\r| 3 | 13 | 2021-02-01 17:00:00 | 2021-02-01 17:59:59 |\r| 4 | 10 | 2021-02-01 16:00:00 | 2021-02-01 17:00:00 |\r| 4 | 11 | 2021-02-01 17:00:00 | 2021-02-01 17:59:59 |\r+------------+------------+---------------------+---------------------+ AND ((a.login between b.login and b.logout) OR (a.logout between b.login and b.logout)) GROUP BY 分组\nHAVING 作用于组，挑选指定的组\n子查询 各部门最高收入的员工 (可能有多个) SELECT d.name AS Department, e1.name AS Employee, e1.salary AS Salary FROM Employee e1 LEFT JOIN Department d ON e1.departmentId = d.id WHERE e1.salary = ( SELECT MAX(salary) FROM Employee e2 GROUP BY e2.departmentId HAVING e2.departmentId = e1.departmentId ) 效率不高！！！\n优化：\nSELECT d.name AS Department, e1.name AS Employee, e1.salary AS Salary FROM Employee e1 LEFT JOIN Department d ON e1.departmentId = d.id WHERE (e1.departmentId,e1.salary) in ( SELECT e2.departmentId, MAX(salary) FROM Employee e2 GROUP BY e2.departmentId ) 生成临时表（避免子查询 重复的执行）\nWITH MaxSalaries AS ( SELECT departmentId, MAX(salary) AS max_salary FROM Employee GROUP BY departmentId ) 每件商品的最新订单 可能有多个\nWith LatestDate AS ( SELECT product_id, MAX(order_date) AS order_date FROM Orders GROUP BY product_id ) SELECT p.product_name, o.product_id, o.order_id, o.order_date FROM Orders AS o LEFT JOIN LatestDate AS ld ON o.product_id = ld.product_id LEFT JOIN Products AS p ON o.product_id = p.product_id WHERE o.order_date = ld.order_date ORDER BY p.product_name ASC, o.product_id ASC, o.order_id ASC 最近的三笔订单 学习， 可分组打index标记，标记按照ORDER顺序\nROW_NUMBER() OVER ( PARTITION BY ? ORDER BY ? ) WITH ORDER_INFO AS ( SELECT c.name, c.customer_id, o.order_id, o.order_date, ROW_NUMBER() OVER ( PARTITION BY o.customer_id ORDER BY o.order_date DESC ) AS row_num FROM Orders AS o LEFT JOIN Customers AS c ON o.customer_id = c.customer_id ) SELECT name AS customer_name, customer_id, order_id, order_date FROM ORDER_INFO AS o WHERE o.row_num \u003c= 3 ORDER BY customer_name ASC, customer_id ASC, order_date DESC 先生成临时表，避免重复生成子查询\n每天的最大金额 先筛选出每天的最大金额，再执行后续的判断\nWITH MAX_AMOUNT AS ( SELECT DATE(`day`) AS `day`, MAX(amount) max_amount FROM Transactions AS t GROUP BY DATE(`day`) ) SELECT transaction_id FROM Transactions AS t LEFT JOIN MAX_AMOUNT AS ma ON DATE(t.day) = ma.day WHERE (DATE(t.day), t.amount) = (ma.day, ma.max_amount) ORDER BY transaction_id ASC 直接给每天的 订单，按照金额， 打index标记\n❗ RANK 相同值会获得相同的排名\nRANK() OVER ( ) 而 ROW_NUMBER，idx严格递增\nWITH Temp AS ( SELECT transaction_id, `day`, amount, rank() OVER ( PARTITION BY DATE(`day`) ORDER BY amount DESC ) AS idx FROM Transactions AS t ) SELECT transaction_id FROM Temp as t WHERE idx = 1 ORDER BY transaction_id ASC 窗口函数和公共表表达式 项目员工 III 找出每个项目 经验最丰富的员工(可能有多个)\n直接1. 分项目 2. 项目内按经验程度进行RANK 3. 再筛选\nWITH Temp AS ( SELECT p.project_id, p.employee_id, RANK() OVER ( PARTITION BY p.project_id ORDER BY e.experience_years DESC ) AS idx FROM Project AS p LEFT JOIN Employee as e ON p.employee_id = e.employee_id ) SELECT project_id, employee_id FROM Temp WHERE idx = 1 每位顾客最经常订购的商品 主SQL GROUP BY 之后，与 RANK() 的操作\nSELECT customer_id, product_id, COUNT(*) AS order_count, RANK() OVER (ORDER BY COUNT(*) DESC) AS RK FROM Orders GROUP BY customer_id, product_id; 结果：\n添加 PARTITION BY customer_id 进行隔离\nSELECT customer_id, product_id, COUNT(*) AS order_count, RANK() OVER (PARTITION BY customer_id ORDER BY COUNT(*) DESC) AS RK FROM Orders GROUP BY customer_id, product_id; 结果：\n=\u003e 结论。 1. 先执行主SQL的GROUP BY，进行分区，再RANK(), RANK()按照 ORDER BY(必须聚合为单行)进行排序， 利用PARTITION进行排序隔离。\n答案\nWITH Temp AS ( SELECT customer_id, product_id, COUNT(*) AS order_count, RANK() OVER (PARTITION BY customer_id ORDER BY COUNT(*) DESC) AS RK FROM Orders GROUP BY customer_id, product_id ) SELECT t.customer_id, t.product_id, p.product_name FROM Temp AS t LEFT JOIN Products AS p ON t.product_id = p.product_id WHERE RK = 1 # 最高的 NO.1 访问日期之间最大的空档期 LEAD(column, offset, defualt) OVER (PARTITION BY … ORDER BY …) 找后面的行。其中LEAD表示引领。\nLAG(…) 找前面的行， 滞后\nSELECT user_id, MAX(DATEDIFF(after_day, visit_date)) AS biggest_window FROM ( SELECT user_id, visit_date, LEAD(visit_date, 1, '2021-1-1') OVER (PARTITION BY user_id ORDER BY visit_date ASC) AS after_day FROM UserVisits AS uv ) AS t GROUP BY user_id 考点：行之间的差值\nCTE Common Table Expression\n向公司 CEO 汇报工作的所有人 查询树状结构节点 列转行\n依次暴力枚举\nSELECT employee_id FROM ( SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1 UNION SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM (SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1) AS e1 ) UNION SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM (SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM (SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1) AS e2 )) e3 ) ) AS e 太低效了！！！ SB操作，疯狂连续查询\n优化\nSELECT employee_id FROM ( SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1 # ✔️ UNION SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1 ) UNION SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM Employees WHERE manager_id in ( SELECT employee_id FROM Employees WHERE manager_id = 1 and employee_id != 1 ) ) ) AS e 利用连接来计算\nSELECT DISTINCT e4.employee_id FROM Employees e1 LEFT JOIN Employees e2 ON e1.employee_id = e2.manager_id LEFT JOIN Employees e3 ON e2.employee_id = e3.manager_id LEFT JOIN Employees e4 ON e3.employee_id = e4.manager_id WHERE e1.employee_id = 1 and e4.employee_id != 1 1 Boss =\u003e { 1 Boss =\u003e { 1 Boss =\u003e { 1 Boss 2 Bob 77 Robert } 2 Bob =\u003e 4 Daniel 77 Robert =\u003e null } 2 Bob =\u003e 4 Daniel =\u003e null 77 Robert =\u003e null =\u003e null } 寻找连续区间的开始和结束位置 思路：\ndata: 1,2,3,7,8,10 idx : 1,2,3,4,5, 6 diff: 0,0,0,3,3, 4 \u003c= GROUP BY diff =\u003e MIN(idx) AS Start_ID, MAX(idx) AS End_ID WITH Temp AS ( SELECT log_id, ROW_NUMBER() OVER (ORDER BY log_id ASC) AS idx FROM Logs ) SELECT MIN(log_id) AS start_id, MAX(log_id) AS end_id FROM ( SELECT log_id, (log_id-idx ) AS diff FROM Temp ) AS t GROUP BY diff 查找处于成绩中游的学生 参加的考试，没有一科是最高分或者最低分。科科中等\n逻辑： 1. 判断每一科，再统计所有科目\nWITH MAXMIN AS ( SELECT exam_id, MIN(score) min_score, MAX(score) max_score FROM Exam GROUP BY exam_id ) SELECT s.student_id, s.student_name FROM ( SELECT e.exam_id, e.student_id, CASE WHEN score != min_score and score != max_score THEN 1 ELSE 0 END AS is_medium FROM Exam AS e LEFT JOIN MAXMIN m ON e.exam_id = m.exam_id ) AS t LEFT JOIN Student AS s ON t.student_id = s.student_id GROUP BY t.student_id HAVING SUM(t.is_medium) = COUNT(t.is_medium) ORDER BY student_id ASC 反过来： 将尖子生和垫底生排除在外即可\n寻找没有被执行的任务对 with recursive all_subtask(task_id, subtask_id) as ( SELECT task_id, subtasks_count FROM Tasks UNION ALL SELECT task_id, subtask_id-1 FROM all_subtask where subtask_id-1 \u003e 0 ) SELECT task_id, subtask_id From all_subtask WHERE (task_id, subtask_id) not in (SELECT task_id, subtask_id FROM Executed) with recursive TableName(param1, param2) AS ( SELECT param1, param2 // 基础结果 FROM BaseTable UNION ALL // 下面式子会被重复递归 SELECT param1, param2-1 // 新的结果 FROM TableName // 上一轮的结果 where param2-1 \u003e 0 // 递归终止条件 ) ",
  "wordCount" : "4445",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/learning/sql%E5%AD%A6%E4%B9%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="LongCoding&#39;s Blog (Alt + H)">LongCoding&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="LongCoding&#39;s Blog">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Timeline">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>Category</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="About Me">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      
    </h1>
    <div class="post-meta">9 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%ab%98%e9%a2%91sql50%e9%a2%98" aria-label="高频SQL50题">高频SQL50题</a><ul>
                        
                <li>
                    <a href="#%e6%9f%a5%e8%af%a2" aria-label="查询">查询</a><ul>
                        
                <li>
                    <a href="#wheregroupbyhaving" aria-label="Where&amp;GroupBy&amp;HAVING">Where&amp;GroupBy&amp;HAVING</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e6%b2%a1%e4%b9%b0%e8%bf%87%e4%b8%9c%e8%a5%bf%e7%9a%84%e9%a1%be%e5%ae%a2" aria-label="查找没买过东西的顾客">查找没买过东西的顾客</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e7%89%b9%e6%ae%8a%e5%a5%96%e9%87%91" aria-label="计算特殊奖金">计算特殊奖金</a></li>
                <li>
                    <a href="#%e8%b4%ad%e4%b9%b0%e4%ba%86%e4%ba%a7%e5%93%81-a-%e5%92%8c%e4%ba%a7%e5%93%81-b-%e5%8d%b4%e6%b2%a1%e6%9c%89%e8%b4%ad%e4%b9%b0%e4%ba%a7%e5%93%81-c-%e7%9a%84%e9%a1%be%e5%ae%a2" aria-label="购买了产品 A 和产品 B 却没有购买产品 C 的顾客">购买了产品 A 和产品 B 却没有购买产品 C 的顾客</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%bd%8d%e5%ad%a6%e7%94%9f%e6%88%90%e7%bb%a9%e6%9c%80%e5%a5%bd%e7%9a%84%e7%a7%91%e7%9b%ae" aria-label="每位学生成绩最好的科目">每位学生成绩最好的科目</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%bf%9e%e6%8e%a5" aria-label="连接">连接</a><ul>
                        
                <li>
                    <a href="#%e6%b2%a1%e6%9c%89%e5%8d%96%e5%87%ba%e7%9a%84%e5%95%86%e5%ae%b6" aria-label="没有卖出的商家">没有卖出的商家</a></li>
                <li>
                    <a href="#%e6%8e%92%e5%90%8d%e9%9d%a0%e5%89%8d%e7%9a%84%e6%97%85%e8%a1%8c%e8%80%85" aria-label="排名靠前的旅行者">排名靠前的旅行者</a></li>
                <li>
                    <a href="#607-%e9%94%80%e5%94%ae%e5%91%98" aria-label="607. 销售员">607. 销售员</a></li>
                <li>
                    <a href="#%e8%ae%a1%e7%ae%97%e5%b8%83%e5%b0%94%e8%a1%a8%e8%be%be%e5%bc%8f%e7%9a%84%e5%80%bc" aria-label="计算布尔表达式的值">计算布尔表达式的值</a></li>
                <li>
                    <a href="#%e6%9f%a5%e8%af%a2%e7%90%83%e9%98%9f%e7%a7%af%e5%88%86" aria-label="查询球队积分">查询球队积分</a></li></ul>
                </li>
                <li>
                    <a href="#%e8%81%9a%e5%90%88%e5%87%bd%e6%95%b0" aria-label="聚合函数">聚合函数</a><ul>
                        
                <li>
                    <a href="#2020%e6%9c%80%e5%90%8e%e4%b8%80%e6%ac%a1%e7%99%bb%e5%bd%95" aria-label="2020最后一次登录">2020最后一次登录</a></li>
                <li>
                    <a href="#%e4%bb%93%e5%ba%93%e7%bb%8f%e7%90%86" aria-label="仓库经理">仓库经理</a></li>
                <li>
                    <a href="#%e8%ae%a2%e5%8d%95%e6%9c%80%e5%a4%9a%e7%9a%84%e5%ae%a2%e6%88%b7" aria-label="订单最多的客户">订单最多的客户</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e6%af%8f%e4%b8%aa%e5%91%98%e5%b7%a5%e8%8a%b1%e8%b4%b9%e7%9a%84%e6%80%bb%e6%97%b6%e9%97%b4" aria-label="查找每个员工花费的总时间">查找每个员工花费的总时间</a></li>
                <li>
                    <a href="#%e5%8f%8a%e6%97%b6%e9%a3%9f%e7%89%a9%e9%85%8d%e9%80%81" aria-label="及时食物配送">及时食物配送</a></li>
                <li>
                    <a href="#%e8%8b%b9%e6%9e%9c%e5%92%8c%e6%a1%94%e5%ad%90" aria-label="苹果和桔子">苹果和桔子</a></li>
                <li>
                    <a href="#%e4%b8%a4%e4%b8%aa%e4%ba%ba%e7%9a%84%e9%80%9a%e8%af%9d%e8%ae%b0%e5%bd%95" aria-label="两个人的通话记录">两个人的通话记录</a></li></ul>
                </li>
                <li>
                    <a href="#%e6%8e%92%e5%ba%8f%e5%92%8c%e5%88%86%e7%bb%84" aria-label="排序和分组">排序和分组</a><ul>
                        
                <li>
                    <a href="#%e9%93%b6%e8%a1%8c%e8%b4%a6%e6%88%b7%e6%a6%82%e8%a6%81-ii" aria-label="银行账户概要 II">银行账户概要 II</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e9%87%8d%e5%a4%8d%e7%9a%84%e7%94%b5%e5%ad%90%e9%82%ae%e7%ae%b1" aria-label="查找重复的电子邮箱">查找重复的电子邮箱</a></li>
                <li>
                    <a href="#%e5%90%88%e4%bd%9c%e8%bf%87%e8%87%b3%e5%b0%91%e4%b8%89%e6%ac%a1%e7%9a%84%e6%bc%94%e5%91%98%e5%92%8c%e5%af%bc%e6%bc%94" aria-label="合作过至少三次的演员和导演">合作过至少三次的演员和导演</a></li>
                <li>
                    <a href="#%e5%8f%af%e4%bb%a5%e6%94%be%e5%bf%83%e6%8a%95%e8%b5%84%e7%9a%84%e5%9b%bd%e5%ae%b6" aria-label="可以放心投资的国家">可以放心投资的国家</a></li></ul>
                </li>
                <li>
                    <a href="#%e9%ab%98%e7%ba%a7%e6%9f%a5%e8%af%a2%e5%92%8c%e8%bf%9e%e6%8e%a5" aria-label="高级查询和连接">高级查询和连接</a><ul>
                        
                <li>
                    <a href="#%e9%a1%b5%e9%9d%a2%e6%8e%a8%e8%8d%90" aria-label="页面推荐">页面推荐</a></li>
                <li>
                    <a href="#%e6%a0%91%e8%8a%82%e7%82%b9" aria-label="树节点">树节点</a></li>
                <li>
                    <a href="#%e6%b8%b8%e6%88%8f%e7%8e%a9%e6%b3%95%e5%88%86%e6%9e%90-iii" aria-label="游戏玩法分析 III">游戏玩法分析 III</a></li>
                <li>
                    <a href="#%e5%a4%a7%e6%bb%a1%e8%b4%af%e6%95%b0%e9%87%8f" aria-label="大满贯数量">大满贯数量</a></li>
                <li>
                    <a href="#%e5%ba%94%e8%af%a5%e8%a2%ab%e7%a6%81%e6%ad%a2%e7%9a%84-leetflex-%e8%b4%a6%e6%88%b7" aria-label=" 应该被禁止的 Leetflex 账户"> 应该被禁止的 Leetflex 账户</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%ad%90%e6%9f%a5%e8%af%a2" aria-label="子查询">子查询</a><ul>
                        
                <li>
                    <a href="#%e5%90%84%e9%83%a8%e9%97%a8%e6%9c%80%e9%ab%98%e6%94%b6%e5%85%a5%e7%9a%84%e5%91%98%e5%b7%a5-%e5%8f%af%e8%83%bd%e6%9c%89%e5%a4%9a%e4%b8%aa" aria-label="各部门最高收入的员工 (可能有多个)">各部门最高收入的员工 (可能有多个)</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%bb%b6%e5%95%86%e5%93%81%e7%9a%84%e6%9c%80%e6%96%b0%e8%ae%a2%e5%8d%95" aria-label="每件商品的最新订单">每件商品的最新订单</a></li>
                <li>
                    <a href="#%e6%9c%80%e8%bf%91%e7%9a%84%e4%b8%89%e7%ac%94%e8%ae%a2%e5%8d%95" aria-label="最近的三笔订单">最近的三笔订单</a></li>
                <li>
                    <a href="#%e6%af%8f%e5%a4%a9%e7%9a%84%e6%9c%80%e5%a4%a7%e9%87%91%e9%a2%9d" aria-label="每天的最大金额">每天的最大金额</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%aa%97%e5%8f%a3%e5%87%bd%e6%95%b0%e5%92%8c%e5%85%ac%e5%85%b1%e8%a1%a8%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="窗口函数和公共表表达式">窗口函数和公共表表达式</a><ul>
                        
                <li>
                    <a href="#%e9%a1%b9%e7%9b%ae%e5%91%98%e5%b7%a5-iii" aria-label=" 项目员工 III"> 项目员工 III</a></li>
                <li>
                    <a href="#%e6%af%8f%e4%bd%8d%e9%a1%be%e5%ae%a2%e6%9c%80%e7%bb%8f%e5%b8%b8%e8%ae%a2%e8%b4%ad%e7%9a%84%e5%95%86%e5%93%81" aria-label="每位顾客最经常订购的商品">每位顾客最经常订购的商品</a></li>
                <li>
                    <a href="#%e8%ae%bf%e9%97%ae%e6%97%a5%e6%9c%9f%e4%b9%8b%e9%97%b4%e6%9c%80%e5%a4%a7%e7%9a%84%e7%a9%ba%e6%a1%a3%e6%9c%9f" aria-label="访问日期之间最大的空档期">访问日期之间最大的空档期</a></li>
                <li>
                    <a href="#%e5%90%91%e5%85%ac%e5%8f%b8-ceo-%e6%b1%87%e6%8a%a5%e5%b7%a5%e4%bd%9c%e7%9a%84%e6%89%80%e6%9c%89%e4%ba%ba" aria-label="向公司 CEO 汇报工作的所有人">向公司 CEO 汇报工作的所有人</a></li>
                <li>
                    <a href="#%e5%af%bb%e6%89%be%e8%bf%9e%e7%bb%ad%e5%8c%ba%e9%97%b4%e7%9a%84%e5%bc%80%e5%a7%8b%e5%92%8c%e7%bb%93%e6%9d%9f%e4%bd%8d%e7%bd%ae" aria-label="寻找连续区间的开始和结束位置">寻找连续区间的开始和结束位置</a></li>
                <li>
                    <a href="#%e6%9f%a5%e6%89%be%e5%a4%84%e4%ba%8e%e6%88%90%e7%bb%a9%e4%b8%ad%e6%b8%b8%e7%9a%84%e5%ad%a6%e7%94%9f" aria-label="查找处于成绩中游的学生">查找处于成绩中游的学生</a></li>
                <li>
                    <a href="#%e5%af%bb%e6%89%be%e6%b2%a1%e6%9c%89%e8%a2%ab%e6%89%a7%e8%a1%8c%e7%9a%84%e4%bb%bb%e5%8a%a1%e5%af%b9" aria-label="寻找没有被执行的任务对">寻找没有被执行的任务对</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="高频sql50题">高频SQL50题<a hidden class="anchor" aria-hidden="true" href="#高频sql50题">#</a></h2>
<h3 id="查询">查询<a hidden class="anchor" aria-hidden="true" href="#查询">#</a></h3>
<h4 id="wheregroupbyhaving">Where&amp;GroupBy&amp;HAVING<a hidden class="anchor" aria-hidden="true" href="#wheregroupbyhaving">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">revenue</span><span class="w">  </span><span class="c1"># 某个用户2021年可能有多项记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Where</span><span class="w"> </span><span class="kt">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Where</span><span class="w"> </span><span class="kt">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span><span class="w">  </span><span class="c1"># 1. 先筛选出此年份所有记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">id</span><span class="w">        </span><span class="c1"># 2. 再根据id分组 3. 必须结合SUM() 或者其他聚合函数，因此这个有多列，需要处理为单值。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Where</span><span class="w"> </span><span class="kt">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2021</span><span class="w">          </span><span class="c1"># 1. 先筛选记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">id</span><span class="w">                </span><span class="c1"># 2. 分组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="w">  </span><span class="c1">#  3. 聚合分组字段记录 并 判断
</span></span></span></code></pre></div><h4 id="查找没买过东西的顾客">查找没买过东西的顾客<a hidden class="anchor" aria-hidden="true" href="#查找没买过东西的顾客">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="c1"># 1. NOT EXISTS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">`</span><span class="n">Customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">Customers</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">customerId</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Where</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customerId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><img src="C:\Users\韦龙\AppData\Roaming\Typora\typora-user-images\image-20241118211512733.png" alt="Image" style="float:left; margin-right: 10px;" />
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="c1"># 2. Left Join 
</span></span></span><span class="line"><span class="cl"><span class="c1"># example
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">oid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">on</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customerId</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">Customers</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">customers</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">on</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customerId</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="no">NULL</span><span class="w">
</span></span></span></code></pre></div><h4 id="计算特殊奖金"><a href="https://leetcode.cn/problems/calculate-special-bonus/">计算特殊奖金</a><a hidden class="anchor" aria-hidden="true" href="#计算特殊奖金">#</a></h4>
<p>编写解决方案，计算每个雇员的奖金。如果一个雇员的 id 是 <strong>奇数</strong> 并且他的名字不是以 <code>'M'</code> <strong>开头</strong>，那么他的奖金是他工资的 <code>100%</code> ，否则奖金为 <code>0</code> 。</p>
<p>返回的结果按照 <code>employee_id</code> 排序。</p>
<p>IF用法  IF(condition, True, False) AS alias</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">employee_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;M%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">salary</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">`</span><span class="n">bonus</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><h4 id="购买了产品-a-和产品-b-却没有购买产品-c-的顾客"><a href="https://leetcode.cn/problems/customers-who-bought-products-a-and-b-but-not-c/">购买了产品 A 和产品 B 却没有购买产品 C 的顾客</a><a hidden class="anchor" aria-hidden="true" href="#购买了产品-a-和产品-b-却没有购买产品-c-的顾客">#</a></h4>
<p>Where 中 多重 判断</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">Customers</span><span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="n">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;A&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="o">=</span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Order</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">  </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><p>连表，分组判断</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">Orders</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">Customers</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">on</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">product_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;C&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Order</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="p">[</span><span class="n">o</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customerId</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customerId</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="mi">1</span><span class="w">            </span><span class="s1">&#39;A&#39;</span><span class="w">              </span><span class="mi">1</span><span class="w">           </span><span class="n">X</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">2</span><span class="w">       </span><span class="mi">1</span><span class="w">            </span><span class="s1">&#39;B&#39;</span><span class="w">              </span><span class="mi">1</span><span class="w">           </span><span class="n">X</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">3</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;A&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;B&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">5</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;C&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customerId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="mi">1</span><span class="w">            </span><span class="s1">&#39;A&#39;</span><span class="w">              </span><span class="mi">1</span><span class="w">           </span><span class="n">X</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">2</span><span class="w">       </span><span class="mi">1</span><span class="w">            </span><span class="s1">&#39;B&#39;</span><span class="w">              </span><span class="mi">1</span><span class="w">           </span><span class="n">X</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">3</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;A&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;B&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="mi">5</span><span class="w">       </span><span class="mi">2</span><span class="w">            </span><span class="s1">&#39;C&#39;</span><span class="w">              </span><span class="mi">2</span><span class="w">           </span><span class="n">Y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">express</span><span class="w"> </span><span class="k">condition</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">condition</span><span class="w"> </span><span class="c1"># 对于String是统计条数
</span></span></span></code></pre></div><h4 id="每位学生成绩最好的科目">每位学生成绩最好的科目<a hidden class="anchor" aria-hidden="true" href="#每位学生成绩最好的科目">#</a></h4>
<p>所有有相同科目成绩一样，选择科目id小的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="o">+---------------+---------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">Column</span><span class="w"> </span><span class="n">Name</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Type</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+---------------+---------+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">student_id</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">int</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">course_id</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="kt">int</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">grade</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="kt">int</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+---------------+---------+</span><span class="w">
</span></span></span></code></pre></div><p># 1</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="c1"># 查某学生成绩最好的那些科目，因为可能有重复的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">student_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">From</span><span class="w"> </span><span class="n">Enrollments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">student_id</span><span class="w">
</span></span></span></code></pre></div><p># 2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="c1"># 查某学生最好的那些科目中 courseId最小的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">student_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MIN</span><span class="p">(</span><span class="n">courseId</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">course_id</span><span class="p">,</span><span class="w"> </span><span class="n">grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">From</span><span class="w"> </span><span class="n">Enrollments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1"># 行 =&gt; 最好的那些科目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Where</span><span class="w"> </span><span class="p">(</span><span class="n">student_id</span><span class="p">,</span><span class="w"> </span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">SELECT</span><span class="w"> </span><span class="n">student_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">grade</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">grade</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">From</span><span class="w"> </span><span class="n">Enrollments</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">student_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">       
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">student_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Order</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">student_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><h3 id="连接">连接<a hidden class="anchor" aria-hidden="true" href="#连接">#</a></h3>
<p><strong>Left Join</strong></p>
<p>拓展左边，即使右表某些行不存在（会出现重复行）</p>
<p>=&gt; **Right Join **同理</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="o">`</span><span class="n">customers</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customerId</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image-20241119220005030" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241119220005030.png"></p>
<p><strong>Inner Join</strong> =&gt; 只展示左右表均成功对接上的行</p>
<h4 id="没有卖出的商家">没有卖出的商家<a hidden class="anchor" aria-hidden="true" href="#没有卖出的商家">#</a></h4>
<p>写一个解决方案, 报告所有在 <code>2020</code> 年度没有任何卖出的卖家的名字。</p>
<p>返回结果按照 <code>seller_name</code> <strong>升序排列。</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">seller_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Seller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">seller_id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">seller_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">sale_date</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;2020%&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">seller_name</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><h4 id="排名靠前的旅行者"><a href="https://leetcode.cn/problems/top-travellers/">排名靠前的旅行者</a><a hidden class="anchor" aria-hidden="true" href="#排名靠前的旅行者">#</a></h4>
<p>返回的结果表单，以 <code>travelled_distance</code> <strong>降序排列</strong> ，如果有两个或者更多的用户旅行了相同的距离, 那么再以 <code>name</code> <strong>升序排列</strong> 。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nf">COALESCE</span><span class="p">(</span><span class="nf">SUM</span><span class="p">(</span><span class="n">distance</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">travelled_distance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">From</span><span class="w"> </span><span class="n">Users</span><span class="w"> </span><span class="k">Left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">Rides</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">On</span><span class="w"> </span><span class="n">Rides</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Users</span><span class="p">.</span><span class="n">id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">Rides</span><span class="p">.</span><span class="n">user_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">travelled_distance</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">ASC</span><span class="p">;</span><span class="w">  </span><span class="c1"># 使用别名排序
</span></span></span></code></pre></div><h4 id="607-销售员"><a href="https://leetcode.cn/problems/sales-person/">607. 销售员</a><a hidden class="anchor" aria-hidden="true" href="#607-销售员">#</a></h4>
<p>编写解决方案，找出没有任何与名为 <strong>“RED”</strong> 的公司相关的订单的所有销售人员的姓名。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">SalesPerson</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sales_id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">sales_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Company</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">com_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Company</span><span class="p">.</span><span class="n">com_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;RED&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h4 id="计算布尔表达式的值"><a href="https://leetcode.cn/problems/evaluate-boolean-expression/">计算布尔表达式的值</a><a hidden class="anchor" aria-hidden="true" href="#计算布尔表达式的值">#</a></h4>
<pre tabindex="0"><code>输入：
Variables 表:
+------+-------+
| name | value |
+------+-------+
| x    | 66    |
| y    | 77    |
+------+-------+

Expressions 表:
+--------------+----------+---------------+
| left_operand | operator | right_operand |
+--------------+----------+---------------+
| x            | &gt;        | y             |
| x            | &lt;        | y             |
| x            | =        | y             |
| y            | &gt;        | x             |
| y            | &lt;        | x             |
| x            | =        | x             |
+--------------+----------+---------------+

输出:
+--------------+----------+---------------+-------+
| left_operand | operator | right_operand | value |
+--------------+----------+---------------+-------+
| x            | &gt;        | y             | false |
| x            | &lt;        | y             | true  |
| x            | =        | y             | false |
| y            | &gt;        | x             | true  |
| y            | &lt;        | x             | false |
| x            | =        | x             | true  |
+--------------+----------+---------------+-------+
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">left_operand</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">operator</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">right_operand</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CASE</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">operator</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;&gt;&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="o">&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;&lt;&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="o">&lt;</span><span class="n">v2</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">value</span><span class="o">=</span><span class="n">v2</span><span class="p">.</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false&#39;</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="n">value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Expressions</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Variables</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">left_operand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="p">.</span><span class="n">name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Variables</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">right_operand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v2</span><span class="p">.</span><span class="n">name</span><span class="w"> 
</span></span></span></code></pre></div><p>考点：多重连表 e.(&hellip;)v1.(&hellip;)v2.(&hellip;)</p>
<p>条件判断表达式</p>
<p>case [sign]</p>
<p>​	when exp then result[if(exp, true, false)]</p>
<p>​	when exp then result</p>
<p>​	else result</p>
<p>end</p>
<hr>
<h4 id="查询球队积分"><a href="https://leetcode.cn/problems/team-scores-in-football-tournament/">查询球队积分</a><a hidden class="anchor" aria-hidden="true" href="#查询球队积分">#</a></h4>
<p>分别查询主队得分和客队得分。再进行汇总统计</p>
<p>IFNULL(SUM(num_points), 0)  # IFNULL(Origin, NULL-value)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">team_id</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">team_name</span><span class="p">,</span><span class="w"> </span><span class="nf">IFNULL</span><span class="p">(</span><span class="nf">SUM</span><span class="p">(</span><span class="n">num_points</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">num_points</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Teams</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">host_team</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">team_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">host_goals</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">guest_goals</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">host_goals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_goals</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_points</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Matches</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">guest_team</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">team_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">guest_goals</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">host_goals</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">host_goals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">guest_goals</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">num_points</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Matches</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">team_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">team_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">team_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Order</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">num_points</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">team_id</span><span class="w"> </span><span class="k">ASC</span><span class="w"> 
</span></span></span></code></pre></div><p># 1. LEFT JOIN 将相关的右表补充至左表 ！若1vN则产生重复记录(聚合该记录)</p>
<p># 2. UNION(ALL) 两张表需字段相同，上下拼接为一张表，ALL则保留重复记录</p>
<p># 3. case 空条件</p>
<p>​	     when ? then x</p>
<p>​		&hellip;</p>
<p>​		ELSE y</p>
<p>​		end</p>
<h3 id="聚合函数">聚合函数<a hidden class="anchor" aria-hidden="true" href="#聚合函数">#</a></h3>
<hr>
<h4 id="2020最后一次登录">2020最后一次登录<a hidden class="anchor" aria-hidden="true" href="#2020最后一次登录">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">Feild</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;= 只要组内最大的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	   </span><span class="nf">Min</span><span class="p">(</span><span class="n">Feild</span><span class="p">)</span><span class="w">  </span><span class="c1"># &lt;= 只要组内最小的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w">
</span></span></span></code></pre></div><h4 id="仓库经理"><a href="https://leetcode.cn/problems/warehouse-manager/">仓库经理</a><a hidden class="anchor" aria-hidden="true" href="#仓库经理">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">Warehouse</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">warehouse_name</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">SUM</span><span class="p">(</span><span class="n">units</span><span class="o">*</span><span class="n">Products</span><span class="p">.</span><span class="n">Width</span><span class="o">*</span><span class="n">Products</span><span class="p">.</span><span class="n">Length</span><span class="o">*</span><span class="n">Products</span><span class="p">.</span><span class="n">Height</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">volume</span><span class="w">   </span><span class="c1"># 聚合组内数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Warehouse</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Products</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Warehouse</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Products</span><span class="p">.</span><span class="n">product_id</span><span class="w">  </span><span class="c1"># 补齐信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">Warehouse</span><span class="p">.</span><span class="n">name</span><span class="w">                                           </span><span class="c1"># 分组
</span></span></span></code></pre></div><h4 id="订单最多的客户">订单最多的客户<a hidden class="anchor" aria-hidden="true" href="#订单最多的客户">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_number</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_number</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="w">  </span><span class="c1"># 对组进行排序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w">                 </span><span class="c1"># Top位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_number</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_number</span><span class="p">,</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">count_number</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_number</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">count_number</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></div><h4 id="查找每个员工花费的总时间"><a href="https://leetcode.cn/problems/find-total-time-spent-by-each-employee/">查找每个员工花费的总时间</a><a hidden class="anchor" aria-hidden="true" href="#查找每个员工花费的总时间">#</a></h4>
<p>多次分组 &amp; 聚合</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">emp_id</span><span class="p">,</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">out_time</span><span class="o">-</span><span class="n">in_time</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">emp_id</span><span class="p">,</span><span class="w"> </span><span class="n">event_day</span><span class="w"> 
</span></span></span></code></pre></div><h4 id="及时食物配送">及时食物配送<a hidden class="anchor" aria-hidden="true" href="#及时食物配送">#</a></h4>
<p>考点：计算公式</p>
<p>#1  ROUND(X*100, 2)   33.33</p>
<p>#2  SUM(IF(X, 1, 0)) / COUNT(ID)</p>
<p><strong>按列操作</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="nf">ROUND</span><span class="p">((</span><span class="nf">SUM</span><span class="p">(</span><span class="k">IF</span><span class="p">(</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">customer_pref_delivery_date</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="o">/</span><span class="nf">COUNT</span><span class="p">(</span><span class="n">delivery_id</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">immediate_percentage</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Delivery</span><span class="w">
</span></span></span></code></pre></div><h4 id="苹果和桔子">苹果和桔子<a hidden class="anchor" aria-hidden="true" href="#苹果和桔子">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">sale_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="nf">SUM</span><span class="p">(</span><span class="k">IF</span><span class="p">(</span><span class="n">fruit</span><span class="o">=</span><span class="s1">&#39;apples&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sold_num</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="k">IF</span><span class="p">(</span><span class="n">fruit</span><span class="o">=</span><span class="s1">&#39;oranges&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sold_num</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Sales</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">sale_date</span><span class="w">
</span></span></span></code></pre></div><p>⭐ 分别聚合组内不同条件的记录</p>
<h4 id="两个人的通话记录">两个人的通话记录<a hidden class="anchor" aria-hidden="true" href="#两个人的通话记录">#</a></h4>
<p>考点，多次分组进行聚合统计。</p>
<p>题干中，呼叫与接收不分。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">from_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">person1</span><span class="p">,</span><span class="w"> </span><span class="n">to_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">person2</span><span class="p">,</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">call_count</span><span class="p">,</span><span class="nf">SUM</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">total_duration</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">from_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">to_id</span><span class="p">,</span><span class="w"> </span><span class="n">from_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">from_id</span><span class="p">,</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">from_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">to_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_id</span><span class="p">,</span><span class="w"> </span><span class="n">from_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">to_id</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">Calls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">from_id</span><span class="p">,</span><span class="w"> </span><span class="n">to_id</span><span class="w">
</span></span></span></code></pre></div><h3 id="排序和分组">排序和分组<a hidden class="anchor" aria-hidden="true" href="#排序和分组">#</a></h3>
<h4 id="银行账户概要-ii"><a href="https://leetcode.cn/problems/bank-account-summary-ii/">银行账户概要 II</a><a hidden class="anchor" aria-hidden="true" href="#银行账户概要-ii">#</a></h4>
<p>编写解决方案, 报告余额高于 10000 的所有用户的名字和余额. 账户的余额等于包含该账户的所有交易的总和</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Users</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">account</span><span class="p">,</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">balance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Transactions</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">Group</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">account</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">trans</span><span class="w"> </span><span class="k">On</span><span class="w"> </span><span class="n">Users</span><span class="p">.</span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trans</span><span class="p">.</span><span class="n">account</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Where</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w">
</span></span></span></code></pre></div><h4 id="查找重复的电子邮箱"><a href="https://leetcode.cn/problems/duplicate-emails/">查找重复的电子邮箱</a><a hidden class="anchor" aria-hidden="true" href="#查找重复的电子邮箱">#</a></h4>
<p>编写解决方案来报告所有重复的电子邮件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Email</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Person</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">By</span><span class="w"> </span><span class="n">email</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></div><h4 id="合作过至少三次的演员和导演"><a href="https://leetcode.cn/problems/actors-and-directors-who-cooperated-at-least-three-times/">合作过至少三次的演员和导演</a><a hidden class="anchor" aria-hidden="true" href="#合作过至少三次的演员和导演">#</a></h4>
<p>编写解决方案找出合作过至少三次的演员和导演的 id 对 <code>(actor_id, director_id)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">actor_id</span><span class="p">,</span><span class="w"> </span><span class="n">director_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">ActorDirector</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">actor_id</span><span class="p">,</span><span class="w"> </span><span class="n">director_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span></code></pre></div><p>消费者下单频率</p>
<p>67月，每个月均消费至少100的用户</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Customers</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Customers</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1"># 其中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">quantity</span><span class="o">*</span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">cost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Product</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="nf">month</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="k">IF</span><span class="p">(</span><span class="nf">month</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">cost</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="k">and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nf">SUM</span><span class="p">(</span><span class="k">IF</span><span class="p">(</span><span class="nf">month</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">cost</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="w">
</span></span></span></code></pre></div><h4 id="可以放心投资的国家">可以放心投资的国家<a hidden class="anchor" aria-hidden="true" href="#可以放心投资的国家">#</a></h4>
<p>分步实现：</p>
<p>1️⃣ 将呼叫\接听联合</p>
<p>2️⃣ 将对应人员及其国家准备好</p>
<p>3️⃣ 再次连接，并按国家分组且聚合(HAVING进行条件筛选)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">country</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">caller_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">call_id</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Calls</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">callee_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">call_id</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Calls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">Country</span><span class="p">.</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Person</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Country</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="nf">SUBSTR</span><span class="p">(</span><span class="n">phone_number</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">country_code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">call_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Group</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">AVG</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="nf">AVG</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Calls</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h3 id="高级查询和连接">高级查询和连接<a hidden class="anchor" aria-hidden="true" href="#高级查询和连接">#</a></h3>
<p><code>HAVING</code> 子句用来对 <strong>聚合结果</strong> 进行过滤，而 <code>HAVING</code> 子句无法直接使用非聚合列</p>
<h4 id="页面推荐">页面推荐<a hidden class="anchor" aria-hidden="true" href="#页面推荐">#</a></h4>
<p>编写解决方案，向<code>user_id</code> = 1 的用户，推荐其朋友们喜欢的页面。不要推荐该用户已经喜欢的页面。</p>
<p>先find他的所有朋友。 他-&gt;朋友 and 朋友 -&gt;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">page_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">recommended_page</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user2_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Friendship</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user1_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">user1_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Friendship</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user2_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">fs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Likes</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ls</span><span class="p">.</span><span class="n">user_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">page_id</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">page_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Likes</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">recommended_page</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><h4 id="树节点"><a href="https://leetcode.cn/problems/tree-node/">树节点</a><a hidden class="anchor" aria-hidden="true" href="#树节点">#</a></h4>
<p>CASE &hellip; END  按列来，每次处理列的一个元素</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;Root&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">atree</span><span class="p">.</span><span class="n">p_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">atree</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s2">&#34;Inner&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="s2">&#34;Leaf&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">type</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Tree</span><span class="w"> 
</span></span></span></code></pre></div><h4 id="游戏玩法分析-iii"><a href="https://leetcode.cn/problems/game-play-analysis-iii/">游戏玩法分析 III</a><a hidden class="anchor" aria-hidden="true" href="#游戏玩法分析-iii">#</a></h4>
<p>编写一个解决方案，同时报告每组玩家和日期，以及玩家到 <strong>目前为止</strong> 玩了多少游戏。也就是说，玩家在该日期之前所玩的游戏总数。详细情况请查看示例。</p>
<p>利用笛卡尔积， 自己跟自己所有的记录进行连接。暴力遍历</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">event_date</span><span class="p">,</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">a2</span><span class="p">.</span><span class="n">games_played</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">games_played_so_far</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">Activity</span><span class="w"> </span><span class="n">a2</span><span class="w">  </span><span class="c1"># 笛卡儿积，o(n) x o(n) = o(n^2) 条纪录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">player_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">player_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">event_date</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">a2</span><span class="p">.</span><span class="n">event_date</span><span class="w">   </span><span class="c1"># 只要自己和自己进行连接的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="p">.</span><span class="n">event_date</span><span class="w">
</span></span></span></code></pre></div><h4 id="大满贯数量"><a href="https://leetcode.cn/problems/grand-slam-titles/">大满贯数量</a><a hidden class="anchor" aria-hidden="true" href="#大满贯数量">#</a></h4>
<p>编写解决方案，找出每一个球员<strong>赢</strong>得大满贯<strong>比赛的次数</strong>。结果不包含没有赢得比赛的球员的ID 。</p>
<p>思路： 行 -&gt; 列 再聚合</p>
<pre tabindex="0"><code>Players 表：
+-----------+-------------+
| player_id | player_name |
+-----------+-------------+
| 1         | Nadal       |
| 2         | Federer     |
| 3         | Novak       |
+-----------+-------------+
Championships 表：
+------+-----------+---------+---------+---------+
| year | Wimbledon | Fr_open | US_open | Au_open |
+------+-----------+---------+---------+---------+
| 2018 | 1         | 1       | 1       | 1       |
| 2019 | 1         | 1       | 2       | 2       |
| 2020 | 2         | 1       | 2       | 2       |
+------+-----------+---------+---------+---------+
输出：
+-----------+-------------+-------------------+
| player_id | player_name | grand_slams_count |
+-----------+-------------+-------------------+
| 2         | Federer     | 5                 |
| 1         | Nadal       | 7                 |
+-----------+-------------+-------------------+
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="p">.</span><span class="n">player_name</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">grand_slams_count</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">player_id</span><span class="p">,</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">grand_slams_count</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">Wimbledon</span><span class="w"> </span><span class="n">player_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Championships</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">Fr_open</span><span class="w"> </span><span class="n">player_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Championships</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">US_open</span><span class="w"> </span><span class="n">player_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Championships</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">Au_open</span><span class="w"> </span><span class="n">player_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Championships</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">rec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rec</span><span class="p">.</span><span class="n">player_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Players</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">player_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ps</span><span class="p">.</span><span class="n">player_id</span><span class="w">
</span></span></span></code></pre></div><h4 id="应该被禁止的-leetflex-账户"><a href="https://leetcode.cn/problems/leetflex-banned-accounts/"> 应该被禁止的 Leetflex 账户</a><a hidden class="anchor" aria-hidden="true" href="#应该被禁止的-leetflex-账户">#</a></h4>
<p>编写解决方案，查找那些应该被禁止的Leetflex帐户编号 <code>account_id</code> 。 如果某个帐户在某一时刻从两个不同的网络地址登录了，则这个帐户应该被禁止。</p>
<pre tabindex="0"><code>LogInfo table:
+------------+------------+---------------------+---------------------+
| account_id | ip_address | login               | logout              |
+------------+------------+---------------------+---------------------+
| 1          | 1          | 2021-02-01 09:00:00 | 2021-02-01 09:30:00 |
| 1          | 2          | 2021-02-01 08:00:00 | 2021-02-01 11:30:00 |
| 2          | 6          | 2021-02-01 20:30:00 | 2021-02-01 22:00:00 |
| 2          | 7          | 2021-02-02 20:30:00 | 2021-02-02 22:00:00 |
| 3          | 9          | 2021-02-01 16:00:00 | 2021-02-01 16:59:59 |
| 3          | 13         | 2021-02-01 17:00:00 | 2021-02-01 17:59:59 |
| 4          | 10         | 2021-02-01 16:00:00 | 2021-02-01 17:00:00 |
| 4          | 11         | 2021-02-01 17:00:00 | 2021-02-01 17:59:59 |
+------------+------------+---------------------+---------------------+
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">AND</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="p">.</span><span class="n">login</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">login</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">logout</span><span class="p">)</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">logout</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">login</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">logout</span><span class="p">))</span><span class="w">
</span></span></span></code></pre></div><p><strong>GROUP BY 分组</strong></p>
<p><strong>HAVING 作用于组，挑选指定的组</strong></p>
<h3 id="子查询">子查询<a hidden class="anchor" aria-hidden="true" href="#子查询">#</a></h3>
<h4 id="各部门最高收入的员工-可能有多个">各部门最高收入的员工 (可能有多个)<a hidden class="anchor" aria-hidden="true" href="#各部门最高收入的员工-可能有多个">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Department</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Employee</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="n">e1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">departmentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="n">e2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">departmentId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">HAVING</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">departmentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">departmentId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>效率不高！！！</p>
<p>优化：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Department</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Employee</span><span class="p">,</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="n">e1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Department</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">departmentId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">e1</span><span class="p">.</span><span class="n">departmentId</span><span class="p">,</span><span class="n">e1</span><span class="p">.</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">departmentId</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="n">e2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">departmentId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image-20241123202209491" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241123202209491.png"></p>
<p>生成临时表（避免子查询 重复的执行）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">MaxSalaries</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">departmentId</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">salary</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">max_salary</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employee</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">departmentId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><h4 id="每件商品的最新订单"><a href="https://leetcode.cn/problems/the-most-recent-orders-for-each-product/">每件商品的最新订单</a><a hidden class="anchor" aria-hidden="true" href="#每件商品的最新订单">#</a></h4>
<p>可能有多个</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">With</span><span class="w"> </span><span class="n">LatestDate</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">order_date</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">LatestDate</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ld</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ld</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Products</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ld</span><span class="p">.</span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><h4 id="最近的三笔订单">最近的三笔订单<a hidden class="anchor" aria-hidden="true" href="#最近的三笔订单">#</a></h4>
<p>学习， 可分组打index标记，标记按照ORDER顺序</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="nf">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="o">?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p><img alt="image-20241123210524866" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241123210524866.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">ORDER_INFO</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">order_date</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">row_num</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Customers</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">customer_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">customer_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">customer_name</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_id</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">ORDER_INFO</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">o</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">o</span><span class="p">.</span><span class="n">row_num</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_name</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">order_date</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span></code></pre></div><p>先生成临时表，避免重复生成子查询</p>
<h4 id="每天的最大金额">每天的最大金额<a hidden class="anchor" aria-hidden="true" href="#每天的最大金额">#</a></h4>
<p>先筛选出每天的最大金额，再执行后续的判断</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">MAX_AMOUNT</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="kt">DATE</span><span class="p">(</span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="n">max_amount</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Transactions</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="kt">DATE</span><span class="p">(</span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">transaction_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Transactions</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">MAX_AMOUNT</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="kt">DATE</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">day</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma</span><span class="p">.</span><span class="n">day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="kt">DATE</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">day</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ma</span><span class="p">.</span><span class="n">day</span><span class="p">,</span><span class="w"> </span><span class="n">ma</span><span class="p">.</span><span class="n">max_amount</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">transaction_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><p>直接给每天的 订单，按照金额， 打index标记</p>
<p>❗ RANK 相同值会获得相同的排名</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="nf">RANK</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> 
</span></span></span></code></pre></div><p>而 ROW_NUMBER，idx严格递增</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">transaction_id</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">amount</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">rank</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="kt">DATE</span><span class="p">(</span><span class="o">`</span><span class="n">day</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">amount</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">idx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Transactions</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">transaction_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">transaction_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="窗口函数和公共表表达式">窗口函数和公共表表达式<a hidden class="anchor" aria-hidden="true" href="#窗口函数和公共表表达式">#</a></h3>
<h4 id="项目员工-iii"><a href="https://leetcode.cn/problems/project-employees-iii/"> 项目员工 III</a><a hidden class="anchor" aria-hidden="true" href="#项目员工-iii">#</a></h4>
<p>找出每个项目 <strong>经验最丰富的员工(可能有多个)</strong></p>
<p>直接1. 分项目 2. 项目内按经验程度进行RANK 3. 再筛选</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">employee_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">RANK</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">project_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">experience_years</span><span class="w"> </span><span class="k">DESC</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">idx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Project</span><span class="w">  </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employee</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">project_id</span><span class="p">,</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Temp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></div><h4 id="每位顾客最经常订购的商品"><a href="https://leetcode.cn/problems/the-most-frequently-ordered-products-for-each-customer/">每位顾客最经常订购的商品</a><a hidden class="anchor" aria-hidden="true" href="#每位顾客最经常订购的商品">#</a></h4>
<p><img alt="image-20241123220011980" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241123220011980.png"></p>
<p>主SQL GROUP BY 之后，与 RANK() 的操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">customer_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">RANK</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">RK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>结果：</p>
<p><img alt="image-20241123220106683" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241123220106683.png"></p>
<p>添加 PARTITION BY customer_id 进行隔离</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">customer_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">RANK</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">RK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>结果：</p>
<p><img alt="image-20241123220202936" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241123220202936.png"></p>
<p>=&gt; 结论。 1. 先执行主SQL的GROUP BY，进行分区，再RANK(), RANK()按照 ORDER BY(必须聚合为单行)进行排序， 利用PARTITION进行排序隔离。</p>
<p>答案</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">customer_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">product_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">order_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">RANK</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">DESC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">RK</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Orders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">product_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">customer_id</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">product_id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Products</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">product_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">RK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1"># 最高的 NO.1
</span></span></span></code></pre></div><hr>
<h4 id="访问日期之间最大的空档期"><a href="https://leetcode.cn/problems/biggest-window-between-visits/">访问日期之间最大的空档期</a><a hidden class="anchor" aria-hidden="true" href="#访问日期之间最大的空档期">#</a></h4>
<p>LEAD(column, offset, defualt) OVER (PARTITION BY &hellip; ORDER BY &hellip;) 找后面的行。其中LEAD表示引领。</p>
<p>LAG(&hellip;)   找前面的行， 滞后</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="nf">DATEDIFF</span><span class="p">(</span><span class="n">after_day</span><span class="p">,</span><span class="w"> </span><span class="n">visit_date</span><span class="p">))</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">biggest_window</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">visit_date</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">LEAD</span><span class="p">(</span><span class="n">visit_date</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2021-1-1&#39;</span><span class="p">)</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">visit_date</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">after_day</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">UserVisits</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">uv</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">user_id</span><span class="w">
</span></span></span></code></pre></div><p>考点：行之间的差值</p>
<hr>
<p><strong>CTE Common Table Expression</strong></p>
<h4 id="向公司-ceo-汇报工作的所有人"><a href="https://leetcode.cn/problems/all-people-report-to-the-given-manager/">向公司 CEO 汇报工作的所有人</a><a hidden class="anchor" aria-hidden="true" href="#向公司-ceo-汇报工作的所有人">#</a></h4>
<p>查询树状结构节点  列转行</p>
<p>依次暴力枚举</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                      </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">))</span><span class="w"> </span><span class="n">e3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span></code></pre></div><p>太低效了！！！ SB操作，疯狂连续查询</p>
<p>优化</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="c1"># ✔️
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">UNION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span></code></pre></div><hr>
<p>利用连接来计算</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">e4</span><span class="p">.</span><span class="n">employee_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">Employees</span><span class="w"> </span><span class="n">e1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employees</span><span class="w"> </span><span class="n">e2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">manager_id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employees</span><span class="w"> </span><span class="n">e3</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e2</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e3</span><span class="p">.</span><span class="n">manager_id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Employees</span><span class="w"> </span><span class="n">e4</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e3</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e4</span><span class="p">.</span><span class="n">manager_id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">e1</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">e4</span><span class="p">.</span><span class="n">employee_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">1</span><span class="w"> </span><span class="n">Boss</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    	</span><span class="n">1</span><span class="w"> </span><span class="n">Boss</span><span class="w">     </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="n">1</span><span class="w"> </span><span class="n">Boss</span><span class="w">                 </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                           					     </span><span class="n">1</span><span class="w"> </span><span class="n">Boss</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                                                 </span><span class="n">2</span><span class="w"> </span><span class="n">Bob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       											 </span><span class="n">77</span><span class="w"> </span><span class="n">Robert</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                       </span><span class="n">2</span><span class="w"> </span><span class="n">Bob</span><span class="w">                  </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">4</span><span class="w"> </span><span class="n">Daniel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        			   </span><span class="n">77</span><span class="w"> </span><span class="n">Robert</span><span class="w">              </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">2</span><span class="w"> </span><span class="n">Bob</span><span class="w">       </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">4</span><span class="w"> </span><span class="n">Daniel</span><span class="w">              </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">null</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">77</span><span class="w"> </span><span class="n">Robert</span><span class="w">   </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">null</span><span class="w">                   </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">null</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="寻找连续区间的开始和结束位置">寻找连续区间的开始和结束位置<a hidden class="anchor" aria-hidden="true" href="#寻找连续区间的开始和结束位置">#</a></h4>
<p>思路：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">data</span><span class="p">:</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">idx</span><span class="w"> </span><span class="p">:</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">diff</span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nf">MIN</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">Start_ID</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">End_ID</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">Temp</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">log_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">ROW_NUMBER</span><span class="p">()</span><span class="w"> </span><span class="nf">OVER</span><span class="w"> </span><span class="p">(</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">log_id</span><span class="w"> </span><span class="k">ASC</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">idx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Logs</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="nf">MIN</span><span class="p">(</span><span class="n">log_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">start_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">log_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">end_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">log_id</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">log_id</span><span class="o">-</span><span class="n">idx</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">diff</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Temp</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">diff</span><span class="w">
</span></span></span></code></pre></div><h4 id="查找处于成绩中游的学生">查找处于成绩中游的学生<a hidden class="anchor" aria-hidden="true" href="#查找处于成绩中游的学生">#</a></h4>
<p>参加的考试，没有一科是最高分或者最低分。科科中等</p>
<p>逻辑： 1. 判断每一科，再统计所有科目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">MAXMIN</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="nf">MIN</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="n">min_score</span><span class="p">,</span><span class="w"> </span><span class="nf">MAX</span><span class="p">(</span><span class="n">score</span><span class="p">)</span><span class="w"> </span><span class="n">max_score</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Exam</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">exam_id</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">student_name</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">exam_id</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">student_id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">min_score</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">max_score</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">is_medium</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">Exam</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">e</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">MAXMIN</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">exam_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">exam_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LEFT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">Student</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">student_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">student_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">student_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w"> </span><span class="nf">SUM</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">is_medium</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">COUNT</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">is_medium</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">student_id</span><span class="w"> </span><span class="k">ASC</span><span class="w">
</span></span></span></code></pre></div><p>反过来： 将尖子生和垫底生排除在外即可</p>
<hr>
<h4 id="寻找没有被执行的任务对"><a href="https://leetcode.cn/problems/find-the-subtasks-that-did-not-execute/">寻找没有被执行的任务对</a><a hidden class="anchor" aria-hidden="true" href="#寻找没有被执行的任务对">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">with</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="nf">all_subtask</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtask_id</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtasks_count</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="n">Tasks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtask_id</span><span class="o">-</span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">FROM</span><span class="w"> </span><span class="n">all_subtask</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">where</span><span class="w"> </span><span class="n">subtask_id</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtask_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">From</span><span class="w"> </span><span class="n">all_subtask</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtask_id</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="n">subtask_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Executed</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">with</span><span class="w"> </span><span class="n">recursive</span><span class="w"> </span><span class="nf">TableName</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">param2</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">SELECT</span><span class="w"> </span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">param2</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">基础结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">BaseTable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">//</span><span class="w"> </span><span class="err">下面式子会被重复递归</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">param1</span><span class="p">,</span><span class="w"> </span><span class="n">param2</span><span class="o">-</span><span class="mi">1</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">新的结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">TableName</span><span class="w">         </span><span class="o">//</span><span class="w"> </span><span class="err">上一轮的结果</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">where</span><span class="w"> </span><span class="n">param2</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="o">//</span><span class="w"> </span><span class="err">递归终止条件</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/jobs/java/">
    <span class="title">« Prev</span>
    <br>
    <span>Java面试题笔记</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">LongCoding&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
