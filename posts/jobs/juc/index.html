<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å¹¶å‘é¢è¯•é¢˜ç¬”è®° | LongCoding&#39;s Blog</title>
<meta name="keywords" content="JUC">
<meta name="description" content="1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹
1ï¼‰ å®ç°Runnableæ¥å£

å®ç°run()æ–¹æ³•

1new Thread(MyRunnable()).start();
2ï¼‰ç»§æ‰¿Threadç±»

é‡å†™run()æ–¹æ³•

3ï¼‰Callableæ¥å£&amp;&amp;FutureTask

å®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨

1FutrueTask&lt;ReturnType&gt; task = new FutrueTask&lt;&gt;(MyCallable());
2Thread(task).start
3    
4ResultType res = task.get(); // è¿™é‡Œé˜»å¡
4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± 

é€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡

ä¸åŒæ–¹æ³•å¯¹æ¯”
1Runnable vs Callable
2Callable:å¯ä»¥è¿”å›ç»“æœï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸
3
4çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼šé¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€ï¼›
5ThreadPool =&gt; (FixedThreadPool, CachedThreadPool, ScheduledThreadPool)
6   
7è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½
8Thread.startVirtualThread()
ThreadPoolå®è·µ
XXXThreadPool.submit(task&hellip;)
1FixedThreadPool: å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡ =&gt; é€‚åˆ1.æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡ï¼›2.æ§åˆ¶å¹¶å‘åº¦
2    
3CachedThreadPoolï¼šæ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®šï¼Œæ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹ï¼Œç©ºçš„è¢«å›æ”¶ï¼Œå°‘äº†å¤šåˆ›å»ºï¼›
4â­é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯ï¼›
5    
6ScheduledThreadPoolï¼šé€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚    
 1// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± 
 2ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5);
 3// For å»¶è¿Ÿä»»åŠ¡
 4scheduledThreadPool.schedule(() -&gt; {
 5    // ä»»åŠ¡é€»è¾‘
 6}, 10, TimeUnit.SECONDS); // å»¶è¿Ÿ10ç§’æ‰§è¡Œ
 7
 8// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡
 9scheduledThreadPool.scheduleAtFixedRate(() -&gt; {
10    // ä»»åŠ¡é€»è¾‘
11}, 0, 1, TimeUnit.SECONDS); // æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡
Thread.sleep(0) &lt;= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ">
<meta name="author" content="LongWei">
<link rel="canonical" href="http://121.40.252.207/posts/jobs/juc/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.6da9a63d25a9608bca2f7f907a030e887a7dd3c3f3918e4cc113129361414bda.css" integrity="sha256-bammPSWpYIvKL3&#43;QegMOiHp908PzkY5MwRMSk2FBS9o=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://121.40.252.207/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://121.40.252.207/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://121.40.252.207/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://121.40.252.207/apple-touch-icon.png">
<link rel="mask-icon" href="http://121.40.252.207/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://121.40.252.207/posts/jobs/juc/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://121.40.252.207/posts/jobs/juc/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="å¹¶å‘é¢è¯•é¢˜ç¬”è®°">
  <meta property="og:description" content="1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹ 1ï¼‰ å®ç°Runnableæ¥å£
å®ç°run()æ–¹æ³• 1new Thread(MyRunnable()).start(); 2ï¼‰ç»§æ‰¿Threadç±»
é‡å†™run()æ–¹æ³• 3ï¼‰Callableæ¥å£&amp;&amp;FutureTask
å®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨ 1FutrueTask&lt;ReturnType&gt; task = new FutrueTask&lt;&gt;(MyCallable()); 2Thread(task).start 3 4ResultType res = task.get(); // è¿™é‡Œé˜»å¡ 4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± 
é€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡ ä¸åŒæ–¹æ³•å¯¹æ¯”
1Runnable vs Callable 2Callable:å¯ä»¥è¿”å›ç»“æœï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸ 3 4çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼šé¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€ï¼› 5ThreadPool =&gt; (FixedThreadPool, CachedThreadPool, ScheduledThreadPool) 6 7è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½ 8Thread.startVirtualThread() ThreadPoolå®è·µ
XXXThreadPool.submit(taskâ€¦)
1FixedThreadPool: å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡ =&gt; é€‚åˆ1.æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡ï¼›2.æ§åˆ¶å¹¶å‘åº¦ 2 3CachedThreadPoolï¼šæ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®šï¼Œæ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹ï¼Œç©ºçš„è¢«å›æ”¶ï¼Œå°‘äº†å¤šåˆ›å»ºï¼› 4â­é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯ï¼› 5 6ScheduledThreadPoolï¼šé€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚ 1// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  2ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5); 3// For å»¶è¿Ÿä»»åŠ¡ 4scheduledThreadPool.schedule(() -&gt; { 5 // ä»»åŠ¡é€»è¾‘ 6}, 10, TimeUnit.SECONDS); // å»¶è¿Ÿ10ç§’æ‰§è¡Œ 7 8// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡ 9scheduledThreadPool.scheduleAtFixedRate(() -&gt; { 10 // ä»»åŠ¡é€»è¾‘ 11}, 0, 1, TimeUnit.SECONDS); // æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡ Thread.sleep(0) &lt;= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-03-05T00:00:00+00:00">
    <meta property="article:tag" content="JUC">
      <meta property="og:see_also" content="http://121.40.252.207/posts/jobs/collection/">
      <meta property="og:see_also" content="http://121.40.252.207/posts/jobs/jvm/">
      <meta property="og:see_also" content="http://121.40.252.207/posts/jobs/mysql/">
      <meta property="og:see_also" content="http://121.40.252.207/posts/jobs/redis/">
      <meta property="og:see_also" content="http://121.40.252.207/posts/jobs/java/">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="å¹¶å‘é¢è¯•é¢˜ç¬”è®°">
<meta name="twitter:description" content="1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹
1ï¼‰ å®ç°Runnableæ¥å£

å®ç°run()æ–¹æ³•

1new Thread(MyRunnable()).start();
2ï¼‰ç»§æ‰¿Threadç±»

é‡å†™run()æ–¹æ³•

3ï¼‰Callableæ¥å£&amp;&amp;FutureTask

å®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨

1FutrueTask&lt;ReturnType&gt; task = new FutrueTask&lt;&gt;(MyCallable());
2Thread(task).start
3    
4ResultType res = task.get(); // è¿™é‡Œé˜»å¡
4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± 

é€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡

ä¸åŒæ–¹æ³•å¯¹æ¯”
1Runnable vs Callable
2Callable:å¯ä»¥è¿”å›ç»“æœï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸
3
4çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼šé¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€ï¼›
5ThreadPool =&gt; (FixedThreadPool, CachedThreadPool, ScheduledThreadPool)
6   
7è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½
8Thread.startVirtualThread()
ThreadPoolå®è·µ
XXXThreadPool.submit(task&hellip;)
1FixedThreadPool: å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡ =&gt; é€‚åˆ1.æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡ï¼›2.æ§åˆ¶å¹¶å‘åº¦
2    
3CachedThreadPoolï¼šæ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®šï¼Œæ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹ï¼Œç©ºçš„è¢«å›æ”¶ï¼Œå°‘äº†å¤šåˆ›å»ºï¼›
4â­é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯ï¼›
5    
6ScheduledThreadPoolï¼šé€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚    
 1// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± 
 2ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5);
 3// For å»¶è¿Ÿä»»åŠ¡
 4scheduledThreadPool.schedule(() -&gt; {
 5    // ä»»åŠ¡é€»è¾‘
 6}, 10, TimeUnit.SECONDS); // å»¶è¿Ÿ10ç§’æ‰§è¡Œ
 7
 8// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡
 9scheduledThreadPool.scheduleAtFixedRate(() -&gt; {
10    // ä»»åŠ¡é€»è¾‘
11}, 0, 1, TimeUnit.SECONDS); // æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡
Thread.sleep(0) &lt;= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://121.40.252.207/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "å¹¶å‘é¢è¯•é¢˜ç¬”è®°",
      "item": "http://121.40.252.207/posts/jobs/juc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å¹¶å‘é¢è¯•é¢˜ç¬”è®°",
  "name": "å¹¶å‘é¢è¯•é¢˜ç¬”è®°",
  "description": "1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹ 1ï¼‰ å®ç°Runnableæ¥å£\nå®ç°run()æ–¹æ³• 1new Thread(MyRunnable()).start(); 2ï¼‰ç»§æ‰¿Threadç±»\né‡å†™run()æ–¹æ³• 3ï¼‰Callableæ¥å£\u0026amp;\u0026amp;FutureTask\nå®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨ 1FutrueTask\u0026lt;ReturnType\u0026gt; task = new FutrueTask\u0026lt;\u0026gt;(MyCallable()); 2Thread(task).start 3 4ResultType res = task.get(); // è¿™é‡Œé˜»å¡ 4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± \né€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡ ä¸åŒæ–¹æ³•å¯¹æ¯”\n1Runnable vs Callable 2Callable:å¯ä»¥è¿”å›ç»“æœï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸ 3 4çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼šé¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€ï¼› 5ThreadPool =\u0026gt; (FixedThreadPool, CachedThreadPool, ScheduledThreadPool) 6 7è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½ 8Thread.startVirtualThread() ThreadPoolå®è·µ\nXXXThreadPool.submit(task\u0026hellip;)\n1FixedThreadPool: å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡ =\u0026gt; é€‚åˆ1.æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡ï¼›2.æ§åˆ¶å¹¶å‘åº¦ 2 3CachedThreadPoolï¼šæ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®šï¼Œæ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹ï¼Œç©ºçš„è¢«å›æ”¶ï¼Œå°‘äº†å¤šåˆ›å»ºï¼› 4â­é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯ï¼› 5 6ScheduledThreadPoolï¼šé€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚ 1// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  2ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5); 3// For å»¶è¿Ÿä»»åŠ¡ 4scheduledThreadPool.schedule(() -\u0026gt; { 5 // ä»»åŠ¡é€»è¾‘ 6}, 10, TimeUnit.SECONDS); // å»¶è¿Ÿ10ç§’æ‰§è¡Œ 7 8// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡ 9scheduledThreadPool.scheduleAtFixedRate(() -\u0026gt; { 10 // ä»»åŠ¡é€»è¾‘ 11}, 0, 1, TimeUnit.SECONDS); // æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡ Thread.sleep(0) \u0026lt;= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ\n",
  "keywords": [
    "JUC"
  ],
  "articleBody": "1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹ 1ï¼‰ å®ç°Runnableæ¥å£\nå®ç°run()æ–¹æ³• 1new Thread(MyRunnable()).start(); 2ï¼‰ç»§æ‰¿Threadç±»\né‡å†™run()æ–¹æ³• 3ï¼‰Callableæ¥å£\u0026\u0026FutureTask\nå®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨ 1FutrueTask\u003cReturnType\u003e task = new FutrueTask\u003c\u003e(MyCallable()); 2Thread(task).start 3 4ResultType res = task.get(); // è¿™é‡Œé˜»å¡ 4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± \né€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡ ä¸åŒæ–¹æ³•å¯¹æ¯”\n1Runnable vs Callable 2Callable:å¯ä»¥è¿”å›ç»“æœï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸ 3 4çº¿ç¨‹æ± çš„ä¼˜åŠ¿ï¼šé¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œå‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€ï¼› 5ThreadPool =\u003e (FixedThreadPool, CachedThreadPool, ScheduledThreadPool) 6 7è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½ 8Thread.startVirtualThread() ThreadPoolå®è·µ\nXXXThreadPool.submit(taskâ€¦)\n1FixedThreadPool: å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡ =\u003e é€‚åˆ1.æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡ï¼›2.æ§åˆ¶å¹¶å‘åº¦ 2 3CachedThreadPoolï¼šæ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®šï¼Œæ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹ï¼Œç©ºçš„è¢«å›æ”¶ï¼Œå°‘äº†å¤šåˆ›å»ºï¼› 4â­é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯ï¼› 5 6ScheduledThreadPoolï¼šé€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ã€‚ 1// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  2ScheduledExecutorService scheduledThreadPool = Executors.newScheduledThreadPool(5); 3// For å»¶è¿Ÿä»»åŠ¡ 4scheduledThreadPool.schedule(() -\u003e { 5 // ä»»åŠ¡é€»è¾‘ 6}, 10, TimeUnit.SECONDS); // å»¶è¿Ÿ10ç§’æ‰§è¡Œ 7 8// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡ 9scheduledThreadPool.scheduleAtFixedRate(() -\u003e { 10 // ä»»åŠ¡é€»è¾‘ 11}, 0, 1, TimeUnit.SECONDS); // æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡ Thread.sleep(0) \u003c= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ\nthread.join() \u003c= ç­‰å¾…è¯¥çº¿ç¨‹å®Œæˆ\n2 åˆ›å»ºçº¿ç¨‹æ±  1ï¼‰ Executorså·¥å‚ç±»\nExecutors.newFixedThreadPool(10) // 2ï¼‰ThreadPoolExecutorç›´æ¥åˆ›å»ºçº¿ç¨‹æ± \n1new ThreadPoolExecutor(corePoolSize, maximumPoolSize, KeepAliveTime,TimeUnit,new LinkedBlockingQueue\u003c\u003e()) 2 3LinkedBlockingQueue: å½“æäº¤çš„ä»»åŠ¡å¤šäºçº¿ç¨‹æ•°æ—¶ï¼Œä¼šå°†å¤šä½™çš„æš‚æ—¶æŒ‚èµ· çº¿ç¨‹æ± ç›¸å…³å‚æ•°è§£é‡Š\ncorePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³çº¿ç¨‹æ± ä¸­å§‹ç»ˆä¿å­˜çš„çº¿ç¨‹æ•°é‡ï¼› maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼› KeepAliveTimeï¼šçº¿ç¨‹ç©ºé—²æ—¶é—´ï¼Œéæ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…è¿‡è¿™ä¸ªæ—¶é—´ä¼šè¢«é”€æ¯ï¼› workQueueï¼šå·¥ä½œé˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼› threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ï¼› rejectedExecutionHandlerï¼šä»»åŠ¡æ‹’ç»å¤„ç†å™¨ï¼Œå½“å‰ä»»åŠ¡æ— æ³•æ‰§è¡Œæ—¶çš„å¤„ç†ç­–ç•¥ã€‚ å·¥ä½œé˜Ÿåˆ—\nSynchronousQueueï¼šä¸å­˜å‚¨ä»»åŠ¡ï¼Œç›´æ¥æäº¤ä»»åŠ¡ç»™çº¿ç¨‹ï¼› LinkedBlockingQueueï¼šé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¤§å°æ— é™ï¼› ArrayBlockingQueueï¼šæ•°æ®ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼› PriorityBlockingQueueï¼šå¸¦ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚/ praÉªËˆÉ’rÉ™ti / çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥\né˜Ÿåˆ—æ»¡ä¸”æ— ç©ºé—²çº¿ç¨‹çš„æ·»åŠ ä»»åŠ¡çš„æƒ…å†µã€‚\nAbortPolicyï¼šæŠ›å¼‚å¸¸ï¼› CallerRunsPolicyï¼šç”±æäº¤çº¿ç¨‹æœ¬èº«æ‰§è¡Œï¼› DiscardOldestPolicyï¼šåˆ é™¤æœ€æ—©æäº¤çš„ä»»åŠ¡ï¼› DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒå½“å‰ä»»åŠ¡ã€‚ 3 çº¿ç¨‹å®‰å…¨çš„é›†åˆ 1concurrentHashMap: åŒæ­¥HashMap\u003cK-\u003eV\u003e 2æ•°æ®ç»“æ„=\u003e ä½¿ç”¨æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘çš„ç»“æ„; 3çº¿ç¨‹å®‰å…¨=\u003e CASä¿è¯æ“ä½œçš„åŸå­æ€§ 4 5eg:çº¿ç¨‹ä¸å®‰å…¨çš„æ“ä½œï¼š 6// éçº¿ç¨‹å®‰å…¨çš„æ“ä½œ 7int value = map.get(\"key\"); // è¿™é‡Œï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹key-\u003evalueè¿›è¡Œäº†ä¿®æ”¹ï¼ï¼Œè¿™é‡Œçš„valueæ˜¯è¿‡æœŸäº†çš„ 8map.put(\"key\", value + 1); 9// â­ä¿è¯åŸå­æ€§ 10map.compute(\"key\", (k, v) -\u003e v + 1); // ä¸€æ¬¡å®Œæˆ 11 12// å¦‚æœæ˜¯æ–¹æ³•ä¸­åˆ›å»ºçš„Map,æ¯ä¸ªçº¿ç¨‹ä¸“äº«ï¼Œä¸ä¼šæœ‰çº¿ç¨‹é—´å®‰å…¨é—®é¢˜ 13// å¦‚æœæ˜¯ç±»ä¸­ï¼Œä¸”å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªClasså®ä¾‹ï¼Œåˆ™å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ 14Methodä¸­åˆ›å»ºï¼šå®‰å…¨ 15Class-æˆå‘˜å˜é‡ï¼šå¤šä¸ªçº¿ç¨‹å¯èƒ½å…±äº«åŒä¸€ä¸ªmapå®ä¾‹ï¼Œéœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ 16Class-é™æ€å˜é‡ï¼šæ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ª map å®ä¾‹ ï¼Œéœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ 17 18BlockingQueueï¼š -æ•°ç»„å®ç° 19LinkedBlockingQueue: çº¿ç¨‹å®‰å…¨çš„é˜»å¡é˜Ÿåˆ—-é“¾è¡¨å®ç° 4 çº¿ç¨‹åŒæ­¥ å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œé¿å…å…±äº«èµ„æºåŒæ—¶è®¿é—®ï¼Œå¼•å‘æ•°æ®ä¸ä¸€è‡´ã€‚=\u003e åŠ é”ï¼Œé™åˆ¶è®¿é—®ã€‚\nJAVAä¸­ï¼Œå¸¸è§çš„åŒæ­¥æ–¹å¼ï¼š\nsynchronized åŒæ­¥ // ä»…é™ä¸€ä¸ªçº¿ç¨‹è®¿é—®. ç”± JVM è´Ÿè´£ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾. éå…¬å¹³é”\nç”Ÿäº§-æ¶ˆè´¹ æ¨¡æ‹Ÿ\n1Mainï¼š 2// å…±äº«é˜Ÿåˆ—ï¼Œç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’ 3Queue\u003cInteger\u003e queue = new LinkedList\u003c\u003e(); // or BlockingQueue 4int maxSize = 5; // é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡ 5 6// åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹ 7Thread producer = new Thread(new Producer(queue, maxSize), \"Producer\"); 8Thread consumer = new Thread(new Consumer(queue), \"Consumer\"); 9 10// å¯åŠ¨çº¿ç¨‹ 11producer.start(); 12consumer.start(); 1Producer: å®ç°Runnable interface 2@Override 3public void run() { 4 int i = 0; 5 while (true) { 6 synchronized (queue) { // å¯¹é˜Ÿåˆ—åŠ é” 7 // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾… 8 while (queue.size() == maxSize) { 9 try { 10 System.out.println(\"é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…...\"); 11 queue.wait(); // é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ 12 } catch (InterruptedException e) { 13 e.printStackTrace(); 14 } 15 } 16 17 // ç”Ÿäº§æ•°æ®å¹¶æ·»åŠ åˆ°é˜Ÿåˆ— 18 System.out.println(\"ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®: \" + i); 19 queue.add(i++); 20 21 // é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹äº† 22 queue.notifyAll(); 23 24 // æ¨¡æ‹Ÿç”Ÿäº§è€—æ—¶ 25 try { 26 Thread.sleep(500); 27 } catch (InterruptedException e) { 28 e.printStackTrace(); 29 } 30 } 31 } 32} 1Consumerï¼šå®ç°Runnableæ¥å£ 2@Override 3public void run() { 4 while (true) { 5 synchronized (queue) { // å¯¹é˜Ÿåˆ—åŠ é” 6 // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…ç­‰å¾… 7 while (queue.isEmpty()) { 8 try { 9 System.out.println(\"é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…ç­‰å¾…...\"); 10 queue.wait(); // é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ 11 } catch (InterruptedException e) { 12 e.printStackTrace(); 13 } 14 } 15 16 // æ¶ˆè´¹æ•°æ® 17 int value = queue.poll(); 18 System.out.println(\"æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®: \" + value); 19 20 // é€šçŸ¥ç”Ÿäº§è€…å¯ä»¥ç”Ÿäº§äº† 21 queue.notifyAll(); 22 23 // æ¨¡æ‹Ÿæ¶ˆè´¹è€—æ—¶ 24 try { 25 Thread.sleep(1000); 26 } catch (InterruptedException e) { 27 e.printStackTrace(); 28 } 29 } 30 } 31} â­â­â­\nsynchronizedï¼ˆä¸´ç•ŒåŒºå¯¹è±¡ï¼‰ \u003c= é”ä½ä¸´ç•ŒåŒº\nwhile(ä¸´ç•ŒåŒºä¸å¯ç”¨) =\u003e é‡è¯• =\u003e .wait() å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€è®©å‡ºCPUï¼Œå¹¶ä¸”é‡Šæ”¾é”\nå¤„ç†å®Œæˆ=\u003e .notifyAll() // é€šçŸ¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹\nsynchronizedï¼šé€šè¿‡ Object.wait() å’Œ Object.notify()/notifyAll() è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡\nReentrantLock å¯é‡å…¥é” Re en trant lock. éœ€è¦æ‰‹åŠ¨åŠ é”å’Œé‡Šæ”¾é”\n1lock.lock(); 2try { 3 // ä¸´ç•ŒåŒºä»£ç  4} finally { 5 lock.unlock(); 6} ReentrantLockï¼šä½¿ç”¨ Condition å¯¹è±¡æ›´çµæ´»åœ°æ§åˆ¶çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’ï¼š\n1Condition condition = lock.newCondition(); 2lock.lock(); 3try { 4 condition.await(); // çº¿ç¨‹ç­‰å¾… 5 condition.signal(); // å”¤é†’å•ä¸ªç­‰å¾…çš„çº¿ç¨‹ 6 condition.signalAll(); // å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ 7} finally { 8 lock.unlock(); 9} æ¡ˆä¾‹\n1// å…±äº«é˜Ÿåˆ—ï¼Œç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’ 2Queue\u003cInteger\u003e queue = new LinkedList\u003c\u003e(); 3// åˆ›å»º ReentrantLock å’Œ Condition 4Lock lock = new ReentrantLock(); 5Condition notFull = lock.newCondition(); // é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶ 6Condition notEmpty = lock.newCondition(); // é˜Ÿåˆ—éç©ºçš„æ¡ä»¶ 7 8Producer: 9while(true) { 10 lock.lock() 11 try{ 12 // 13 while(queue.size == maxSize) { 14 System.out.println(\"é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…...\"); 15 notFull.await(); // ç­‰å¾…é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶ 16 } 17 18 queue.add(?) 19 notEmpty.signalAll() 20 21 // ... ç”Ÿäº§è€—æ—¶ 22 23 }finally{ 24 lock.unlock() 25 } 26} 27 28Consumer: 29while(true) { 30 lock.lock() 31 try { 32 while(queue.size == 0) { 33 sout(\"æ²¡ä¸œè¥¿æ¶ˆè´¹\") 34 notEmpty.await() 35 } 36 37 queue.poll() 38 notFull.signalAll() 39 40 // ...æ¶ˆè´¹æ—¶é•¿ 41 }finally{ 42\tlock.unlock() 43 } 44} â­â­â­ å…³é”®ç”¨æ³•ï¼š\nLock lock = new ReentrantLock(); Condition notFull = lock.newCondition(); // é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶ Condition notEmpty = lock.newCondition(); // é˜Ÿåˆ—éç©ºçš„æ¡ä»¶\nlock.lock \u0026\u0026 lock.unlock\nnotFull.await(), notFull.signal(), notFull.signalAll()\n5 çº¿ç¨‹å®‰å…¨ ä¿è¯å¤šçº¿ç¨‹ï¼Œä¹±åºæ‰§è¡Œæ—¶å€™ï¼Œæ— è®ºæ€ä¹ˆæ‰§è¡Œï¼Œéƒ½å¯ä»¥å¾—åˆ°é¢„æœŸç»“æœ\n=\u003e é€šè¿‡ çº¿ç¨‹åŒæ­¥ (æ‚²è§‚é”)\né€šè¿‡Synchronized å’Œ ReentrantLock ËˆsÉªÅ‹krÉ™naÉªzd \u0026 riËËˆentrÉ™nt, lÉ’k å®ç°çº¿ç¨‹åŒæ­¥\n=\u003e é€šè¿‡åŸå­æ“ä½œç±»\nAtomicInteger É™ËˆtÉ’mÉªk åŸå­ï¼Œ åŸå­æ•´æ•°\nâ­â­â­æ‰©å±•CASï¼ˆä¹è§‚é”ï¼‰ï¼šï¼ˆCompare And Swapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ˜¯ä¸€ç§æ— é”å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œå¸¸ç”¨äºå®ç°åŸå­æ“ä½œã€‚å®ƒçš„åŸºæœ¬åŸç†æ˜¯ï¼šå…ˆæ¯”è¾ƒï¼Œå†äº¤æ¢ï¼Œå³åªæœ‰å½“å˜é‡çš„å½“å‰å€¼ç­‰äºé¢„æœŸå€¼æ—¶ï¼Œæ‰ä¼šæ›´æ–°ï¼Œå¦åˆ™é‡è¯•ã€‚\n1// å½“å‰å€¼, é¢„æœŸå€¼, æ–°å€¼ 2boolean compareAndSwap(V, E, N) { 3 if (V == E) { // æ¯”è¾ƒå½“å‰å€¼æ˜¯å¦ç­‰äºé¢„æœŸå€¼ 4 V = N; // å¦‚æœç›¸ç­‰ï¼Œæ›´æ–°ä¸ºæ–°å€¼ 5 return true; // æ“ä½œæˆåŠŸ 6 } 7 return false; // æ“ä½œå¤±è´¥ 8} ä¾‹å­ï¼šæœ€ä½³å®è·µæ¡ˆä¾‹=\u003e çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨\n1private AtomicInteger value = new AtomicInteger(0); 2 3// çº¿ç¨‹å®‰å…¨çš„é€’å¢æ–¹æ³• 4public void increment() { 5 int oldValue; 6 int newValue; 7 do { 8 oldValue = value.get(); // è·å–å½“å‰å€¼, å…ˆè·å–ä¿®æ”¹å€¼ 9 newValue = oldValue + 1; // è®¡ç®—æ–°å€¼ 10 } while (!value.compareAndSet(oldValue, newValue)); // CAS æ“ä½œ 11} 12// CAS compare and swap \u003c=\u003e è®¿é—®åˆ°ä¿®æ”¹æœŸé—´ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œä¿®æ”¹çš„è¯ï¼Œå°±å¯ä»¥æ‰§è¡Œ 13value.compareAndSet(oldValue, newValue) =\u003e oldvalue == value.get() ? value = newValue ï¼šnothing æ£€æŸ¥ç¬¬ä¸€æ¬¡å¾—åˆ°çš„æ—§å€¼ä¸ä¿®æ”¹æ—¶çš„å€¼æ˜¯å¦ä¸€è‡´ï¼Œåˆ¤æ–­æ˜¯å¦è¢«åŠ¨è¿‡ï¼Œæ²¡åŠ¨è¿‡å†æ”¹\n=\u003e çº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼šconcurrentHashMap or copyonWriteArrayListâŒ ä¸æ‡‚\n=\u003e å±€éƒ¨å˜é‡ï¼Œçº¿ç¨‹ä¸“äº«\n=\u003e ThreadLocal, çº¿ç¨‹æœ¬åœ°èµ„æºï¼Œçº¿ç¨‹ä¸“äº«\n6 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ åˆå§‹(èµ„æº) =\u003e å¯è¿è¡Œ(CPUé˜Ÿåˆ—) =\u003e è¿è¡Œ =\u003e ç»ˆæ­¢\nâ€‹ é˜»å¡\u0026ç­‰å¾…\n7 çº¿ç¨‹é€šä¿¡ å¤šçº¿ç¨‹é—´çš„ååŒå·¥ä½œ\n1ï¼‰**å…±äº«å˜é‡ï¼š**è®¿é—®å…±äº«å†…å­˜å˜é‡æ¥äº¤æ¢ä¿¡æ¯ï¼›\n2ï¼‰åŒæ­¥æœºåˆ¶ï¼š\nsynchronized() =\u003e wait =\u003e notify\u0026notifyAll ï¼ˆObjectä¸­çš„æ–¹æ³•ï¼‰\nReentrantLock.lock =\u003e condition.await =\u003e condition.signal\u0026signalAll\nBlockingQueue =\u003e queue.put() æ»¡åˆ™é˜»å¡ =\u003e queue.take() ç©ºåˆ™é˜»å¡\n1synchronized (lock) { 2 while (conditionNotMet) { 3 lock.wait(); // é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€ 4 } 5 // æ‰§è¡Œæ“ä½œ 6 lock.notify(); // å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ 7} 1Lock lock = new ReentrantLock(); 2Condition condition = lock.newCondition(); 3 4lock.lock(); 5try { 6 while (conditionNotMet) { 7 condition.await(); // ç­‰å¾… 8 } 9 // æ‰§è¡Œæ“ä½œ 10 condition.signal(); // å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ 11} finally { 12 lock.unlock(); 13} 1BlockingQueue\u003cString\u003e queue = new LinkedBlockingQueue\u003c\u003e(10); 2 3// ç”Ÿäº§è€… 4new Thread(() -\u003e { 5 try { 6 queue.put(\"Data\"); 7 } catch (InterruptedException e) { 8 Thread.currentThread().interrupt(); 9 } 10}).start(); 11 12// æ¶ˆè´¹è€… 13new Thread(() -\u003e { 14 try { 15 String data = queue.take(); 16 } catch (InterruptedException e) { 17 Thread.currentThread().interrupt(); 18 } 19}).start(); 8 çº¿ç¨‹æ±  æ± åŒ–æŠ€æœ¯ï¼Œé¢„å…ˆåˆ›å»ºå¹¶ç®¡ç†ä¸€ç»„çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹é‡å¤åˆ›å»ºå’Œé”€æ¯å¸¦æ¥çš„å¼€é”€\nå…³é”®é…ç½®ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ï¼Œç©ºé—´å­˜æ´»æ—¶é—´ï¼Œå·¥ä½œé˜Ÿåˆ—ï¼Œæ‹’ç»ç­–ç•¥\n=\u003e æäº¤ä»»åŠ¡æ‰ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œæˆ–è€…è®¾ç½®preStartAllCoreThreads\n=\u003e æ ¸å¿ƒçº¿ç¨‹æ»¡äº†ä¸ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯æŠŠå¤šä½™çš„ä»»åŠ¡æ”¾åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ‰§è¡Œ\n=\u003e æ ¸å¿ƒçº¿ç¨‹æ»¡è½½ä¸”å·¥ä½œé˜Ÿåˆ—æ”¾ä¸ä¸‹äº†ï¼Œæ‰ä¼šæ–°å¢çº¿ç¨‹æ‰§è¡Œæäº¤çš„ä»»åŠ¡(\u003cæœ€å¤§çº¿ç¨‹æ•°)\n=\u003e å·¥ä½œé˜Ÿåˆ—æ»¡äº†+å·²æœ€å¤§çº¿ç¨‹æ•°äº† =\u003e æ‹’ç»ç­–ç•¥?æ–°ä»»åŠ¡\n=\u003e çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡æŒ‡å®šæ—¶é—´ ä¸”æœ‰å¤šä½™çš„éæ ¸å¿ƒçº¿ç¨‹ =\u003e é‡Šæ”¾éæ ¸å¿ƒçº¿ç¨‹\nå·¥ä½œé˜Ÿåˆ—ï¼š\nLinkedBlockingQueue æ— ç•Œé˜Ÿåˆ—ï¼Œé“¾å¼\nArrayBlockingQueue æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ•°ç»„\nPriorityBlockingQueue å¸¦æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—\nçº¿ç¨‹æ± ç±»å‹ï¼š\n1FixedThreadPool: å›ºå®šçº¿ç¨‹æ•° 2CachedThreadPoolï¼šå˜åŒ–ï¼ŒåŠ¨æ€æ–°å»º 3SingleThreadPoolï¼šå•çº¿ç¨‹çš„æ± å­ 4ScheduledThreadPoolï¼šå®šæ—¶ä»»åŠ¡çš„æ± å­ shutdownä¸shutdownNowçš„åŒºåˆ«\nshutdownï¼šæé†’å…³é—­ï¼Œä¼šæŠŠå·²æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•\nshutdownNowï¼šå¼ºåˆ¶åœæ­¢\n9 å¹¶å‘å·¥å…·ç±» ConcurrentHashMapï¼šçº¿ç¨‹å®‰å…¨çš„HashMapï¼Œå¤šçº¿ç¨‹ä¿®æ”¹ä¸´ç•ŒåŒºæ—¶åŠ é”æˆ–è€…å…¶ä»–æ–¹æ³•ï¼Œ=\u003eå®‰å…¨\nAtomicIntergerï¼šÉ™ËˆtÉ’mÉªk çº¿ç¨‹å®‰å…¨çš„æ•´å‹ compareAndSet CASæ–¹æ³•ï¼ŒåŸå­ç±»å‹\nSemaphore ä¿¡å·é‡ï¼šacquire() and release()\nBlockingQueueï¼šé˜»å¡é˜Ÿåˆ—-é€šä¿¡å®¹å™¨ queue.put() and queue.take()\nCyclicBarrierï¼šå¾ªç¯å±éšœ barrier.await\nCountDownlatchï¼šè®¡æ—¶å™¨ latch.countDown() latch.await()\n497 ReentrantLockå®ç° =\u003e å¯é‡å…¥é”ï¼Œå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”çš„é”æœºåˆ¶ï¼Œé¿å…çº¿ç¨‹å› ä¸ºé‡å¤è·å–é”è€Œå¯¼è‡´æ­»é”\næ¡ˆä¾‹ï¼š1. é€’å½’è°ƒç”¨ä¸­çš„é”ä¿æŠ¤\n1# éå…¬å¹³é” 2final boolean nonfairTryAcquire(int acquires) { 3 final Thread current = Thread.currentThread(); 4 int c = getState(); 5 if (c == 0) { // é”æœªè¢«å ç”¨ 6 if (compareAndSetState(0, acquires)) { // CAS å°è¯•è·å–é” 7 setExclusiveOwnerThread(current); // è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹ 8 return true; 9 } 10 } else if (current == getExclusiveOwnerThread()) { // â­â­â­é”å·²è¢«å½“å‰çº¿ç¨‹å ç”¨ï¼ˆé‡å…¥ï¼‰ 11 int nextc = c + acquires; // å¢åŠ é‡å…¥æ¬¡æ•° 12 if (nextc \u003c 0) throw new Error(\"Maximum lock count exceeded\"); 13 setState(nextc); // æ›´æ–°çŠ¶æ€ 14 return true; 15 } 16 return false; // è·å–é”å¤±è´¥ 17} åŸºäºAQSå®ç°çš„ä¸€ä¸ªå¯é‡å…¥é”ï¼Œæ”¯æŒå…¬å¹³å’Œéå…¬å¹³ä¸¤ç§æ–¹å¼\nå†…éƒ¨ä¾é ä¸€ä¸ªStateå˜é‡å’Œä¸¤ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼šåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—\nåˆ©ç”¨CASä¿®æ”¹stateæ¥äº‰å¤ºé”\näº‰æŠ¢ä¸åˆ°é”å°±å…¥AQS ç­‰å¾…é˜Ÿåˆ—è¿›è¡Œç­‰å¾…ï¼ŒAQS ç­‰å¾…é˜Ÿåˆ—æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—\næŠ¢åˆ°é”ä½†æ˜¯æ¡ä»¶conditionä¸æ»¡è¶³åˆ™å…¥æ¡ä»¶é˜Ÿåˆ—(æ¯ä¸ªconditionç»´æŠ¤ä¸€ä¸ª)ï¼Œå•å‘é“¾è¡¨\næ˜¯å¦å…¬å¹³é” =\u003e çº¿ç¨‹è·å–é” æ˜¯åŠ å…¥åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨è¿˜æ˜¯ç›´æ¥åˆ©ç”¨CASäº‰å¤ºé”\nReentrantLock æ˜¯åŸºäº AQS å®ç°çš„å¯é‡å…¥ç‹¬å é”ï¼Œæ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ¨¡å¼ã€‚å…¶æ ¸å¿ƒæ˜¯é€šè¿‡ AQS çš„çŠ¶æ€ç®¡ç†ï¼ˆstateï¼‰å’Œç­‰å¾…é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’ã€‚éå…¬å¹³é”çš„æ€§èƒ½é€šå¸¸ä¼˜äºå…¬å¹³é”ï¼Œä½†å…¬å¹³é”å¯ä»¥é¿å…çº¿ç¨‹é¥¥é¥¿é—®é¢˜ã€‚ReentrantLock æä¾›äº†æ¯” synchronized æ›´çµæ´»çš„é”æ“ä½œï¼Œæ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·\n492 Synchronizedå®ç° ä¾èµ–äºJVMçš„ç›‘è§†å™¨é”+å¯¹è±¡å¤´\nå½“synchronizedä¿®é¥°åœ¨æ–¹æ³•æˆ–è€…ä»£ç å—ä¸Šæ—¶ï¼Œä¼šå¯¹ç‰¹å®šçš„å¯¹è±¡æˆ–è€…ç±»åŠ é”ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿è¡ŒåŠ é”çš„ä»£ç å—ï¼›\nsynchronizedä¿®é¥°æ–¹æ³•ï¼šæ–¹æ³•çš„æ ‡å¿—ä½ä¼šå¢åŠ ä¸€ä¸ªACC_SYNCHRONIZEDæ ‡å¿—ï¼Œæ£€æŸ¥æ ‡å¿—å†è·å–é”ï¼Œè¿™éƒ¨åˆ†è¿›è¡ŒåŒæ­¥æ§åˆ¶ synchronizedä¿®é¥°ä»£ç å—ï¼šä¼šåœ¨ä»£ç å—å‰åæ’å…¥monitorenterå’Œmonitorexitå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸Šé”+è§£é” synchronizedæ˜¯å¯é‡å…¥é”\n491 Synchronizedå’ŒReentrantLock 496 å¦‚ä½•ä¼˜åŒ–Javaä¸­é”çš„ä½¿ç”¨ï¼Ÿ å‡å°‘é”çš„ç²’åº¦ï¼š å‡å°‘åŠ é”çš„èŒƒå›´ï¼Œå‡å°‘é”çš„æŒç»­æ—¶é—´ ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é”ï¼šæé«˜å¹¶å‘åº¦ hashTable: é€šè¿‡æ–¹æ³•ä¸Šæ·»åŠ synchronizedå®ç°é”çš„å®‰å…¨ï¼Œä»…ä¸€ä¸ªçº¿ç¨‹ï¼Œæ€§èƒ½è¾ƒå·® concurrentHashMapï¼š é€šè¿‡CAS+synchronizedå®ç°çº¿ç¨‹å®‰å…¨ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™ï¼Œæ€§èƒ½æ›´é«˜ å‡å°‘é”çš„ä½¿ç”¨ é€šè¿‡æ— é”ç¼–ç¨‹ã€CASæ“ä½œå’ŒåŸå­ç±»æ¥é¿å…é”çš„ä½¿ç”¨ï¼Œå‡å°‘é”å¸¦æ¥çš„æ€§èƒ½æŸå¤± é€šè¿‡å‡å°‘å…±äº«èµ„æºçš„ä½¿ç”¨ï¼Œé¿å…å¯¹ä¸´ç•ŒåŒºçš„ç«äº‰ã€‚(æœ¬åœ°å˜é‡+çº¿ç¨‹æœ¬åœ°å˜é‡) æ‰©å±•ï¼š\nç‹¬å é”ï¼šå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é” è¯»å†™é”ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»ï¼Œä½†å†™çš„æ—¶å€™éœ€è¦ä¸Šé”ï¼Œé€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ ä¹è§‚é”å’Œæ‚²è§‚é”ï¼šæ‚²è§‚é”æ¯æ¬¡éƒ½åŠ é”ï¼›ä¹è§‚é”å‡è®¾æ²¡æœ‰å†²çª-CASæˆ–ç‰ˆæœ¬å·å®ç° 499 è¯»å†™é” å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»æ“ä½œï¼Œä½†æ˜¯å†™æ“ä½œéœ€è¦åŠ é”(å•ä¸ªçº¿ç¨‹)ã€‚\n=\u003e è¯»å†™+å†™å†™æ“çºµæ˜¯äº’æ–¥æ“ä½œï¼›â­é€‚åˆè¯»å¤šå†™å°‘çš„æƒ…å†µ\nå¯ä»¥åˆ©ç”¨ReadWriteLockå’ŒReentrantReadWriteLockå®ç°\n1# ä»£ç ç¤ºä¾‹ 2 3ReentrantReadWriteLock lock = new ReentrantReadWriteLock() 4Lock readLock = lock.readLock() 5lock writeLock = lock.writeLock() 6 7// 1. åˆ¤æ–­å†™é”(è¯»å†™äº’æ–¥)2. åˆ¤æ–­è¯»é”,ç¬¬ä¸€ä¸ªå’Œåç»­ 8readLock.lock() 9try{ 10 ... 11} finally { 12 readLock.unlock() 13} 14 15// 1. æœ‰è¯»é”æˆ–å†™é”ä¸”å†™é”ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å¤±è´¥ 16// 2. æ ¹æ®å…¬å¹³æ€§ç­–ç•¥ï¼ˆå…¬å¹³é”æˆ–éå…¬å¹³é”ï¼‰å†³å®šæ˜¯å¦éœ€è¦é˜»å¡ 17// 3. CAS æ›´æ–°çŠ¶æ€ 18// 4. è®¾ç½®å†™é”æŒæœ‰è€… \u003c= è®¾ç½®å¯é‡å…¥ 19writeLock.lock() // äº’æ–¥ å†™å†™äº’æ–¥ 20try{ 21 ... 22} finally { 23 writeLock.unlock() 24} 501 Java JMM javaå†…å­˜æ¨¡å‹ java memory model\nç”¨äºæè¿°çº¿ç¨‹ä½•æ—¶ä»ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®ã€ä½•æ—¶æŠŠæ•°æ®å†™å›ä¸»å­˜ä¸­\nJMMæ ¸å¿ƒç›®æ ‡\nå¯è§æ€§ï¼šç¡®ä¿æŸä¸ªçº¿ç¨‹çš„ä¿®æ”¹ï¼Œå…¶ä»–çº¿ç¨‹åŠæ—¶å¯è§ã€‚ ä½¿ç”¨volatileå…³é”®å­—å¼ºåˆ¶çº¿ç¨‹æ¯æ¬¡è¯»å†™éƒ½ç›´æ¥ä»ä¸»å†…å­˜ä¸­è·å–æ–°å€¼ æœ‰åºæ€§ï¼šæŒ‡çº¿ç¨‹æ‰§è¡Œæ“ä½œçš„é¡ºåºï¼ŒJMMå…è®¸æŸäº›æŒ‡ä»¤é€šè¿‡æŒ‡ä»¤é‡æ‹æé«˜æ€§èƒ½ï¼Œä¸”ä¿è¯çº¿ç¨‹å†…çš„æ“ä½œé¡ºåºä¸ä¼šè¢«ç ´åï¼Œé€šè¿‡happens-beforeå…³ç³»ä¿è¯è·¨çº¿ç¨‹çš„æœ‰åºæ€§ã€‚ **åŸå­æ€§ï¼š**æŒ‡æ“ä½œä¸å¯åˆ†å‰²ï¼Œçº¿ç¨‹ä¸ä¼šåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ã€‚ Why JMMï¼š\næ“ä½œç³»ç»Ÿæœ‰è‡ªå·±çš„å†…å­˜æ¨¡å‹ï¼Œä½†JAVAæ˜¯è·¨å¹³å°å®ç°çš„ï¼Œå› æ­¤éœ€è¦è‡ªå·±è®¾è®¡ä¸€å¥—å†…å­˜æ¨¡å‹å±è”½å„æ“ä½œç³»ç»Ÿä¹‹é—´çš„å·®å¼‚ã€‚JMMæè¿°äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•åœ¨ä¸é€šè¿‡çš„çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡ä»¥åŠå˜é‡çš„æ“ä½œé¡ºåºã€‚\nä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼š\nä¸»å†…å­˜ï¼šJAVAå †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€æœ‰çš„å®ä¾‹å˜é‡ã€é™æ€å˜é‡å’Œæ•°ç»„å…ƒç´ éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼› å·¥ä½œå†…å­˜ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜å­˜å‚¨äº†ä¸»å†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬ï¼Œçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œã€‚ çº¿ç¨‹ä¹‹é—´çš„å˜é‡ï¼Œå¿…é¡»ç»è¿‡ä¸»å†…å­˜è¿›è¡Œä¼ é€’ 506 Why ThreadLocal æ¯ä¸ªçº¿ç¨‹è‡ªå·±ç‹¬äº«çš„ç‹¬ç«‹å˜é‡å‰¯æœ¬ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹é—´çš„å˜é‡å…±äº«å’Œç«äº‰ï¼Œè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚\næ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªThreadLocalMap ç”¨äºå­˜å‚¨çº¿ç¨‹ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼ŒThreadLocalMapä»¥ThreadLocalå®ä¾‹ä¸ºé”®ï¼Œä¸åŒçº¿ç¨‹é€šè¿‡è‡ªå·±ThreadLocalèº«ä»½è·å–å„è‡ªçš„å˜é‡å‰¯æœ¬ã€‚\né¿å…åŒä¸€ä¸ªThreadLocalMapçš„ç«äº‰\n517 Javaä¸­waitã€notifyå’ŒnotifyALL è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯Objectå¯¹è±¡å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä¸”éœ€è¦åœ¨Synchronizedä¿®é¥°å†…ä½¿ç”¨\nwait =\u003e çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é” notify =\u003e å”¤é†’ä¸€ä¸ªåœ¨ç­‰å¾…çš„çº¿ç¨‹ notifyALL =\u003e å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ 518 æ­»é” åŠ é¿å… æ¡ä»¶äº’æ–¥ï¼šç‹¬äº«èµ„æº å æœ‰ä¸”ç­‰å¾…ï¼šä¸æ”¾æ‰‹ï¼Œç­‰åˆ«äººæ”¾å¼ƒ ä¸å¯æŠ¢å ï¼šæ–‡æ˜ å¾ªç¯ç­‰å¾…ï¼š A=\u003eB=\u003eC=\u003eA é¿å…ï¼š\næŒ‰åºç”³è¯· =\u003e é”è·å–çš„é¡ºåºç›¸åŒï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å‰é¢å¡ä½ è¶…æ—¶ç­‰å¾…æ—¶é—´=\u003eé‡Šæ”¾æ‰‹ä¸­èµ„æºå’Œé” 519 volatileå…³é”®å­— ä¸»è¦çš„ä½œç”¨è¿˜æ˜¯ä¿è¯å˜é‡çš„å¯è§æ€§\nå¯è§æ€§ï¼šä¿®æ”¹äº†volatileå˜é‡çš„å€¼ï¼Œè¯¥å€¼ä¼šè¢«ç«‹åˆ»åˆ·æ–°å›ä¸»å†…å­˜ä¸­ï¼ŒåŠæ—¶è®©å…¶ä»–çº¿ç¨‹å¯è§ã€‚ 6304 å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Ÿ ThreadObj.join() ä¼šç­‰å¾…å¯¹åº”å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯• FutureTask+Callable futrue.get() æ‹¿åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæˆçš„ç»“æœ å›è°ƒæœºåˆ¶ï¼šå®Œæˆåï¼Œè°ƒç”¨å›è°ƒå‡½æ•°é€šçŸ¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥äº† 481 Semaphore ä¿¡å·é‡ ËˆsemÉ™fÉ”Ër\nä¸»è¦ä½œç”¨å°±æ˜¯ç¡®ä¿ åªæœ‰æŒ‡å®šæ•°é‡çš„çº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œé™åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡\nåŸºæœ¬æ¦‚å¿µ\nè®¸å¯ permits: å¯ä»¥è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚\nAcquireï¼šå°è¯•è·å–è®¸å¯ï¼›\nreleaseï¼šé‡Šæ”¾è®¸å¯ã€‚\nå…¬å¹³ï¼šæŒ‰ç…§è¯·æ±‚é¡ºåºè·å–è®¸å¯ï¼Œé˜²æ­¢çº¿ç¨‹é¥¥é¥¿\néå…¬å¹³ï¼šå¯ä»¥æé«˜æ€§èƒ½ã€‚\nå¸¸è§ç”¨æ³•ï¼š\n1Semaphore semaphore = new Semaphore(10); // å…è®¸æœ€å¤š10ä¸ªçº¿ç¨‹è®¿é—® 2semaphore.acquire(); // å¤±è´¥ä¼šé˜»å¡ä¸ä¼šå¾€ä¸‹æ‰§è¡Œäº† 3try { 4 // è®¿é—®å…±äº«èµ„æº 5} finally { 6 semaphore.release(); 7} 8 9Semaphore semaphore = new Semaphore(5); // å…è®¸æœ€å¤š5ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ 10for (int i = 0; i \u003c 10; i++) { 11 new Thread(() -\u003e { 12 try { 13 semaphore.acquire(); // é˜»å¡ 14 // æ‰§è¡Œä»»åŠ¡ 15 } catch (InterruptedException e) { 16 Thread.currentThread().interrupt(); 17 } finally { 18 semaphore.release(); 19 } 20 }).start(); 21} 482 CyclicBarrier ËˆsaÉªklÉªk ËˆbÃ¦riÉ™(r) å¾ªç¯éšœç¢ // å¯ä»¥é‡ç”¨ï¼Œå½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœåï¼Œåˆ·æ–°\nå…è®¸ä¸€ç»„çº¿ç¨‹åœ¨æ‰§è¡ŒæŸä¸ªä»»åŠ¡ç›¸äº’ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è¾¾åˆ°äº†Barrierå±éšœåæ‰èƒ½ç»§ç»­æ‰§è¡Œ // ç›´æ¥å…¨å¡ä½\nå±éšœï¼šè°ƒç”¨barrier.await() é˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœï¼› çº¿ç¨‹æ•°é‡ï¼šé¢„æŒ‡å®šçš„ï¼Œå½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœï¼Œæ‰€æœ‰çº¿ç¨‹æ‰è¢«å”¤é†’ï¼› é‡ç”¨æ€§ï¼šå¯ä»¥è¢«é‡ç”¨ã€‚ 1# ç¤ºä¾‹ 2static CyclicBarrier cyclicbarrier; 3cyclicbarrier = new CyclicBarrier(parties=10, () -\u003e Sout(\"å…¨éƒ¨å‡†å¤‡å°±ç»ª\")) 4 5for(i ...) 6 new Thread(() -\u003e { 7 Thread.sleep(i * 3000 ms) 8 sout(i+\"ç©å®¶å‡†å¤‡å®Œæˆ\"); 9 cyclicbarrier.await() // â­ç­‰å¾…å…¨éƒ¨å®Œæˆ 10 sout(i+\"ç©å®¶è¿›å…¥æ¸¸æˆ\") 11 }) 483 CountDownLatch å€’è®¡æ—¶é—¨é—©é” - ä¸å¯å¤ç”¨\nä½œç”¨ï¼šä½¿æŸçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä¸€ç»„æ“ä½œå®Œæˆã€‚æ¯å½“å…¶ä»–çº¿ç¨‹å®Œæˆä¸€ä¸ªæ“ä½œï¼Œè®¡æ•°å™¨â€“ï¼Œåˆ°è¾¾0åˆ™ç­‰å¾…çš„ALLçº¿ç¨‹ä¼šè¢«å”¤é†’\nä¸»è¦åŠŸèƒ½ï¼š\nç­‰å¾…äº‹ä»¶å®Œæˆï¼šawait()ï¼› é€’å‡è®¡æ•°å™¨ï¼šlatch.countdown()ï¼› çº¿ç¨‹åŒæ­¥ï¼šå½“è®¡æ•°å™¨å˜ä¸º0ï¼Œå”¤é†’çº¿ç¨‹ã€‚ 1CountDownLatch latch = new CountDownLatch(3) 2 3for(int i = 1; i \u003c= 3; i++) { // å¼‚æ­¥ 4 new Thread(() -\u003e { 5 Thread,sleep(i*3000) 6 sout(i+\"???\") 7 latch.countDown(); // è¿™é‡Œæ¨¡æ‹Ÿé€’å‡è®¡æ•°å™¨ 8 }).start() 9} 10 11sout(\"wait all thread finish\") 12latch.await() // ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾… 13sout(\"all thread finish\") // å¹¶è¡Œè®¡ç®—ç»“æœçš„æ±‡æ€»\n487 å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ synchronized + awit + notify, A =\u003e B =\u003e C å¤šç»„é” ReentrantLock + condition å¤šç»„ Thread.join, é€æ­¥ç­‰å¾… CountDownLatchï¼Œç­‰å¾…å…¶ä»–çš„çº¿ç¨‹countdown semaphoreï¼Œé™åˆ¶å¼‚æ­¥ä¸ºåŒæ­¥é¡ºåº 488 Javaé˜»å¡é˜Ÿåˆ— ArrayBlockingQueue LinkedBlockingQueue PriorBlockingQueue praÉªÉ™(r) 489 åŸå­ç±» AtomicInterger É™ËˆtÉ’mÉªk ËˆÉªntÉªdÊ’É™(r) AtomicStampedReference stÃ¦mpt 1.get 2.compareAndSet 3.getAndIncrement ËˆÉªÅ‹krÉ™mÉ™nt æé—® CAS Compare and swap\næ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ æ˜¯å¦ä¸ ä¹‹å‰çš„é¢„æœŸå€¼(ä¹‹å‰æ‹¿åˆ°çš„æ—§å€¼) ç›¸ç­‰\nç›¸ç­‰ =\u003e å°†è¯¥å˜é‡çš„å€¼è®¾ç½®ä¸ºæ–°å€¼\n=\u003e åˆ¤æ–­ä»ä¹‹å‰çš„è®¿é—®åˆ°ç°åœ¨çš„ä¿®æ”¹ï¼Œä¸­é—´å˜é‡çš„å€¼æ˜¯å¦å˜åŠ¨è¿‡ï¼Œæ²¡å˜è¿‡=\u003eå¯ä»¥ä¿®æ”¹\nä¼˜åŠ¿ï¼š\næ— é”å¹¶å‘ + CASæ˜¯åŸå­æ€§çš„(çº¿ç¨‹å®‰å…¨)\nç¼ºç‚¹ï¼š\nABAé—®é¢˜ï¼Œå¦‚æœå˜é‡å€¼ ä» A=\u003eB=\u003eA,CASæ— æ³•æ£€æµ‹åˆ°è¿™ç§å˜åŒ– è‡ªæ—‹(é‡å¤)å¼€é”€ï¼šå¯¼è‡´CPUèµ„æºæµªè´¹ï¼Œå› ä¸ºä¸€ç›´æ¯”è¾ƒï¼Œç›´åˆ°èƒ½å¤Ÿä¿®æ”¹ä¸ºæ­¢ å•å˜é‡é™åˆ¶ï¼šä»…æ”¯æŒä¿®æ”¹å•å˜é‡ ABAé—®é¢˜ï¼šå¼•å…¥ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³ï¼Œæ¯æ¬¡æ›´æ–°å˜é‡çš„åŒæ—¶æ›´æ–°ç‰ˆæœ¬å·ï¼Œä»è€Œä¾é ç‰ˆæœ¬å·åˆ¤æ–­å˜é‡æ˜¯å¦è¢«è°ƒæ•´è¿‡ã€‚\nåšæ³•ï¼š\n1private AtomicStampedReference\u003cInteger\u003e atomicStampedReference = new AtomicStampedReference\u003c\u003e(0, 0); // åˆå§‹å€¼:ç‰ˆæœ¬å· == 0:0 2 3public void updateValue(int expected, int newValue) { 4 int[] stampHolder = new int[1]; 5 Integer currentValue = atomicStampedReference.get(stampHolder); 6 int currentStamp = stampHolder[0]; 7\t8 // 9 boolean updated = atomicStampedReference.compareAndSet(expected, newValue, currentStamp, currentStamp + 1); 10 if (updated) { 11 System.out.println(\"Value updated to \" + newValue); 12 } else { 13 System.out.println(\"Update failed\"); 14 } 15} AtomicStampedReferenceï¼š",
  "wordCount" : "1850",
  "inLanguage": "en",
  "datePublished": "2025-03-05T00:00:00Z",
  "dateModified": "2025-03-05T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://121.40.252.207/posts/jobs/juc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://121.40.252.207/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://121.40.252.207/" accesskey="h" title="ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“° (Alt + H)">
                <img src="http://121.40.252.207/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://121.40.252.207/index.html" title="ğŸ¡ Home">
                    <span>ğŸ¡ Home</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/archives/" title="ğŸ“ƒ Archive">
                    <span>ğŸ“ƒ Archive</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/tags/" title="ğŸ“‘ Tags">
                    <span>ğŸ“‘ Tags</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/categories/" title="ğŸ—’ï¸ Categories">
                    <span>ğŸ—’ï¸ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/search/" title="ğŸ” Search">
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://121.40.252.207/about/" title="ğŸ‘¨ğŸ»â€ğŸ“ About Me">
                    <span>ğŸ‘¨ğŸ»â€ğŸ“ About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://121.40.252.207/">Home</a>&nbsp;Â»&nbsp;<a href="http://121.40.252.207/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      å¹¶å‘é¢è¯•é¢˜ç¬”è®°
    </h1>
    <div class="post-meta"><span title='2025-03-05 00:00:00 +0000 UTC'>March 5, 2025</span>&nbsp;Â·&nbsp;9 min&nbsp;Â·&nbsp;1850 words&nbsp;Â·&nbsp;LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e5%a4%9a%e7%ba%bf%e7%a8%8b" aria-label="1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹">1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹</a></li>
                <li>
                    <a href="#2-%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="2 åˆ›å»ºçº¿ç¨‹æ± ">2 åˆ›å»ºçº¿ç¨‹æ± </a></li>
                <li>
                    <a href="#3-%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8%e7%9a%84%e9%9b%86%e5%90%88" aria-label="3 çº¿ç¨‹å®‰å…¨çš„é›†åˆ">3 çº¿ç¨‹å®‰å…¨çš„é›†åˆ</a></li>
                <li>
                    <a href="#4-%e7%ba%bf%e7%a8%8b%e5%90%8c%e6%ad%a5" aria-label="4 çº¿ç¨‹åŒæ­¥">4 çº¿ç¨‹åŒæ­¥</a></li>
                <li>
                    <a href="#5-%e7%ba%bf%e7%a8%8b%e5%ae%89%e5%85%a8" aria-label="5 çº¿ç¨‹å®‰å…¨">5 çº¿ç¨‹å®‰å…¨</a></li>
                <li>
                    <a href="#6-%e7%ba%bf%e7%a8%8b%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="6 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ">6 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ</a></li>
                <li>
                    <a href="#7-%e7%ba%bf%e7%a8%8b%e9%80%9a%e4%bf%a1" aria-label="7 çº¿ç¨‹é€šä¿¡">7 çº¿ç¨‹é€šä¿¡</a></li>
                <li>
                    <a href="#8-%e7%ba%bf%e7%a8%8b%e6%b1%a0" aria-label="8 çº¿ç¨‹æ± ">8 çº¿ç¨‹æ± </a></li>
                <li>
                    <a href="#9-%e5%b9%b6%e5%8f%91%e5%b7%a5%e5%85%b7%e7%b1%bb" aria-label="9 å¹¶å‘å·¥å…·ç±»">9 å¹¶å‘å·¥å…·ç±»</a></li>
                <li>
                    <a href="#497-reentrantlock%e5%ae%9e%e7%8e%b0" aria-label="497 ReentrantLockå®ç°">497 ReentrantLockå®ç°</a></li>
                <li>
                    <a href="#492-synchronized%e5%ae%9e%e7%8e%b0" aria-label="492 Synchronizedå®ç°">492 Synchronizedå®ç°</a></li>
                <li>
                    <a href="#491-synchronized%e5%92%8creentrantlock" aria-label="491 Synchronizedå’ŒReentrantLock">491 Synchronizedå’ŒReentrantLock</a></li>
                <li>
                    <a href="#496-%e5%a6%82%e4%bd%95%e4%bc%98%e5%8c%96java%e4%b8%ad%e9%94%81%e7%9a%84%e4%bd%bf%e7%94%a8" aria-label="496 å¦‚ä½•ä¼˜åŒ–Javaä¸­é”çš„ä½¿ç”¨ï¼Ÿ">496 å¦‚ä½•ä¼˜åŒ–Javaä¸­é”çš„ä½¿ç”¨ï¼Ÿ</a></li>
                <li>
                    <a href="#499-%e8%af%bb%e5%86%99%e9%94%81" aria-label="499 è¯»å†™é”">499 è¯»å†™é”</a></li>
                <li>
                    <a href="#501-java-jmm-java%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8b" aria-label="501 Java JMM javaå†…å­˜æ¨¡å‹">501 Java JMM javaå†…å­˜æ¨¡å‹</a></li>
                <li>
                    <a href="#506-why-threadlocal" aria-label="506 Why ThreadLocal">506 Why ThreadLocal</a></li>
                <li>
                    <a href="#517-java%e4%b8%adwaitnotify%e5%92%8cnotifyall" aria-label="517 Javaä¸­waitã€notifyå’ŒnotifyALL">517 Javaä¸­waitã€notifyå’ŒnotifyALL</a></li>
                <li>
                    <a href="#518-%e6%ad%bb%e9%94%81-%e5%8f%8a-%e9%81%bf%e5%85%8d" aria-label="518 æ­»é” åŠ é¿å…">518 æ­»é” åŠ é¿å…</a></li>
                <li>
                    <a href="#519-volatile%e5%85%b3%e9%94%ae%e5%ad%97" aria-label="519 volatileå…³é”®å­—">519 volatileå…³é”®å­—</a></li>
                <li>
                    <a href="#6304-%e5%a6%82%e4%bd%95%e7%9f%a5%e6%99%93%e5%ad%90%e7%ba%bf%e7%a8%8b%e6%98%af%e5%90%a6%e6%89%a7%e8%a1%8c%e5%ae%8c%e6%af%95" aria-label="6304 å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Ÿ">6304 å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Ÿ</a></li>
                <li>
                    <a href="#481-semaphore-%e4%bf%a1%e5%8f%b7%e9%87%8f" aria-label="481 Semaphore ä¿¡å·é‡">481 Semaphore ä¿¡å·é‡</a></li>
                <li>
                    <a href="#482-cyclicbarrier" aria-label="482 CyclicBarrier">482 CyclicBarrier</a></li>
                <li>
                    <a href="#483-countdownlatch" aria-label="483 CountDownLatch">483 CountDownLatch</a></li>
                <li>
                    <a href="#487-%e5%a6%82%e4%bd%95%e6%8e%a7%e5%88%b6%e5%a4%9a%e4%b8%aa%e7%ba%bf%e7%a8%8b%e7%9a%84%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e5%91%a2" aria-label="487 å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ">487 å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ</a></li>
                <li>
                    <a href="#488-java%e9%98%bb%e5%a1%9e%e9%98%9f%e5%88%97" aria-label="488 Javaé˜»å¡é˜Ÿåˆ—">488 Javaé˜»å¡é˜Ÿåˆ—</a></li>
                <li>
                    <a href="#489-%e5%8e%9f%e5%ad%90%e7%b1%bb" aria-label="489 åŸå­ç±»">489 åŸå­ç±»</a></li>
                <li>
                    <a href="#%e6%8f%90%e9%97%ae" aria-label="æé—®">æé—®</a><ul>
                        
                <li>
                    <a href="#cas" aria-label="CAS">CAS</a></li>
                <li>
                    <a href="#aqs" aria-label="AQS">AQS</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="1-å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹">1 å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#1-å¦‚ä½•åˆ›å»ºå¤šçº¿ç¨‹">#</a></h3>
<p>1ï¼‰ å®ç°<strong>Runnable</strong>æ¥å£</p>
<ul>
<li>å®ç°run()æ–¹æ³•</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">MyRunnable</span><span class="p">()).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>2ï¼‰ç»§æ‰¿Threadç±»</p>
<ul>
<li>é‡å†™run()æ–¹æ³•</li>
</ul>
<p>3ï¼‰Callableæ¥å£&amp;&amp;FutureTask</p>
<ul>
<li>å®ç°Callable call()æ–¹æ³•ï¼Œä½¿ç”¨FutureTaskåŒ…è£…Callableå¯¹è±¡ï¼Œé€šè¿‡Threadå¯åŠ¨</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">FutrueTask</span><span class="o">&lt;</span><span class="n">ReturnType</span><span class="o">&gt;</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutrueTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">MyCallable</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="p">(</span><span class="n">task</span><span class="p">).</span><span class="na">start</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">ResultType</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"> </span><span class="c1">// è¿™é‡Œé˜»å¡</span><span class="w">
</span></span></span></code></pre></div><p>4ï¼‰ä½¿ç”¨çº¿ç¨‹æ± </p>
<ul>
<li>é€šè¿‡ExecutorServiceæäº¤Runnableæˆ–è€…Callableä»»åŠ¡</li>
</ul>
<p>ä¸åŒæ–¹æ³•å¯¹æ¯”</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Runnable</span><span class="w"> </span><span class="n">vs</span><span class="w"> </span><span class="n">Callable</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nl">Callable</span><span class="p">:</span><span class="n">å¯ä»¥è¿”å›ç»“æœ</span><span class="err">ï¼Œ</span><span class="n">å¯ä»¥æŠ›å‡ºå¼‚å¸¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">çº¿ç¨‹æ± çš„ä¼˜åŠ¿</span><span class="err">ï¼š</span><span class="n">é¿å…é‡å¤åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹</span><span class="err">ï¼Œ</span><span class="n">å‡å°‘è¿™éƒ¨åˆ†é‡å¤å¸¦æ¥çš„å¼€é”€</span><span class="err">ï¼›</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="n">ThreadPool</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">FixedThreadPool</span><span class="p">,</span><span class="w"> </span><span class="n">CachedThreadPool</span><span class="p">,</span><span class="w"> </span><span class="n">ScheduledThreadPool</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="n">è™šæ‹Ÿçº¿ç¨‹</span><span class="err">ï¼š</span><span class="n">è™šæ‹Ÿçº¿ç¨‹åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€æ›´ä½</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="p">.</span><span class="na">startVirtualThread</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p><strong>ThreadPoolå®è·µ</strong></p>
<p>XXXThreadPool.submit(task&hellip;)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nl">FixedThreadPool</span><span class="p">:</span><span class="w"> </span><span class="n">å›ºå®šæ± ä¸­çº¿ç¨‹æ•°é‡</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">é€‚åˆ1</span><span class="p">.</span><span class="na">æ‰§è¡Œè¾ƒé•¿ä»»åŠ¡</span><span class="err">ï¼›</span><span class="n">2</span><span class="p">.</span><span class="na">æ§åˆ¶å¹¶å‘åº¦</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">CachedThreadPool</span><span class="err">ï¼š</span><span class="n">æ± ä¸­çº¿ç¨‹æ•°é‡ä¸å›ºå®š</span><span class="err">ï¼Œ</span><span class="n">æ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºçº¿ç¨‹</span><span class="err">ï¼Œ</span><span class="n">ç©ºçš„è¢«å›æ”¶</span><span class="err">ï¼Œ</span><span class="n">å°‘äº†å¤šåˆ›å»º</span><span class="err">ï¼›</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="err">â­</span><span class="n">é€‚ç”¨äºä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”ä»»åŠ¡æ•°é‡ä¸ç¡®å®šçš„åœºæ™¯</span><span class="err">ï¼›</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="n">ScheduledThreadPool</span><span class="err">ï¼š</span><span class="n">é€‚ç”¨äºéœ€è¦å®šæ—¶æ‰§è¡Œæˆ–å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯</span><span class="err">ã€‚</span><span class="w">    
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">ScheduledExecutorService</span><span class="w"> </span><span class="n">scheduledThreadPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newScheduledThreadPool</span><span class="p">(</span><span class="n">5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// For å»¶è¿Ÿä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">scheduledThreadPool</span><span class="p">.</span><span class="na">schedule</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="c1">// ä»»åŠ¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="p">},</span><span class="w"> </span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w"> </span><span class="c1">// å»¶è¿Ÿ10ç§’æ‰§è¡Œ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// Forå‘¨æœŸæ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">scheduledThreadPool</span><span class="p">.</span><span class="na">scheduleAtFixedRate</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="c1">// ä»»åŠ¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">},</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ¯éš”1ç§’æ‰§è¡Œä¸€æ¬¡</span><span class="w">
</span></span></span></code></pre></div><p>Thread.sleep(0) &lt;= ä¸»åŠ¨è®©å‡ºCPUæ§åˆ¶æƒ</p>
<p>thread.join() &lt;= ç­‰å¾…è¯¥çº¿ç¨‹å®Œæˆ</p>
<h3 id="2-åˆ›å»ºçº¿ç¨‹æ± ">2 åˆ›å»ºçº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#2-åˆ›å»ºçº¿ç¨‹æ± ">#</a></h3>
<p>1ï¼‰ Executors<strong>å·¥å‚ç±»</strong></p>
<ul>
<li>Executors.newFixedThreadPool(10) //</li>
</ul>
<p>2ï¼‰ThreadPoolExecutorç›´æ¥åˆ›å»º<strong>çº¿ç¨‹æ± </strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">new</span><span class="w"> </span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">corePoolSize</span><span class="p">,</span><span class="w"> </span><span class="n">maximumPoolSize</span><span class="p">,</span><span class="w"> </span><span class="n">KeepAliveTime</span><span class="p">,</span><span class="n">TimeUnit</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nl">LinkedBlockingQueue</span><span class="p">:</span><span class="w"> </span><span class="n">å½“æäº¤çš„ä»»åŠ¡å¤šäºçº¿ç¨‹æ•°æ—¶</span><span class="err">ï¼Œ</span><span class="n">ä¼šå°†å¤šä½™çš„æš‚æ—¶æŒ‚èµ·</span><span class="w">
</span></span></span></code></pre></div><p><strong>çº¿ç¨‹æ± ç›¸å…³å‚æ•°è§£é‡Š</strong></p>
<ul>
<li>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³çº¿ç¨‹æ± ä¸­å§‹ç»ˆä¿å­˜çš„çº¿ç¨‹æ•°é‡ï¼›</li>
<li>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°é‡ï¼›</li>
<li>KeepAliveTimeï¼šçº¿ç¨‹ç©ºé—²æ—¶é—´ï¼Œéæ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…è¿‡è¿™ä¸ªæ—¶é—´ä¼šè¢«é”€æ¯ï¼›</li>
<li>workQueueï¼šå·¥ä½œé˜Ÿåˆ—ï¼Œå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼›</li>
<li>threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºæ–°çº¿ç¨‹ï¼›</li>
<li>rejectedExecutionHandlerï¼šä»»åŠ¡æ‹’ç»å¤„ç†å™¨ï¼Œå½“å‰ä»»åŠ¡æ— æ³•æ‰§è¡Œæ—¶çš„å¤„ç†ç­–ç•¥ã€‚</li>
</ul>
<p><strong>å·¥ä½œé˜Ÿåˆ—</strong></p>
<ul>
<li>SynchronousQueueï¼šä¸å­˜å‚¨ä»»åŠ¡ï¼Œç›´æ¥æäº¤ä»»åŠ¡ç»™çº¿ç¨‹ï¼›</li>
<li>LinkedBlockingQueueï¼šé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¤§å°æ— é™ï¼›</li>
<li>ArrayBlockingQueueï¼šæ•°æ®ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼›</li>
<li>PriorityBlockingQueueï¼šå¸¦ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚/ praÉªËˆÉ’rÉ™ti /</li>
</ul>
<p><strong>çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥</strong></p>
<p>é˜Ÿåˆ—æ»¡ä¸”æ— ç©ºé—²çº¿ç¨‹çš„æ·»åŠ ä»»åŠ¡çš„æƒ…å†µã€‚</p>
<ul>
<li>AbortPolicyï¼šæŠ›å¼‚å¸¸ï¼›</li>
<li>CallerRunsPolicyï¼šç”±æäº¤çº¿ç¨‹æœ¬èº«æ‰§è¡Œï¼›</li>
<li>DiscardOldestPolicyï¼šåˆ é™¤æœ€æ—©æäº¤çš„ä»»åŠ¡ï¼›</li>
<li>DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒå½“å‰ä»»åŠ¡ã€‚</li>
</ul>
<h3 id="3-çº¿ç¨‹å®‰å…¨çš„é›†åˆ">3 çº¿ç¨‹å®‰å…¨çš„é›†åˆ<a hidden class="anchor" aria-hidden="true" href="#3-çº¿ç¨‹å®‰å…¨çš„é›†åˆ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nl">concurrentHashMap</span><span class="p">:</span><span class="w"> </span><span class="n">åŒæ­¥HashMap</span><span class="o">&lt;</span><span class="n">K</span><span class="o">-&gt;</span><span class="n">V</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">æ•°æ®ç»“æ„</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ä½¿ç”¨æ•°ç»„</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">é“¾è¡¨</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">çº¢é»‘æ ‘çš„ç»“æ„</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">çº¿ç¨‹å®‰å…¨</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CASä¿è¯æ“ä½œçš„åŸå­æ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nl">eg</span><span class="p">:</span><span class="n">çº¿ç¨‹ä¸å®‰å…¨çš„æ“ä½œ</span><span class="err">ï¼š</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// éçº¿ç¨‹å®‰å…¨çš„æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">);</span><span class="w"> </span><span class="c1">// è¿™é‡Œï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å¯¹key-&gt;valueè¿›è¡Œäº†ä¿®æ”¹ï¼ï¼Œè¿™é‡Œçš„valueæ˜¯è¿‡æœŸäº†çš„</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// â­ä¿è¯åŸå­æ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="n">map</span><span class="p">.</span><span class="na">compute</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// ä¸€æ¬¡å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// å¦‚æœæ˜¯æ–¹æ³•ä¸­åˆ›å»ºçš„Map,æ¯ä¸ªçº¿ç¨‹ä¸“äº«ï¼Œä¸ä¼šæœ‰çº¿ç¨‹é—´å®‰å…¨é—®é¢˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// å¦‚æœæ˜¯ç±»ä¸­ï¼Œä¸”å¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€ä¸ªClasså®ä¾‹ï¼Œåˆ™å¯èƒ½å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">Methodä¸­åˆ›å»º</span><span class="err">ï¼š</span><span class="n">å®‰å…¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">Class</span><span class="o">-</span><span class="n">æˆå‘˜å˜é‡</span><span class="err">ï¼š</span><span class="n">å¤šä¸ªçº¿ç¨‹å¯èƒ½å…±äº«åŒä¸€ä¸ªmapå®ä¾‹</span><span class="err">ï¼Œ</span><span class="n">éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">Class</span><span class="o">-</span><span class="n">é™æ€å˜é‡</span><span class="err">ï¼š</span><span class="n">æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ª</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="n">å®ä¾‹</span><span class="w"> </span><span class="err">ï¼Œ</span><span class="n">éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="n">BlockingQueue</span><span class="err">ï¼š</span><span class="w"> </span><span class="o">-</span><span class="n">æ•°ç»„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nl">LinkedBlockingQueue</span><span class="p">:</span><span class="w"> </span><span class="n">çº¿ç¨‹å®‰å…¨çš„é˜»å¡é˜Ÿåˆ—</span><span class="o">-</span><span class="n">é“¾è¡¨å®ç°</span><span class="w">
</span></span></span></code></pre></div><h3 id="4-çº¿ç¨‹åŒæ­¥">4 çº¿ç¨‹åŒæ­¥<a hidden class="anchor" aria-hidden="true" href="#4-çº¿ç¨‹åŒæ­¥">#</a></h3>
<p>å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œé¿å…å…±äº«èµ„æºåŒæ—¶è®¿é—®ï¼Œå¼•å‘æ•°æ®ä¸ä¸€è‡´ã€‚=&gt; åŠ é”ï¼Œé™åˆ¶è®¿é—®ã€‚</p>
<p>JAVAä¸­ï¼Œå¸¸è§çš„åŒæ­¥æ–¹å¼ï¼š</p>
<p><strong>synchronized</strong> åŒæ­¥ // ä»…é™ä¸€ä¸ªçº¿ç¨‹è®¿é—®.  ç”± JVM è´Ÿè´£ç®¡ç†é”çš„è·å–å’Œé‡Šæ”¾. éå…¬å¹³é”</p>
<p>ç”Ÿäº§-æ¶ˆè´¹ æ¨¡æ‹Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Main</span><span class="err">ï¼š</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// å…±äº«é˜Ÿåˆ—ï¼Œç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w"> </span><span class="c1">// or BlockingQueue</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">maxSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">5</span><span class="p">;</span><span class="w"> </span><span class="c1">// é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// åˆ›å»ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">maxSize</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;Producer&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">Thread</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span><span class="w"> </span><span class="s">&#34;Consumer&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// å¯åŠ¨çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">producer</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">consumer</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">    
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nl">Producer</span><span class="p">:</span><span class="w"> </span><span class="n">å®ç°Runnable</span><span class="w"> </span><span class="kd">interface</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="err">@</span><span class="nc">Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// å¯¹é˜Ÿåˆ—åŠ é”</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="c1">// å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">maxSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                    </span><span class="n">queue</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w"> </span><span class="c1">// é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="c1">// ç”Ÿäº§æ•°æ®å¹¶æ·»åŠ åˆ°é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;ç”Ÿäº§è€…ç”Ÿäº§æ•°æ®: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="c1">// é€šçŸ¥æ¶ˆè´¹è€…å¯ä»¥æ¶ˆè´¹äº†</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="c1">// æ¨¡æ‹Ÿç”Ÿäº§è€—æ—¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Consumer</span><span class="err">ï¼š</span><span class="n">å®ç°Runnableæ¥å£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// å¯¹é˜Ÿåˆ—åŠ é”</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="c1">// å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…ç­‰å¾…...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                    </span><span class="n">queue</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w"> </span><span class="c1">// é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                    </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="c1">// æ¶ˆè´¹æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">poll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="c1">// é€šçŸ¥ç”Ÿäº§è€…å¯ä»¥ç”Ÿäº§äº†</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="n">queue</span><span class="p">.</span><span class="na">notifyAll</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="c1">// æ¨¡æ‹Ÿæ¶ˆè´¹è€—æ—¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â­â­â­</p>
<p>synchronizedï¼ˆä¸´ç•ŒåŒºå¯¹è±¡ï¼‰  &lt;=  é”ä½ä¸´ç•ŒåŒº</p>
<p>while(ä¸´ç•ŒåŒºä¸å¯ç”¨) =&gt; é‡è¯• =&gt; .wait() å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€<strong>è®©å‡ºCPU</strong>ï¼Œå¹¶ä¸”<strong>é‡Šæ”¾é”</strong></p>
<p>å¤„ç†å®Œæˆ=&gt; .notifyAll() // é€šçŸ¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹</p>
<p><strong><code>synchronized</code></strong>ï¼šé€šè¿‡ <code>Object.wait()</code> å’Œ <code>Object.notify()/notifyAll()</code> è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡</p>
<hr>
<p><strong>ReentrantLock</strong>  å¯é‡å…¥é”  Re en trant lock.  éœ€è¦æ‰‹åŠ¨åŠ é”å’Œé‡Šæ”¾é”</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="c1">// ä¸´ç•ŒåŒºä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong><code>ReentrantLock</code></strong>ï¼šä½¿ç”¨ <code>Condition</code> å¯¹è±¡æ›´çµæ´»åœ°æ§åˆ¶çº¿ç¨‹ç­‰å¾…å’Œå”¤é†’ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Condition</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">newCondition</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="n">condition</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w">  </span><span class="c1">// çº¿ç¨‹ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">condition</span><span class="p">.</span><span class="na">signal</span><span class="p">();</span><span class="w"> </span><span class="c1">// å”¤é†’å•ä¸ªç­‰å¾…çš„çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="n">condition</span><span class="p">.</span><span class="na">signalAll</span><span class="p">();</span><span class="w"> </span><span class="c1">// å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ¡ˆä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// å…±äº«é˜Ÿåˆ—ï¼Œç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„æ•°æ®ä¼ é€’</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">Queue</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// åˆ›å»º ReentrantLock å’Œ Condition</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">Lock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">Condition</span><span class="w"> </span><span class="n">notFull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">newCondition</span><span class="p">();</span><span class="w"> </span><span class="c1">// é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">Condition</span><span class="w"> </span><span class="n">notEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">newCondition</span><span class="p">();</span><span class="w"> </span><span class="c1">// é˜Ÿåˆ—éç©ºçš„æ¡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nl">Producer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// </span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">maxSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…...&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="n">notFull</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w"> </span><span class="c1">// ç­‰å¾…é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="o">?</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="n">notEmpty</span><span class="p">.</span><span class="na">signalAll</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// ... ç”Ÿäº§è€—æ—¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">finally</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="nl">Consumer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="n">queue</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">sout</span><span class="p">(</span><span class="s">&#34;æ²¡ä¸œè¥¿æ¶ˆè´¹&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="n">notEmpty</span><span class="p">.</span><span class="na">await</span><span class="p">()</span><span class="w">    
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="na">poll</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="n">notFull</span><span class="p">.</span><span class="na">signalAll</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="c1">// ...æ¶ˆè´¹æ—¶é•¿</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">finally</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">		</span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â­â­â­ å…³é”®ç”¨æ³•ï¼š</p>
<p>Lock lock = new ReentrantLock();
Condition notFull = lock.newCondition(); // é˜Ÿåˆ—æœªæ»¡çš„æ¡ä»¶
Condition notEmpty = lock.newCondition(); // é˜Ÿåˆ—éç©ºçš„æ¡ä»¶</p>
<p>lock.lock &amp;&amp; lock.unlock</p>
<p>notFull.await(),  notFull.signal(),  notFull.signalAll()</p>
<hr>
<h3 id="5-çº¿ç¨‹å®‰å…¨">5 çº¿ç¨‹å®‰å…¨<a hidden class="anchor" aria-hidden="true" href="#5-çº¿ç¨‹å®‰å…¨">#</a></h3>
<p>ä¿è¯å¤šçº¿ç¨‹ï¼Œä¹±åºæ‰§è¡Œæ—¶å€™ï¼Œæ— è®ºæ€ä¹ˆæ‰§è¡Œï¼Œéƒ½å¯ä»¥å¾—åˆ°é¢„æœŸç»“æœ</p>
<p>=&gt; <strong>é€šè¿‡ çº¿ç¨‹åŒæ­¥</strong> (æ‚²è§‚é”)</p>
<p>é€šè¿‡Synchronized å’Œ ReentrantLock   ËˆsÉªÅ‹krÉ™naÉªzd &amp;  riËËˆentrÉ™nt, lÉ’k å®ç°çº¿ç¨‹åŒæ­¥</p>
<p>=&gt; <strong>é€šè¿‡åŸå­æ“ä½œç±»</strong></p>
<p>AtomicInteger  É™ËˆtÉ’mÉªk åŸå­ï¼Œ  åŸå­æ•´æ•°</p>
<p>â­â­â­<em><strong>æ‰©å±•CAS</strong></em>ï¼ˆä¹è§‚é”ï¼‰ï¼šï¼ˆ<strong>Compare And Swap</strong>ï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰æ˜¯ä¸€ç§æ— é”å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œå¸¸ç”¨äºå®ç°<strong>åŸå­æ“ä½œ</strong>ã€‚å®ƒçš„åŸºæœ¬åŸç†æ˜¯ï¼š<strong>å…ˆæ¯”è¾ƒï¼Œå†äº¤æ¢</strong>ï¼Œå³<strong>åªæœ‰å½“å˜é‡çš„å½“å‰å€¼ç­‰äºé¢„æœŸå€¼æ—¶ï¼Œæ‰ä¼šæ›´æ–°ï¼Œå¦åˆ™é‡è¯•</strong>ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// å½“å‰å€¼, é¢„æœŸå€¼, æ–°å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="nf">compareAndSwap</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// æ¯”è¾ƒå½“å‰å€¼æ˜¯å¦ç­‰äºé¢„æœŸå€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">        </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w">    </span><span class="c1">// å¦‚æœç›¸ç­‰ï¼Œæ›´æ–°ä¸ºæ–°å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ“ä½œæˆåŠŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// æ“ä½œå¤±è´¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä¾‹å­ï¼šæœ€ä½³å®è·µæ¡ˆä¾‹=&gt; çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// çº¿ç¨‹å®‰å…¨çš„é€’å¢æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">increment</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">oldValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">oldValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w"> </span><span class="c1">// è·å–å½“å‰å€¼, å…ˆè·å–ä¿®æ”¹å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">newValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// è®¡ç®—æ–°å€¼ </span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">newValue</span><span class="p">));</span><span class="w"> </span><span class="c1">// CAS æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// CAS  compare and swap &lt;=&gt; è®¿é—®åˆ°ä¿®æ”¹æœŸé—´ï¼Œæ²¡æœ‰å…¶ä»–çº¿ç¨‹è¿›è¡Œä¿®æ”¹çš„è¯ï¼Œå°±å¯ä»¥æ‰§è¡Œ </span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">value</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="n">oldValue</span><span class="p">,</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">oldvalue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">get</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="err">ï¼š</span><span class="n">nothing</span><span class="w">
</span></span></span></code></pre></div><p><strong>æ£€æŸ¥ç¬¬ä¸€æ¬¡å¾—åˆ°çš„æ—§å€¼ä¸ä¿®æ”¹æ—¶çš„å€¼æ˜¯å¦ä¸€è‡´ï¼Œåˆ¤æ–­æ˜¯å¦è¢«åŠ¨è¿‡ï¼Œæ²¡åŠ¨è¿‡å†æ”¹</strong></p>
<p><img alt="image-20250303211427792" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FivGPltzjm8vcyR15n4BDC2-1Bq9"></p>
<p>=&gt; <strong>çº¿ç¨‹å®‰å…¨çš„å®¹å™¨</strong>ï¼šconcurrentHashMap or copyonWriteArrayListâŒ <strong>ä¸æ‡‚</strong></p>
<p>=&gt; <strong>å±€éƒ¨å˜é‡</strong>ï¼Œçº¿ç¨‹ä¸“äº«</p>
<p>=&gt; <strong>ThreadLocal</strong>, çº¿ç¨‹æœ¬åœ°èµ„æºï¼Œçº¿ç¨‹ä¸“äº«</p>
<h3 id="6-çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ">6 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ<a hidden class="anchor" aria-hidden="true" href="#6-çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ">#</a></h3>
<p>åˆå§‹(èµ„æº) =&gt; å¯è¿è¡Œ(CPUé˜Ÿåˆ—) =&gt; è¿è¡Œ =&gt; ç»ˆæ­¢</p>
<p>â€‹                                     é˜»å¡&amp;ç­‰å¾…</p>
<h3 id="7-çº¿ç¨‹é€šä¿¡">7 çº¿ç¨‹é€šä¿¡<a hidden class="anchor" aria-hidden="true" href="#7-çº¿ç¨‹é€šä¿¡">#</a></h3>
<p>å¤šçº¿ç¨‹é—´çš„ååŒå·¥ä½œ</p>
<p>1ï¼‰**å…±äº«å˜é‡ï¼š**è®¿é—®å…±äº«å†…å­˜å˜é‡æ¥äº¤æ¢ä¿¡æ¯ï¼›</p>
<p>2ï¼‰<strong>åŒæ­¥æœºåˆ¶ï¼š</strong></p>
<p>synchronized() =&gt; wait =&gt; notify&amp;notifyAll  ï¼ˆObjectä¸­çš„æ–¹æ³•ï¼‰</p>
<p>ReentrantLock.lock =&gt; condition.await =&gt; condition.signal&amp;signalAll</p>
<p>BlockingQueue =&gt; queue.put() æ»¡åˆ™é˜»å¡ =&gt; queue.take() ç©ºåˆ™é˜»å¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">conditionNotMet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">       </span><span class="n">lock</span><span class="p">.</span><span class="na">wait</span><span class="p">();</span><span class="w"> </span><span class="c1">// é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">   </span><span class="c1">// æ‰§è¡Œæ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">   </span><span class="n">lock</span><span class="p">.</span><span class="na">notify</span><span class="p">();</span><span class="w"> </span><span class="c1">// å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Lock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantLock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">Condition</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">newCondition</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">conditionNotMet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">       </span><span class="n">condition</span><span class="p">.</span><span class="na">await</span><span class="p">();</span><span class="w"> </span><span class="c1">// ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">   </span><span class="c1">// æ‰§è¡Œæ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">   </span><span class="n">condition</span><span class="p">.</span><span class="na">signal</span><span class="p">();</span><span class="w"> </span><span class="c1">// å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">   </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">BlockingQueue</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedBlockingQueue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// ç”Ÿäº§è€…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">   </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">       </span><span class="n">queue</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;Data&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">       </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// æ¶ˆè´¹è€…</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">   </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">       </span><span class="n">String</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue</span><span class="p">.</span><span class="na">take</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">       </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="p">}).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><h3 id="8-çº¿ç¨‹æ± ">8 çº¿ç¨‹æ± <a hidden class="anchor" aria-hidden="true" href="#8-çº¿ç¨‹æ± ">#</a></h3>
<p>æ± åŒ–æŠ€æœ¯ï¼Œé¢„å…ˆåˆ›å»ºå¹¶ç®¡ç†ä¸€ç»„çº¿ç¨‹ï¼Œé¿å…çº¿ç¨‹é‡å¤åˆ›å»ºå’Œé”€æ¯å¸¦æ¥çš„å¼€é”€</p>
<p>å…³é”®é…ç½®ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°ï¼Œç©ºé—´å­˜æ´»æ—¶é—´ï¼Œå·¥ä½œé˜Ÿåˆ—ï¼Œæ‹’ç»ç­–ç•¥</p>
<p>=&gt; æäº¤ä»»åŠ¡æ‰ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œæˆ–è€…è®¾ç½®preStartAllCoreThreads</p>
<p>=&gt; æ ¸å¿ƒçº¿ç¨‹æ»¡äº†ä¸ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯æŠŠå¤šä½™çš„ä»»åŠ¡æ”¾åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ‰§è¡Œ</p>
<p>=&gt; æ ¸å¿ƒçº¿ç¨‹æ»¡è½½ä¸”å·¥ä½œé˜Ÿåˆ—æ”¾ä¸ä¸‹äº†ï¼Œæ‰ä¼šæ–°å¢çº¿ç¨‹æ‰§è¡Œæäº¤çš„ä»»åŠ¡(&lt;æœ€å¤§çº¿ç¨‹æ•°)</p>
<p>=&gt; å·¥ä½œé˜Ÿåˆ—æ»¡äº†+å·²æœ€å¤§çº¿ç¨‹æ•°äº† =&gt; æ‹’ç»ç­–ç•¥?æ–°ä»»åŠ¡</p>
<p>=&gt; çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡æŒ‡å®šæ—¶é—´ ä¸”æœ‰å¤šä½™çš„éæ ¸å¿ƒçº¿ç¨‹ =&gt; é‡Šæ”¾éæ ¸å¿ƒçº¿ç¨‹</p>
<p>å·¥ä½œé˜Ÿåˆ—ï¼š</p>
<p>LinkedBlockingQueue æ— ç•Œé˜Ÿåˆ—ï¼Œé“¾å¼</p>
<p>ArrayBlockingQueue æœ‰ç•Œé˜Ÿåˆ—ï¼Œæ•°ç»„</p>
<p>PriorityBlockingQueue å¸¦æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</p>
<p>çº¿ç¨‹æ± ç±»å‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nl">FixedThreadPool</span><span class="p">:</span><span class="w"> </span><span class="n">å›ºå®šçº¿ç¨‹æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">CachedThreadPool</span><span class="err">ï¼š</span><span class="n">å˜åŒ–</span><span class="err">ï¼Œ</span><span class="n">åŠ¨æ€æ–°å»º</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">SingleThreadPool</span><span class="err">ï¼š</span><span class="n">å•çº¿ç¨‹çš„æ± å­</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">ScheduledThreadPool</span><span class="err">ï¼š</span><span class="n">å®šæ—¶ä»»åŠ¡çš„æ± å­</span><span class="w">
</span></span></span></code></pre></div><p>shutdownä¸shutdownNowçš„åŒºåˆ«</p>
<p>shutdownï¼šæé†’å…³é—­ï¼Œä¼šæŠŠå·²æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</p>
<p>shutdownNowï¼šå¼ºåˆ¶åœæ­¢</p>
<h3 id="9-å¹¶å‘å·¥å…·ç±»">9 å¹¶å‘å·¥å…·ç±»<a hidden class="anchor" aria-hidden="true" href="#9-å¹¶å‘å·¥å…·ç±»">#</a></h3>
<ul>
<li>
<p>ConcurrentHashMapï¼šçº¿ç¨‹å®‰å…¨çš„HashMapï¼Œå¤šçº¿ç¨‹ä¿®æ”¹ä¸´ç•ŒåŒºæ—¶åŠ é”æˆ–è€…å…¶ä»–æ–¹æ³•ï¼Œ=&gt;å®‰å…¨</p>
</li>
<li>
<p>AtomicIntergerï¼šÉ™ËˆtÉ’mÉªk   çº¿ç¨‹å®‰å…¨çš„æ•´å‹  compareAndSet CASæ–¹æ³•ï¼ŒåŸå­ç±»å‹</p>
</li>
<li>
<p>Semaphore ä¿¡å·é‡ï¼šacquire() and release()</p>
</li>
<li>
<p>BlockingQueueï¼šé˜»å¡é˜Ÿåˆ—-é€šä¿¡å®¹å™¨  queue.put() and queue.take()</p>
</li>
<li>
<p>CyclicBarrierï¼šå¾ªç¯å±éšœ barrier.await</p>
</li>
<li>
<p>CountDownlatchï¼šè®¡æ—¶å™¨ latch.countDown() latch.await()</p>
</li>
</ul>
<h3 id="497-reentrantlockå®ç°">497 ReentrantLockå®ç°<a hidden class="anchor" aria-hidden="true" href="#497-reentrantlockå®ç°">#</a></h3>
<p>=&gt; å¯é‡å…¥é”ï¼Œå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”çš„é”æœºåˆ¶ï¼Œé¿å…çº¿ç¨‹å› ä¸ºé‡å¤è·å–é”è€Œå¯¼è‡´æ­»é”</p>
<p>æ¡ˆä¾‹ï¼š1. é€’å½’è°ƒç”¨ä¸­çš„é”ä¿æŠ¤</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">éå…¬å¹³é”</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">nonfairTryAcquire</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">acquires</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Thread</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// é”æœªè¢«å ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetState</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">acquires</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// CAS å°è¯•è·å–é”</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span><span class="w"> </span><span class="c1">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">getExclusiveOwnerThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// â­â­â­é”å·²è¢«å½“å‰çº¿ç¨‹å ç”¨ï¼ˆé‡å…¥ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nextc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acquires</span><span class="p">;</span><span class="w"> </span><span class="c1">// å¢åŠ é‡å…¥æ¬¡æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nextc</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Error</span><span class="p">(</span><span class="s">&#34;Maximum lock count exceeded&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">setState</span><span class="p">(</span><span class="n">nextc</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ›´æ–°çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// è·å–é”å¤±è´¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>åŸºäºAQSå®ç°çš„ä¸€ä¸ªå¯é‡å…¥é”</strong>ï¼Œæ”¯æŒå…¬å¹³å’Œéå…¬å¹³ä¸¤ç§æ–¹å¼</p>
<p>å†…éƒ¨ä¾é ä¸€ä¸ª<strong>Stateå˜é‡</strong>å’Œä¸¤ä¸ªç­‰å¾…<strong>é˜Ÿåˆ—</strong>ï¼šåŒæ­¥é˜Ÿåˆ—å’Œç­‰å¾…é˜Ÿåˆ—</p>
<p>åˆ©ç”¨CASä¿®æ”¹stateæ¥äº‰å¤ºé”</p>
<ul>
<li>
<p>äº‰æŠ¢ä¸åˆ°é”å°±å…¥<strong>AQS ç­‰å¾…é˜Ÿåˆ—</strong>è¿›è¡Œç­‰å¾…ï¼Œ<strong>AQS ç­‰å¾…é˜Ÿåˆ—</strong>æ˜¯ä¸€ä¸ªåŒå‘é˜Ÿåˆ—</p>
</li>
<li>
<p>æŠ¢åˆ°é”ä½†æ˜¯æ¡ä»¶conditionä¸æ»¡è¶³åˆ™å…¥<strong>æ¡ä»¶é˜Ÿåˆ—(æ¯ä¸ªconditionç»´æŠ¤ä¸€ä¸ª)</strong>ï¼Œå•å‘é“¾è¡¨</p>
</li>
</ul>
<p>æ˜¯å¦å…¬å¹³é” =&gt; çº¿ç¨‹è·å–é” æ˜¯åŠ å…¥åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨è¿˜æ˜¯ç›´æ¥åˆ©ç”¨CASäº‰å¤ºé”</p>
<p><img alt="image-20250305195628416" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FqPim2avU5jlSZ9MgW892NKCux-W"></p>
<p><code>ReentrantLock</code> æ˜¯åŸºäº AQS å®ç°çš„å¯é‡å…¥ç‹¬å é”ï¼Œæ”¯æŒå…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§æ¨¡å¼ã€‚å…¶æ ¸å¿ƒæ˜¯é€šè¿‡ AQS çš„çŠ¶æ€ç®¡ç†ï¼ˆ<code>state</code>ï¼‰å’Œç­‰å¾…é˜Ÿåˆ—æ¥å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’ã€‚éå…¬å¹³é”çš„æ€§èƒ½é€šå¸¸ä¼˜äºå…¬å¹³é”ï¼Œä½†<strong>å…¬å¹³é”å¯ä»¥é¿å…çº¿ç¨‹é¥¥é¥¿</strong>é—®é¢˜ã€‚<code>ReentrantLock</code> æä¾›äº†æ¯” <code>synchronized</code> æ›´çµæ´»çš„é”æ“ä½œï¼Œæ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„é‡è¦å·¥å…·</p>
<h3 id="492-synchronizedå®ç°">492 Synchronizedå®ç°<a hidden class="anchor" aria-hidden="true" href="#492-synchronizedå®ç°">#</a></h3>
<p>ä¾èµ–äºJVMçš„ç›‘è§†å™¨é”+å¯¹è±¡å¤´</p>
<p>å½“synchronizedä¿®é¥°åœ¨æ–¹æ³•æˆ–è€…ä»£ç å—ä¸Šæ—¶ï¼Œä¼šå¯¹ç‰¹å®šçš„å¯¹è±¡æˆ–è€…ç±»åŠ é”ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿è¡ŒåŠ é”çš„ä»£ç å—ï¼›</p>
<ul>
<li>synchronizedä¿®é¥°æ–¹æ³•ï¼šæ–¹æ³•çš„<strong>æ ‡å¿—</strong>ä½ä¼šå¢åŠ ä¸€ä¸ªACC_SYNCHRONIZEDæ ‡å¿—ï¼Œæ£€æŸ¥æ ‡å¿—å†è·å–é”ï¼Œè¿™éƒ¨åˆ†è¿›è¡ŒåŒæ­¥æ§åˆ¶</li>
<li>synchronizedä¿®é¥°ä»£ç å—ï¼šä¼šåœ¨ä»£ç å—å‰åæ’å…¥monitorenterå’Œmonitorexitå­—èŠ‚ç æŒ‡ä»¤ï¼Œä¸Šé”+è§£é”</li>
</ul>
<p>synchronizedæ˜¯å¯é‡å…¥é”</p>
<h3 id="491-synchronizedå’Œreentrantlock">491 Synchronizedå’ŒReentrantLock<a hidden class="anchor" aria-hidden="true" href="#491-synchronizedå’Œreentrantlock">#</a></h3>
<p><img alt="image-20250305205348468" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmLzFQnZFDkECyV1ZTIc2ZEK_yyO"></p>
<h3 id="496-å¦‚ä½•ä¼˜åŒ–javaä¸­é”çš„ä½¿ç”¨">496 å¦‚ä½•ä¼˜åŒ–Javaä¸­é”çš„ä½¿ç”¨ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#496-å¦‚ä½•ä¼˜åŒ–javaä¸­é”çš„ä½¿ç”¨">#</a></h3>
<ol>
<li><strong>å‡å°‘é”çš„ç²’åº¦</strong>ï¼š
<ol>
<li>å‡å°‘åŠ é”çš„èŒƒå›´ï¼Œå‡å°‘é”çš„æŒç»­æ—¶é—´</li>
</ol>
</li>
<li>ä½¿ç”¨<strong>æ›´ç»†ç²’åº¦çš„é”</strong>ï¼šæé«˜å¹¶å‘åº¦
<ul>
<li>hashTable:
<ul>
<li>é€šè¿‡æ–¹æ³•ä¸Šæ·»åŠ synchronizedå®ç°é”çš„å®‰å…¨ï¼Œä»…ä¸€ä¸ªçº¿ç¨‹ï¼Œæ€§èƒ½è¾ƒå·®</li>
</ul>
</li>
<li>concurrentHashMapï¼š
<ul>
<li>é€šè¿‡CAS+synchronizedå®ç°çº¿ç¨‹å®‰å…¨ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™ï¼Œæ€§èƒ½æ›´é«˜</li>
</ul>
</li>
</ul>
</li>
<li>å‡å°‘é”çš„ä½¿ç”¨
<ol>
<li>é€šè¿‡æ— é”ç¼–ç¨‹ã€CASæ“ä½œå’ŒåŸå­ç±»æ¥é¿å…é”çš„ä½¿ç”¨ï¼Œå‡å°‘é”å¸¦æ¥çš„æ€§èƒ½æŸå¤±</li>
<li>é€šè¿‡å‡å°‘å…±äº«èµ„æºçš„ä½¿ç”¨ï¼Œé¿å…å¯¹ä¸´ç•ŒåŒºçš„ç«äº‰ã€‚(æœ¬åœ°å˜é‡+çº¿ç¨‹æœ¬åœ°å˜é‡)</li>
</ol>
</li>
</ol>
<p>æ‰©å±•ï¼š</p>
<ul>
<li>ç‹¬å é”ï¼šå†™æ“ä½œå¤šçš„åœºæ™¯ï¼Œä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”</li>
<li>è¯»å†™é”ï¼šå…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»ï¼Œä½†å†™çš„æ—¶å€™éœ€è¦ä¸Šé”ï¼Œé€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯</li>
<li>ä¹è§‚é”å’Œæ‚²è§‚é”ï¼šæ‚²è§‚é”æ¯æ¬¡éƒ½åŠ é”ï¼›ä¹è§‚é”å‡è®¾æ²¡æœ‰å†²çª-CASæˆ–ç‰ˆæœ¬å·å®ç°</li>
</ul>
<h3 id="499-è¯»å†™é”">499 è¯»å†™é”<a hidden class="anchor" aria-hidden="true" href="#499-è¯»å†™é”">#</a></h3>
<p>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»æ“ä½œï¼Œä½†æ˜¯å†™æ“ä½œéœ€è¦åŠ é”(å•ä¸ªçº¿ç¨‹)ã€‚</p>
<p>=&gt; è¯»å†™+å†™å†™æ“çºµæ˜¯äº’æ–¥æ“ä½œï¼›â­é€‚åˆè¯»å¤šå†™å°‘çš„æƒ…å†µ</p>
<p>å¯ä»¥åˆ©ç”¨ReadWriteLockå’ŒReentrantReadWriteLockå®ç°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">ä»£ç ç¤ºä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">ReentrantReadWriteLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReentrantReadWriteLock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">Lock</span><span class="w"> </span><span class="n">readLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">readLock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">lock</span><span class="w"> </span><span class="n">writeLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">writeLock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 1. åˆ¤æ–­å†™é”(è¯»å†™äº’æ–¥)2. åˆ¤æ–­è¯»é”,ç¬¬ä¸€ä¸ªå’Œåç»­</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">readLock</span><span class="p">.</span><span class="na">lock</span><span class="p">()</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">readLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 1. æœ‰è¯»é”æˆ–å†™é”ä¸”å†™é”ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å¤±è´¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 2. æ ¹æ®å…¬å¹³æ€§ç­–ç•¥ï¼ˆå…¬å¹³é”æˆ–éå…¬å¹³é”ï¼‰å†³å®šæ˜¯å¦éœ€è¦é˜»å¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 3. CAS æ›´æ–°çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// 4. è®¾ç½®å†™é”æŒæœ‰è€… &lt;= è®¾ç½®å¯é‡å…¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">writeLock</span><span class="p">.</span><span class="na">lock</span><span class="p">()</span><span class="w"> </span><span class="c1">// äº’æ–¥ å†™å†™äº’æ–¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="n">writeLock</span><span class="p">.</span><span class="na">unlock</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="501-java-jmm-javaå†…å­˜æ¨¡å‹">501 Java JMM javaå†…å­˜æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#501-java-jmm-javaå†…å­˜æ¨¡å‹">#</a></h3>
<p>java memory model</p>
<p>ç”¨äºæè¿°çº¿ç¨‹ä½•æ—¶ä»ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®ã€ä½•æ—¶æŠŠæ•°æ®å†™å›ä¸»å­˜ä¸­</p>
<p>JMMæ ¸å¿ƒç›®æ ‡</p>
<ul>
<li><strong>å¯è§æ€§</strong>ï¼šç¡®ä¿æŸä¸ªçº¿ç¨‹çš„ä¿®æ”¹ï¼Œå…¶ä»–çº¿ç¨‹åŠæ—¶å¯è§ã€‚ ä½¿ç”¨volatileå…³é”®å­—å¼ºåˆ¶çº¿ç¨‹æ¯æ¬¡è¯»å†™éƒ½ç›´æ¥ä»ä¸»å†…å­˜ä¸­è·å–æ–°å€¼</li>
<li><strong>æœ‰åºæ€§</strong>ï¼šæŒ‡çº¿ç¨‹æ‰§è¡Œæ“ä½œçš„é¡ºåºï¼ŒJMMå…è®¸æŸäº›æŒ‡ä»¤é€šè¿‡æŒ‡ä»¤é‡æ‹æé«˜æ€§èƒ½ï¼Œä¸”ä¿è¯çº¿ç¨‹å†…çš„æ“ä½œé¡ºåºä¸ä¼šè¢«ç ´åï¼Œé€šè¿‡<code>happens-before</code>å…³ç³»ä¿è¯è·¨çº¿ç¨‹çš„æœ‰åºæ€§ã€‚</li>
<li>**åŸå­æ€§ï¼š**æŒ‡æ“ä½œä¸å¯åˆ†å‰²ï¼Œçº¿ç¨‹ä¸ä¼šåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«ä¸­æ–­ã€‚</li>
</ul>
<p>Why JMMï¼š</p>
<p>æ“ä½œç³»ç»Ÿæœ‰è‡ªå·±çš„å†…å­˜æ¨¡å‹ï¼Œä½†JAVAæ˜¯è·¨å¹³å°å®ç°çš„ï¼Œå› æ­¤éœ€è¦è‡ªå·±è®¾è®¡ä¸€å¥—å†…å­˜æ¨¡å‹å±è”½å„æ“ä½œç³»ç»Ÿä¹‹é—´çš„å·®å¼‚ã€‚JMMæè¿°äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•åœ¨ä¸é€šè¿‡çš„çº¿ç¨‹ä¹‹é—´å…±äº«å˜é‡ä»¥åŠå˜é‡çš„æ“ä½œé¡ºåºã€‚</p>
<p>ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼š</p>
<ul>
<li>ä¸»å†…å­˜ï¼šJAVAå †å†…å­˜çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€æœ‰çš„å®ä¾‹å˜é‡ã€é™æ€å˜é‡å’Œæ•°ç»„å…ƒç´ éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼›</li>
<li>å·¥ä½œå†…å­˜ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜å­˜å‚¨äº†ä¸»å†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬ï¼Œçº¿ç¨‹çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œã€‚</li>
<li>çº¿ç¨‹ä¹‹é—´çš„å˜é‡ï¼Œå¿…é¡»ç»è¿‡ä¸»å†…å­˜è¿›è¡Œä¼ é€’</li>
</ul>
<h3 id="506-why-threadlocal">506 Why ThreadLocal<a hidden class="anchor" aria-hidden="true" href="#506-why-threadlocal">#</a></h3>
<p>æ¯ä¸ªçº¿ç¨‹è‡ªå·±<strong>ç‹¬äº«çš„ç‹¬ç«‹å˜é‡å‰¯æœ¬</strong>ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹é—´çš„å˜é‡å…±äº«å’Œç«äº‰ï¼Œè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p><strong>æ¯ä¸ª</strong>çº¿ç¨‹ç»´æŠ¤ä¸€ä¸ª<code>ThreadLocalMap</code> ç”¨äºå­˜å‚¨çº¿ç¨‹ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼ŒThreadLocalMapä»¥ThreadLocalå®ä¾‹ä¸ºé”®ï¼Œä¸åŒçº¿ç¨‹é€šè¿‡è‡ªå·±ThreadLocalèº«ä»½è·å–å„è‡ªçš„å˜é‡å‰¯æœ¬ã€‚</p>
<p>é¿å…åŒä¸€ä¸ªThreadLocalMapçš„ç«äº‰</p>
<h3 id="517-javaä¸­waitnotifyå’Œnotifyall">517 Javaä¸­waitã€notifyå’ŒnotifyALL<a hidden class="anchor" aria-hidden="true" href="#517-javaä¸­waitnotifyå’Œnotifyall">#</a></h3>
<p>è¿™ä¸‰ä¸ªæ–¹æ³•éƒ½æ˜¯Objectå¯¹è±¡å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œä¸”éœ€è¦åœ¨Synchronizedä¿®é¥°å†…ä½¿ç”¨</p>
<ul>
<li>wait =&gt; çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”</li>
<li>notify =&gt; å”¤é†’ä¸€ä¸ªåœ¨ç­‰å¾…çš„çº¿ç¨‹</li>
<li>notifyALL =&gt; å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</li>
</ul>
<h3 id="518-æ­»é”-åŠ-é¿å…">518 æ­»é” åŠ é¿å…<a hidden class="anchor" aria-hidden="true" href="#518-æ­»é”-åŠ-é¿å…">#</a></h3>
<ul>
<li>æ¡ä»¶äº’æ–¥ï¼šç‹¬äº«èµ„æº</li>
<li>å æœ‰ä¸”ç­‰å¾…ï¼šä¸æ”¾æ‰‹ï¼Œç­‰åˆ«äººæ”¾å¼ƒ</li>
<li>ä¸å¯æŠ¢å ï¼šæ–‡æ˜</li>
<li>å¾ªç¯ç­‰å¾…ï¼š A=&gt;B=&gt;C=&gt;A</li>
</ul>
<p>é¿å…ï¼š</p>
<ul>
<li>æŒ‰åºç”³è¯· =&gt; é”è·å–çš„é¡ºåºç›¸åŒï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å‰é¢å¡ä½</li>
<li>è¶…æ—¶ç­‰å¾…æ—¶é—´=&gt;é‡Šæ”¾æ‰‹ä¸­èµ„æºå’Œé”</li>
</ul>
<h3 id="519-volatileå…³é”®å­—">519 volatileå…³é”®å­—<a hidden class="anchor" aria-hidden="true" href="#519-volatileå…³é”®å­—">#</a></h3>
<p>ä¸»è¦çš„ä½œç”¨è¿˜æ˜¯ä¿è¯å˜é‡çš„å¯è§æ€§</p>
<ul>
<li>å¯è§æ€§ï¼šä¿®æ”¹äº†volatileå˜é‡çš„å€¼ï¼Œè¯¥å€¼ä¼šè¢«ç«‹åˆ»åˆ·æ–°å›ä¸»å†…å­˜ä¸­ï¼ŒåŠæ—¶è®©å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li>
</ul>
<h3 id="6304-å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•">6304 å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#6304-å¦‚ä½•çŸ¥æ™“å­çº¿ç¨‹æ˜¯å¦æ‰§è¡Œå®Œæ¯•">#</a></h3>
<ul>
<li>ThreadObj.join() ä¼šç­‰å¾…å¯¹åº”å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</li>
<li>FutureTask+Callable   futrue.get() æ‹¿åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæˆçš„ç»“æœ</li>
<li>å›è°ƒæœºåˆ¶ï¼šå®Œæˆåï¼Œè°ƒç”¨å›è°ƒå‡½æ•°é€šçŸ¥ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥äº†</li>
</ul>
<h3 id="481-semaphore-ä¿¡å·é‡">481 Semaphore ä¿¡å·é‡<a hidden class="anchor" aria-hidden="true" href="#481-semaphore-ä¿¡å·é‡">#</a></h3>
<p>ËˆsemÉ™fÉ”Ër</p>
<p>ä¸»è¦ä½œç”¨å°±æ˜¯ç¡®ä¿ åªæœ‰æŒ‡å®šæ•°é‡çš„çº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œ<strong>é™åˆ¶åŒæ—¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°é‡</strong></p>
<p><em>åŸºæœ¬æ¦‚å¿µ</em></p>
<ul>
<li>
<p>è®¸å¯ permits: å¯ä»¥è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚</p>
</li>
<li>
<p>Acquireï¼šå°è¯•è·å–è®¸å¯ï¼›</p>
</li>
<li>
<p>releaseï¼šé‡Šæ”¾è®¸å¯ã€‚</p>
</li>
<li>
<p>å…¬å¹³ï¼šæŒ‰ç…§è¯·æ±‚é¡ºåºè·å–è®¸å¯ï¼Œé˜²æ­¢çº¿ç¨‹é¥¥é¥¿</p>
</li>
<li>
<p>éå…¬å¹³ï¼šå¯ä»¥æé«˜æ€§èƒ½ã€‚</p>
</li>
</ul>
<p>å¸¸è§ç”¨æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">Semaphore</span><span class="w"> </span><span class="n">semaphore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Semaphore</span><span class="p">(</span><span class="n">10</span><span class="p">);</span><span class="w">  </span><span class="c1">// å…è®¸æœ€å¤š10ä¸ªçº¿ç¨‹è®¿é—®</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">semaphore</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span><span class="w"> </span><span class="c1">// å¤±è´¥ä¼šé˜»å¡ä¸ä¼šå¾€ä¸‹æ‰§è¡Œäº†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c1">// è®¿é—®å…±äº«èµ„æº</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">semaphore</span><span class="p">.</span><span class="na">release</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">Semaphore</span><span class="w"> </span><span class="n">semaphore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Semaphore</span><span class="p">(</span><span class="n">5</span><span class="p">);</span><span class="w">  </span><span class="c1">// å…è®¸æœ€å¤š5ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">            </span><span class="n">semaphore</span><span class="p">.</span><span class="na">acquire</span><span class="p">();</span><span class="w"> </span><span class="c1">// é˜»å¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="c1">// æ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">semaphore</span><span class="p">.</span><span class="na">release</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="482-cyclicbarrier">482 CyclicBarrier<a hidden class="anchor" aria-hidden="true" href="#482-cyclicbarrier">#</a></h3>
<p>ËˆsaÉªklÉªk ËˆbÃ¦riÉ™(r) å¾ªç¯éšœç¢ // <strong>å¯ä»¥é‡ç”¨</strong>ï¼Œå½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœåï¼Œåˆ·æ–°</p>
<p>å…è®¸ä¸€ç»„çº¿ç¨‹åœ¨æ‰§è¡ŒæŸä¸ªä»»åŠ¡ç›¸äº’ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½è¾¾åˆ°äº†Barrierå±éšœåæ‰èƒ½ç»§ç»­æ‰§è¡Œ // ç›´æ¥å…¨å¡ä½</p>
<ul>
<li>å±éšœï¼šè°ƒç”¨barrier.await() é˜»å¡ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾å±éšœï¼›</li>
<li>çº¿ç¨‹æ•°é‡ï¼šé¢„æŒ‡å®šçš„ï¼Œå½“æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å±éšœï¼Œæ‰€æœ‰çº¿ç¨‹æ‰è¢«å”¤é†’ï¼›</li>
<li>é‡ç”¨æ€§ï¼šå¯ä»¥è¢«é‡ç”¨ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">ç¤ºä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">static</span><span class="w"> </span><span class="n">CyclicBarrier</span><span class="w"> </span><span class="n">cyclicbarrier</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">cyclicbarrier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CyclicBarrier</span><span class="p">(</span><span class="n">parties</span><span class="o">=</span><span class="n">10</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Sout</span><span class="p">(</span><span class="s">&#34;å…¨éƒ¨å‡†å¤‡å°±ç»ª&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="p">...)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">3000</span><span class="w"> </span><span class="n">ms</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">sout</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="s">&#34;ç©å®¶å‡†å¤‡å®Œæˆ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">cyclicbarrier</span><span class="p">.</span><span class="na">await</span><span class="p">()</span><span class="w"> </span><span class="c1">// â­ç­‰å¾…å…¨éƒ¨å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">sout</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="s">&#34;ç©å®¶è¿›å…¥æ¸¸æˆ&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">})</span><span class="w">  
</span></span></span></code></pre></div><h3 id="483-countdownlatch">483 CountDownLatch<a hidden class="anchor" aria-hidden="true" href="#483-countdownlatch">#</a></h3>
<p>å€’è®¡æ—¶é—¨é—©é”  - ä¸å¯å¤ç”¨</p>
<p>ä½œç”¨ï¼š<strong>ä½¿æŸçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä¸€ç»„æ“ä½œå®Œæˆ</strong>ã€‚æ¯å½“å…¶ä»–çº¿ç¨‹å®Œæˆä¸€ä¸ªæ“ä½œï¼Œè®¡æ•°å™¨&ndash;ï¼Œåˆ°è¾¾0åˆ™ç­‰å¾…çš„ALLçº¿ç¨‹ä¼šè¢«å”¤é†’</p>
<p>ä¸»è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>ç­‰å¾…äº‹ä»¶å®Œæˆï¼šawait()ï¼›</li>
<li>é€’å‡è®¡æ•°å™¨ï¼šlatch.countdown()ï¼›</li>
<li>çº¿ç¨‹åŒæ­¥ï¼šå½“è®¡æ•°å™¨å˜ä¸º0ï¼Œå”¤é†’çº¿ç¨‹ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">CountDownLatch</span><span class="w"> </span><span class="n">latch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CountDownLatch</span><span class="p">(</span><span class="n">3</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// å¼‚æ­¥</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">,</span><span class="n">sleep</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">3000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">sout</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="s">&#34;???&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">latch</span><span class="p">.</span><span class="na">countDown</span><span class="p">();</span><span class="w"> </span><span class="c1">// è¿™é‡Œæ¨¡æ‹Ÿé€’å‡è®¡æ•°å™¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}).</span><span class="na">start</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">    
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="n">sout</span><span class="p">(</span><span class="s">&#34;wait all thread finish&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">latch</span><span class="p">.</span><span class="na">await</span><span class="p">()</span><span class="w"> </span><span class="c1">// ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">sout</span><span class="p">(</span><span class="s">&#34;all thread finish&#34;</span><span class="p">)</span><span class="w">    
</span></span></span></code></pre></div><p>// å¹¶è¡Œè®¡ç®—ç»“æœçš„æ±‡æ€»</p>
<h3 id="487-å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢">487 å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#487-å¦‚ä½•æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œé¡ºåºå‘¢">#</a></h3>
<ul>
<li>synchronized + awit + notify, A =&gt; B =&gt; C å¤šç»„é”</li>
<li>ReentrantLock + condition å¤šç»„</li>
<li>Thread.join, é€æ­¥ç­‰å¾…</li>
<li>CountDownLatchï¼Œç­‰å¾…å…¶ä»–çš„çº¿ç¨‹countdown</li>
<li>semaphoreï¼Œé™åˆ¶å¼‚æ­¥ä¸ºåŒæ­¥é¡ºåº</li>
</ul>
<h3 id="488-javaé˜»å¡é˜Ÿåˆ—">488 Javaé˜»å¡é˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#488-javaé˜»å¡é˜Ÿåˆ—">#</a></h3>
<ul>
<li>ArrayBlockingQueue</li>
<li>LinkedBlockingQueue</li>
<li>PriorBlockingQueue praÉªÉ™(r)</li>
</ul>
<h3 id="489-åŸå­ç±»">489 åŸå­ç±»<a hidden class="anchor" aria-hidden="true" href="#489-åŸå­ç±»">#</a></h3>
<ul>
<li>AtomicInterger                           É™ËˆtÉ’mÉªk ËˆÉªntÉªdÊ’É™(r)</li>
<li>AtomicStampedReference            stÃ¦mpt</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="p">.</span><span class="na">get</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">compareAndSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="p">.</span><span class="na">getAndIncrement</span><span class="w">    </span><span class="n">ËˆÉªÅ‹krÉ™mÉ™nt</span><span class="w">
</span></span></span></code></pre></div><h3 id="æé—®">æé—®<a hidden class="anchor" aria-hidden="true" href="#æé—®">#</a></h3>
<h4 id="cas">CAS<a hidden class="anchor" aria-hidden="true" href="#cas">#</a></h4>
<p>Compare and swap</p>
<p>æ¯”è¾ƒå†…å­˜ä¸­çš„å€¼ æ˜¯å¦ä¸ ä¹‹å‰çš„é¢„æœŸå€¼(ä¹‹å‰æ‹¿åˆ°çš„æ—§å€¼) ç›¸ç­‰</p>
<p>ç›¸ç­‰ =&gt; å°†è¯¥å˜é‡çš„å€¼è®¾ç½®ä¸ºæ–°å€¼</p>
<p>=&gt; åˆ¤æ–­ä»ä¹‹å‰çš„è®¿é—®åˆ°ç°åœ¨çš„ä¿®æ”¹ï¼Œä¸­é—´å˜é‡çš„å€¼æ˜¯å¦å˜åŠ¨è¿‡ï¼Œæ²¡å˜è¿‡=&gt;å¯ä»¥ä¿®æ”¹</p>
<p>ä¼˜åŠ¿ï¼š</p>
<p><strong>æ— é”å¹¶å‘</strong> + CASæ˜¯åŸå­æ€§çš„(çº¿ç¨‹å®‰å…¨)</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ABAé—®é¢˜ï¼Œå¦‚æœå˜é‡å€¼ ä» A=&gt;B=&gt;A,CASæ— æ³•æ£€æµ‹åˆ°è¿™ç§å˜åŒ–</li>
<li><strong>è‡ªæ—‹(é‡å¤)å¼€é”€</strong>ï¼šå¯¼è‡´CPUèµ„æºæµªè´¹ï¼Œå› ä¸ºä¸€ç›´æ¯”è¾ƒï¼Œç›´åˆ°èƒ½å¤Ÿä¿®æ”¹ä¸ºæ­¢</li>
<li>å•å˜é‡é™åˆ¶ï¼šä»…æ”¯æŒä¿®æ”¹å•å˜é‡</li>
</ul>
<p>ABAé—®é¢˜ï¼šå¼•å…¥ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³ï¼Œæ¯æ¬¡æ›´æ–°å˜é‡çš„åŒæ—¶æ›´æ–°ç‰ˆæœ¬å·ï¼Œä»è€Œä¾é ç‰ˆæœ¬å·åˆ¤æ–­å˜é‡æ˜¯å¦è¢«è°ƒæ•´è¿‡ã€‚</p>
<p>åšæ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">AtomicStampedReference</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">atomicStampedReference</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicStampedReference</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// åˆå§‹å€¼:ç‰ˆæœ¬å· == 0:0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateValue</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">stampHolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">currentValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicStampedReference</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">stampHolder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">currentStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampHolder</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicStampedReference</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">newValue</span><span class="p">,</span><span class="w"> </span><span class="n">currentStamp</span><span class="p">,</span><span class="w"> </span><span class="n">currentStamp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Value updated to &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">newValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Update failed&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>AtomicStampedReferenceï¼š&lt;ObjRef =&gt; stampedref&gt;</p>
<p><strong>å°è¯•æ›´æ–°å€¼å’Œç‰ˆæœ¬å·</strong></p>
<p>boolean updated = atomicStampedReference.compareAndSet(expected, newValue, currentStamp, currentStamp + 1);</p>
<p>æœŸæœ›çš„å½“å‰å€¼ï¼Œæ›´æ–°å€¼ï¼ŒæœŸæœ›çš„ç‰ˆæœ¬å·ï¼Œæ›´æ–°çš„ç‰ˆæœ¬å·; <strong>å½“æœŸæœ›çš„ä¸¤ä¸ªå€¼ç›¸åŒæ‰æ›´æ–°</strong></p>
<p>è¾…åŠ©ç†è§£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">newValue</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ready</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// è·å–å½“å‰å¼•ç”¨å€¼å’Œç‰ˆæœ¬å·</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="kt">int</span><span class="o">[]</span><span class="w"> </span><span class="n">stampHolder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// å› ä¸ºJavaåªèƒ½è¿”å›ä¸€ä¸ªè¿”å›å€¼ï¼Œå°†å¤šä¸ªç»“æœä¿®æ”¹æ•°ç»„çš„å½¢å¼é—´æ¥è¿”å›</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">currentValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomicStampedRef</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">stampHolder</span><span class="p">);</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">currentStamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stampHolder</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="c1">// â­â­â­</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="s">&#34;å½“å‰å€¼: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">currentValue</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nl">ç‰ˆæœ¬å·</span><span class="p">:</span><span class="w"> </span><span class="s">&#34; + currentStamp 
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s">    
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s">atomicStampedReference.compareAndSet(expected, newValue, currentStamp, currentStamp + 1);
</span></span></span></code></pre></div><p>åœ¨CASåŸºç¡€ä¸Šï¼Œå¤šåˆ¤æ–­ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ£€æŸ¥å˜é‡æ˜¯å¦ä¿®æ”¹è¿‡ï¼Œè§£å†³ABAé—®é¢˜</p>
<p>// ##</p>
<p>è‡ªæ—‹é” =&gt; è·å–é”å¤±è´¥ï¼Œä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯é‡å¤å°è¯•è·å–é” â—éå…¬å¹³:é¥¥é¥¿ï¼›æ€§èƒ½é—®é¢˜:å¯¹åŒä¸€å˜é‡é«˜å¹¶å‘è¿›è¡ŒCAS</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SpinLock</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="c1">// è‡ªæ—‹ç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">lock</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é’ˆå¯¹è‡ªæ—‹é”=&gt;CLH</p>
<h4 id="aqs">AQS<a hidden class="anchor" aria-hidden="true" href="#aqs">#</a></h4>
<p><strong>Abstract Queued Synchronizer</strong> æ˜¯åŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ï¼Œ èµ·åˆ°æŠ½è±¡ã€å°è£…çš„ä½œç”¨ï¼Œå°†ä¸€äº›æ’é˜Ÿã€å…¥é˜Ÿã€åŠ é”ã€ä¸­æ–­æ–¹æ³•æä¾›å‡ºæ¥ï¼Œå…·ä½“åŠ é”æ—¶æœºã€å…¥é˜Ÿæ—¶æœºç­‰éœ€è¦å®ç°ç±»è‡ªå·±æ§åˆ¶ã€‚</p>
<ul>
<li><strong>(volatileç”³æ˜)stateçŠ¶æ€</strong>ï¼Œå¯ä»¥é€šè¿‡CASæ— é”å¹¶å‘æ–¹å¼ç«äº‰é”</li>
</ul>
<p>AQSæ”¯æŒ</p>
<ol>
<li>ç‹¬å æ¨¡å¼ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œï¼Œäº’æ–¥é”ï¼›</li>
<li>å…±äº«æ¨¡å¼ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œä¾‹å¦‚ä¿¡å·é‡ï¼›</li>
</ol>
<p>å½“ä¸€ä¸ªçº¿ç¨‹è·å–é”å¤±è´¥æ—¶ï¼ŒAQSå°†å…¶æ’å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°åŒæ­¥çŠ¶æ€å¯ç”¨ã€‚</p>
<p>ä½¿ç”¨AQSå®ç°ä¸€ä¸ªç‹¬å é”</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SimpleLock</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Sync</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractQueuedSynchronizer</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">tryAcquire</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">acquires</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">compareAndSetState</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">                </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">tryRelease</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">releases</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalMonitorStateException</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">setExclusiveOwnerThread</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">setState</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isHeldExclusively</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">getState</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">ConditionObject</span><span class="w"> </span><span class="nf">newCondition</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConditionObject</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Sync</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sync</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">lock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">sync</span><span class="p">.</span><span class="na">acquire</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">unlock</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="n">sync</span><span class="p">.</span><span class="na">release</span><span class="p">(</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isLocked</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sync</span><span class="p">.</span><span class="na">isHeldExclusively</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Condition</span><span class="w"> </span><span class="nf">newCondition</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sync</span><span class="p">.</span><span class="na">newCondition</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">åŸºäºAQSçš„ç‹¬å é”</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nl">tryAcquire</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CAS</span><span class="p">(</span><span class="n">åŸå­</span><span class="err">ï¼Œ</span><span class="n">æ¯”è¾ƒä¸”è®¾ç½®</span><span class="p">)</span><span class="n">æ£€æŸ¥æ˜¯å¦é”å¯ä»¥ä½¿ç”¨</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">å¯ä»¥åˆ™è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å æ¨¡å¼</span><span class="w"> </span><span class="kc">true</span><span class="o">=&gt;</span><span class="k">else</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nl">tryRelease</span><span class="p">:</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">getState</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">å¦‚æœä¸ä¸º1åˆ™å¼‚å¸¸</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">å…³é—­ç‹¬å æ¨¡å¼å¹¶é‡Šæ”¾é”</span><span class="p">(</span><span class="n">stateè®¾ç½®ä¸º0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Sync</span><span class="w"> </span><span class="n">sync</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Sync</span><span class="p">()</span><span class="w"> </span><span class="c1">// ä½œä¸ºé”å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="nl">lock</span><span class="p">:</span><span class="w"> </span><span class="n">sync</span><span class="p">.</span><span class="na">acquire</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="nl">unlock</span><span class="p">:</span><span class="w"> </span><span class="n">sync</span><span class="p">.</span><span class="na">release</span><span class="p">(</span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>AQSå’ŒCASä¸¤è€…å¯ä»¥ç»å¸¸ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚åœ¨ReentrantLockä¸­ï¼ŒCASç”¨äºå®ç°é”çš„è·å–å’Œé‡Šæ”¾æ“ä½œï¼Œè€ŒAQSåˆ™ç®¡ç†é”çš„çŠ¶æ€å’Œç­‰å¾…é˜Ÿåˆ—ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://121.40.252.207/tags/juc/">JUC</a></li>
    </ul>
  </footer> <div id="tw-comment"></div>
 <script>
     
     const getStoredTheme = () => localStorage.getItem("pref-theme") === "light" ? "light" : "dark";
     const setGiscusTheme = () => {
         const sendMessage = (message) => {
             const iframe = document.querySelector('iframe.giscus-frame');
             if (iframe) {
                 iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');
            }
        }
        sendMessage({setConfig: {theme: getStoredTheme()}})
    }

    document.addEventListener("DOMContentLoaded", () => {
        const giscusAttributes = {
            "src": "https://giscus.app/client.js",
            "data-repo": "hhhey-lw\/LongWeiBlog",
            "data-repo-id": "R_kgDOOMaMvQ",
            "data-category": "Announcements",
            "data-category-id": "DIC_kwDOOMaMvc4CoUI4",
            "data-mapping": "pathname",
            "data-strict": "0",
            "data-reactions-enabled": "1",
            "data-emit-metadata": "0",
            "data-input-position": "bottom",
            "data-theme": getStoredTheme(),
            "data-lang": "en",
            "data-loading": "lazy",
            "crossorigin": "anonymous",
        };

        
        const giscusScript = document.createElement("script");
        Object.entries(giscusAttributes).forEach(
                ([key, value]) => giscusScript.setAttribute(key, value));
        document.querySelector("#tw-comment").appendChild(giscusScript);

        
        const themeSwitcher = document.querySelector("#theme-toggle");
        if (themeSwitcher) {
            themeSwitcher.addEventListener("click", setGiscusTheme);
        }
        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");
        if (themeFloatSwitcher) {
            themeFloatSwitcher.addEventListener("click", setGiscusTheme);
        }
    });
</script>

</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://121.40.252.207/">LongCoding&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
