<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>é¡¹ç›®é‡éš¾ç‚¹ | LongCoding&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="ç®€å†é¡¹ç›®é‡éš¾ç‚¹">
<meta name="author" content="ğŸ‘¨ğŸ»â€ğŸ“ LongWei">
<link rel="canonical" href="http://longcoding.top/posts/jobs/java_project_highlight/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://longcoding.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://longcoding.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://longcoding.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://longcoding.top/apple-touch-icon.png">
<link rel="mask-icon" href="http://longcoding.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://longcoding.top/posts/jobs/java_project_highlight/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://longcoding.top/posts/jobs/java_project_highlight/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="é¡¹ç›®é‡éš¾ç‚¹">
  <meta property="og:description" content="ç®€å†é¡¹ç›®é‡éš¾ç‚¹">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-11T16:45:11+08:00">
    <meta property="article:modified_time" content="2025-03-11T16:45:11+08:00">
      <meta property="og:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:title" content="é¡¹ç›®é‡éš¾ç‚¹">
<meta name="twitter:description" content="ç®€å†é¡¹ç›®é‡éš¾ç‚¹">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://longcoding.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "é¡¹ç›®é‡éš¾ç‚¹",
      "item": "http://longcoding.top/posts/jobs/java_project_highlight/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "é¡¹ç›®é‡éš¾ç‚¹",
  "name": "é¡¹ç›®é‡éš¾ç‚¹",
  "description": "ç®€å†é¡¹ç›®é‡éš¾ç‚¹",
  "keywords": [
    
  ],
  "articleBody": " é»‘é©¬ç‚¹è¯„ï¼š ç™»å½•ç›¸å…³ ä½¿ç”¨ JWT å®ç°æ— çŠ¶æ€è®¤è¯ï¼Œç™»å½•æˆåŠŸåç”Ÿæˆä¸€ä¸ªåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ Token è¿”å›ç»™å‰ç«¯ï¼Œç”±å‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶æºå¸¦åœ¨è¯·æ±‚å¤´ä¸­ã€‚åç«¯é€šè¿‡æ‹¦æˆªå™¨ç»Ÿä¸€æ‹¦æˆªè¯·æ±‚ï¼Œè§£æå¹¶æ ¡éªŒ Token çš„åˆæ³•æ€§ã€‚ \u003cç”¨æˆ·ä¿¡æ¯åªåŒ…æ‹¬ï¼šuserIdï¼Œusernameï¼Œroleç­‰å¿…è¦ä¿¡æ¯ =\u003e å®‰å…¨\u003e\næ ¡éªŒé€šè¿‡åï¼Œæˆ‘ä»¬ä¼šå°†è§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° ThreadLocal ä¸­ï¼Œæ„å»ºä¸€ä¸ªçº¿ç¨‹çº§çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†æµç¨‹ä¸­éƒ½å¯ä»¥æ–¹ä¾¿åœ°è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼Œé¿å…å±‚å±‚ä¼ å‚ï¼Œæå‡ä»£ç æ•´æ´åº¦å’Œå¯ç»´æŠ¤æ€§ã€‚\nThreadLocalåŸç†ï¼šæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„ThreadLocalMapå¯¹è±¡ã€‚æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ª ThreadLocal å¯¹è±¡ä½œä¸ºé”®ï¼Œä½†å€¼äº’ä¸å½±å“ã€‚é€šè¿‡çº¿ç¨‹çº§åˆ«çš„å˜é‡éš”ç¦»ï¼Œé¿å…å¤šçº¿ç¨‹ç«äº‰ï¼Œå®ç°çº¿ç¨‹å®‰å…¨ã€‚\nè¶…å–é—®é¢˜ï¼š æ•°æ®åº“å±‚é¢ï¼š æ‚²è§‚é”ï¼ˆFOR UPDATE-è¡Œé”ï¼‰ ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·æ³•ï¼‰ åº”ç”¨å±‚é¢ï¼š åˆ†å¸ƒå¼é”ï¼ˆäº’æ–¥ï¼‰ ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ— é™æµ+ç†”æ–­ 1.1 è¡Œé”\n1BEGIN; 2SELECT stock FROM products WHERE id = 1 FOR UPDATE; 3-- ä¸šåŠ¡é€»è¾‘ï¼šæ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œæ‰§è¡Œæ‰£å‡æ“ä½œ 4UPDATE products SET stock = stock - 1 WHERE id = 1; 5COMMIT; 10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š791.2/sec äº’æ–¥é”ï¼Œä¸²è¡Œè®¿é—®\n1Integer stock = baseMapper.selectSecKillStockForUpdate(voucherId); // FordateåŠ è¡Œé”ï¼Œäº‹åŠ¡ç»“æŸä¼šé‡Šæ”¾ 2if (stock \u003c= 0){ 3 throw new BusinessException(500, \"fail\"); 4} 5 6boolean update = lambdaUpdate().set(SeckillVoucher::getStock, stock - 1) 7 .eq(SeckillVoucher::getVoucherId, voucherId) 8 .update(); 1.2 CASæ–¹æ³•\n1UPDATE products 2SET stock = stock - 1 3WHERE id = 1 AND stock \u003e 0; 10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š944.7/sec\n1// æ³¨æ„æŠŠStockä¸æ»¡è¶³æ¡ä»¶çš„è¿‡æ»¤ï¼ 2 3boolean update = lambdaUpdate() 4 .setSql(\"stock = stock - 1\") // è¿™ä¸ªå¾ˆå…³é”® ä¸è¦ä½¿ç”¨ set(::getStock, stock-1) é”™è¯¯åŸå› ï¼šåŸºäºåº”ç”¨å±‚è®¡ç®—çš„å€¼ï¼Œè€Œä¸æ˜¯æ•°æ®åº“çš„å½“å‰å€¼ã€‚ 5 .eq(SeckillVoucher::getVoucherId, voucherId) 6 .gt(SeckillVoucher::getStock, 0) // eq(::getStock, stock) 7 .update(); â­â­â­ MVCC(ç‰ˆæœ¬é“¾+ReadView) - è¯»æ“ä½œè€Œè¨€\näº‹åŠ¡ B çš„æ›´æ–°æ“ä½œï¼š æ›´æ–°æ“ä½œä¼šç›´æ¥æ“ä½œæ•°æ®åº“çš„å½“å‰å€¼ï¼Œè€Œä¸æ˜¯åŸºäºäº‹åŠ¡ B çš„ ReadViewã€‚ äº‹åŠ¡ B çš„æ›´æ–°æ“ä½œä¼šæ£€æŸ¥æ•°æ®åº“çš„å½“å‰å€¼ï¼Œå‘ç° stock = 0ï¼Œå› æ­¤æ›´æ–°å¤±è´¥ã€‚ 2.1 ğŸ·ï¸ JVMé”ï¼ˆå•ä½“ï¼‰ï¼š\n1// è¯¥æ–¹æ³•æ¯æ¬¡åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œäº’æ–¥ 2synchronized (VoucherOrderService.class) { 3\t// æŸ¥ 4 // æ”¹ 5} 10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š715.5/sec äº’æ–¥é”ï¼Œä¸²è¡Œè®¿é—®\n2.2 ğŸ·ï¸åˆ†å¸ƒå¼é”ï¼š\n1// seckill_key = \"seckill:product:1\" 2// =Luaè„šæœ¬(åˆ¤æ–­+æ‰£å‡)=\u003e å†å¤„ç†MySQL // åŸå­åŒ–æŸ¥è¯¢+ä¿®æ”¹ 2.3 ğŸ·ï¸ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ— ï¼ˆæœåŠ¡è§£è€¦ï¼‰:\n1// åº“å­˜åˆå§‹åŒ–ï¼šå°†MySQLå•†å“åº“å­˜å­˜å…¥Redisä¸­ï¼Œæå‡æŸ¥è¯¢å’Œæ‰£å‡æ•ˆç‡; 2 3// åº“å­˜é¢„æ‰£å‡(Redis)ï¼šç”¨æˆ·è¯·æ±‚æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜; == Luaè„šæœ¬ 4Long ok = redisTemplate.execute(SECKILL_SCRIPT, Collections.emptyList(), \"1\"); 5rabbitTemplate.convertAndSend(exchangerName, routingKey, message); 6 7// è®¢å•å¼‚æ­¥å¤„ç†(MQ):æ‰£å‡æˆåŠŸ =\u003e MQ =\u003e è®¢å•å¤„ç†æ¥å£ =\u003e Redis\u0026MySQLä¸€è‡´ã€‚ 8lambdaUpdate() 9 .setSql(\"stock = stock - 1\") 10 .eq(SeckillVoucher::getVoucherId, Integer.valueOf(msg.get(\"voucherId\"))) 11 .update(); 10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š1485.7/sec\nğŸ·ï¸é™æµ+ç†”æ–­: ï¼ˆä»…ç†è®ºï¼‰\n1// 1. Nginxé™æµ(æœ€åŸºç¡€ï¼Œæ‹¦æˆªæ¶æ„æµé‡) - åªé’ˆå¯¹IP 2http { 3 limit_req_zone $binary_remote_addr zone=mylimit:10m rate 100r/s; 4 server { 5 location /seckill { 6 limit_req zone=mylimit burst=50 nodelay; 7 proxy_pass http://backend; 8 } 9 } 10} 11 12// 2. Redisä»¤ç‰Œæ¡¶(åº”ç”¨å±‚ç”¨æˆ·çº§é™æµï¼Œç²¾å‡†æ§åˆ¶) 13// def try_acquire_token(user_id, rate=5, capacity=10): 14bucket_key = f\"token_bucket:{user_id}\" 15last_time_key = f\"last_time:{user_id}\" 16 17// ä¸‹é¢éœ€è¦ä¸ºluaè„šæœ¬ ==== 18now = time.time() 19last_time = float(r.get(last_time_key) or now) 20elapsed = now - last_time 21 22# è®¡ç®—è¡¥å……çš„ä»¤ç‰Œ 23tokens_to_add = int(elapsed * rate) 24current_tokens = min(capacity, int(r.get(bucket_key) or capacity) + tokens_to_add) 25 26if current_tokens \u003e 0: 27 r.set(bucket_key, current_tokens - 1) # æ¶ˆè€— 1 ä¸ªä»¤ç‰Œ 28 r.set(last_time_key, now) # æ›´æ–°æ—¶é—´ 29 return True 30return False 31 32// ==== 33 34 35// 3. å‰ç«¯æ’é˜Ÿ(å‡å°‘æ— æ•ˆè¯·æ±‚ï¼Œé¿å…ä¸€çªèœ‚æ¶Œå…¥) ä¸€äººä¸€å•é—®é¢˜ï¼š ï¼ˆé¦–å…ˆä¸èƒ½é‡å¤ä¸‹å•ï¼Œè¿˜è¦æ‰£å‡åº“å­˜ï¼Œå¹¶ä¸”æ–°å¢è®¢å•ï¼‰\n**å•ä½“æ¶æ„ **\n*** Redis-Luaè„šæœ¬åŸå­åŒ–æŸ¥è¯¢åº“å­˜+é‡å¤ä¸‹å•*** synchronizedåŠ é” - UserId.toString().intern() å­—ç¬¦ä¸²å¸¸é‡æ± å¼•ç”¨ é›†ç¾¤æ¶æ„\nåˆ†å¸ƒå¼é”å®ç° 1.1 ğŸ·ï¸Rediså®ç°ï¼š\n1if (redis.call('exists', orderKey) == 0) then 2 redis.call('sadd', orderKey, '') -- ï¼ï¼ï¼åˆå§‹åŒ–éœ€è¦ä»MySQLä¸­åŠ è½½å·²ç»ä¹°è¿‡çš„ç”¨æˆ· 3 return 2 4end 5if (redis.call('sismember', orderKey, userId) == 1) then 6 return 2 7end 8 9redis.call('sadd', orderKey, userId) 10-- åœ¨Redisä¸­ï¼Œä½¿ç”¨Seté›†åˆå­˜å‚¨ä¹°è¿‡çš„ç”¨æˆ· 1.2 ğŸ·ï¸JVMé”+MySQLå®ç°ï¼š\n1@Transactional 2public Result seckillVoucherMySQLAndMQUnique(Long voucherId, Long userId) throws JsonProcessingException { 3 Integer stock = lambdaQuery() 4 .select(SeckillVoucher::getStock) 5 .eq(SeckillVoucher::getVoucherId, voucherId) 6 .oneOpt() 7 .map(SeckillVoucher::getStock).orElse(null); 8 if (stock \u003c= 0) { 9 throw new BusinessException(500, \"å·²ç»å–å®Œäº†ï¼\"); 10 } 11 12 synchronized(userId.toString().intern()) { 13 transactionPostChannel(userId, voucherId); 14 } 15 16 return Result.ok(); 17} 18 19@Transactional 20public void transactionPostChannel(Long userId, Long voucherId) { 21 boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); 22 if (isOrder) { 23 throw new BusinessException(500, \"æ‚¨ä¹°è¿‡äº†ï¼\"); 24 } 25 26 boolean update = lambdaUpdate() 27 .setSql(\"stock = stock - 1\") 28 .eq(SeckillVoucher::getVoucherId, voucherId) 29 .update(); 30 if (!update) { 31 throw new BusinessException(500, \"MySQLåº“å­˜æ›´æ–°å¤±è´¥\"); 32 } 33 34 VoucherOrder voucherOrder = new VoucherOrder(); 35 voucherOrder.setUserId(userId); 36 voucherOrder.setVoucherId(voucherId); 37 boolean b = voucherOrderService.setVoucherOrder(voucherOrder); 38 if (!b) { 39 throw new BusinessException(500, \"MySQLæ’å…¥å¤±è´¥\"); 40 } 41} 42 43// ä¸‹é¢åªä½¿ç”¨ä¸€ä¸ª@Transactional 44@Transactional 45public Result seckillVoucherMySQLAndMQUnique(Long voucherId, Long userId) throws JsonProcessingException { 46 Integer stock = lambdaQuery() 47 .select(SeckillVoucher::getStock) 48 .eq(SeckillVoucher::getVoucherId, voucherId) 49 .oneOpt() 50 .map(SeckillVoucher::getStock).orElse(null); 51 if (stock \u003c= 0) { 52 throw new BusinessException(500, \"å·²ç»å–å®Œäº†ï¼\"); 53 } 54 55 synchronized(userId.toString().intern()) { 56 VoucherSecKillService o = (VoucherSecKillService) AopContext.currentProxy(); 57 o.transactionPostChannel(userId, voucherId); 58 } 59 60 return Result.ok(); 61} 62//â­â­â­åµŒå¥—æ‰§è¡Œæ–¹æ³•ï¼Œä¸”ä¸»æ–¹æ³•æ²¡æœ‰@Transactionalï¼Œéœ€è¦ä»£ç†å¯¹è±¡æ¥æ‰§è¡Œæ‰èƒ½ä½¿ä¸šåŠ¡ç”Ÿæ•ˆ ğŸ·ï¸1 synchronized é”çš„ç²’åº¦é™çº§äº†ï¼Œå˜ä¸ºå½“å‰ç”¨æˆ·Id ã€userId.toString().intern() æ·»åŠ åˆ°å¸¸é‡æ± ï¼Œå¹¶è¿”å›å¸¸é‡æ± çš„å¼•ç”¨ã€‘ âŒâŒâŒè¿™é‡Œé”çš„å•æœºï¼Œå¤šä¸ªJVMçš„æƒ…å†µä¸‹ï¼Œå°±å¯„äº†\nğŸ·ï¸2 VoucherSecKillService o = (VoucherSecKillService) AopContext.currentProxy(); æ‹¿åˆ°æ‰§è¡Œäº‹åŠ¡çš„ä»£ç†å¯¹è±¡\nğŸ·ï¸3 boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); éœ€è¦æŠŠæ˜¯å¦ä¸‹å•é”ä½ï¼Œå¦åˆ™ï¼Œå¯èƒ½é‡å¤ä¸‹å•ï¼Œå› ä¸ºè¿™ä¸ªæ¡ä»¶å¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶æ»¡è¶³ï¼ï¼ï¼\n2.1 ğŸ·ï¸åˆ†å¸ƒå¼é”ç°å®\nè§£å†³å•æœºJVMé”ï¼Œåœ¨é›†ç¾¤ä¸‹å¤±æ•ˆçš„é—®é¢˜ã€‚\n1-- ä¸Šé”ï¼Œåˆ†å¸ƒå¼çš„ 2ä¸å­˜åœ¨:åˆ›å»ºå¹¶è¿”å›True ä¸šåŠ¡ =\u003e æ‰£åº“å­˜ + åˆ›å»ºè®¢å•\n1-- è§£é”ï¼Œåˆ†å¸ƒå¼ï¼Œåªèƒ½è§£é”è‡ªå·±ä¸Šçš„é” 2// å¦‚æœå¯ä»¥é‡Šæ”¾åˆ«äººçš„é”ï¼Œä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µ 3// äº‹åŠ¡Açš„é”è¿‡æœŸé‡Šæ”¾äº†(è¿™é‡Œæ²¡æœ‰ç»­æ—¶é—´oræš‚æ—¶å¡äº†) =\u003e äº‹åŠ¡BåŠ é” =\u003e äº‹åŠ¡Aæ´»äº†è¿‡æ¥*è§£é”* =\u003e äº‹åŠ¡CåŠ é” ... 4äº‹åŠ¡Bå’ŒCæ‹¿äº†åŒä¸€æŠŠé”ï¼Œå¯„äº† =\u003e åªå…è®¸åˆ è‡ªå·±åŠ çš„é” 5äº‹åŠ¡Aå’ŒBæ‹¿äº†åŒä¸€æŠŠé”ï¼Œå¯„äº† =\u003e çœ‹é—¨ç‹—ç»­æ—¶é—´ luaè„šæœ¬\n1Boolean lock = redisTemplate.opsForValue().setIfAbsent(lock_key, lock_value, 3, TimeUnit.SECONDS); 2 3try { 4 if (lock) { 5 ... 6 } 7} finally { 8\tredisTemplate.execute(SECKILL_UNLOCK_SCRIPT, Collections.singletonList(lock_key), lock_value); // åˆ é™¤é”å’Œåˆ¤æ–­é”æ˜¯å¦å½“å‰çº¿ç¨‹æ‹¥æœ‰ åŸå­åŒ– 9} Redission\n1RLock lock = redissonClient.getLock(lock_key); 2try { 3 boolean ok = lock.tryLock(1, 3, TimeUnit.SECONDS); // ä¸é˜»å¡ 4 if(ok) {...} 5 finally { 6 if (lock.isHeldByCurrentThread()) lock.unlock(); 7 } 8} 9 10try { 11 boolean ok = lock.lock(); // é˜»å¡,ä¸”æœªæŒ‡å®šè¿‡æœŸæ—¶é—´ =\u003e è§¦å‘çœ‹é—¨ç‹— 12 if(ok) {...} 13 finally { 14 if (lock.isHeldByCurrentThread()) lock.unlock(); 15 } 16} æœ€å¼€å§‹æˆ‘ä»¬çš„é‡åˆ°è‡ªå¢IDé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°åˆ†å¸ƒå¼IDè§£å†³äº†é—®é¢˜ï¼›åé¢æˆ‘ä»¬åœ¨å•ä½“ç³»ç»Ÿä¸‹é‡åˆ°äº†ä¸€äººå¤šå•è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡ä¹è§‚é”/æ‚²è§‚é”è§£å†³äº†ï¼›æˆ‘ä»¬å¯¹ä¸šåŠ¡è¿›è¡Œäº†å˜æ›´ï¼Œå°†ä¸€äººå¤šå•å˜æˆäº†ä¸€äººä¸€å•ï¼Œç»“æœåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹åŒä¸€ç”¨æˆ·å‘é€ç›¸åŒè¯·æ±‚ä»ç„¶å‡ºç°äº†è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡æ‚²è§‚é”è§£å†³äº†ï¼›ç”±äºç”¨æˆ·é‡çš„æ¿€å¢ï¼Œæˆ‘ä»¬å°†å•ä½“ç³»ç»Ÿå‡çº§æˆäº†é›†ç¾¤ï¼Œç»“æœç”±äºé”åªèƒ½åœ¨ä¸€ä¸ªJVMä¸­å¯è§å¯¼è‡´åˆå‡ºç°äº†ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹åŒä¸€ç”¨æˆ·å‘é€ä¸‹å•è¯·æ±‚å‡ºç°è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°åˆ†å¸ƒå¼é”æˆåŠŸè§£å†³é›†ç¾¤ä¸‹çš„è¶…å–é—®é¢˜ï¼›é‡Šæ”¾é”æ—¶ï¼Œåˆ¤æ–­é”æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ å’Œ åˆ é™¤é”ä¸¤ä¸ªæ“ä½œä¸æ˜¯åŸå­æ€§çš„ï¼Œå¯èƒ½å¯¼è‡´è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å°†ä¸¤ä¸ªæ“ä½œå°è£…åˆ°ä¸€ä¸ªLuaè„šæœ¬æˆåŠŸè§£å†³äº†ï¼›\nä¸ºäº†è§£å†³é”çš„ä¸å¯é‡å…¥æ€§ï¼Œæˆ‘ä»¬é€šè¿‡å°†é”ä»¥hashç»“æ„çš„å½¢å¼å­˜å‚¨ï¼Œæ¯æ¬¡é‡Šæ”¾é”éƒ½value-1ï¼Œè·å–é”value+1ï¼Œä»è€Œå®ç°é”çš„å¯é‡å…¥æ€§ï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”å’Œè·å–é”çš„æ“ä½œå°è£…åˆ°Luaè„šæœ¬ä¸­ä»¥ç¡®ä¿åŸå­æ€§ã€‚\næœ€æœ€åï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥ç›´æ¥ä½¿ç”¨ç°æœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆRedissonæ¥è§£å†³ä¸Šè¯‰å‡ºç°çš„æ‰€æœ‰é—®é¢˜ğŸ¤£ï¼Œä»€ä¹ˆä¸å¯é‡è¯•ã€ä¸å¯é‡å…¥ã€è¶…å¸‚é‡Šæ”¾ã€åŸå­æ€§ç­‰é—®é¢˜Redissonéƒ½æä¾›ç›¸å¯¹åº”çš„è§£å†³æ–¹æ³•ï¼ˆã€‚ï¼¾â–½ï¼¾ï¼‰\nä¼˜æƒ å·ç§’æ€ å¼‚æ­¥ä¸‹å•ï¼š\n1// ä¸»çº¿ç¨‹ 21. Luaè„šæœ¬ 32. æˆåŠŸ=\u003eæ”¾å…¥é˜Ÿåˆ—ï¼›å¤±è´¥=\u003eè¿”å›å¼‚å¸¸ 4 51.1. Luaè„šæœ¬ =\u003e åº“å­˜ =æ‰£åº“å­˜=\u003e æ˜¯å¦ä¸‹å• =è®°å½•ç”¨æˆ·ä¸‹å• =\u003e è¿”å›0 6 è¿”å›1 è¿”å›2 7 8// å­çº¿ç¨‹ 9é˜Ÿåˆ—ä¸­å–å‡ºè®¢å•ä¿¡æ¯ =\u003e æ‰£å‡å·åº“å­˜ =\u003e æ˜¯å¦ä»˜æ¬¾ =\u003e æ›´æ–°æˆåŠŸ 10 =\u003e End ç¼“å­˜ä¸‰å…„å¼Ÿï¼š ğŸ’¡ç¼“å­˜ç©¿é€ï¼š æ¶æ„è¯·æ±‚æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç»•è¿‡ç¼“å­˜ç›´æ¥è®¿é—®æ•°æ®åº“\nå¸ƒéš†è¿‡æ»¤å™¨ å•†å“IDï¼Œé€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå°†å…ƒç´ æ˜ å°„åˆ°bitMapä¸­çš„å¤šä¸ªä½ç½®ï¼Œåªæœ‰æ¯ä¸ªä½ç½®éƒ½ä¸º1æ‰è¡¨æ˜è¿™ä¸ªå¯¹è±¡å­˜åœ¨ã€‚ guavaåº“æœ‰å®ç°å¥½çš„ï¼Œç›´æ¥ç”¨ã€‚ 1# ä¼ªä»£ç ï¼Œä»…ä¾›å­¦ä¹  2class BloomFilter: 3 def __init__(self, size, hash_count): 4 \"\"\" 5 åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ 6 :param size: ä½æ•°ç»„å¤§å°ï¼ˆmï¼‰ 7 :param hash_count: å“ˆå¸Œå‡½æ•°æ•°é‡ï¼ˆkï¼‰ 8 \"\"\" 9 self.size = size 10 self.hash_count = hash_count 11 self.bit_array = [0] * size # åˆå§‹åŒ–ä½æ•°ç»„ï¼ˆå…¨0ï¼‰ 12 13 def add(self, item): 14 \"\"\" 15 æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨ 16 \"\"\" 17 for seed in range(self.hash_count): 18 # é€šè¿‡ä¸åŒçš„ç§å­æ¨¡æ‹Ÿå¤šä¸ªå“ˆå¸Œå‡½æ•° 19 index = self._hash(item, seed) % self.size 20 self.bit_array[index] = 1 # è®¾ç½®å¯¹åº”ä½ä¸º1 21 22 def contains(self, item): 23 \"\"\" 24 æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨ 25 :return: 26 - True: å¯èƒ½å­˜åœ¨ï¼ˆå¯èƒ½æœ‰è¯¯åˆ¤ï¼‰ 27 - False: ä¸€å®šä¸å­˜åœ¨ 28 \"\"\" 29 for seed in range(self.hash_count): 30 index = self._hash(item, seed) % self.size 31 if self.bit_array[index] == 0: 32 return False # åªè¦æœ‰ä¸€ä½ä¸º0ï¼Œåˆ™ä¸€å®šä¸å­˜åœ¨ 33 return True # æ‰€æœ‰ä½å‡ä¸º1ï¼Œå¯èƒ½å­˜åœ¨ 34 35 def _hash(self, item, seed): 36 \"\"\" 37 å“ˆå¸Œå‡½æ•°ï¼ˆä¼ªä»£ç ï¼Œå®é™…å¯ç”¨MurmurHashç­‰ï¼‰ 38 :param item: è¾“å…¥å…ƒç´  39 :param seed: å“ˆå¸Œç§å­ï¼ˆæ¨¡æ‹Ÿä¸åŒå“ˆå¸Œå‡½æ•°ï¼‰ 40 :return: å“ˆå¸Œå€¼ 41 \"\"\" 42 hash_value = 0 43 for char in str(item): 44 hash_value = (hash_value * seed + ord(char)) \u0026 0xFFFFFFFF 45 return hash_value ç¼“å­˜ç©ºå¯¹è±¡ ğŸ·ï¸ ç¼“å­˜ç©ºå¯¹è±¡å®ç°æ–¹æ¡ˆ\n1// ç¼“å­˜å‘½ä¸­ 2if (StrUtil.isNotBlank(s)) { // ä¸ä¸ºnullï¼Œä¸ä¸º\"\" 3 SeckillVoucher seckillVoucher = JSONUtil.toBean(s, SeckillVoucher.class); 4 return Result.ok(seckillVoucher); 5} 6 7// æœªå‘½ä¸­ï¼Œæ˜¯å¦æ˜¯ä¹‹å‰ç¼“å­˜çš„ç©ºå¯¹è±¡ 8if (Objects.nonNull(s)) { // \"\" ä¸ä¸ºnull 9 throw new BusinessException(500, \"æŸ¥è¯¢ç¼“å­˜ç©ºå¯¹è±¡ï¼\"); 10} 11 12SeckillVoucher seckillVoucher = lambdaQuery() 13 .eq(SeckillVoucher::getVoucherId, id) 14 .one(); 15// ç¼“å­˜ç©ºå¯¹è±¡ ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜å°±å¥½ 16synchronized (CacheTestService.class) { 17 String t = redisTemplate.opsForValue().get(key); 18 if (Objects.nonNull(t)) 19 throw new BusinessException(500, \"æŸ¥è¯¢ç¼“å­˜ç©ºå¯¹è±¡ï¼\"); 20 21 if (Objects.isNull(seckillVoucher)) { 22 redisTemplate.opsForValue().set(key, \"\", 3, TimeUnit.SECONDS); 23 throw new BusinessException(500, \"ç¼“å­˜ç©ºå¯¹è±¡ï¼\"); 24 } 25} 26// ç¼“å­˜é‡å»º 27redisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(seckillVoucher), 3, TimeUnit.SECONDS); 28 29return Result.ok(seckillVoucher); ğŸ’¡ç¼“å­˜é›ªå´©ï¼šé‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨å‹åˆ°æ•°æ®åº“\nè¿‡æœŸæ—¶é—´éšæœºåŒ– â­â­â­ baseline + random_offset Hotæ•°æ®å®šæ—¶åˆ·æ–°ç¼“å­˜ @Scheduled å¤šçº§ç¼“å­˜(æœ¬åœ°-Redis-æ•°æ®åº“) ğŸ’¡ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹ Key çªç„¶å¤±æ•ˆï¼Œå¤§é‡å¹¶å‘è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“\näº’æ–¥é‡å»ºï¼šç¬¬ä¸€ä¸ªé‡å»º(MySQL=\u003eRedis)ï¼Œåé¢çš„ç­‰ä¸€ä¸‹å†è®¿é—®ç¼“å­˜ é€»è¾‘è¿‡æœŸï¼šè¿”å›è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯äº’æ–¥(ç¬¬ä¸€ä¸ªè®¿é—®çš„)é‡å»ºç¼“å­˜ â—æ•°æ®ä¸€è‡´æ€§ä¸é«˜ 1// ç¼“å­˜å‡»ç©¿(çƒ­ç‚¹Keyï¼Œç¬æ—¶é‡å»ºé—®é¢˜) 2public Shop queryWithMutex(Long id) { 3 // 1. å…ˆRedis 4 String key = \"cache:shop:\" + id; 5 String shopJson = stringRedisTemplate.opsForValue().get(key); 6 // Cacheå‘½ä¸­ shopJson ä¸ä¸ºnull,\"\", \"\\t\"(ä¸å…¨æ˜¯ç©ºç™½å­—ç¬¦) 7 if (StrUtil.isNotBlank(shopJson)) { 8 Shop shop = JSONUtil.toBean(shopJson, Shop.class); 9 return shop; 10 } 11 // ç©ºå¯¹è±¡ 12 if (shopJson != null) { // ä¸º\"\" 13 return null; 14 } 15 16 // 1. å®ç°ç¼“å­˜é‡å»º 17 String lockKey = \"lock:shop:\" + id; 18 Shop shop = null; 19 try { 20 // 1.1 è·å–äº’æ–¥é” 21 boolean isLock = tryLock(lockKey); 22 // 1.2 åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ 23 if (!isLock) { 24 // 1.3 å¤±è´¥åˆ™ä¼‘çœ ä¸”è½®è¯¢ 25 Thread.sleep(50); 26 return queryWithMutex(id); â­â­â­ 27 } 28 // æœªå‘½ä¸­ =\u003e MySQL ç¼“å­˜é‡å»º 29 shop = lambdaQuery().eq(Shop::getId, id).one(); 30 Thread.sleep(500); // æ¨¡æ‹Ÿå¤æ‚çš„é‡å»ºä»»åŠ¡ 31 if (shop == null) { 32 // å°†ç©ºå¯¹è±¡ç¼“å­˜ 33 stringRedisTemplate.opsForValue().set(key, \"\", RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES); 34 return null; 35 } 36 // log.debug(shop.toString()); 37 stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), RedisConstants.CACHE_SHOP_TTL, TimeUnit.MINUTES); 38 } catch (InterruptedException e) { 39 e.printStackTrace(); 40 } finally { 41 unlock(lockKey); 42 } 43 return shop; 44} 45 46public Shop queryWithLogicExpire(Long id) { 47 // 1. å…ˆRedis 48 String key = \"cache:shop:\" + id; 49 // log.debug(\"Key:\" + key); 50 String shopJson = stringRedisTemplate.opsForValue().get(key); 51 52 if (StrUtil.isBlank(shopJson)) { 53 // ç¼“å­˜ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶å›å¡« 54 return saveShop2Redis(id, 20L); 55 } 56 // RedisData: private LocalDateTime expireTime; 57 // private Object data; 58 RedisData redisData = JSONUtil.toBean(shopJson, RedisData.class); 59 Shop shop = JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class); 60 61 if (redisData.getExpireTime().isAfter(LocalDateTime.now())) { 62 // æœªè¿‡æœŸ 63 return shop; 64 } 65 String lockKey = \"lock:shop:\" + id; 66 // è¿‡æœŸè¿›è¡Œæ›´æ–° 67 boolean isLock = tryLock(lockKey); 68 if (isLock) { 69 // ç‹¬ç«‹çº¿ç¨‹è¿›è¡Œé‡å»ºç¼“å­˜ 70 CACHE_REBUILD_EXECUTOR.submit(() -\u003e { 71 try { 72 saveShop2Redis(id, 20L); 73 Thread.sleep(500); 74 } catch (Exception e) { 75 e.printStackTrace(); 76 } finally { 77 unlock(lockKey); 78 } 79 }); 80 } 81 return shop; // å¯èƒ½ä¼šè¿”å›è¿‡æœŸæ•°æ®ã€‚ å› ä¸ºæ²¡æœ‰è¿›è¡Œç­‰å¾… 82} Redis\u0026MySQLæ•°æ®ä¸€è‡´æ€§ å…ˆæ›´æ–°Redisï¼Œå†æ›´æ–°MySQL âŒä¸æ¨è å…ˆæ›´æ–°MySQLï¼Œå†æ›´æ–°Redis âŒä¸æ¨è å…ˆåˆ é™¤Redisï¼Œå†æ›´æ–°MySQLï¼Œæœ€åå†™å›Redis âŒä¸æ¨è å…ˆæ›´æ–°MySQLï¼Œå†åˆ é™¤Redisï¼Œç­‰è¯·æ±‚é‡æ–°ç¼“å­˜(æƒ°æ€§) âœ”ï¸æ¨è ç¼“å­˜åŒåˆ é™¤ç­–ç•¥ã€‚æ›´æ–°MySQLä¹‹å‰ï¼Œåˆ é™¤ä¸€æ¬¡Redisï¼›æ›´æ–°å®ŒMySQLåï¼Œå†è¿›è¡Œä¸€æ¬¡å»¶è¿Ÿåˆ é™¤ âœ”ï¸æ¨è æ•°æ®åº“æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¼“å­˜æœ‰é—®é¢˜ï¼Œç­‰å¾…ä¸€æ®µå®è·µ\nä½¿ç”¨Binlogå¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œç›‘å¬æ•°æ®åº“çš„binlogå˜åŒ–ï¼Œé€šè¿‡å¼‚æ­¥æ–¹å¼æ›´æ–°Redisç¼“å­˜ âœ”ï¸æ¨è äº®ç‚¹æ¨¡å—ï¼š RabbitMQ å¼‚æ­¥å¤„ç† å‰Šå³°å¡«è°·ï¼ˆæµé‡å‰Šå³°ï¼‰\n=\u003e å‰Šå³°ï¼ˆç¼“å†²æµé‡ï¼‰ï¼šæµé‡é«˜å³°æ—¶ï¼ŒMQ å……å½“â€œç¼“å†²åŒºâ€ï¼Œå°†è¯·æ±‚å…ˆå­˜å‚¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œé¿å…ç³»ç»Ÿç›´æ¥å´©æºƒã€‚\nâ€‹ å¡«è°·ï¼ˆå¹³æ»‘æµé‡ï¼‰ï¼šæ¶ˆè´¹è€…æŒ‰ç¨³å®šé€Ÿç‡æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¿è¯ç³»ç»Ÿè´Ÿè½½å‡è¡¡ã€‚\næ¶ˆæ¯å¯é æŠ•é€’ å‘å¸ƒç¡®è®¤æœºåˆ¶ - æ˜¯å¦é‡å‘ RabbitMQæŒä¹…åŒ– æ¶ˆæ¯å¯é æ¶ˆè´¹ æ‰‹åŠ¨ACK é™æµæœºåˆ¶ - ä¸€æ¬¡åªå–ä¸€ä¸ªæ¶ˆæ¯ æ­»ä¿¡é˜Ÿåˆ—ï¼ˆâ—å…œåº•ï¼‰ æ¶ˆæ¯å”¯ä¸€æ¶ˆè´¹ Rediså­˜å‚¨æ¶ˆè´¹è¿‡çš„ID (å¤šä¸ªæ¶ˆè´¹è€…æ¥æ”¶åˆ°ç›¸åŒçš„æ¶ˆæ¯æ—¶å€™) - å‘å¸ƒ/è®¢é˜…ï¼ˆFanout äº¤æ¢æœº-å¹¿æ’­ï¼‰ï¼Œæ¶ˆæ¯ä¼šè¢«å¤åˆ¶åˆ°å¤šä¸ªé˜Ÿåˆ—ã€‚ â­RabbitMQ ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œé˜Ÿåˆ—æ˜¯ç‚¹å¯¹ç‚¹æ¨¡å‹ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼ŒRabbitMQ é‡‡ç”¨ â€œè½®è¯¢åˆ†å‘â€ï¼ˆRound Robinï¼‰ï¼Œæ¯æ¡æ¶ˆæ¯åªä¼šè¢«å…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ã€‚ 1\tRabbitMQ 2publisher =\u003e [exchanger =\u003e queue] =\u003e consumer 3error 1. 4. 2. 5. 3. 1.2. æŠ•é€’å¤±è´¥ =\u003e é‡æ–°æŠ•é€’\n4.5. MQå®•æœº =\u003e æŒä¹…åŒ–\n3.. ACKç¡®è®¤ =\u003e é‡æ–°æ¶ˆè´¹\n1rebbitmq: 2\t# ... 3 publisher-confirm-type: correlated # å¼€å¯å‘å¸ƒç¡®è®¤æœºåˆ¶ 4 publisher-returns: true # æŠ•é€’æ¶ˆæ¯æŠµè¾¾é˜Ÿåˆ— 5 listener: 6 simple: 7 acknowledge-mode: manual # æ¶ˆè´¹è€…æ‰‹åŠ¨ç¡®è®¤ACK 8 prefetch: 1 # é™åˆ¶æ¶ˆè´¹è€…ä¸€æ¬¡å¤„ç†ä¸€æ¡æ•°æ® ç”Ÿäº§è€…ï¼š\n1// ç¡®ä¿äº¤æ¢æœºæ”¶åˆ°æ¶ˆæ¯ 2rabbitTemplate.setConfirmCallback(((correlationData, ack, cause) -\u003e { 3 if (ack) { 4 log.debug(\"[âˆš] Product: Msg send success!\"); 5 }else { 6 log.error(\"[Ã—] Product: Msg send fail!, åŸå› : {}\", cause.toUpperCase()); 7 msgRetryCount.putIfAbsent(correlationData.getId(), 3); 8 retrySendMsg(correlationData); 9 } 10})); 11 12// ç¡®ä¿é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯ 13rabbitTemplate.setReturnsCallback(returnedMessage -\u003e { 14 log.error(\"[Ã—] æ¶ˆæ¯è·¯ç”±å¤±è´¥!, åŸå› : {}, Msg: {}\", returnedMessage.getReplyText(), returnedMessage.getMessage()); 15 // è¿™é‡ŒRoting Keyé”™è¯¯ï¼Œé…ç½®é”™è¯¯ï¼ŒæŠ•é€’æ­»ä¿¡é˜Ÿåˆ—æ¯”è¾ƒå¥½ 16}); 17} 18 19private void retrySendMsg(CorrelationData correlationData) { 20 Integer count = msgRetryCount.get(correlationData.getId()); 21 if (count \u003e 0) { 22 String message = msgCacheMap.get(correlationData.getId()); 23 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY, message, correlationData); 24 msgRetryCount.computeIfPresent(correlationData.getId(), (s, integer) -\u003e integer-1); 25 }else { 26 log.error(\"å‘é€åˆ°æ­»ä¿¡äº¤æ¢æœºï¼\"); 27 } 28} 29 30// â­â­â­æ¨¡æ‹Ÿé”™è¯¯æƒ…å†µ 1. 2. 31public void sendMessage(String message) { 32 log.debug(\"[\u003e] Send Msg: \" + message); 33 for (int i = 1; i \u003c= 3; i++) { 34 CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString()); 35 msgCacheMap.put(correlationData.getId(), message + \":\" + i); // ç¼“å­˜æ¶ˆæ¯ 36 if (i == 2) { 37 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME + \"error\", ReliabilityMQConfig.ROUTING_KEY, message + \":\" + i, correlationData); 38 }else if (i == 3) { 39 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY + \"error\", message + \":\" + i, correlationData); 40 }else { 41 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY, message, correlationData); 42 } 43 } 44} æ¶ˆè´¹è€…ï¼š\n1@RabbitListener(queues = ReliabilityMQConfig.QUEUE_NAME) 2public void receiveMessage(String message, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag, Channel channel) throws InterruptedException { 3 try { 4 log.debug(\"[Ã—] å¼€å§‹å¤„ç†æ¶ˆæ¯: \" + message); 5 Thread.sleep(2000); 6 double p = RandomUtil.randomDouble(0, 1); 7 if (p \u003e= 0.5) { 8 throw new IOException(\"æ‰‹åŠ¨é€ æˆå¼‚å¸¸\"); 9 } 10 // 1. process success 11 channel.basicAck(deliveryTag, false); // deliveryTag:msgId; multiple=false:ackCurrentMsg else ackPreAllMsg 12 log.debug(\"[âˆš] process Msg success: {}\", message); 13 } catch (IOException e) { 14 // 2. process fail 15 log.debug(\"[Ã—] process Msg fail: \" + message); 16 try { 17 // é€€å›æ¶ˆæ¯ 18 channel.basicNack(deliveryTag, false, true); // msgId, æ˜¯å¦æ‰¹é‡æ‹’ç»:false:ä»…æ‹’ç»å½“å‰Msg, true:æ‹’ç»æ‰€æœ‰deliveryTagå°äºç­‰äºå½“å‰çš„deliveryTagæ¶ˆæ¯ â­â­â­ æ¶ˆè´¹å¤±è´¥æ—¶é‡æ–°å…¥é˜Ÿï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚ 19 } catch (IOException ioException) { 20 log.debug(\"[\u003c] Msg notAck fail\"); 21 } 22 } 23} å¾®æœåŠ¡è§£è€¦ è®¢å•è¶…æ—¶å–æ¶ˆ æ‹¼å›¢äº¤æ˜“ æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿ å®šä¹‰æŠ½è±¡ä»»åŠ¡æ¥å£\n1public interface StrategyHandler\u003cT, D, R\u003e { 2 3 StrategyHandler DEFAULT = (T, D) -\u003e null; 4 5 R apply(T requestParameter, D dynamicContext) throws Exception; 6} 7 8public interface StrategyMapper\u003cT, D, R\u003e { 9 10 StrategyHandler\u003cT, D, R\u003e get(T requestParameter, D dynamicContext) throws Exception; 11 12} å®šä¹‰æŠ½è±¡èŠ‚ç‚¹æ¥å£\n1public abstract class AbstractStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 protected StrategyHandler\u003cT, D, R\u003e defaultHandler = StrategyHandler.DEFAULT; 4 5 public R router(T requestParameter, D dynamicContext) throws Exception { 6 StrategyHandler\u003cT, D, R\u003e handler = get(requestParameter, dynamicContext); 7 if (handler != null) return handler.apply(requestParameter, dynamicContext); 8 return defaultHandler.apply(requestParameter, dynamicContext); 9 } 10 11} å¤§è‡´å°±æ˜¯ [apply + next]ï¼Œè´£ä»»é“¾æ¨¡å¼ã€‚\n1// åŸºæœ¬ä½¿ç”¨ 2class XXX { 3 ObjectXXX nextNode; 4 5 apply{... =\u003e next()} 6 7 next{nextNode.apply()} 8} å¤šå®ä¾‹é“¾è·¯æ¨¡å¼\nåŒå‘é“¾è¡¨çš„å®ç°æ€æƒ³\nå®šä¹‰é“¾è¡¨ï¼š\n1public class Node\u003cE\u003e { 2 E item; 3 4 Node\u003cE\u003e next; 5 Node\u003cE\u003e prev; 6 7 public Node(Node\u003cE\u003e prev, E item, Node\u003cE\u003e next) { 8 this.item = item; 9 this.next = next; 10 this.prev = prev; 11 } 12} å®šä¹‰èŠ‚ç‚¹å¤„ç†å¯¹è±¡\n1public interface ILogicHandler\u003cT, D, R\u003e { 2 3 // å­ç±»å¯ä»¥ä¸å®ç° 4 default R next(T requestParameter, D dynamicContext) { 5 return null; 6 } 7 8 R apply(T requestParameter, D dynamicContext) throws Exception; 9 10} å®ç°å…·ä½“çš„ä¸šåŠ¡èŠ‚ç‚¹\n1public class RuleLogic201 implements ILogicHandler\u003cString, Rule02TradeRuleFactory.DynamicContext, String\u003e { 2 3 public String apply(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext) throws Exception{ 4 5 // å…·ä½“ä¸šåŠ¡é€»è¾‘; 6 7 return next(requestParameter, dynamicContext); 8 } 9 10} è£…é…ä¸šåŠ¡è´£ä»»é“¾\n1public class LinkArmory\u003cT, D, R\u003e { 2 private final BusinessLinkedList\u003cT, D, R\u003e logicLink; 3 4 5 @SafeVarargs 6 public LinkArmory(String linkName, ILogicHandler\u003cT, D, R\u003e... logicHandlers) { 7 logicLink = new BusinessLinkedList\u003c\u003e(linkName); 8 for (ILogicHandler\u003cT, D, R\u003e logicHandler: logicHandlers){ 9 logicLink.add(logicHandler); 10 } 11 } 12 public BusinessLinkedList\u003cT, D, R\u003e getLogicLink() { 13 return logicLink; 14 } 15} è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“ å•†å“æŠ˜æ‰£ä»·æ ¼è¯•ç®—\n1// ä»å·¥å‚æ‹¿åˆ°å¯¹åº”çš„è´£ä»»é“¾å‡ºå‘èŠ‚ç‚¹ 2=\u003e RootNode 3\t=\u003e multiThread[å‰ç½®å¤„ç†|æ£€æŸ¥ä¿¡æ¯] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 4=\u003e SwitchNode 5\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 6=\u003e TagNode 7 =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 8=\u003e MarketNode 9\t=\u003e multiThread[â­å‰ç½®å¤„ç†â­æ‹¼å•è¯•ç®—] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 10=\u003e EndNode 11\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡|æ„å»ºç»“æœ] 12 13// SwitchNodeï¼šæ ¹æ®æ¡ä»¶åˆ¤æ–­ä¸šåŠ¡æ˜¯å¦é™çº§oré™æµ 14// TagNodeï¼šæ ¹æ®ç”¨æˆ·ä¿¡æ¯åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨èƒ½å¦å‚ä¸ä¸å¯è§ 15// MarketNodeï¼šæ ¹æ®æ‹¼å›¢æ´»åŠ¨ï¼Œè®¡ç®—æŠ˜æ‰£ä»·æ ¼ 16// ç­–ç•¥æ¨¡å¼ï¼šæ ¹æ®ä¼˜æƒ Id,è®¡ç®—ä¸åŒçš„æŠ˜æ‰£ æ‹¼å›¢é”å•æ ¡éªŒ\n1// å®ç°å…·ä½“çš„ä¸šåŠ¡èŠ‚ç‚¹ 2 3// 1. ActivityUsabilityRuleFilterï¼šæ ¡éªŒæ´»åŠ¨çŠ¶æ€å’Œæ´»åŠ¨æ—¶é—´çš„æœ‰æ•ˆæ€§ 4 5// 2. UserTakeLimitRuleFilterï¼šåˆ¤æ–­ç”¨æˆ·å‚ä¸æ¬¡æ•°ä¸æ´»åŠ¨é™åˆ¶æ¬¡æ•°å…³ç³» 6 7// è£…é…ä¸šåŠ¡è´£ä»»é“¾ æ‹¼å›¢ç»“ç®—æ ¡éªŒ\n1// 1. SCRuleFilter: æ ¡éªŒæ‹¼å›¢çš„æ¸ é“æ¥æºæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦åœ¨é»‘åå•ä¸­ 2// 2. SettableRuleFilterï¼šæ‹¼å›¢æ´»åŠ¨çš„ç”¨æˆ·æ”¯ä»˜æ—¶é—´æ˜¯å¦åœ¨æœ‰æ•ˆæ—¶é—´å†… 3// 3. OutTradeNoRuleFilterï¼šå¤–éƒ¨äº¤æ˜“å•å·æ˜¯å¦æ­£ç¡® 4// 4. EndRuleFilterï¼šæ‰“åŒ…ç»“æœ AOP+æ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–° é€šè¿‡AOPç¼–ç¨‹å’ŒRediså‘å¸ƒ/è®¢é˜…åŠŸèƒ½å®ç°ä¸šåŠ¡è§„åˆ™ï¼ˆé™æµé˜ˆå€¼ã€é™çº§ç­–ç•¥ï¼‰çš„çƒ­æ›´æ–°\nè‡ªå®šä¹‰æ³¨è§£\n1@Retention(RetentionPolicy.RUNTIME) 2@Target(ElementType.FIELD) 3@Documented 4public @interface DCCValue { 5 String value() default \"\"; 6} å®šä¹‰çƒ­æ›´æ–°æœåŠ¡\n1@Service 2public class DCCService { 3 4 /** 5 * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯ 6 */ 7 @DCCValue(\"downgradeSwitch:0\") 8 private String downgradeSwitch; 9 10 @DCCValue(\"cutRange:100\") 11 private String cutRange; 12 13 public boolean isCutRange(String userId) { 14 // è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼ 15 int hashCode = Math.abs(userId.hashCode()); 16 17 // è·å–æœ€åä¸¤ä½ 18 int lastTwoDigits = hashCode % 100; 19 20 // åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†… 21 if (lastTwoDigits \u003c= Integer.parseInt(cutRange)) { 22 log.error(cutRange); 23 return true; 24 } 25 26 return false; 27 } 28 29 public boolean isDowngradeSwitch() { 30 return this.downgradeSwitch.equals(\"1\"); 31 } 32} â­æ³¨æ„ï¼šåœ¨SwitchNodeä¸­ï¼Œè°ƒç”¨è¿™äº›æ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ”¾è¡Œ\nåŸºäºRedisçš„å‘å¸ƒè®¢é˜…è¿›è¡Œå‚æ•°è°ƒæ•´\n1/ DCCValueBeanFactory implements BeanPostProcessor 2private static final String BASE_CONFIG_PATH = \"group_buy_market_dcc_\"; 3 4private final RedissonClient redissonClient; 5 6private final Map\u003cString, Object\u003e dccObjGroup = new HashMap\u003c\u003e(); 7 8public DCCValueBeanFactory(RedissonClient redissonClient) { 9 this.redissonClient = redissonClient; 10} 11 12@Bean(\"dccTopic\") 13public RTopic dccRedisTopicListener(RedissonClient redissonClient) { 14 log.info(\"åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}\", redissonClient.getBucket(\"test\").get()); 15 // å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç° 16 RTopic topic = redissonClient.getTopic(\"group_buy_market_dcc\"); 17 // æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯ 18 topic.addListener(String.class, ((charSequence, s) -\u003e { 19 log.info(\"ç›‘å¬åˆ°Redis Topicï¼š {}\", charSequence.toString()); 20 String[] split = s.split(Constants.SPLIT); 21 22 // è·å–å€¼ 23 String attribute = split[0]; 24 String key = BASE_CONFIG_PATH + attribute; 25 String value = split[1]; 26 27 // è®¾ç½®å€¼ =\u003e å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ 28 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 29 boolean exists = bucket.isExists(); 30 if (!exists) return; 31 bucket.set(value); 32 33 Object objBean = dccObjGroup.get(key); // è·å–å†…å­˜ä¸­çš„å¯¹è±¡ 34 if (objBean == null) return; 35 36 Class\u003c?\u003e objBeanClass = objBean.getClass(); 37 // æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ 38 if (AopUtils.isAopProxy(objBean)) { 39 objBeanClass = AopUtils.getTargetClass(objBean); 40 } 41 42 try { 43 Field field = objBeanClass.getDeclaredField(attribute); 44 field.setAccessible(true); 45 field.set(objBean, value); 46 field.setAccessible(false); 47 48 log.info(\"DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}\", key,value); 49 } catch (Exception e) { 50 throw new RuntimeException(e); 51 } 52 53 })); 54 return topic; 55} 56 57 58// implements BeanPostProcessor é‡å†™æ–¹æ³• -- å¹¶åœ¨æ¯ä¸ª bean åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚ 59@Override 60public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { 61 // æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº† 62 Class\u003c?\u003e targetBeanClass = bean.getClass(); 63 Object targetBeanObject = bean; 64 if (AopUtils.isAopProxy(targetBeanObject)) { 65 targetBeanClass = AopUtils.getTargetClass(targetBeanObject); 66 targetBeanObject = AopProxyUtils.getSingletonTarget(bean); 67 } 68\t69 // è¿™é‡Œåˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰å¯¹åº”çš„è‡ªå®šä¹‰æ³¨è§£ 70 Field[] fields = targetBeanClass.getDeclaredFields(); 71 for (Field field : fields) { 72 if (!field.isAnnotationPresent(DCCValue.class)) { 73 continue; 74 } 75 76 DCCValue dccValue = field.getAnnotation(DCCValue.class); 77 String value = dccValue.value(); 78 if (StringUtils.isBlank(value)) { 79 throw new RuntimeException(field.getName() + \"@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€\"); 80 } 81 82 String[] split = value.split(\":\"); 83 String key = BASE_CONFIG_PATH.concat(split[0]); 84 String defaultValue = split[1]; 85 86 String setValue = defaultValue; 87 88 try { 89 if (StringUtils.isBlank(defaultValue)) { 90 throw new RuntimeException(\"dcc config error \" + key + \" is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼\"); 91 } 92 93 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 94 boolean exists = bucket.isExists(); 95 if (!exists) { 96 bucket.set(defaultValue); 97 } else { 98 setValue = bucket.get(); 99 } 100 101 field.setAccessible(true); 102 field.set(targetBeanObject, setValue); 103 field.setAccessible(false); 104 log.info(\"åˆå§‹åŒ–å€¼ key:{} value:{}\", key, setValue); 105 } catch (IllegalAccessException e) { 106 throw new RuntimeException(e); 107 } 108 109 dccObjGroup.put(key, targetBeanObject); 110 } 111 return bean; 112} å®ç°Apiæ¥å£æ›´æ–°Redisä¸­çš„å€¼\n1@Override 2@GetMapping(\"update_config\") 3public Response\u003cBoolean\u003e updateConfig(@RequestParam String key, @RequestParam String value) { 4 try { 5 log.info(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}\", key, value); 6 dccTopic.publish(key + \",\" + value); 7 return Response.\u003cBoolean\u003ebuilder() 8 .code(ResponseCode.SUCCESS.getCode()) 9 .info(ResponseCode.SUCCESS.getInfo()) 10 .build(); 11 } catch (Exception e) { 12 log.error(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}\", key, value, e.getMessage()); 13 return Response.\u003cBoolean\u003ebuilder() 14 .code(ResponseCode.UN_ERROR.getCode()) 15 .info(ResponseCode.UN_ERROR.getInfo()) 16 .build(); 17 } 18} æ›´æ–°è¯·æ±‚ =\u003e Redis =\u003e è®¢é˜…æœåŠ¡ =\u003e ä¿®æ”¹å‚æ•°\n",
  "wordCount" : "2706",
  "inLanguage": "en",
  "image": "http://longcoding.top/papermod-cover.png","datePublished": "2025-03-11T16:45:11+08:00",
  "dateModified": "2025-03-11T16:45:11+08:00",
  "author":{
    "@type": "Person",
    "name": "ğŸ‘¨ğŸ»â€ğŸ“ LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://longcoding.top/posts/jobs/java_project_highlight/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://longcoding.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://longcoding.top/" accesskey="h" title="ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“° (Alt + H)">
                <img src="http://longcoding.top/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://longcoding.top/index.html" title="ğŸ¡ Home">
                    <span>ğŸ¡ Home</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/archives/" title="ğŸ“ƒ Archives">
                    <span>ğŸ“ƒ Archives</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/tags/" title="ğŸ“‘ Tags">
                    <span>ğŸ“‘ Tags</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/categories/" title="ğŸ—’ï¸ Categories">
                    <span>ğŸ—’ï¸ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/search/" title="ğŸ” Search">
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/about/" title="ğŸ‘¨ğŸ»â€ğŸ“ About Me">
                    <span>ğŸ‘¨ğŸ»â€ğŸ“ About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://longcoding.top/">Home</a>&nbsp;Â»&nbsp;<a href="http://longcoding.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      é¡¹ç›®é‡éš¾ç‚¹
    </h1>
    <div class="post-description">
      ç®€å†é¡¹ç›®é‡éš¾ç‚¹
    </div>
    <div class="post-meta"><span title='2025-03-11 16:45:11 +0800 CST'>March 11, 2025</span>&nbsp;Â·&nbsp;13 min&nbsp;Â·&nbsp;2706 words&nbsp;Â·&nbsp;ğŸ‘¨ğŸ»â€ğŸ“ LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%bb%91%e9%a9%ac%e7%82%b9%e8%af%84" aria-label="é»‘é©¬ç‚¹è¯„ï¼š">é»‘é©¬ç‚¹è¯„ï¼š</a><ul>
                        
                <li>
                    <a href="#%e7%99%bb%e5%bd%95%e7%9b%b8%e5%85%b3" aria-label="ç™»å½•ç›¸å…³">ç™»å½•ç›¸å…³</a></li>
                <li>
                    <a href="#%e8%b6%85%e5%8d%96%e9%97%ae%e9%a2%98" aria-label="è¶…å–é—®é¢˜ï¼š">è¶…å–é—®é¢˜ï¼š</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%ba%e4%b8%80%e5%8d%95%e9%97%ae%e9%a2%98" aria-label="ä¸€äººä¸€å•é—®é¢˜ï¼š">ä¸€äººä¸€å•é—®é¢˜ï¼š</a></li>
                <li>
                    <a href="#%e4%bc%98%e6%83%a0%e5%8d%b7%e7%a7%92%e6%9d%80" aria-label="ä¼˜æƒ å·ç§’æ€">ä¼˜æƒ å·ç§’æ€</a></li>
                <li>
                    <a href="#%e7%bc%93%e5%ad%98%e4%b8%89%e5%85%84%e5%bc%9f" aria-label="ç¼“å­˜ä¸‰å…„å¼Ÿï¼š">ç¼“å­˜ä¸‰å…„å¼Ÿï¼š</a></li>
                <li>
                    <a href="#redismysql%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7" aria-label="Redis&amp;MySQLæ•°æ®ä¸€è‡´æ€§">Redis&amp;MySQLæ•°æ®ä¸€è‡´æ€§</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%ae%e7%82%b9%e6%a8%a1%e5%9d%97" aria-label="äº®ç‚¹æ¨¡å—ï¼š">äº®ç‚¹æ¨¡å—ï¼š</a><ul>
                        
                <li>
                    <a href="#rabbitmq" aria-label="RabbitMQ">RabbitMQ</a><ul>
                        
                <li>
                    <a href="#%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86" aria-label="å¼‚æ­¥å¤„ç†">å¼‚æ­¥å¤„ç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93" aria-label="æ‹¼å›¢äº¤æ˜“">æ‹¼å›¢äº¤æ˜“</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e8%b4%a3%e4%bb%bb%e9%93%be%e6%a8%a1%e6%9d%bf" aria-label="æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿">æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿</a></li>
                <li>
                    <a href="#%e8%b4%a3%e4%bb%bb%e9%93%be%e5%ae%9e%e7%8e%b0%e4%b8%9a%e5%8a%a1%e7%ae%a1%e9%81%93" aria-label="è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“">è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“</a></li>
                <li>
                    <a href="#aop%e6%b6%88%e6%81%af%e8%ae%a2%e9%98%85%e5%ae%9e%e7%8e%b0%e7%83%ad%e6%9b%b4%e6%96%b0" aria-label="AOP&#43;æ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–°">AOP+æ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–°</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><hr>
<h3 id="é»‘é©¬ç‚¹è¯„">é»‘é©¬ç‚¹è¯„ï¼š<a hidden class="anchor" aria-hidden="true" href="#é»‘é©¬ç‚¹è¯„">#</a></h3>
<h4 id="ç™»å½•ç›¸å…³">ç™»å½•ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#ç™»å½•ç›¸å…³">#</a></h4>
<ul>
<li>ä½¿ç”¨ JWT å®ç°æ— çŠ¶æ€è®¤è¯ï¼Œç™»å½•æˆåŠŸåç”Ÿæˆä¸€ä¸ªåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ Token è¿”å›ç»™å‰ç«¯ï¼Œç”±å‰ç«¯æ¯æ¬¡è¯·æ±‚æ—¶æºå¸¦åœ¨è¯·æ±‚å¤´ä¸­ã€‚åç«¯é€šè¿‡æ‹¦æˆªå™¨ç»Ÿä¸€æ‹¦æˆªè¯·æ±‚ï¼Œè§£æå¹¶æ ¡éªŒ Token çš„åˆæ³•æ€§ã€‚</li>
</ul>
<p>&lt;ç”¨æˆ·ä¿¡æ¯åªåŒ…æ‹¬ï¼šuserIdï¼Œusernameï¼Œroleç­‰å¿…è¦ä¿¡æ¯ =&gt; å®‰å…¨&gt;</p>
<ul>
<li>
<p>æ ¡éªŒé€šè¿‡åï¼Œæˆ‘ä»¬ä¼šå°†è§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° <code>ThreadLocal</code> ä¸­ï¼Œæ„å»ºä¸€ä¸ªçº¿ç¨‹çº§çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†æµç¨‹ä¸­éƒ½å¯ä»¥æ–¹ä¾¿åœ°è·å–å½“å‰ç™»å½•ç”¨æˆ·ï¼Œé¿å…å±‚å±‚ä¼ å‚ï¼Œæå‡ä»£ç æ•´æ´åº¦å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
</li>
<li>
<p>ThreadLocalåŸç†ï¼šæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„ThreadLocalMapå¯¹è±¡ã€‚æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ª <code>ThreadLocal</code> å¯¹è±¡ä½œä¸ºé”®ï¼Œä½†å€¼äº’ä¸å½±å“ã€‚é€šè¿‡çº¿ç¨‹çº§åˆ«çš„å˜é‡éš”ç¦»ï¼Œé¿å…å¤šçº¿ç¨‹ç«äº‰ï¼Œå®ç°çº¿ç¨‹å®‰å…¨ã€‚</p>
</li>
</ul>
<h4 id="è¶…å–é—®é¢˜">è¶…å–é—®é¢˜ï¼š<a hidden class="anchor" aria-hidden="true" href="#è¶…å–é—®é¢˜">#</a></h4>
<ol>
<li><em><strong>æ•°æ®åº“å±‚é¢ï¼š</strong></em>
<ul>
<li><em><strong>æ‚²è§‚é”ï¼ˆFOR UPDATE-è¡Œé”ï¼‰</strong></em></li>
<li><em><strong>ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·æ³•ï¼‰</strong></em></li>
</ul>
</li>
<li><em><strong>åº”ç”¨å±‚é¢ï¼š</strong></em>
<ul>
<li><em><strong>åˆ†å¸ƒå¼é”ï¼ˆäº’æ–¥ï¼‰</strong></em></li>
<li><em><strong>ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ—</strong></em></li>
<li><em><strong>é™æµ+ç†”æ–­</strong></em></li>
</ul>
</li>
</ol>
<p><em><strong>1.1 è¡Œé”</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">BEGIN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">-- ä¸šåŠ¡é€»è¾‘ï¼šæ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œæ‰§è¡Œæ‰£å‡æ“ä½œ
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="k">COMMIT</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š791.2/sec       äº’æ–¥é”ï¼Œä¸²è¡Œè®¿é—®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseMapper</span><span class="p">.</span><span class="na">selectSecKillStockForUpdate</span><span class="p">(</span><span class="n">voucherId</span><span class="p">);</span><span class="w"> </span><span class="c1">// FordateåŠ è¡Œé”ï¼Œäº‹åŠ¡ç»“æŸä¼šé‡Šæ”¾</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;fail&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>1.2 CASæ–¹æ³•</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š944.7/sec</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// æ³¨æ„æŠŠStockä¸æ»¡è¶³æ¡ä»¶çš„è¿‡æ»¤ï¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">// è¿™ä¸ªå¾ˆå…³é”® ä¸è¦ä½¿ç”¨ set(::getStock, stock-1) é”™è¯¯åŸå› ï¼šåŸºäºåº”ç”¨å±‚è®¡ç®—çš„å€¼ï¼Œè€Œä¸æ˜¯æ•°æ®åº“çš„å½“å‰å€¼ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">gt</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// eq(::getStock, stock) </span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>â­â­â­ MVCC(ç‰ˆæœ¬é“¾+ReadView)  - è¯»æ“ä½œè€Œè¨€</p>
<ul>
<li><strong>äº‹åŠ¡ B çš„æ›´æ–°æ“ä½œ</strong>ï¼š
<ul>
<li>æ›´æ–°æ“ä½œä¼šç›´æ¥æ“ä½œæ•°æ®åº“çš„å½“å‰å€¼ï¼Œè€Œä¸æ˜¯åŸºäºäº‹åŠ¡ B çš„ ReadViewã€‚</li>
<li>äº‹åŠ¡ B çš„æ›´æ–°æ“ä½œä¼šæ£€æŸ¥æ•°æ®åº“çš„å½“å‰å€¼ï¼Œå‘ç° <code>stock = 0</code>ï¼Œå› æ­¤æ›´æ–°å¤±è´¥ã€‚</li>
</ul>
</li>
</ul>
<p><em><strong>2.1 ğŸ·ï¸ JVMé”ï¼ˆå•ä½“ï¼‰ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// è¯¥æ–¹æ³•æ¯æ¬¡åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œäº’æ–¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">VoucherOrderService</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">	</span><span class="c1">// æŸ¥ </span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="c1">// æ”¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">    
</span></span></span></code></pre></div><p>10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š715.5/sec       äº’æ–¥é”ï¼Œä¸²è¡Œè®¿é—®</p>
<p><em><strong>2.2 ğŸ·ï¸åˆ†å¸ƒå¼é”ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// seckill_key = &#34;seckill:product:1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// =Luaè„šæœ¬(åˆ¤æ–­+æ‰£å‡)=&gt; å†å¤„ç†MySQL   // åŸå­åŒ–æŸ¥è¯¢+ä¿®æ”¹ </span><span class="w">
</span></span></span></code></pre></div><p><em><strong>2.3 ğŸ·ï¸ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ— ï¼ˆæœåŠ¡è§£è€¦ï¼‰:</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// åº“å­˜åˆå§‹åŒ–ï¼šå°†MySQLå•†å“åº“å­˜å­˜å…¥Redisä¸­ï¼Œæå‡æŸ¥è¯¢å’Œæ‰£å‡æ•ˆç‡;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// åº“å­˜é¢„æ‰£å‡(Redis)ï¼šç”¨æˆ·è¯·æ±‚æ—¶ï¼Œå…ˆåœ¨ Redis ä¸­æ‰£å‡åº“å­˜;  == Luaè„šæœ¬</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">Long</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">SECKILL_SCRIPT</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">exchangerName</span><span class="p">,</span><span class="w"> </span><span class="n">routingKey</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// è®¢å•å¼‚æ­¥å¤„ç†(MQ):æ‰£å‡æˆåŠŸ =&gt; MQ =&gt; è®¢å•å¤„ç†æ¥å£ =&gt; Redis&amp;MySQLä¸€è‡´ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;voucherId&#34;</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>10000æ¡(10çº¿ç¨‹å¾ªç¯1000æ¬¡)è¯·æ±‚ï¼Œååé‡ï¼š1485.7/sec</p>
<p>ğŸ·ï¸<em><strong>é™æµ+ç†”æ–­</strong></em>: ï¼ˆä»…ç†è®ºï¼‰</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. Nginxé™æµ(æœ€åŸºç¡€ï¼Œæ‹¦æˆªæ¶æ„æµé‡)  - åªé’ˆå¯¹IP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">http</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">limit_req_zone</span><span class="w"> </span><span class="n">$binary_remote_addr</span><span class="w"> </span><span class="n">zone</span><span class="o">=</span><span class="n">mylimit</span><span class="p">:</span><span class="n">10m</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="n">100r</span><span class="o">/</span><span class="n">s</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">seckill</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="n">limit_req</span><span class="w"> </span><span class="n">zone</span><span class="o">=</span><span class="n">mylimit</span><span class="w"> </span><span class="n">burst</span><span class="o">=</span><span class="n">50</span><span class="w"> </span><span class="n">nodelay</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//backend;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 2. Redisä»¤ç‰Œæ¡¶(åº”ç”¨å±‚ç”¨æˆ·çº§é™æµï¼Œç²¾å‡†æ§åˆ¶)</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// def try_acquire_token(user_id, rate=5, capacity=10):</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">bucket_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s">&#34;token_bucket:{user_id}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">last_time_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s">&#34;last_time:{user_id}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// ä¸‹é¢éœ€è¦ä¸ºluaè„šæœ¬  ====</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="na">time</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">last_time_key</span><span class="p">)</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_time</span><span class="w">    
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">è®¡ç®—è¡¥å……çš„ä»¤ç‰Œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="n">tokens_to_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">elapsed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="n">current_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bucket_key</span><span class="p">)</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tokens_to_add</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">current_tokens</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">bucket_key</span><span class="p">,</span><span class="w"> </span><span class="n">current_tokens</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">æ¶ˆè€—</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="n">ä¸ªä»¤ç‰Œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">last_time_key</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">æ›´æ–°æ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">True</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">False</span><span class="w">    
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="c1">//  ====</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="c1">// 3. å‰ç«¯æ’é˜Ÿ(å‡å°‘æ— æ•ˆè¯·æ±‚ï¼Œé¿å…ä¸€çªèœ‚æ¶Œå…¥)</span><span class="w">
</span></span></span></code></pre></div><h4 id="ä¸€äººä¸€å•é—®é¢˜">ä¸€äººä¸€å•é—®é¢˜ï¼š<a hidden class="anchor" aria-hidden="true" href="#ä¸€äººä¸€å•é—®é¢˜">#</a></h4>
<p><em><strong>ï¼ˆé¦–å…ˆä¸èƒ½é‡å¤ä¸‹å•ï¼Œè¿˜è¦æ‰£å‡åº“å­˜ï¼Œå¹¶ä¸”æ–°å¢è®¢å•ï¼‰</strong></em></p>
<ul>
<li>
<p>**<em>å•ä½“æ¶æ„</em> **</p>
<ul>
<li>*** Redis-Luaè„šæœ¬åŸå­åŒ–æŸ¥è¯¢åº“å­˜+é‡å¤ä¸‹å•***</li>
<li><em><strong>synchronizedåŠ é”</strong></em> - UserId.toString().intern() å­—ç¬¦ä¸²å¸¸é‡æ± å¼•ç”¨</li>
</ul>
</li>
<li>
<p><em><strong>é›†ç¾¤æ¶æ„</strong></em></p>
<ul>
<li><em><strong>åˆ†å¸ƒå¼é”å®ç°</strong></em></li>
</ul>
</li>
</ul>
<p><em><strong>1.1 ğŸ·ï¸Rediså®ç°ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">if</span> <span class="p">(</span><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sadd&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1">-- ï¼ï¼ï¼åˆå§‹åŒ–éœ€è¦ä»MySQLä¸­åŠ è½½å·²ç»ä¹°è¿‡çš„ç”¨æˆ·</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kr">return</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kr">if</span> <span class="p">(</span><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sismember&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="n">userId</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kr">return</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sadd&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="n">userId</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">-- åœ¨Redisä¸­ï¼Œä½¿ç”¨Seté›†åˆå­˜å‚¨ä¹°è¿‡çš„ç”¨æˆ·</span>
</span></span></code></pre></div><p><em><strong>1.2 ğŸ·ï¸JVMé”+MySQLå®ç°ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">seckillVoucherMySQLAndMQUnique</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">oneOpt</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;å·²ç»å–å®Œäº†ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">intern</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">transactionPostChannel</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transactionPostChannel</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voucherOrderService</span><span class="p">.</span><span class="na">findVoucherOrderByUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;æ‚¨ä¹°è¿‡äº†ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;MySQLåº“å­˜æ›´æ–°å¤±è´¥&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="n">VoucherOrder</span><span class="w"> </span><span class="n">voucherOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VoucherOrder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="n">voucherOrder</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="n">voucherOrder</span><span class="p">.</span><span class="na">setVoucherId</span><span class="p">(</span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voucherOrderService</span><span class="p">.</span><span class="na">setVoucherOrder</span><span class="p">(</span><span class="n">voucherOrder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;MySQLæ’å…¥å¤±è´¥&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="c1">// ä¸‹é¢åªä½¿ç”¨ä¸€ä¸ª@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">seckillVoucherMySQLAndMQUnique</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">oneOpt</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;å·²ç»å–å®Œäº†ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">intern</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="n">VoucherSecKillService</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VoucherSecKillService</span><span class="p">)</span><span class="w"> </span><span class="n">AopContext</span><span class="p">.</span><span class="na">currentProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">transactionPostChannel</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w"></span><span class="c1">//â­â­â­åµŒå¥—æ‰§è¡Œæ–¹æ³•ï¼Œä¸”ä¸»æ–¹æ³•æ²¡æœ‰@Transactionalï¼Œéœ€è¦ä»£ç†å¯¹è±¡æ¥æ‰§è¡Œæ‰èƒ½ä½¿ä¸šåŠ¡ç”Ÿæ•ˆ</span><span class="w">
</span></span></span></code></pre></div><p>ğŸ·ï¸1 <em><strong>synchronized</strong></em> é”çš„ç²’åº¦é™çº§äº†ï¼Œå˜ä¸ºå½“å‰ç”¨æˆ·Id ã€userId.toString().intern() æ·»åŠ åˆ°å¸¸é‡æ± ï¼Œå¹¶è¿”å›å¸¸é‡æ± çš„å¼•ç”¨ã€‘ âŒâŒâŒ<strong>è¿™é‡Œé”çš„å•æœºï¼Œå¤šä¸ªJVMçš„æƒ…å†µä¸‹ï¼Œå°±å¯„äº†</strong></p>
<p>ğŸ·ï¸2 VoucherSecKillService o = (VoucherSecKillService) <strong>AopContext.currentProxy()</strong>;  æ‹¿åˆ°æ‰§è¡Œäº‹åŠ¡çš„ä»£ç†å¯¹è±¡</p>
<p>ğŸ·ï¸3  boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); <strong>éœ€è¦æŠŠæ˜¯å¦ä¸‹å•é”ä½</strong>ï¼Œå¦åˆ™ï¼Œå¯èƒ½é‡å¤ä¸‹å•ï¼Œå› ä¸ºè¿™ä¸ªæ¡ä»¶å¯èƒ½å¤šä¸ªçº¿ç¨‹åŒæ—¶æ»¡è¶³ï¼ï¼ï¼</p>
<p><em><strong>2.1 ğŸ·ï¸åˆ†å¸ƒå¼é”ç°å®</strong></em></p>
<p>è§£å†³å•æœºJVMé”ï¼Œåœ¨é›†ç¾¤ä¸‹å¤±æ•ˆçš„é—®é¢˜ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">-- ä¸Šé”ï¼Œåˆ†å¸ƒå¼çš„</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="err">ä¸å­˜åœ¨</span><span class="p">:</span><span class="err">åˆ›å»ºå¹¶è¿”å›</span><span class="n">True</span>
</span></span></code></pre></div><p>ä¸šåŠ¡ =&gt; æ‰£åº“å­˜ + åˆ›å»ºè®¢å•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">-- è§£é”ï¼Œåˆ†å¸ƒå¼ï¼Œåªèƒ½è§£é”è‡ªå·±ä¸Šçš„é”</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">//</span> <span class="err">å¦‚æœå¯ä»¥é‡Šæ”¾åˆ«äººçš„é”ï¼Œä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µ</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="o">//</span> <span class="err">äº‹åŠ¡</span><span class="n">Açš„é”è¿‡æœŸé‡Šæ”¾äº†</span><span class="p">(</span><span class="err">è¿™é‡Œæ²¡æœ‰ç»­æ—¶é—´</span><span class="n">oræš‚æ—¶å¡äº†</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">äº‹åŠ¡</span><span class="n">BåŠ é”</span> <span class="o">=&gt;</span> <span class="err">äº‹åŠ¡</span><span class="n">Aæ´»äº†è¿‡æ¥</span><span class="o">*</span><span class="err">è§£é”</span><span class="o">*</span> <span class="o">=&gt;</span> <span class="err">äº‹åŠ¡</span><span class="n">CåŠ é”</span> <span class="p">...</span> 
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="err">äº‹åŠ¡</span><span class="n">Bå’ŒCæ‹¿äº†åŒä¸€æŠŠé”</span><span class="err">ï¼Œå¯„äº†</span>  <span class="o">=&gt;</span> <span class="err">åªå…è®¸åˆ è‡ªå·±åŠ çš„é”</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="err">äº‹åŠ¡</span><span class="n">Aå’ŒBæ‹¿äº†åŒä¸€æŠŠé”</span><span class="err">ï¼Œå¯„äº†</span>  <span class="o">=&gt;</span> <span class="err">çœ‹é—¨ç‹—ç»­æ—¶é—´</span>
</span></span></code></pre></div><p><em><strong>luaè„šæœ¬</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Boolean</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">setIfAbsent</span><span class="p">(</span><span class="n">lock_key</span><span class="p">,</span><span class="w"> </span><span class="n">lock_value</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">	</span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">SECKILL_UNLOCK_SCRIPT</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">lock_key</span><span class="p">),</span><span class="w"> </span><span class="n">lock_value</span><span class="p">);</span><span class="w"> </span><span class="c1">// åˆ é™¤é”å’Œåˆ¤æ–­é”æ˜¯å¦å½“å‰çº¿ç¨‹æ‹¥æœ‰ åŸå­åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">    
</span></span></span></code></pre></div><p><em><strong>Redission</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">lock_key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">  </span><span class="c1">// ä¸é˜»å¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">  </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">  </span><span class="c1">// é˜»å¡,ä¸”æœªæŒ‡å®šè¿‡æœŸæ—¶é—´ =&gt; è§¦å‘çœ‹é—¨ç‹—</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">  </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æœ€å¼€å§‹æˆ‘ä»¬çš„é‡åˆ°è‡ªå¢IDé—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°åˆ†å¸ƒå¼IDè§£å†³äº†é—®é¢˜ï¼›åé¢æˆ‘ä»¬åœ¨<strong>å•ä½“ç³»ç»Ÿ</strong>ä¸‹é‡åˆ°äº†<strong>ä¸€äººå¤šå•è¶…å–</strong>é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡<strong>ä¹è§‚é”/æ‚²è§‚é”</strong>è§£å†³äº†ï¼›æˆ‘ä»¬å¯¹ä¸šåŠ¡è¿›è¡Œäº†å˜æ›´ï¼Œå°†ä¸€äººå¤šå•å˜æˆäº†<strong>ä¸€äººä¸€å•</strong>ï¼Œç»“æœåœ¨<strong>é«˜å¹¶å‘</strong>åœºæ™¯ä¸‹åŒä¸€ç”¨æˆ·å‘é€ç›¸åŒè¯·æ±‚ä»ç„¶å‡ºç°äº†è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡<strong>æ‚²è§‚é”</strong>è§£å†³äº†ï¼›ç”±äºç”¨æˆ·é‡çš„æ¿€å¢ï¼Œæˆ‘ä»¬å°†å•ä½“ç³»ç»Ÿå‡çº§æˆäº†<strong>é›†ç¾¤</strong>ï¼Œç»“æœç”±äº<strong>é”åªèƒ½åœ¨ä¸€ä¸ªJVMä¸­å¯è§</strong>å¯¼è‡´åˆå‡ºç°äº†ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹åŒä¸€ç”¨æˆ·å‘é€ä¸‹å•è¯·æ±‚å‡ºç°è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å®ç°<strong>åˆ†å¸ƒå¼é”</strong>æˆåŠŸè§£å†³é›†ç¾¤ä¸‹çš„<strong>è¶…å–</strong>é—®é¢˜ï¼›é‡Šæ”¾é”æ—¶ï¼Œ<strong>åˆ¤æ–­é”æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ å’Œ åˆ é™¤é”ä¸¤ä¸ªæ“ä½œ</strong>ä¸æ˜¯åŸå­æ€§çš„ï¼Œå¯èƒ½å¯¼è‡´è¶…å–é—®é¢˜ï¼Œæˆ‘ä»¬é€šè¿‡å°†ä¸¤ä¸ªæ“ä½œå°è£…åˆ°ä¸€ä¸ª<strong>Luaè„šæœ¬</strong>æˆåŠŸè§£å†³äº†ï¼›</p>
<p>ä¸ºäº†è§£å†³é”çš„ä¸å¯é‡å…¥æ€§ï¼Œæˆ‘ä»¬é€šè¿‡å°†é”ä»¥hashç»“æ„çš„å½¢å¼å­˜å‚¨ï¼Œæ¯æ¬¡é‡Šæ”¾é”éƒ½value-1ï¼Œè·å–é”value+1ï¼Œä»è€Œå®ç°é”çš„å¯é‡å…¥æ€§ï¼Œå¹¶ä¸”å°†é‡Šæ”¾é”å’Œè·å–é”çš„æ“ä½œå°è£…åˆ°Luaè„šæœ¬ä¸­ä»¥ç¡®ä¿åŸå­æ€§ã€‚</p>
<p>æœ€æœ€åï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥ç›´æ¥ä½¿ç”¨ç°æœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆRedissonæ¥è§£å†³ä¸Šè¯‰å‡ºç°çš„æ‰€æœ‰é—®é¢˜ğŸ¤£ï¼Œä»€ä¹ˆä¸å¯é‡è¯•ã€ä¸å¯é‡å…¥ã€è¶…å¸‚é‡Šæ”¾ã€åŸå­æ€§ç­‰é—®é¢˜Redissonéƒ½æä¾›ç›¸å¯¹åº”çš„è§£å†³æ–¹æ³•ï¼ˆã€‚ï¼¾â–½ï¼¾ï¼‰</p>
<h4 id="ä¼˜æƒ å·ç§’æ€">ä¼˜æƒ å·ç§’æ€<a hidden class="anchor" aria-hidden="true" href="#ä¼˜æƒ å·ç§’æ€">#</a></h4>
<p>å¼‚æ­¥ä¸‹å•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ä¸»çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">1</span><span class="p">.</span><span class="w"> </span><span class="n">Luaè„šæœ¬</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">2</span><span class="p">.</span><span class="w"> </span><span class="n">æˆåŠŸ</span><span class="o">=&gt;</span><span class="n">æ”¾å…¥é˜Ÿåˆ—</span><span class="err">ï¼›</span><span class="n">å¤±è´¥</span><span class="o">=&gt;</span><span class="n">è¿”å›å¼‚å¸¸</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">1</span><span class="p">.</span><span class="na">1</span><span class="p">.</span><span class="w"> </span><span class="n">Luaè„šæœ¬</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">åº“å­˜</span><span class="w"> </span><span class="o">=</span><span class="n">æ‰£åº“å­˜</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">æ˜¯å¦ä¸‹å•</span><span class="w"> </span><span class="o">=</span><span class="n">è®°å½•ç”¨æˆ·ä¸‹å•</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">è¿”å›0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">               </span><span class="n">è¿”å›1</span><span class="w">            </span><span class="n">è¿”å›2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// å­çº¿ç¨‹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">é˜Ÿåˆ—ä¸­å–å‡ºè®¢å•ä¿¡æ¯</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">æ‰£å‡å·åº“å­˜</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">æ˜¯å¦ä»˜æ¬¾</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">æ›´æ–°æˆåŠŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                            </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">End</span><span class="w">
</span></span></span></code></pre></div><img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250316232011370.png" alt="image-20250316232011370" style="zoom:50%;" />
<h4 id="ç¼“å­˜ä¸‰å…„å¼Ÿ">ç¼“å­˜ä¸‰å…„å¼Ÿï¼š<a hidden class="anchor" aria-hidden="true" href="#ç¼“å­˜ä¸‰å…„å¼Ÿ">#</a></h4>
<p>ğŸ’¡<em><strong>ç¼“å­˜ç©¿é€</strong></em>ï¼š æ¶æ„è¯·æ±‚æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç»•è¿‡ç¼“å­˜ç›´æ¥è®¿é—®æ•°æ®åº“</p>
<p><img alt="image-20241121195359815" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121195359815.png"></p>
<ul>
<li><em><strong>å¸ƒéš†è¿‡æ»¤å™¨</strong></em></li>
</ul>
<ol>
<li>å•†å“IDï¼Œé€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œå°†å…ƒç´ æ˜ å°„åˆ°bitMapä¸­çš„å¤šä¸ªä½ç½®ï¼Œåªæœ‰æ¯ä¸ªä½ç½®éƒ½ä¸º1æ‰è¡¨æ˜è¿™ä¸ªå¯¹è±¡å­˜åœ¨ã€‚</li>
<li>guavaåº“æœ‰å®ç°å¥½çš„ï¼Œç›´æ¥ç”¨ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># ä¼ªä»£ç ï¼Œä»…ä¾›å­¦ä¹ </span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">BloomFilter</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s2">        åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s2">        :param size: ä½æ•°ç»„å¤§å°ï¼ˆmï¼‰
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s2">        :param hash_count: å“ˆå¸Œå‡½æ•°æ•°é‡ï¼ˆkï¼‰
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span> <span class="o">=</span> <span class="n">hash_count</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>  <span class="c1"># åˆå§‹åŒ–ä½æ•°ç»„ï¼ˆå…¨0ï¼‰</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s2">        æ·»åŠ å…ƒç´ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="c1"># é€šè¿‡ä¸åŒçš„ç§å­æ¨¡æ‹Ÿå¤šä¸ªå“ˆå¸Œå‡½æ•°</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># è®¾ç½®å¯¹åº”ä½ä¸º1</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="s2">        æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="s2">        :return: 
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="s2">            - True: å¯èƒ½å­˜åœ¨ï¼ˆå¯èƒ½æœ‰è¯¯åˆ¤ï¼‰
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="s2">            - False: ä¸€å®šä¸å­˜åœ¨
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># åªè¦æœ‰ä¸€ä½ä¸º0ï¼Œåˆ™ä¸€å®šä¸å­˜åœ¨</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># æ‰€æœ‰ä½å‡ä¸º1ï¼Œå¯èƒ½å­˜åœ¨</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="s2">        å“ˆå¸Œå‡½æ•°ï¼ˆä¼ªä»£ç ï¼Œå®é™…å¯ç”¨MurmurHashç­‰ï¼‰
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="s2">        :param item: è¾“å…¥å…ƒç´ 
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="s2">        :param seed: å“ˆå¸Œç§å­ï¼ˆæ¨¡æ‹Ÿä¸åŒå“ˆå¸Œå‡½æ•°ï¼‰
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="s2">        :return: å“ˆå¸Œå€¼
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">hash_value</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">            <span class="n">hash_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">*</span> <span class="n">seed</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="k">return</span> <span class="n">hash_value</span>
</span></span></code></pre></div><ul>
<li><em><strong>ç¼“å­˜ç©ºå¯¹è±¡</strong></em></li>
</ul>
<p><em>ğŸ·ï¸ ç¼“å­˜ç©ºå¯¹è±¡å®ç°æ–¹æ¡ˆ</em></p>
<p><img alt="image-20241121195847292" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121195847292.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ç¼“å­˜å‘½ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// ä¸ä¸ºnullï¼Œä¸ä¸º&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">SeckillVoucher</span><span class="w"> </span><span class="n">seckillVoucher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">SeckillVoucher</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// æœªå‘½ä¸­ï¼Œæ˜¯å¦æ˜¯ä¹‹å‰ç¼“å­˜çš„ç©ºå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">nonNull</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &#34;&#34; ä¸ä¸ºnull</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;æŸ¥è¯¢ç¼“å­˜ç©ºå¯¹è±¡ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">SeckillVoucher</span><span class="w"> </span><span class="n">seckillVoucher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">one</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// ç¼“å­˜ç©ºå¯¹è±¡ ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜å°±å¥½</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">CacheTestService</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">nonNull</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;æŸ¥è¯¢ç¼“å­˜ç©ºå¯¹è±¡ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">isNull</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ç¼“å­˜ç©ºå¯¹è±¡ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// ç¼“å­˜é‡å»º</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">),</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>ğŸ’¡<em><strong>ç¼“å­˜é›ªå´©</strong></em>ï¼šé‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚å…¨éƒ¨å‹åˆ°æ•°æ®åº“</p>
<p><img alt="image-20241121201618172" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121201618172.png"></p>
<ul>
<li>è¿‡æœŸæ—¶é—´éšæœºåŒ– â­â­â­ baseline + random_offset</li>
<li>Hotæ•°æ®<strong>å®šæ—¶</strong>åˆ·æ–°ç¼“å­˜  @Scheduled</li>
<li>å¤šçº§ç¼“å­˜(æœ¬åœ°-Redis-æ•°æ®åº“)</li>
</ul>
<p>ğŸ’¡<em><strong>ç¼“å­˜å‡»ç©¿</strong></em>ï¼šçƒ­ç‚¹ Key çªç„¶å¤±æ•ˆï¼Œå¤§é‡å¹¶å‘è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“</p>
<ul>
<li>äº’æ–¥é‡å»ºï¼šç¬¬ä¸€ä¸ªé‡å»º(MySQL=&gt;Redis)ï¼Œåé¢çš„ç­‰ä¸€ä¸‹å†è®¿é—®ç¼“å­˜</li>
<li>é€»è¾‘è¿‡æœŸï¼šè¿”å›è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯äº’æ–¥(ç¬¬ä¸€ä¸ªè®¿é—®çš„)é‡å»ºç¼“å­˜  â—æ•°æ®ä¸€è‡´æ€§ä¸é«˜</li>
</ul>
<p><img alt="image-20241121210053886" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121210053886.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ç¼“å­˜å‡»ç©¿(çƒ­ç‚¹Keyï¼Œç¬æ—¶é‡å»ºé—®é¢˜)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Shop</span><span class="w"> </span><span class="nf">queryWithMutex</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// 1. å…ˆRedis</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cache:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">shopJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// Cacheå‘½ä¸­  shopJson ä¸ä¸ºnull,&#34;&#34;, &#34;\t&#34;(ä¸å…¨æ˜¯ç©ºç™½å­—ç¬¦)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">shopJson</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">shopJson</span><span class="p">,</span><span class="w"> </span><span class="n">Shop</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// ç©ºå¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shopJson</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// ä¸º&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c1">// 1. å®ç°ç¼“å­˜é‡å»º</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// 1.1 è·å–äº’æ–¥é”</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryLock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">// 1.2 åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="c1">// 1.3 å¤±è´¥åˆ™ä¼‘çœ ä¸”è½®è¯¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">50</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">queryWithMutex</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w"> </span><span class="err">â­â­â­</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="c1">// æœªå‘½ä¸­ =&gt; MySQL ç¼“å­˜é‡å»º</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">().</span><span class="na">eq</span><span class="p">(</span><span class="n">Shop</span><span class="p">::</span><span class="n">getId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">).</span><span class="na">one</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// æ¨¡æ‹Ÿå¤æ‚çš„é‡å»ºä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="c1">// å°†ç©ºå¯¹è±¡ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">RedisConstants</span><span class="p">.</span><span class="na">CACHE_NULL_TTL</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="c1">// log.debug(shop.toString());</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">shop</span><span class="p">),</span><span class="w"> </span><span class="n">RedisConstants</span><span class="p">.</span><span class="na">CACHE_SHOP_TTL</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">unlock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Shop</span><span class="w"> </span><span class="nf">queryWithLogicExpire</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="c1">// 1. å…ˆRedis</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cache:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="c1">// log.debug(&#34;Key:&#34; + key);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">shopJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">shopJson</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="c1">// ç¼“å­˜ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶å›å¡«</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">saveShop2Redis</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">20L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="c1">// RedisData:  private LocalDateTime expireTime;</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">    </span><span class="c1">//             private Object data;</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="n">RedisData</span><span class="w"> </span><span class="n">redisData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">shopJson</span><span class="p">,</span><span class="w"> </span><span class="n">RedisData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">    </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">((</span><span class="n">JSONObject</span><span class="p">)</span><span class="w"> </span><span class="n">redisData</span><span class="p">.</span><span class="na">getData</span><span class="p">(),</span><span class="w"> </span><span class="n">Shop</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">redisData</span><span class="p">.</span><span class="na">getExpireTime</span><span class="p">().</span><span class="na">isAfter</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">        </span><span class="c1">// æœªè¿‡æœŸ</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">    </span><span class="c1">// è¿‡æœŸè¿›è¡Œæ›´æ–°</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryLock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">        </span><span class="c1">// ç‹¬ç«‹çº¿ç¨‹è¿›è¡Œé‡å»ºç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">        </span><span class="n">CACHE_REBUILD_EXECUTOR</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">                </span><span class="n">saveShop2Redis</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">20L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">                </span><span class="n">unlock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯èƒ½ä¼šè¿”å›è¿‡æœŸæ•°æ®ã€‚ å› ä¸ºæ²¡æœ‰è¿›è¡Œç­‰å¾…</span><span class="w">
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="redismysqlæ•°æ®ä¸€è‡´æ€§">Redis&amp;MySQLæ•°æ®ä¸€è‡´æ€§<a hidden class="anchor" aria-hidden="true" href="#redismysqlæ•°æ®ä¸€è‡´æ€§">#</a></h4>
<ul>
<li>å…ˆæ›´æ–°Redisï¼Œå†æ›´æ–°MySQL âŒä¸æ¨è</li>
</ul>
<p><img alt="image-20250308135639431" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmGqn7lzt08zg5oJu4hJH-WsIxYk"></p>
<ul>
<li>å…ˆæ›´æ–°MySQLï¼Œå†æ›´æ–°Redis âŒä¸æ¨è</li>
</ul>
<p><img alt="image-20250308140251136" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/Fp0jO35q6BMqKyzIsrb0NXRI8o6P"></p>
<ul>
<li>å…ˆåˆ é™¤Redisï¼Œå†æ›´æ–°MySQLï¼Œæœ€åå†™å›Redis âŒä¸æ¨è</li>
</ul>
<p><img alt="image-20250308140614242" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmEB4Dj9_pgrOuyHLfHhGqK04wHb"></p>
<ul>
<li>å…ˆæ›´æ–°MySQLï¼Œå†åˆ é™¤Redisï¼Œç­‰è¯·æ±‚é‡æ–°ç¼“å­˜(æƒ°æ€§) âœ”ï¸æ¨è</li>
<li>ç¼“å­˜åŒåˆ é™¤ç­–ç•¥ã€‚æ›´æ–°MySQLä¹‹å‰ï¼Œåˆ é™¤ä¸€æ¬¡Redisï¼›æ›´æ–°å®ŒMySQLåï¼Œå†è¿›è¡Œä¸€æ¬¡å»¶è¿Ÿåˆ é™¤ âœ”ï¸æ¨è</li>
</ul>
<p><img alt="image-20250308140849778" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FsUaIXIOz9NnJkJ0Lf1fUebBQpHI"></p>
<p>æ•°æ®åº“æ²¡é—®é¢˜ï¼Œä½†æ˜¯ç¼“å­˜æœ‰é—®é¢˜ï¼Œç­‰å¾…ä¸€æ®µå®è·µ</p>
<ul>
<li>ä½¿ç”¨Binlogå¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œç›‘å¬æ•°æ®åº“çš„binlogå˜åŒ–ï¼Œé€šè¿‡å¼‚æ­¥æ–¹å¼æ›´æ–°Redisç¼“å­˜ âœ”ï¸æ¨è</li>
</ul>
<h3 id="äº®ç‚¹æ¨¡å—">äº®ç‚¹æ¨¡å—ï¼š<a hidden class="anchor" aria-hidden="true" href="#äº®ç‚¹æ¨¡å—">#</a></h3>
<h4 id="rabbitmq">RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#rabbitmq">#</a></h4>
<ul>
<li>
<h5 id="å¼‚æ­¥å¤„ç†">å¼‚æ­¥å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#å¼‚æ­¥å¤„ç†">#</a></h5>
</li>
<li>
<p><em><strong>å‰Šå³°å¡«è°·ï¼ˆæµé‡å‰Šå³°ï¼‰</strong></em></p>
<p>=&gt; <strong>å‰Šå³°</strong>ï¼ˆç¼“å†²æµé‡ï¼‰ï¼šæµé‡é«˜å³°æ—¶ï¼ŒMQ å……å½“â€œç¼“å†²åŒºâ€ï¼Œå°†è¯·æ±‚å…ˆå­˜å‚¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œé¿å…ç³»ç»Ÿç›´æ¥å´©æºƒã€‚</p>
<p>â€‹     <strong>å¡«è°·</strong>ï¼ˆå¹³æ»‘æµé‡ï¼‰ï¼šæ¶ˆè´¹è€…æŒ‰<strong>ç¨³å®šé€Ÿç‡</strong>æ¶ˆè´¹æ¶ˆæ¯ï¼Œä¿è¯ç³»ç»Ÿè´Ÿè½½å‡è¡¡ã€‚</p>
<ul>
<li>æ¶ˆæ¯å¯é æŠ•é€’
<ul>
<li>å‘å¸ƒç¡®è®¤æœºåˆ¶ - æ˜¯å¦é‡å‘</li>
<li>RabbitMQæŒä¹…åŒ–</li>
</ul>
</li>
<li>æ¶ˆæ¯å¯é æ¶ˆè´¹
<ul>
<li>æ‰‹åŠ¨ACK</li>
<li>é™æµæœºåˆ¶ - ä¸€æ¬¡åªå–ä¸€ä¸ªæ¶ˆæ¯</li>
<li>æ­»ä¿¡é˜Ÿåˆ—ï¼ˆâ—å…œåº•ï¼‰</li>
</ul>
</li>
<li>æ¶ˆæ¯å”¯ä¸€æ¶ˆè´¹
<ul>
<li>Rediså­˜å‚¨æ¶ˆè´¹è¿‡çš„ID (å¤šä¸ªæ¶ˆè´¹è€…æ¥æ”¶åˆ°ç›¸åŒçš„æ¶ˆæ¯æ—¶å€™)  - <strong>å‘å¸ƒ/è®¢é˜…ï¼ˆFanout äº¤æ¢æœº-å¹¿æ’­ï¼‰</strong>ï¼Œæ¶ˆæ¯ä¼šè¢«<strong>å¤åˆ¶åˆ°å¤šä¸ªé˜Ÿåˆ—ã€‚</strong></li>
<li>â­RabbitMQ ä¸­ï¼Œ<strong>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹</strong>ï¼Œ<strong>é˜Ÿåˆ—æ˜¯ç‚¹å¯¹ç‚¹æ¨¡å‹</strong>ï¼Œä¸€æ¡æ¶ˆæ¯åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ã€‚<strong>å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—æ—¶ï¼ŒRabbitMQ é‡‡ç”¨</strong> <strong>â€œè½®è¯¢åˆ†å‘â€</strong>ï¼ˆRound Robinï¼‰ï¼Œæ¯æ¡æ¶ˆæ¯åªä¼šè¢«å…¶ä¸­ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="w">				 </span><span class="n">RabbitMQ</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">publisher</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">exchanger</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">queue</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">error</span><span class="w">     </span><span class="n">1</span><span class="p">.</span><span class="w">     </span><span class="n">4</span><span class="p">.</span><span class="w">      </span><span class="n">2</span><span class="p">.</span><span class="w">   </span><span class="n">5</span><span class="p">.</span><span class="w">  </span><span class="n">3</span><span class="p">.</span><span class="w">    
</span></span></span></code></pre></div><p>1.2. æŠ•é€’å¤±è´¥ =&gt; é‡æ–°æŠ•é€’</p>
<p>4.5. MQå®•æœº =&gt; æŒä¹…åŒ–</p>
<p>3.. ACKç¡®è®¤ =&gt; é‡æ–°æ¶ˆè´¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">rebbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">	</span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nt">publisher-confirm-type</span><span class="p">:</span><span class="w"> </span><span class="l">correlated </span><span class="w"> </span><span class="c"># å¼€å¯å‘å¸ƒç¡®è®¤æœºåˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="nt">publisher-returns</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">   </span><span class="c"># æŠ•é€’æ¶ˆæ¯æŠµè¾¾é˜Ÿåˆ—</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="nt">listener</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">        </span><span class="nt">simple</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">        </span><span class="nt">acknowledge-mode</span><span class="p">:</span><span class="w"> </span><span class="l">manual </span><span class="w"> </span><span class="c"># æ¶ˆè´¹è€…æ‰‹åŠ¨ç¡®è®¤ACK</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">            </span><span class="nt">prefetch</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="c"># é™åˆ¶æ¶ˆè´¹è€…ä¸€æ¬¡å¤„ç†ä¸€æ¡æ•°æ®</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>ç”Ÿäº§è€…ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ç¡®ä¿äº¤æ¢æœºæ”¶åˆ°æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setConfirmCallback</span><span class="p">(((</span><span class="n">correlationData</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[âˆš] Product: Msg send success!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;[Ã—] Product: Msg send fail!, åŸå› : {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">putIfAbsent</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">retrySendMsg</span><span class="p">(</span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// ç¡®ä¿é˜Ÿåˆ—æ”¶åˆ°æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setReturnsCallback</span><span class="p">(</span><span class="n">returnedMessage</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;[Ã—] æ¶ˆæ¯è·¯ç”±å¤±è´¥!, åŸå› : {}, Msg: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">returnedMessage</span><span class="p">.</span><span class="na">getReplyText</span><span class="p">(),</span><span class="w"> </span><span class="n">returnedMessage</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// è¿™é‡ŒRoting Keyé”™è¯¯ï¼Œé…ç½®é”™è¯¯ï¼ŒæŠ•é€’æ­»ä¿¡é˜Ÿåˆ—æ¯”è¾ƒå¥½</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">retrySendMsg</span><span class="p">(</span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgCacheMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">computeIfPresent</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">integer</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">integer</span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;å‘é€åˆ°æ­»ä¿¡äº¤æ¢æœºï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="c1">// â­â­â­æ¨¡æ‹Ÿé”™è¯¯æƒ…å†µ 1. 2.</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[&gt;] Send Msg: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CorrelationData</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="n">msgCacheMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// ç¼“å­˜æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;error&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;error&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>æ¶ˆè´¹è€…ï¼š</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">QUEUE_NAME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">receiveMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="nd">@Header</span><span class="p">(</span><span class="n">AmqpHeaders</span><span class="p">.</span><span class="na">DELIVERY_TAG</span><span class="p">)</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[Ã—] å¼€å§‹å¤„ç†æ¶ˆæ¯: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">2000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RandomUtil</span><span class="p">.</span><span class="na">randomDouble</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">.</span><span class="na">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;æ‰‹åŠ¨é€ æˆå¼‚å¸¸&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// 1. process success</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">channel</span><span class="p">.</span><span class="na">basicAck</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">  </span><span class="c1">// deliveryTag:msgId; multiple=false:ackCurrentMsg else ackPreAllMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[âˆš] process Msg success: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 2. process fail</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[Ã—] process Msg fail: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="c1">// é€€å›æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">basicNack</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// msgId, æ˜¯å¦æ‰¹é‡æ‹’ç»:false:ä»…æ‹’ç»å½“å‰Msg, true:æ‹’ç»æ‰€æœ‰deliveryTagå°äºç­‰äºå½“å‰çš„deliveryTagæ¶ˆæ¯  â­â­â­ æ¶ˆè´¹å¤±è´¥æ—¶é‡æ–°å…¥é˜Ÿï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[&lt;] Msg notAck fail&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><em><strong>å¾®æœåŠ¡è§£è€¦</strong></em></li>
<li><em><strong>è®¢å•è¶…æ—¶å–æ¶ˆ</strong></em></li>
</ul>
<h3 id="æ‹¼å›¢äº¤æ˜“">æ‹¼å›¢äº¤æ˜“<a hidden class="anchor" aria-hidden="true" href="#æ‹¼å›¢äº¤æ˜“">#</a></h3>
<h4 id="æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿">æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿<a hidden class="anchor" aria-hidden="true" href="#æŠ½è±¡è´£ä»»é“¾æ¨¡æ¿">#</a></h4>
<p>å®šä¹‰æŠ½è±¡ä»»åŠ¡æ¥å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®šä¹‰æŠ½è±¡èŠ‚ç‚¹æ¥å£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handler</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">handler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defaultHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¤§è‡´å°±æ˜¯ [apply + next]ï¼Œè´£ä»»é“¾æ¨¡å¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// åŸºæœ¬ä½¿ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">XXX</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">ObjectXXX</span><span class="w"> </span><span class="n">nextNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">apply</span><span class="p">{...</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">()}</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="n">next</span><span class="p">{</span><span class="n">nextNode</span><span class="p">.</span><span class="na">apply</span><span class="p">()}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<p><strong>å¤šå®ä¾‹é“¾è·¯æ¨¡å¼</strong></p>
<p>åŒå‘é“¾è¡¨çš„å®ç°æ€æƒ³</p>
<p>å®šä¹‰é“¾è¡¨ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Node</span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®šä¹‰èŠ‚ç‚¹å¤„ç†å¯¹è±¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// å­ç±»å¯ä»¥ä¸å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®ç°å…·ä½“çš„ä¸šåŠ¡èŠ‚ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RuleLogic201</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Rule02TradeRuleFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">Rule02TradeRuleFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// å…·ä½“ä¸šåŠ¡é€»è¾‘;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è£…é…ä¸šåŠ¡è´£ä»»é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LinkArmory</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@SafeVarargs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkArmory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">linkName</span><span class="p">,</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">logicLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">linkName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicHandler</span><span class="p">:</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="n">logicLink</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">logicHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLogicLink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“">è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“<a hidden class="anchor" aria-hidden="true" href="#è´£ä»»é“¾å®ç°ä¸šåŠ¡ç®¡é“">#</a></h4>
<p>å•†å“æŠ˜æ‰£ä»·æ ¼è¯•ç®—</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ä»å·¥å‚æ‹¿åˆ°å¯¹åº”çš„è´£ä»»é“¾å‡ºå‘èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RootNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">|</span><span class="n">æ£€æŸ¥ä¿¡æ¯</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">TagNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MarketNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="err">â­</span><span class="n">å‰ç½®å¤„ç†</span><span class="err">â­</span><span class="n">æ‹¼å•è¯•ç®—</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">|</span><span class="n">æ„å»ºç»“æœ</span><span class="o">]</span><span class="w">    
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// SwitchNodeï¼šæ ¹æ®æ¡ä»¶åˆ¤æ–­ä¸šåŠ¡æ˜¯å¦é™çº§oré™æµ</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// TagNodeï¼šæ ¹æ®ç”¨æˆ·ä¿¡æ¯åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨èƒ½å¦å‚ä¸ä¸å¯è§</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// MarketNodeï¼šæ ¹æ®æ‹¼å›¢æ´»åŠ¨ï¼Œè®¡ç®—æŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 	      ç­–ç•¥æ¨¡å¼ï¼šæ ¹æ®ä¼˜æƒ Id,è®¡ç®—ä¸åŒçš„æŠ˜æ‰£</span><span class="w">
</span></span></span></code></pre></div><p>æ‹¼å›¢é”å•æ ¡éªŒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// å®ç°å…·ä½“çš„ä¸šåŠ¡èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 1. ActivityUsabilityRuleFilterï¼šæ ¡éªŒæ´»åŠ¨çŠ¶æ€å’Œæ´»åŠ¨æ—¶é—´çš„æœ‰æ•ˆæ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 2. UserTakeLimitRuleFilterï¼šåˆ¤æ–­ç”¨æˆ·å‚ä¸æ¬¡æ•°ä¸æ´»åŠ¨é™åˆ¶æ¬¡æ•°å…³ç³»</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// è£…é…ä¸šåŠ¡è´£ä»»é“¾</span><span class="w">
</span></span></span></code></pre></div><p>æ‹¼å›¢ç»“ç®—æ ¡éªŒ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 1. SCRuleFilter: æ ¡éªŒæ‹¼å›¢çš„æ¸ é“æ¥æºæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦åœ¨é»‘åå•ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 2. SettableRuleFilterï¼šæ‹¼å›¢æ´»åŠ¨çš„ç”¨æˆ·æ”¯ä»˜æ—¶é—´æ˜¯å¦åœ¨æœ‰æ•ˆæ—¶é—´å†…</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 3. OutTradeNoRuleFilterï¼šå¤–éƒ¨äº¤æ˜“å•å·æ˜¯å¦æ­£ç¡®</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 4. EndRuleFilterï¼šæ‰“åŒ…ç»“æœ</span><span class="w">
</span></span></span></code></pre></div><h4 id="aopæ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–°">AOP+æ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–°<a hidden class="anchor" aria-hidden="true" href="#aopæ¶ˆæ¯è®¢é˜…å®ç°çƒ­æ›´æ–°">#</a></h4>
<p>é€šè¿‡AOPç¼–ç¨‹å’ŒRediså‘å¸ƒ/è®¢é˜…åŠŸèƒ½å®ç°ä¸šåŠ¡è§„åˆ™ï¼ˆé™æµé˜ˆå€¼ã€é™çº§ç­–ç•¥ï¼‰çš„çƒ­æ›´æ–°</p>
<p>è‡ªå®šä¹‰æ³¨è§£</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DCCValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®šä¹‰çƒ­æ›´æ–°æœåŠ¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cm">     * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;downgradeSwitch:0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">downgradeSwitch</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;cutRange:100&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cutRange</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCutRange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–æœ€åä¸¤ä½</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†…</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cutRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">cutRange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDowngradeSwitch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â­æ³¨æ„ï¼šåœ¨SwitchNodeä¸­ï¼Œè°ƒç”¨è¿™äº›æ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ”¾è¡Œ</p>
<p>åŸºäºRedisçš„å‘å¸ƒè®¢é˜…è¿›è¡Œå‚æ•°è°ƒæ•´</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="o">/</span><span class="w"> </span><span class="n">DCCValueBeanFactory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanPostProcessor</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;group_buy_market_dcc_&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">DCCValueBeanFactory</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">redissonClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;dccTopic&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">RTopic</span><span class="w"> </span><span class="nf">dccRedisTopicListener</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">RTopic</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getTopic</span><span class="p">(</span><span class="s">&#34;group_buy_market_dcc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="c1">// æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="n">topic</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">charSequence</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç›‘å¬åˆ°Redis Topicï¼š {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">charSequence</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">attribute</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="c1">// è®¾ç½®å€¼ =&gt; å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">objBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="c1">// è·å–å†…å­˜ä¸­çš„å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="c1">// æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">objBean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">objBean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBeanClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">objBean</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="c1">// implements BeanPostProcessor é‡å†™æ–¹æ³•  -- å¹¶åœ¨æ¯ä¸ª bean åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="c1">// æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopProxyUtils</span><span class="p">.</span><span class="na">getSingletonTarget</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span><span class="c1">// è¿™é‡Œåˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰å¯¹åº”çš„è‡ªå®šä¹‰æ³¨è§£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">.</span><span class="na">isAnnotationPresent</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="n">DCCValue</span><span class="w"> </span><span class="n">dccValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccValue</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;dcc config error &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">            </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">                </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å€¼ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">        </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®ç°Apiæ¥å£æ›´æ–°Redisä¸­çš„å€¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;update_config&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateConfig</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">dccTopic</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ›´æ–°è¯·æ±‚ =&gt; Redis =&gt; è®¢é˜…æœåŠ¡ =&gt; ä¿®æ”¹å‚æ•°</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://longcoding.top/posts/jobs/collection/">
    <span class="title">Â« Prev</span>
    <br>
    <span>é›†åˆé¢è¯•é¢˜ç¬”è®°</span>
  </a>
  <a class="next" href="http://longcoding.top/posts/jobs/jvm/">
    <span class="title">Next Â»</span>
    <br>
    <span>JVMé¢è¯•é¢˜ç¬”è®°</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://longcoding.top/">LongCoding&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
