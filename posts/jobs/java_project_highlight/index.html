<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>项目重难点 | LongCoding&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="简历项目重难点">
<meta name="author" content="👨🏻‍🎓 LongWei">
<link rel="canonical" href="http://longcoding.top/posts/jobs/java_project_highlight/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://longcoding.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://longcoding.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://longcoding.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://longcoding.top/apple-touch-icon.png">
<link rel="mask-icon" href="http://longcoding.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://longcoding.top/posts/jobs/java_project_highlight/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://longcoding.top/posts/jobs/java_project_highlight/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="项目重难点">
  <meta property="og:description" content="简历项目重难点">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-11T16:45:11+08:00">
    <meta property="article:modified_time" content="2025-03-11T16:45:11+08:00">
      <meta property="og:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:title" content="项目重难点">
<meta name="twitter:description" content="简历项目重难点">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://longcoding.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "项目重难点",
      "item": "http://longcoding.top/posts/jobs/java_project_highlight/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "项目重难点",
  "name": "项目重难点",
  "description": "简历项目重难点",
  "keywords": [
    
  ],
  "articleBody": " 黑马点评： 登录相关 使用 JWT 实现无状态认证，登录成功后生成一个包含用户信息的 Token 返回给前端，由前端每次请求时携带在请求头中。后端通过拦截器统一拦截请求，解析并校验 Token 的合法性。 \u003c用户信息只包括：userId，username，role等必要信息 =\u003e 安全\u003e\n校验通过后，我们会将解析出来的用户信息保存到 ThreadLocal 中，构建一个线程级的用户上下文，在整个请求处理流程中都可以方便地获取当前登录用户，避免层层传参，提升代码整洁度和可维护性。\nThreadLocal原理：每个线程拥有独立的ThreadLocalMap对象。所有线程使用同一个 ThreadLocal 对象作为键，但值互不影响。通过线程级别的变量隔离，避免多线程竞争，实现线程安全。\n超卖问题： 数据库层面： 悲观锁（FOR UPDATE-行锁） 乐观锁（版本号法） 应用层面： 分布式锁（互斥） 缓存+消息队列 限流+熔断 1.1 行锁\n1BEGIN; 2SELECT stock FROM products WHERE id = 1 FOR UPDATE; 3-- 业务逻辑：检查库存是否足够，执行扣减操作 4UPDATE products SET stock = stock - 1 WHERE id = 1; 5COMMIT; 10000条(10线程循环1000次)请求，吞吐量：791.2/sec 互斥锁，串行访问\n1Integer stock = baseMapper.selectSecKillStockForUpdate(voucherId); // Fordate加行锁，事务结束会释放 2if (stock \u003c= 0){ 3 throw new BusinessException(500, \"fail\"); 4} 5 6boolean update = lambdaUpdate().set(SeckillVoucher::getStock, stock - 1) 7 .eq(SeckillVoucher::getVoucherId, voucherId) 8 .update(); 1.2 CAS方法\n1UPDATE products 2SET stock = stock - 1 3WHERE id = 1 AND stock \u003e 0; 10000条(10线程循环1000次)请求，吞吐量：944.7/sec\n1// 注意把Stock不满足条件的过滤！ 2 3boolean update = lambdaUpdate() 4 .setSql(\"stock = stock - 1\") // 这个很关键 不要使用 set(::getStock, stock-1) 错误原因：基于应用层计算的值，而不是数据库的当前值。 5 .eq(SeckillVoucher::getVoucherId, voucherId) 6 .gt(SeckillVoucher::getStock, 0) // eq(::getStock, stock) 7 .update(); ⭐⭐⭐ MVCC(版本链+ReadView) - 读操作而言\n事务 B 的更新操作： 更新操作会直接操作数据库的当前值，而不是基于事务 B 的 ReadView。 事务 B 的更新操作会检查数据库的当前值，发现 stock = 0，因此更新失败。 2.1 🏷️ JVM锁（单体）：\n1// 该方法每次只会有一个线程执行，互斥 2synchronized (VoucherOrderService.class) { 3\t// 查 4 // 改 5} 10000条(10线程循环1000次)请求，吞吐量：715.5/sec 互斥锁，串行访问\n2.2 🏷️分布式锁：\n1// seckill_key = \"seckill:product:1\" 2// =Lua脚本(判断+扣减)=\u003e 再处理MySQL // 原子化查询+修改 2.3 🏷️缓存+消息队列 （服务解耦）:\n1// 库存初始化：将MySQL商品库存存入Redis中，提升查询和扣减效率; 2 3// 库存预扣减(Redis)：用户请求时，先在 Redis 中扣减库存; == Lua脚本 4Long ok = redisTemplate.execute(SECKILL_SCRIPT, Collections.emptyList(), \"1\"); 5rabbitTemplate.convertAndSend(exchangerName, routingKey, message); 6 7// 订单异步处理(MQ):扣减成功 =\u003e MQ =\u003e 订单处理接口 =\u003e Redis\u0026MySQL一致。 8lambdaUpdate() 9 .setSql(\"stock = stock - 1\") 10 .eq(SeckillVoucher::getVoucherId, Integer.valueOf(msg.get(\"voucherId\"))) 11 .update(); 10000条(10线程循环1000次)请求，吞吐量：1485.7/sec\n🏷️限流+熔断: （仅理论）\n1// 1. Nginx限流(最基础，拦截恶意流量) - 只针对IP 2http { 3 limit_req_zone $binary_remote_addr zone=mylimit:10m rate 100r/s; 4 server { 5 location /seckill { 6 limit_req zone=mylimit burst=50 nodelay; 7 proxy_pass http://backend; 8 } 9 } 10} 11 12// 2. Redis令牌桶(应用层用户级限流，精准控制) 13// def try_acquire_token(user_id, rate=5, capacity=10): 14bucket_key = f\"token_bucket:{user_id}\" 15last_time_key = f\"last_time:{user_id}\" 16 17// 下面需要为lua脚本 ==== 18now = time.time() 19last_time = float(r.get(last_time_key) or now) 20elapsed = now - last_time 21 22# 计算补充的令牌 23tokens_to_add = int(elapsed * rate) 24current_tokens = min(capacity, int(r.get(bucket_key) or capacity) + tokens_to_add) 25 26if current_tokens \u003e 0: 27 r.set(bucket_key, current_tokens - 1) # 消耗 1 个令牌 28 r.set(last_time_key, now) # 更新时间 29 return True 30return False 31 32// ==== 33 34 35// 3. 前端排队(减少无效请求，避免一窝蜂涌入) 一人一单问题： （首先不能重复下单，还要扣减库存，并且新增订单）\n**单体架构 **\n*** Redis-Lua脚本原子化查询库存+重复下单*** synchronized加锁 - UserId.toString().intern() 字符串常量池引用 集群架构\n分布式锁实现 1.1 🏷️Redis实现：\n1if (redis.call('exists', orderKey) == 0) then 2 redis.call('sadd', orderKey, '') -- ！！！初始化需要从MySQL中加载已经买过的用户 3 return 2 4end 5if (redis.call('sismember', orderKey, userId) == 1) then 6 return 2 7end 8 9redis.call('sadd', orderKey, userId) 10-- 在Redis中，使用Set集合存储买过的用户 1.2 🏷️JVM锁+MySQL实现：\n1@Transactional 2public Result seckillVoucherMySQLAndMQUnique(Long voucherId, Long userId) throws JsonProcessingException { 3 Integer stock = lambdaQuery() 4 .select(SeckillVoucher::getStock) 5 .eq(SeckillVoucher::getVoucherId, voucherId) 6 .oneOpt() 7 .map(SeckillVoucher::getStock).orElse(null); 8 if (stock \u003c= 0) { 9 throw new BusinessException(500, \"已经卖完了！\"); 10 } 11 12 synchronized(userId.toString().intern()) { 13 transactionPostChannel(userId, voucherId); 14 } 15 16 return Result.ok(); 17} 18 19@Transactional 20public void transactionPostChannel(Long userId, Long voucherId) { 21 boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); 22 if (isOrder) { 23 throw new BusinessException(500, \"您买过了！\"); 24 } 25 26 boolean update = lambdaUpdate() 27 .setSql(\"stock = stock - 1\") 28 .eq(SeckillVoucher::getVoucherId, voucherId) 29 .update(); 30 if (!update) { 31 throw new BusinessException(500, \"MySQL库存更新失败\"); 32 } 33 34 VoucherOrder voucherOrder = new VoucherOrder(); 35 voucherOrder.setUserId(userId); 36 voucherOrder.setVoucherId(voucherId); 37 boolean b = voucherOrderService.setVoucherOrder(voucherOrder); 38 if (!b) { 39 throw new BusinessException(500, \"MySQL插入失败\"); 40 } 41} 42 43// 下面只使用一个@Transactional 44@Transactional 45public Result seckillVoucherMySQLAndMQUnique(Long voucherId, Long userId) throws JsonProcessingException { 46 Integer stock = lambdaQuery() 47 .select(SeckillVoucher::getStock) 48 .eq(SeckillVoucher::getVoucherId, voucherId) 49 .oneOpt() 50 .map(SeckillVoucher::getStock).orElse(null); 51 if (stock \u003c= 0) { 52 throw new BusinessException(500, \"已经卖完了！\"); 53 } 54 55 synchronized(userId.toString().intern()) { 56 VoucherSecKillService o = (VoucherSecKillService) AopContext.currentProxy(); 57 o.transactionPostChannel(userId, voucherId); 58 } 59 60 return Result.ok(); 61} 62//⭐⭐⭐嵌套执行方法，且主方法没有@Transactional，需要代理对象来执行才能使业务生效 🏷️1 synchronized 锁的粒度降级了，变为当前用户Id 【userId.toString().intern() 添加到常量池，并返回常量池的引用】 ❌❌❌这里锁的单机，多个JVM的情况下，就寄了\n🏷️2 VoucherSecKillService o = (VoucherSecKillService) AopContext.currentProxy(); 拿到执行事务的代理对象\n🏷️3 boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); 需要把是否下单锁住，否则，可能重复下单，因为这个条件可能多个线程同时满足！！！\n2.1 🏷️分布式锁现实\n解决单机JVM锁，在集群下失效的问题。\n1-- 上锁，分布式的 2不存在:创建并返回True 业务 =\u003e 扣库存 + 创建订单\n1-- 解锁，分布式，只能解锁自己上的锁 2// 如果可以释放别人的锁，会出现以下情况 3// 事务A的锁过期释放了(这里没有续时间or暂时卡了) =\u003e 事务B加锁 =\u003e 事务A活了过来*解锁* =\u003e 事务C加锁 ... 4事务B和C拿了同一把锁，寄了 =\u003e 只允许删自己加的锁 5事务A和B拿了同一把锁，寄了 =\u003e 看门狗续时间 lua脚本\n1Boolean lock = redisTemplate.opsForValue().setIfAbsent(lock_key, lock_value, 3, TimeUnit.SECONDS); 2 3try { 4 if (lock) { 5 ... 6 } 7} finally { 8\tredisTemplate.execute(SECKILL_UNLOCK_SCRIPT, Collections.singletonList(lock_key), lock_value); // 删除锁和判断锁是否当前线程拥有 原子化 9} Redission\n1RLock lock = redissonClient.getLock(lock_key); 2try { 3 boolean ok = lock.tryLock(1, 3, TimeUnit.SECONDS); // 不阻塞 4 if(ok) {...} 5 finally { 6 if (lock.isHeldByCurrentThread()) lock.unlock(); 7 } 8} 9 10try { 11 boolean ok = lock.lock(); // 阻塞,且未指定过期时间 =\u003e 触发看门狗 12 if(ok) {...} 13 finally { 14 if (lock.isHeldByCurrentThread()) lock.unlock(); 15 } 16} 最开始我们的遇到自增ID问题，我们通过实现分布式ID解决了问题；后面我们在单体系统下遇到了一人多单超卖问题，我们通过乐观锁/悲观锁解决了；我们对业务进行了变更，将一人多单变成了一人一单，结果在高并发场景下同一用户发送相同请求仍然出现了超卖问题，我们通过悲观锁解决了；由于用户量的激增，我们将单体系统升级成了集群，结果由于锁只能在一个JVM中可见导致又出现了，在高并发场景下同一用户发送下单请求出现超卖问题，我们通过实现分布式锁成功解决集群下的超卖问题；释放锁时，判断锁是否是当前线程 和 删除锁两个操作不是原子性的，可能导致超卖问题，我们通过将两个操作封装到一个Lua脚本成功解决了；\n为了解决锁的不可重入性，我们通过将锁以hash结构的形式存储，每次释放锁都value-1，获取锁value+1，从而实现锁的可重入性，并且将释放锁和获取锁的操作封装到Lua脚本中以确保原子性。\n最最后，我们发现可以直接使用现有比较成熟的方案Redisson来解决上诉出现的所有问题🤣，什么不可重试、不可重入、超市释放、原子性等问题Redisson都提供相对应的解决方法（。＾▽＾）\n优惠卷秒杀 异步下单：\n1// 主线程 21. Lua脚本 32. 成功=\u003e放入队列；失败=\u003e返回异常 4 51.1. Lua脚本 =\u003e 库存 =扣库存=\u003e 是否下单 =记录用户下单 =\u003e 返回0 6 返回1 返回2 7 8// 子线程 9队列中取出订单信息 =\u003e 扣减卷库存 =\u003e 是否付款 =\u003e 更新成功 10 =\u003e End 缓存三兄弟： 💡缓存穿透： 恶意请求查询不存在的数据，绕过缓存直接访问数据库\n布隆过滤器 商品ID，通过多个哈希函数，将元素映射到bitMap中的多个位置，只有每个位置都为1才表明这个对象存在。 guava库有实现好的，直接用。 1# 伪代码，仅供学习 2class BloomFilter: 3 def __init__(self, size, hash_count): 4 \"\"\" 5 初始化布隆过滤器 6 :param size: 位数组大小（m） 7 :param hash_count: 哈希函数数量（k） 8 \"\"\" 9 self.size = size 10 self.hash_count = hash_count 11 self.bit_array = [0] * size # 初始化位数组（全0） 12 13 def add(self, item): 14 \"\"\" 15 添加元素到布隆过滤器 16 \"\"\" 17 for seed in range(self.hash_count): 18 # 通过不同的种子模拟多个哈希函数 19 index = self._hash(item, seed) % self.size 20 self.bit_array[index] = 1 # 设置对应位为1 21 22 def contains(self, item): 23 \"\"\" 24 检查元素是否可能存在 25 :return: 26 - True: 可能存在（可能有误判） 27 - False: 一定不存在 28 \"\"\" 29 for seed in range(self.hash_count): 30 index = self._hash(item, seed) % self.size 31 if self.bit_array[index] == 0: 32 return False # 只要有一位为0，则一定不存在 33 return True # 所有位均为1，可能存在 34 35 def _hash(self, item, seed): 36 \"\"\" 37 哈希函数（伪代码，实际可用MurmurHash等） 38 :param item: 输入元素 39 :param seed: 哈希种子（模拟不同哈希函数） 40 :return: 哈希值 41 \"\"\" 42 hash_value = 0 43 for char in str(item): 44 hash_value = (hash_value * seed + ord(char)) \u0026 0xFFFFFFFF 45 return hash_value 缓存空对象 🏷️ 缓存空对象实现方案\n1// 缓存命中 2if (StrUtil.isNotBlank(s)) { // 不为null，不为\"\" 3 SeckillVoucher seckillVoucher = JSONUtil.toBean(s, SeckillVoucher.class); 4 return Result.ok(seckillVoucher); 5} 6 7// 未命中，是否是之前缓存的空对象 8if (Objects.nonNull(s)) { // \"\" 不为null 9 throw new BusinessException(500, \"查询缓存空对象！\"); 10} 11 12SeckillVoucher seckillVoucher = lambdaQuery() 13 .eq(SeckillVoucher::getVoucherId, id) 14 .one(); 15// 缓存空对象 一个线程重建缓存就好 16synchronized (CacheTestService.class) { 17 String t = redisTemplate.opsForValue().get(key); 18 if (Objects.nonNull(t)) 19 throw new BusinessException(500, \"查询缓存空对象！\"); 20 21 if (Objects.isNull(seckillVoucher)) { 22 redisTemplate.opsForValue().set(key, \"\", 3, TimeUnit.SECONDS); 23 throw new BusinessException(500, \"缓存空对象！\"); 24 } 25} 26// 缓存重建 27redisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(seckillVoucher), 3, TimeUnit.SECONDS); 28 29return Result.ok(seckillVoucher); 💡缓存雪崩：量缓存同时失效，导致请求全部压到数据库\n过期时间随机化 ⭐⭐⭐ baseline + random_offset Hot数据定时刷新缓存 @Scheduled 多级缓存(本地-Redis-数据库) 💡缓存击穿：热点 Key 突然失效，大量并发请求直接打到数据库\n互斥重建：第一个重建(MySQL=\u003eRedis)，后面的等一下再访问缓存 逻辑过期：返回过期数据，但是互斥(第一个访问的)重建缓存 ❗数据一致性不高 1// 缓存击穿(热点Key，瞬时重建问题) 2public Shop queryWithMutex(Long id) { 3 // 1. 先Redis 4 String key = \"cache:shop:\" + id; 5 String shopJson = stringRedisTemplate.opsForValue().get(key); 6 // Cache命中 shopJson 不为null,\"\", \"\\t\"(不全是空白字符) 7 if (StrUtil.isNotBlank(shopJson)) { 8 Shop shop = JSONUtil.toBean(shopJson, Shop.class); 9 return shop; 10 } 11 // 空对象 12 if (shopJson != null) { // 为\"\" 13 return null; 14 } 15 16 // 1. 实现缓存重建 17 String lockKey = \"lock:shop:\" + id; 18 Shop shop = null; 19 try { 20 // 1.1 获取互斥锁 21 boolean isLock = tryLock(lockKey); 22 // 1.2 判断是否获取成功 23 if (!isLock) { 24 // 1.3 失败则休眠且轮询 25 Thread.sleep(50); 26 return queryWithMutex(id); ⭐⭐⭐ 27 } 28 // 未命中 =\u003e MySQL 缓存重建 29 shop = lambdaQuery().eq(Shop::getId, id).one(); 30 Thread.sleep(500); // 模拟复杂的重建任务 31 if (shop == null) { 32 // 将空对象缓存 33 stringRedisTemplate.opsForValue().set(key, \"\", RedisConstants.CACHE_NULL_TTL, TimeUnit.MINUTES); 34 return null; 35 } 36 // log.debug(shop.toString()); 37 stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop), RedisConstants.CACHE_SHOP_TTL, TimeUnit.MINUTES); 38 } catch (InterruptedException e) { 39 e.printStackTrace(); 40 } finally { 41 unlock(lockKey); 42 } 43 return shop; 44} 45 46public Shop queryWithLogicExpire(Long id) { 47 // 1. 先Redis 48 String key = \"cache:shop:\" + id; 49 // log.debug(\"Key:\" + key); 50 String shopJson = stringRedisTemplate.opsForValue().get(key); 51 52 if (StrUtil.isBlank(shopJson)) { 53 // 缓存不存在，查询数据库并回填 54 return saveShop2Redis(id, 20L); 55 } 56 // RedisData: private LocalDateTime expireTime; 57 // private Object data; 58 RedisData redisData = JSONUtil.toBean(shopJson, RedisData.class); 59 Shop shop = JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class); 60 61 if (redisData.getExpireTime().isAfter(LocalDateTime.now())) { 62 // 未过期 63 return shop; 64 } 65 String lockKey = \"lock:shop:\" + id; 66 // 过期进行更新 67 boolean isLock = tryLock(lockKey); 68 if (isLock) { 69 // 独立线程进行重建缓存 70 CACHE_REBUILD_EXECUTOR.submit(() -\u003e { 71 try { 72 saveShop2Redis(id, 20L); 73 Thread.sleep(500); 74 } catch (Exception e) { 75 e.printStackTrace(); 76 } finally { 77 unlock(lockKey); 78 } 79 }); 80 } 81 return shop; // 可能会返回过期数据。 因为没有进行等待 82} Redis\u0026MySQL数据一致性 先更新Redis，再更新MySQL ❌不推荐 先更新MySQL，再更新Redis ❌不推荐 先删除Redis，再更新MySQL，最后写回Redis ❌不推荐 先更新MySQL，再删除Redis，等请求重新缓存(惰性) ✔️推荐 缓存双删除策略。更新MySQL之前，删除一次Redis；更新完MySQL后，再进行一次延迟删除 ✔️推荐 数据库没问题，但是缓存有问题，等待一段实践\n使用Binlog异步更新缓存，监听数据库的binlog变化，通过异步方式更新Redis缓存 ✔️推荐 亮点模块： RabbitMQ 异步处理 削峰填谷（流量削峰）\n=\u003e 削峰（缓冲流量）：流量高峰时，MQ 充当“缓冲区”，将请求先存储到消息队列中，避免系统直接崩溃。\n​ 填谷（平滑流量）：消费者按稳定速率消费消息，保证系统负载均衡。\n消息可靠投递 发布确认机制 - 是否重发 RabbitMQ持久化 消息可靠消费 手动ACK 限流机制 - 一次只取一个消息 死信队列（❗兜底） 消息唯一消费 Redis存储消费过的ID (多个消费者接收到相同的消息时候) - 发布/订阅（Fanout 交换机-广播），消息会被复制到多个队列。 ⭐RabbitMQ 中，默认情况下，消息只会被一个消费者消费，队列是点对点模型，一条消息只能被消费一次。多个消费者订阅同一个队列时，RabbitMQ 采用 “轮询分发”（Round Robin），每条消息只会被其中一个消费者处理。 1\tRabbitMQ 2publisher =\u003e [exchanger =\u003e queue] =\u003e consumer 3error 1. 4. 2. 5. 3. 1.2. 投递失败 =\u003e 重新投递\n4.5. MQ宕机 =\u003e 持久化\n3.. ACK确认 =\u003e 重新消费\n1rebbitmq: 2\t# ... 3 publisher-confirm-type: correlated # 开启发布确认机制 4 publisher-returns: true # 投递消息抵达队列 5 listener: 6 simple: 7 acknowledge-mode: manual # 消费者手动确认ACK 8 prefetch: 1 # 限制消费者一次处理一条数据 生产者：\n1// 确保交换机收到消息 2rabbitTemplate.setConfirmCallback(((correlationData, ack, cause) -\u003e { 3 if (ack) { 4 log.debug(\"[√] Product: Msg send success!\"); 5 }else { 6 log.error(\"[×] Product: Msg send fail!, 原因: {}\", cause.toUpperCase()); 7 msgRetryCount.putIfAbsent(correlationData.getId(), 3); 8 retrySendMsg(correlationData); 9 } 10})); 11 12// 确保队列收到消息 13rabbitTemplate.setReturnsCallback(returnedMessage -\u003e { 14 log.error(\"[×] 消息路由失败!, 原因: {}, Msg: {}\", returnedMessage.getReplyText(), returnedMessage.getMessage()); 15 // 这里Roting Key错误，配置错误，投递死信队列比较好 16}); 17} 18 19private void retrySendMsg(CorrelationData correlationData) { 20 Integer count = msgRetryCount.get(correlationData.getId()); 21 if (count \u003e 0) { 22 String message = msgCacheMap.get(correlationData.getId()); 23 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY, message, correlationData); 24 msgRetryCount.computeIfPresent(correlationData.getId(), (s, integer) -\u003e integer-1); 25 }else { 26 log.error(\"发送到死信交换机！\"); 27 } 28} 29 30// ⭐⭐⭐模拟错误情况 1. 2. 31public void sendMessage(String message) { 32 log.debug(\"[\u003e] Send Msg: \" + message); 33 for (int i = 1; i \u003c= 3; i++) { 34 CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString()); 35 msgCacheMap.put(correlationData.getId(), message + \":\" + i); // 缓存消息 36 if (i == 2) { 37 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME + \"error\", ReliabilityMQConfig.ROUTING_KEY, message + \":\" + i, correlationData); 38 }else if (i == 3) { 39 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY + \"error\", message + \":\" + i, correlationData); 40 }else { 41 rabbitTemplate.convertAndSend(ReliabilityMQConfig.EXCHANGE_NAME, ReliabilityMQConfig.ROUTING_KEY, message, correlationData); 42 } 43 } 44} 消费者：\n1@RabbitListener(queues = ReliabilityMQConfig.QUEUE_NAME) 2public void receiveMessage(String message, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag, Channel channel) throws InterruptedException { 3 try { 4 log.debug(\"[×] 开始处理消息: \" + message); 5 Thread.sleep(2000); 6 double p = RandomUtil.randomDouble(0, 1); 7 if (p \u003e= 0.5) { 8 throw new IOException(\"手动造成异常\"); 9 } 10 // 1. process success 11 channel.basicAck(deliveryTag, false); // deliveryTag:msgId; multiple=false:ackCurrentMsg else ackPreAllMsg 12 log.debug(\"[√] process Msg success: {}\", message); 13 } catch (IOException e) { 14 // 2. process fail 15 log.debug(\"[×] process Msg fail: \" + message); 16 try { 17 // 退回消息 18 channel.basicNack(deliveryTag, false, true); // msgId, 是否批量拒绝:false:仅拒绝当前Msg, true:拒绝所有deliveryTag小于等于当前的deliveryTag消息 ⭐⭐⭐ 消费失败时重新入队，确保消息不丢失。 19 } catch (IOException ioException) { 20 log.debug(\"[\u003c] Msg notAck fail\"); 21 } 22 } 23} 微服务解耦 订单超时取消 拼团交易 抽象责任链模板 定义抽象任务接口\n1public interface StrategyHandler\u003cT, D, R\u003e { 2 3 StrategyHandler DEFAULT = (T, D) -\u003e null; 4 5 R apply(T requestParameter, D dynamicContext) throws Exception; 6} 7 8public interface StrategyMapper\u003cT, D, R\u003e { 9 10 StrategyHandler\u003cT, D, R\u003e get(T requestParameter, D dynamicContext) throws Exception; 11 12} 定义抽象节点接口\n1public abstract class AbstractStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 protected StrategyHandler\u003cT, D, R\u003e defaultHandler = StrategyHandler.DEFAULT; 4 5 public R router(T requestParameter, D dynamicContext) throws Exception { 6 StrategyHandler\u003cT, D, R\u003e handler = get(requestParameter, dynamicContext); 7 if (handler != null) return handler.apply(requestParameter, dynamicContext); 8 return defaultHandler.apply(requestParameter, dynamicContext); 9 } 10 11} 大致就是 [apply + next]，责任链模式。\n1// 基本使用 2class XXX { 3 ObjectXXX nextNode; 4 5 apply{... =\u003e next()} 6 7 next{nextNode.apply()} 8} 多实例链路模式\n双向链表的实现思想\n定义链表：\n1public class Node\u003cE\u003e { 2 E item; 3 4 Node\u003cE\u003e next; 5 Node\u003cE\u003e prev; 6 7 public Node(Node\u003cE\u003e prev, E item, Node\u003cE\u003e next) { 8 this.item = item; 9 this.next = next; 10 this.prev = prev; 11 } 12} 定义节点处理对象\n1public interface ILogicHandler\u003cT, D, R\u003e { 2 3 // 子类可以不实现 4 default R next(T requestParameter, D dynamicContext) { 5 return null; 6 } 7 8 R apply(T requestParameter, D dynamicContext) throws Exception; 9 10} 实现具体的业务节点\n1public class RuleLogic201 implements ILogicHandler\u003cString, Rule02TradeRuleFactory.DynamicContext, String\u003e { 2 3 public String apply(String requestParameter, Rule02TradeRuleFactory.DynamicContext dynamicContext) throws Exception{ 4 5 // 具体业务逻辑; 6 7 return next(requestParameter, dynamicContext); 8 } 9 10} 装配业务责任链\n1public class LinkArmory\u003cT, D, R\u003e { 2 private final BusinessLinkedList\u003cT, D, R\u003e logicLink; 3 4 5 @SafeVarargs 6 public LinkArmory(String linkName, ILogicHandler\u003cT, D, R\u003e... logicHandlers) { 7 logicLink = new BusinessLinkedList\u003c\u003e(linkName); 8 for (ILogicHandler\u003cT, D, R\u003e logicHandler: logicHandlers){ 9 logicLink.add(logicHandler); 10 } 11 } 12 public BusinessLinkedList\u003cT, D, R\u003e getLogicLink() { 13 return logicLink; 14 } 15} 责任链实现业务管道 商品折扣价格试算\n1// 从工厂拿到对应的责任链出发节点 2=\u003e RootNode 3\t=\u003e multiThread[前置处理|检查信息] =\u003e doApply[业务+路由] 4=\u003e SwitchNode 5\t=\u003e multiThread[前置处理] =\u003e doApply[业务+路由] 6=\u003e TagNode 7 =\u003e doApply[业务+路由] 8=\u003e MarketNode 9\t=\u003e multiThread[⭐前置处理⭐拼单试算] =\u003e doApply[业务+路由] 10=\u003e EndNode 11\t=\u003e multiThread[前置处理] =\u003e doApply[业务|构建结果] 12 13// SwitchNode：根据条件判断业务是否降级or限流 14// TagNode：根据用户信息判断拼团活动能否参与与可见 15// MarketNode：根据拼团活动，计算折扣价格 16// 策略模式：根据优惠Id,计算不同的折扣 拼团锁单校验\n1// 实现具体的业务节点 2 3// 1. ActivityUsabilityRuleFilter：校验活动状态和活动时间的有效性 4 5// 2. UserTakeLimitRuleFilter：判断用户参与次数与活动限制次数关系 6 7// 装配业务责任链 拼团结算校验\n1// 1. SCRuleFilter: 校验拼团的渠道来源是否合法，是否在黑名单中 2// 2. SettableRuleFilter：拼团活动的用户支付时间是否在有效时间内 3// 3. OutTradeNoRuleFilter：外部交易单号是否正确 4// 4. EndRuleFilter：打包结果 AOP+消息订阅实现热更新 通过AOP编程和Redis发布/订阅功能实现业务规则（限流阈值、降级策略）的热更新\n自定义注解\n1@Retention(RetentionPolicy.RUNTIME) 2@Target(ElementType.FIELD) 3@Documented 4public @interface DCCValue { 5 String value() default \"\"; 6} 定义热更新服务\n1@Service 2public class DCCService { 3 4 /** 5 * 降级开关 0关闭 1开启 6 */ 7 @DCCValue(\"downgradeSwitch:0\") 8 private String downgradeSwitch; 9 10 @DCCValue(\"cutRange:100\") 11 private String cutRange; 12 13 public boolean isCutRange(String userId) { 14 // 计算哈希码的绝对值 15 int hashCode = Math.abs(userId.hashCode()); 16 17 // 获取最后两位 18 int lastTwoDigits = hashCode % 100; 19 20 // 判断是否在切量范围内 21 if (lastTwoDigits \u003c= Integer.parseInt(cutRange)) { 22 log.error(cutRange); 23 return true; 24 } 25 26 return false; 27 } 28 29 public boolean isDowngradeSwitch() { 30 return this.downgradeSwitch.equals(\"1\"); 31 } 32} ⭐注意：在SwitchNode中，调用这些方法进行判断是否放行\n基于Redis的发布订阅进行参数调整\n1/ DCCValueBeanFactory implements BeanPostProcessor 2private static final String BASE_CONFIG_PATH = \"group_buy_market_dcc_\"; 3 4private final RedissonClient redissonClient; 5 6private final Map\u003cString, Object\u003e dccObjGroup = new HashMap\u003c\u003e(); 7 8public DCCValueBeanFactory(RedissonClient redissonClient) { 9 this.redissonClient = redissonClient; 10} 11 12@Bean(\"dccTopic\") 13public RTopic dccRedisTopicListener(RedissonClient redissonClient) { 14 log.info(\"初始化Redis Topic监听事件 测试连通{}\", redissonClient.getBucket(\"test\").get()); 15 // 发布订阅模式的Topic实现 16 RTopic topic = redissonClient.getTopic(\"group_buy_market_dcc\"); 17 // 消息类型，回调接口：Topic名称，接收的消息 18 topic.addListener(String.class, ((charSequence, s) -\u003e { 19 log.info(\"监听到Redis Topic： {}\", charSequence.toString()); 20 String[] split = s.split(Constants.SPLIT); 21 22 // 获取值 23 String attribute = split[0]; 24 String key = BASE_CONFIG_PATH + attribute; 25 String value = split[1]; 26 27 // 设置值 =\u003e 可以存储任意类型的值（如 String、Integer、自定义对象等），Redisson 会自动进行序列化和反序列化。 28 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 29 boolean exists = bucket.isExists(); 30 if (!exists) return; 31 bucket.set(value); 32 33 Object objBean = dccObjGroup.get(key); // 获取内存中的对象 34 if (objBean == null) return; 35 36 Class\u003c?\u003e objBeanClass = objBean.getClass(); 37 // 检查objBean是否为代理对象 38 if (AopUtils.isAopProxy(objBean)) { 39 objBeanClass = AopUtils.getTargetClass(objBean); 40 } 41 42 try { 43 Field field = objBeanClass.getDeclaredField(attribute); 44 field.setAccessible(true); 45 field.set(objBean, value); 46 field.setAccessible(false); 47 48 log.info(\"DCC 节点监听，动态设置值 {} {}\", key,value); 49 } catch (Exception e) { 50 throw new RuntimeException(e); 51 } 52 53 })); 54 return topic; 55} 56 57 58// implements BeanPostProcessor 重写方法 -- 并在每个 bean 初始化完成后自动调用该方法。 59@Override 60public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { 61 // 注意：增加 AOP 代理后，获得类的方式要通过 AopProxyUtils.getTargetClass(bean); 不能直接 bean.class 因为代理后类的结构发生了变化，这样不能获得自己的自定义注解了 62 Class\u003c?\u003e targetBeanClass = bean.getClass(); 63 Object targetBeanObject = bean; 64 if (AopUtils.isAopProxy(targetBeanObject)) { 65 targetBeanClass = AopUtils.getTargetClass(targetBeanObject); 66 targetBeanObject = AopProxyUtils.getSingletonTarget(bean); 67 } 68\t69 // 这里判断该类是否有对应的自定义注解 70 Field[] fields = targetBeanClass.getDeclaredFields(); 71 for (Field field : fields) { 72 if (!field.isAnnotationPresent(DCCValue.class)) { 73 continue; 74 } 75 76 DCCValue dccValue = field.getAnnotation(DCCValue.class); 77 String value = dccValue.value(); 78 if (StringUtils.isBlank(value)) { 79 throw new RuntimeException(field.getName() + \"@DCCValue is not config value config case「isSwitch/isSwitch:1」\"); 80 } 81 82 String[] split = value.split(\":\"); 83 String key = BASE_CONFIG_PATH.concat(split[0]); 84 String defaultValue = split[1]; 85 86 String setValue = defaultValue; 87 88 try { 89 if (StringUtils.isBlank(defaultValue)) { 90 throw new RuntimeException(\"dcc config error \" + key + \" is not null - 请配置默认值！\"); 91 } 92 93 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 94 boolean exists = bucket.isExists(); 95 if (!exists) { 96 bucket.set(defaultValue); 97 } else { 98 setValue = bucket.get(); 99 } 100 101 field.setAccessible(true); 102 field.set(targetBeanObject, setValue); 103 field.setAccessible(false); 104 log.info(\"初始化值 key:{} value:{}\", key, setValue); 105 } catch (IllegalAccessException e) { 106 throw new RuntimeException(e); 107 } 108 109 dccObjGroup.put(key, targetBeanObject); 110 } 111 return bean; 112} 实现Api接口更新Redis中的值\n1@Override 2@GetMapping(\"update_config\") 3public Response\u003cBoolean\u003e updateConfig(@RequestParam String key, @RequestParam String value) { 4 try { 5 log.info(\"DCC 动态配置值变更 key:{} value:{}\", key, value); 6 dccTopic.publish(key + \",\" + value); 7 return Response.\u003cBoolean\u003ebuilder() 8 .code(ResponseCode.SUCCESS.getCode()) 9 .info(ResponseCode.SUCCESS.getInfo()) 10 .build(); 11 } catch (Exception e) { 12 log.error(\"DCC 动态配置值变更失败！ key:{} value:{} {}\", key, value, e.getMessage()); 13 return Response.\u003cBoolean\u003ebuilder() 14 .code(ResponseCode.UN_ERROR.getCode()) 15 .info(ResponseCode.UN_ERROR.getInfo()) 16 .build(); 17 } 18} 更新请求 =\u003e Redis =\u003e 订阅服务 =\u003e 修改参数\n",
  "wordCount" : "2706",
  "inLanguage": "en",
  "image": "http://longcoding.top/papermod-cover.png","datePublished": "2025-03-11T16:45:11+08:00",
  "dateModified": "2025-03-11T16:45:11+08:00",
  "author":{
    "@type": "Person",
    "name": "👨🏻‍🎓 LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://longcoding.top/posts/jobs/java_project_highlight/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://longcoding.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://longcoding.top/" accesskey="h" title="𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰 (Alt + H)">
                <img src="http://longcoding.top/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://longcoding.top/index.html" title="🏡 Home">
                    <span>🏡 Home</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/archives/" title="📃 Archives">
                    <span>📃 Archives</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/tags/" title="📑 Tags">
                    <span>📑 Tags</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/categories/" title="🗒️ Categories">
                    <span>🗒️ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/search/" title="🔍 Search">
                    <span>🔍 Search</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/about/" title="👨🏻‍🎓 About Me">
                    <span>👨🏻‍🎓 About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://longcoding.top/">Home</a>&nbsp;»&nbsp;<a href="http://longcoding.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      项目重难点
    </h1>
    <div class="post-description">
      简历项目重难点
    </div>
    <div class="post-meta"><span title='2025-03-11 16:45:11 +0800 CST'>March 11, 2025</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;2706 words&nbsp;·&nbsp;👨🏻‍🎓 LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e9%bb%91%e9%a9%ac%e7%82%b9%e8%af%84" aria-label="黑马点评：">黑马点评：</a><ul>
                        
                <li>
                    <a href="#%e7%99%bb%e5%bd%95%e7%9b%b8%e5%85%b3" aria-label="登录相关">登录相关</a></li>
                <li>
                    <a href="#%e8%b6%85%e5%8d%96%e9%97%ae%e9%a2%98" aria-label="超卖问题：">超卖问题：</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%ba%e4%b8%80%e5%8d%95%e9%97%ae%e9%a2%98" aria-label="一人一单问题：">一人一单问题：</a></li>
                <li>
                    <a href="#%e4%bc%98%e6%83%a0%e5%8d%b7%e7%a7%92%e6%9d%80" aria-label="优惠卷秒杀">优惠卷秒杀</a></li>
                <li>
                    <a href="#%e7%bc%93%e5%ad%98%e4%b8%89%e5%85%84%e5%bc%9f" aria-label="缓存三兄弟：">缓存三兄弟：</a></li>
                <li>
                    <a href="#redismysql%e6%95%b0%e6%8d%ae%e4%b8%80%e8%87%b4%e6%80%a7" aria-label="Redis&amp;MySQL数据一致性">Redis&amp;MySQL数据一致性</a></li></ul>
                </li>
                <li>
                    <a href="#%e4%ba%ae%e7%82%b9%e6%a8%a1%e5%9d%97" aria-label="亮点模块：">亮点模块：</a><ul>
                        
                <li>
                    <a href="#rabbitmq" aria-label="RabbitMQ">RabbitMQ</a><ul>
                        
                <li>
                    <a href="#%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86" aria-label="异步处理">异步处理</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93" aria-label="拼团交易">拼团交易</a><ul>
                        
                <li>
                    <a href="#%e6%8a%bd%e8%b1%a1%e8%b4%a3%e4%bb%bb%e9%93%be%e6%a8%a1%e6%9d%bf" aria-label="抽象责任链模板">抽象责任链模板</a></li>
                <li>
                    <a href="#%e8%b4%a3%e4%bb%bb%e9%93%be%e5%ae%9e%e7%8e%b0%e4%b8%9a%e5%8a%a1%e7%ae%a1%e9%81%93" aria-label="责任链实现业务管道">责任链实现业务管道</a></li>
                <li>
                    <a href="#aop%e6%b6%88%e6%81%af%e8%ae%a2%e9%98%85%e5%ae%9e%e7%8e%b0%e7%83%ad%e6%9b%b4%e6%96%b0" aria-label="AOP&#43;消息订阅实现热更新">AOP+消息订阅实现热更新</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><hr>
<h3 id="黑马点评">黑马点评：<a hidden class="anchor" aria-hidden="true" href="#黑马点评">#</a></h3>
<h4 id="登录相关">登录相关<a hidden class="anchor" aria-hidden="true" href="#登录相关">#</a></h4>
<ul>
<li>使用 JWT 实现无状态认证，登录成功后生成一个包含用户信息的 Token 返回给前端，由前端每次请求时携带在请求头中。后端通过拦截器统一拦截请求，解析并校验 Token 的合法性。</li>
</ul>
<p>&lt;用户信息只包括：userId，username，role等必要信息 =&gt; 安全&gt;</p>
<ul>
<li>
<p>校验通过后，我们会将解析出来的用户信息保存到 <code>ThreadLocal</code> 中，构建一个线程级的用户上下文，在整个请求处理流程中都可以方便地获取当前登录用户，避免层层传参，提升代码整洁度和可维护性。</p>
</li>
<li>
<p>ThreadLocal原理：每个线程拥有独立的ThreadLocalMap对象。所有线程使用同一个 <code>ThreadLocal</code> 对象作为键，但值互不影响。通过线程级别的变量隔离，避免多线程竞争，实现线程安全。</p>
</li>
</ul>
<h4 id="超卖问题">超卖问题：<a hidden class="anchor" aria-hidden="true" href="#超卖问题">#</a></h4>
<ol>
<li><em><strong>数据库层面：</strong></em>
<ul>
<li><em><strong>悲观锁（FOR UPDATE-行锁）</strong></em></li>
<li><em><strong>乐观锁（版本号法）</strong></em></li>
</ul>
</li>
<li><em><strong>应用层面：</strong></em>
<ul>
<li><em><strong>分布式锁（互斥）</strong></em></li>
<li><em><strong>缓存+消息队列</strong></em></li>
<li><em><strong>限流+熔断</strong></em></li>
</ul>
</li>
</ol>
<p><em><strong>1.1 行锁</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">BEGIN</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">-- 业务逻辑：检查库存是否足够，执行扣减操作
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="k">COMMIT</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>10000条(10线程循环1000次)请求，吞吐量：791.2/sec       互斥锁，串行访问</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baseMapper</span><span class="p">.</span><span class="na">selectSecKillStockForUpdate</span><span class="p">(</span><span class="n">voucherId</span><span class="p">);</span><span class="w"> </span><span class="c1">// Fordate加行锁，事务结束会释放</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;fail&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">,</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>1.2 CAS方法</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="ln">1</span><span class="cl"><span class="k">UPDATE</span><span class="w"> </span><span class="n">products</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>10000条(10线程循环1000次)请求，吞吐量：944.7/sec</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 注意把Stock不满足条件的过滤！</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 这个很关键 不要使用 set(::getStock, stock-1) 错误原因：基于应用层计算的值，而不是数据库的当前值。</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">gt</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="c1">// eq(::getStock, stock) </span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>⭐⭐⭐ MVCC(版本链+ReadView)  - 读操作而言</p>
<ul>
<li><strong>事务 B 的更新操作</strong>：
<ul>
<li>更新操作会直接操作数据库的当前值，而不是基于事务 B 的 ReadView。</li>
<li>事务 B 的更新操作会检查数据库的当前值，发现 <code>stock = 0</code>，因此更新失败。</li>
</ul>
</li>
</ul>
<p><em><strong>2.1 🏷️ JVM锁（单体）：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 该方法每次只会有一个线程执行，互斥</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">VoucherOrderService</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">	</span><span class="c1">// 查 </span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="c1">// 改</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">    
</span></span></span></code></pre></div><p>10000条(10线程循环1000次)请求，吞吐量：715.5/sec       互斥锁，串行访问</p>
<p><em><strong>2.2 🏷️分布式锁：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// seckill_key = &#34;seckill:product:1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// =Lua脚本(判断+扣减)=&gt; 再处理MySQL   // 原子化查询+修改 </span><span class="w">
</span></span></span></code></pre></div><p><em><strong>2.3 🏷️缓存+消息队列 （服务解耦）:</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 库存初始化：将MySQL商品库存存入Redis中，提升查询和扣减效率;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 库存预扣减(Redis)：用户请求时，先在 Redis 中扣减库存;  == Lua脚本</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">Long</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">SECKILL_SCRIPT</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">emptyList</span><span class="p">(),</span><span class="w"> </span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">exchangerName</span><span class="p">,</span><span class="w"> </span><span class="n">routingKey</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 订单异步处理(MQ):扣减成功 =&gt; MQ =&gt; 订单处理接口 =&gt; Redis&amp;MySQL一致。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&#34;voucherId&#34;</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><p>10000条(10线程循环1000次)请求，吞吐量：1485.7/sec</p>
<p>🏷️<em><strong>限流+熔断</strong></em>: （仅理论）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. Nginx限流(最基础，拦截恶意流量)  - 只针对IP</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">http</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">limit_req_zone</span><span class="w"> </span><span class="n">$binary_remote_addr</span><span class="w"> </span><span class="n">zone</span><span class="o">=</span><span class="n">mylimit</span><span class="p">:</span><span class="n">10m</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="n">100r</span><span class="o">/</span><span class="n">s</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">seckill</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">            </span><span class="n">limit_req</span><span class="w"> </span><span class="n">zone</span><span class="o">=</span><span class="n">mylimit</span><span class="w"> </span><span class="n">burst</span><span class="o">=</span><span class="n">50</span><span class="w"> </span><span class="n">nodelay</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//backend;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 2. Redis令牌桶(应用层用户级限流，精准控制)</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// def try_acquire_token(user_id, rate=5, capacity=10):</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">bucket_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s">&#34;token_bucket:{user_id}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">last_time_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="s">&#34;last_time:{user_id}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 下面需要为lua脚本  ====</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">.</span><span class="na">time</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">float</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">last_time_key</span><span class="p">)</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_time</span><span class="w">    
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="err">#</span><span class="w"> </span><span class="n">计算补充的令牌</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="n">tokens_to_add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">elapsed</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">rate</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="n">current_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">bucket_key</span><span class="p">)</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">capacity</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tokens_to_add</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="n">current_tokens</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">bucket_key</span><span class="p">,</span><span class="w"> </span><span class="n">current_tokens</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">消耗</span><span class="w"> </span><span class="n">1</span><span class="w"> </span><span class="n">个令牌</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">    </span><span class="n">r</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">last_time_key</span><span class="p">,</span><span class="w"> </span><span class="n">now</span><span class="p">)</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">更新时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">True</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">False</span><span class="w">    
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="c1">//  ====</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w"></span><span class="c1">// 3. 前端排队(减少无效请求，避免一窝蜂涌入)</span><span class="w">
</span></span></span></code></pre></div><h4 id="一人一单问题">一人一单问题：<a hidden class="anchor" aria-hidden="true" href="#一人一单问题">#</a></h4>
<p><em><strong>（首先不能重复下单，还要扣减库存，并且新增订单）</strong></em></p>
<ul>
<li>
<p>**<em>单体架构</em> **</p>
<ul>
<li>*** Redis-Lua脚本原子化查询库存+重复下单***</li>
<li><em><strong>synchronized加锁</strong></em> - UserId.toString().intern() 字符串常量池引用</li>
</ul>
</li>
<li>
<p><em><strong>集群架构</strong></em></p>
<ul>
<li><em><strong>分布式锁实现</strong></em></li>
</ul>
</li>
</ul>
<p><em><strong>1.1 🏷️Redis实现：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">if</span> <span class="p">(</span><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sadd&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1">-- ！！！初始化需要从MySQL中加载已经买过的用户</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="kr">return</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="kr">if</span> <span class="p">(</span><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sismember&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="n">userId</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="kr">then</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="kr">return</span> <span class="mi">2</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="kr">end</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">redis.call</span><span class="p">(</span><span class="s1">&#39;sadd&#39;</span><span class="p">,</span> <span class="n">orderKey</span><span class="p">,</span> <span class="n">userId</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">-- 在Redis中，使用Set集合存储买过的用户</span>
</span></span></code></pre></div><p><em><strong>1.2 🏷️JVM锁+MySQL实现：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">seckillVoucherMySQLAndMQUnique</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">oneOpt</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;已经卖完了！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">intern</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">transactionPostChannel</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">transactionPostChannel</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voucherOrderService</span><span class="p">.</span><span class="na">findVoucherOrderByUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;您买过了！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaUpdate</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setSql</span><span class="p">(</span><span class="s">&#34;stock = stock - 1&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">update</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">update</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;MySQL库存更新失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="n">VoucherOrder</span><span class="w"> </span><span class="n">voucherOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VoucherOrder</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="n">voucherOrder</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="n">voucherOrder</span><span class="p">.</span><span class="na">setVoucherId</span><span class="p">(</span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">voucherOrderService</span><span class="p">.</span><span class="na">setVoucherOrder</span><span class="p">(</span><span class="n">voucherOrder</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;MySQL插入失败&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="c1">// 下面只使用一个@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="nd">@Transactional</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="nf">seckillVoucherMySQLAndMQUnique</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">voucherId</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">stock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">oneOpt</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getStock</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stock</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;已经卖完了！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">toString</span><span class="p">().</span><span class="na">intern</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="n">VoucherSecKillService</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VoucherSecKillService</span><span class="p">)</span><span class="w"> </span><span class="n">AopContext</span><span class="p">.</span><span class="na">currentProxy</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">        </span><span class="n">o</span><span class="p">.</span><span class="na">transactionPostChannel</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">voucherId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w"></span><span class="c1">//⭐⭐⭐嵌套执行方法，且主方法没有@Transactional，需要代理对象来执行才能使业务生效</span><span class="w">
</span></span></span></code></pre></div><p>🏷️1 <em><strong>synchronized</strong></em> 锁的粒度降级了，变为当前用户Id 【userId.toString().intern() 添加到常量池，并返回常量池的引用】 ❌❌❌<strong>这里锁的单机，多个JVM的情况下，就寄了</strong></p>
<p>🏷️2 VoucherSecKillService o = (VoucherSecKillService) <strong>AopContext.currentProxy()</strong>;  拿到执行事务的代理对象</p>
<p>🏷️3  boolean isOrder = voucherOrderService.findVoucherOrderByUserId(userId); <strong>需要把是否下单锁住</strong>，否则，可能重复下单，因为这个条件可能多个线程同时满足！！！</p>
<p><em><strong>2.1 🏷️分布式锁现实</strong></em></p>
<p>解决单机JVM锁，在集群下失效的问题。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">-- 上锁，分布式的</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="err">不存在</span><span class="p">:</span><span class="err">创建并返回</span><span class="n">True</span>
</span></span></code></pre></div><p>业务 =&gt; 扣库存 + 创建订单</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">-- 解锁，分布式，只能解锁自己上的锁</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="o">//</span> <span class="err">如果可以释放别人的锁，会出现以下情况</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="o">//</span> <span class="err">事务</span><span class="n">A的锁过期释放了</span><span class="p">(</span><span class="err">这里没有续时间</span><span class="n">or暂时卡了</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="err">事务</span><span class="n">B加锁</span> <span class="o">=&gt;</span> <span class="err">事务</span><span class="n">A活了过来</span><span class="o">*</span><span class="err">解锁</span><span class="o">*</span> <span class="o">=&gt;</span> <span class="err">事务</span><span class="n">C加锁</span> <span class="p">...</span> 
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="err">事务</span><span class="n">B和C拿了同一把锁</span><span class="err">，寄了</span>  <span class="o">=&gt;</span> <span class="err">只允许删自己加的锁</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="err">事务</span><span class="n">A和B拿了同一把锁</span><span class="err">，寄了</span>  <span class="o">=&gt;</span> <span class="err">看门狗续时间</span>
</span></span></code></pre></div><p><em><strong>lua脚本</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">Boolean</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">setIfAbsent</span><span class="p">(</span><span class="n">lock_key</span><span class="p">,</span><span class="w"> </span><span class="n">lock_value</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">	</span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">SECKILL_UNLOCK_SCRIPT</span><span class="p">,</span><span class="w"> </span><span class="n">Collections</span><span class="p">.</span><span class="na">singletonList</span><span class="p">(</span><span class="n">lock_key</span><span class="p">),</span><span class="w"> </span><span class="n">lock_value</span><span class="p">);</span><span class="w"> </span><span class="c1">// 删除锁和判断锁是否当前线程拥有 原子化</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">    
</span></span></span></code></pre></div><p><em><strong>Redission</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">lock_key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">1</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">  </span><span class="c1">// 不阻塞</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">  </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">lock</span><span class="p">();</span><span class="w">  </span><span class="c1">// 阻塞,且未指定过期时间 =&gt; 触发看门狗</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"> </span><span class="p">{...}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">  </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>最开始我们的遇到自增ID问题，我们通过实现分布式ID解决了问题；后面我们在<strong>单体系统</strong>下遇到了<strong>一人多单超卖</strong>问题，我们通过<strong>乐观锁/悲观锁</strong>解决了；我们对业务进行了变更，将一人多单变成了<strong>一人一单</strong>，结果在<strong>高并发</strong>场景下同一用户发送相同请求仍然出现了超卖问题，我们通过<strong>悲观锁</strong>解决了；由于用户量的激增，我们将单体系统升级成了<strong>集群</strong>，结果由于<strong>锁只能在一个JVM中可见</strong>导致又出现了，在高并发场景下同一用户发送下单请求出现超卖问题，我们通过实现<strong>分布式锁</strong>成功解决集群下的<strong>超卖</strong>问题；释放锁时，<strong>判断锁是否是当前线程 和 删除锁两个操作</strong>不是原子性的，可能导致超卖问题，我们通过将两个操作封装到一个<strong>Lua脚本</strong>成功解决了；</p>
<p>为了解决锁的不可重入性，我们通过将锁以hash结构的形式存储，每次释放锁都value-1，获取锁value+1，从而实现锁的可重入性，并且将释放锁和获取锁的操作封装到Lua脚本中以确保原子性。</p>
<p>最最后，我们发现可以直接使用现有比较成熟的方案Redisson来解决上诉出现的所有问题🤣，什么不可重试、不可重入、超市释放、原子性等问题Redisson都提供相对应的解决方法（。＾▽＾）</p>
<h4 id="优惠卷秒杀">优惠卷秒杀<a hidden class="anchor" aria-hidden="true" href="#优惠卷秒杀">#</a></h4>
<p>异步下单：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 主线程</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">1</span><span class="p">.</span><span class="w"> </span><span class="n">Lua脚本</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">2</span><span class="p">.</span><span class="w"> </span><span class="n">成功</span><span class="o">=&gt;</span><span class="n">放入队列</span><span class="err">；</span><span class="n">失败</span><span class="o">=&gt;</span><span class="n">返回异常</span><span class="w">    
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">1</span><span class="p">.</span><span class="na">1</span><span class="p">.</span><span class="w"> </span><span class="n">Lua脚本</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">库存</span><span class="w"> </span><span class="o">=</span><span class="n">扣库存</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">是否下单</span><span class="w"> </span><span class="o">=</span><span class="n">记录用户下单</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">返回0</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">               </span><span class="n">返回1</span><span class="w">            </span><span class="n">返回2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 子线程</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">队列中取出订单信息</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">扣减卷库存</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">是否付款</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">更新成功</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">                            </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">End</span><span class="w">
</span></span></span></code></pre></div><img src="C:\Users\韦龙\AppData\Roaming\Typora\typora-user-images\image-20250316232011370.png" alt="image-20250316232011370" style="zoom:50%;" />
<h4 id="缓存三兄弟">缓存三兄弟：<a hidden class="anchor" aria-hidden="true" href="#缓存三兄弟">#</a></h4>
<p>💡<em><strong>缓存穿透</strong></em>： 恶意请求查询不存在的数据，绕过缓存直接访问数据库</p>
<p><img alt="image-20241121195359815" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121195359815.png"></p>
<ul>
<li><em><strong>布隆过滤器</strong></em></li>
</ul>
<ol>
<li>商品ID，通过多个哈希函数，将元素映射到bitMap中的多个位置，只有每个位置都为1才表明这个对象存在。</li>
<li>guava库有实现好的，直接用。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1"># 伪代码，仅供学习</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="k">class</span> <span class="nc">BloomFilter</span><span class="p">:</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="s2">        初始化布隆过滤器
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s2">        :param size: 位数组大小（m）
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s2">        :param hash_count: 哈希函数数量（k）
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span> <span class="o">=</span> <span class="n">hash_count</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">size</span>  <span class="c1"># 初始化位数组（全0）</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="s2">        添加元素到布隆过滤器
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">            <span class="c1"># 通过不同的种子模拟多个哈希函数</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 设置对应位为1</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl">    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="s2">        检查元素是否可能存在
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="s2">        :return: 
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="s2">            - True: 可能存在（可能有误判）
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="s2">            - False: 一定不存在
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash_count</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bit_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># 只要有一位为0，则一定不存在</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># 所有位均为1，可能存在</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="k">def</span> <span class="nf">_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="s2">        哈希函数（伪代码，实际可用MurmurHash等）
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="s2">        :param item: 输入元素
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="s2">        :param seed: 哈希种子（模拟不同哈希函数）
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="s2">        :return: 哈希值
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">        <span class="n">hash_value</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">            <span class="n">hash_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">hash_value</span> <span class="o">*</span> <span class="n">seed</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">        <span class="k">return</span> <span class="n">hash_value</span>
</span></span></code></pre></div><ul>
<li><em><strong>缓存空对象</strong></em></li>
</ul>
<p><em>🏷️ 缓存空对象实现方案</em></p>
<p><img alt="image-20241121195847292" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121195847292.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 缓存命中</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 不为null，不为&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">SeckillVoucher</span><span class="w"> </span><span class="n">seckillVoucher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">SeckillVoucher</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 未命中，是否是之前缓存的空对象</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">nonNull</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// &#34;&#34; 不为null</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;查询缓存空对象！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">SeckillVoucher</span><span class="w"> </span><span class="n">seckillVoucher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">SeckillVoucher</span><span class="p">::</span><span class="n">getVoucherId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">one</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 缓存空对象 一个线程重建缓存就好</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">CacheTestService</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">nonNull</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;查询缓存空对象！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">isNull</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessException</span><span class="p">(</span><span class="n">500</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;缓存空对象！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// 缓存重建</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="n">redisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">),</span><span class="w"> </span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">seckillVoucher</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>💡<em><strong>缓存雪崩</strong></em>：量缓存同时失效，导致请求全部压到数据库</p>
<p><img alt="image-20241121201618172" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121201618172.png"></p>
<ul>
<li>过期时间随机化 ⭐⭐⭐ baseline + random_offset</li>
<li>Hot数据<strong>定时</strong>刷新缓存  @Scheduled</li>
<li>多级缓存(本地-Redis-数据库)</li>
</ul>
<p>💡<em><strong>缓存击穿</strong></em>：热点 Key 突然失效，大量并发请求直接打到数据库</p>
<ul>
<li>互斥重建：第一个重建(MySQL=&gt;Redis)，后面的等一下再访问缓存</li>
<li>逻辑过期：返回过期数据，但是互斥(第一个访问的)重建缓存  ❗数据一致性不高</li>
</ul>
<p><img alt="image-20241121210053886" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20241121210053886.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 缓存击穿(热点Key，瞬时重建问题)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Shop</span><span class="w"> </span><span class="nf">queryWithMutex</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 先Redis</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cache:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">shopJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// Cache命中  shopJson 不为null,&#34;&#34;, &#34;\t&#34;(不全是空白字符)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isNotBlank</span><span class="p">(</span><span class="n">shopJson</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">shopJson</span><span class="p">,</span><span class="w"> </span><span class="n">Shop</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// 空对象</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shopJson</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// 为&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 实现缓存重建</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// 1.1 获取互斥锁</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryLock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="c1">// 1.2 判断是否获取成功</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="c1">// 1.3 失败则休眠且轮询</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">50</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">queryWithMutex</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w"> </span><span class="err">⭐⭐⭐</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="c1">// 未命中 =&gt; MySQL 缓存重建</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lambdaQuery</span><span class="p">().</span><span class="na">eq</span><span class="p">(</span><span class="n">Shop</span><span class="p">::</span><span class="n">getId</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">).</span><span class="na">one</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w"> </span><span class="c1">// 模拟复杂的重建任务</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="c1">// 将空对象缓存</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">            </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">RedisConstants</span><span class="p">.</span><span class="na">CACHE_NULL_TTL</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="c1">// log.debug(shop.toString());</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toJsonStr</span><span class="p">(</span><span class="n">shop</span><span class="p">),</span><span class="w"> </span><span class="n">RedisConstants</span><span class="p">.</span><span class="na">CACHE_SHOP_TTL</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">unlock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Shop</span><span class="w"> </span><span class="nf">queryWithLogicExpire</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 先Redis</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;cache:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="c1">// log.debug(&#34;Key:&#34; + key);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">shopJson</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stringRedisTemplate</span><span class="p">.</span><span class="na">opsForValue</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StrUtil</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">shopJson</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="c1">// 缓存不存在，查询数据库并回填</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">saveShop2Redis</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">20L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="c1">// RedisData:  private LocalDateTime expireTime;</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">    </span><span class="c1">//             private Object data;</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">    </span><span class="n">RedisData</span><span class="w"> </span><span class="n">redisData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">(</span><span class="n">shopJson</span><span class="p">,</span><span class="w"> </span><span class="n">RedisData</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">    </span><span class="n">Shop</span><span class="w"> </span><span class="n">shop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JSONUtil</span><span class="p">.</span><span class="na">toBean</span><span class="p">((</span><span class="n">JSONObject</span><span class="p">)</span><span class="w"> </span><span class="n">redisData</span><span class="p">.</span><span class="na">getData</span><span class="p">(),</span><span class="w"> </span><span class="n">Shop</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">redisData</span><span class="p">.</span><span class="na">getExpireTime</span><span class="p">().</span><span class="na">isAfter</span><span class="p">(</span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">        </span><span class="c1">// 未过期</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;lock:shop:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">    </span><span class="c1">// 过期进行更新</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryLock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">        </span><span class="c1">// 独立线程进行重建缓存</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">        </span><span class="n">CACHE_REBUILD_EXECUTOR</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">                </span><span class="n">saveShop2Redis</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">20L</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="na">printStackTrace</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">                </span><span class="n">unlock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w">        </span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shop</span><span class="p">;</span><span class="w">  </span><span class="c1">// 可能会返回过期数据。 因为没有进行等待</span><span class="w">
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="redismysql数据一致性">Redis&amp;MySQL数据一致性<a hidden class="anchor" aria-hidden="true" href="#redismysql数据一致性">#</a></h4>
<ul>
<li>先更新Redis，再更新MySQL ❌不推荐</li>
</ul>
<p><img alt="image-20250308135639431" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmGqn7lzt08zg5oJu4hJH-WsIxYk"></p>
<ul>
<li>先更新MySQL，再更新Redis ❌不推荐</li>
</ul>
<p><img alt="image-20250308140251136" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/Fp0jO35q6BMqKyzIsrb0NXRI8o6P"></p>
<ul>
<li>先删除Redis，再更新MySQL，最后写回Redis ❌不推荐</li>
</ul>
<p><img alt="image-20250308140614242" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FmEB4Dj9_pgrOuyHLfHhGqK04wHb"></p>
<ul>
<li>先更新MySQL，再删除Redis，等请求重新缓存(惰性) ✔️推荐</li>
<li>缓存双删除策略。更新MySQL之前，删除一次Redis；更新完MySQL后，再进行一次延迟删除 ✔️推荐</li>
</ul>
<p><img alt="image-20250308140849778" loading="lazy" src="http://sthda9dn6.hd-bkt.clouddn.com/FsUaIXIOz9NnJkJ0Lf1fUebBQpHI"></p>
<p>数据库没问题，但是缓存有问题，等待一段实践</p>
<ul>
<li>使用Binlog异步更新缓存，监听数据库的binlog变化，通过异步方式更新Redis缓存 ✔️推荐</li>
</ul>
<h3 id="亮点模块">亮点模块：<a hidden class="anchor" aria-hidden="true" href="#亮点模块">#</a></h3>
<h4 id="rabbitmq">RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#rabbitmq">#</a></h4>
<ul>
<li>
<h5 id="异步处理">异步处理<a hidden class="anchor" aria-hidden="true" href="#异步处理">#</a></h5>
</li>
<li>
<p><em><strong>削峰填谷（流量削峰）</strong></em></p>
<p>=&gt; <strong>削峰</strong>（缓冲流量）：流量高峰时，MQ 充当“缓冲区”，将请求先存储到消息队列中，避免系统直接崩溃。</p>
<p>​     <strong>填谷</strong>（平滑流量）：消费者按<strong>稳定速率</strong>消费消息，保证系统负载均衡。</p>
<ul>
<li>消息可靠投递
<ul>
<li>发布确认机制 - 是否重发</li>
<li>RabbitMQ持久化</li>
</ul>
</li>
<li>消息可靠消费
<ul>
<li>手动ACK</li>
<li>限流机制 - 一次只取一个消息</li>
<li>死信队列（❗兜底）</li>
</ul>
</li>
<li>消息唯一消费
<ul>
<li>Redis存储消费过的ID (多个消费者接收到相同的消息时候)  - <strong>发布/订阅（Fanout 交换机-广播）</strong>，消息会被<strong>复制到多个队列。</strong></li>
<li>⭐RabbitMQ 中，<strong>默认情况下，消息只会被一个消费者消费</strong>，<strong>队列是点对点模型</strong>，一条消息只能被消费一次。<strong>多个消费者订阅同一个队列时，RabbitMQ 采用</strong> <strong>“轮询分发”</strong>（Round Robin），每条消息只会被其中一个消费者处理。</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="w">				 </span><span class="n">RabbitMQ</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">publisher</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">exchanger</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">queue</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="n">error</span><span class="w">     </span><span class="n">1</span><span class="p">.</span><span class="w">     </span><span class="n">4</span><span class="p">.</span><span class="w">      </span><span class="n">2</span><span class="p">.</span><span class="w">   </span><span class="n">5</span><span class="p">.</span><span class="w">  </span><span class="n">3</span><span class="p">.</span><span class="w">    
</span></span></span></code></pre></div><p>1.2. 投递失败 =&gt; 重新投递</p>
<p>4.5. MQ宕机 =&gt; 持久化</p>
<p>3.. ACK确认 =&gt; 重新消费</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">rebbitmq</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">	</span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nt">publisher-confirm-type</span><span class="p">:</span><span class="w"> </span><span class="l">correlated </span><span class="w"> </span><span class="c"># 开启发布确认机制</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="nt">publisher-returns</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">   </span><span class="c"># 投递消息抵达队列</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="nt">listener</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">        </span><span class="nt">simple</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">        </span><span class="nt">acknowledge-mode</span><span class="p">:</span><span class="w"> </span><span class="l">manual </span><span class="w"> </span><span class="c"># 消费者手动确认ACK</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">            </span><span class="nt">prefetch</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">   </span><span class="c"># 限制消费者一次处理一条数据</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>生产者：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 确保交换机收到消息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setConfirmCallback</span><span class="p">(((</span><span class="n">correlationData</span><span class="p">,</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[√] Product: Msg send success!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;[×] Product: Msg send fail!, 原因: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">cause</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">putIfAbsent</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">retrySendMsg</span><span class="p">(</span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 确保队列收到消息</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setReturnsCallback</span><span class="p">(</span><span class="n">returnedMessage</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;[×] 消息路由失败!, 原因: {}, Msg: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">returnedMessage</span><span class="p">.</span><span class="na">getReplyText</span><span class="p">(),</span><span class="w"> </span><span class="n">returnedMessage</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 这里Roting Key错误，配置错误，投递死信队列比较好</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">});</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">retrySendMsg</span><span class="p">(</span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msgCacheMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="n">msgRetryCount</span><span class="p">.</span><span class="na">computeIfPresent</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">integer</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">integer</span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;发送到死信交换机！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="c1">// ⭐⭐⭐模拟错误情况 1. 2.</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[&gt;] Send Msg: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CorrelationData</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="n">msgCacheMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">correlationData</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="c1">// 缓存消息</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;error&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;error&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;:&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">            </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">EXCHANGE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">ROUTING_KEY</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><em><strong>消费者：</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReliabilityMQConfig</span><span class="p">.</span><span class="na">QUEUE_NAME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">receiveMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="nd">@Header</span><span class="p">(</span><span class="n">AmqpHeaders</span><span class="p">.</span><span class="na">DELIVERY_TAG</span><span class="p">)</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[×] 开始处理消息: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="n">2000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RandomUtil</span><span class="p">.</span><span class="na">randomDouble</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">.</span><span class="na">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IOException</span><span class="p">(</span><span class="s">&#34;手动造成异常&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// 1. process success</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">channel</span><span class="p">.</span><span class="na">basicAck</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">  </span><span class="c1">// deliveryTag:msgId; multiple=false:ackCurrentMsg else ackPreAllMsg</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[√] process Msg success: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 2. process fail</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[×] process Msg fail: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="c1">// 退回消息</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">basicNack</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// msgId, 是否批量拒绝:false:仅拒绝当前Msg, true:拒绝所有deliveryTag小于等于当前的deliveryTag消息  ⭐⭐⭐ 消费失败时重新入队，确保消息不丢失。</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioException</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;[&lt;] Msg notAck fail&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><em><strong>微服务解耦</strong></em></li>
<li><em><strong>订单超时取消</strong></em></li>
</ul>
<h3 id="拼团交易">拼团交易<a hidden class="anchor" aria-hidden="true" href="#拼团交易">#</a></h3>
<h4 id="抽象责任链模板">抽象责任链模板<a hidden class="anchor" aria-hidden="true" href="#抽象责任链模板">#</a></h4>
<p>定义抽象任务接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>定义抽象节点接口</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handler</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">handler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defaultHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>大致就是 [apply + next]，责任链模式。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 基本使用</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">XXX</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">ObjectXXX</span><span class="w"> </span><span class="n">nextNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">apply</span><span class="p">{...</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">()}</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="n">next</span><span class="p">{</span><span class="n">nextNode</span><span class="p">.</span><span class="na">apply</span><span class="p">()}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<p><strong>多实例链路模式</strong></p>
<p>双向链表的实现思想</p>
<p>定义链表：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">Node</span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>定义节点处理对象</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="c1">// 子类可以不实现</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">next</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>实现具体的业务节点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RuleLogic201</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Rule02TradeRuleFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">Rule02TradeRuleFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// 具体业务逻辑;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>装配业务责任链</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LinkArmory</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@SafeVarargs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkArmory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">linkName</span><span class="p">,</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">logicLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">linkName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicHandler</span><span class="p">:</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="n">logicLink</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">logicHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLogicLink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="责任链实现业务管道">责任链实现业务管道<a hidden class="anchor" aria-hidden="true" href="#责任链实现业务管道">#</a></h4>
<p>商品折扣价格试算</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 从工厂拿到对应的责任链出发节点</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RootNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">|</span><span class="n">检查信息</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">TagNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MarketNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="err">⭐</span><span class="n">前置处理</span><span class="err">⭐</span><span class="n">拼单试算</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">|</span><span class="n">构建结果</span><span class="o">]</span><span class="w">    
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// SwitchNode：根据条件判断业务是否降级or限流</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// TagNode：根据用户信息判断拼团活动能否参与与可见</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// MarketNode：根据拼团活动，计算折扣价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 	      策略模式：根据优惠Id,计算不同的折扣</span><span class="w">
</span></span></span></code></pre></div><p>拼团锁单校验</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 实现具体的业务节点</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 1. ActivityUsabilityRuleFilter：校验活动状态和活动时间的有效性</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 2. UserTakeLimitRuleFilter：判断用户参与次数与活动限制次数关系</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// 装配业务责任链</span><span class="w">
</span></span></span></code></pre></div><p>拼团结算校验</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 1. SCRuleFilter: 校验拼团的渠道来源是否合法，是否在黑名单中</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 2. SettableRuleFilter：拼团活动的用户支付时间是否在有效时间内</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 3. OutTradeNoRuleFilter：外部交易单号是否正确</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 4. EndRuleFilter：打包结果</span><span class="w">
</span></span></span></code></pre></div><h4 id="aop消息订阅实现热更新">AOP+消息订阅实现热更新<a hidden class="anchor" aria-hidden="true" href="#aop消息订阅实现热更新">#</a></h4>
<p>通过AOP编程和Redis发布/订阅功能实现业务规则（限流阈值、降级策略）的热更新</p>
<p>自定义注解</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DCCValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>定义热更新服务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cm">     * 降级开关 0关闭 1开启
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;downgradeSwitch:0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">downgradeSwitch</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;cutRange:100&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cutRange</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCutRange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 计算哈希码的绝对值</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="c1">// 获取最后两位</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// 判断是否在切量范围内</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cutRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">cutRange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDowngradeSwitch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>⭐注意：在SwitchNode中，调用这些方法进行判断是否放行</p>
<p>基于Redis的发布订阅进行参数调整</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="o">/</span><span class="w"> </span><span class="n">DCCValueBeanFactory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanPostProcessor</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;group_buy_market_dcc_&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">DCCValueBeanFactory</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">redissonClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;dccTopic&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">RTopic</span><span class="w"> </span><span class="nf">dccRedisTopicListener</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;初始化Redis Topic监听事件 测试连通{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// 发布订阅模式的Topic实现</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">RTopic</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getTopic</span><span class="p">(</span><span class="s">&#34;group_buy_market_dcc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="c1">// 消息类型，回调接口：Topic名称，接收的消息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="n">topic</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">charSequence</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;监听到Redis Topic： {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">charSequence</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="c1">// 获取值</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">attribute</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="c1">// 设置值 =&gt; 可以存储任意类型的值（如 String、Integer、自定义对象等），Redisson 会自动进行序列化和反序列化。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">objBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取内存中的对象</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="c1">// 检查objBean是否为代理对象</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">objBean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">objBean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBeanClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">objBean</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC 节点监听，动态设置值 {} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="c1">// implements BeanPostProcessor 重写方法  -- 并在每个 bean 初始化完成后自动调用该方法。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="c1">// 注意：增加 AOP 代理后，获得类的方式要通过 AopProxyUtils.getTargetClass(bean); 不能直接 bean.class 因为代理后类的结构发生了变化，这样不能获得自己的自定义注解了</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopProxyUtils</span><span class="p">.</span><span class="na">getSingletonTarget</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span><span class="c1">// 这里判断该类是否有对应的自定义注解</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">.</span><span class="na">isAnnotationPresent</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="n">DCCValue</span><span class="w"> </span><span class="n">dccValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccValue</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;@DCCValue is not config value config case「isSwitch/isSwitch:1」&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;dcc config error &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is not null - 请配置默认值！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">            </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">                </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;初始化值 key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">        </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>实现Api接口更新Redis中的值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;update_config&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateConfig</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC 动态配置值变更 key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">dccTopic</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;DCC 动态配置值变更失败！ key:{} value:{} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>更新请求 =&gt; Redis =&gt; 订阅服务 =&gt; 修改参数</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://longcoding.top/posts/jobs/collection/">
    <span class="title">« Prev</span>
    <br>
    <span>集合面试题笔记</span>
  </a>
  <a class="next" href="http://longcoding.top/posts/jobs/jvm/">
    <span class="title">Next »</span>
    <br>
    <span>JVM面试题笔记</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://longcoding.top/">LongCoding&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
