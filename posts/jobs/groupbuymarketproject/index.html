<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Grouptradingproject | LongCoding&#39;s Blog</title>
<meta name="keywords" content="Projects">
<meta name="description" content="Grouptradingproject">
<meta name="author" content="ğŸ‘¨ğŸ»â€ğŸ“ LongWei">
<link rel="canonical" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://longcoding.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://longcoding.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://longcoding.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://longcoding.top/apple-touch-icon.png">
<link rel="mask-icon" href="http://longcoding.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://longcoding.top/posts/jobs/groupbuymarketproject/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="Grouptradingproject">
  <meta property="og:description" content="Grouptradingproject">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:modified_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:tag" content="Projects">
      <meta property="og:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:title" content="Grouptradingproject">
<meta name="twitter:description" content="Grouptradingproject">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://longcoding.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Grouptradingproject",
      "item": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Grouptradingproject",
  "name": "Grouptradingproject",
  "description": "Grouptradingproject",
  "keywords": [
    "Projects"
  ],
  "articleBody": "æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ **é¡¹ç›®èƒŒæ™¯ï¼š**ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚\nç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡ ä¸šåŠ¡æµç¨‹ï¼š\nè¿è¥è§’åº¦ï¼š 1. ç»™å“ªäº›å•†å“é…ç½®æ‹¼å•ï¼›2. æ‹¼å›¢å•†å“æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼šæŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚ ç”¨æˆ·è§’åº¦ï¼š 1. å‚ä¸æ‹¼å›¢ï¼Œé¦–æ¬¡å‘èµ·orå‚ä¸ç°æœ‰ï¼Œæ‹¼å•å®Œæˆå›è°ƒé€šçŸ¥ã€‚ åº“è¡¨è®¾è®¡ï¼š 1. äººç¾¤è®¾è®¡ï¼Œå°†æ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥ç‰¹å®šRedisè®°å½•ä¸­ã€‚ æ‹¼å›¢æ´»åŠ¨ï¼ŒæŠ˜æ‰£çš„å¤šç§è¿­ä»£ã€‚ åº“è¡¨è®¾è®¡ï¼š\næ‹¼å›¢é…ç½®è¡¨ï¼š\næ‹¼å›¢æ´»åŠ¨è¡¨ï¼šè®¾å®šäº†æ‹¼å›¢çš„æˆå›¢è§„åˆ™ï¼Œäººç¾¤æ ‡ç­¾çš„ä½¿ç”¨å¯ä»¥é™å®šå“ªäº›äººå¯è§ï¼Œå“ªäº›äººå¯å‚ä¸ã€‚ æŠ˜æ‰£é…ç½®è¡¨ï¼šæ‹†åˆ†å‡ºæ‹¼å›¢ä¼˜æƒ åˆ°ä¸€ä¸ªæ–°çš„è¡¨è¿›è¡Œå¤šæ¡é…ç½®ã€‚å¦‚æœæŠ˜æ‰£è¿˜æœ‰æ›´å¤šçš„å¤æ‚è§„åˆ™ï¼Œåˆ™å¯ä»¥é…ç½®æ–°çš„æŠ˜æ‰£è§„åˆ™è¡¨è¿›è¡Œå¤„ç†ã€‚ äººç¾¤æ ‡ç­¾è¡¨ï¼šä¸“é—¨æ¥åšäººç¾¤è®¾è®¡è®°å½•çš„ï¼Œè¿™3å¼ è¡¨å°±æ˜¯ä¸ºäº†æŠŠç¬¦åˆè§„åˆ™çš„äººç¾¤IDï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·IDï¼Œå…¨éƒ¨è·‘ä»»åŠ¡åˆ°ä¸€ä¸ªè®°å½•ä¸‹è¿›è¡Œä½¿ç”¨ã€‚ æ¯”å¦‚é»‘ç«ç‘°äººç¾¤ã€é«˜å‡€å€¼äººç¾¤ã€æ‹¼å›¢å±¥çº¦ç‡90%ä»¥ä¸Šçš„äººç¾¤ç­‰ã€‚ å‚ä¸æ‹¼å›¢è¡¨ï¼š\næ‹¼å›¢è´¦æˆ·è¡¨ï¼šè®°å½•ç”¨æˆ·çš„æ‹¼å›¢å‚ä¸æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†é™åˆ¶ç”¨æˆ·çš„å‚ä¸æ‹¼å›¢æ¬¡æ•°ï¼Œå¦å¤–æ˜¯ä¸ºäº†äººç¾¤æ ‡ç­¾ä»»åŠ¡ç»Ÿè®¡æ•°æ®ã€‚ ç”¨æˆ·æ‹¼å•è¡¨ï¼šå½“æœ‰ç”¨æˆ·å‘èµ·é¦–æ¬¡æ‹¼å•çš„æ—¶å€™ï¼Œäº§ç”Ÿæ‹¼å•idï¼Œå¹¶è®°å½•æ‰€éœ€æˆå›¢çš„æ‹¼å•è®°å½•ï¼Œå¦å¤–æ˜¯å†™ä¸Šæ‹¼å›¢çš„çŠ¶æ€ã€å”¯ä¸€ç´¢å¼•ã€å›è°ƒæ¥å£ç­‰ã€‚è¿™æ ·æ‹¼å›¢å®Œæˆå°±å¯ä»¥å›è°ƒå¯¹æ¥çš„å¹³å°ï¼Œé€šçŸ¥å®Œæˆäº†ã€‚ã€å¾®ä¿¡æ”¯ä»˜ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡ï¼Œå›è°ƒæ”¯ä»˜ç»“æœï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿å¹³å°åŒ–å¯¹æ¥ã€‘å½“å†æœ‰ç”¨æˆ·å‚ä¸åï¼Œåˆ™å†™å…¥ç”¨æˆ·æ‹¼å•æ˜ç»†è¡¨ã€‚ç›´è‡³è¾¾æˆæ‹¼å›¢ å›è°ƒä»»åŠ¡è¡¨ï¼šå½“æ‹¼å›¢å®Œæˆåï¼Œè¦åšå›è°ƒå¤„ç†ã€‚ä½†å¯èƒ½ä¼šæœ‰å¤±è´¥ï¼Œæ‰€ä»¥åŠ å…¥ä»»åŠ¡çš„æ–¹å¼è¿›è¡Œè¡¥å¿ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦å¯¹æ¥çš„å¹³å°ï¼Œè‡ªå·±æŸ¥è¯¢æ‹¼å›¢ç»“æœã€‚ ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡ è¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼šåº“è¡¨è®¾è®¡ã€ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚\nç”¨ä¾‹å›¾ï¼šç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼› æµç¨‹å›¾ï¼šåŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼› æ—¶åºå›¾ï¼šå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³» ç³»ç»Ÿæ¶æ„ï¼š\nMVCæ¶æ„\nDDDæ¶æ„\nç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡ å¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§\n=\u003e è®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚\næ¨¡å‹è®¾è®¡\né“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜\né¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ æ¶µç›–ï¼šStrategyMapper, StrategyHandler /ËˆstrÃ¦tÉ™dÊ’i/ã€AbstractStrategyRouterã€‚ é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚ ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚ ç¼–ç å®ç°\né¡¹ç›®å·¥ç¨‹çš„Typesæ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿\n1.1 ç­–ç•¥æ˜ å°„å™¨\n1public interface StrategyMapper\u003cT, D, R\u003e { 2 3 /** 4 * è·å–å¾…æ‰§è¡Œç­–ç•¥ 5 * 6 * @param requestParameter å…¥å‚ 7 * @param dynamicContext ä¸Šä¸‹æ–‡ 8 * @return è¿”å‚ 9 * @throws Exception å¼‚å¸¸ 10 */ 11 StrategyHandler\u003cT, D, R\u003e get(T requestParameter, D dynamicContext) throws Exception; 12 13} ç”¨äºè·å–æ¯ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œè´£ä»»é“¾åŠ å¼ºç‰ˆ Tï¼ŒDï¼ŒRï¼šå…¥å‚ï¼Œä¸Šä¸‹æ–‡ï¼Œåå‚ 1.2 ç­–ç•¥å—ç†å™¨\n1public interface StrategyHandler\u003cT, D, R\u003e { 2 3 StrategyHandler DEFAULT = (T, D) -\u003e null; 4 5 R apply(T requestParameter, D dynamicContext) throws Exception; 6 7} æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œåˆ©ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ç»™åé¢æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚ 1.3 ç­–ç•¥è·¯ç”±å™¨\n1public abstract class AbstractStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 @Getter 4 @Setter 5 protected StrategyHandler\u003cT, D, R\u003e defaultStrategyHandler = StrategyHandler.DEFAULT; 6\t7 // ä¼ªä»£ç  8 public R router(T, D) throws Exception { 9 StrategyHandler strategyHandler = get(T, D); 10 if(null != strategyHandler) return strategyHandler.apply(T, D); 11 return defaultStrategyHandler.apply(T, D); 12 } 13 14} æ‰§è¡Œå…·ä½“èŠ‚ç‚¹ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¼ é€’åˆ°é»˜è®¤èŠ‚ç‚¹ä¸­ ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½ é¦–é¡µè¯•ç®—\nå½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚\n1. Modelå®šä¹‰å¯¹è±¡ï¼› 2. æœåŠ¡åŠŸèƒ½å®ç°ï¼Œtrialè¯•ç®—æ¨¡å—ï¼›3. ä¸šåŠ¡æµè½¬çš„åŠŸèƒ½èŠ‚ç‚¹\næ¨¡å‹é“¾è·¯\n1IIndexGroupBuyMarketService 2=\u003e RootNode 3\t=\u003e multiThread[å‰ç½®å¤„ç†|æ£€æŸ¥ä¿¡æ¯] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 4=\u003e SwitchNode 5\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 6=\u003e MarketNode 7\t=\u003e multiThread[â­å‰ç½®å¤„ç†â­æ‹¼å•è¯•ç®—] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 8=\u003e EndNode 9\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡|æ„å»ºç»“æœ] è·¯ç”±ç­–ç•¥æ¨¡æ¿[èŠ‚ç‚¹æ¨¡æ¿]\n1public abstract class AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 public R router(T requestParameter, D dynamicContext) throws Exception {} 4 @Override 5 public R apply(T requestParameter, D dynamicContext) throws Exception { 6 multiThread() // å‰ç½®å¤„ç† 7 return doApply() // ä¸šåŠ¡é€»è¾‘ 8 } 9 protected abstract void multiThread(T requestParameter, D dynamicContext) throws; 10 protected abstract R doApply(T requestParameter, D dynamicContext) throws; 1public abstract class AbstractGroupBuyMarketSupport\u003cT, D, R\u003e extends AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e { 2 3 protected long timeout = 500; 4 @Resource 5 protected IActivityRepository repository; 6 7 @Override 8 protected void multiThread(T, D) { 9 // ç©ºæ–¹æ³•ï¼Œéœ€è¦å®ç°çš„è¯ï¼Œè®©å­ç±»é‡å†™ 10 } 11 12} å…·ä½“èŠ‚ç‚¹å®ä¾‹\nå·¥ä½œæµï¼šå‰ç½®å¤„ç† =\u003e ä¸šåŠ¡é€»è¾‘ =\u003e è·¯ç”±\n1public class RootNode extends AbstractGroupBuyMarketSupport\u003cMarketProductEntity, DynamicContext, TrialBalanceEntity\u003e { 2 3 @Resource 4 private SwitchNode nextNode; 5 6 @Override 7 protected TrialBalanceEntity doApply(T, D, R) throws Exception { 8 log.info(\"ä¸šåŠ¡å¤„ç†\") 9 return router(requestParameter, dynamicContext); // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ 10 } 11 12 @Override 13 public StrategyHandler\u003cT, D, R\u003e get(T, D, R) { 14 return switchNode; 15 } 16} â­â­â­\nå¼‚æ­¥æ•°æ®åŠ è½½\n1// å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½® 2XXXThreadTask taskA = new XXXThreadTask(...); 3FutureTask\u003cXXX\u003e xxxFutureTaskA = new FutureTask\u003c\u003e(XXXThreadTask); 4threadPoolExecutor.execute(xxxFutureTask); 5 6// å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ - 7XXXThreadTask taskB = new XXXThreadTask(...); 8FutureTask\u003cXXX\u003e xxxFutureTaskB = new FutureTask\u003c\u003e(XXXThreadTask); 9threadPoolExecutor.execute(xxxFutureTask); 10 11// å†™å…¥ä¸Šä¸‹æ–‡ï¼Œ å‰ç½®æŸ¥è¯¢æ•°æ® 12dynamicContext.setXXXA(xxxFutureTaskA.get(TIMEOUT, TimeUnit.MINUTES)); // é˜»å¡æŒ‡å®šæ—¶é—´ 13dynamicContext.setXXXB(xxxFutureTaskB.get(TIMEOUT, TimeUnit.MINUTES)); ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®— ä¸åŒä¼˜æƒ æ¨¡å¼ =\u003e ç­–ç•¥æ¨¡å¼å®ç°\nå®šä¹‰æ¥å£\n1public interface IDiscountCalculateService { 2 BigDecimal calculate(...); 3} æŠ½è±¡æ¨¡æ¿\n1public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService { 2 3 @Override 4 public BigDecimal calculate(...) { 5 // 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤ 6 if (IsFilter){ 7 boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId()); 8 if (!isCrowdRange) return originalPrice; 9 } 10 // 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®— 11 return doCalculate(originalPrice, groupBuyDiscount); 12 } 13 14 // äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ  15 private boolean filterTagId(String userId, String tagId) { 16 // todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ† 17 return true; 18 } 19\t20 // å…·ä½“è®¡ç®—å‡½æ•° 21 protected abstract BigDecimal doCalculate(...); 22 23} æŠ˜æ‰£æ–¹æ³•\n1@Slf4j 2@Service(\"MJ\") // æ»¡å‡ä¼˜æƒ  3public class MJCalculateService extends AbstractDiscountCalculateService { 4 5 @Override 6 public BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) { 7 log.info(\"ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}\", groupBuyDiscount.getDiscountType().getCode()); 8 9 // æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ 10 String marketExpr = groupBuyDiscount.getMarketExpr(); 11 String[] split = marketExpr.split(Constants.SPLIT); 12 BigDecimal x = new BigDecimal(split[0].trim()); 13 BigDecimal y = new BigDecimal(split[1].trim()); 14 15 // ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»· 16 if (originalPrice.compareTo(x) \u003c 0) { 17 return originalPrice; 18 } 19 20 // æŠ˜æ‰£ä»·æ ¼ 21 BigDecimal deductionPrice = originalPrice.subtract(y); 22 23 // åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’± 24 if (deductionPrice.compareTo(BigDecimal.ZERO) \u003c= 0) { 25 return new BigDecimal(\"0.01\"); 26 } 27 28 return deductionPrice; 29 } 30 31} è¥é”€è°ƒç”¨\n1// MarketNode 2 3public TrialBalanceEntity doApply(T, D) throws Exception { 4 log.info(\"æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡\"); 5 6 dynamicContext.getGroupBuyActivityDiscountVO(); 7 groupBuyActivityDiscountVO.getGroupBuyDiscount(); 8 9 dynamicContext.getSkuVO(); 10 11 // å…·ä½“çš„ç­–ç•¥ï¼Œä¼˜æƒ æ¨¡å¼ 12 IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan()); 13 if (null == discountCalculateService) { 14 log.info(\"...\", JSON.toString(discountCalculateServiceMap.keys())) 15 throw ... 16 } 17 18 // æŠ˜æ‰£ä»·æ ¼ 19 BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount); 20 dynamicContext.setDeductionPrice(deductionPrice); 21 22 return router(requestParameter, dynamicContext); 23} å­¦ä¹ ç‚¹ï¼š\n1@Service(\"Key\") 2XXX implement IDiscountCalculateService {} 3 4@Resource // â­å…ˆæŒ‰åç§°ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹æ³¨å…¥ 5private Map\u003cString, IDiscountCalculateService\u003e discountCalculateServiceMap; ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›† ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœ\näººç¾¤æ ‡ç­¾æ˜¯æ ¹æ®ç”¨æˆ·ä¸šåŠ¡è¡Œä¸ºé‡‡é›†çš„\næ•°æ®åº“è¡¨ï¼š\ncrowd_tags ï¼šç»Ÿè®¡åŠŸèƒ½ï¼›\ncrowd_tags_detailï¼štag_id =\u003e user_id; å…·ä½“æ¯ä¸ªäººç¾¤éƒ½æœ‰è°ï¼›\ncrowd_tags_jobï¼štag_id =\u003e batch_id, tag_relu:æ¶ˆè´¹è§„åˆ™;\næµç¨‹ï¼š\næ ¹æ®tag_id, batch_id æŸ¥è¯¢crowd_tags_jobå¾—åˆ°å¯¹åº”æ‰¹æ¬¡ä»»åŠ¡ é‡‡é›†ç”¨æˆ·æ•°æ® æ•°æ®å†™å…¥è®°å½• // æš‚å­˜ æ•°æ®å†™å…¥æ•°æ®åº“ =\u003e crowd_tags_detail æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡ =\u003e crowd_tags æ•°æ®å†™å…¥æ•°æ®åº“\n1@Override 2public void addCrowdTagsUserId(String tagId, String userId) { 3 CrowdTagsDetail crowdTagsDetailReq = new CrowdTagsDetail(); 4 crowdTagsDetailReq.setTagId(tagId); 5 crowdTagsDetailReq.setUserId(userId); 6 try { 7 crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq); 8 // è·å–BitSet 9 RBitSet bitSet = redisService.getBitSet(tagId); // tagId:{userId, ...}:BitSet 10 bitSet.set(redisService.getIndexFromUserId(userId), true); // Longç±»å‹å•¥çš„è½¬æ¢ä¸€ä¸‹è·Ÿbitseté•¿åº¦ä¸€è‡´ï¼Œå°½å¯èƒ½å‡åŒ€ 11 } catch (DuplicateKeyException ignore) { 12 // å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª 13 } 14} â—â—â—redisä¸­ BitSet å°±æ˜¯bitç±»å‹çš„hashtableï¼Œ è€Œ bitmapæ˜¯å­—ç¬¦ä¸²ï¼›\nå¤§è‡´æ€è·¯ï¼š\n1// æ•°æ®å†™å…¥æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æŠŠbitsetä¸­ä½ç½®ç½®1ï¼Œè¡¨ç¤ºè¿™ä¸ªç”¨æˆ·å­˜åœ¨äºè¿™ä¸ªé›†åˆ 2// æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·Idï¼ŒæŸ¥bitset // è¿™é‡Œç”¨æˆ·ID=\u003ebitset:key, ä½¿ç”¨ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œä½¿å¾—æ•£åˆ—å°½å¯èƒ½å‡åŒ€ ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ† å°†å•†å“SKUä¸æ´»åŠ¨è¡¨ è§£è€¦ =\u003e SKU\u0026Activityå…³è”è¡¨ã€‚ä½¿å¾—å¤šä¸ªå•†å“å¯ä»¥ç»‘å®šåŒä¸€ä¸ªæ´»åŠ¨ID(ä¼˜æƒ æ‹¼å›¢æ´»åŠ¨)\n1# MarketèŠ‚ç‚¹ åˆ¤æ–­ å•†å“æ˜¯å¦å­˜åœ¨ä¼˜æƒ æ´»åŠ¨ 2=\u003e ErrorNode =\u003e ä¸å­˜åœ¨ä¼˜æƒ æ´»åŠ¨ 3=\u003e EndNode =\u003e è¿”å›ä¼˜æƒ çš„è¯•ç®—ä»·æ ¼ æµç¨‹ï¼š\n1// MarketNode =\u003e multi-thread æ£€æŸ¥æ˜¯å¦å­˜åœ¨å•†å“\u003c=\u003e æ´»åŠ¨å…³è”è¡¨ 2@Override 3public GroupBuyActivityDiscountVO call() throws Exception { 4 SCSkuActivityVO scSkuActivityVO = activityRepository.querySCSkuActivityBySCGoodsId(goodsId); 5 // log.error(JSON.toJSONString(scSkuActivityVO)); 6 if (scSkuActivityVO == null) return null; 7 return activityRepository.queryGroupBuyActivityDiscountVOById(scSkuActivityVO.getActivityId()); 8} 1// marketNode è·¯ç”± 2if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 3 return errorNode; 4} 5return tagNode; 1// ErrorNode åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼ŒæŠ›å‡ºæ— æ‹¼å›¢é…ç½® 2log.info(\"æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}\", requestParameter.getUserId(), JSON.toJSONString(requestParameter)); 3 4if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 5 log.info(\"å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}\", requestParameter.getGoodsId()); 6 throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo()); 7} 8 9return TrialBalanceEntity.builder().build(); ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤ é™åˆ¶æ‹¼å›¢çš„äººç¾¤\næµç¨‹1ï¼š\n1MarketNode =\u003e TagNode =\u003e EndNode 1// TagNode æ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ èƒ½çœ‹è§æ‹¼å›¢ï¼Œæ˜¯å¦å‚ä¸æ‹¼å›¢ tag_scope = {1,2} ç¬¬ä¸€ä½é™åˆ¶æ˜¯å¦å¯è§ï¼Œç¬¬äºŒä½æ˜¯å¦é™åˆ¶å‚ä¸ 2// redis:bitset =\u003e tag_id:{...} å­˜æ”¾æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ· 3 4// è·å–æ‹¼å›¢ä¿¡æ¯ 5GroupBuyActivityDiscountVO activityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO(); 6String tagId = activityDiscountVO.getTagId(); 7boolean visible = activityDiscountVO.isVisible(); 8boolean enable = activityDiscountVO.isEnable(); 9 10// æ— ç‰¹å®šäººç¾¤ä¿¡æ¯, äººäººèƒ½æ“ä½œ 11if (StringUtils.isBlank(tagId)) { 12 dynamicContext.setVisible(true); 13 dynamicContext.setEnable(true); 14 return router(requestParameter, dynamicContext); 15} 16 17// æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œç‰¹å®šäººç¾¤èƒ½çœ‹ 18boolean isWithin = repository.isTagCrowdRange(tagId, requestParameter.getUserId()); 19dynamicContext.setVisible(visible || isWithin); 20dynamicContext.setEnable(enable || isWithin); 21 22return router(requestParameter, dynamicContext); 23 24 25// =\u003e isTagCrowdRange function 26// xiaofugeã€liergouåœ¨é‡Œé¢ 27RBitSet bitSet = redisService.getBitSet(tagId); 28if (!bitSet.isExists()) return true; 29// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨äººç¾¤ä¸­ 30return bitSet.get(redisService.getIndexFromUserId(userId)); ç¬¬2-8èŠ‚ åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ ç›®çš„ï¼šå¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ\n=\u003e åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚\nä½¿ç”¨Redisä½œä¸ºé›†ä¸­åŒ–å‚¨å­˜ç³»ç»Ÿçš„å¥½å¤„ï¼Œæ–¹ä¾¿ä¸€å¤„ä¿®æ”¹å˜é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„å®ä¾‹è¿›è¡Œå˜æ›´ï¼\næµé‡é™çº§æˆ–åˆ‡é‡\n1// è‡ªå®šä¹‰æ³¨è§£ 2@Retention(RetentionPolicy.RUNTIME) 3@Target(ElementType.FIELD) 4@Documented 5public @interface DCCValue { 6 String value() default \"\"; 7} 8 9// åŠ¨æ€ä¸­å¿ƒæ§åˆ¶ -- ä½œç”¨äºé™çº§ 10@Service 11public class DCCService { 12 13 /** 14 * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯ 15 */ 16 @DCCValue(\"downgradeSwitch:0\") 17 private String downgradeSwitch; 18 19 @DCCValue(\"cutRange:100\") 20 private String cutRange; 21 22 public boolean isCutRange(String userId) { 23 // è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼ 24 int hashCode = Math.abs(userId.hashCode()); 25 26 // è·å–æœ€åä¸¤ä½ 27 int lastTwoDigits = hashCode % 100; 28 29 // åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†… 30 if (lastTwoDigits \u003c= Integer.parseInt(cutRange)) { 31 log.error(cutRange); 32 return true; 33 } 34 35 return false; 36 } 37 38 public boolean isDowngradeSwitch() { 39 return this.downgradeSwitch.equals(\"1\"); 40 } 41} 42 43// SwitchNodeä¸­ è¿›è¡Œæµé‡æ§åˆ¶ 44// æ ¹æ®ç”¨æˆ·IDåˆ‡é‡ 45String userId = requestParameter.getUserId(); 46 47// åˆ¤æ–­æ˜¯å¦é™çº§ 48if (activityRepository.downgradeSwitch()) { 49 log.info(\"æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}\", userId); 50 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 51} 52 53// åˆ¤æ–­æ˜¯å¦åˆ‡é‡ 54if (activityRepository.cutRange(userId)) { 55 log.info(\"æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}\", userId); 56 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 57} åˆ©ç”¨Redisçš„Topicäº‹ä»¶å‘å¸ƒè®¢é˜… è¿›è¡Œ ä¿®æ”¹\nBeanPostProcessor èƒ½å¤Ÿå½“SpringBeanåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œ\n1// DCCValueBeanFactory implements BeanPostProcessor 2private static final String BASE_CONFIG_PATH = \"group_buy_market_dcc_\"; 3 4private final RedissonClient redissonClient; 5 6private final Map\u003cString, Object\u003e dccObjGroup = new HashMap\u003c\u003e(); 7 8public DCCValueBeanFactory(RedissonClient redissonClient) { 9 this.redissonClient = redissonClient; 10} 11 12@Bean(\"dccTopic\") 13public RTopic dccRedisTopicListener(RedissonClient redissonClient) { 14 log.info(\"åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}\", redissonClient.getBucket(\"test\").get()); 15 // å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç° 16 RTopic topic = redissonClient.getTopic(\"group_buy_market_dcc\"); 17 // æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯ 18 topic.addListener(String.class, ((charSequence, s) -\u003e { 19 log.info(\"ç›‘å¬åˆ°Redis Topicï¼š {}\", charSequence.toString()); 20 String[] split = s.split(Constants.SPLIT); 21 22 // è·å–å€¼ 23 String attribute = split[0]; 24 String key = BASE_CONFIG_PATH + attribute; 25 String value = split[1]; 26 27 // è®¾ç½®å€¼ =\u003e å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ 28 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 29 boolean exists = bucket.isExists(); 30 if (!exists) return; 31 bucket.set(value); 32 33 Object objBean = dccObjGroup.get(key); // è·å–å†…å­˜ä¸­çš„å¯¹è±¡ 34 if (objBean == null) return; 35 36 Class\u003c?\u003e objBeanClass = objBean.getClass(); 37 // æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ 38 if (AopUtils.isAopProxy(objBean)) { 39 objBeanClass = AopUtils.getTargetClass(objBean); 40 } 41 42 try { 43 Field field = objBeanClass.getDeclaredField(attribute); 44 field.setAccessible(true); 45 field.set(objBean, value); 46 field.setAccessible(false); 47 48 log.info(\"DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}\", key,value); 49 } catch (Exception e) { 50 throw new RuntimeException(e); 51 } 52 53 })); 54 return topic; 55} 56 57 58@Override 59public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { 60 // æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº† 61 Class\u003c?\u003e targetBeanClass = bean.getClass(); 62 Object targetBeanObject = bean; 63 if (AopUtils.isAopProxy(targetBeanObject)) { 64 targetBeanClass = AopUtils.getTargetClass(targetBeanObject); 65 targetBeanObject = AopProxyUtils.getSingletonTarget(bean); 66 } 67 68 Field[] fields = targetBeanClass.getDeclaredFields(); 69 for (Field field : fields) { 70 if (!field.isAnnotationPresent(DCCValue.class)) { 71 continue; 72 } 73 74 DCCValue dccValue = field.getAnnotation(DCCValue.class); 75 String value = dccValue.value(); 76 if (StringUtils.isBlank(value)) { 77 throw new RuntimeException(field.getName() + \"@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€\"); 78 } 79 80 String[] split = value.split(\":\"); 81 String key = BASE_CONFIG_PATH.concat(split[0]); 82 String defaultValue = split[1]; 83 84 String setValue = defaultValue; 85 86 try { 87 if (StringUtils.isBlank(defaultValue)) { 88 throw new RuntimeException(\"dcc config error \" + key + \" is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼\"); 89 } 90 91 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 92 boolean exists = bucket.isExists(); 93 if (!exists) { 94 bucket.set(defaultValue); 95 } else { 96 setValue = bucket.get(); 97 } 98 99 field.setAccessible(true); 100 field.set(targetBeanObject, setValue); 101 field.setAccessible(false); 102 log.info(\"åˆå§‹åŒ–å€¼ key:{} value:{}\", key, setValue); 103 } catch (IllegalAccessException e) { 104 throw new RuntimeException(e); 105 } 106 107 dccObjGroup.put(key, targetBeanObject); 108 } 109 return bean; 110} Controller\n1@Override 2@GetMapping(\"update_config\") 3public Response\u003cBoolean\u003e updateConfig(@RequestParam String key, @RequestParam String value) { 4 try { 5 log.info(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}\", key, value); 6 dccTopic.publish(key + \",\" + value); 7 return Response.\u003cBoolean\u003ebuilder() 8 .code(ResponseCode.SUCCESS.getCode()) 9 .info(ResponseCode.SUCCESS.getInfo()) 10 .build(); 11 } catch (Exception e) { 12 log.error(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}\", key, value, e.getMessage()); 13 return Response.\u003cBoolean\u003ebuilder() 14 .code(ResponseCode.UN_ERROR.getCode()) 15 .info(ResponseCode.UN_ERROR.getInfo()) 16 .build(); 17 } 18} â±ï¸25/3/24-23:34\nç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å• 25/3/25/ 20:37\nå®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆï¼Œå›¢è´­å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºï¼šåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€å·ï¼‰ï¼Œåˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚ ç”¨æˆ·ä»¥æ‹¼å›¢çš„æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚åˆ›å»ºè®¢å•ä½¿ç”¨æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ã€‚ æ‹¼å›¢è¡¨(ç›®æ ‡é‡ã€å®Œæˆé‡ã€é”å•é‡)ï¼Œé”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œä¸èƒ½å†å‚ä¸è¯¥æ‹¼å›¢ã€‚æ‹¼å›¢è¶…æ—¶ï¼Œé‡Šæ”¾ç©ºé—²ä½ç½®è®©å…¶ä»–ç”¨æˆ·å‚ä¸. Trade Repository / rÉªËˆpÉ’zÉ™t(É™)ri /\n1// ç®€å•å®ç°æ­¥éª¤ 2// OutTradeNO æ¨¡æ‹Ÿç”Ÿæˆ è®¢å•IDæ¨¡æ‹Ÿç”Ÿæˆ, TeamIDæ¨¡æ‹Ÿç”Ÿæˆ. ä¸¤å¼ è¡¨:1.è®°å½•æ‹¼å›¢ä¸­æ¯ä¸ªç”¨æˆ·çš„ä¿¡æ¯ 2. è®°å½•è¯¥æ‹¼å›¢ä¿¡æ¯. 3 4// â­ä»“å‚¨ä¸šåŠ¡å®ç° 5// åˆ¤æ–­æ˜¯å¦æœ‰å›¢ -- ä¸€è¡Œè®°å½•å­˜å‚¨æ¯ä¸ªæ‹¼å›¢çš„ä¿¡æ¯ 6// é¦–æ¬¡åˆ™åˆ›å»ºæ‹¼å›¢è®¢å•. åˆå§‹åŒ–è¡¨2 7// å¦åˆ™åŠ å…¥å…¶ä»–äººçš„å›¢ è¡¨2 æ‹¼å›¢äººæ•°+1 8 9// æ’å…¥è¯¥ç”¨æˆ·çš„æ‹¼å›¢ä¿¡æ¯åˆ°è¡¨1; æ¯ä¸ªç”¨æˆ·ä¸€è¡Œ 10 11// â­æ§åˆ¶å™¨ä¸šåŠ¡å®ç° 12// 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯ 13// 2. æŸ¥è¯¢ç”¨æˆ·outTradeNoæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡,å¹‚ç­‰æ€§ 14// 3. æŸ¥è¯¢æ‹¼å›¢æ˜¯å¦äººæ•°å·²æ»¡è¶³ 15// 4. è¥é”€ä¼˜æƒ è¯•ç®— 16// 5. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿçœ‹è§æ‹¼å›¢å’Œå‚ä¸ 17// 6. æ‹¼å›¢é”å• =\u003e ä»“å‚¨ä¸šåŠ¡ 18// 7. è¿”å›ç»“æœ ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡ 25/4/8/ 15:53\nå…ˆå‰çš„è´£ä»»é“¾æ¨¡æ¿éƒ½æ˜¯å†™æ­»çš„ã€‚æœ¬ç« å†…å®¹ä¸ºï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘å’Œé“¾æ¥é€»è¾‘è§£è€¦ã€‚\næŠ½è±¡\nç®€å•çš„å•ä¾‹é“¾\n1// 1. IlogicChainArmory: è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹ 2// next() 3//\tappendNext() 4// 2. ILogicLink extends IlogicChainArmory: å¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³• 5//\tapply() 6// 3. AbstractLogicLink extends ILogicLink: å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³• 7// next() 8//\tappendNext() 9// apply() è¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„ç±»ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ ILogicLink next è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚\nå¤šä¾‹-é“¾è·¯æ¨¡å¼\nå¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚\n1// éœ€è¦è®¾è®¡çš„ç±» 2// 1. Node \u0026 LinkedList extends ILink 3// åŒå‘é“¾è¡¨èŠ‚ç‚¹ \u0026 åŒå‘é“¾è¡¨ 4 5// 2. BusinessLinkedList extends LinkedList 6// ä»å¤´åˆ°å°¾æ‰§è¡Œå„ä¸ªèŠ‚ç‚¹ 7 8// 3. ILogicHandler -- å®šä¹‰ä»»åŠ¡ 9 10// 4. LinkArmory -- åˆ›å»ºé“¾è¡¨å¹¶è£…é…èŠ‚ç‚¹ 11// public LinkArmory(String linkName, ILogicHandler... logicHandlers) 12// private final BusinessLinkedList logicLink; 1// ç”¨æ³• 2// 1. å®šä¹‰ RuleLogicNode extends ILogicHandler 3// 2. new LinkArmory\u003c\u003e(\"demo01\", ruleLogic201, ruleLogic202, ...); å…·ä½“ä¼ªä»£ç \n1public class LinkedList\u003cE\u003e implements ILink\u003cE\u003e { 2 3 /** 4 * è´£ä»»é“¾åç§° 5 * */ 6 @Getter 7 private final String name; 8 transient int size = 0; 9 transient Node\u003cE\u003e first; 10 transient Node\u003cE\u003e last; 11 12 public LinkedList(String name) { 13 this.name = name; 14 } 15 16 // å¤´æ’èŠ‚ç‚¹ 17 void linkFirst(E e) { 18 final Node\u003cE\u003e f = first; 19 final Node\u003cE\u003e newNode = new Node\u003c\u003e(null, e, f); 20 first = newNode; 21 if (f == null) 22 last = newNode; 23 else 24 f.prev = newNode; 25 size++; 26 } 27 28 // å°¾æ’æ³• 29 void linkLast(E e) { 30 final Node\u003cE\u003e l = last; 31 final Node\u003cE\u003e newNode = new Node\u003c\u003e(l, e, null); 32 last = newNode; 33 if (l == null) { 34 first = newNode; 35 } else { 36 l.next = newNode; 37 } 38 size++; 39 } 40 41 @Override 42 public boolean add(E e) { 43 linkLast(e); 44 return true; 45 } 46 47 @Override 48 public boolean addFirst(E e) { 49 linkFirst(e); 50 return true; 51 } 52 53 @Override 54 public boolean addLast(E e) { 55 linkLast(e); 56 return true; 57 } 58 59 @Override 60 public boolean remove(Object o) { 61 if (o == null) { 62 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 63 if (x.item == null) { 64 unlink(x); 65 return true; 66 } 67 } 68 } else { 69 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 70 if (o.equals(x.item)) { 71 unlink(x); 72 return true; 73 } 74 } 75 } 76 return false; 77 } 78\t79 // åˆ é™¤èŠ‚ç‚¹ï¼Œæ³¨æ„æ˜¯åŒå‘é“¾è¡¨ 80 E unlink(Node\u003cE\u003e x) { 81 final E element = x.item; 82 final Node\u003cE\u003e next = x.next; 83 final Node\u003cE\u003e prev = x.prev; 84 85 // xä¸ºå¤´èŠ‚ç‚¹ 86 if (prev == null) { 87 first = next; 88 } else { 89 prev.next = next; 90 x.prev = null; 91 } 92 93 // xä¸ºæœ«å°¾ 94 if (next == null) { 95 last = x.prev; 96 } else { 97 next.prev = prev; 98 x.next = null; 99 } 100 101 x.item = null; 102 size--; 103 return element; 104 } 105 106 @Override 107 public E get(int index) { 108 return node(index).item; 109 }\t110\t111 // æ ¹æ®indexï¼Œåˆ¤æ–­æ˜¯å‰å‘è¿˜æ˜¯åå‘ 112 private Node\u003cE\u003e node(int index) { 113 if (index \u003c (size \u003e\u003e 1)) { 114 Node\u003cE\u003e x = first; 115 for (int i = 0; i \u003c index; i++) { 116 x = x.next; 117 } 118 return x; 119 } else { 120 Node\u003cE\u003e x = last; 121 for (int i = size-1; i \u003e index; i--) { 122 x = x.prev; 123 } 124 return x; 125 } 126 } 127 128 @Override 129 public void printLinkList() { 130 if (this.size == 0) { 131 System.out.printf(\"é“¾è¡¨ä¸ºç©º\"); 132 } else { 133 Node\u003cE\u003e temp = first; 134 System.out.print(\"ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š\" + first.item + \" å°¾èŠ‚ç‚¹ï¼š\" + last.item + \" æ•´ä½“ï¼š\"); 135 while (temp != null) { 136 System.out.print(temp.item + \"ï¼Œ\"); 137 temp = temp.next; 138 } 139 System.out.println(); 140 } 141 } 142} ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤ 2025-4-8 17:30\nè¯¥ç« èŠ‚è¡¥å……ï¼šè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚\n1// Logic chain 2// 1. æ£€æŸ¥å‚æ•° 3// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ ¹æ®å¤–éƒ¨OrderId 4// 3. åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨æ˜¯å¦æ»¡ 5// 4. è¥é”€è¯•ç®— -- ç»™å‡ºæŠ˜æ‰£ä»·æ ¼ 6// 5. äººç¾¤é™å®š -- ç‰¹å®šäººç¾¤æ‰èƒ½æ‹¼å›¢ 7// 6. æ‹¼å›¢é”å• -- 1. ä¿®æ”¹æ´»åŠ¨è¡¨å¯¹åº”çš„ä¿¡æ¯ 2. æ’å…¥ä¸€æ¡æ‹¼å›¢è®°å½• 8// 6.1. äº¤æ˜“è§„åˆ™è¿‡æ»¤ -- æ£€æŸ¥æ´»åŠ¨æ—¶é—´ + æ£€æŸ¥æ‹¼å›¢æ¬¡æ•° â­æœ¬èŠ‚ä¸»è¦è¿™éƒ¨åˆ† å…·ä½“å°±æ˜¯å®šä¹‰ä¸€äº› è´£ä»»é“¾èŠ‚ç‚¹(æ‹¦æˆªå™¨)\n1@Slf4j 2@Service 3public class ActivityUsabilityRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 // æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨ 13 GroupBuyActivityEntity groupBuyActivityEntity = repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId()); 14 15 // æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€ 16 if (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivityEntity.getStatus())) { 17 log.info(\"æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0101); 19 } 20 21 // æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´ 22 Date now = new Date(); 23 if (now.before(groupBuyActivityEntity.getStartTime()) || now.after(groupBuyActivityEntity.getEndTime())) { 24 log.info(\"æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}\", requestParameter.getActivityId()); 25 throw new AppException(ResponseCode.E0102); 26 } 27 28 dynamicContext.setGroupBuyActivity(groupBuyActivityEntity); 29 30 // èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹ 31 return next(requestParameter, dynamicContext); 32 } 33} 1@Slf4j 2@Service 3public class UserTakeLimitRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity(); 13 14 Integer count = repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId()); 15 16 if (groupBuyActivity.getTakeLimitCount() != null \u0026\u0026 count \u003e= groupBuyActivity.getTakeLimitCount()) { 17 log.info(\"ç”¨æˆ·å‚æ•°æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0103); 19 } 20 21 return TradeRuleFilterBackEntity.builder() 22 .userTakeOrderCount(count) 23 .build(); 24 } 25} ç»„è£…è´£ä»»é“¾ â€“ BusinessLinkedList å…·ä½“ä¸šåŠ¡\n1@Bean(\"tradeRuleFilter\") 2public BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e 3 tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) { 4 // ç»„è£…é“¾ 5 LinkArmory\u003cTradeRuleCommandEntity, DynamicContext, TradeRuleFilterBackEntity\u003e filter = new LinkArmory\u003c\u003e(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾\", activityUsabilityRuleFilter, userTakeLimitRuleFilter); 6 // é“¾å¯¹è±¡ 7 return filter.getLogicLink(); 8} LinkArmory â€“ çœŸæ­£çš„æŠ½è±¡è£…é…è´£ä»»é“¾\n1@SafeVarargs 2public LinkArmory(String linkName, ILogicHandler\u003cT, D, R\u003e... logicHandlers) { 3 logicLink = new BusinessLinkedList\u003c\u003e(linkName); 4 for (ILogicHandler\u003cT, D, R\u003e logicHandler: logicHandlers){ 5 logicLink.add(logicHandler); 6 } 7} 8public BusinessLinkedList\u003cT, D, R\u003e getLogicLink() { 9 return logicLink; 10} ç”¨æ³•\n1@Resource 2private BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e tradeRuleFilter; 3 4tradeRuleFilter.aaply(...) ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡ 25/4/8 21:19\næ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚\né‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚\nâ­â­â­ æ‰€æœ‰ç”¨æˆ·å®Œæˆæ”¯ä»˜å, æœ€åä¸€ä¸ªç”¨æˆ·çš„ç»“ç®—è§¦å‘å›è°ƒäº‹ä»¶!\n1@Transactional(timeout = 500) 2@Override 3public void settlementMarketPayOrder(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate) { 4 UserEntity userEntity = groupBuyTeamSettlementAggregate.getUserEntity(); 5 GroupBuyTeamEntity groupBuyTeamEntity = groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity(); 6 TradePaySuccessEntity tradePaySuccessEntity = groupBuyTeamSettlementAggregate.getTradePaySuccessEntity(); 7 8 // 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€ 9 GroupBuyOrderList groupBuyOrderList = new GroupBuyOrderList(); 10 groupBuyOrderList.setUserId(userEntity.getUserId()); 11 groupBuyOrderList.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo()); 12 int updateOrderStatus2COMPLETE = groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderList); 13 if (1 != updateOrderStatus2COMPLETE) { 14 throw new AppException(ResponseCode.UPDATE_ZERO); 15 } 16\t17 // 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ 18 int updateAddCount = groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId()); 19 if (1 != updateAddCount) { 20 throw new AppException(ResponseCode.UPDATE_ZERO); 21 } 22 23 // 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€ 24 if (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == 1) { 25 int i = groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId()); 26 if (1 != i) { 27 throw new AppException(ResponseCode.UPDATE_ZERO); 28 } 29 30 // æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å¤–éƒ¨è®¢å•å·åˆ—è¡¨ 31 List\u003cString\u003e outOrderNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId()); 32 33 // æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½• 34 NotifyTask notifyTask = NotifyTask.builder() 35 .activityId(groupBuyTeamEntity.getActivityId()) 36 .teamId(groupBuyTeamEntity.getTeamId()) 37 .notifyUrl(\"æš‚æ— \") 38 .notifyCount(0) 39 .notifyStatus(0) 40 .build(); 41 notifyTask.setParameterJson(JSON.toJSONString(new HashMap\u003cString, Object\u003e() {{ 42 put(\"teamId\", groupBuyTeamEntity.getTeamId()); 43 put(\"outTradeNoList\", outOrderNoList); 44 }})); 45 46 notifyTaskDao.insert(notifyTask); 47 } 48 49} è¿™é‡Œç®—æ˜¯æ”¯ä»˜æˆåŠŸåçš„å›è°ƒ\n",
  "wordCount" : "2800",
  "inLanguage": "en",
  "image": "http://longcoding.top/papermod-cover.png","datePublished": "2025-03-23T19:36:21+08:00",
  "dateModified": "2025-03-23T19:36:21+08:00",
  "author":{
    "@type": "Person",
    "name": "ğŸ‘¨ğŸ»â€ğŸ“ LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://longcoding.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://longcoding.top/" accesskey="h" title="ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“° (Alt + H)">
                <img src="http://longcoding.top/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°&#39;ğ“¼ ğ“‘ğ“µğ“¸ğ“°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://longcoding.top/index.html" title="ğŸ¡ Home">
                    <span>ğŸ¡ Home</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/archives/" title="ğŸ“ƒ Archives">
                    <span>ğŸ“ƒ Archives</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/tags/" title="ğŸ“‘ Tags">
                    <span>ğŸ“‘ Tags</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/categories/" title="ğŸ—’ï¸ Categories">
                    <span>ğŸ—’ï¸ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/search/" title="ğŸ” Search">
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/about/" title="ğŸ‘¨ğŸ»â€ğŸ“ About Me">
                    <span>ğŸ‘¨ğŸ»â€ğŸ“ About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://longcoding.top/">Home</a>&nbsp;Â»&nbsp;<a href="http://longcoding.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Grouptradingproject
    </h1>
    <div class="post-description">
      Grouptradingproject
    </div>
    <div class="post-meta"><span title='2025-03-23 19:36:21 +0800 CST'>March 23, 2025</span>&nbsp;Â·&nbsp;14 min&nbsp;Â·&nbsp;2800 words&nbsp;Â·&nbsp;ğŸ‘¨ğŸ»â€ğŸ“ LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e5%b9%b3%e5%8f%b0%e7%b3%bb%e7%bb%9f" aria-label="æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e7%ac%ac1-2%e8%8a%82-%e6%8b%bc%e5%9b%a2%e5%ba%93%e8%a1%a8%e8%ae%be%e8%ae%a1" aria-label="ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡">ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac1-3%e8%8a%82-%e7%a0%94%e5%8f%91%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1" aria-label="ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡">ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-2%e8%8a%82-%e8%af%95%e7%ae%97%e6%a8%a1%e5%9e%8b%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-3%e8%8a%82-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%bc%82%e6%ad%a5%e6%95%b0%e6%8d%ae%e5%8a%a0%e8%bd%bd" aria-label="ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½</a></li>
                <li>
                    <a href="#%e7%ac%ac2-4%e8%8a%82-%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f%e4%bc%98%e6%83%a0%e6%8a%98%e6%89%a3%e8%ae%a1%e7%ae%97" aria-label="ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—</a></li>
                <li>
                    <a href="#%e7%ac%ac2-5%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e6%95%b0%e6%8d%ae%e9%87%87%e9%9b%86" aria-label="ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†</a></li>
                <li>
                    <a href="#%e7%ac%ac2-6%e8%8a%82-%e5%ba%93%e8%a1%a8%e6%8b%86%e5%88%86" aria-label="ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†">ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†</a></li>
                <li>
                    <a href="#%e7%ac%ac2-7%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e8%8a%82%e7%82%b9%e8%bf%87%e6%bb%a4" aria-label="ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-8%e8%8a%82--%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae%e5%bc%80%e5%85%b3%e6%93%8d%e4%bd%9c" aria-label="ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ</a></li>
                <li>
                    <a href="#%e7%ac%ac2-9%e8%8a%82-%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e8%90%a5%e9%94%80%e9%94%81%e5%8d%95" aria-label="ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•</a></li>
                <li>
                    <a href="#%e7%ac%ac2-10%e8%8a%82-%e8%b4%a3%e4%bb%bb%e9%93%be%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-11%e8%8a%82-%e4%ba%a4%e6%98%93%e8%a7%84%e5%88%99%e8%b4%a3%e4%bb%bb%e9%93%be%e8%bf%87%e6%bb%a4" aria-label="ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-12%e8%8a%82%e6%8b%bc%e5%9b%a2%e7%bb%84%e9%98%9f%e7%bb%93%e7%ae%97%e7%bb%9f%e8%ae%a1" aria-label="ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">#</a></h1>
<p>**é¡¹ç›®èƒŒæ™¯ï¼š**ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚</p>
<h3 id="ç¬¬1-2èŠ‚-æ‹¼å›¢åº“è¡¨è®¾è®¡">ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1-2èŠ‚-æ‹¼å›¢åº“è¡¨è®¾è®¡">#</a></h3>
<p><em><strong>ä¸šåŠ¡æµç¨‹ï¼š</strong></em></p>
<p><img alt="image-20250323194301660" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250323194301660.png"></p>
<ul>
<li><em>è¿è¥è§’åº¦ï¼š</em> 1. ç»™å“ªäº›å•†å“é…ç½®æ‹¼å•ï¼›2. æ‹¼å›¢å•†å“æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼šæŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚</li>
<li><em>ç”¨æˆ·è§’åº¦ï¼š</em> 1. å‚ä¸æ‹¼å›¢ï¼Œé¦–æ¬¡å‘èµ·orå‚ä¸ç°æœ‰ï¼Œæ‹¼å•å®Œæˆå›è°ƒé€šçŸ¥ã€‚</li>
<li><em>åº“è¡¨è®¾è®¡ï¼š</em> 1. äººç¾¤è®¾è®¡ï¼Œå°†æ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥ç‰¹å®šRedisè®°å½•ä¸­ã€‚</li>
<li>æ‹¼å›¢æ´»åŠ¨ï¼ŒæŠ˜æ‰£çš„å¤šç§è¿­ä»£ã€‚</li>
</ul>
<p><strong>åº“è¡¨è®¾è®¡ï¼š</strong></p>
<p><em>æ‹¼å›¢é…ç½®è¡¨</em>ï¼š</p>
<p><img alt="image-20250323194814202" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250323194814202.png"></p>
<ul>
<li>æ‹¼å›¢æ´»åŠ¨è¡¨ï¼šè®¾å®šäº†æ‹¼å›¢çš„æˆå›¢è§„åˆ™ï¼Œäººç¾¤æ ‡ç­¾çš„ä½¿ç”¨å¯ä»¥é™å®šå“ªäº›äººå¯è§ï¼Œå“ªäº›äººå¯å‚ä¸ã€‚</li>
<li>æŠ˜æ‰£é…ç½®è¡¨ï¼šæ‹†åˆ†å‡ºæ‹¼å›¢ä¼˜æƒ åˆ°ä¸€ä¸ªæ–°çš„è¡¨è¿›è¡Œå¤šæ¡é…ç½®ã€‚å¦‚æœæŠ˜æ‰£è¿˜æœ‰æ›´å¤šçš„å¤æ‚è§„åˆ™ï¼Œåˆ™å¯ä»¥é…ç½®æ–°çš„æŠ˜æ‰£è§„åˆ™è¡¨è¿›è¡Œå¤„ç†ã€‚</li>
<li>äººç¾¤æ ‡ç­¾è¡¨ï¼šä¸“é—¨æ¥åšäººç¾¤è®¾è®¡è®°å½•çš„ï¼Œè¿™3å¼ è¡¨å°±æ˜¯ä¸ºäº†æŠŠç¬¦åˆè§„åˆ™çš„äººç¾¤IDï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·IDï¼Œå…¨éƒ¨è·‘ä»»åŠ¡åˆ°ä¸€ä¸ªè®°å½•ä¸‹è¿›è¡Œä½¿ç”¨ã€‚ æ¯”å¦‚é»‘ç«ç‘°äººç¾¤ã€é«˜å‡€å€¼äººç¾¤ã€æ‹¼å›¢å±¥çº¦ç‡90%ä»¥ä¸Šçš„äººç¾¤ç­‰ã€‚</li>
</ul>
<p><em><strong>å‚ä¸æ‹¼å›¢è¡¨ï¼š</strong></em></p>
<p><img alt="image-20250323195108167" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250323195108167.png"></p>
<ul>
<li>æ‹¼å›¢è´¦æˆ·è¡¨ï¼šè®°å½•ç”¨æˆ·çš„æ‹¼å›¢å‚ä¸æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†é™åˆ¶ç”¨æˆ·çš„å‚ä¸æ‹¼å›¢æ¬¡æ•°ï¼Œå¦å¤–æ˜¯ä¸ºäº†äººç¾¤æ ‡ç­¾ä»»åŠ¡ç»Ÿè®¡æ•°æ®ã€‚</li>
<li>ç”¨æˆ·æ‹¼å•è¡¨ï¼šå½“æœ‰ç”¨æˆ·å‘èµ·é¦–æ¬¡æ‹¼å•çš„æ—¶å€™ï¼Œäº§ç”Ÿæ‹¼å•idï¼Œå¹¶è®°å½•æ‰€éœ€æˆå›¢çš„æ‹¼å•è®°å½•ï¼Œå¦å¤–æ˜¯å†™ä¸Šæ‹¼å›¢çš„çŠ¶æ€ã€å”¯ä¸€ç´¢å¼•ã€å›è°ƒæ¥å£ç­‰ã€‚è¿™æ ·æ‹¼å›¢å®Œæˆå°±å¯ä»¥å›è°ƒå¯¹æ¥çš„å¹³å°ï¼Œé€šçŸ¥å®Œæˆäº†ã€‚ã€å¾®ä¿¡æ”¯ä»˜ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡ï¼Œå›è°ƒæ”¯ä»˜ç»“æœï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿å¹³å°åŒ–å¯¹æ¥ã€‘å½“å†æœ‰ç”¨æˆ·å‚ä¸åï¼Œåˆ™å†™å…¥ç”¨æˆ·æ‹¼å•æ˜ç»†è¡¨ã€‚ç›´è‡³è¾¾æˆæ‹¼å›¢</li>
<li>å›è°ƒä»»åŠ¡è¡¨ï¼šå½“æ‹¼å›¢å®Œæˆåï¼Œè¦åšå›è°ƒå¤„ç†ã€‚ä½†å¯èƒ½ä¼šæœ‰å¤±è´¥ï¼Œæ‰€ä»¥åŠ å…¥ä»»åŠ¡çš„æ–¹å¼è¿›è¡Œè¡¥å¿ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦å¯¹æ¥çš„å¹³å°ï¼Œè‡ªå·±æŸ¥è¯¢æ‹¼å›¢ç»“æœã€‚</li>
</ul>
<h3 id="ç¬¬1-3èŠ‚-ç ”å‘ç³»ç»Ÿè®¾è®¡">ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1-3èŠ‚-ç ”å‘ç³»ç»Ÿè®¾è®¡">#</a></h3>
<p>è¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼šåº“è¡¨è®¾è®¡ã€ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚</p>
<ul>
<li>ç”¨ä¾‹å›¾ï¼šç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼›</li>
<li>æµç¨‹å›¾ï¼šåŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼›</li>
<li>æ—¶åºå›¾ï¼šå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³»</li>
</ul>
<p><strong>ç³»ç»Ÿæ¶æ„ï¼š</strong></p>
<p><em>MVCæ¶æ„</em></p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323200411716.png" alt="image-20250323200411716" style="zoom:50%;" />
<p><em>DDDæ¶æ„</em></p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323200448795.png" alt="image-20250323200448795" style="zoom:50%;" />
<h3 id="ç¬¬2-2èŠ‚-è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-2èŠ‚-è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">#</a></h3>
<p><em><strong>å¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§</strong></em></p>
<p>=&gt; è®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚</p>
<p><strong>æ¨¡å‹è®¾è®¡</strong></p>
<p>é“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜</p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323212011895.png" alt="image-20250323212011895" style="zoom:50%;" />
<ul>
<li>é¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨è§„åˆ™æ ‘æ¨¡å‹ç»“æ„
<ul>
<li>æ¶µç›–ï¼šStrategyMapper, StrategyHandler /ËˆstrÃ¦tÉ™dÊ’i/ã€AbstractStrategyRouter&lt;T, D, R&gt;ã€‚ é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚</li>
<li>ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¼–ç å®ç°</strong></p>
<p>é¡¹ç›®å·¥ç¨‹çš„Typesæ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿</p>
<p><em>1.1 ç­–ç•¥æ˜ å°„å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm">     * è·å–å¾…æ‰§è¡Œç­–ç•¥
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     * @param requestParameter å…¥å‚
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     * @param dynamicContext   ä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">     * @return è¿”å‚
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     * @throws Exception å¼‚å¸¸
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>ç”¨äºè·å–æ¯ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œè´£ä»»é“¾åŠ å¼ºç‰ˆ</li>
<li>Tï¼ŒDï¼ŒRï¼šå…¥å‚ï¼Œä¸Šä¸‹æ–‡ï¼Œåå‚</li>
</ul>
<p><em>1.2 ç­–ç•¥å—ç†å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œåˆ©ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ç»™åé¢æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚</li>
</ul>
<p><em>1.3 ç­–ç•¥è·¯ç”±å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Setter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// ä¼ªä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">strategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>æ‰§è¡Œå…·ä½“èŠ‚ç‚¹ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¼ é€’åˆ°é»˜è®¤èŠ‚ç‚¹ä¸­</li>
</ul>
<h3 id="ç¬¬2-3èŠ‚-å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-3èŠ‚-å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">#</a></h3>
<p><strong>é¦–é¡µè¯•ç®—</strong></p>
<p>å½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚</p>
<p><strong>1. Modelå®šä¹‰å¯¹è±¡ï¼› 2. æœåŠ¡åŠŸèƒ½å®ç°ï¼Œtrialè¯•ç®—æ¨¡å—ï¼›3. ä¸šåŠ¡æµè½¬çš„åŠŸèƒ½èŠ‚ç‚¹</strong></p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250323214143312.png" alt="image-20250323214143312" style="zoom:50%;" />
<p><strong>æ¨¡å‹é“¾è·¯</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">IIndexGroupBuyMarketService</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RootNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">|</span><span class="n">æ£€æŸ¥ä¿¡æ¯</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MarketNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="err">â­</span><span class="n">å‰ç½®å¤„ç†</span><span class="err">â­</span><span class="n">æ‹¼å•è¯•ç®—</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">|</span><span class="n">æ„å»ºç»“æœ</span><span class="o">]</span><span class="w">     
</span></span></span></code></pre></div><p><strong>è·¯ç”±ç­–ç•¥æ¨¡æ¿[èŠ‚ç‚¹æ¨¡æ¿]</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">multiThread</span><span class="p">()</span><span class="w"> </span><span class="c1">// å‰ç½®å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doApply</span><span class="p">()</span><span class="w"> </span><span class="c1">// ä¸šåŠ¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">IActivityRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// ç©ºæ–¹æ³•ï¼Œéœ€è¦å®ç°çš„è¯ï¼Œè®©å­ç±»é‡å†™</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å…·ä½“èŠ‚ç‚¹å®ä¾‹</strong></p>
<p>å·¥ä½œæµï¼šå‰ç½®å¤„ç† =&gt; ä¸šåŠ¡é€»è¾‘ =&gt; è·¯ç”±</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RootNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">MarketProductEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> </span><span class="n">nextNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ä¸šåŠ¡å¤„ç†&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w"> </span><span class="c1">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">switchNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â­â­â­</p>
<p><em><strong>å¼‚æ­¥æ•°æ®åŠ è½½</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ -</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// å†™å…¥ä¸Šä¸‹æ–‡ï¼Œ å‰ç½®æŸ¥è¯¢æ•°æ® </span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXA</span><span class="p">(</span><span class="n">xxxFutureTaskA</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w"> </span><span class="c1">// é˜»å¡æŒ‡å®šæ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXB</span><span class="p">(</span><span class="n">xxxFutureTaskB</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-4èŠ‚-ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">ç¬¬2-4èŠ‚ <strong>ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—</strong><a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-4èŠ‚-ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">#</a></h3>
<p>ä¸åŒä¼˜æƒ æ¨¡å¼ =&gt; ç­–ç•¥æ¨¡å¼å®ç°</p>
<p><strong>å®šä¹‰æ¥å£</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æŠ½è±¡æ¨¡æ¿</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractDiscountCalculateService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsFilter</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isCrowdRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterTagId</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getTagId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isCrowdRange</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doCalculate</span><span class="p">(</span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ </span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">filterTagId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ†</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// å…·ä½“è®¡ç®—å‡½æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æŠ˜æ‰£æ–¹æ³•</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;MJ&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// æ»¡å‡ä¼˜æƒ </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MJCalculateService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(</span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">GroupBuyDiscount</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getDiscountType</span><span class="p">().</span><span class="na">getCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">marketExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketExpr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">marketExpr</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»·</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">originalPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// æŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’±</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&#34;0.01&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">deductionPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>è¥é”€è°ƒç”¨</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// MarketNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="n">groupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">getGroupBuyDiscount</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// å…·ä½“çš„ç­–ç•¥ï¼Œä¼˜æƒ æ¨¡å¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;...&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">keys</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    	</span><span class="k">throw</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="c1">// æŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">skuVO</span><span class="p">.</span><span class="na">getOriginalPrice</span><span class="p">(),</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setDeductionPrice</span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å­¦ä¹ ç‚¹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">XXX</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nd">@Resource</span><span class="w">   </span><span class="c1">// â­å…ˆæŒ‰åç§°ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹æ³¨å…¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-5èŠ‚-äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-5èŠ‚-äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">#</a></h3>
<p>ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœ</p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324161606013.png" alt="image-20250324161606013" style="zoom:50%;" />
<p>äººç¾¤æ ‡ç­¾æ˜¯æ ¹æ®ç”¨æˆ·ä¸šåŠ¡è¡Œä¸ºé‡‡é›†çš„</p>
<p><strong>æ•°æ®åº“è¡¨ï¼š</strong></p>
<p>crowd_tags ï¼šç»Ÿè®¡åŠŸèƒ½ï¼›</p>
<p>crowd_tags_detailï¼štag_id =&gt; user_id;  å…·ä½“æ¯ä¸ªäººç¾¤éƒ½æœ‰è°ï¼›</p>
<p>crowd_tags_jobï¼štag_id =&gt; batch_id, tag_relu:æ¶ˆè´¹è§„åˆ™;</p>
<p><img alt="image-20250324170251768" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250324170251768.png"></p>
<p>æµç¨‹ï¼š</p>
<ol>
<li>æ ¹æ®tag_id, batch_id æŸ¥è¯¢crowd_tags_jobå¾—åˆ°å¯¹åº”æ‰¹æ¬¡ä»»åŠ¡</li>
<li>é‡‡é›†ç”¨æˆ·æ•°æ®</li>
<li>æ•°æ®å†™å…¥è®°å½• // æš‚å­˜</li>
<li>æ•°æ®å†™å…¥æ•°æ®åº“  =&gt; crowd_tags_detail</li>
<li>æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡ =&gt; crowd_tags</li>
</ol>
<p><strong>æ•°æ®å†™å…¥æ•°æ®åº“</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addCrowdTagsUserId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">CrowdTagsDetail</span><span class="w"> </span><span class="n">crowdTagsDetailReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CrowdTagsDetail</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setTagId</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">crowdTagsDetailDao</span><span class="p">.</span><span class="na">addCrowdTagsUserId</span><span class="p">(</span><span class="n">crowdTagsDetailReq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w"> </span><span class="c1">// tagId:{userId, ...}:BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">bitSet</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// Longç±»å‹å•¥çš„è½¬æ¢ä¸€ä¸‹è·Ÿbitseté•¿åº¦ä¸€è‡´ï¼Œå°½å¯èƒ½å‡åŒ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DuplicateKeyException</span><span class="w"> </span><span class="n">ignore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â—â—â—redisä¸­ BitSet å°±æ˜¯bitç±»å‹çš„hashtableï¼Œ è€Œ bitmapæ˜¯å­—ç¬¦ä¸²ï¼›</p>
<p>å¤§è‡´æ€è·¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// æ•°æ®å†™å…¥æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æŠŠbitsetä¸­ä½ç½®ç½®1ï¼Œè¡¨ç¤ºè¿™ä¸ªç”¨æˆ·å­˜åœ¨äºè¿™ä¸ªé›†åˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·Idï¼ŒæŸ¥bitset                    // è¿™é‡Œç”¨æˆ·ID=&gt;bitset:key, ä½¿ç”¨ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œä½¿å¾—æ•£åˆ—å°½å¯èƒ½å‡åŒ€</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-6èŠ‚-åº“è¡¨æ‹†åˆ†">ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-6èŠ‚-åº“è¡¨æ‹†åˆ†">#</a></h3>
<p>å°†å•†å“SKUä¸æ´»åŠ¨è¡¨ è§£è€¦ =&gt; SKU&amp;Activityå…³è”è¡¨ã€‚ä½¿å¾—å¤šä¸ªå•†å“å¯ä»¥ç»‘å®šåŒä¸€ä¸ªæ´»åŠ¨ID(ä¼˜æƒ æ‹¼å›¢æ´»åŠ¨)</p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324185432351.png" alt="image-20250324185432351" style="zoom: 67%;" />
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">MarketèŠ‚ç‚¹</span><span class="w"> </span><span class="n">åˆ¤æ–­</span><span class="w"> </span><span class="n">å•†å“æ˜¯å¦å­˜åœ¨ä¼˜æƒ æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ErrorNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ä¸å­˜åœ¨ä¼˜æƒ æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">è¿”å›ä¼˜æƒ çš„è¯•ç®—ä»·æ ¼</span><span class="w">    
</span></span></span></code></pre></div><p>æµç¨‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// MarketNode =&gt; multi-thread æ£€æŸ¥æ˜¯å¦å­˜åœ¨å•†å“&lt;=&gt; æ´»åŠ¨å…³è”è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="n">SCSkuActivityVO</span><span class="w"> </span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">querySCSkuActivityBySCGoodsId</span><span class="p">(</span><span class="n">goodsId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="c1">// log.error(JSON.toJSONString(scSkuActivityVO));</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">queryGroupBuyActivityDiscountVOById</span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// marketNode è·¯ç”±</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">errorNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">tagNode</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ErrorNode åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼ŒæŠ›å‡ºæ— æ‹¼å›¢é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getGoodsId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-7èŠ‚-äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-7èŠ‚-äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">#</a></h3>
<p>é™åˆ¶æ‹¼å›¢çš„äººç¾¤</p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324214800601.png" alt="image-20250324214800601" style="zoom:67%;" />
<p>æµç¨‹1ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">MarketNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">TagNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// TagNode æ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ èƒ½çœ‹è§æ‹¼å›¢ï¼Œæ˜¯å¦å‚ä¸æ‹¼å›¢  tag_scope = {1,2} ç¬¬ä¸€ä½é™åˆ¶æ˜¯å¦å¯è§ï¼Œç¬¬äºŒä½æ˜¯å¦é™åˆ¶å‚ä¸</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// redis:bitset =&gt; tag_id:{...} å­˜æ”¾æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// è·å–æ‹¼å›¢ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">getTagId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">visible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isVisible</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isEnable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// æ— ç‰¹å®šäººç¾¤ä¿¡æ¯, äººäººèƒ½æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">tagId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œç‰¹å®šäººç¾¤èƒ½çœ‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">isWithin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">isTagCrowdRange</span><span class="p">(</span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="n">visible</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; isTagCrowdRange function</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// xiaofugeã€liergouåœ¨é‡Œé¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bitSet</span><span class="p">.</span><span class="na">isExists</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨äººç¾¤ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">bitSet</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span><span class="w">    
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-8èŠ‚--åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-8èŠ‚--åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">#</a></h3>
<p>ç›®çš„ï¼šå¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ</p>
<p>=&gt; åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚</p>
<p><strong>ä½¿ç”¨Redisä½œä¸ºé›†ä¸­åŒ–å‚¨å­˜ç³»ç»Ÿçš„å¥½å¤„ï¼Œæ–¹ä¾¿ä¸€å¤„ä¿®æ”¹å˜é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„å®ä¾‹è¿›è¡Œå˜æ›´ï¼</strong></p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250324220542463.png" alt="image-20250324220542463" style="zoom:50%;" />
<p><strong>æµé‡é™çº§æˆ–åˆ‡é‡</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// è‡ªå®šä¹‰æ³¨è§£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DCCValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// åŠ¨æ€ä¸­å¿ƒæ§åˆ¶ -- ä½œç”¨äºé™çº§</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cm">     * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;downgradeSwitch:0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">downgradeSwitch</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;cutRange:100&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cutRange</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCutRange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–æœ€åä¸¤ä½</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="c1">// åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†…</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cutRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">cutRange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDowngradeSwitch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="c1">// SwitchNodeä¸­ è¿›è¡Œæµé‡æ§åˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="c1">// æ ¹æ®ç”¨æˆ·IDåˆ‡é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦é™çº§</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦åˆ‡é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">cutRange</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>åˆ©ç”¨Redisçš„Topicäº‹ä»¶å‘å¸ƒè®¢é˜… è¿›è¡Œ ä¿®æ”¹</strong></p>
<p>BeanPostProcessor èƒ½å¤Ÿå½“SpringBeanåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// DCCValueBeanFactory implements BeanPostProcessor </span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;group_buy_market_dcc_&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">DCCValueBeanFactory</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">redissonClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;dccTopic&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">RTopic</span><span class="w"> </span><span class="nf">dccRedisTopicListener</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">RTopic</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getTopic</span><span class="p">(</span><span class="s">&#34;group_buy_market_dcc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="c1">// æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="n">topic</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">charSequence</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç›‘å¬åˆ°Redis Topicï¼š {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">charSequence</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">attribute</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="c1">// è®¾ç½®å€¼ =&gt; å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">objBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="c1">// è·å–å†…å­˜ä¸­çš„å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="c1">// æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">objBean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">objBean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBeanClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">objBean</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="c1">// æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">        </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopProxyUtils</span><span class="p">.</span><span class="na">getSingletonTarget</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">.</span><span class="na">isAnnotationPresent</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="n">DCCValue</span><span class="w"> </span><span class="n">dccValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccValue</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;dcc config error &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">            </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">                </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å€¼ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Controller</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;update_config&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateConfig</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">dccTopic</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â±ï¸25/3/24-23:34</p>
<h3 id="ç¬¬2-9èŠ‚-æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-9èŠ‚-æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">#</a></h3>
<p>25/3/25/ 20:37</p>
<p>å®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<img src="C:\Users\éŸ¦é¾™\AppData\Roaming\Typora\typora-user-images\image-20250325203753717.png" alt="image-20250325203753717" style="zoom: 80%;" />
<ul>
<li>é¦–å…ˆï¼Œå›¢è´­å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºï¼šåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€å·ï¼‰ï¼Œåˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚</li>
<li>ç”¨æˆ·ä»¥æ‹¼å›¢çš„æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚åˆ›å»ºè®¢å•ä½¿ç”¨æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ã€‚</li>
<li>æ‹¼å›¢è¡¨(ç›®æ ‡é‡ã€å®Œæˆé‡ã€é”å•é‡)ï¼Œé”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œä¸èƒ½å†å‚ä¸è¯¥æ‹¼å›¢ã€‚æ‹¼å›¢è¶…æ—¶ï¼Œé‡Šæ”¾ç©ºé—²ä½ç½®è®©å…¶ä»–ç”¨æˆ·å‚ä¸.</li>
</ul>
<p><em>Trade Repository  / rÉªËˆpÉ’zÉ™t(É™)ri /</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ç®€å•å®ç°æ­¥éª¤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// OutTradeNO æ¨¡æ‹Ÿç”Ÿæˆ è®¢å•IDæ¨¡æ‹Ÿç”Ÿæˆ, TeamIDæ¨¡æ‹Ÿç”Ÿæˆ. ä¸¤å¼ è¡¨:1.è®°å½•æ‹¼å›¢ä¸­æ¯ä¸ªç”¨æˆ·çš„ä¿¡æ¯ 2. è®°å½•è¯¥æ‹¼å›¢ä¿¡æ¯.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// â­ä»“å‚¨ä¸šåŠ¡å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦æœ‰å›¢  -- ä¸€è¡Œè®°å½•å­˜å‚¨æ¯ä¸ªæ‹¼å›¢çš„ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// é¦–æ¬¡åˆ™åˆ›å»ºæ‹¼å›¢è®¢å•. åˆå§‹åŒ–è¡¨2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// å¦åˆ™åŠ å…¥å…¶ä»–äººçš„å›¢ è¡¨2 æ‹¼å›¢äººæ•°+1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// æ’å…¥è¯¥ç”¨æˆ·çš„æ‹¼å›¢ä¿¡æ¯åˆ°è¡¨1; æ¯ä¸ªç”¨æˆ·ä¸€è¡Œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// â­æ§åˆ¶å™¨ä¸šåŠ¡å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 2. æŸ¥è¯¢ç”¨æˆ·outTradeNoæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡,å¹‚ç­‰æ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// 3. æŸ¥è¯¢æ‹¼å›¢æ˜¯å¦äººæ•°å·²æ»¡è¶³</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 4. è¥é”€ä¼˜æƒ è¯•ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 5. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿçœ‹è§æ‹¼å›¢å’Œå‚ä¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 6. æ‹¼å›¢é”å• =&gt; ä»“å‚¨ä¸šåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// 7. è¿”å›ç»“æœ</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-10èŠ‚-è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-10èŠ‚-è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">#</a></h3>
<p>25/4/8/ 15:53</p>
<p>å…ˆå‰çš„è´£ä»»é“¾æ¨¡æ¿éƒ½æ˜¯å†™æ­»çš„ã€‚æœ¬ç« å†…å®¹ä¸ºï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘å’Œé“¾æ¥é€»è¾‘è§£è€¦ã€‚</p>
<p>æŠ½è±¡</p>
<p><img alt="image-20250408155522466" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250408155522466.png"></p>
<p>ç®€å•çš„å•ä¾‹é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 1. IlogicChainArmory:   è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 		next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 2. ILogicLink extends IlogicChainArmory:  å¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">//		apply()</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 3. AbstractLogicLink extends ILogicLink:  å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">//      next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="c1">// 		apply()</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„<strong>ç±»</strong>ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ <code>ILogicLink&lt;T, D, R&gt; next </code>è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚</p>
<p>å¤šä¾‹-é“¾è·¯æ¨¡å¼</p>
<p>å¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// éœ€è¦è®¾è®¡çš„ç±»</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 1. Node &amp; LinkedList extends ILink</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// åŒå‘é“¾è¡¨èŠ‚ç‚¹ &amp; åŒå‘é“¾è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 2. BusinessLinkedList extends LinkedList</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// ä»å¤´åˆ°å°¾æ‰§è¡Œå„ä¸ªèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 3. ILogicHandler  -- å®šä¹‰ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 4. LinkArmory -- åˆ›å»ºé“¾è¡¨å¹¶è£…é…èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// public LinkArmory(String linkName, ILogicHandler&lt;T, D, R&gt;... logicHandlers)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// private final BusinessLinkedList&lt;T, D, R&gt; logicLink;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ç”¨æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. å®šä¹‰ RuleLogicNode extends ILogicHandler</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. new LinkArmory&lt;&gt;(&#34;demo01&#34;, ruleLogic201, ruleLogic202, ...);</span><span class="w">
</span></span></span></code></pre></div><p>å…·ä½“ä¼ªä»£ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILink</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="cm">     * è´£ä»»é“¾åç§°
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="cm">     * */</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkedList</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="c1">// å¤´æ’èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="c1">// å°¾æ’æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">        </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">            </span><span class="n">l</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="n">linkFirst</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="c1">// åˆ é™¤èŠ‚ç‚¹ï¼Œæ³¨æ„æ˜¯åŒå‘é“¾è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="nf">unlink</span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="c1">// xä¸ºå¤´èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="n">prev</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">        </span><span class="c1">// xä¸ºæœ«å°¾</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="n">next</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">        </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">element</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">	
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="c1">// æ ¹æ®indexï¼Œåˆ¤æ–­æ˜¯å‰å‘è¿˜æ˜¯åå‘</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">printLinkList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&#34;é“¾è¡¨ä¸ºç©º&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&#34;ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">first</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; å°¾èŠ‚ç‚¹ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ•´ä½“ï¼š&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;ï¼Œ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">                </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-11èŠ‚-äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-11èŠ‚-äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">#</a></h3>
<p>2025-4-8 17:30</p>
<p><img alt="image-20250408175143439" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250408175143439.png"></p>
<p>è¯¥ç« èŠ‚è¡¥å……ï¼šè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// Logic chain</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. æ£€æŸ¥å‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ ¹æ®å¤–éƒ¨OrderId</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 3. åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨æ˜¯å¦æ»¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 4. è¥é”€è¯•ç®— -- ç»™å‡ºæŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 5. äººç¾¤é™å®š -- ç‰¹å®šäººç¾¤æ‰èƒ½æ‹¼å›¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// 6. æ‹¼å›¢é”å• -- 1. ä¿®æ”¹æ´»åŠ¨è¡¨å¯¹åº”çš„ä¿¡æ¯ 2. æ’å…¥ä¸€æ¡æ‹¼å›¢è®°å½•</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">// 6.1. äº¤æ˜“è§„åˆ™è¿‡æ»¤  -- æ£€æŸ¥æ´»åŠ¨æ—¶é—´ + æ£€æŸ¥æ‹¼å›¢æ¬¡æ•°  â­æœ¬èŠ‚ä¸»è¦è¿™éƒ¨åˆ†</span><span class="w">
</span></span></span></code></pre></div><p>å…·ä½“å°±æ˜¯å®šä¹‰ä¸€äº› è´£ä»»é“¾èŠ‚ç‚¹(æ‹¦æˆªå™¨)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivityEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryGroupBuyActivityEntityByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActivityStatusEnumVO</span><span class="p">.</span><span class="na">EFFECTIVE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">before</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStartTime</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="na">after</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getEndTime</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0102</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setGroupBuyActivity</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryOrderCountByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ·å‚æ•°æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userTakeOrderCount</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç»„è£…è´£ä»»é“¾  &ndash; BusinessLinkedList å…·ä½“ä¸šåŠ¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;tradeRuleFilter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nf">tradeRuleFilter</span><span class="p">(</span><span class="n">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="c1">// ç»„è£…é“¾</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">LinkArmory</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkArmory</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="c1">// é“¾å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">getLogicLink</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>LinkArmory  &ndash; çœŸæ­£çš„æŠ½è±¡è£…é…è´£ä»»é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@SafeVarargs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkArmory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">linkName</span><span class="p">,</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">logicLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">linkName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicHandler</span><span class="p">:</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">logicLink</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">logicHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLogicLink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç”¨æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tradeRuleFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">tradeRuleFilter</span><span class="p">.</span><span class="na">aaply</span><span class="p">(...)</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-12èŠ‚æ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-12èŠ‚æ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">#</a></h3>
<p>25/4/8 21:19</p>
<p><img alt="image-20250408224034286" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250408224034286.png"></p>
<p>æ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚</p>
<p>é‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚</p>
<p>â­â­â­ æ‰€æœ‰ç”¨æˆ·å®Œæˆæ”¯ä»˜å, æœ€åä¸€ä¸ªç”¨æˆ·çš„ç»“ç®—è§¦å‘å›è°ƒäº‹ä»¶!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">settlementMarketPayOrder</span><span class="p">(</span><span class="n">GroupBuyTeamSettlementAggregate</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">UserEntity</span><span class="w"> </span><span class="n">userEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getUserEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getGroupBuyTeamEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">TradePaySuccessEntity</span><span class="w"> </span><span class="n">tradePaySuccessEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getTradePaySuccessEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyOrderList</span><span class="w"> </span><span class="n">groupBuyOrderList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GroupBuyOrderList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userEntity</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setOutTradeNo</span><span class="p">(</span><span class="n">tradePaySuccessEntity</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyOrderList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateAddCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateAddCompleteCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateAddCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="c1">// 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTargetCount</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getCompleteCount</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å¤–éƒ¨è®¢å•å·åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">queryGroupBuyCompleteOrderOutTradeNoListByTeamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½•</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">NotifyTask</span><span class="w"> </span><span class="n">notifyTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotifyTask</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">teamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyUrl</span><span class="p">(</span><span class="s">&#34;æš‚æ— &#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyCount</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyStatus</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">notifyTask</span><span class="p">.</span><span class="na">setParameterJson</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;teamId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;outTradeNoList&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="p">}}));</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="n">notifyTaskDao</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œç®—æ˜¯æ”¯ä»˜æˆåŠŸåçš„å›è°ƒ</p>
<hr>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://longcoding.top/tags/projects/">Projects</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://longcoding.top/posts/learning/common_commands/">
    <span class="title">Next Â»</span>
    <br>
    <span>Linux&amp;Docker&amp;Shellå‘½ä»¤</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://longcoding.top/">LongCoding&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
