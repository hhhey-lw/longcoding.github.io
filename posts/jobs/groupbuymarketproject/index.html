<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>拼团营销交易拼团 | LongCoding&#39;s Blog</title>
<meta name="keywords" content="Projects">
<meta name="description" content="Grouptradingproject">
<meta name="author" content="👨🏻‍🎓 LongWei">
<link rel="canonical" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://longcoding.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://longcoding.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://longcoding.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://longcoding.top/apple-touch-icon.png">
<link rel="mask-icon" href="http://longcoding.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://longcoding.top/posts/jobs/groupbuymarketproject/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="拼团营销交易拼团">
  <meta property="og:description" content="Grouptradingproject">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:modified_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:tag" content="Projects">
      <meta property="og:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:title" content="拼团营销交易拼团">
<meta name="twitter:description" content="Grouptradingproject">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://longcoding.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "拼团营销交易拼团",
      "item": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "拼团营销交易拼团",
  "name": "拼团营销交易拼团",
  "description": "Grouptradingproject",
  "keywords": [
    "Projects"
  ],
  "articleBody": "拼团交易平台系统 **项目背景：**为了盘活沉睡用户，需要适当降低商品价格。但为了达到传播的效果，所以需要引入拼团方式，以客带客，靠用户自身传播的方式进行交易拉新。这样的处理方式对比于 KOL，会让利商品价值到用户自身。\n第1-2节 拼团库表设计 业务流程：\n运营角度： 1. 给哪些商品配置拼单；2. 拼团商品提供的规则信息：折扣、时间、人数等。 用户角度： 1. 参与拼团，首次发起or参与现有，拼单完成回调通知。 库表设计： 1. 人群设计，将所有符合某个条件的用户ID，全部写入特定Redis记录中。 拼团活动，折扣的多种迭代。 库表设计：\n拼团配置表：\n拼团活动表：设定了拼团的成团规则，人群标签的使用可以限定哪些人可见，哪些人可参与。 折扣配置表：拆分出拼团优惠到一个新的表进行多条配置。如果折扣还有更多的复杂规则，则可以配置新的折扣规则表进行处理。 人群标签表：专门来做人群设计记录的，这3张表就是为了把符合规则的人群ID，也就是用户ID，全部跑任务到一个记录下进行使用。 比如黑玫瑰人群、高净值人群、拼团履约率90%以上的人群等。 参与拼团表：\n拼团账户表：记录用户的拼团参与数据，一个是为了限制用户的参与拼团次数，另外是为了人群标签任务统计数据。 用户拼单表：当有用户发起首次拼单的时候，产生拼单id，并记录所需成团的拼单记录，另外是写上拼团的状态、唯一索引、回调接口等。这样拼团完成就可以回调对接的平台，通知完成了。【微信支付也是这样的设计，回调支付结果，这样的设计可以方便平台化对接】当再有用户参与后，则写入用户拼单明细表。直至达成拼团 回调任务表：当拼团完成后，要做回调处理。但可能会有失败，所以加入任务的方式进行补偿。如果仍然失败，则需要对接的平台，自己查询拼团结果。 第1-3节 研发系统设计 进行研发系统设计。包括：库表设计、用例图、系统建模、工程模型、功能流程、UML时序图。\n用例图：用户与系统交互最简表示形式； 流程图：功能节点的串联关系； 时序图：展示了整个拼团过程所涉及的系统模块和流转关系 系统架构：\nMVC架构\nDDD架构\n第2-2节 试算模型抽象模板设计 引入设计模式进行解耦和实现，提高工程代码的扩展性\n=\u003e 设计模式抽象模板的通用结构定义，添加一个 tree规则树抽象模型，在引入到工程中进行使用。这样后续工程中就可以不断的定义通用的设计模式被不同的场景统一使用了。\n模型设计\n链式的多分支规则树模型结构，由功能节点自行决定后续流程的执行链路。它的设计比责任链的扩展性更好，自由度也更高\n首先，定义抽象的通用规则树模型结构 涵盖：StrategyMapper, StrategyHandler /ˈstrætədʒi/、AbstractStrategyRouter。 通过泛型设计允许使用方可以自定义出入参和动态上下文，让抽象模板模型具有通用性。 之后，由使用方自定义出工厂、功能抽象类和一个个流程流转的节点。 编码实现\n项目工程的Types模块中，添加通用设计模式模板\n1.1 策略映射器\n1public interface StrategyMapper\u003cT, D, R\u003e { 2 3 /** 4 * 获取待执行策略 5 * 6 * @param requestParameter 入参 7 * @param dynamicContext 上下文 8 * @return 返参 9 * @throws Exception 异常 10 */ 11 StrategyHandler\u003cT, D, R\u003e get(T requestParameter, D dynamicContext) throws Exception; 12 13} 用于获取每个执行的节点，责任链加强版 T，D，R：入参，上下文，反参 1.2 策略受理器\n1public interface StrategyHandler\u003cT, D, R\u003e { 2 3 StrategyHandler DEFAULT = (T, D) -\u003e null; 4 5 R apply(T requestParameter, D dynamicContext) throws Exception; 6 7} 执行具体的业务流程，利用上下文传递信息给后面执行的节点。 1.3 策略路由器\n1public abstract class AbstractStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 @Getter 4 @Setter 5 protected StrategyHandler\u003cT, D, R\u003e defaultStrategyHandler = StrategyHandler.DEFAULT; 6\t7 // 伪代码 8 public R router(T, D) throws Exception { 9 StrategyHandler strategyHandler = get(T, D); 10 if(null != strategyHandler) return strategyHandler.apply(T, D); 11 return defaultStrategyHandler.apply(T, D); 12 } 13 14} 执行具体节点，转发给下一个节点或者传递到默认节点中 第2-3节 多线程异步数据加载 首页试算\n当一个用户进入到购物首页查看商品的优惠信息，我们可以把这个过程定义为试算过程。试算；试试算一下，这个用户进入到首页看这个商品的时候，商品的营销优惠信息。包括：原始价格、折扣价格、拼团目标、拼团时效、是否可见优惠、是否可参与拼团等，这些东西都是试算拿到的结果。\n1. Model定义对象； 2. 服务功能实现，trial试算模块；3. 业务流转的功能节点\n模型链路\n1IIndexGroupBuyMarketService 2=\u003e RootNode 3\t=\u003e multiThread[前置处理|检查信息] =\u003e doApply[业务+路由] 4=\u003e SwitchNode 5\t=\u003e multiThread[前置处理] =\u003e doApply[业务+路由] 6=\u003e MarketNode 7\t=\u003e multiThread[⭐前置处理⭐拼单试算] =\u003e doApply[业务+路由] 8=\u003e EndNode 9\t=\u003e multiThread[前置处理] =\u003e doApply[业务|构建结果] 路由策略模板[节点模板]\n1public abstract class AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 public R router(T requestParameter, D dynamicContext) throws Exception {} 4 @Override 5 public R apply(T requestParameter, D dynamicContext) throws Exception { 6 multiThread() // 前置处理 7 return doApply() // 业务逻辑 8 } 9 protected abstract void multiThread(T requestParameter, D dynamicContext) throws; 10 protected abstract R doApply(T requestParameter, D dynamicContext) throws; 1public abstract class AbstractGroupBuyMarketSupport\u003cT, D, R\u003e extends AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e { 2 3 protected long timeout = 500; 4 @Resource 5 protected IActivityRepository repository; 6 7 @Override 8 protected void multiThread(T, D) { 9 // 空方法，需要实现的话，让子类重写 10 } 11 12} 具体节点实例\n工作流：前置处理 =\u003e 业务逻辑 =\u003e 路由\n1public class RootNode extends AbstractGroupBuyMarketSupport\u003cMarketProductEntity, DynamicContext, TrialBalanceEntity\u003e { 2 3 @Resource 4 private SwitchNode nextNode; 5 6 @Override 7 protected TrialBalanceEntity doApply(T, D, R) throws Exception { 8 log.info(\"业务处理\") 9 return router(requestParameter, dynamicContext); // 下一个节点 10 } 11 12 @Override 13 public StrategyHandler\u003cT, D, R\u003e get(T, D, R) { 14 return switchNode; 15 } 16} ⭐⭐⭐\n异步数据加载\n1// 异步查询活动配置 2XXXThreadTask taskA = new XXXThreadTask(...); 3FutureTask\u003cXXX\u003e xxxFutureTaskA = new FutureTask\u003c\u003e(XXXThreadTask); 4threadPoolExecutor.execute(xxxFutureTask); 5 6// 异步查询商品信息 - 7XXXThreadTask taskB = new XXXThreadTask(...); 8FutureTask\u003cXXX\u003e xxxFutureTaskB = new FutureTask\u003c\u003e(XXXThreadTask); 9threadPoolExecutor.execute(xxxFutureTask); 10 11// 写入上下文， 前置查询数据 12dynamicContext.setXXXA(xxxFutureTaskA.get(TIMEOUT, TimeUnit.MINUTES)); // 阻塞指定时间 13dynamicContext.setXXXB(xxxFutureTaskB.get(TIMEOUT, TimeUnit.MINUTES)); 第2-4节 策略模式优惠折扣计算 不同优惠模式 =\u003e 策略模式实现\n定义接口\n1public interface IDiscountCalculateService { 2 BigDecimal calculate(...); 3} 抽象模板\n1public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService { 2 3 @Override 4 public BigDecimal calculate(...) { 5 // 1. 人群标签过滤 6 if (IsFilter){ 7 boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId()); 8 if (!isCrowdRange) return originalPrice; 9 } 10 // 2. 折扣优惠计算 11 return doCalculate(originalPrice, groupBuyDiscount); 12 } 13 14 // 人群过滤 - 限定人群优惠 15 private boolean filterTagId(String userId, String tagId) { 16 // todo xiaofuge 后续开发这部分 17 return true; 18 } 19\t20 // 具体计算函数 21 protected abstract BigDecimal doCalculate(...); 22 23} 折扣方法\n1@Slf4j 2@Service(\"MJ\") // 满减优惠 3public class MJCalculateService extends AbstractDiscountCalculateService { 4 5 @Override 6 public BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) { 7 log.info(\"优惠策略折扣计算:{}\", groupBuyDiscount.getDiscountType().getCode()); 8 9 // 折扣表达式 - 100,10 满100减10元 10 String marketExpr = groupBuyDiscount.getMarketExpr(); 11 String[] split = marketExpr.split(Constants.SPLIT); 12 BigDecimal x = new BigDecimal(split[0].trim()); 13 BigDecimal y = new BigDecimal(split[1].trim()); 14 15 // 不满足最低满减约束，则按照原价 16 if (originalPrice.compareTo(x) \u003c 0) { 17 return originalPrice; 18 } 19 20 // 折扣价格 21 BigDecimal deductionPrice = originalPrice.subtract(y); 22 23 // 判断折扣后金额，最低支付1分钱 24 if (deductionPrice.compareTo(BigDecimal.ZERO) \u003c= 0) { 25 return new BigDecimal(\"0.01\"); 26 } 27 28 return deductionPrice; 29 } 30 31} 营销调用\n1// MarketNode 2 3public TrialBalanceEntity doApply(T, D) throws Exception { 4 log.info(\"拼团商品查询试算服务\"); 5 6 dynamicContext.getGroupBuyActivityDiscountVO(); 7 groupBuyActivityDiscountVO.getGroupBuyDiscount(); 8 9 dynamicContext.getSkuVO(); 10 11 // 具体的策略，优惠模式 12 IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan()); 13 if (null == discountCalculateService) { 14 log.info(\"...\", JSON.toString(discountCalculateServiceMap.keys())) 15 throw ... 16 } 17 18 // 折扣价格 19 BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount); 20 dynamicContext.setDeductionPrice(deductionPrice); 21 22 return router(requestParameter, dynamicContext); 23} 学习点：\n1@Service(\"Key\") 2XXX implement IDiscountCalculateService {} 3 4@Resource // ⭐先按名称，找不到再按类型注入 5private Map\u003cString, IDiscountCalculateService\u003e discountCalculateServiceMap; 第2-5节 人群标签数据采集 精准的对这些用户做定向活动投放，比如；特定的券、特定的通知等。以此达到更加精准的运营效果\n人群标签是根据用户业务行为采集的\n数据库表：\ncrowd_tags ：统计功能；\ncrowd_tags_detail：tag_id =\u003e user_id; 具体每个人群都有谁；\ncrowd_tags_job：tag_id =\u003e batch_id, tag_relu:消费规则;\n流程：\n根据tag_id, batch_id 查询crowd_tags_job得到对应批次任务 采集用户数据 数据写入记录 // 暂存 数据写入数据库 =\u003e crowd_tags_detail 更新人群标签统计 =\u003e crowd_tags 数据写入数据库\n1@Override 2public void addCrowdTagsUserId(String tagId, String userId) { 3 CrowdTagsDetail crowdTagsDetailReq = new CrowdTagsDetail(); 4 crowdTagsDetailReq.setTagId(tagId); 5 crowdTagsDetailReq.setUserId(userId); 6 try { 7 crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq); 8 // 获取BitSet 9 RBitSet bitSet = redisService.getBitSet(tagId); // tagId:{userId, ...}:BitSet 10 bitSet.set(redisService.getIndexFromUserId(userId), true); // Long类型啥的转换一下跟bitset长度一致，尽可能均匀 11 } catch (DuplicateKeyException ignore) { 12 // 忽略唯一索引冲突 13 } 14} ❗❗❗redis中 BitSet 就是bit类型的hashtable， 而 bitmap是字符串；\n大致思路：\n1// 数据写入数据库时，同时把bitset中位置置1，表示这个用户存在于这个集合 2// 查询时，根据用户Id，查bitset // 这里用户ID=\u003ebitset:key, 使用一个转换函数，使得散列尽可能均匀 第2-6节 库表拆分 将商品SKU与活动表 解耦 =\u003e SKU\u0026Activity关联表。使得多个商品可以绑定同一个活动ID(优惠拼团活动)\n1# Market节点 判断 商品是否存在优惠活动 2=\u003e ErrorNode =\u003e 不存在优惠活动 3=\u003e EndNode =\u003e 返回优惠的试算价格 流程：\n1// MarketNode =\u003e multi-thread 检查是否存在商品\u003c=\u003e 活动关联表 2@Override 3public GroupBuyActivityDiscountVO call() throws Exception { 4 SCSkuActivityVO scSkuActivityVO = activityRepository.querySCSkuActivityBySCGoodsId(goodsId); 5 // log.error(JSON.toJSONString(scSkuActivityVO)); 6 if (scSkuActivityVO == null) return null; 7 return activityRepository.queryGroupBuyActivityDiscountVOById(scSkuActivityVO.getActivityId()); 8} 1// marketNode 路由 2if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 3 return errorNode; 4} 5return tagNode; 1// ErrorNode 判断上下文，抛出无拼团配置 2log.info(\"拼团商品查询试算服务-NoMarketNode userId:{} requestParameter:{}\", requestParameter.getUserId(), JSON.toJSONString(requestParameter)); 3 4if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 5 log.info(\"商品无拼团营销配置 {}\", requestParameter.getGoodsId()); 6 throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo()); 7} 8 9return TrialBalanceEntity.builder().build(); 第2-7节 人群标签节点过滤 限制拼团的人群\n流程1：\n1MarketNode =\u003e TagNode =\u003e EndNode 1// TagNode 检查请求的用户是否 能看见拼团，是否参与拼团 tag_scope = {1,2} 第一位限制是否可见，第二位是否限制参与 2// redis:bitset =\u003e tag_id:{...} 存放满足条件的用户 3 4// 获取拼团信息 5GroupBuyActivityDiscountVO activityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO(); 6String tagId = activityDiscountVO.getTagId(); 7boolean visible = activityDiscountVO.isVisible(); 8boolean enable = activityDiscountVO.isEnable(); 9 10// 无特定人群信息, 人人能操作 11if (StringUtils.isBlank(tagId)) { 12 dynamicContext.setVisible(true); 13 dynamicContext.setEnable(true); 14 return router(requestParameter, dynamicContext); 15} 16 17// 是否在人群范围内，特定人群能看 18boolean isWithin = repository.isTagCrowdRange(tagId, requestParameter.getUserId()); 19dynamicContext.setVisible(visible || isWithin); 20dynamicContext.setEnable(enable || isWithin); 21 22return router(requestParameter, dynamicContext); 23 24 25// =\u003e isTagCrowdRange function 26// xiaofuge、liergou在里面 27RBitSet bitSet = redisService.getBitSet(tagId); 28if (!bitSet.isExists()) return true; 29// 判断用户是否存在人群中 30return bitSet.get(redisService.getIndexFromUserId(userId)); 第2-8节 动态配置开关操作 目的：如何不停车就给汽车换个轮子？\n=\u003e 在程序运行过程中，直接动态变更某些属性配置。这些动态变更的配置包括降级和切量的开关，也包括一些功能程序的白名单用户测试。\n使用Redis作为集中化储存系统的好处，方便一处修改变量，通知所有的实例进行变更！\n流量降级或切量\n1// 自定义注解 2@Retention(RetentionPolicy.RUNTIME) 3@Target(ElementType.FIELD) 4@Documented 5public @interface DCCValue { 6 String value() default \"\"; 7} 8 9// 动态中心控制 -- 作用于降级 10@Service 11public class DCCService { 12 13 /** 14 * 降级开关 0关闭 1开启 15 */ 16 @DCCValue(\"downgradeSwitch:0\") 17 private String downgradeSwitch; 18 19 @DCCValue(\"cutRange:100\") 20 private String cutRange; 21 22 public boolean isCutRange(String userId) { 23 // 计算哈希码的绝对值 24 int hashCode = Math.abs(userId.hashCode()); 25 26 // 获取最后两位 27 int lastTwoDigits = hashCode % 100; 28 29 // 判断是否在切量范围内 30 if (lastTwoDigits \u003c= Integer.parseInt(cutRange)) { 31 log.error(cutRange); 32 return true; 33 } 34 35 return false; 36 } 37 38 public boolean isDowngradeSwitch() { 39 return this.downgradeSwitch.equals(\"1\"); 40 } 41} 42 43// SwitchNode中 进行流量控制 44// 根据用户ID切量 45String userId = requestParameter.getUserId(); 46 47// 判断是否降级 48if (activityRepository.downgradeSwitch()) { 49 log.info(\"拼团活动降级拦截 {}\", userId); 50 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 51} 52 53// 判断是否切量 54if (activityRepository.cutRange(userId)) { 55 log.info(\"拼团活动切量拦截 {}\", userId); 56 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 57} 利用Redis的Topic事件发布订阅 进行 修改\nBeanPostProcessor 能够当SpringBean初始化完成后再执行\n1// DCCValueBeanFactory implements BeanPostProcessor 2private static final String BASE_CONFIG_PATH = \"group_buy_market_dcc_\"; 3 4private final RedissonClient redissonClient; 5 6private final Map\u003cString, Object\u003e dccObjGroup = new HashMap\u003c\u003e(); 7 8public DCCValueBeanFactory(RedissonClient redissonClient) { 9 this.redissonClient = redissonClient; 10} 11 12@Bean(\"dccTopic\") 13public RTopic dccRedisTopicListener(RedissonClient redissonClient) { 14 log.info(\"初始化Redis Topic监听事件 测试连通{}\", redissonClient.getBucket(\"test\").get()); 15 // 发布订阅模式的Topic实现 16 RTopic topic = redissonClient.getTopic(\"group_buy_market_dcc\"); 17 // 消息类型，回调接口：Topic名称，接收的消息 18 topic.addListener(String.class, ((charSequence, s) -\u003e { 19 log.info(\"监听到Redis Topic： {}\", charSequence.toString()); 20 String[] split = s.split(Constants.SPLIT); 21 22 // 获取值 23 String attribute = split[0]; 24 String key = BASE_CONFIG_PATH + attribute; 25 String value = split[1]; 26 27 // 设置值 =\u003e 可以存储任意类型的值（如 String、Integer、自定义对象等），Redisson 会自动进行序列化和反序列化。 28 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 29 boolean exists = bucket.isExists(); 30 if (!exists) return; 31 bucket.set(value); 32 33 Object objBean = dccObjGroup.get(key); // 获取内存中的对象 34 if (objBean == null) return; 35 36 Class\u003c?\u003e objBeanClass = objBean.getClass(); 37 // 检查objBean是否为代理对象 38 if (AopUtils.isAopProxy(objBean)) { 39 objBeanClass = AopUtils.getTargetClass(objBean); 40 } 41 42 try { 43 Field field = objBeanClass.getDeclaredField(attribute); 44 field.setAccessible(true); 45 field.set(objBean, value); 46 field.setAccessible(false); 47 48 log.info(\"DCC 节点监听，动态设置值 {} {}\", key,value); 49 } catch (Exception e) { 50 throw new RuntimeException(e); 51 } 52 53 })); 54 return topic; 55} 56 57 58// implements BeanPostProcessor 重写方法 -- 并在每个 bean 初始化完成后自动调用该方法。 59@Override 60public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { 61 // 注意：增加 AOP 代理后，获得类的方式要通过 AopProxyUtils.getTargetClass(bean); 不能直接 bean.class 因为代理后类的结构发生了变化，这样不能获得自己的自定义注解了 62 Class\u003c?\u003e targetBeanClass = bean.getClass(); 63 Object targetBeanObject = bean; 64 if (AopUtils.isAopProxy(targetBeanObject)) { 65 targetBeanClass = AopUtils.getTargetClass(targetBeanObject); 66 targetBeanObject = AopProxyUtils.getSingletonTarget(bean); 67 } 68\t69 // 这里判断该类是否有对应的自定义注解 70 Field[] fields = targetBeanClass.getDeclaredFields(); 71 for (Field field : fields) { 72 if (!field.isAnnotationPresent(DCCValue.class)) { 73 continue; 74 } 75 76 DCCValue dccValue = field.getAnnotation(DCCValue.class); 77 String value = dccValue.value(); 78 if (StringUtils.isBlank(value)) { 79 throw new RuntimeException(field.getName() + \"@DCCValue is not config value config case「isSwitch/isSwitch:1」\"); 80 } 81 82 String[] split = value.split(\":\"); 83 String key = BASE_CONFIG_PATH.concat(split[0]); 84 String defaultValue = split[1]; 85 86 String setValue = defaultValue; 87 88 try { 89 if (StringUtils.isBlank(defaultValue)) { 90 throw new RuntimeException(\"dcc config error \" + key + \" is not null - 请配置默认值！\"); 91 } 92 93 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 94 boolean exists = bucket.isExists(); 95 if (!exists) { 96 bucket.set(defaultValue); 97 } else { 98 setValue = bucket.get(); 99 } 100 101 field.setAccessible(true); 102 field.set(targetBeanObject, setValue); 103 field.setAccessible(false); 104 log.info(\"初始化值 key:{} value:{}\", key, setValue); 105 } catch (IllegalAccessException e) { 106 throw new RuntimeException(e); 107 } 108 109 dccObjGroup.put(key, targetBeanObject); 110 } 111 return bean; 112} Controller\n1@Override 2@GetMapping(\"update_config\") 3public Response\u003cBoolean\u003e updateConfig(@RequestParam String key, @RequestParam String value) { 4 try { 5 log.info(\"DCC 动态配置值变更 key:{} value:{}\", key, value); 6 dccTopic.publish(key + \",\" + value); 7 return Response.\u003cBoolean\u003ebuilder() 8 .code(ResponseCode.SUCCESS.getCode()) 9 .info(ResponseCode.SUCCESS.getInfo()) 10 .build(); 11 } catch (Exception e) { 12 log.error(\"DCC 动态配置值变更失败！ key:{} value:{} {}\", key, value, e.getMessage()); 13 return Response.\u003cBoolean\u003ebuilder() 14 .code(ResponseCode.UN_ERROR.getCode()) 15 .info(ResponseCode.UN_ERROR.getInfo()) 16 .build(); 17 } 18} ⏱️25/3/24-23:34\n第2-9节 拼团交易营销锁单 25/3/25/ 20:37\n完整的业务流程如下：\n首先，团购商品下单。下单过程分为：创建流水单、锁定营销优惠（拼团、积分、卷），创建支付订单、唤起收银台支付、用户扫码支付、支付完成核销优惠等。 用户以拼团的方式下单，创建流水单完成后，需要与拼团系统交互，锁定营销优惠。更新流水单优惠金额和支付金额。创建订单使用最终的支付金额。 拼团表(目标量、完成量、锁单量)，锁单量达到目标量后，不能再参与该拼团。拼团超时，释放空闲位置让其他用户参与. Trade Repository / rɪˈpɒzət(ə)ri /\n1// 简单实现步骤 2// OutTradeNO 模拟生成 订单ID模拟生成, TeamID模拟生成. 两张表:1.记录拼团中每个用户的信息 2. 记录该拼团信息. 3 4// ⭐仓储业务实现 5// 判断是否有团 -- 一行记录存储每个拼团的信息 6// 首次则创建拼团订单. 初始化表2 7// 否则加入其他人的团 表2 拼团人数+1 8 9// 插入该用户的拼团信息到表1; 每个用户一行 10 11// ⭐控制器业务实现 12// 1. 检查用户信息 13// 2. 查询用户outTradeNo是否已经使用过,幂等性 14// 3. 查询拼团是否人数已满足 15// 4. 营销优惠试算 16// 5. 判断用户是否能够看见拼团和参与 17// 6. 拼团锁单 =\u003e 仓储业务 18// 7. 返回结果 第2-10节 责任链抽象模板设计 25/4/8/ 15:53\n先前的责任链模板都是写死的。本章内容为：将每个节点的执行逻辑和链接逻辑解耦。\n抽象\n简单的单例链\n1// 1. IlogicChainArmory: 装配链，提供添加节点方法和获取节点 2// next() 3//\tappendNext() 4// 2. ILogicLink extends IlogicChainArmory: 并提供一个受理业务逻辑的方法 5//\tapply() 6// 3. AbstractLogicLink extends ILogicLink: 封装添加节点和执行 next 下一个节点的方法 7// next() 8//\tappendNext() 9// apply() 这里是由统一的类维护责任链，也就是一份责任链。如果有2个独立的链要处理，就需要使用到非单例的类进行填充，否则会修改同一份链。也就是 ILogicLink next 被几份链反复调整，也就不是一个单独的链了。\n多例-链路模式\n多例链的设计要解耦链路和执行，把链路当做一个 LinkedList 列表处理，之后执行当做是单独的 for 循环。\n1// 需要设计的类 2// 1. Node \u0026 LinkedList extends ILink 3// 双向链表节点 \u0026 双向链表 4 5// 2. BusinessLinkedList extends LinkedList 6// 从头到尾执行各个节点 7 8// 3. ILogicHandler -- 定义任务 9 10// 4. LinkArmory -- 创建链表并装配节点 11// public LinkArmory(String linkName, ILogicHandler... logicHandlers) 12// private final BusinessLinkedList logicLink; 1// 用法 2// 1. 定义 RuleLogicNode extends ILogicHandler 3// 2. new LinkArmory\u003c\u003e(\"demo01\", ruleLogic201, ruleLogic202, ...); 具体伪代码\n1public class LinkedList\u003cE\u003e implements ILink\u003cE\u003e { 2 3 /** 4 * 责任链名称 5 * */ 6 @Getter 7 private final String name; 8 transient int size = 0; 9 transient Node\u003cE\u003e first; 10 transient Node\u003cE\u003e last; 11 12 public LinkedList(String name) { 13 this.name = name; 14 } 15 16 // 头插节点 17 void linkFirst(E e) { 18 final Node\u003cE\u003e f = first; 19 final Node\u003cE\u003e newNode = new Node\u003c\u003e(null, e, f); 20 first = newNode; 21 if (f == null) 22 last = newNode; 23 else 24 f.prev = newNode; 25 size++; 26 } 27 28 // 尾插法 29 void linkLast(E e) { 30 final Node\u003cE\u003e l = last; 31 final Node\u003cE\u003e newNode = new Node\u003c\u003e(l, e, null); 32 last = newNode; 33 if (l == null) { 34 first = newNode; 35 } else { 36 l.next = newNode; 37 } 38 size++; 39 } 40 41 @Override 42 public boolean add(E e) { 43 linkLast(e); 44 return true; 45 } 46 47 @Override 48 public boolean addFirst(E e) { 49 linkFirst(e); 50 return true; 51 } 52 53 @Override 54 public boolean addLast(E e) { 55 linkLast(e); 56 return true; 57 } 58 59 @Override 60 public boolean remove(Object o) { 61 if (o == null) { 62 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 63 if (x.item == null) { 64 unlink(x); 65 return true; 66 } 67 } 68 } else { 69 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 70 if (o.equals(x.item)) { 71 unlink(x); 72 return true; 73 } 74 } 75 } 76 return false; 77 } 78\t79 // 删除节点，注意是双向链表 80 E unlink(Node\u003cE\u003e x) { 81 final E element = x.item; 82 final Node\u003cE\u003e next = x.next; 83 final Node\u003cE\u003e prev = x.prev; 84 85 // x为头节点 86 if (prev == null) { 87 first = next; 88 } else { 89 prev.next = next; 90 x.prev = null; 91 } 92 93 // x为末尾 94 if (next == null) { 95 last = x.prev; 96 } else { 97 next.prev = prev; 98 x.next = null; 99 } 100 101 x.item = null; 102 size--; 103 return element; 104 } 105 106 @Override 107 public E get(int index) { 108 return node(index).item; 109 }\t110\t111 // 根据index，判断是前向还是后向 112 private Node\u003cE\u003e node(int index) { 113 if (index \u003c (size \u003e\u003e 1)) { 114 Node\u003cE\u003e x = first; 115 for (int i = 0; i \u003c index; i++) { 116 x = x.next; 117 } 118 return x; 119 } else { 120 Node\u003cE\u003e x = last; 121 for (int i = size-1; i \u003e index; i--) { 122 x = x.prev; 123 } 124 return x; 125 } 126 } 127 128 @Override 129 public void printLinkList() { 130 if (this.size == 0) { 131 System.out.printf(\"链表为空\"); 132 } else { 133 Node\u003cE\u003e temp = first; 134 System.out.print(\"目前的列表，头节点：\" + first.item + \" 尾节点：\" + last.item + \" 整体：\"); 135 while (temp != null) { 136 System.out.print(temp.item + \"，\"); 137 temp = temp.next; 138 } 139 System.out.println(); 140 } 141 } 142} 第2-11节 交易规则责任链过滤 2025-4-8 17:30\n该章节补充：过滤拼团活动配置的规则。包括；活动的有效期、状态，以及个人参与拼团的次数。\n1// Logic chain 2// 1. 检查参数 3// 2. 检查是否存在交易记录，根据外部OrderId 4// 3. 判断拼团活动是否满 5// 4. 营销试算 -- 给出折扣价格 6// 5. 人群限定 -- 特定人群才能拼团 7// 6. 拼团锁单 -- 1. 修改活动表对应的信息 2. 插入一条拼团记录 8// 6.1. 交易规则过滤 -- 检查活动时间 + 检查拼团次数 ⭐本节主要这部分 具体就是定义一些 责任链节点(拦截器)\n1@Slf4j 2@Service 3public class ActivityUsabilityRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"交易规则过滤-活动的可用性校验{} activityId:{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 // 查询拼团活动 13 GroupBuyActivityEntity groupBuyActivityEntity = repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId()); 14 15 // 校验：活动状态 16 if (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivityEntity.getStatus())) { 17 log.info(\"活动的可用性校验，非生效状态 activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0101); 19 } 20 21 // 校验；活动时间 22 Date now = new Date(); 23 if (now.before(groupBuyActivityEntity.getStartTime()) || now.after(groupBuyActivityEntity.getEndTime())) { 24 log.info(\"活动的可用性校验，非可参与时间范围 activityId:{}\", requestParameter.getActivityId()); 25 throw new AppException(ResponseCode.E0102); 26 } 27 28 dynamicContext.setGroupBuyActivity(groupBuyActivityEntity); 29 30 // 走到下一个责任链节点 31 return next(requestParameter, dynamicContext); 32 } 33} 1@Slf4j 2@Service 3public class UserTakeLimitRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"交易规则过滤-用户参与次数校验{} activityId{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity(); 13 14 Integer count = repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId()); 15 16 if (groupBuyActivity.getTakeLimitCount() != null \u0026\u0026 count \u003e= groupBuyActivity.getTakeLimitCount()) { 17 log.info(\"用户参数次数校验，已达可参与上限 activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0103); 19 } 20 21 return TradeRuleFilterBackEntity.builder() 22 .userTakeOrderCount(count) 23 .build(); 24 } 25} 组装责任链 – BusinessLinkedList 具体业务\n1@Bean(\"tradeRuleFilter\") 2public BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e 3 tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) { 4 // 组装链 5 LinkArmory\u003cTradeRuleCommandEntity, DynamicContext, TradeRuleFilterBackEntity\u003e filter = new LinkArmory\u003c\u003e(\"交易规则过滤链\", activityUsabilityRuleFilter, userTakeLimitRuleFilter); 6 // 链对象 7 return filter.getLogicLink(); 8} LinkArmory – 真正的抽象装配责任链\n1@SafeVarargs 2public LinkArmory(String linkName, ILogicHandler\u003cT, D, R\u003e... logicHandlers) { 3 logicLink = new BusinessLinkedList\u003c\u003e(linkName); 4 for (ILogicHandler\u003cT, D, R\u003e logicHandler: logicHandlers){ 5 logicLink.add(logicHandler); 6 } 7} 8public BusinessLinkedList\u003cT, D, R\u003e getLogicLink() { 9 return logicLink; 10} 用法\n1@Resource 2private BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e tradeRuleFilter; 3 4tradeRuleFilter.aaply(...) 第2-12节：拼团组队结算统计 25/4/8 21:19\n拼团的过程是用户在商城下单，锁定拼团优惠（也就是拼团系统里锁单的过程）。之后就是用户给这笔商品完成支付交易，交易后不会直接发货，直至拼团组队完成后才会发货。\n那么，这里有一个流程，就是支付完成后，需要做拼团数量的统计结算。如，拼团需要3个用户一起下单，那么每完成一笔支付，就要给拼团的组队加上一笔记录。这个就是本节要实现的流程。\n⭐⭐⭐ 所有用户完成支付后, 最后一个用户的结算触发回调事件!\n1@Transactional(timeout = 500) 2@Override 3public void settlementMarketPayOrder(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate) { 4 UserEntity userEntity = groupBuyTeamSettlementAggregate.getUserEntity(); 5 GroupBuyTeamEntity groupBuyTeamEntity = groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity(); 6 TradePaySuccessEntity tradePaySuccessEntity = groupBuyTeamSettlementAggregate.getTradePaySuccessEntity(); 7 8 // 1. 更新拼团订单明细状态 9 GroupBuyOrderList groupBuyOrderList = new GroupBuyOrderList(); 10 groupBuyOrderList.setUserId(userEntity.getUserId()); 11 groupBuyOrderList.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo()); 12 int updateOrderStatus2COMPLETE = groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderList); 13 if (1 != updateOrderStatus2COMPLETE) { 14 throw new AppException(ResponseCode.UPDATE_ZERO); 15 } 16\t17 // 2. 更新拼团达成数量 18 int updateAddCount = groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId()); 19 if (1 != updateAddCount) { 20 throw new AppException(ResponseCode.UPDATE_ZERO); 21 } 22 23 // 3. 更新拼团完成状态 24 if (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == 1) { 25 int i = groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId()); 26 if (1 != i) { 27 throw new AppException(ResponseCode.UPDATE_ZERO); 28 } 29 30 // 查询拼团交易外部订单号列表 31 List\u003cString\u003e outOrderNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId()); 32 33 // 拼团完成写入回调任务记录 34 NotifyTask notifyTask = NotifyTask.builder() 35 .activityId(groupBuyTeamEntity.getActivityId()) 36 .teamId(groupBuyTeamEntity.getTeamId()) 37 .notifyUrl(\"暂无\") 38 .notifyCount(0) 39 .notifyStatus(0) 40 .build(); 41 notifyTask.setParameterJson(JSON.toJSONString(new HashMap\u003cString, Object\u003e() {{ 42 put(\"teamId\", groupBuyTeamEntity.getTeamId()); 43 put(\"outTradeNoList\", outOrderNoList); 44 }})); 45 46 notifyTaskDao.insert(notifyTask); 47 } 48 49} 这里算是支付成功后的回调\n第2-13节：交易结算责任链过滤 ⏱️25/4/9 12:31\n本节诉求：\n拼团交易结算的过程，需要一些列的规则过滤。包括；我们上一节提到的校验外部交易单的时间是否在拼团有效时间内，同时还有关于这笔外部交易单是否为有效的拼团锁单订单。另外像是 SC 渠道的有效性也需要在结算时进行校验。\n所以，本节我们需要实现一套规则链，来处理这些业务规则。因为规则链已经被抽取为通用的模板了，那么本节使用起来会非常容易。\n责任链流程：1. 校验渠道是否为黑名单 2. 外部订单号是否正确 3. 交易时间是否在拼团有效期内 4. 打包信息到上下文\n责任链包装对象\n1@Bean(\"tradeSettlementRuleFilter\") 2public BusinessLinkedList\u003cTradeSettlementRuleCommandEntity, 3TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e tradeSettlementRuleFilter( 4 SCRuleFilter scRuleFilter, OutTradeNoRuleFilter outTradeNoRuleFilter, SettableRuleFilter settableRuleFilter, EndRuleFilter endRuleFilter 5) { 6 LinkArmory\u003cTradeSettlementRuleCommandEntity, DynamicContext, TradeSettlementRuleFilterBackEntity\u003e tradeSettlementFilter = 7 new LinkArmory\u003c\u003e(\"交易结算规则过滤链\", scRuleFilter, outTradeNoRuleFilter, settableRuleFilter, endRuleFilter); 8 9 return tradeSettlementFilter.getLogicLink(); 10 11} 1 SC过滤器\n1@Slf4j 2@Service 3public class SCRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 // 1. 打印函数流程信息 12 log.info(\"结算规则过滤-渠道黑名单校验{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 13 14 // 2. 校验黑名单信息 15 Boolean intercept = repository.isSCBlackIntercept(requestParameter.getSource(), requestParameter.getChannel()); 16 if (intercept) { 17 log.info(\"{}-{} 渠道黑名单拦截\", requestParameter.getSource(), requestParameter.getChannel()); 18 throw new AppException(ResponseCode.E0105); 19 } 20 21 return next(requestParameter, dynamicContext); 22 } 23} 2 订单号校验过滤器\n1@Slf4j 2@Service 3public class OutTradeNoRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 log.info(\"结算规则过滤-外部单号校验{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 12 13 MarketPayOrderEntity marketPayOrderEntity = repository.queryMarketPayOrderEntityByOutTradeNo(requestParameter.getUserId(), requestParameter.getOutTradeNo()); 14 15 if (null == marketPayOrderEntity) { 16 log.info(\"不存在的外部交易单号或用户已退单，不需要做支付订单结算：{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 17 throw new AppException(ResponseCode.E0104); 18 } 19 20 dynamicContext.setMarketPayOrderEntity(marketPayOrderEntity); 21 22 return next(requestParameter, dynamicContext); 23 } 24} 3 有效期校验器\n1@Slf4j 2@Service 3public class SettableRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 log.info(\"结算规则过滤-有效时间校验：{}, {}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 12 13 // 1. 上下文获取数据 14 MarketPayOrderEntity marketPayOrderEntity = dynamicContext.getMarketPayOrderEntity(); 15 16 // 2. 查询拼团对象 17 GroupBuyTeamEntity groupBuyTeamEntity = repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId()); 18 19 // 3. 外部交易时间 - 支付时间需要在拼团有效时间内完成 20 if (requestParameter.getOutTradeTime().after(groupBuyTeamEntity.getValidEndTime())){ 21 // 4. 判断，外部交易时间是否小于拼团结束时间 22 log.info(\"订单交易时间不在拼团有效时间范围内\"); 23 throw new AppException(ResponseCode.E0106); 24 } 25 26 // 5. 设置上下文 27 dynamicContext.setGroupBuyTeamEntity(groupBuyTeamEntity); 28 29 return next(requestParameter, dynamicContext); 30 } 31} 4 打包节点\n1@Slf4j 2@Service 3public class EndRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 @Override 6 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 7 log.info(\"结算规则过滤-结束节点{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 8 9 GroupBuyTeamEntity groupBuyTeamEntity = dynamicContext.getGroupBuyTeamEntity(); 10 11 return TradeSettlementRuleFilterBackEntity.builder() 12 .teamId(groupBuyTeamEntity.getTeamId()) 13 .activityId(groupBuyTeamEntity.getActivityId()) 14 .completeCount(groupBuyTeamEntity.getCompleteCount()) 15 .targetCount(groupBuyTeamEntity.getTargetCount()) 16 .validStartTime(groupBuyTeamEntity.getValidStartTime()) 17 .validEndTime(groupBuyTeamEntity.getValidEndTime()) 18 .lockCount(groupBuyTeamEntity.getLockCount()) 19 .status(groupBuyTeamEntity.getStatus()) 20 .build(); 21 } 22} 5 SC来源渠道黑名单动态配置\n1@Slf4j 2@Service 3public class DCCService 4 5@DCCValue(\"scBlacklist:s02c02\") // 默认黑名单渠道 6private String scBlacklist; 7 8public Boolean isSCBlackIntercept(String source, String channel) { 9 List\u003cString\u003e list = Arrays.asList(scBlacklist.split(Constants.SPLIT)); 10 return list.contains(source + channel); 11} 12 13// Http请求key=scBlacklist\u0026value=s02c02;s03c03 14 15// =\u003e Redis (scBlacklist) =\u003e scBlacklist,s02c02;s03c03 第2-14节：拼团回调通知任务 ⏱️25/4/9 15:32\n拼团组队交易结算完结后，实现一个回调通知的任务处理。告知另外的微服务系统可以进行后续的流程了。\nRPC、MQ，这一类的都是需要有一个公用的注册中心，它的技术架构比较适合于公司内部的统一系统使用。如果是有和外部其他系统的对接，通常我们会使用 HTTP 这样统一标准协议的接口进行使用。\n注意：微信支付，支付宝支付，也是在完成支付后，做的这样的回调处理。\n💡流程逻辑 1：锁单\n1// 1. 检查锁单请求信息 - 请求参数是否为Null or 空串 2// 2. 检查outTradeNo是否重复锁单 - 检查检查outTradeNo是否重复锁单是否存在 3// 3. 拼团是否能够加入 - 判断拼团当前人数小于目标人数 4// 4. 营销优惠试算 5// 4.1. RootNode =\u003e SwitchRoot =\u003e MarketNode =\u003e TagNode =\u003e EndNode 6// =\u003e ErrorNode 7// 4.1.1 RootNode检查信息 8// 4.1.2 SwitchRoot 降级和限流 9// 4.1.3 MarketNode 1:异步查询商品信息+活动信息 2:进行折扣验算(根据Map拿到对应的折扣对象 - 每个折扣对象实现同一接口) 10// 4.1.4-1 TagNode：根据bitset，检查用户Id是否有资格参与or可见该折扣活动 11//\t4.1.4-2 ErrorNode：无折扣活动返回 12// 4.1.5 EndNode 组装试算结果 13// 5. 根据试算结果判断是否可见和可参与 14// 6. 进行锁单 15//\t6.1. 交易规则检查 - 校验活动状态+活动时间 \u0026\u0026 校验参与次数 -责任链 16// LinkArmory(BusinessLinkedList:ActivityUsabilityRuleFilter+UserTakeLimitRuleFilter) 17//\t6.1.1 ActivityUsabilityRuleFilter: 检查活动状态和时间 18//\t6.1.2 UserTakeLimitRuleFilter: 检查用户参与次数 19// 6.2. 判断是否有团 - 生成拼团订单 or 加入别人的订单 =\u003e 插入or修改记录 GroupBuyOrder 20// 6.3. 生成订单明细 =\u003e 插入记录到GroupBuyOrderList 💡流程逻辑 2：结算\n1// 1. 检查拼团信息 - 结算规则 2// 1.1 检查 渠道合法性=\u003e外部订单合法性=\u003e拼团时间合法性=\u003e包装检查结果 3// 1.1.1 SCRuleFilter: 检查source和channel是否在黑名单中，@DCCValue(\"scBlacklist:s02c02\"), 可动态配置 4// 1.1.2 OutTradeNoRuleFilter：检查OutTradeNo是否合法，是否GroupBuyOrderList存在初始锁单的拼团订单 5//\t(这里，外部进行了支付，但是系统还没修改结算状态呢) 6// 1.1.3 SettableRuleFilter：检查订单交易时间是否在拼团有效时间内 7// 1.1.4 EndRuleFilter：包装结果 8// 2. 进行拼团结算 9// 2.1 更新拼团订单明细 =\u003e GroupBuyOrderList对应用户的完成状态 10// 2.2 更新拼团达成数量 =\u003e GroupBuyOrder对应的用户完成支付数量 11// 2.3 更新拼团完成状态 =\u003e 最后一个人支付完成触发 =\u003e GroupBuyOrder拼团信息状态 =\u003e 写入回调任务记录(包装TeamId+所有的外部订单ID) 12// 3. 组队回调处理 - 这里显示的执行，使得实时性比较好，只有最后一个人完成才会执行成功，不过有定时任务进行兜底 13// 3.1 发送Http远程调用，将(TeamId+所有的外部订单ID)发送给第三方服务，通知发货or其他 14// 3.2 定时任务：查询所有初始状态和重试状态的 通知任务 🏷️本章节完成 3 触发回调部分\n1// 指定触发回调通知任务 - 实时性 2@Override 3public Map\u003cString, Integer\u003e execSettlementNotifyJob(String teamId) throws Exception { 4 log.info(\"拼团交易-执行结算通知回调，指定 teamId:{}\", teamId); 5 6 List\u003cNotifyTaskEntity\u003e notifyTaskEntityList = repository.queryUnExecutedNotifyTaskList(teamId); 7 return execSettlementNotifyJob(notifyTaskEntityList); 8} 9 10// 辅助定时扫描，进行通知 - 兜底 11@Override 12public Map\u003cString, Integer\u003e execSettlementNotifyJob() throws Exception { 13 log.info(\"拼团交易-执行结算通知任务\"); 14 15 // 查询未执行任务 16 List\u003cNotifyTaskEntity\u003e notifyTaskEntities = repository.queryUnExecutedNotifyTaskList(); 17 18 return execSettlementNotifyJob(notifyTaskEntities); 19} 20 21// 公用通知函数 22private Map\u003cString, Integer\u003e execSettlementNotifyJob(List\u003cNotifyTaskEntity\u003e notifyTaskEntities) throws Exception { 23 int successCount = 0, errorCount = 0, retryCount = 0; 24 for (NotifyTaskEntity notifyTask : notifyTaskEntities) { 25 // 回调处理 26 String response = port.groupBuyNotify(notifyTask); 27 28 if (NotifyTaskHTTPEnumVO.SUCCESS.getCode().equals(response)) { 29 int i = repository.updateNotifyTaskStatusSuccess(notifyTask.getTeamId()); 30 if (1 == i) { 31 successCount += 1; 32 } 33 } else if (NotifyTaskHTTPEnumVO.ERROR.getCode().equals(response)) { 34 int i = repository.updateNotifyTaskStatusError(notifyTask.getTeamId()); 35 if (1 == i) { 36 errorCount += 1; 37 } 38 } else { 39 int i = repository.updateNotifyTaskStatusRetry(notifyTask.getTeamId()); 40 if (1 == i) { 41 retryCount += 1; 42 } 43 } 44 } 45 46 Map\u003cString, Integer\u003e resultMap = new HashMap\u003c\u003e(); 47 resultMap.put(\"waitCount\", notifyTaskEntities.size()); 48 resultMap.put(\"successCount\", successCount); 49 resultMap.put(\"errorCount\", errorCount); 50 resultMap.put(\"retryCount\", retryCount); 51 52 return resultMap; 53} 54 55// 远程调用 56@Override 57public String groupBuyNotify(NotifyTaskEntity notifyTask) throws Exception { 58 RLock lock = redisService.getLock(notifyTask.lockKey()); 59 try { 60 // 拼团服务器部署在多台应用服务器上，多任务执行，避免任务被多次执行，锁的粒度 xxx:teamId 61 if (lock.tryLock(3, 0, TimeUnit.SECONDS)) { 62 try { 63 if (StringUtils.isBlank(notifyTask.getNotifyUrl()) || \"暂无\".equals(notifyTask.getNotifyUrl())) { 64 return NotifyTaskHTTPEnumVO.SUCCESS.getCode(); 65 } 66 return ⭐groupBuyNotifyService.groupBuyNotify(notifyTask.getNotifyUrl(), notifyTask.getParameterJson());⭐ // 这里进行远程调用 67 } finally { 68 if (lock.isLocked() \u0026\u0026 lock.isHeldByCurrentThread()) 69 lock.unlock(); 70 } 71 } 72 return NotifyTaskHTTPEnumVO.NULL.getCode(); 73 }catch (Exception e) { 74 Thread.currentThread().interrupt(); 75 return NotifyTaskHTTPEnumVO.NULL.getCode(); 76 } 77} 78 79// OKHttp发送请求 80public String groupBuyNotify(String apiUrl, String notifyRequestDTOJSON) { 81 try { 82 // 1. 构建参数 83 MediaType mediaType = MediaType.parse(\"application/json\"); 84 RequestBody body = RequestBody.create(mediaType, notifyRequestDTOJSON); 85 Request request = new Request.Builder() 86 .url(apiUrl) 87 .post(body) 88 .addHeader(\"content-type\", \"application/json\") 89 .build(); 90 91 // 2. 调用接口 92 Response response = okHttpClient.newCall(request).execute(); 93 94 // 3. 返回结果 95 return response.body().string(); 96 } catch (IOException e) { 97 log.info(\"拼团回调 HTTP 接口服务异常 {}\", apiUrl, e); 98 throw new AppException(ResponseCode.HTTP_EXCEPTION); 99 } 100} 微信扫描登录流程 access_token是公众号的全局唯一接口调用凭据; 公众号和小程序均可以使用AppID和AppSecret调用本接口来获取access_token。\n用户点击Web登录 =\u003e 商户后端 =\u003e 获取公众号登录凭证(请求微信二维码接口，获取对应的ticket，用于获取微信公众号的二维码) 然后，前端根据ticket去微信系统获取对应的二维码，进行登录 登录成功后，微信会回调公众号对应的回调接口，这时候，后端可以保存用户信息，比如 （openid标识用户） 前端再拿ticket进行登录校验，登录成功后，返回Token令牌就好了。 ⭐\n需要实现请求二维码登录凭证的Api接口； 需要实现微信登录回调的Api接口，保存用户登录信息； 需要实现用户登录校验的接口，生成Token令牌，后续请求用这个。 微信支付流程 请求下单接口 =\u003e 后端创建订单(创建) =\u003e 请求微信支付系统(创建支付订单),后端订单(待付款)；最后返回拉起支付的参数； 小程序拉起微信收银台 回调小程序支付状态，小程序查询商户后端订单状态 =\u003e 后端查询微信支付系统 =\u003e … =\u003e 返回支付状态 用户支付成功，会回调通知商户后端。⭐需要实现回调的接口，保持支付通知(改后端订单状态: 已支付) 未收到回调通知，需要商户后端主动查询微信支付的查询接口。 超时 =\u003e 商户后端主动调用微信关单接口 (订单状态：支付失败|超时) 退款 =\u003e 商户后端请求微信支付退款接口 (订单状态：退款) ⭐\n需要实现的接口：\n商户后端创建初始订单，并请求微信支付生成支付订单的Api接口；(检查订单幂等性) 接收微信支付回调的Api接口，修改订单支付状态； 主动查询订单支付状态的接口，调用微信支付的查询接口。 超时 =\u003e 商户后端主动调用微信关单接口 (订单状态：支付失败|超时)的Api接口 退款 =\u003e 商户后端请求微信支付退款接口 (订单状态：退款)的Api接口 第2-15节：根据UI展示封装接口 紫色圈：拼团的统计信息；\n灰色圈：商品信息；\n红色圈：参与拼团，随机挑选几个团；\n绿色圈：参与拼团；单独开始一个新的团，还是参与其他人的团\n黄色圈：拼团结算。\nResponseDTO\n1@Data 2@Builder 3@AllArgsConstructor 4@NoArgsConstructor 5public class GoodsMarketResponseDTO { 6 7 private Goods goods; 8 private List\u003cTeam\u003e teamList; 9 private TeamStatistic teamStatistic; 10 11 /** 12 * 商品信息 13 */ 14 @Data 15 @Builder 16 @AllArgsConstructor 17 @NoArgsConstructor 18 public static class Goods { 19 // 商品ID 20 private String goodsId; 21 // 原始价格 22 private BigDecimal originalPrice; 23 // 折扣金额 24 private BigDecimal deductionPrice; 25 // 支付价格 26 private BigDecimal payPrice; 27 } 28 29 /** 30 * 组队信息 31 */ 32 @Data 33 @Builder 34 @AllArgsConstructor 35 @NoArgsConstructor 36 public static class Team { 37 // 用户ID 38 private String userId; 39 // 拼单组队ID 40 private String teamId; 41 // 活动ID 42 private Long activityId; 43 // 目标数量 44 private Integer targetCount; 45 // 完成数量 46 private Integer completeCount; 47 // 锁单数量 48 private Integer lockCount; 49 // 拼团开始时间 - 参与拼团时间 50 private Date validStartTime; 51 // 拼团结束时间 - 拼团有效时长 52 private Date validEndTime; 53 // 倒计时(字符串) validEndTime - validStartTime 54 private String validTimeCountdown; 55 /** 外部交易单号-确保外部调用唯一幂等 */ 56 private String outTradeNo; 57 58 public static String differenceDateTime2Str(Date validStartTime, Date validEndTime) { 59 if (validStartTime == null || validEndTime == null) { 60 return \"无效的时间\"; 61 } 62 63 long diffInMilliseconds = validEndTime.getTime() - validStartTime.getTime(); 64 65 if (diffInMilliseconds \u003c 0) { 66 return \"已结束\"; 67 } 68 69 long seconds = TimeUnit.MILLISECONDS.toSeconds(diffInMilliseconds) % 60; 70 long minutes = TimeUnit.MILLISECONDS.toMinutes(diffInMilliseconds) % 60; 71 long hours = TimeUnit.MILLISECONDS.toHours(diffInMilliseconds) % 24; 72 long days = TimeUnit.MILLISECONDS.toDays(diffInMilliseconds); 73 74 return String.format(\"%02d:%02d:%02d\", hours, minutes, seconds); 75 } 76 77 } 78 79 80 /** 81 * 组队统计 82 */ 83 @Data 84 @Builder 85 @AllArgsConstructor 86 @NoArgsConstructor 87 public static class TeamStatistic { 88 // 开团队伍数量 89 private Integer allTeamCount; 90 // 成团队伍数量 91 private Integer allTeamCompleteCount; 92 // 参团人数总量 - 一个商品的总参团人数 93 private Integer allTeamUserCount; 94 } 95 96} 1// 增删改查 2// 注意：Team的查询 3// 1. 先查自己的拼团 4// 2. 查其他人的拼团。对应活动，非当前用户，状态为可加入拼团，时间有效，队伍in(对应活动，且锁单人数小于目标人数) 5 6@Override 7public List\u003cUserGroupBuyOrderDetailEntity\u003e queryInProgressUserGroupBuyOrderDetailListByRandom(Long activityId, String userId, Integer randomCount) { 8 // 1. 根据用户ID、活动ID、查询非当前用户参与的拼团队伍 9 GroupBuyOrderList buyOrderListReq = GroupBuyOrderList.builder() 10 .activityId(activityId) 11 .userId(userId) 12 .build(); 13 buyOrderListReq.setCount(randomCount * 2); // 查询两倍的量，再随机取一半 14 15 // 1. ==ActivityId; 2. !=userId 3; status == 0 or 1; 4. endTime \u003e now(); 5. teamId in (select teamId from group_buy_order where status = 0 and activity = #{activity}) 16 List\u003cGroupBuyOrderList\u003e groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByRandom(buyOrderListReq); 17 if (groupBuyOrderLists == null || groupBuyOrderLists.isEmpty()) 18 return null; 19 20 // 随机选 randomCount 条 21 if (groupBuyOrderLists.size() \u003e randomCount) { 22 Collections.shuffle(groupBuyOrderLists); 23 groupBuyOrderLists = groupBuyOrderLists.subList(0, randomCount); 24 } 25 26 // 2. 过滤队伍获取 TeamId 27 Set\u003cString\u003e teamIds = groupBuyOrderLists.stream().map(GroupBuyOrderList::getTeamId) 28 .filter(teamId -\u003e teamId != null \u0026\u0026 !teamId.isEmpty()) 29 .collect(Collectors.toSet()); 30 31 32 // 3. 查询队伍明细，组装Map结构 33 List\u003cGroupBuyOrder\u003e groupBuyOrders = groupBuyOrderDao.queryGroupBuyProgressByTeamIds(teamIds); 34 if (groupBuyOrders == null || groupBuyOrders.isEmpty()) return null; 35 36 Map\u003cString, GroupBuyOrder\u003e groupBuyOrderMap = groupBuyOrders.stream() 37 .collect(Collectors.toMap(GroupBuyOrder::getTeamId, order -\u003e order)); 38 39 // 4. 转换数据 40 ArrayList\u003cUserGroupBuyOrderDetailEntity\u003e userGroupBuyOrderDetailEntities = new ArrayList\u003c\u003e(); 41 // ... 根据 groupBuyOrders 和 groupBuyOrderLists组装结果 42 43 return userGroupBuyOrderDetailEntities; 44} 1// 锁单 接口 2⬇️ 3// outTradeNo - 调用第三方支付生成 4⬇️ 5// 结算 接口 第2-16节 独占锁和无锁化 一个库存一个锁，最小化锁的粒度，使用occupyCount + recoveryCount 判断库存。因为之前的线程抢占了库存，但是执行失败，需要恢复被抢占的库存量。\n**独占锁：**多个服务均有定时任务，仅一个服务执行即可。\n1@Scheduled(cron = \"0 0 0 * * ?\") 2public void exec() { 3 RLock lock = redissonClient.getLock(\"group_buy_market_notify_job_exec\"); 4 try { 5 // 等待时间(若被占用等待3秒)，锁的过期时间(0表示需要手动释放) 6 boolean isLocked = lock.tryLock(3, 0, TimeUnit.SECONDS); 7 if (!isLocked) return; 8 9 Map\u003cString, Integer\u003e result = tradeSettlementOrderService.execSettlementNotifyJob(); 10 log.info(\"定时任务，回调通知拼团完结任务 result:{}\", JSON.toJSONString(result)); 11 } catch (Exception e) { 12 log.error(\"定时任务，回调通知拼团完结任务失败\", e); 13 } finally { 14 if (lock.isLocked() \u0026\u0026 lock.isHeldByCurrentThread()) { 15 lock.unlock(); 16 } 17 } 18} 乐观锁：\n将库存的隔离进行分段化，一个库存表示一个锁\n1// 拼团人数检查-是否已满 2// 1. teamId 为空，则为首次开团，不做拼团组队目标量库存限制 3String teamId = requestParameter.getTeamId(); 4if (StringUtils.isBlank(teamId)) { 5 return TradeLockRuleFilterBackEntity.builder() 6 .userTakeOrderCount(dynamicContext.getUserTakeOrderCount()) 7 .build(); 8} 9 10// 2. 抢占库存；通过抢占 Redis 缓存库存，来降低对数据库的操作压力。 11// 上下文信息 12GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity(); 13Integer target = groupBuyActivity.getTarget(); 14Integer validTime = groupBuyActivity.getValidTime(); 15String teamStockKey = dynamicContext.generateTeamStockKey(teamId); 16String recoveryTeamStockKey = dynamicContext.generateRecoveryTeamStockKey(teamId); 17 18// 抢占库存 19boolean status = repository.occupyTeamStock(teamStockKey, recoveryTeamStockKey, target, validTime); 抢占库存\n1public boolean occupyTeamStock(String teamStockKey, String recoveryTeamStockKey, Integer target, Integer validTime) { 2 // 失败恢复量 3 Long recoveryCount = redisService.getAtomicLong(recoveryTeamStockKey); 4 recoveryCount = null == recoveryCount ? 0 : recoveryCount; 5 6 // 1. incr 得到值，与总量和恢复量做对比。恢复量为系统失败时候记录的量。 7 // 2. 从有组队量开始，相当于已经有了一个占用量，所以要 +1 8 long occupy = redisService.incr(teamStockKey) + 1; 9 10 if (occupy \u003e= target + recoveryCount) { 11 redisService.setAtomicLong(teamStockKey, target); 12 return false; 13 } 14 15 // 1. 给每个产生的值加锁为兜底设计，虽然incr操作是原子的，基本不会产生一样的值。但在实际生产中，遇到过集群的运维配置问题，以及业务运营配置数据问题，导致incr得到的值相同。 16 // 2. validTime + 60分钟，是一个延后时间的设计，让数据保留时间稍微长一些，便于排查问题。 17 String lockKey = teamStockKey + Constants.UNDERLINE + occupy; 18 Boolean lock = redisService.setNx(lockKey, validTime + 60, TimeUnit.MINUTES); 19 20 if (!lock) { 21 log.info(\"组队库存加锁失败 {}\", lockKey); 22 } 23 24 return lock; 25} 恢复库存 \u003c= 业务执行失败，需要进行库存的恢复！\n1@Override 2public void recoveryTeamStock(String recoveryTeamStockKey, Integer validTime) { 3 // 首次组队拼团，是没有 teamId 的，所以不需要这个做处理。 4 if (StringUtils.isBlank(recoveryTeamStockKey)) return; 5 redisService.incr(recoveryTeamStockKey); 6} ",
  "wordCount" : "4572",
  "inLanguage": "en",
  "image": "http://longcoding.top/papermod-cover.png","datePublished": "2025-03-23T19:36:21+08:00",
  "dateModified": "2025-03-23T19:36:21+08:00",
  "author":{
    "@type": "Person",
    "name": "👨🏻‍🎓 LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://longcoding.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://longcoding.top/" accesskey="h" title="𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰 (Alt + H)">
                <img src="http://longcoding.top/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">𝓛𝓸𝓷𝓰𝓒𝓸𝓭𝓲𝓷𝓰</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://longcoding.top/index.html" title="🏡 Home">
                    <span>🏡 Home</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/archives/" title="📃 Archives">
                    <span>📃 Archives</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/tags/" title="📑 Tags">
                    <span>📑 Tags</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/categories/" title="🗒️ Categories">
                    <span>🗒️ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/search/" title="🔍 Search">
                    <span>🔍 Search</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/about/" title="👨🏻‍🎓 About Me">
                    <span>👨🏻‍🎓 About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://longcoding.top/">Home</a>&nbsp;»&nbsp;<a href="http://longcoding.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      拼团营销交易拼团
    </h1>
    <div class="post-description">
      Grouptradingproject
    </div>
    <div class="post-meta"><span title='2025-03-23 19:36:21 +0800 CST'>March 23, 2025</span>&nbsp;·&nbsp;22 min&nbsp;·&nbsp;4572 words&nbsp;·&nbsp;👨🏻‍🎓 LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e5%b9%b3%e5%8f%b0%e7%b3%bb%e7%bb%9f" aria-label="拼团交易平台系统">拼团交易平台系统</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e7%ac%ac1-2%e8%8a%82-%e6%8b%bc%e5%9b%a2%e5%ba%93%e8%a1%a8%e8%ae%be%e8%ae%a1" aria-label="第1-2节 拼团库表设计">第1-2节 拼团库表设计</a></li>
                <li>
                    <a href="#%e7%ac%ac1-3%e8%8a%82-%e7%a0%94%e5%8f%91%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1" aria-label="第1-3节 研发系统设计">第1-3节 研发系统设计</a></li>
                <li>
                    <a href="#%e7%ac%ac2-2%e8%8a%82-%e8%af%95%e7%ae%97%e6%a8%a1%e5%9e%8b%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="第2-2节 试算模型抽象模板设计">第2-2节 试算模型抽象模板设计</a></li>
                <li>
                    <a href="#%e7%ac%ac2-3%e8%8a%82-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%bc%82%e6%ad%a5%e6%95%b0%e6%8d%ae%e5%8a%a0%e8%bd%bd" aria-label="第2-3节 多线程异步数据加载">第2-3节 多线程异步数据加载</a></li>
                <li>
                    <a href="#%e7%ac%ac2-4%e8%8a%82-%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f%e4%bc%98%e6%83%a0%e6%8a%98%e6%89%a3%e8%ae%a1%e7%ae%97" aria-label="第2-4节 策略模式优惠折扣计算">第2-4节 策略模式优惠折扣计算</a></li>
                <li>
                    <a href="#%e7%ac%ac2-5%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e6%95%b0%e6%8d%ae%e9%87%87%e9%9b%86" aria-label="第2-5节 人群标签数据采集">第2-5节 人群标签数据采集</a></li>
                <li>
                    <a href="#%e7%ac%ac2-6%e8%8a%82-%e5%ba%93%e8%a1%a8%e6%8b%86%e5%88%86" aria-label="第2-6节 库表拆分">第2-6节 库表拆分</a></li>
                <li>
                    <a href="#%e7%ac%ac2-7%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e8%8a%82%e7%82%b9%e8%bf%87%e6%bb%a4" aria-label="第2-7节 人群标签节点过滤">第2-7节 人群标签节点过滤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-8%e8%8a%82--%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae%e5%bc%80%e5%85%b3%e6%93%8d%e4%bd%9c" aria-label="第2-8节  动态配置开关操作">第2-8节  动态配置开关操作</a></li>
                <li>
                    <a href="#%e7%ac%ac2-9%e8%8a%82-%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e8%90%a5%e9%94%80%e9%94%81%e5%8d%95" aria-label="第2-9节 拼团交易营销锁单">第2-9节 拼团交易营销锁单</a></li>
                <li>
                    <a href="#%e7%ac%ac2-10%e8%8a%82-%e8%b4%a3%e4%bb%bb%e9%93%be%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="第2-10节 责任链抽象模板设计">第2-10节 责任链抽象模板设计</a></li>
                <li>
                    <a href="#%e7%ac%ac2-11%e8%8a%82-%e4%ba%a4%e6%98%93%e8%a7%84%e5%88%99%e8%b4%a3%e4%bb%bb%e9%93%be%e8%bf%87%e6%bb%a4" aria-label="第2-11节 交易规则责任链过滤">第2-11节 交易规则责任链过滤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-12%e8%8a%82%e6%8b%bc%e5%9b%a2%e7%bb%84%e9%98%9f%e7%bb%93%e7%ae%97%e7%bb%9f%e8%ae%a1" aria-label="第2-12节：拼团组队结算统计">第2-12节：拼团组队结算统计</a></li>
                <li>
                    <a href="#%e7%ac%ac2-13%e8%8a%82%e4%ba%a4%e6%98%93%e7%bb%93%e7%ae%97%e8%b4%a3%e4%bb%bb%e9%93%be%e8%bf%87%e6%bb%a4" aria-label="第2-13节：交易结算责任链过滤">第2-13节：交易结算责任链过滤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-14%e8%8a%82%e6%8b%bc%e5%9b%a2%e5%9b%9e%e8%b0%83%e9%80%9a%e7%9f%a5%e4%bb%bb%e5%8a%a1" aria-label="第2-14节：拼团回调通知任务">第2-14节：拼团回调通知任务</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%89%ab%e6%8f%8f%e7%99%bb%e5%bd%95%e6%b5%81%e7%a8%8b" aria-label="微信扫描登录流程">微信扫描登录流程</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e6%b5%81%e7%a8%8b" aria-label="微信支付流程">微信支付流程</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2-15%e8%8a%82%e6%a0%b9%e6%8d%aeui%e5%b1%95%e7%a4%ba%e5%b0%81%e8%a3%85%e6%8e%a5%e5%8f%a3" aria-label="第2-15节：根据UI展示封装接口">第2-15节：根据UI展示封装接口</a></li>
                <li>
                    <a href="#%e7%ac%ac2-16%e8%8a%82-%e7%8b%ac%e5%8d%a0%e9%94%81%e5%92%8c%e6%97%a0%e9%94%81%e5%8c%96" aria-label="第2-16节 独占锁和无锁化">第2-16节 独占锁和无锁化</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="拼团交易平台系统">拼团交易平台系统<a hidden class="anchor" aria-hidden="true" href="#拼团交易平台系统">#</a></h1>
<p>**项目背景：**为了盘活沉睡用户，需要适当降低商品价格。但为了达到传播的效果，所以需要引入拼团方式，以客带客，靠用户自身传播的方式进行交易拉新。这样的处理方式对比于 KOL，会让利商品价值到用户自身。</p>
<h3 id="第1-2节-拼团库表设计">第1-2节 拼团库表设计<a hidden class="anchor" aria-hidden="true" href="#第1-2节-拼团库表设计">#</a></h3>
<p><em><strong>业务流程：</strong></em></p>
<p><img alt="image-20250323194301660" loading="lazy" src="http://verification.longcoding.top/FiI6jzJ8l7NKoKgTZcSoz3LzJqL1"></p>
<ul>
<li><em>运营角度：</em> 1. 给哪些商品配置拼单；2. 拼团商品提供的规则信息：折扣、时间、人数等。</li>
<li><em>用户角度：</em> 1. 参与拼团，首次发起or参与现有，拼单完成回调通知。</li>
<li><em>库表设计：</em> 1. 人群设计，将所有符合某个条件的用户ID，全部写入特定Redis记录中。</li>
<li>拼团活动，折扣的多种迭代。</li>
</ul>
<p><strong>库表设计：</strong></p>
<p><em>拼团配置表</em>：</p>
<p><img alt="image-20250323194814202" loading="lazy" src="http://verification.longcoding.top/FkAG47W_Dvi0nh84V_dSOYU0Ljd2"></p>
<ul>
<li>拼团活动表：设定了拼团的成团规则，人群标签的使用可以限定哪些人可见，哪些人可参与。</li>
<li>折扣配置表：拆分出拼团优惠到一个新的表进行多条配置。如果折扣还有更多的复杂规则，则可以配置新的折扣规则表进行处理。</li>
<li>人群标签表：专门来做人群设计记录的，这3张表就是为了把符合规则的人群ID，也就是用户ID，全部跑任务到一个记录下进行使用。 比如黑玫瑰人群、高净值人群、拼团履约率90%以上的人群等。</li>
</ul>
<p><em><strong>参与拼团表：</strong></em></p>
<p><img alt="image-20250323195108167" loading="lazy" src="http://verification.longcoding.top/FqOAEF4N91PNEdxvKoW0qT4GLpgt"></p>
<ul>
<li>拼团账户表：记录用户的拼团参与数据，一个是为了限制用户的参与拼团次数，另外是为了人群标签任务统计数据。</li>
<li>用户拼单表：当有用户发起首次拼单的时候，产生拼单id，并记录所需成团的拼单记录，另外是写上拼团的状态、唯一索引、回调接口等。这样拼团完成就可以回调对接的平台，通知完成了。【微信支付也是这样的设计，回调支付结果，这样的设计可以方便平台化对接】当再有用户参与后，则写入用户拼单明细表。直至达成拼团</li>
<li>回调任务表：当拼团完成后，要做回调处理。但可能会有失败，所以加入任务的方式进行补偿。如果仍然失败，则需要对接的平台，自己查询拼团结果。</li>
</ul>
<h3 id="第1-3节-研发系统设计">第1-3节 研发系统设计<a hidden class="anchor" aria-hidden="true" href="#第1-3节-研发系统设计">#</a></h3>
<p>进行研发系统设计。包括：库表设计、用例图、系统建模、工程模型、功能流程、UML时序图。</p>
<ul>
<li>用例图：用户与系统交互最简表示形式；</li>
<li>流程图：功能节点的串联关系；</li>
<li>时序图：展示了整个拼团过程所涉及的系统模块和流转关系</li>
</ul>
<p><strong>系统架构：</strong></p>
<p><em>MVC架构</em></p>
<img src="http://verification.longcoding.top/FputTQmCOc_DT9IHR_Tue1UphgiB" alt="image-20250323200411716" style="zoom:50%;" />
<p><em>DDD架构</em></p>
<img src="http://verification.longcoding.top/FtLoDQWtMfo0Tws2aSwFoLOq9d4a" alt="image-20250323200448795" style="zoom:50%;" />
<h3 id="第2-2节-试算模型抽象模板设计">第2-2节 试算模型抽象模板设计<a hidden class="anchor" aria-hidden="true" href="#第2-2节-试算模型抽象模板设计">#</a></h3>
<p><em><strong>引入设计模式进行解耦和实现，提高工程代码的扩展性</strong></em></p>
<p>=&gt; 设计模式抽象模板的通用结构定义，添加一个 tree规则树抽象模型，在引入到工程中进行使用。这样后续工程中就可以不断的定义通用的设计模式被不同的场景统一使用了。</p>
<p><strong>模型设计</strong></p>
<p>链式的多分支规则树模型结构，由功能节点自行决定后续流程的执行链路。它的设计比责任链的扩展性更好，自由度也更高</p>
<img src="http://verification.longcoding.top/Fs14rhSCUv1G2iJDaNAYovqrgCtI" alt="image-20250323212011895" style="zoom:50%;" />
<ul>
<li>首先，定义抽象的通用规则树模型结构
<ul>
<li>涵盖：StrategyMapper, StrategyHandler /ˈstrætədʒi/、AbstractStrategyRouter&lt;T, D, R&gt;。 通过泛型设计允许使用方可以自定义出入参和动态上下文，让抽象模板模型具有通用性。</li>
<li>之后，由使用方自定义出工厂、功能抽象类和一个个流程流转的节点。</li>
</ul>
</li>
</ul>
<p><strong>编码实现</strong></p>
<p>项目工程的Types模块中，添加通用设计模式模板</p>
<p><em>1.1 策略映射器</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm">     * 获取待执行策略
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     * @param requestParameter 入参
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     * @param dynamicContext   上下文
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">     * @return 返参
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     * @throws Exception 异常
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>用于获取每个执行的节点，责任链加强版</li>
<li>T，D，R：入参，上下文，反参</li>
</ul>
<p><em>1.2 策略受理器</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>执行具体的业务流程，利用上下文传递信息给后面执行的节点。</li>
</ul>
<p><em>1.3 策略路由器</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Setter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// 伪代码</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">strategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>执行具体节点，转发给下一个节点或者传递到默认节点中</li>
</ul>
<h3 id="第2-3节-多线程异步数据加载">第2-3节 多线程异步数据加载<a hidden class="anchor" aria-hidden="true" href="#第2-3节-多线程异步数据加载">#</a></h3>
<p><strong>首页试算</strong></p>
<p>当一个用户进入到购物首页查看商品的优惠信息，我们可以把这个过程定义为试算过程。试算；试试算一下，这个用户进入到首页看这个商品的时候，商品的营销优惠信息。包括：原始价格、折扣价格、拼团目标、拼团时效、是否可见优惠、是否可参与拼团等，这些东西都是试算拿到的结果。</p>
<p><strong>1. Model定义对象； 2. 服务功能实现，trial试算模块；3. 业务流转的功能节点</strong></p>
<img src="http://verification.longcoding.top/FmCp8w1NlRoVcELrPMSLgz_FOgTt" alt="image-20250323214143312" style="zoom:50%;" />
<p><strong>模型链路</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">IIndexGroupBuyMarketService</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RootNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">|</span><span class="n">检查信息</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MarketNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="err">⭐</span><span class="n">前置处理</span><span class="err">⭐</span><span class="n">拼单试算</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">+</span><span class="n">路由</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">前置处理</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">业务</span><span class="o">|</span><span class="n">构建结果</span><span class="o">]</span><span class="w">     
</span></span></span></code></pre></div><p><strong>路由策略模板[节点模板]</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">multiThread</span><span class="p">()</span><span class="w"> </span><span class="c1">// 前置处理</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doApply</span><span class="p">()</span><span class="w"> </span><span class="c1">// 业务逻辑</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">IActivityRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// 空方法，需要实现的话，让子类重写</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>具体节点实例</strong></p>
<p>工作流：前置处理 =&gt; 业务逻辑 =&gt; 路由</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RootNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">MarketProductEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> </span><span class="n">nextNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;业务处理&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w"> </span><span class="c1">// 下一个节点</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">switchNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>⭐⭐⭐</p>
<p><em><strong>异步数据加载</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 异步查询活动配置</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// 异步查询商品信息 -</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// 写入上下文， 前置查询数据 </span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXA</span><span class="p">(</span><span class="n">xxxFutureTaskA</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w"> </span><span class="c1">// 阻塞指定时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXB</span><span class="p">(</span><span class="n">xxxFutureTaskB</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="第2-4节-策略模式优惠折扣计算">第2-4节 <strong>策略模式优惠折扣计算</strong><a hidden class="anchor" aria-hidden="true" href="#第2-4节-策略模式优惠折扣计算">#</a></h3>
<p>不同优惠模式 =&gt; 策略模式实现</p>
<p><strong>定义接口</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>抽象模板</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractDiscountCalculateService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// 1. 人群标签过滤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsFilter</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isCrowdRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterTagId</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getTagId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isCrowdRange</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// 2. 折扣优惠计算</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doCalculate</span><span class="p">(</span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// 人群过滤 - 限定人群优惠</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">filterTagId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// todo xiaofuge 后续开发这部分</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// 具体计算函数</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>折扣方法</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;MJ&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 满减优惠</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MJCalculateService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(</span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">GroupBuyDiscount</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;优惠策略折扣计算:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getDiscountType</span><span class="p">().</span><span class="na">getCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// 折扣表达式 - 100,10 满100减10元</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">marketExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketExpr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">marketExpr</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// 不满足最低满减约束，则按照原价</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">originalPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// 折扣价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// 判断折扣后金额，最低支付1分钱</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&#34;0.01&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">deductionPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>营销调用</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// MarketNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团商品查询试算服务&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="n">groupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">getGroupBuyDiscount</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// 具体的策略，优惠模式</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;...&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">keys</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    	</span><span class="k">throw</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="c1">// 折扣价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">skuVO</span><span class="p">.</span><span class="na">getOriginalPrice</span><span class="p">(),</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setDeductionPrice</span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>学习点：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">XXX</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nd">@Resource</span><span class="w">   </span><span class="c1">// ⭐先按名称，找不到再按类型注入</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="第2-5节-人群标签数据采集">第2-5节 人群标签数据采集<a hidden class="anchor" aria-hidden="true" href="#第2-5节-人群标签数据采集">#</a></h3>
<p>精准的对这些用户做定向活动投放，比如；特定的券、特定的通知等。以此达到更加精准的运营效果</p>
<img src="http://verification.longcoding.top/Fl7ziKeBDxruQ3SdNIT9zf-9gfB5" alt="image-20250324161606013" style="zoom:50%;" />
<p>人群标签是根据用户业务行为采集的</p>
<p><strong>数据库表：</strong></p>
<p>crowd_tags ：统计功能；</p>
<p>crowd_tags_detail：tag_id =&gt; user_id;  具体每个人群都有谁；</p>
<p>crowd_tags_job：tag_id =&gt; batch_id, tag_relu:消费规则;</p>
<p><img alt="image-20250324170251768" loading="lazy" src="http://verification.longcoding.top/FmlVSVsIZIR9I2OvUixXEBJMm5wu"></p>
<p>流程：</p>
<ol>
<li>根据tag_id, batch_id 查询crowd_tags_job得到对应批次任务</li>
<li>采集用户数据</li>
<li>数据写入记录 // 暂存</li>
<li>数据写入数据库  =&gt; crowd_tags_detail</li>
<li>更新人群标签统计 =&gt; crowd_tags</li>
</ol>
<p><strong>数据写入数据库</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addCrowdTagsUserId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">CrowdTagsDetail</span><span class="w"> </span><span class="n">crowdTagsDetailReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CrowdTagsDetail</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setTagId</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">crowdTagsDetailDao</span><span class="p">.</span><span class="na">addCrowdTagsUserId</span><span class="p">(</span><span class="n">crowdTagsDetailReq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="c1">// 获取BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w"> </span><span class="c1">// tagId:{userId, ...}:BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">bitSet</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// Long类型啥的转换一下跟bitset长度一致，尽可能均匀</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DuplicateKeyException</span><span class="w"> </span><span class="n">ignore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// 忽略唯一索引冲突</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>❗❗❗redis中 BitSet 就是bit类型的hashtable， 而 bitmap是字符串；</p>
<p>大致思路：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 数据写入数据库时，同时把bitset中位置置1，表示这个用户存在于这个集合</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 查询时，根据用户Id，查bitset                    // 这里用户ID=&gt;bitset:key, 使用一个转换函数，使得散列尽可能均匀</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="第2-6节-库表拆分">第2-6节 库表拆分<a hidden class="anchor" aria-hidden="true" href="#第2-6节-库表拆分">#</a></h3>
<p>将商品SKU与活动表 解耦 =&gt; SKU&amp;Activity关联表。使得多个商品可以绑定同一个活动ID(优惠拼团活动)</p>
<img src="http://verification.longcoding.top/Fpmlq6rL3i5VfewYyQm4iFQjKvGa" alt="image-20250324185432351" style="zoom: 67%;" />
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">Market节点</span><span class="w"> </span><span class="n">判断</span><span class="w"> </span><span class="n">商品是否存在优惠活动</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ErrorNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">不存在优惠活动</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">返回优惠的试算价格</span><span class="w">    
</span></span></span></code></pre></div><p>流程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// MarketNode =&gt; multi-thread 检查是否存在商品&lt;=&gt; 活动关联表</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="n">SCSkuActivityVO</span><span class="w"> </span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">querySCSkuActivityBySCGoodsId</span><span class="p">(</span><span class="n">goodsId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="c1">// log.error(JSON.toJSONString(scSkuActivityVO));</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">queryGroupBuyActivityDiscountVOById</span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// marketNode 路由</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">errorNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">tagNode</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ErrorNode 判断上下文，抛出无拼团配置</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团商品查询试算服务-NoMarketNode userId:{} requestParameter:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;商品无拼团营销配置 {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getGoodsId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="第2-7节-人群标签节点过滤">第2-7节 人群标签节点过滤<a hidden class="anchor" aria-hidden="true" href="#第2-7节-人群标签节点过滤">#</a></h3>
<p>限制拼团的人群</p>
<img src="http://verification.longcoding.top/Fq0dYRQTWGX5WxsW8ayFT00f_f9c" alt="image-20250324214800601" style="zoom:67%;" />
<p>流程1：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">MarketNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">TagNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// TagNode 检查请求的用户是否 能看见拼团，是否参与拼团  tag_scope = {1,2} 第一位限制是否可见，第二位是否限制参与</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// redis:bitset =&gt; tag_id:{...} 存放满足条件的用户</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// 获取拼团信息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">getTagId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">visible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isVisible</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isEnable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 无特定人群信息, 人人能操作</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">tagId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 是否在人群范围内，特定人群能看</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">isWithin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">isTagCrowdRange</span><span class="p">(</span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="n">visible</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; isTagCrowdRange function</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// xiaofuge、liergou在里面</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bitSet</span><span class="p">.</span><span class="na">isExists</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="c1">// 判断用户是否存在人群中</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">bitSet</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span><span class="w">    
</span></span></span></code></pre></div><hr>
<h3 id="第2-8节--动态配置开关操作">第2-8节  动态配置开关操作<a hidden class="anchor" aria-hidden="true" href="#第2-8节--动态配置开关操作">#</a></h3>
<p>目的：如何不停车就给汽车换个轮子？</p>
<p>=&gt; 在程序运行过程中，直接动态变更某些属性配置。这些动态变更的配置包括降级和切量的开关，也包括一些功能程序的白名单用户测试。</p>
<p><strong>使用Redis作为集中化储存系统的好处，方便一处修改变量，通知所有的实例进行变更！</strong></p>
<img src="http://verification.longcoding.top/FpD9HrVow32o0uQLmC8s38KAvj-m" alt="image-20250324220542463" style="zoom:50%;" />
<p><strong>流量降级或切量</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 自定义注解</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DCCValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 动态中心控制 -- 作用于降级</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cm">     * 降级开关 0关闭 1开启
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;downgradeSwitch:0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">downgradeSwitch</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;cutRange:100&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cutRange</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCutRange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// 计算哈希码的绝对值</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// 获取最后两位</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="c1">// 判断是否在切量范围内</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cutRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">cutRange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDowngradeSwitch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="c1">// SwitchNode中 进行流量控制</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="c1">// 根据用户ID切量</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w"></span><span class="c1">// 判断是否降级</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团活动降级拦截 {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w"></span><span class="c1">// 判断是否切量</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">cutRange</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团活动切量拦截 {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>利用Redis的Topic事件发布订阅 进行 修改</strong></p>
<p>BeanPostProcessor 能够当SpringBean初始化完成后再执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// DCCValueBeanFactory implements BeanPostProcessor </span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;group_buy_market_dcc_&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">DCCValueBeanFactory</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">redissonClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;dccTopic&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">RTopic</span><span class="w"> </span><span class="nf">dccRedisTopicListener</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;初始化Redis Topic监听事件 测试连通{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// 发布订阅模式的Topic实现</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">RTopic</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getTopic</span><span class="p">(</span><span class="s">&#34;group_buy_market_dcc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="c1">// 消息类型，回调接口：Topic名称，接收的消息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="n">topic</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">charSequence</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;监听到Redis Topic： {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">charSequence</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="c1">// 获取值</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">attribute</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="c1">// 设置值 =&gt; 可以存储任意类型的值（如 String、Integer、自定义对象等），Redisson 会自动进行序列化和反序列化。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">objBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="c1">// 获取内存中的对象</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="c1">// 检查objBean是否为代理对象</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">objBean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">objBean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBeanClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">objBean</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC 节点监听，动态设置值 {} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="c1">// implements BeanPostProcessor 重写方法  -- 并在每个 bean 初始化完成后自动调用该方法。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="c1">// 注意：增加 AOP 代理后，获得类的方式要通过 AopProxyUtils.getTargetClass(bean); 不能直接 bean.class 因为代理后类的结构发生了变化，这样不能获得自己的自定义注解了</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopProxyUtils</span><span class="p">.</span><span class="na">getSingletonTarget</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span><span class="c1">// 这里判断该类是否有对应的自定义注解</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">.</span><span class="na">isAnnotationPresent</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="n">DCCValue</span><span class="w"> </span><span class="n">dccValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccValue</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;@DCCValue is not config value config case「isSwitch/isSwitch:1」&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;dcc config error &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is not null - 请配置默认值！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">            </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">                </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;初始化值 key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">        </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Controller</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;update_config&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateConfig</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC 动态配置值变更 key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">dccTopic</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;DCC 动态配置值变更失败！ key:{} value:{} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>⏱️25/3/24-23:34</p>
<h3 id="第2-9节-拼团交易营销锁单">第2-9节 拼团交易营销锁单<a hidden class="anchor" aria-hidden="true" href="#第2-9节-拼团交易营销锁单">#</a></h3>
<p>25/3/25/ 20:37</p>
<p>完整的业务流程如下：</p>
<img src="http://verification.longcoding.top/Fn3pgRYz7BPBei64sWeiiob2YqQH" alt="image-20250325203753717" style="zoom: 80%;" />
<ul>
<li>首先，团购商品下单。下单过程分为：创建流水单、锁定营销优惠（拼团、积分、卷），创建支付订单、唤起收银台支付、用户扫码支付、支付完成核销优惠等。</li>
<li>用户以拼团的方式下单，创建流水单完成后，需要与拼团系统交互，锁定营销优惠。更新流水单优惠金额和支付金额。创建订单使用最终的支付金额。</li>
<li>拼团表(目标量、完成量、锁单量)，锁单量达到目标量后，不能再参与该拼团。拼团超时，释放空闲位置让其他用户参与.</li>
</ul>
<p><em>Trade Repository  / rɪˈpɒzət(ə)ri /</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 简单实现步骤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// OutTradeNO 模拟生成 订单ID模拟生成, TeamID模拟生成. 两张表:1.记录拼团中每个用户的信息 2. 记录该拼团信息.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// ⭐仓储业务实现</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 判断是否有团  -- 一行记录存储每个拼团的信息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// 首次则创建拼团订单. 初始化表2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 否则加入其他人的团 表2 拼团人数+1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 插入该用户的拼团信息到表1; 每个用户一行</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// ⭐控制器业务实现</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 1. 检查用户信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 2. 查询用户outTradeNo是否已经使用过,幂等性</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// 3. 查询拼团是否人数已满足</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 4. 营销优惠试算</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 5. 判断用户是否能够看见拼团和参与</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 6. 拼团锁单 =&gt; 仓储业务</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// 7. 返回结果</span><span class="w">
</span></span></span></code></pre></div><h3 id="第2-10节-责任链抽象模板设计">第2-10节 责任链抽象模板设计<a hidden class="anchor" aria-hidden="true" href="#第2-10节-责任链抽象模板设计">#</a></h3>
<p>25/4/8/ 15:53</p>
<p>先前的责任链模板都是写死的。本章内容为：将每个节点的执行逻辑和链接逻辑解耦。</p>
<p>抽象</p>
<p><img alt="image-20250408155522466" loading="lazy" src="http://verification.longcoding.top/FsBb-DMhMAt2eLcNHGwKRX-tpaAG"></p>
<p>简单的单例链</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 1. IlogicChainArmory:   装配链，提供添加节点方法和获取节点</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 		next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 2. ILogicLink extends IlogicChainArmory:  并提供一个受理业务逻辑的方法</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">//		apply()</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 3. AbstractLogicLink extends ILogicLink:  封装添加节点和执行 next 下一个节点的方法</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">//      next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="c1">// 		apply()</span><span class="w">
</span></span></span></code></pre></div><p>这里是由统一的<strong>类</strong>维护责任链，也就是一份责任链。如果有2个独立的链要处理，就需要使用到非单例的类进行填充，否则会修改同一份链。也就是 <code>ILogicLink&lt;T, D, R&gt; next </code>被几份链反复调整，也就不是一个单独的链了。</p>
<p>多例-链路模式</p>
<p>多例链的设计要解耦链路和执行，把链路当做一个 LinkedList 列表处理，之后执行当做是单独的 for 循环。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 需要设计的类</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 1. Node &amp; LinkedList extends ILink</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 双向链表节点 &amp; 双向链表</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 2. BusinessLinkedList extends LinkedList</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// 从头到尾执行各个节点</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 3. ILogicHandler  -- 定义任务</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 4. LinkArmory -- 创建链表并装配节点</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// public LinkArmory(String linkName, ILogicHandler&lt;T, D, R&gt;... logicHandlers)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// private final BusinessLinkedList&lt;T, D, R&gt; logicLink;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 用法</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. 定义 RuleLogicNode extends ILogicHandler</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. new LinkArmory&lt;&gt;(&#34;demo01&#34;, ruleLogic201, ruleLogic202, ...);</span><span class="w">
</span></span></span></code></pre></div><p>具体伪代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILink</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="cm">     * 责任链名称
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="cm">     * */</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkedList</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="c1">// 头插节点</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="c1">// 尾插法</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">        </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">            </span><span class="n">l</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="n">linkFirst</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="c1">// 删除节点，注意是双向链表</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="nf">unlink</span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="c1">// x为头节点</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="n">prev</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">        </span><span class="c1">// x为末尾</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="n">next</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">        </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">element</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">	
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="c1">// 根据index，判断是前向还是后向</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">printLinkList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&#34;链表为空&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&#34;目前的列表，头节点：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">first</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; 尾节点：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; 整体：&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;，&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">                </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="第2-11节-交易规则责任链过滤">第2-11节 交易规则责任链过滤<a hidden class="anchor" aria-hidden="true" href="#第2-11节-交易规则责任链过滤">#</a></h3>
<p>2025-4-8 17:30</p>
<p><img alt="image-20250408175143439" loading="lazy" src="http://verification.longcoding.top/Ft7mFa7SSNbeW7WIK6nSRUaiACK0"></p>
<p>该章节补充：过滤拼团活动配置的规则。包括；活动的有效期、状态，以及个人参与拼团的次数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// Logic chain</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. 检查参数</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. 检查是否存在交易记录，根据外部OrderId</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 3. 判断拼团活动是否满</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 4. 营销试算 -- 给出折扣价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 5. 人群限定 -- 特定人群才能拼团</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// 6. 拼团锁单 -- 1. 修改活动表对应的信息 2. 插入一条拼团记录</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">// 6.1. 交易规则过滤  -- 检查活动时间 + 检查拼团次数  ⭐本节主要这部分</span><span class="w">
</span></span></span></code></pre></div><p>具体就是定义一些 责任链节点(拦截器)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;交易规则过滤-活动的可用性校验{} activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// 查询拼团活动</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivityEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryGroupBuyActivityEntityByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// 校验：活动状态</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActivityStatusEnumVO</span><span class="p">.</span><span class="na">EFFECTIVE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;活动的可用性校验，非生效状态 activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// 校验；活动时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">before</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStartTime</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="na">after</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getEndTime</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;活动的可用性校验，非可参与时间范围 activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0102</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setGroupBuyActivity</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// 走到下一个责任链节点</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;交易规则过滤-用户参与次数校验{} activityId{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryOrderCountByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;用户参数次数校验，已达可参与上限 activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userTakeOrderCount</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>组装责任链  &ndash; BusinessLinkedList 具体业务</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;tradeRuleFilter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nf">tradeRuleFilter</span><span class="p">(</span><span class="n">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="c1">// 组装链</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">LinkArmory</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkArmory</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;交易规则过滤链&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="c1">// 链对象</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">getLogicLink</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>LinkArmory  &ndash; 真正的抽象装配责任链</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@SafeVarargs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkArmory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">linkName</span><span class="p">,</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">logicLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">linkName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicHandler</span><span class="p">:</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">logicLink</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">logicHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLogicLink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>用法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tradeRuleFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">tradeRuleFilter</span><span class="p">.</span><span class="na">aaply</span><span class="p">(...)</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="第2-12节拼团组队结算统计">第2-12节：拼团组队结算统计<a hidden class="anchor" aria-hidden="true" href="#第2-12节拼团组队结算统计">#</a></h3>
<p>25/4/8 21:19</p>
<p><img alt="image-20250408224034286" loading="lazy" src="http://verification.longcoding.top/FibqNji0Ee0IfoFnGG-u4FK-BHvJ"></p>
<p>拼团的过程是用户在商城下单，锁定拼团优惠（也就是拼团系统里锁单的过程）。之后就是用户给这笔商品完成支付交易，交易后不会直接发货，直至拼团组队完成后才会发货。</p>
<p>那么，这里有一个流程，就是支付完成后，需要做拼团数量的统计结算。如，拼团需要3个用户一起下单，那么每完成一笔支付，就要给拼团的组队加上一笔记录。这个就是本节要实现的流程。</p>
<p>⭐⭐⭐ 所有用户完成支付后, 最后一个用户的结算触发回调事件!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">settlementMarketPayOrder</span><span class="p">(</span><span class="n">GroupBuyTeamSettlementAggregate</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">UserEntity</span><span class="w"> </span><span class="n">userEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getUserEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getGroupBuyTeamEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">TradePaySuccessEntity</span><span class="w"> </span><span class="n">tradePaySuccessEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getTradePaySuccessEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 更新拼团订单明细状态</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyOrderList</span><span class="w"> </span><span class="n">groupBuyOrderList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GroupBuyOrderList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userEntity</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setOutTradeNo</span><span class="p">(</span><span class="n">tradePaySuccessEntity</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyOrderList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c1">// 2. 更新拼团达成数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateAddCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateAddCompleteCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateAddCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="c1">// 3. 更新拼团完成状态</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTargetCount</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getCompleteCount</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// 查询拼团交易外部订单号列表</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">queryGroupBuyCompleteOrderOutTradeNoListByTeamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="c1">// 拼团完成写入回调任务记录</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">NotifyTask</span><span class="w"> </span><span class="n">notifyTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotifyTask</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">teamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyUrl</span><span class="p">(</span><span class="s">&#34;暂无&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyCount</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyStatus</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">notifyTask</span><span class="p">.</span><span class="na">setParameterJson</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;teamId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;outTradeNoList&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="p">}}));</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="n">notifyTaskDao</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>这里算是支付成功后的回调</p>
<hr>
<h3 id="第2-13节交易结算责任链过滤"><strong>第2-13节：交易结算责任链过滤</strong><a hidden class="anchor" aria-hidden="true" href="#第2-13节交易结算责任链过滤">#</a></h3>
<p>⏱️25/4/9 12:31</p>
<p><img alt="image-20250409152543493" loading="lazy" src="http://verification.longcoding.top/FpSGuYmWq4FZbzRFomQj6MM06Xvm"></p>
<p>本节诉求：</p>
<p>拼团交易结算的过程，需要一些列的规则过滤。包括；我们上一节提到的校验外部交易单的时间是否在拼团有效时间内，同时还有关于这笔外部交易单是否为有效的拼团锁单订单。另外像是 SC 渠道的有效性也需要在结算时进行校验。</p>
<p>所以，本节我们需要实现一套规则链，来处理这些业务规则。因为规则链已经被抽取为通用的模板了，那么本节使用起来会非常容易。</p>
<p>责任链流程：1. 校验渠道是否为黑名单 2. 外部订单号是否正确 3. 交易时间是否在拼团有效期内 4. 打包信息到上下文</p>
<p><em><strong>责任链包装对象</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;tradeSettlementRuleFilter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">tradeSettlementRuleFilter</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">SCRuleFilter</span><span class="w"> </span><span class="n">scRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">OutTradeNoRuleFilter</span><span class="w"> </span><span class="n">outTradeNoRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">SettableRuleFilter</span><span class="w"> </span><span class="n">settableRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">EndRuleFilter</span><span class="w"> </span><span class="n">endRuleFilter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">LinkArmory</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tradeSettlementFilter</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">LinkArmory</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;交易结算规则过滤链&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">scRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">outTradeNoRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">settableRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">endRuleFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tradeSettlementFilter</span><span class="p">.</span><span class="na">getLogicLink</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>1 SC过滤器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SCRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="c1">// 1. 打印函数流程信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;结算规则过滤-渠道黑名单校验{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 2. 校验黑名单信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">isSCBlackIntercept</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getSource</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getChannel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;{}-{} 渠道黑名单拦截&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getSource</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getChannel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0105</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>2 订单号校验过滤器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OutTradeNoRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;结算规则过滤-外部单号校验{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">MarketPayOrderEntity</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryMarketPayOrderEntityByOutTradeNo</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;不存在的外部交易单号或用户已退单，不需要做支付订单结算：{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0104</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setMarketPayOrderEntity</span><span class="p">(</span><span class="n">marketPayOrderEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>3 有效期校验器</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SettableRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;结算规则过滤-有效时间校验：{}, {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// 1. 上下文获取数据</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">MarketPayOrderEntity</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getMarketPayOrderEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// 2. 查询拼团对象</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryGroupBuyTeamByTeamId</span><span class="p">(</span><span class="n">marketPayOrderEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// 3. 外部交易时间 - 支付时间需要在拼团有效时间内完成</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeTime</span><span class="p">().</span><span class="na">after</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidEndTime</span><span class="p">())){</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="c1">// 4. 判断，外部交易时间是否小于拼团结束时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;订单交易时间不在拼团有效时间范围内&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0106</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// 5. 设置上下文</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setGroupBuyTeamEntity</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>4 打包节点</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EndRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;结算规则过滤-结束节点{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyTeamEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">teamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">completeCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getCompleteCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">targetCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTargetCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">validStartTime</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidStartTime</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">validEndTime</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidEndTime</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">lockCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getLockCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getStatus</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>5 SC来源渠道黑名单动态配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;scBlacklist:s02c02&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 默认黑名单渠道</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">scBlacklist</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">isSCBlackIntercept</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">scBlacklist</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">source</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// Http请求key=scBlacklist&amp;value=s02c02;s03c03</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; Redis (scBlacklist) =&gt; scBlacklist,s02c02;s03c03 </span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="第2-14节拼团回调通知任务"><strong>第2-14节：拼团回调通知任务</strong><a hidden class="anchor" aria-hidden="true" href="#第2-14节拼团回调通知任务">#</a></h3>
<p>⏱️25/4/9 15:32</p>
<p>拼团组队交易结算完结后，实现一个回调通知的任务处理。告知另外的微服务系统可以进行后续的流程了。</p>
<p>RPC、MQ，这一类的都是需要有一个公用的注册中心，它的技术架构比较适合于公司内部的统一系统使用。如果是有和外部其他系统的对接，通常我们会使用 HTTP 这样统一标准协议的接口进行使用。</p>
<p>注意：微信支付，支付宝支付，也是在完成支付后，做的这样的回调处理。</p>
<p><img alt="image-20250409153440408" loading="lazy" src="http://verification.longcoding.top/FoxjZpAuwMdJMA1Pw0ySfe_zrWpx"></p>
<p>💡<strong>流程逻辑 1：锁单</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. 检查锁单请求信息 - 请求参数是否为Null or 空串</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 2. 检查outTradeNo是否重复锁单 - 检查检查outTradeNo是否重复锁单是否存在</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 3. 拼团是否能够加入 - 判断拼团当前人数小于目标人数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// 4. 营销优惠试算</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 	  4.1. RootNode =&gt; SwitchRoot =&gt; MarketNode =&gt; TagNode =&gt; EndNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">//                                              =&gt; ErrorNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.1 RootNode检查信息</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.2 SwitchRoot 降级和限流</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.3 MarketNode 1:异步查询商品信息+活动信息 2:进行折扣验算(根据Map拿到对应的折扣对象 - 每个折扣对象实现同一接口)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.4-1 TagNode：根据bitset，检查用户Id是否有资格参与or可见该折扣活动</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">//		4.1.4-2 ErrorNode：无折扣活动返回</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.5 EndNode 组装试算结果</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 5. 根据试算结果判断是否可见和可参与</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// 6. 进行锁单</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">//	  6.1. 交易规则检查 - 校验活动状态+活动时间 &amp;&amp; 校验参与次数  -责任链</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">//      LinkArmory(BusinessLinkedList:ActivityUsabilityRuleFilter+UserTakeLimitRuleFilter)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">//		6.1.1 ActivityUsabilityRuleFilter: 检查活动状态和时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">//		6.1.2 UserTakeLimitRuleFilter:     检查用户参与次数</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="c1">//    6.2. 判断是否有团 - 生成拼团订单 or 加入别人的订单  =&gt; 插入or修改记录 GroupBuyOrder</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="c1">//    6.3. 生成订单明细  =&gt; 插入记录到GroupBuyOrderList</span><span class="w">
</span></span></span></code></pre></div><p><strong>💡流程逻辑 2：结算</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. 检查拼团信息 - 结算规则</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 	  1.1 检查 渠道合法性=&gt;外部订单合法性=&gt;拼团时间合法性=&gt;包装检查结果</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">//    		1.1.1 SCRuleFilter: 检查source和channel是否在黑名单中，@DCCValue(&#34;scBlacklist:s02c02&#34;), 可动态配置</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">//   		1.1.2 OutTradeNoRuleFilter：检查OutTradeNo是否合法，是否GroupBuyOrderList存在初始锁单的拼团订单 </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">//			(这里，外部进行了支付，但是系统还没修改结算状态呢)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// 			1.1.3 SettableRuleFilter：检查订单交易时间是否在拼团有效时间内</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 			1.1.4 EndRuleFilter：包装结果</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 2. 进行拼团结算</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 	  2.1 更新拼团订单明细 =&gt; GroupBuyOrderList对应用户的完成状态</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">//    2.2 更新拼团达成数量 =&gt; GroupBuyOrder对应的用户完成支付数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">//    2.3 更新拼团完成状态 =&gt; 最后一个人支付完成触发 =&gt; GroupBuyOrder拼团信息状态 =&gt; 写入回调任务记录(包装TeamId+所有的外部订单ID)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 3. 组队回调处理 - 这里显示的执行，使得实时性比较好，只有最后一个人完成才会执行成功，不过有定时任务进行兜底</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 	  3.1 发送Http远程调用，将(TeamId+所有的外部订单ID)发送给第三方服务，通知发货or其他</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">//    3.2 定时任务：查询所有初始状态和重试状态的 通知任务</span><span class="w">
</span></span></span></code></pre></div><p>🏷️<strong>本章节完成 3 触发回调部分</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// 指定触发回调通知任务  - 实时性</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团交易-执行结算通知回调，指定 teamId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntityList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryUnExecutedNotifyTaskList</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">execSettlementNotifyJob</span><span class="p">(</span><span class="n">notifyTaskEntityList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="c1">// 辅助定时扫描，进行通知 - 兜底</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团交易-执行结算通知任务&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// 查询未执行任务</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryUnExecutedNotifyTaskList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">execSettlementNotifyJob</span><span class="p">(</span><span class="n">notifyTaskEntities</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w"></span><span class="c1">// 公用通知函数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">successCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">errorCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskEntity</span><span class="w"> </span><span class="n">notifyTask</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="c1">// 回调处理</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="p">.</span><span class="na">groupBuyNotify</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusSuccess</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">                </span><span class="n">successCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusError</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">                </span><span class="n">errorCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusRetry</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">                </span><span class="n">retryCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resultMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;waitCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;successCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">successCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;errorCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">errorCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;retryCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">resultMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="c1">// 远程调用</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">groupBuyNotify</span><span class="p">(</span><span class="n">NotifyTaskEntity</span><span class="w"> </span><span class="n">notifyTask</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">    </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">lockKey</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">        </span><span class="c1">// 拼团服务器部署在多台应用服务器上，多任务执行，避免任务被多次执行，锁的粒度 xxx:teamId</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&#34;暂无&#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="err">⭐</span><span class="n">groupBuyNotifyService</span><span class="p">.</span><span class="na">groupBuyNotify</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getParameterJson</span><span class="p">());</span><span class="err">⭐</span><span class="w"> </span><span class="c1">// 这里进行远程调用</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isLocked</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">                    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">NULL</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">NULL</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w"></span><span class="c1">// OKHttp发送请求</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">groupBuyNotify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">notifyRequestDTOJSON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="c1">// 1. 构建参数</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">MediaType</span><span class="w"> </span><span class="n">mediaType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">RequestBody</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestBody</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">mediaType</span><span class="p">,</span><span class="w"> </span><span class="n">notifyRequestDTOJSON</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Request</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">url</span><span class="p">(</span><span class="n">apiUrl</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&#34;content-type&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;application/json&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="c1">// 2. 调用接口</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">        </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">okHttpClient</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">execute</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="c1">// 3. 返回结果</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;拼团回调 HTTP 接口服务异常 {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">HTTP_EXCEPTION</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="微信扫描登录流程"><strong>微信扫描登录流程</strong><a hidden class="anchor" aria-hidden="true" href="#微信扫描登录流程">#</a></h4>
<p><img alt="image-20250418182112507" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418182112507.png"></p>
<p><strong>access_token是公众号</strong>的全局唯一接口调用凭据; 公众号和小程序均可以使用AppID和AppSecret调用本接口来获取access_token。</p>
<ol>
<li>用户点击Web登录  =&gt; 商户后端 =&gt;  获取公众号登录凭证(请求微信二维码接口，获取对应的ticket，用于获取微信公众号的二维码)</li>
<li>然后，前端根据ticket去微信系统获取对应的二维码，进行登录</li>
<li>登录成功后，微信会回调公众号对应的回调接口，这时候，后端可以保存用户信息，比如&lt;ticket， openid&gt; （openid标识用户）</li>
<li>前端再拿ticket进行登录校验，登录成功后，返回Token令牌就好了。</li>
</ol>
<p>⭐</p>
<ul>
<li>需要实现请求二维码登录凭证的Api接口；</li>
<li>需要实现微信登录回调的Api接口，保存用户登录信息；</li>
<li>需要实现用户登录校验的接口，生成Token令牌，后续请求用这个。</li>
</ul>
<h4 id="微信支付流程">微信支付流程<a hidden class="anchor" aria-hidden="true" href="#微信支付流程">#</a></h4>
<p><img alt="image-20250418181032363" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181032363.png"></p>
<ol>
<li>请求下单接口 =&gt; 后端创建订单(创建) =&gt; 请求微信支付系统(<strong>创建支付订单</strong>),后端订单(<strong>待付款</strong>)；最后返回拉起支付的参数；</li>
</ol>
<p><img alt="image-20250418181230663" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181230663.png"></p>
<ol start="2">
<li>小程序拉起微信收银台</li>
</ol>
<p><img alt="image-20250418181257254" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181257254.png"></p>
<ol start="3">
<li>回调小程序支付状态，小程序查询商户后端订单状态 =&gt; 后端查询微信支付系统 =&gt; &hellip; =&gt; 返回支付状态</li>
<li>用户支付成功，会回调通知商户后端。⭐需要实现回调的接口，保持支付通知(改后端订单状态: <strong>已支付</strong>)</li>
<li>未收到回调通知，需要商户后端主动查询微信支付的查询接口。</li>
<li>超时 =&gt; 商户后端主动调用微信关单接口 (订单状态：<strong>支付失败|超时</strong>)</li>
<li>退款 =&gt; 商户后端请求微信支付退款接口 (订单状态：<strong>退款</strong>)</li>
</ol>
<p>⭐</p>
<p>需要实现的接口：</p>
<ul>
<li>商户后端创建初始订单，并请求微信支付生成支付订单的Api接口；(检查订单幂等性)</li>
<li>接收微信支付回调的Api接口，修改订单支付状态；</li>
<li>主动查询订单支付状态的接口，调用微信支付的查询接口。</li>
<li>超时 =&gt; 商户后端主动调用微信关单接口 (订单状态：<strong>支付失败|超时</strong>)的Api接口</li>
<li>退款 =&gt; 商户后端请求微信支付退款接口 (订单状态：<strong>退款</strong>)的Api接口</li>
</ul>
<hr>
<h3 id="第2-15节根据ui展示封装接口">第2-15节：根据UI展示封装接口<a hidden class="anchor" aria-hidden="true" href="#第2-15节根据ui展示封装接口">#</a></h3>
<img src="http://verification.longcoding.top/FkdkTAEsaBL2GhNuwdj2tG7ffvcw" alt="image-20250409202305147" style="zoom:60%;" />
<img src="http://verification.longcoding.top/Fme4e2W89LK_zNSWZM_cgIPgFi5Q" alt="image-20250409202122844" style="zoom:50%;" />
<ul>
<li>
<p>紫色圈：拼团的统计信息；</p>
</li>
<li>
<p>灰色圈：商品信息；</p>
</li>
<li>
<p>红色圈：参与拼团，随机挑选几个团；</p>
</li>
<li>
<p>绿色圈：参与拼团；单独开始一个新的团，还是参与其他人的团</p>
</li>
<li>
<p>黄色圈：拼团结算。</p>
</li>
</ul>
<p><strong>ResponseDTO</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GoodsMarketResponseDTO</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Goods</span><span class="w"> </span><span class="n">goods</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Team</span><span class="o">&gt;</span><span class="w"> </span><span class="n">teamList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">TeamStatistic</span><span class="w"> </span><span class="n">teamStatistic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     * 商品信息
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Goods</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// 商品ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// 原始价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// 折扣金额</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="c1">// 支付价格</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">payPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cm">     * 组队信息
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Team</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="c1">// 用户ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="c1">// 拼单组队ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="c1">// 活动ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">activityId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="c1">// 目标数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">targetCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">        </span><span class="c1">// 完成数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">completeCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="c1">// 锁单数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">lockCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="c1">// 拼团开始时间 - 参与拼团时间</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">        </span><span class="c1">// 拼团结束时间 - 拼团有效时长</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="c1">// 倒计时(字符串) validEndTime - validStartTime</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">validTimeCountdown</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">        </span><span class="cm">/** 外部交易单号-确保外部调用唯一幂等 */</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outTradeNo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">differenceDateTime2Str</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validStartTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">validEndTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;无效的时间&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">diffInMilliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">.</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">.</span><span class="na">getTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;已结束&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">60</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toMinutes</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">60</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toHours</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">24</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toDays</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%02d:%02d:%02d&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">hours</span><span class="p">,</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="n">seconds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="cm">     * 组队统计
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">83</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">84</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">86</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">87</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TeamStatistic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">88</span><span class="cl"><span class="w">        </span><span class="c1">// 开团队伍数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">89</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">90</span><span class="cl"><span class="w">        </span><span class="c1">// 成团队伍数量</span><span class="w">
</span></span></span><span class="line"><span class="ln">91</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamCompleteCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">92</span><span class="cl"><span class="w">        </span><span class="c1">// 参团人数总量 - 一个商品的总参团人数</span><span class="w">
</span></span></span><span class="line"><span class="ln">93</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamUserCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">94</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">95</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">96</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 增删改查</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 注意：Team的查询</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 1. 先查自己的拼团</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// 2. 查其他人的拼团。对应活动，非当前用户，状态为可加入拼团，时间有效，队伍in(对应活动，且锁单人数小于目标人数)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">UserGroupBuyOrderDetailEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryInProgressUserGroupBuyOrderDetailListByRandom</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">activityId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">randomCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 根据用户ID、活动ID、查询非当前用户参与的拼团队伍</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyOrderList</span><span class="w"> </span><span class="n">buyOrderListReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GroupBuyOrderList</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">activityId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">buyOrderListReq</span><span class="p">.</span><span class="na">setCount</span><span class="p">(</span><span class="n">randomCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 查询两倍的量，再随机取一半</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 1. ==ActivityId; 2. !=userId 3; status == 0 or 1; 4. endTime &gt; now(); 5. teamId in (select teamId from group_buy_order where status = 0 and activity = #{activity})</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GroupBuyOrderList</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">queryInProgressUserGroupBuyOrderDetailListByRandom</span><span class="p">(</span><span class="n">buyOrderListReq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// 随机选 randomCount 条</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">randomCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Collections</span><span class="p">.</span><span class="na">shuffle</span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">subList</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">randomCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="c1">// 2. 过滤队伍获取 TeamId</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">teamIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">GroupBuyOrderList</span><span class="p">::</span><span class="n">getTeamId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">teamId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">teamId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">teamId</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="c1">// 3. 查询队伍明细，组装Map结构</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GroupBuyOrder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">queryGroupBuyProgressByTeamIds</span><span class="p">(</span><span class="n">teamIds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrders</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">GroupBuyOrder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrderMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toMap</span><span class="p">(</span><span class="n">GroupBuyOrder</span><span class="p">::</span><span class="n">getTeamId</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="c1">// 4. 转换数据</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserGroupBuyOrderDetailEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userGroupBuyOrderDetailEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"> 	</span><span class="c1">// ... 根据 groupBuyOrders 和 groupBuyOrderLists组装结果</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">userGroupBuyOrderDetailEntities</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 锁单 接口</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="err">⬇</span><span class="n">️</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// outTradeNo - 调用第三方支付生成</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="err">⬇</span><span class="n">️</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 结算 接口</span><span class="w">
</span></span></span></code></pre></div><img src="http://verification.longcoding.top/FkDcIvtAlVhuiv8qwR_H_GNQcGtm" alt="image-20250410001830020" style="zoom:50%;" />
<hr>
<h3 id="第2-16节-独占锁和无锁化">第2-16节 独占锁和无锁化<a hidden class="anchor" aria-hidden="true" href="#第2-16节-独占锁和无锁化">#</a></h3>
<p>一个库存一个锁，最小化锁的粒度，使用occupyCount +  recoveryCount 判断库存。因为之前的线程抢占了库存，但是执行失败，需要恢复被抢占的库存量。</p>
<p><img alt="image-20250418205449507" loading="lazy" src="c:\\Users\\韦龙\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418205449507.png"></p>
<p>**独占锁：**多个服务均有定时任务，仅一个服务执行即可。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 0 * * ?&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">exec</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="s">&#34;group_buy_market_notify_job_exec&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// 等待时间(若被占用等待3秒)，锁的过期时间(0表示需要手动释放)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isLocked</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tradeSettlementOrderService</span><span class="p">.</span><span class="na">execSettlementNotifyJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;定时任务，回调通知拼团完结任务 result:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">result</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;定时任务，回调通知拼团完结任务失败&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isLocked</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>乐观锁：</strong></p>
<p>将库存的隔离进行分段化，一个库存表示一个锁</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 拼团人数检查-是否已满</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 1. teamId 为空，则为首次开团，不做拼团组队目标量库存限制</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">teamId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TradeLockRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">userTakeOrderCount</span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getUserTakeOrderCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 2. 抢占库存；通过抢占 Redis 缓存库存，来降低对数据库的操作压力。</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// 上下文信息</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTarget</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getValidTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">teamStockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">generateTeamStockKey</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">generateRecoveryTeamStockKey</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// 抢占库存</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">occupyTeamStock</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">validTime</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>抢占库存</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">occupyTeamStock</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="c1">// 失败恢复量</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getAtomicLong</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">recoveryCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// 1. incr 得到值，与总量和恢复量做对比。恢复量为系统失败时候记录的量。</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// 2. 从有组队量开始，相当于已经有了一个占用量，所以要 +1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">occupy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">incr</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">occupy</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">recoveryCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">redisService</span><span class="p">.</span><span class="na">setAtomicLong</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 1. 给每个产生的值加锁为兜底设计，虽然incr操作是原子的，基本不会产生一样的值。但在实际生产中，遇到过集群的运维配置问题，以及业务运营配置数据问题，导致incr得到的值相同。</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c1">// 2. validTime + 60分钟，是一个延后时间的设计，让数据保留时间稍微长一些，便于排查问题。</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">teamStockKey</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">UNDERLINE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">occupy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">setNx</span><span class="p">(</span><span class="n">lockKey</span><span class="p">,</span><span class="w"> </span><span class="n">validTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;组队库存加锁失败 {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>恢复库存 &lt;= 业务执行失败，需要进行库存的恢复！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recoveryTeamStock</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="c1">// 首次组队拼团，是没有 teamId 的，所以不需要这个做处理。</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">redisService</span><span class="p">.</span><span class="na">incr</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://longcoding.top/tags/projects/">Projects</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://longcoding.top/posts/jobs/mq/">
    <span class="title">« Prev</span>
    <br>
    <span>消息队列面试题</span>
  </a>
  <a class="next" href="http://longcoding.top/posts/learning/common_commands/">
    <span class="title">Next »</span>
    <br>
    <span>Linux&amp;Docker&amp;Shell命令</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://longcoding.top/">LongCoding&#39;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
