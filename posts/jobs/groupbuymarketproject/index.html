<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢ | LongCoding&#39;s Blog</title>
<meta name="keywords" content="Projects">
<meta name="description" content="Grouptradingproject">
<meta name="author" content="ğŸ‘¨ğŸ»â€ğŸ“ LongWei">
<link rel="canonical" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="http://longcoding.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://longcoding.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://longcoding.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://longcoding.top/apple-touch-icon.png">
<link rel="mask-icon" href="http://longcoding.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://longcoding.top/posts/jobs/groupbuymarketproject/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://longcoding.top/posts/jobs/groupbuymarketproject/">
  <meta property="og:site_name" content="LongCoding&#39;s Blog">
  <meta property="og:title" content="æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢">
  <meta property="og:description" content="Grouptradingproject">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:modified_time" content="2025-03-23T19:36:21+08:00">
    <meta property="article:tag" content="Projects">
      <meta property="og:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://longcoding.top/papermod-cover.png">
<meta name="twitter:title" content="æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢">
<meta name="twitter:description" content="Grouptradingproject">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://longcoding.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢",
      "item": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢",
  "name": "æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢",
  "description": "Grouptradingproject",
  "keywords": [
    "Projects"
  ],
  "articleBody": "æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ **é¡¹ç›®èƒŒæ™¯ï¼š**ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚\nç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡ ä¸šåŠ¡æµç¨‹ï¼š\nè¿è¥è§’åº¦ï¼š 1. ç»™å“ªäº›å•†å“é…ç½®æ‹¼å•ï¼›2. æ‹¼å›¢å•†å“æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼šæŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚ ç”¨æˆ·è§’åº¦ï¼š 1. å‚ä¸æ‹¼å›¢ï¼Œé¦–æ¬¡å‘èµ·orå‚ä¸ç°æœ‰ï¼Œæ‹¼å•å®Œæˆå›è°ƒé€šçŸ¥ã€‚ åº“è¡¨è®¾è®¡ï¼š 1. äººç¾¤è®¾è®¡ï¼Œå°†æ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥ç‰¹å®šRedisè®°å½•ä¸­ã€‚ æ‹¼å›¢æ´»åŠ¨ï¼ŒæŠ˜æ‰£çš„å¤šç§è¿­ä»£ã€‚ åº“è¡¨è®¾è®¡ï¼š\næ‹¼å›¢é…ç½®è¡¨ï¼š\næ‹¼å›¢æ´»åŠ¨è¡¨ï¼šè®¾å®šäº†æ‹¼å›¢çš„æˆå›¢è§„åˆ™ï¼Œäººç¾¤æ ‡ç­¾çš„ä½¿ç”¨å¯ä»¥é™å®šå“ªäº›äººå¯è§ï¼Œå“ªäº›äººå¯å‚ä¸ã€‚ æŠ˜æ‰£é…ç½®è¡¨ï¼šæ‹†åˆ†å‡ºæ‹¼å›¢ä¼˜æƒ åˆ°ä¸€ä¸ªæ–°çš„è¡¨è¿›è¡Œå¤šæ¡é…ç½®ã€‚å¦‚æœæŠ˜æ‰£è¿˜æœ‰æ›´å¤šçš„å¤æ‚è§„åˆ™ï¼Œåˆ™å¯ä»¥é…ç½®æ–°çš„æŠ˜æ‰£è§„åˆ™è¡¨è¿›è¡Œå¤„ç†ã€‚ äººç¾¤æ ‡ç­¾è¡¨ï¼šä¸“é—¨æ¥åšäººç¾¤è®¾è®¡è®°å½•çš„ï¼Œè¿™3å¼ è¡¨å°±æ˜¯ä¸ºäº†æŠŠç¬¦åˆè§„åˆ™çš„äººç¾¤IDï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·IDï¼Œå…¨éƒ¨è·‘ä»»åŠ¡åˆ°ä¸€ä¸ªè®°å½•ä¸‹è¿›è¡Œä½¿ç”¨ã€‚ æ¯”å¦‚é»‘ç«ç‘°äººç¾¤ã€é«˜å‡€å€¼äººç¾¤ã€æ‹¼å›¢å±¥çº¦ç‡90%ä»¥ä¸Šçš„äººç¾¤ç­‰ã€‚ å‚ä¸æ‹¼å›¢è¡¨ï¼š\næ‹¼å›¢è´¦æˆ·è¡¨ï¼šè®°å½•ç”¨æˆ·çš„æ‹¼å›¢å‚ä¸æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†é™åˆ¶ç”¨æˆ·çš„å‚ä¸æ‹¼å›¢æ¬¡æ•°ï¼Œå¦å¤–æ˜¯ä¸ºäº†äººç¾¤æ ‡ç­¾ä»»åŠ¡ç»Ÿè®¡æ•°æ®ã€‚ ç”¨æˆ·æ‹¼å•è¡¨ï¼šå½“æœ‰ç”¨æˆ·å‘èµ·é¦–æ¬¡æ‹¼å•çš„æ—¶å€™ï¼Œäº§ç”Ÿæ‹¼å•idï¼Œå¹¶è®°å½•æ‰€éœ€æˆå›¢çš„æ‹¼å•è®°å½•ï¼Œå¦å¤–æ˜¯å†™ä¸Šæ‹¼å›¢çš„çŠ¶æ€ã€å”¯ä¸€ç´¢å¼•ã€å›è°ƒæ¥å£ç­‰ã€‚è¿™æ ·æ‹¼å›¢å®Œæˆå°±å¯ä»¥å›è°ƒå¯¹æ¥çš„å¹³å°ï¼Œé€šçŸ¥å®Œæˆäº†ã€‚ã€å¾®ä¿¡æ”¯ä»˜ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡ï¼Œå›è°ƒæ”¯ä»˜ç»“æœï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿å¹³å°åŒ–å¯¹æ¥ã€‘å½“å†æœ‰ç”¨æˆ·å‚ä¸åï¼Œåˆ™å†™å…¥ç”¨æˆ·æ‹¼å•æ˜ç»†è¡¨ã€‚ç›´è‡³è¾¾æˆæ‹¼å›¢ å›è°ƒä»»åŠ¡è¡¨ï¼šå½“æ‹¼å›¢å®Œæˆåï¼Œè¦åšå›è°ƒå¤„ç†ã€‚ä½†å¯èƒ½ä¼šæœ‰å¤±è´¥ï¼Œæ‰€ä»¥åŠ å…¥ä»»åŠ¡çš„æ–¹å¼è¿›è¡Œè¡¥å¿ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦å¯¹æ¥çš„å¹³å°ï¼Œè‡ªå·±æŸ¥è¯¢æ‹¼å›¢ç»“æœã€‚ ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡ è¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼šåº“è¡¨è®¾è®¡ã€ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚\nç”¨ä¾‹å›¾ï¼šç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼› æµç¨‹å›¾ï¼šåŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼› æ—¶åºå›¾ï¼šå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³» ç³»ç»Ÿæ¶æ„ï¼š\nMVCæ¶æ„\nDDDæ¶æ„\nç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡ å¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§\n=\u003e è®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚\næ¨¡å‹è®¾è®¡\né“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜\né¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ æ¶µç›–ï¼šStrategyMapper, StrategyHandler /ËˆstrÃ¦tÉ™dÊ’i/ã€AbstractStrategyRouterã€‚ é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚ ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚ ç¼–ç å®ç°\né¡¹ç›®å·¥ç¨‹çš„Typesæ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿\n1.1 ç­–ç•¥æ˜ å°„å™¨\n1public interface StrategyMapper\u003cT, D, R\u003e { 2 3 /** 4 * è·å–å¾…æ‰§è¡Œç­–ç•¥ 5 * 6 * @param requestParameter å…¥å‚ 7 * @param dynamicContext ä¸Šä¸‹æ–‡ 8 * @return è¿”å‚ 9 * @throws Exception å¼‚å¸¸ 10 */ 11 StrategyHandler\u003cT, D, R\u003e get(T requestParameter, D dynamicContext) throws Exception; 12 13} ç”¨äºè·å–æ¯ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œè´£ä»»é“¾åŠ å¼ºç‰ˆ Tï¼ŒDï¼ŒRï¼šå…¥å‚ï¼Œä¸Šä¸‹æ–‡ï¼Œåå‚ 1.2 ç­–ç•¥å—ç†å™¨\n1public interface StrategyHandler\u003cT, D, R\u003e { 2 3 StrategyHandler DEFAULT = (T, D) -\u003e null; 4 5 R apply(T requestParameter, D dynamicContext) throws Exception; 6 7} æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œåˆ©ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ç»™åé¢æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚ 1.3 ç­–ç•¥è·¯ç”±å™¨\n1public abstract class AbstractStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 @Getter 4 @Setter 5 protected StrategyHandler\u003cT, D, R\u003e defaultStrategyHandler = StrategyHandler.DEFAULT; 6\t7 // ä¼ªä»£ç  8 public R router(T, D) throws Exception { 9 StrategyHandler strategyHandler = get(T, D); 10 if(null != strategyHandler) return strategyHandler.apply(T, D); 11 return defaultStrategyHandler.apply(T, D); 12 } 13 14} æ‰§è¡Œå…·ä½“èŠ‚ç‚¹ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¼ é€’åˆ°é»˜è®¤èŠ‚ç‚¹ä¸­ ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½ é¦–é¡µè¯•ç®—\nå½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚\n1. Modelå®šä¹‰å¯¹è±¡ï¼› 2. æœåŠ¡åŠŸèƒ½å®ç°ï¼Œtrialè¯•ç®—æ¨¡å—ï¼›3. ä¸šåŠ¡æµè½¬çš„åŠŸèƒ½èŠ‚ç‚¹\næ¨¡å‹é“¾è·¯\n1IIndexGroupBuyMarketService 2=\u003e RootNode 3\t=\u003e multiThread[å‰ç½®å¤„ç†|æ£€æŸ¥ä¿¡æ¯] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 4=\u003e SwitchNode 5\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 6=\u003e MarketNode 7\t=\u003e multiThread[â­å‰ç½®å¤„ç†â­æ‹¼å•è¯•ç®—] =\u003e doApply[ä¸šåŠ¡+è·¯ç”±] 8=\u003e EndNode 9\t=\u003e multiThread[å‰ç½®å¤„ç†] =\u003e doApply[ä¸šåŠ¡|æ„å»ºç»“æœ] è·¯ç”±ç­–ç•¥æ¨¡æ¿[èŠ‚ç‚¹æ¨¡æ¿]\n1public abstract class AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e implements StrategyMapper\u003cT, D, R\u003e, StrategyHandler\u003cT, D, R\u003e { 2 3 public R router(T requestParameter, D dynamicContext) throws Exception {} 4 @Override 5 public R apply(T requestParameter, D dynamicContext) throws Exception { 6 multiThread() // å‰ç½®å¤„ç† 7 return doApply() // ä¸šåŠ¡é€»è¾‘ 8 } 9 protected abstract void multiThread(T requestParameter, D dynamicContext) throws; 10 protected abstract R doApply(T requestParameter, D dynamicContext) throws; 1public abstract class AbstractGroupBuyMarketSupport\u003cT, D, R\u003e extends AbstractMultiThreadStrategyRouter\u003cT, D, R\u003e { 2 3 protected long timeout = 500; 4 @Resource 5 protected IActivityRepository repository; 6 7 @Override 8 protected void multiThread(T, D) { 9 // ç©ºæ–¹æ³•ï¼Œéœ€è¦å®ç°çš„è¯ï¼Œè®©å­ç±»é‡å†™ 10 } 11 12} å…·ä½“èŠ‚ç‚¹å®ä¾‹\nå·¥ä½œæµï¼šå‰ç½®å¤„ç† =\u003e ä¸šåŠ¡é€»è¾‘ =\u003e è·¯ç”±\n1public class RootNode extends AbstractGroupBuyMarketSupport\u003cMarketProductEntity, DynamicContext, TrialBalanceEntity\u003e { 2 3 @Resource 4 private SwitchNode nextNode; 5 6 @Override 7 protected TrialBalanceEntity doApply(T, D, R) throws Exception { 8 log.info(\"ä¸šåŠ¡å¤„ç†\") 9 return router(requestParameter, dynamicContext); // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ 10 } 11 12 @Override 13 public StrategyHandler\u003cT, D, R\u003e get(T, D, R) { 14 return switchNode; 15 } 16} â­â­â­\nå¼‚æ­¥æ•°æ®åŠ è½½\n1// å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½® 2XXXThreadTask taskA = new XXXThreadTask(...); 3FutureTask\u003cXXX\u003e xxxFutureTaskA = new FutureTask\u003c\u003e(XXXThreadTask); 4threadPoolExecutor.execute(xxxFutureTask); 5 6// å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ - 7XXXThreadTask taskB = new XXXThreadTask(...); 8FutureTask\u003cXXX\u003e xxxFutureTaskB = new FutureTask\u003c\u003e(XXXThreadTask); 9threadPoolExecutor.execute(xxxFutureTask); 10 11// å†™å…¥ä¸Šä¸‹æ–‡ï¼Œ å‰ç½®æŸ¥è¯¢æ•°æ® 12dynamicContext.setXXXA(xxxFutureTaskA.get(TIMEOUT, TimeUnit.MINUTES)); // é˜»å¡æŒ‡å®šæ—¶é—´ 13dynamicContext.setXXXB(xxxFutureTaskB.get(TIMEOUT, TimeUnit.MINUTES)); ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®— ä¸åŒä¼˜æƒ æ¨¡å¼ =\u003e ç­–ç•¥æ¨¡å¼å®ç°\nå®šä¹‰æ¥å£\n1public interface IDiscountCalculateService { 2 BigDecimal calculate(...); 3} æŠ½è±¡æ¨¡æ¿\n1public abstract class AbstractDiscountCalculateService implements IDiscountCalculateService { 2 3 @Override 4 public BigDecimal calculate(...) { 5 // 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤ 6 if (IsFilter){ 7 boolean isCrowdRange = filterTagId(userId, groupBuyDiscount.getTagId()); 8 if (!isCrowdRange) return originalPrice; 9 } 10 // 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®— 11 return doCalculate(originalPrice, groupBuyDiscount); 12 } 13 14 // äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ  15 private boolean filterTagId(String userId, String tagId) { 16 // todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ† 17 return true; 18 } 19\t20 // å…·ä½“è®¡ç®—å‡½æ•° 21 protected abstract BigDecimal doCalculate(...); 22 23} æŠ˜æ‰£æ–¹æ³•\n1@Slf4j 2@Service(\"MJ\") // æ»¡å‡ä¼˜æƒ  3public class MJCalculateService extends AbstractDiscountCalculateService { 4 5 @Override 6 public BigDecimal doCalculate(BigDecimal originalPrice, GroupBuyActivityDiscountVO.GroupBuyDiscount groupBuyDiscount) { 7 log.info(\"ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}\", groupBuyDiscount.getDiscountType().getCode()); 8 9 // æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ 10 String marketExpr = groupBuyDiscount.getMarketExpr(); 11 String[] split = marketExpr.split(Constants.SPLIT); 12 BigDecimal x = new BigDecimal(split[0].trim()); 13 BigDecimal y = new BigDecimal(split[1].trim()); 14 15 // ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»· 16 if (originalPrice.compareTo(x) \u003c 0) { 17 return originalPrice; 18 } 19 20 // æŠ˜æ‰£ä»·æ ¼ 21 BigDecimal deductionPrice = originalPrice.subtract(y); 22 23 // åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’± 24 if (deductionPrice.compareTo(BigDecimal.ZERO) \u003c= 0) { 25 return new BigDecimal(\"0.01\"); 26 } 27 28 return deductionPrice; 29 } 30 31} è¥é”€è°ƒç”¨\n1// MarketNode 2 3public TrialBalanceEntity doApply(T, D) throws Exception { 4 log.info(\"æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡\"); 5 6 dynamicContext.getGroupBuyActivityDiscountVO(); 7 groupBuyActivityDiscountVO.getGroupBuyDiscount(); 8 9 dynamicContext.getSkuVO(); 10 11 // å…·ä½“çš„ç­–ç•¥ï¼Œä¼˜æƒ æ¨¡å¼ 12 IDiscountCalculateService discountCalculateService = discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan()); 13 if (null == discountCalculateService) { 14 log.info(\"...\", JSON.toString(discountCalculateServiceMap.keys())) 15 throw ... 16 } 17 18 // æŠ˜æ‰£ä»·æ ¼ 19 BigDecimal deductionPrice = discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount); 20 dynamicContext.setDeductionPrice(deductionPrice); 21 22 return router(requestParameter, dynamicContext); 23} å­¦ä¹ ç‚¹ï¼š\n1@Service(\"Key\") 2XXX implement IDiscountCalculateService {} 3 4@Resource // â­å…ˆæŒ‰åç§°ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹æ³¨å…¥ 5private Map\u003cString, IDiscountCalculateService\u003e discountCalculateServiceMap; ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›† ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœ\näººç¾¤æ ‡ç­¾æ˜¯æ ¹æ®ç”¨æˆ·ä¸šåŠ¡è¡Œä¸ºé‡‡é›†çš„\næ•°æ®åº“è¡¨ï¼š\ncrowd_tags ï¼šç»Ÿè®¡åŠŸèƒ½ï¼›\ncrowd_tags_detailï¼štag_id =\u003e user_id; å…·ä½“æ¯ä¸ªäººç¾¤éƒ½æœ‰è°ï¼›\ncrowd_tags_jobï¼štag_id =\u003e batch_id, tag_relu:æ¶ˆè´¹è§„åˆ™;\næµç¨‹ï¼š\næ ¹æ®tag_id, batch_id æŸ¥è¯¢crowd_tags_jobå¾—åˆ°å¯¹åº”æ‰¹æ¬¡ä»»åŠ¡ é‡‡é›†ç”¨æˆ·æ•°æ® æ•°æ®å†™å…¥è®°å½• // æš‚å­˜ æ•°æ®å†™å…¥æ•°æ®åº“ =\u003e crowd_tags_detail æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡ =\u003e crowd_tags æ•°æ®å†™å…¥æ•°æ®åº“\n1@Override 2public void addCrowdTagsUserId(String tagId, String userId) { 3 CrowdTagsDetail crowdTagsDetailReq = new CrowdTagsDetail(); 4 crowdTagsDetailReq.setTagId(tagId); 5 crowdTagsDetailReq.setUserId(userId); 6 try { 7 crowdTagsDetailDao.addCrowdTagsUserId(crowdTagsDetailReq); 8 // è·å–BitSet 9 RBitSet bitSet = redisService.getBitSet(tagId); // tagId:{userId, ...}:BitSet 10 bitSet.set(redisService.getIndexFromUserId(userId), true); // Longç±»å‹å•¥çš„è½¬æ¢ä¸€ä¸‹è·Ÿbitseté•¿åº¦ä¸€è‡´ï¼Œå°½å¯èƒ½å‡åŒ€ 11 } catch (DuplicateKeyException ignore) { 12 // å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª 13 } 14} â—â—â—redisä¸­ BitSet å°±æ˜¯bitç±»å‹çš„hashtableï¼Œ è€Œ bitmapæ˜¯å­—ç¬¦ä¸²ï¼›\nå¤§è‡´æ€è·¯ï¼š\n1// æ•°æ®å†™å…¥æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æŠŠbitsetä¸­ä½ç½®ç½®1ï¼Œè¡¨ç¤ºè¿™ä¸ªç”¨æˆ·å­˜åœ¨äºè¿™ä¸ªé›†åˆ 2// æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·Idï¼ŒæŸ¥bitset // è¿™é‡Œç”¨æˆ·ID=\u003ebitset:key, ä½¿ç”¨ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œä½¿å¾—æ•£åˆ—å°½å¯èƒ½å‡åŒ€ ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ† å°†å•†å“SKUä¸æ´»åŠ¨è¡¨ è§£è€¦ =\u003e SKU\u0026Activityå…³è”è¡¨ã€‚ä½¿å¾—å¤šä¸ªå•†å“å¯ä»¥ç»‘å®šåŒä¸€ä¸ªæ´»åŠ¨ID(ä¼˜æƒ æ‹¼å›¢æ´»åŠ¨)\n1# MarketèŠ‚ç‚¹ åˆ¤æ–­ å•†å“æ˜¯å¦å­˜åœ¨ä¼˜æƒ æ´»åŠ¨ 2=\u003e ErrorNode =\u003e ä¸å­˜åœ¨ä¼˜æƒ æ´»åŠ¨ 3=\u003e EndNode =\u003e è¿”å›ä¼˜æƒ çš„è¯•ç®—ä»·æ ¼ æµç¨‹ï¼š\n1// MarketNode =\u003e multi-thread æ£€æŸ¥æ˜¯å¦å­˜åœ¨å•†å“\u003c=\u003e æ´»åŠ¨å…³è”è¡¨ 2@Override 3public GroupBuyActivityDiscountVO call() throws Exception { 4 SCSkuActivityVO scSkuActivityVO = activityRepository.querySCSkuActivityBySCGoodsId(goodsId); 5 // log.error(JSON.toJSONString(scSkuActivityVO)); 6 if (scSkuActivityVO == null) return null; 7 return activityRepository.queryGroupBuyActivityDiscountVOById(scSkuActivityVO.getActivityId()); 8} 1// marketNode è·¯ç”± 2if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 3 return errorNode; 4} 5return tagNode; 1// ErrorNode åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼ŒæŠ›å‡ºæ— æ‹¼å›¢é…ç½® 2log.info(\"æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}\", requestParameter.getUserId(), JSON.toJSONString(requestParameter)); 3 4if (dynamicContext.getGroupBuyActivityDiscountVO() == null || dynamicContext.getSkuVO() == null) { 5 log.info(\"å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}\", requestParameter.getGoodsId()); 6 throw new AppException(ResponseCode.ILLEGAL_PARAMETER.getCode(), ResponseCode.ILLEGAL_PARAMETER.getInfo()); 7} 8 9return TrialBalanceEntity.builder().build(); ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤ é™åˆ¶æ‹¼å›¢çš„äººç¾¤\næµç¨‹1ï¼š\n1MarketNode =\u003e TagNode =\u003e EndNode 1// TagNode æ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ èƒ½çœ‹è§æ‹¼å›¢ï¼Œæ˜¯å¦å‚ä¸æ‹¼å›¢ tag_scope = {1,2} ç¬¬ä¸€ä½é™åˆ¶æ˜¯å¦å¯è§ï¼Œç¬¬äºŒä½æ˜¯å¦é™åˆ¶å‚ä¸ 2// redis:bitset =\u003e tag_id:{...} å­˜æ”¾æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ· 3 4// è·å–æ‹¼å›¢ä¿¡æ¯ 5GroupBuyActivityDiscountVO activityDiscountVO = dynamicContext.getGroupBuyActivityDiscountVO(); 6String tagId = activityDiscountVO.getTagId(); 7boolean visible = activityDiscountVO.isVisible(); 8boolean enable = activityDiscountVO.isEnable(); 9 10// æ— ç‰¹å®šäººç¾¤ä¿¡æ¯, äººäººèƒ½æ“ä½œ 11if (StringUtils.isBlank(tagId)) { 12 dynamicContext.setVisible(true); 13 dynamicContext.setEnable(true); 14 return router(requestParameter, dynamicContext); 15} 16 17// æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œç‰¹å®šäººç¾¤èƒ½çœ‹ 18boolean isWithin = repository.isTagCrowdRange(tagId, requestParameter.getUserId()); 19dynamicContext.setVisible(visible || isWithin); 20dynamicContext.setEnable(enable || isWithin); 21 22return router(requestParameter, dynamicContext); 23 24 25// =\u003e isTagCrowdRange function 26// xiaofugeã€liergouåœ¨é‡Œé¢ 27RBitSet bitSet = redisService.getBitSet(tagId); 28if (!bitSet.isExists()) return true; 29// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨äººç¾¤ä¸­ 30return bitSet.get(redisService.getIndexFromUserId(userId)); ç¬¬2-8èŠ‚ åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ ç›®çš„ï¼šå¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ\n=\u003e åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚\nä½¿ç”¨Redisä½œä¸ºé›†ä¸­åŒ–å‚¨å­˜ç³»ç»Ÿçš„å¥½å¤„ï¼Œæ–¹ä¾¿ä¸€å¤„ä¿®æ”¹å˜é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„å®ä¾‹è¿›è¡Œå˜æ›´ï¼\næµé‡é™çº§æˆ–åˆ‡é‡\n1// è‡ªå®šä¹‰æ³¨è§£ 2@Retention(RetentionPolicy.RUNTIME) 3@Target(ElementType.FIELD) 4@Documented 5public @interface DCCValue { 6 String value() default \"\"; 7} 8 9// åŠ¨æ€ä¸­å¿ƒæ§åˆ¶ -- ä½œç”¨äºé™çº§ 10@Service 11public class DCCService { 12 13 /** 14 * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯ 15 */ 16 @DCCValue(\"downgradeSwitch:0\") 17 private String downgradeSwitch; 18 19 @DCCValue(\"cutRange:100\") 20 private String cutRange; 21 22 public boolean isCutRange(String userId) { 23 // è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼ 24 int hashCode = Math.abs(userId.hashCode()); 25 26 // è·å–æœ€åä¸¤ä½ 27 int lastTwoDigits = hashCode % 100; 28 29 // åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†… 30 if (lastTwoDigits \u003c= Integer.parseInt(cutRange)) { 31 log.error(cutRange); 32 return true; 33 } 34 35 return false; 36 } 37 38 public boolean isDowngradeSwitch() { 39 return this.downgradeSwitch.equals(\"1\"); 40 } 41} 42 43// SwitchNodeä¸­ è¿›è¡Œæµé‡æ§åˆ¶ 44// æ ¹æ®ç”¨æˆ·IDåˆ‡é‡ 45String userId = requestParameter.getUserId(); 46 47// åˆ¤æ–­æ˜¯å¦é™çº§ 48if (activityRepository.downgradeSwitch()) { 49 log.info(\"æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}\", userId); 50 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 51} 52 53// åˆ¤æ–­æ˜¯å¦åˆ‡é‡ 54if (activityRepository.cutRange(userId)) { 55 log.info(\"æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}\", userId); 56 throw new AppException(ResponseCode.E0004.getCode(), ResponseCode.E0004.getInfo()); 57} åˆ©ç”¨Redisçš„Topicäº‹ä»¶å‘å¸ƒè®¢é˜… è¿›è¡Œ ä¿®æ”¹\nBeanPostProcessor èƒ½å¤Ÿå½“SpringBeanåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œ\n1// DCCValueBeanFactory implements BeanPostProcessor 2private static final String BASE_CONFIG_PATH = \"group_buy_market_dcc_\"; 3 4private final RedissonClient redissonClient; 5 6private final Map\u003cString, Object\u003e dccObjGroup = new HashMap\u003c\u003e(); 7 8public DCCValueBeanFactory(RedissonClient redissonClient) { 9 this.redissonClient = redissonClient; 10} 11 12@Bean(\"dccTopic\") 13public RTopic dccRedisTopicListener(RedissonClient redissonClient) { 14 log.info(\"åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}\", redissonClient.getBucket(\"test\").get()); 15 // å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç° 16 RTopic topic = redissonClient.getTopic(\"group_buy_market_dcc\"); 17 // æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯ 18 topic.addListener(String.class, ((charSequence, s) -\u003e { 19 log.info(\"ç›‘å¬åˆ°Redis Topicï¼š {}\", charSequence.toString()); 20 String[] split = s.split(Constants.SPLIT); 21 22 // è·å–å€¼ 23 String attribute = split[0]; 24 String key = BASE_CONFIG_PATH + attribute; 25 String value = split[1]; 26 27 // è®¾ç½®å€¼ =\u003e å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ 28 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 29 boolean exists = bucket.isExists(); 30 if (!exists) return; 31 bucket.set(value); 32 33 Object objBean = dccObjGroup.get(key); // è·å–å†…å­˜ä¸­çš„å¯¹è±¡ 34 if (objBean == null) return; 35 36 Class\u003c?\u003e objBeanClass = objBean.getClass(); 37 // æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡ 38 if (AopUtils.isAopProxy(objBean)) { 39 objBeanClass = AopUtils.getTargetClass(objBean); 40 } 41 42 try { 43 Field field = objBeanClass.getDeclaredField(attribute); 44 field.setAccessible(true); 45 field.set(objBean, value); 46 field.setAccessible(false); 47 48 log.info(\"DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}\", key,value); 49 } catch (Exception e) { 50 throw new RuntimeException(e); 51 } 52 53 })); 54 return topic; 55} 56 57 58// implements BeanPostProcessor é‡å†™æ–¹æ³• -- å¹¶åœ¨æ¯ä¸ª bean åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚ 59@Override 60public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { 61 // æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº† 62 Class\u003c?\u003e targetBeanClass = bean.getClass(); 63 Object targetBeanObject = bean; 64 if (AopUtils.isAopProxy(targetBeanObject)) { 65 targetBeanClass = AopUtils.getTargetClass(targetBeanObject); 66 targetBeanObject = AopProxyUtils.getSingletonTarget(bean); 67 } 68\t69 // è¿™é‡Œåˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰å¯¹åº”çš„è‡ªå®šä¹‰æ³¨è§£ 70 Field[] fields = targetBeanClass.getDeclaredFields(); 71 for (Field field : fields) { 72 if (!field.isAnnotationPresent(DCCValue.class)) { 73 continue; 74 } 75 76 DCCValue dccValue = field.getAnnotation(DCCValue.class); 77 String value = dccValue.value(); 78 if (StringUtils.isBlank(value)) { 79 throw new RuntimeException(field.getName() + \"@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€\"); 80 } 81 82 String[] split = value.split(\":\"); 83 String key = BASE_CONFIG_PATH.concat(split[0]); 84 String defaultValue = split[1]; 85 86 String setValue = defaultValue; 87 88 try { 89 if (StringUtils.isBlank(defaultValue)) { 90 throw new RuntimeException(\"dcc config error \" + key + \" is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼\"); 91 } 92 93 RBucket\u003cString\u003e bucket = redissonClient.getBucket(key); 94 boolean exists = bucket.isExists(); 95 if (!exists) { 96 bucket.set(defaultValue); 97 } else { 98 setValue = bucket.get(); 99 } 100 101 field.setAccessible(true); 102 field.set(targetBeanObject, setValue); 103 field.setAccessible(false); 104 log.info(\"åˆå§‹åŒ–å€¼ key:{} value:{}\", key, setValue); 105 } catch (IllegalAccessException e) { 106 throw new RuntimeException(e); 107 } 108 109 dccObjGroup.put(key, targetBeanObject); 110 } 111 return bean; 112} Controller\n1@Override 2@GetMapping(\"update_config\") 3public Response\u003cBoolean\u003e updateConfig(@RequestParam String key, @RequestParam String value) { 4 try { 5 log.info(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}\", key, value); 6 dccTopic.publish(key + \",\" + value); 7 return Response.\u003cBoolean\u003ebuilder() 8 .code(ResponseCode.SUCCESS.getCode()) 9 .info(ResponseCode.SUCCESS.getInfo()) 10 .build(); 11 } catch (Exception e) { 12 log.error(\"DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}\", key, value, e.getMessage()); 13 return Response.\u003cBoolean\u003ebuilder() 14 .code(ResponseCode.UN_ERROR.getCode()) 15 .info(ResponseCode.UN_ERROR.getInfo()) 16 .build(); 17 } 18} â±ï¸25/3/24-23:34\nç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å• 25/3/25/ 20:37\nå®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š\né¦–å…ˆï¼Œå›¢è´­å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºï¼šåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€å·ï¼‰ï¼Œåˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚ ç”¨æˆ·ä»¥æ‹¼å›¢çš„æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚åˆ›å»ºè®¢å•ä½¿ç”¨æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ã€‚ æ‹¼å›¢è¡¨(ç›®æ ‡é‡ã€å®Œæˆé‡ã€é”å•é‡)ï¼Œé”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œä¸èƒ½å†å‚ä¸è¯¥æ‹¼å›¢ã€‚æ‹¼å›¢è¶…æ—¶ï¼Œé‡Šæ”¾ç©ºé—²ä½ç½®è®©å…¶ä»–ç”¨æˆ·å‚ä¸. Trade Repository / rÉªËˆpÉ’zÉ™t(É™)ri /\n1// ç®€å•å®ç°æ­¥éª¤ 2// OutTradeNO æ¨¡æ‹Ÿç”Ÿæˆ è®¢å•IDæ¨¡æ‹Ÿç”Ÿæˆ, TeamIDæ¨¡æ‹Ÿç”Ÿæˆ. ä¸¤å¼ è¡¨:1.è®°å½•æ‹¼å›¢ä¸­æ¯ä¸ªç”¨æˆ·çš„ä¿¡æ¯ 2. è®°å½•è¯¥æ‹¼å›¢ä¿¡æ¯. 3 4// â­ä»“å‚¨ä¸šåŠ¡å®ç° 5// åˆ¤æ–­æ˜¯å¦æœ‰å›¢ -- ä¸€è¡Œè®°å½•å­˜å‚¨æ¯ä¸ªæ‹¼å›¢çš„ä¿¡æ¯ 6// é¦–æ¬¡åˆ™åˆ›å»ºæ‹¼å›¢è®¢å•. åˆå§‹åŒ–è¡¨2 7// å¦åˆ™åŠ å…¥å…¶ä»–äººçš„å›¢ è¡¨2 æ‹¼å›¢äººæ•°+1 8 9// æ’å…¥è¯¥ç”¨æˆ·çš„æ‹¼å›¢ä¿¡æ¯åˆ°è¡¨1; æ¯ä¸ªç”¨æˆ·ä¸€è¡Œ 10 11// â­æ§åˆ¶å™¨ä¸šåŠ¡å®ç° 12// 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯ 13// 2. æŸ¥è¯¢ç”¨æˆ·outTradeNoæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡,å¹‚ç­‰æ€§ 14// 3. æŸ¥è¯¢æ‹¼å›¢æ˜¯å¦äººæ•°å·²æ»¡è¶³ 15// 4. è¥é”€ä¼˜æƒ è¯•ç®— 16// 5. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿçœ‹è§æ‹¼å›¢å’Œå‚ä¸ 17// 6. æ‹¼å›¢é”å• =\u003e ä»“å‚¨ä¸šåŠ¡ 18// 7. è¿”å›ç»“æœ ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡ 25/4/8/ 15:53\nå…ˆå‰çš„è´£ä»»é“¾æ¨¡æ¿éƒ½æ˜¯å†™æ­»çš„ã€‚æœ¬ç« å†…å®¹ä¸ºï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘å’Œé“¾æ¥é€»è¾‘è§£è€¦ã€‚\næŠ½è±¡\nç®€å•çš„å•ä¾‹é“¾\n1// 1. IlogicChainArmory: è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹ 2// next() 3//\tappendNext() 4// 2. ILogicLink extends IlogicChainArmory: å¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³• 5//\tapply() 6// 3. AbstractLogicLink extends ILogicLink: å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³• 7// next() 8//\tappendNext() 9// apply() è¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„ç±»ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ ILogicLink next è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚\nå¤šä¾‹-é“¾è·¯æ¨¡å¼\nå¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚\n1// éœ€è¦è®¾è®¡çš„ç±» 2// 1. Node \u0026 LinkedList extends ILink 3// åŒå‘é“¾è¡¨èŠ‚ç‚¹ \u0026 åŒå‘é“¾è¡¨ 4 5// 2. BusinessLinkedList extends LinkedList 6// ä»å¤´åˆ°å°¾æ‰§è¡Œå„ä¸ªèŠ‚ç‚¹ 7 8// 3. ILogicHandler -- å®šä¹‰ä»»åŠ¡ 9 10// 4. LinkArmory -- åˆ›å»ºé“¾è¡¨å¹¶è£…é…èŠ‚ç‚¹ 11// public LinkArmory(String linkName, ILogicHandler... logicHandlers) 12// private final BusinessLinkedList logicLink; 1// ç”¨æ³• 2// 1. å®šä¹‰ RuleLogicNode extends ILogicHandler 3// 2. new LinkArmory\u003c\u003e(\"demo01\", ruleLogic201, ruleLogic202, ...); å…·ä½“ä¼ªä»£ç \n1public class LinkedList\u003cE\u003e implements ILink\u003cE\u003e { 2 3 /** 4 * è´£ä»»é“¾åç§° 5 * */ 6 @Getter 7 private final String name; 8 transient int size = 0; 9 transient Node\u003cE\u003e first; 10 transient Node\u003cE\u003e last; 11 12 public LinkedList(String name) { 13 this.name = name; 14 } 15 16 // å¤´æ’èŠ‚ç‚¹ 17 void linkFirst(E e) { 18 final Node\u003cE\u003e f = first; 19 final Node\u003cE\u003e newNode = new Node\u003c\u003e(null, e, f); 20 first = newNode; 21 if (f == null) 22 last = newNode; 23 else 24 f.prev = newNode; 25 size++; 26 } 27 28 // å°¾æ’æ³• 29 void linkLast(E e) { 30 final Node\u003cE\u003e l = last; 31 final Node\u003cE\u003e newNode = new Node\u003c\u003e(l, e, null); 32 last = newNode; 33 if (l == null) { 34 first = newNode; 35 } else { 36 l.next = newNode; 37 } 38 size++; 39 } 40 41 @Override 42 public boolean add(E e) { 43 linkLast(e); 44 return true; 45 } 46 47 @Override 48 public boolean addFirst(E e) { 49 linkFirst(e); 50 return true; 51 } 52 53 @Override 54 public boolean addLast(E e) { 55 linkLast(e); 56 return true; 57 } 58 59 @Override 60 public boolean remove(Object o) { 61 if (o == null) { 62 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 63 if (x.item == null) { 64 unlink(x); 65 return true; 66 } 67 } 68 } else { 69 for (Node\u003cE\u003e x=first; x!=null; x=x.next) { 70 if (o.equals(x.item)) { 71 unlink(x); 72 return true; 73 } 74 } 75 } 76 return false; 77 } 78\t79 // åˆ é™¤èŠ‚ç‚¹ï¼Œæ³¨æ„æ˜¯åŒå‘é“¾è¡¨ 80 E unlink(Node\u003cE\u003e x) { 81 final E element = x.item; 82 final Node\u003cE\u003e next = x.next; 83 final Node\u003cE\u003e prev = x.prev; 84 85 // xä¸ºå¤´èŠ‚ç‚¹ 86 if (prev == null) { 87 first = next; 88 } else { 89 prev.next = next; 90 x.prev = null; 91 } 92 93 // xä¸ºæœ«å°¾ 94 if (next == null) { 95 last = x.prev; 96 } else { 97 next.prev = prev; 98 x.next = null; 99 } 100 101 x.item = null; 102 size--; 103 return element; 104 } 105 106 @Override 107 public E get(int index) { 108 return node(index).item; 109 }\t110\t111 // æ ¹æ®indexï¼Œåˆ¤æ–­æ˜¯å‰å‘è¿˜æ˜¯åå‘ 112 private Node\u003cE\u003e node(int index) { 113 if (index \u003c (size \u003e\u003e 1)) { 114 Node\u003cE\u003e x = first; 115 for (int i = 0; i \u003c index; i++) { 116 x = x.next; 117 } 118 return x; 119 } else { 120 Node\u003cE\u003e x = last; 121 for (int i = size-1; i \u003e index; i--) { 122 x = x.prev; 123 } 124 return x; 125 } 126 } 127 128 @Override 129 public void printLinkList() { 130 if (this.size == 0) { 131 System.out.printf(\"é“¾è¡¨ä¸ºç©º\"); 132 } else { 133 Node\u003cE\u003e temp = first; 134 System.out.print(\"ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š\" + first.item + \" å°¾èŠ‚ç‚¹ï¼š\" + last.item + \" æ•´ä½“ï¼š\"); 135 while (temp != null) { 136 System.out.print(temp.item + \"ï¼Œ\"); 137 temp = temp.next; 138 } 139 System.out.println(); 140 } 141 } 142} ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤ 2025-4-8 17:30\nè¯¥ç« èŠ‚è¡¥å……ï¼šè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚\n1// Logic chain 2// 1. æ£€æŸ¥å‚æ•° 3// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ ¹æ®å¤–éƒ¨OrderId 4// 3. åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨æ˜¯å¦æ»¡ 5// 4. è¥é”€è¯•ç®— -- ç»™å‡ºæŠ˜æ‰£ä»·æ ¼ 6// 5. äººç¾¤é™å®š -- ç‰¹å®šäººç¾¤æ‰èƒ½æ‹¼å›¢ 7// 6. æ‹¼å›¢é”å• -- 1. ä¿®æ”¹æ´»åŠ¨è¡¨å¯¹åº”çš„ä¿¡æ¯ 2. æ’å…¥ä¸€æ¡æ‹¼å›¢è®°å½• 8// 6.1. äº¤æ˜“è§„åˆ™è¿‡æ»¤ -- æ£€æŸ¥æ´»åŠ¨æ—¶é—´ + æ£€æŸ¥æ‹¼å›¢æ¬¡æ•° â­æœ¬èŠ‚ä¸»è¦è¿™éƒ¨åˆ† å…·ä½“å°±æ˜¯å®šä¹‰ä¸€äº› è´£ä»»é“¾èŠ‚ç‚¹(æ‹¦æˆªå™¨)\n1@Slf4j 2@Service 3public class ActivityUsabilityRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 // æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨ 13 GroupBuyActivityEntity groupBuyActivityEntity = repository.queryGroupBuyActivityEntityByActivityId(requestParameter.getActivityId()); 14 15 // æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€ 16 if (!ActivityStatusEnumVO.EFFECTIVE.equals(groupBuyActivityEntity.getStatus())) { 17 log.info(\"æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0101); 19 } 20 21 // æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´ 22 Date now = new Date(); 23 if (now.before(groupBuyActivityEntity.getStartTime()) || now.after(groupBuyActivityEntity.getEndTime())) { 24 log.info(\"æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}\", requestParameter.getActivityId()); 25 throw new AppException(ResponseCode.E0102); 26 } 27 28 dynamicContext.setGroupBuyActivity(groupBuyActivityEntity); 29 30 // èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹ 31 return next(requestParameter, dynamicContext); 32 } 33} 1@Slf4j 2@Service 3public class UserTakeLimitRuleFilter implements ILogicHandler\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e { 4 5 @Resource 6 private ITradeRepository repository; 7 8 @Override 9 public TradeRuleFilterBackEntity apply(TradeRuleCommandEntity requestParameter, TradeRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 10 log.info(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId{}\", requestParameter.getUserId(), requestParameter.getActivityId()); 11 12 GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity(); 13 14 Integer count = repository.queryOrderCountByActivityId(requestParameter.getActivityId(), requestParameter.getUserId()); 15 16 if (groupBuyActivity.getTakeLimitCount() != null \u0026\u0026 count \u003e= groupBuyActivity.getTakeLimitCount()) { 17 log.info(\"ç”¨æˆ·å‚æ•°æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}\", requestParameter.getActivityId()); 18 throw new AppException(ResponseCode.E0103); 19 } 20 21 return TradeRuleFilterBackEntity.builder() 22 .userTakeOrderCount(count) 23 .build(); 24 } 25} ç»„è£…è´£ä»»é“¾ â€“ BusinessLinkedList å…·ä½“ä¸šåŠ¡\n1@Bean(\"tradeRuleFilter\") 2public BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e 3 tradeRuleFilter(ActivityUsabilityRuleFilter activityUsabilityRuleFilter, UserTakeLimitRuleFilter userTakeLimitRuleFilter) { 4 // ç»„è£…é“¾ 5 LinkArmory\u003cTradeRuleCommandEntity, DynamicContext, TradeRuleFilterBackEntity\u003e filter = new LinkArmory\u003c\u003e(\"äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾\", activityUsabilityRuleFilter, userTakeLimitRuleFilter); 6 // é“¾å¯¹è±¡ 7 return filter.getLogicLink(); 8} LinkArmory â€“ çœŸæ­£çš„æŠ½è±¡è£…é…è´£ä»»é“¾\n1@SafeVarargs 2public LinkArmory(String linkName, ILogicHandler\u003cT, D, R\u003e... logicHandlers) { 3 logicLink = new BusinessLinkedList\u003c\u003e(linkName); 4 for (ILogicHandler\u003cT, D, R\u003e logicHandler: logicHandlers){ 5 logicLink.add(logicHandler); 6 } 7} 8public BusinessLinkedList\u003cT, D, R\u003e getLogicLink() { 9 return logicLink; 10} ç”¨æ³•\n1@Resource 2private BusinessLinkedList\u003cTradeRuleCommandEntity, TradeRuleFilterFactory.DynamicContext, TradeRuleFilterBackEntity\u003e tradeRuleFilter; 3 4tradeRuleFilter.aaply(...) ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡ 25/4/8 21:19\næ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚\né‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚\nâ­â­â­ æ‰€æœ‰ç”¨æˆ·å®Œæˆæ”¯ä»˜å, æœ€åä¸€ä¸ªç”¨æˆ·çš„ç»“ç®—è§¦å‘å›è°ƒäº‹ä»¶!\n1@Transactional(timeout = 500) 2@Override 3public void settlementMarketPayOrder(GroupBuyTeamSettlementAggregate groupBuyTeamSettlementAggregate) { 4 UserEntity userEntity = groupBuyTeamSettlementAggregate.getUserEntity(); 5 GroupBuyTeamEntity groupBuyTeamEntity = groupBuyTeamSettlementAggregate.getGroupBuyTeamEntity(); 6 TradePaySuccessEntity tradePaySuccessEntity = groupBuyTeamSettlementAggregate.getTradePaySuccessEntity(); 7 8 // 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€ 9 GroupBuyOrderList groupBuyOrderList = new GroupBuyOrderList(); 10 groupBuyOrderList.setUserId(userEntity.getUserId()); 11 groupBuyOrderList.setOutTradeNo(tradePaySuccessEntity.getOutTradeNo()); 12 int updateOrderStatus2COMPLETE = groupBuyOrderListDao.updateOrderStatus2COMPLETE(groupBuyOrderList); 13 if (1 != updateOrderStatus2COMPLETE) { 14 throw new AppException(ResponseCode.UPDATE_ZERO); 15 } 16\t17 // 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ 18 int updateAddCount = groupBuyOrderDao.updateAddCompleteCount(groupBuyTeamEntity.getTeamId()); 19 if (1 != updateAddCount) { 20 throw new AppException(ResponseCode.UPDATE_ZERO); 21 } 22 23 // 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€ 24 if (groupBuyTeamEntity.getTargetCount() - groupBuyTeamEntity.getCompleteCount() == 1) { 25 int i = groupBuyOrderDao.updateOrderStatus2COMPLETE(groupBuyTeamEntity.getTeamId()); 26 if (1 != i) { 27 throw new AppException(ResponseCode.UPDATE_ZERO); 28 } 29 30 // æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å¤–éƒ¨è®¢å•å·åˆ—è¡¨ 31 List\u003cString\u003e outOrderNoList = groupBuyOrderListDao.queryGroupBuyCompleteOrderOutTradeNoListByTeamId(groupBuyTeamEntity.getTeamId()); 32 33 // æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½• 34 NotifyTask notifyTask = NotifyTask.builder() 35 .activityId(groupBuyTeamEntity.getActivityId()) 36 .teamId(groupBuyTeamEntity.getTeamId()) 37 .notifyUrl(\"æš‚æ— \") 38 .notifyCount(0) 39 .notifyStatus(0) 40 .build(); 41 notifyTask.setParameterJson(JSON.toJSONString(new HashMap\u003cString, Object\u003e() {{ 42 put(\"teamId\", groupBuyTeamEntity.getTeamId()); 43 put(\"outTradeNoList\", outOrderNoList); 44 }})); 45 46 notifyTaskDao.insert(notifyTask); 47 } 48 49} è¿™é‡Œç®—æ˜¯æ”¯ä»˜æˆåŠŸåçš„å›è°ƒ\nç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤ â±ï¸25/4/9 12:31\næœ¬èŠ‚è¯‰æ±‚ï¼š\næ‹¼å›¢äº¤æ˜“ç»“ç®—çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸€äº›åˆ—çš„è§„åˆ™è¿‡æ»¤ã€‚åŒ…æ‹¬ï¼›æˆ‘ä»¬ä¸Šä¸€èŠ‚æåˆ°çš„æ ¡éªŒå¤–éƒ¨äº¤æ˜“å•çš„æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…ï¼ŒåŒæ—¶è¿˜æœ‰å…³äºè¿™ç¬”å¤–éƒ¨äº¤æ˜“å•æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ‹¼å›¢é”å•è®¢å•ã€‚å¦å¤–åƒæ˜¯ SC æ¸ é“çš„æœ‰æ•ˆæ€§ä¹Ÿéœ€è¦åœ¨ç»“ç®—æ—¶è¿›è¡Œæ ¡éªŒã€‚\næ‰€ä»¥ï¼Œæœ¬èŠ‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€å¥—è§„åˆ™é“¾ï¼Œæ¥å¤„ç†è¿™äº›ä¸šåŠ¡è§„åˆ™ã€‚å› ä¸ºè§„åˆ™é“¾å·²ç»è¢«æŠ½å–ä¸ºé€šç”¨çš„æ¨¡æ¿äº†ï¼Œé‚£ä¹ˆæœ¬èŠ‚ä½¿ç”¨èµ·æ¥ä¼šéå¸¸å®¹æ˜“ã€‚\nè´£ä»»é“¾æµç¨‹ï¼š1. æ ¡éªŒæ¸ é“æ˜¯å¦ä¸ºé»‘åå• 2. å¤–éƒ¨è®¢å•å·æ˜¯å¦æ­£ç¡® 3. äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæœŸå†… 4. æ‰“åŒ…ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡\nè´£ä»»é“¾åŒ…è£…å¯¹è±¡\n1@Bean(\"tradeSettlementRuleFilter\") 2public BusinessLinkedList\u003cTradeSettlementRuleCommandEntity, 3TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e tradeSettlementRuleFilter( 4 SCRuleFilter scRuleFilter, OutTradeNoRuleFilter outTradeNoRuleFilter, SettableRuleFilter settableRuleFilter, EndRuleFilter endRuleFilter 5) { 6 LinkArmory\u003cTradeSettlementRuleCommandEntity, DynamicContext, TradeSettlementRuleFilterBackEntity\u003e tradeSettlementFilter = 7 new LinkArmory\u003c\u003e(\"äº¤æ˜“ç»“ç®—è§„åˆ™è¿‡æ»¤é“¾\", scRuleFilter, outTradeNoRuleFilter, settableRuleFilter, endRuleFilter); 8 9 return tradeSettlementFilter.getLogicLink(); 10 11} 1 SCè¿‡æ»¤å™¨\n1@Slf4j 2@Service 3public class SCRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 // 1. æ‰“å°å‡½æ•°æµç¨‹ä¿¡æ¯ 12 log.info(\"ç»“ç®—è§„åˆ™è¿‡æ»¤-æ¸ é“é»‘åå•æ ¡éªŒ{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 13 14 // 2. æ ¡éªŒé»‘åå•ä¿¡æ¯ 15 Boolean intercept = repository.isSCBlackIntercept(requestParameter.getSource(), requestParameter.getChannel()); 16 if (intercept) { 17 log.info(\"{}-{} æ¸ é“é»‘åå•æ‹¦æˆª\", requestParameter.getSource(), requestParameter.getChannel()); 18 throw new AppException(ResponseCode.E0105); 19 } 20 21 return next(requestParameter, dynamicContext); 22 } 23} 2 è®¢å•å·æ ¡éªŒè¿‡æ»¤å™¨\n1@Slf4j 2@Service 3public class OutTradeNoRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 log.info(\"ç»“ç®—è§„åˆ™è¿‡æ»¤-å¤–éƒ¨å•å·æ ¡éªŒ{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 12 13 MarketPayOrderEntity marketPayOrderEntity = repository.queryMarketPayOrderEntityByOutTradeNo(requestParameter.getUserId(), requestParameter.getOutTradeNo()); 14 15 if (null == marketPayOrderEntity) { 16 log.info(\"ä¸å­˜åœ¨çš„å¤–éƒ¨äº¤æ˜“å•å·æˆ–ç”¨æˆ·å·²é€€å•ï¼Œä¸éœ€è¦åšæ”¯ä»˜è®¢å•ç»“ç®—ï¼š{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 17 throw new AppException(ResponseCode.E0104); 18 } 19 20 dynamicContext.setMarketPayOrderEntity(marketPayOrderEntity); 21 22 return next(requestParameter, dynamicContext); 23 } 24} 3 æœ‰æ•ˆæœŸæ ¡éªŒå™¨\n1@Slf4j 2@Service 3public class SettableRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 6 @Resource 7 private ITradeRepository repository; 8 9 @Override 10 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 11 log.info(\"ç»“ç®—è§„åˆ™è¿‡æ»¤-æœ‰æ•ˆæ—¶é—´æ ¡éªŒï¼š{}, {}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 12 13 // 1. ä¸Šä¸‹æ–‡è·å–æ•°æ® 14 MarketPayOrderEntity marketPayOrderEntity = dynamicContext.getMarketPayOrderEntity(); 15 16 // 2. æŸ¥è¯¢æ‹¼å›¢å¯¹è±¡ 17 GroupBuyTeamEntity groupBuyTeamEntity = repository.queryGroupBuyTeamByTeamId(marketPayOrderEntity.getTeamId()); 18 19 // 3. å¤–éƒ¨äº¤æ˜“æ—¶é—´ - æ”¯ä»˜æ—¶é—´éœ€è¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…å®Œæˆ 20 if (requestParameter.getOutTradeTime().after(groupBuyTeamEntity.getValidEndTime())){ 21 // 4. åˆ¤æ–­ï¼Œå¤–éƒ¨äº¤æ˜“æ—¶é—´æ˜¯å¦å°äºæ‹¼å›¢ç»“æŸæ—¶é—´ 22 log.info(\"è®¢å•äº¤æ˜“æ—¶é—´ä¸åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…\"); 23 throw new AppException(ResponseCode.E0106); 24 } 25 26 // 5. è®¾ç½®ä¸Šä¸‹æ–‡ 27 dynamicContext.setGroupBuyTeamEntity(groupBuyTeamEntity); 28 29 return next(requestParameter, dynamicContext); 30 } 31} 4 æ‰“åŒ…èŠ‚ç‚¹\n1@Slf4j 2@Service 3public class EndRuleFilter implements ILogicHandler\u003cTradeSettlementRuleCommandEntity, 4 TradeSettlementRuleFilterFactory.DynamicContext, TradeSettlementRuleFilterBackEntity\u003e { 5 @Override 6 public TradeSettlementRuleFilterBackEntity apply(TradeSettlementRuleCommandEntity requestParameter, TradeSettlementRuleFilterFactory.DynamicContext dynamicContext) throws Exception { 7 log.info(\"ç»“ç®—è§„åˆ™è¿‡æ»¤-ç»“æŸèŠ‚ç‚¹{} outTradeNo:{}\", requestParameter.getUserId(), requestParameter.getOutTradeNo()); 8 9 GroupBuyTeamEntity groupBuyTeamEntity = dynamicContext.getGroupBuyTeamEntity(); 10 11 return TradeSettlementRuleFilterBackEntity.builder() 12 .teamId(groupBuyTeamEntity.getTeamId()) 13 .activityId(groupBuyTeamEntity.getActivityId()) 14 .completeCount(groupBuyTeamEntity.getCompleteCount()) 15 .targetCount(groupBuyTeamEntity.getTargetCount()) 16 .validStartTime(groupBuyTeamEntity.getValidStartTime()) 17 .validEndTime(groupBuyTeamEntity.getValidEndTime()) 18 .lockCount(groupBuyTeamEntity.getLockCount()) 19 .status(groupBuyTeamEntity.getStatus()) 20 .build(); 21 } 22} 5 SCæ¥æºæ¸ é“é»‘åå•åŠ¨æ€é…ç½®\n1@Slf4j 2@Service 3public class DCCService 4 5@DCCValue(\"scBlacklist:s02c02\") // é»˜è®¤é»‘åå•æ¸ é“ 6private String scBlacklist; 7 8public Boolean isSCBlackIntercept(String source, String channel) { 9 List\u003cString\u003e list = Arrays.asList(scBlacklist.split(Constants.SPLIT)); 10 return list.contains(source + channel); 11} 12 13// Httpè¯·æ±‚key=scBlacklist\u0026value=s02c02;s03c03 14 15// =\u003e Redis (scBlacklist) =\u003e scBlacklist,s02c02;s03c03 ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡ â±ï¸25/4/9 15:32\næ‹¼å›¢ç»„é˜Ÿäº¤æ˜“ç»“ç®—å®Œç»“åï¼Œå®ç°ä¸€ä¸ªå›è°ƒé€šçŸ¥çš„ä»»åŠ¡å¤„ç†ã€‚å‘ŠçŸ¥å¦å¤–çš„å¾®æœåŠ¡ç³»ç»Ÿå¯ä»¥è¿›è¡Œåç»­çš„æµç¨‹äº†ã€‚\nRPCã€MQï¼Œè¿™ä¸€ç±»çš„éƒ½æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå…¬ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼Œå®ƒçš„æŠ€æœ¯æ¶æ„æ¯”è¾ƒé€‚åˆäºå…¬å¸å†…éƒ¨çš„ç»Ÿä¸€ç³»ç»Ÿä½¿ç”¨ã€‚å¦‚æœæ˜¯æœ‰å’Œå¤–éƒ¨å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¥ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ HTTP è¿™æ ·ç»Ÿä¸€æ ‡å‡†åè®®çš„æ¥å£è¿›è¡Œä½¿ç”¨ã€‚\næ³¨æ„ï¼šå¾®ä¿¡æ”¯ä»˜ï¼Œæ”¯ä»˜å®æ”¯ä»˜ï¼Œä¹Ÿæ˜¯åœ¨å®Œæˆæ”¯ä»˜åï¼Œåšçš„è¿™æ ·çš„å›è°ƒå¤„ç†ã€‚\nğŸ’¡æµç¨‹é€»è¾‘ 1ï¼šé”å•\n1// 1. æ£€æŸ¥é”å•è¯·æ±‚ä¿¡æ¯ - è¯·æ±‚å‚æ•°æ˜¯å¦ä¸ºNull or ç©ºä¸² 2// 2. æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å• - æ£€æŸ¥æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å•æ˜¯å¦å­˜åœ¨ 3// 3. æ‹¼å›¢æ˜¯å¦èƒ½å¤ŸåŠ å…¥ - åˆ¤æ–­æ‹¼å›¢å½“å‰äººæ•°å°äºç›®æ ‡äººæ•° 4// 4. è¥é”€ä¼˜æƒ è¯•ç®— 5// 4.1. RootNode =\u003e SwitchRoot =\u003e MarketNode =\u003e TagNode =\u003e EndNode 6// =\u003e ErrorNode 7// 4.1.1 RootNodeæ£€æŸ¥ä¿¡æ¯ 8// 4.1.2 SwitchRoot é™çº§å’Œé™æµ 9// 4.1.3 MarketNode 1:å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯+æ´»åŠ¨ä¿¡æ¯ 2:è¿›è¡ŒæŠ˜æ‰£éªŒç®—(æ ¹æ®Mapæ‹¿åˆ°å¯¹åº”çš„æŠ˜æ‰£å¯¹è±¡ - æ¯ä¸ªæŠ˜æ‰£å¯¹è±¡å®ç°åŒä¸€æ¥å£) 10// 4.1.4-1 TagNodeï¼šæ ¹æ®bitsetï¼Œæ£€æŸ¥ç”¨æˆ·Idæ˜¯å¦æœ‰èµ„æ ¼å‚ä¸orå¯è§è¯¥æŠ˜æ‰£æ´»åŠ¨ 11//\t4.1.4-2 ErrorNodeï¼šæ— æŠ˜æ‰£æ´»åŠ¨è¿”å› 12// 4.1.5 EndNode ç»„è£…è¯•ç®—ç»“æœ 13// 5. æ ¹æ®è¯•ç®—ç»“æœåˆ¤æ–­æ˜¯å¦å¯è§å’Œå¯å‚ä¸ 14// 6. è¿›è¡Œé”å• 15//\t6.1. äº¤æ˜“è§„åˆ™æ£€æŸ¥ - æ ¡éªŒæ´»åŠ¨çŠ¶æ€+æ´»åŠ¨æ—¶é—´ \u0026\u0026 æ ¡éªŒå‚ä¸æ¬¡æ•° -è´£ä»»é“¾ 16// LinkArmory(BusinessLinkedList:ActivityUsabilityRuleFilter+UserTakeLimitRuleFilter) 17//\t6.1.1 ActivityUsabilityRuleFilter: æ£€æŸ¥æ´»åŠ¨çŠ¶æ€å’Œæ—¶é—´ 18//\t6.1.2 UserTakeLimitRuleFilter: æ£€æŸ¥ç”¨æˆ·å‚ä¸æ¬¡æ•° 19// 6.2. åˆ¤æ–­æ˜¯å¦æœ‰å›¢ - ç”Ÿæˆæ‹¼å›¢è®¢å• or åŠ å…¥åˆ«äººçš„è®¢å• =\u003e æ’å…¥orä¿®æ”¹è®°å½• GroupBuyOrder 20// 6.3. ç”Ÿæˆè®¢å•æ˜ç»† =\u003e æ’å…¥è®°å½•åˆ°GroupBuyOrderList ğŸ’¡æµç¨‹é€»è¾‘ 2ï¼šç»“ç®—\n1// 1. æ£€æŸ¥æ‹¼å›¢ä¿¡æ¯ - ç»“ç®—è§„åˆ™ 2// 1.1 æ£€æŸ¥ æ¸ é“åˆæ³•æ€§=\u003eå¤–éƒ¨è®¢å•åˆæ³•æ€§=\u003eæ‹¼å›¢æ—¶é—´åˆæ³•æ€§=\u003eåŒ…è£…æ£€æŸ¥ç»“æœ 3// 1.1.1 SCRuleFilter: æ£€æŸ¥sourceå’Œchannelæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œ@DCCValue(\"scBlacklist:s02c02\"), å¯åŠ¨æ€é…ç½® 4// 1.1.2 OutTradeNoRuleFilterï¼šæ£€æŸ¥OutTradeNoæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦GroupBuyOrderListå­˜åœ¨åˆå§‹é”å•çš„æ‹¼å›¢è®¢å• 5//\t(è¿™é‡Œï¼Œå¤–éƒ¨è¿›è¡Œäº†æ”¯ä»˜ï¼Œä½†æ˜¯ç³»ç»Ÿè¿˜æ²¡ä¿®æ”¹ç»“ç®—çŠ¶æ€å‘¢) 6// 1.1.3 SettableRuleFilterï¼šæ£€æŸ¥è®¢å•äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†… 7// 1.1.4 EndRuleFilterï¼šåŒ…è£…ç»“æœ 8// 2. è¿›è¡Œæ‹¼å›¢ç»“ç®— 9// 2.1 æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»† =\u003e GroupBuyOrderListå¯¹åº”ç”¨æˆ·çš„å®ŒæˆçŠ¶æ€ 10// 2.2 æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ =\u003e GroupBuyOrderå¯¹åº”çš„ç”¨æˆ·å®Œæˆæ”¯ä»˜æ•°é‡ 11// 2.3 æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€ =\u003e æœ€åä¸€ä¸ªäººæ”¯ä»˜å®Œæˆè§¦å‘ =\u003e GroupBuyOrderæ‹¼å›¢ä¿¡æ¯çŠ¶æ€ =\u003e å†™å…¥å›è°ƒä»»åŠ¡è®°å½•(åŒ…è£…TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID) 12// 3. ç»„é˜Ÿå›è°ƒå¤„ç† - è¿™é‡Œæ˜¾ç¤ºçš„æ‰§è¡Œï¼Œä½¿å¾—å®æ—¶æ€§æ¯”è¾ƒå¥½ï¼Œåªæœ‰æœ€åä¸€ä¸ªäººå®Œæˆæ‰ä¼šæ‰§è¡ŒæˆåŠŸï¼Œä¸è¿‡æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œå…œåº• 13// 3.1 å‘é€Httpè¿œç¨‹è°ƒç”¨ï¼Œå°†(TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID)å‘é€ç»™ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œé€šçŸ¥å‘è´§orå…¶ä»– 14// 3.2 å®šæ—¶ä»»åŠ¡ï¼šæŸ¥è¯¢æ‰€æœ‰åˆå§‹çŠ¶æ€å’Œé‡è¯•çŠ¶æ€çš„ é€šçŸ¥ä»»åŠ¡ ğŸ·ï¸æœ¬ç« èŠ‚å®Œæˆ 3 è§¦å‘å›è°ƒéƒ¨åˆ†\n1// æŒ‡å®šè§¦å‘å›è°ƒé€šçŸ¥ä»»åŠ¡ - å®æ—¶æ€§ 2@Override 3public Map\u003cString, Integer\u003e execSettlementNotifyJob(String teamId) throws Exception { 4 log.info(\"æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥å›è°ƒï¼ŒæŒ‡å®š teamId:{}\", teamId); 5 6 List\u003cNotifyTaskEntity\u003e notifyTaskEntityList = repository.queryUnExecutedNotifyTaskList(teamId); 7 return execSettlementNotifyJob(notifyTaskEntityList); 8} 9 10// è¾…åŠ©å®šæ—¶æ‰«æï¼Œè¿›è¡Œé€šçŸ¥ - å…œåº• 11@Override 12public Map\u003cString, Integer\u003e execSettlementNotifyJob() throws Exception { 13 log.info(\"æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥ä»»åŠ¡\"); 14 15 // æŸ¥è¯¢æœªæ‰§è¡Œä»»åŠ¡ 16 List\u003cNotifyTaskEntity\u003e notifyTaskEntities = repository.queryUnExecutedNotifyTaskList(); 17 18 return execSettlementNotifyJob(notifyTaskEntities); 19} 20 21// å…¬ç”¨é€šçŸ¥å‡½æ•° 22private Map\u003cString, Integer\u003e execSettlementNotifyJob(List\u003cNotifyTaskEntity\u003e notifyTaskEntities) throws Exception { 23 int successCount = 0, errorCount = 0, retryCount = 0; 24 for (NotifyTaskEntity notifyTask : notifyTaskEntities) { 25 // å›è°ƒå¤„ç† 26 String response = port.groupBuyNotify(notifyTask); 27 28 if (NotifyTaskHTTPEnumVO.SUCCESS.getCode().equals(response)) { 29 int i = repository.updateNotifyTaskStatusSuccess(notifyTask.getTeamId()); 30 if (1 == i) { 31 successCount += 1; 32 } 33 } else if (NotifyTaskHTTPEnumVO.ERROR.getCode().equals(response)) { 34 int i = repository.updateNotifyTaskStatusError(notifyTask.getTeamId()); 35 if (1 == i) { 36 errorCount += 1; 37 } 38 } else { 39 int i = repository.updateNotifyTaskStatusRetry(notifyTask.getTeamId()); 40 if (1 == i) { 41 retryCount += 1; 42 } 43 } 44 } 45 46 Map\u003cString, Integer\u003e resultMap = new HashMap\u003c\u003e(); 47 resultMap.put(\"waitCount\", notifyTaskEntities.size()); 48 resultMap.put(\"successCount\", successCount); 49 resultMap.put(\"errorCount\", errorCount); 50 resultMap.put(\"retryCount\", retryCount); 51 52 return resultMap; 53} 54 55// è¿œç¨‹è°ƒç”¨ 56@Override 57public String groupBuyNotify(NotifyTaskEntity notifyTask) throws Exception { 58 RLock lock = redisService.getLock(notifyTask.lockKey()); 59 try { 60 // æ‹¼å›¢æœåŠ¡å™¨éƒ¨ç½²åœ¨å¤šå°åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œå¤šä»»åŠ¡æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡è¢«å¤šæ¬¡æ‰§è¡Œï¼Œé”çš„ç²’åº¦ xxx:teamId 61 if (lock.tryLock(3, 0, TimeUnit.SECONDS)) { 62 try { 63 if (StringUtils.isBlank(notifyTask.getNotifyUrl()) || \"æš‚æ— \".equals(notifyTask.getNotifyUrl())) { 64 return NotifyTaskHTTPEnumVO.SUCCESS.getCode(); 65 } 66 return â­groupBuyNotifyService.groupBuyNotify(notifyTask.getNotifyUrl(), notifyTask.getParameterJson());â­ // è¿™é‡Œè¿›è¡Œè¿œç¨‹è°ƒç”¨ 67 } finally { 68 if (lock.isLocked() \u0026\u0026 lock.isHeldByCurrentThread()) 69 lock.unlock(); 70 } 71 } 72 return NotifyTaskHTTPEnumVO.NULL.getCode(); 73 }catch (Exception e) { 74 Thread.currentThread().interrupt(); 75 return NotifyTaskHTTPEnumVO.NULL.getCode(); 76 } 77} 78 79// OKHttpå‘é€è¯·æ±‚ 80public String groupBuyNotify(String apiUrl, String notifyRequestDTOJSON) { 81 try { 82 // 1. æ„å»ºå‚æ•° 83 MediaType mediaType = MediaType.parse(\"application/json\"); 84 RequestBody body = RequestBody.create(mediaType, notifyRequestDTOJSON); 85 Request request = new Request.Builder() 86 .url(apiUrl) 87 .post(body) 88 .addHeader(\"content-type\", \"application/json\") 89 .build(); 90 91 // 2. è°ƒç”¨æ¥å£ 92 Response response = okHttpClient.newCall(request).execute(); 93 94 // 3. è¿”å›ç»“æœ 95 return response.body().string(); 96 } catch (IOException e) { 97 log.info(\"æ‹¼å›¢å›è°ƒ HTTP æ¥å£æœåŠ¡å¼‚å¸¸ {}\", apiUrl, e); 98 throw new AppException(ResponseCode.HTTP_EXCEPTION); 99 } 100} å¾®ä¿¡æ‰«æç™»å½•æµç¨‹ access_tokenæ˜¯å…¬ä¼—å·çš„å…¨å±€å”¯ä¸€æ¥å£è°ƒç”¨å‡­æ®; å…¬ä¼—å·å’Œå°ç¨‹åºå‡å¯ä»¥ä½¿ç”¨AppIDå’ŒAppSecretè°ƒç”¨æœ¬æ¥å£æ¥è·å–access_tokenã€‚\nç”¨æˆ·ç‚¹å‡»Webç™»å½• =\u003e å•†æˆ·åç«¯ =\u003e è·å–å…¬ä¼—å·ç™»å½•å‡­è¯(è¯·æ±‚å¾®ä¿¡äºŒç»´ç æ¥å£ï¼Œè·å–å¯¹åº”çš„ticketï¼Œç”¨äºè·å–å¾®ä¿¡å…¬ä¼—å·çš„äºŒç»´ç ) ç„¶åï¼Œå‰ç«¯æ ¹æ®ticketå»å¾®ä¿¡ç³»ç»Ÿè·å–å¯¹åº”çš„äºŒç»´ç ï¼Œè¿›è¡Œç™»å½• ç™»å½•æˆåŠŸåï¼Œå¾®ä¿¡ä¼šå›è°ƒå…¬ä¼—å·å¯¹åº”çš„å›è°ƒæ¥å£ï¼Œè¿™æ—¶å€™ï¼Œåç«¯å¯ä»¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚ ï¼ˆopenidæ ‡è¯†ç”¨æˆ·ï¼‰ å‰ç«¯å†æ‹¿ticketè¿›è¡Œç™»å½•æ ¡éªŒï¼Œç™»å½•æˆåŠŸåï¼Œè¿”å›Tokenä»¤ç‰Œå°±å¥½äº†ã€‚ â­\néœ€è¦å®ç°è¯·æ±‚äºŒç»´ç ç™»å½•å‡­è¯çš„Apiæ¥å£ï¼› éœ€è¦å®ç°å¾®ä¿¡ç™»å½•å›è°ƒçš„Apiæ¥å£ï¼Œä¿å­˜ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼› éœ€è¦å®ç°ç”¨æˆ·ç™»å½•æ ¡éªŒçš„æ¥å£ï¼Œç”ŸæˆTokenä»¤ç‰Œï¼Œåç»­è¯·æ±‚ç”¨è¿™ä¸ªã€‚ å¾®ä¿¡æ”¯ä»˜æµç¨‹ è¯·æ±‚ä¸‹å•æ¥å£ =\u003e åç«¯åˆ›å»ºè®¢å•(åˆ›å»º) =\u003e è¯·æ±‚å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿ(åˆ›å»ºæ”¯ä»˜è®¢å•),åç«¯è®¢å•(å¾…ä»˜æ¬¾)ï¼›æœ€åè¿”å›æ‹‰èµ·æ”¯ä»˜çš„å‚æ•°ï¼› å°ç¨‹åºæ‹‰èµ·å¾®ä¿¡æ”¶é“¶å° å›è°ƒå°ç¨‹åºæ”¯ä»˜çŠ¶æ€ï¼Œå°ç¨‹åºæŸ¥è¯¢å•†æˆ·åç«¯è®¢å•çŠ¶æ€ =\u003e åç«¯æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿ =\u003e â€¦ =\u003e è¿”å›æ”¯ä»˜çŠ¶æ€ ç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œä¼šå›è°ƒé€šçŸ¥å•†æˆ·åç«¯ã€‚â­éœ€è¦å®ç°å›è°ƒçš„æ¥å£ï¼Œä¿æŒæ”¯ä»˜é€šçŸ¥(æ”¹åç«¯è®¢å•çŠ¶æ€: å·²æ”¯ä»˜) æœªæ”¶åˆ°å›è°ƒé€šçŸ¥ï¼Œéœ€è¦å•†æˆ·åç«¯ä¸»åŠ¨æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜çš„æŸ¥è¯¢æ¥å£ã€‚ è¶…æ—¶ =\u003e å•†æˆ·åç«¯ä¸»åŠ¨è°ƒç”¨å¾®ä¿¡å…³å•æ¥å£ (è®¢å•çŠ¶æ€ï¼šæ”¯ä»˜å¤±è´¥|è¶…æ—¶) é€€æ¬¾ =\u003e å•†æˆ·åç«¯è¯·æ±‚å¾®ä¿¡æ”¯ä»˜é€€æ¬¾æ¥å£ (è®¢å•çŠ¶æ€ï¼šé€€æ¬¾) â­\néœ€è¦å®ç°çš„æ¥å£ï¼š\nå•†æˆ·åç«¯åˆ›å»ºåˆå§‹è®¢å•ï¼Œå¹¶è¯·æ±‚å¾®ä¿¡æ”¯ä»˜ç”Ÿæˆæ”¯ä»˜è®¢å•çš„Apiæ¥å£ï¼›(æ£€æŸ¥è®¢å•å¹‚ç­‰æ€§) æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å›è°ƒçš„Apiæ¥å£ï¼Œä¿®æ”¹è®¢å•æ”¯ä»˜çŠ¶æ€ï¼› ä¸»åŠ¨æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€çš„æ¥å£ï¼Œè°ƒç”¨å¾®ä¿¡æ”¯ä»˜çš„æŸ¥è¯¢æ¥å£ã€‚ è¶…æ—¶ =\u003e å•†æˆ·åç«¯ä¸»åŠ¨è°ƒç”¨å¾®ä¿¡å…³å•æ¥å£ (è®¢å•çŠ¶æ€ï¼šæ”¯ä»˜å¤±è´¥|è¶…æ—¶)çš„Apiæ¥å£ é€€æ¬¾ =\u003e å•†æˆ·åç«¯è¯·æ±‚å¾®ä¿¡æ”¯ä»˜é€€æ¬¾æ¥å£ (è®¢å•çŠ¶æ€ï¼šé€€æ¬¾)çš„Apiæ¥å£ ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£ ç´«è‰²åœˆï¼šæ‹¼å›¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼›\nç°è‰²åœˆï¼šå•†å“ä¿¡æ¯ï¼›\nçº¢è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼ŒéšæœºæŒ‘é€‰å‡ ä¸ªå›¢ï¼›\nç»¿è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼›å•ç‹¬å¼€å§‹ä¸€ä¸ªæ–°çš„å›¢ï¼Œè¿˜æ˜¯å‚ä¸å…¶ä»–äººçš„å›¢\né»„è‰²åœˆï¼šæ‹¼å›¢ç»“ç®—ã€‚\nResponseDTO\n1@Data 2@Builder 3@AllArgsConstructor 4@NoArgsConstructor 5public class GoodsMarketResponseDTO { 6 7 private Goods goods; 8 private List\u003cTeam\u003e teamList; 9 private TeamStatistic teamStatistic; 10 11 /** 12 * å•†å“ä¿¡æ¯ 13 */ 14 @Data 15 @Builder 16 @AllArgsConstructor 17 @NoArgsConstructor 18 public static class Goods { 19 // å•†å“ID 20 private String goodsId; 21 // åŸå§‹ä»·æ ¼ 22 private BigDecimal originalPrice; 23 // æŠ˜æ‰£é‡‘é¢ 24 private BigDecimal deductionPrice; 25 // æ”¯ä»˜ä»·æ ¼ 26 private BigDecimal payPrice; 27 } 28 29 /** 30 * ç»„é˜Ÿä¿¡æ¯ 31 */ 32 @Data 33 @Builder 34 @AllArgsConstructor 35 @NoArgsConstructor 36 public static class Team { 37 // ç”¨æˆ·ID 38 private String userId; 39 // æ‹¼å•ç»„é˜ŸID 40 private String teamId; 41 // æ´»åŠ¨ID 42 private Long activityId; 43 // ç›®æ ‡æ•°é‡ 44 private Integer targetCount; 45 // å®Œæˆæ•°é‡ 46 private Integer completeCount; 47 // é”å•æ•°é‡ 48 private Integer lockCount; 49 // æ‹¼å›¢å¼€å§‹æ—¶é—´ - å‚ä¸æ‹¼å›¢æ—¶é—´ 50 private Date validStartTime; 51 // æ‹¼å›¢ç»“æŸæ—¶é—´ - æ‹¼å›¢æœ‰æ•ˆæ—¶é•¿ 52 private Date validEndTime; 53 // å€’è®¡æ—¶(å­—ç¬¦ä¸²) validEndTime - validStartTime 54 private String validTimeCountdown; 55 /** å¤–éƒ¨äº¤æ˜“å•å·-ç¡®ä¿å¤–éƒ¨è°ƒç”¨å”¯ä¸€å¹‚ç­‰ */ 56 private String outTradeNo; 57 58 public static String differenceDateTime2Str(Date validStartTime, Date validEndTime) { 59 if (validStartTime == null || validEndTime == null) { 60 return \"æ— æ•ˆçš„æ—¶é—´\"; 61 } 62 63 long diffInMilliseconds = validEndTime.getTime() - validStartTime.getTime(); 64 65 if (diffInMilliseconds \u003c 0) { 66 return \"å·²ç»“æŸ\"; 67 } 68 69 long seconds = TimeUnit.MILLISECONDS.toSeconds(diffInMilliseconds) % 60; 70 long minutes = TimeUnit.MILLISECONDS.toMinutes(diffInMilliseconds) % 60; 71 long hours = TimeUnit.MILLISECONDS.toHours(diffInMilliseconds) % 24; 72 long days = TimeUnit.MILLISECONDS.toDays(diffInMilliseconds); 73 74 return String.format(\"%02d:%02d:%02d\", hours, minutes, seconds); 75 } 76 77 } 78 79 80 /** 81 * ç»„é˜Ÿç»Ÿè®¡ 82 */ 83 @Data 84 @Builder 85 @AllArgsConstructor 86 @NoArgsConstructor 87 public static class TeamStatistic { 88 // å¼€å›¢é˜Ÿä¼æ•°é‡ 89 private Integer allTeamCount; 90 // æˆå›¢é˜Ÿä¼æ•°é‡ 91 private Integer allTeamCompleteCount; 92 // å‚å›¢äººæ•°æ€»é‡ - ä¸€ä¸ªå•†å“çš„æ€»å‚å›¢äººæ•° 93 private Integer allTeamUserCount; 94 } 95 96} 1// å¢åˆ æ”¹æŸ¥ 2// æ³¨æ„ï¼šTeamçš„æŸ¥è¯¢ 3// 1. å…ˆæŸ¥è‡ªå·±çš„æ‹¼å›¢ 4// 2. æŸ¥å…¶ä»–äººçš„æ‹¼å›¢ã€‚å¯¹åº”æ´»åŠ¨ï¼Œéå½“å‰ç”¨æˆ·ï¼ŒçŠ¶æ€ä¸ºå¯åŠ å…¥æ‹¼å›¢ï¼Œæ—¶é—´æœ‰æ•ˆï¼Œé˜Ÿä¼in(å¯¹åº”æ´»åŠ¨ï¼Œä¸”é”å•äººæ•°å°äºç›®æ ‡äººæ•°) 5 6@Override 7public List\u003cUserGroupBuyOrderDetailEntity\u003e queryInProgressUserGroupBuyOrderDetailListByRandom(Long activityId, String userId, Integer randomCount) { 8 // 1. æ ¹æ®ç”¨æˆ·IDã€æ´»åŠ¨IDã€æŸ¥è¯¢éå½“å‰ç”¨æˆ·å‚ä¸çš„æ‹¼å›¢é˜Ÿä¼ 9 GroupBuyOrderList buyOrderListReq = GroupBuyOrderList.builder() 10 .activityId(activityId) 11 .userId(userId) 12 .build(); 13 buyOrderListReq.setCount(randomCount * 2); // æŸ¥è¯¢ä¸¤å€çš„é‡ï¼Œå†éšæœºå–ä¸€åŠ 14 15 // 1. ==ActivityId; 2. !=userId 3; status == 0 or 1; 4. endTime \u003e now(); 5. teamId in (select teamId from group_buy_order where status = 0 and activity = #{activity}) 16 List\u003cGroupBuyOrderList\u003e groupBuyOrderLists = groupBuyOrderListDao.queryInProgressUserGroupBuyOrderDetailListByRandom(buyOrderListReq); 17 if (groupBuyOrderLists == null || groupBuyOrderLists.isEmpty()) 18 return null; 19 20 // éšæœºé€‰ randomCount æ¡ 21 if (groupBuyOrderLists.size() \u003e randomCount) { 22 Collections.shuffle(groupBuyOrderLists); 23 groupBuyOrderLists = groupBuyOrderLists.subList(0, randomCount); 24 } 25 26 // 2. è¿‡æ»¤é˜Ÿä¼è·å– TeamId 27 Set\u003cString\u003e teamIds = groupBuyOrderLists.stream().map(GroupBuyOrderList::getTeamId) 28 .filter(teamId -\u003e teamId != null \u0026\u0026 !teamId.isEmpty()) 29 .collect(Collectors.toSet()); 30 31 32 // 3. æŸ¥è¯¢é˜Ÿä¼æ˜ç»†ï¼Œç»„è£…Mapç»“æ„ 33 List\u003cGroupBuyOrder\u003e groupBuyOrders = groupBuyOrderDao.queryGroupBuyProgressByTeamIds(teamIds); 34 if (groupBuyOrders == null || groupBuyOrders.isEmpty()) return null; 35 36 Map\u003cString, GroupBuyOrder\u003e groupBuyOrderMap = groupBuyOrders.stream() 37 .collect(Collectors.toMap(GroupBuyOrder::getTeamId, order -\u003e order)); 38 39 // 4. è½¬æ¢æ•°æ® 40 ArrayList\u003cUserGroupBuyOrderDetailEntity\u003e userGroupBuyOrderDetailEntities = new ArrayList\u003c\u003e(); 41 // ... æ ¹æ® groupBuyOrders å’Œ groupBuyOrderListsç»„è£…ç»“æœ 42 43 return userGroupBuyOrderDetailEntities; 44} 1// é”å• æ¥å£ 2â¬‡ï¸ 3// outTradeNo - è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ç”Ÿæˆ 4â¬‡ï¸ 5// ç»“ç®— æ¥å£ ç¬¬2-16èŠ‚ ç‹¬å é”å’Œæ— é”åŒ– ä¸€ä¸ªåº“å­˜ä¸€ä¸ªé”ï¼Œæœ€å°åŒ–é”çš„ç²’åº¦ï¼Œä½¿ç”¨occupyCount + recoveryCount åˆ¤æ–­åº“å­˜ã€‚å› ä¸ºä¹‹å‰çš„çº¿ç¨‹æŠ¢å äº†åº“å­˜ï¼Œä½†æ˜¯æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦æ¢å¤è¢«æŠ¢å çš„åº“å­˜é‡ã€‚\n**ç‹¬å é”ï¼š**å¤šä¸ªæœåŠ¡å‡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œä»…ä¸€ä¸ªæœåŠ¡æ‰§è¡Œå³å¯ã€‚\n1@Scheduled(cron = \"0 0 0 * * ?\") 2public void exec() { 3 RLock lock = redissonClient.getLock(\"group_buy_market_notify_job_exec\"); 4 try { 5 // ç­‰å¾…æ—¶é—´(è‹¥è¢«å ç”¨ç­‰å¾…3ç§’)ï¼Œé”çš„è¿‡æœŸæ—¶é—´(0è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨é‡Šæ”¾) 6 boolean isLocked = lock.tryLock(3, 0, TimeUnit.SECONDS); 7 if (!isLocked) return; 8 9 Map\u003cString, Integer\u003e result = tradeSettlementOrderService.execSettlementNotifyJob(); 10 log.info(\"å®šæ—¶ä»»åŠ¡ï¼Œå›è°ƒé€šçŸ¥æ‹¼å›¢å®Œç»“ä»»åŠ¡ result:{}\", JSON.toJSONString(result)); 11 } catch (Exception e) { 12 log.error(\"å®šæ—¶ä»»åŠ¡ï¼Œå›è°ƒé€šçŸ¥æ‹¼å›¢å®Œç»“ä»»åŠ¡å¤±è´¥\", e); 13 } finally { 14 if (lock.isLocked() \u0026\u0026 lock.isHeldByCurrentThread()) { 15 lock.unlock(); 16 } 17 } 18} ä¹è§‚é”ï¼š\nå°†åº“å­˜çš„éš”ç¦»è¿›è¡Œåˆ†æ®µåŒ–ï¼Œä¸€ä¸ªåº“å­˜è¡¨ç¤ºä¸€ä¸ªé”\n1// æ‹¼å›¢äººæ•°æ£€æŸ¥-æ˜¯å¦å·²æ»¡ 2// 1. teamId ä¸ºç©ºï¼Œåˆ™ä¸ºé¦–æ¬¡å¼€å›¢ï¼Œä¸åšæ‹¼å›¢ç»„é˜Ÿç›®æ ‡é‡åº“å­˜é™åˆ¶ 3String teamId = requestParameter.getTeamId(); 4if (StringUtils.isBlank(teamId)) { 5 return TradeLockRuleFilterBackEntity.builder() 6 .userTakeOrderCount(dynamicContext.getUserTakeOrderCount()) 7 .build(); 8} 9 10// 2. æŠ¢å åº“å­˜ï¼›é€šè¿‡æŠ¢å  Redis ç¼“å­˜åº“å­˜ï¼Œæ¥é™ä½å¯¹æ•°æ®åº“çš„æ“ä½œå‹åŠ›ã€‚ 11// ä¸Šä¸‹æ–‡ä¿¡æ¯ 12GroupBuyActivityEntity groupBuyActivity = dynamicContext.getGroupBuyActivity(); 13Integer target = groupBuyActivity.getTarget(); 14Integer validTime = groupBuyActivity.getValidTime(); 15String teamStockKey = dynamicContext.generateTeamStockKey(teamId); 16String recoveryTeamStockKey = dynamicContext.generateRecoveryTeamStockKey(teamId); 17 18// æŠ¢å åº“å­˜ 19boolean status = repository.occupyTeamStock(teamStockKey, recoveryTeamStockKey, target, validTime); æŠ¢å åº“å­˜\n1public boolean occupyTeamStock(String teamStockKey, String recoveryTeamStockKey, Integer target, Integer validTime) { 2 // å¤±è´¥æ¢å¤é‡ 3 Long recoveryCount = redisService.getAtomicLong(recoveryTeamStockKey); 4 recoveryCount = null == recoveryCount ? 0 : recoveryCount; 5 6 // 1. incr å¾—åˆ°å€¼ï¼Œä¸æ€»é‡å’Œæ¢å¤é‡åšå¯¹æ¯”ã€‚æ¢å¤é‡ä¸ºç³»ç»Ÿå¤±è´¥æ—¶å€™è®°å½•çš„é‡ã€‚ 7 // 2. ä»æœ‰ç»„é˜Ÿé‡å¼€å§‹ï¼Œç›¸å½“äºå·²ç»æœ‰äº†ä¸€ä¸ªå ç”¨é‡ï¼Œæ‰€ä»¥è¦ +1 8 long occupy = redisService.incr(teamStockKey) + 1; 9 10 if (occupy \u003e= target + recoveryCount) { 11 redisService.setAtomicLong(teamStockKey, target); 12 return false; 13 } 14 15 // 1. ç»™æ¯ä¸ªäº§ç”Ÿçš„å€¼åŠ é”ä¸ºå…œåº•è®¾è®¡ï¼Œè™½ç„¶incræ“ä½œæ˜¯åŸå­çš„ï¼ŒåŸºæœ¬ä¸ä¼šäº§ç”Ÿä¸€æ ·çš„å€¼ã€‚ä½†åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œé‡åˆ°è¿‡é›†ç¾¤çš„è¿ç»´é…ç½®é—®é¢˜ï¼Œä»¥åŠä¸šåŠ¡è¿è¥é…ç½®æ•°æ®é—®é¢˜ï¼Œå¯¼è‡´incrå¾—åˆ°çš„å€¼ç›¸åŒã€‚ 16 // 2. validTime + 60åˆ†é’Ÿï¼Œæ˜¯ä¸€ä¸ªå»¶åæ—¶é—´çš„è®¾è®¡ï¼Œè®©æ•°æ®ä¿ç•™æ—¶é—´ç¨å¾®é•¿ä¸€äº›ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚ 17 String lockKey = teamStockKey + Constants.UNDERLINE + occupy; 18 Boolean lock = redisService.setNx(lockKey, validTime + 60, TimeUnit.MINUTES); 19 20 if (!lock) { 21 log.info(\"ç»„é˜Ÿåº“å­˜åŠ é”å¤±è´¥ {}\", lockKey); 22 } 23 24 return lock; 25} æ¢å¤åº“å­˜ \u003c= ä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦è¿›è¡Œåº“å­˜çš„æ¢å¤ï¼\n1@Override 2public void recoveryTeamStock(String recoveryTeamStockKey, Integer validTime) { 3 // é¦–æ¬¡ç»„é˜Ÿæ‹¼å›¢ï¼Œæ˜¯æ²¡æœ‰ teamId çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿™ä¸ªåšå¤„ç†ã€‚ 4 if (StringUtils.isBlank(recoveryTeamStockKey)) return; 5 redisService.incr(recoveryTeamStockKey); 6} ",
  "wordCount" : "4572",
  "inLanguage": "en",
  "image": "http://longcoding.top/papermod-cover.png","datePublished": "2025-03-23T19:36:21+08:00",
  "dateModified": "2025-03-23T19:36:21+08:00",
  "author":{
    "@type": "Person",
    "name": "ğŸ‘¨ğŸ»â€ğŸ“ LongWei"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://longcoding.top/posts/jobs/groupbuymarketproject/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LongCoding's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://longcoding.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://longcoding.top/" accesskey="h" title="ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“° (Alt + H)">
                <img src="http://longcoding.top/android-icon-48x48.png" alt="" aria-label="logo"
                    height="30">ğ“›ğ“¸ğ“·ğ“°ğ“’ğ“¸ğ“­ğ“²ğ“·ğ“°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://longcoding.top/index.html" title="ğŸ¡ Home">
                    <span>ğŸ¡ Home</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/archives/" title="ğŸ“ƒ Archives">
                    <span>ğŸ“ƒ Archives</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/tags/" title="ğŸ“‘ Tags">
                    <span>ğŸ“‘ Tags</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/categories/" title="ğŸ—’ï¸ Categories">
                    <span>ğŸ—’ï¸ Categories</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/search/" title="ğŸ” Search">
                    <span>ğŸ” Search</span>
                </a>
            </li>
            <li>
                <a href="http://longcoding.top/about/" title="ğŸ‘¨ğŸ»â€ğŸ“ About Me">
                    <span>ğŸ‘¨ğŸ»â€ğŸ“ About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://longcoding.top/">Home</a>&nbsp;Â»&nbsp;<a href="http://longcoding.top/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      æ‹¼å›¢è¥é”€äº¤æ˜“æ‹¼å›¢
    </h1>
    <div class="post-description">
      Grouptradingproject
    </div>
    <div class="post-meta"><span title='2025-03-23 19:36:21 +0800 CST'>March 23, 2025</span>&nbsp;Â·&nbsp;22 min&nbsp;Â·&nbsp;4572 words&nbsp;Â·&nbsp;ğŸ‘¨ğŸ»â€ğŸ“ LongWei

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e5%b9%b3%e5%8f%b0%e7%b3%bb%e7%bb%9f" aria-label="æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e7%ac%ac1-2%e8%8a%82-%e6%8b%bc%e5%9b%a2%e5%ba%93%e8%a1%a8%e8%ae%be%e8%ae%a1" aria-label="ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡">ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac1-3%e8%8a%82-%e7%a0%94%e5%8f%91%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1" aria-label="ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡">ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-2%e8%8a%82-%e8%af%95%e7%ae%97%e6%a8%a1%e5%9e%8b%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-3%e8%8a%82-%e5%a4%9a%e7%ba%bf%e7%a8%8b%e5%bc%82%e6%ad%a5%e6%95%b0%e6%8d%ae%e5%8a%a0%e8%bd%bd" aria-label="ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½</a></li>
                <li>
                    <a href="#%e7%ac%ac2-4%e8%8a%82-%e7%ad%96%e7%95%a5%e6%a8%a1%e5%bc%8f%e4%bc%98%e6%83%a0%e6%8a%98%e6%89%a3%e8%ae%a1%e7%ae%97" aria-label="ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">ç¬¬2-4èŠ‚ ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—</a></li>
                <li>
                    <a href="#%e7%ac%ac2-5%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e6%95%b0%e6%8d%ae%e9%87%87%e9%9b%86" aria-label="ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†</a></li>
                <li>
                    <a href="#%e7%ac%ac2-6%e8%8a%82-%e5%ba%93%e8%a1%a8%e6%8b%86%e5%88%86" aria-label="ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†">ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†</a></li>
                <li>
                    <a href="#%e7%ac%ac2-7%e8%8a%82-%e4%ba%ba%e7%be%a4%e6%a0%87%e7%ad%be%e8%8a%82%e7%82%b9%e8%bf%87%e6%bb%a4" aria-label="ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-8%e8%8a%82--%e5%8a%a8%e6%80%81%e9%85%8d%e7%bd%ae%e5%bc%80%e5%85%b3%e6%93%8d%e4%bd%9c" aria-label="ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ</a></li>
                <li>
                    <a href="#%e7%ac%ac2-9%e8%8a%82-%e6%8b%bc%e5%9b%a2%e4%ba%a4%e6%98%93%e8%90%a5%e9%94%80%e9%94%81%e5%8d%95" aria-label="ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•</a></li>
                <li>
                    <a href="#%e7%ac%ac2-10%e8%8a%82-%e8%b4%a3%e4%bb%bb%e9%93%be%e6%8a%bd%e8%b1%a1%e6%a8%a1%e6%9d%bf%e8%ae%be%e8%ae%a1" aria-label="ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-11%e8%8a%82-%e4%ba%a4%e6%98%93%e8%a7%84%e5%88%99%e8%b4%a3%e4%bb%bb%e9%93%be%e8%bf%87%e6%bb%a4" aria-label="ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-12%e8%8a%82%e6%8b%bc%e5%9b%a2%e7%bb%84%e9%98%9f%e7%bb%93%e7%ae%97%e7%bb%9f%e8%ae%a1" aria-label="ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡</a></li>
                <li>
                    <a href="#%e7%ac%ac2-13%e8%8a%82%e4%ba%a4%e6%98%93%e7%bb%93%e7%ae%97%e8%b4%a3%e4%bb%bb%e9%93%be%e8%bf%87%e6%bb%a4" aria-label="ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤">ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤</a></li>
                <li>
                    <a href="#%e7%ac%ac2-14%e8%8a%82%e6%8b%bc%e5%9b%a2%e5%9b%9e%e8%b0%83%e9%80%9a%e7%9f%a5%e4%bb%bb%e5%8a%a1" aria-label="ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡">ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡</a><ul>
                        
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%89%ab%e6%8f%8f%e7%99%bb%e5%bd%95%e6%b5%81%e7%a8%8b" aria-label="å¾®ä¿¡æ‰«æç™»å½•æµç¨‹">å¾®ä¿¡æ‰«æç™»å½•æµç¨‹</a></li>
                <li>
                    <a href="#%e5%be%ae%e4%bf%a1%e6%94%af%e4%bb%98%e6%b5%81%e7%a8%8b" aria-label="å¾®ä¿¡æ”¯ä»˜æµç¨‹">å¾®ä¿¡æ”¯ä»˜æµç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2-15%e8%8a%82%e6%a0%b9%e6%8d%aeui%e5%b1%95%e7%a4%ba%e5%b0%81%e8%a3%85%e6%8e%a5%e5%8f%a3" aria-label="ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£">ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£</a></li>
                <li>
                    <a href="#%e7%ac%ac2-16%e8%8a%82-%e7%8b%ac%e5%8d%a0%e9%94%81%e5%92%8c%e6%97%a0%e9%94%81%e5%8c%96" aria-label="ç¬¬2-16èŠ‚ ç‹¬å é”å’Œæ— é”åŒ–">ç¬¬2-16èŠ‚ ç‹¬å é”å’Œæ— é”åŒ–</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#æ‹¼å›¢äº¤æ˜“å¹³å°ç³»ç»Ÿ">#</a></h1>
<p>**é¡¹ç›®èƒŒæ™¯ï¼š**ä¸ºäº†ç›˜æ´»æ²‰ç¡ç”¨æˆ·ï¼Œéœ€è¦é€‚å½“é™ä½å•†å“ä»·æ ¼ã€‚ä½†ä¸ºäº†è¾¾åˆ°ä¼ æ’­çš„æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥æ‹¼å›¢æ–¹å¼ï¼Œä»¥å®¢å¸¦å®¢ï¼Œé ç”¨æˆ·è‡ªèº«ä¼ æ’­çš„æ–¹å¼è¿›è¡Œäº¤æ˜“æ‹‰æ–°ã€‚è¿™æ ·çš„å¤„ç†æ–¹å¼å¯¹æ¯”äº KOLï¼Œä¼šè®©åˆ©å•†å“ä»·å€¼åˆ°ç”¨æˆ·è‡ªèº«ã€‚</p>
<h3 id="ç¬¬1-2èŠ‚-æ‹¼å›¢åº“è¡¨è®¾è®¡">ç¬¬1-2èŠ‚ æ‹¼å›¢åº“è¡¨è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1-2èŠ‚-æ‹¼å›¢åº“è¡¨è®¾è®¡">#</a></h3>
<p><em><strong>ä¸šåŠ¡æµç¨‹ï¼š</strong></em></p>
<p><img alt="image-20250323194301660" loading="lazy" src="http://verification.longcoding.top/FiI6jzJ8l7NKoKgTZcSoz3LzJqL1"></p>
<ul>
<li><em>è¿è¥è§’åº¦ï¼š</em> 1. ç»™å“ªäº›å•†å“é…ç½®æ‹¼å•ï¼›2. æ‹¼å›¢å•†å“æä¾›çš„è§„åˆ™ä¿¡æ¯ï¼šæŠ˜æ‰£ã€æ—¶é—´ã€äººæ•°ç­‰ã€‚</li>
<li><em>ç”¨æˆ·è§’åº¦ï¼š</em> 1. å‚ä¸æ‹¼å›¢ï¼Œé¦–æ¬¡å‘èµ·orå‚ä¸ç°æœ‰ï¼Œæ‹¼å•å®Œæˆå›è°ƒé€šçŸ¥ã€‚</li>
<li><em>åº“è¡¨è®¾è®¡ï¼š</em> 1. äººç¾¤è®¾è®¡ï¼Œå°†æ‰€æœ‰ç¬¦åˆæŸä¸ªæ¡ä»¶çš„ç”¨æˆ·IDï¼Œå…¨éƒ¨å†™å…¥ç‰¹å®šRedisè®°å½•ä¸­ã€‚</li>
<li>æ‹¼å›¢æ´»åŠ¨ï¼ŒæŠ˜æ‰£çš„å¤šç§è¿­ä»£ã€‚</li>
</ul>
<p><strong>åº“è¡¨è®¾è®¡ï¼š</strong></p>
<p><em>æ‹¼å›¢é…ç½®è¡¨</em>ï¼š</p>
<p><img alt="image-20250323194814202" loading="lazy" src="http://verification.longcoding.top/FkAG47W_Dvi0nh84V_dSOYU0Ljd2"></p>
<ul>
<li>æ‹¼å›¢æ´»åŠ¨è¡¨ï¼šè®¾å®šäº†æ‹¼å›¢çš„æˆå›¢è§„åˆ™ï¼Œäººç¾¤æ ‡ç­¾çš„ä½¿ç”¨å¯ä»¥é™å®šå“ªäº›äººå¯è§ï¼Œå“ªäº›äººå¯å‚ä¸ã€‚</li>
<li>æŠ˜æ‰£é…ç½®è¡¨ï¼šæ‹†åˆ†å‡ºæ‹¼å›¢ä¼˜æƒ åˆ°ä¸€ä¸ªæ–°çš„è¡¨è¿›è¡Œå¤šæ¡é…ç½®ã€‚å¦‚æœæŠ˜æ‰£è¿˜æœ‰æ›´å¤šçš„å¤æ‚è§„åˆ™ï¼Œåˆ™å¯ä»¥é…ç½®æ–°çš„æŠ˜æ‰£è§„åˆ™è¡¨è¿›è¡Œå¤„ç†ã€‚</li>
<li>äººç¾¤æ ‡ç­¾è¡¨ï¼šä¸“é—¨æ¥åšäººç¾¤è®¾è®¡è®°å½•çš„ï¼Œè¿™3å¼ è¡¨å°±æ˜¯ä¸ºäº†æŠŠç¬¦åˆè§„åˆ™çš„äººç¾¤IDï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·IDï¼Œå…¨éƒ¨è·‘ä»»åŠ¡åˆ°ä¸€ä¸ªè®°å½•ä¸‹è¿›è¡Œä½¿ç”¨ã€‚ æ¯”å¦‚é»‘ç«ç‘°äººç¾¤ã€é«˜å‡€å€¼äººç¾¤ã€æ‹¼å›¢å±¥çº¦ç‡90%ä»¥ä¸Šçš„äººç¾¤ç­‰ã€‚</li>
</ul>
<p><em><strong>å‚ä¸æ‹¼å›¢è¡¨ï¼š</strong></em></p>
<p><img alt="image-20250323195108167" loading="lazy" src="http://verification.longcoding.top/FqOAEF4N91PNEdxvKoW0qT4GLpgt"></p>
<ul>
<li>æ‹¼å›¢è´¦æˆ·è¡¨ï¼šè®°å½•ç”¨æˆ·çš„æ‹¼å›¢å‚ä¸æ•°æ®ï¼Œä¸€ä¸ªæ˜¯ä¸ºäº†é™åˆ¶ç”¨æˆ·çš„å‚ä¸æ‹¼å›¢æ¬¡æ•°ï¼Œå¦å¤–æ˜¯ä¸ºäº†äººç¾¤æ ‡ç­¾ä»»åŠ¡ç»Ÿè®¡æ•°æ®ã€‚</li>
<li>ç”¨æˆ·æ‹¼å•è¡¨ï¼šå½“æœ‰ç”¨æˆ·å‘èµ·é¦–æ¬¡æ‹¼å•çš„æ—¶å€™ï¼Œäº§ç”Ÿæ‹¼å•idï¼Œå¹¶è®°å½•æ‰€éœ€æˆå›¢çš„æ‹¼å•è®°å½•ï¼Œå¦å¤–æ˜¯å†™ä¸Šæ‹¼å›¢çš„çŠ¶æ€ã€å”¯ä¸€ç´¢å¼•ã€å›è°ƒæ¥å£ç­‰ã€‚è¿™æ ·æ‹¼å›¢å®Œæˆå°±å¯ä»¥å›è°ƒå¯¹æ¥çš„å¹³å°ï¼Œé€šçŸ¥å®Œæˆäº†ã€‚ã€å¾®ä¿¡æ”¯ä»˜ä¹Ÿæ˜¯è¿™æ ·çš„è®¾è®¡ï¼Œå›è°ƒæ”¯ä»˜ç»“æœï¼Œè¿™æ ·çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿å¹³å°åŒ–å¯¹æ¥ã€‘å½“å†æœ‰ç”¨æˆ·å‚ä¸åï¼Œåˆ™å†™å…¥ç”¨æˆ·æ‹¼å•æ˜ç»†è¡¨ã€‚ç›´è‡³è¾¾æˆæ‹¼å›¢</li>
<li>å›è°ƒä»»åŠ¡è¡¨ï¼šå½“æ‹¼å›¢å®Œæˆåï¼Œè¦åšå›è°ƒå¤„ç†ã€‚ä½†å¯èƒ½ä¼šæœ‰å¤±è´¥ï¼Œæ‰€ä»¥åŠ å…¥ä»»åŠ¡çš„æ–¹å¼è¿›è¡Œè¡¥å¿ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œåˆ™éœ€è¦å¯¹æ¥çš„å¹³å°ï¼Œè‡ªå·±æŸ¥è¯¢æ‹¼å›¢ç»“æœã€‚</li>
</ul>
<h3 id="ç¬¬1-3èŠ‚-ç ”å‘ç³»ç»Ÿè®¾è®¡">ç¬¬1-3èŠ‚ ç ”å‘ç³»ç»Ÿè®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1-3èŠ‚-ç ”å‘ç³»ç»Ÿè®¾è®¡">#</a></h3>
<p>è¿›è¡Œç ”å‘ç³»ç»Ÿè®¾è®¡ã€‚åŒ…æ‹¬ï¼šåº“è¡¨è®¾è®¡ã€ç”¨ä¾‹å›¾ã€ç³»ç»Ÿå»ºæ¨¡ã€å·¥ç¨‹æ¨¡å‹ã€åŠŸèƒ½æµç¨‹ã€UMLæ—¶åºå›¾ã€‚</p>
<ul>
<li>ç”¨ä¾‹å›¾ï¼šç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’æœ€ç®€è¡¨ç¤ºå½¢å¼ï¼›</li>
<li>æµç¨‹å›¾ï¼šåŠŸèƒ½èŠ‚ç‚¹çš„ä¸²è”å…³ç³»ï¼›</li>
<li>æ—¶åºå›¾ï¼šå±•ç¤ºäº†æ•´ä¸ªæ‹¼å›¢è¿‡ç¨‹æ‰€æ¶‰åŠçš„ç³»ç»Ÿæ¨¡å—å’Œæµè½¬å…³ç³»</li>
</ul>
<p><strong>ç³»ç»Ÿæ¶æ„ï¼š</strong></p>
<p><em>MVCæ¶æ„</em></p>
<img src="http://verification.longcoding.top/FputTQmCOc_DT9IHR_Tue1UphgiB" alt="image-20250323200411716" style="zoom:50%;" />
<p><em>DDDæ¶æ„</em></p>
<img src="http://verification.longcoding.top/FtLoDQWtMfo0Tws2aSwFoLOq9d4a" alt="image-20250323200448795" style="zoom:50%;" />
<h3 id="ç¬¬2-2èŠ‚-è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-2èŠ‚ è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-2èŠ‚-è¯•ç®—æ¨¡å‹æŠ½è±¡æ¨¡æ¿è®¾è®¡">#</a></h3>
<p><em><strong>å¼•å…¥è®¾è®¡æ¨¡å¼è¿›è¡Œè§£è€¦å’Œå®ç°ï¼Œæé«˜å·¥ç¨‹ä»£ç çš„æ‰©å±•æ€§</strong></em></p>
<p>=&gt; è®¾è®¡æ¨¡å¼æŠ½è±¡æ¨¡æ¿çš„é€šç”¨ç»“æ„å®šä¹‰ï¼Œæ·»åŠ ä¸€ä¸ª treeè§„åˆ™æ ‘æŠ½è±¡æ¨¡å‹ï¼Œåœ¨å¼•å…¥åˆ°å·¥ç¨‹ä¸­è¿›è¡Œä½¿ç”¨ã€‚è¿™æ ·åç»­å·¥ç¨‹ä¸­å°±å¯ä»¥ä¸æ–­çš„å®šä¹‰é€šç”¨çš„è®¾è®¡æ¨¡å¼è¢«ä¸åŒçš„åœºæ™¯ç»Ÿä¸€ä½¿ç”¨äº†ã€‚</p>
<p><strong>æ¨¡å‹è®¾è®¡</strong></p>
<p>é“¾å¼çš„å¤šåˆ†æ”¯è§„åˆ™æ ‘æ¨¡å‹ç»“æ„ï¼Œç”±åŠŸèƒ½èŠ‚ç‚¹è‡ªè¡Œå†³å®šåç»­æµç¨‹çš„æ‰§è¡Œé“¾è·¯ã€‚å®ƒçš„è®¾è®¡æ¯”è´£ä»»é“¾çš„æ‰©å±•æ€§æ›´å¥½ï¼Œè‡ªç”±åº¦ä¹Ÿæ›´é«˜</p>
<img src="http://verification.longcoding.top/Fs14rhSCUv1G2iJDaNAYovqrgCtI" alt="image-20250323212011895" style="zoom:50%;" />
<ul>
<li>é¦–å…ˆï¼Œå®šä¹‰æŠ½è±¡çš„é€šç”¨è§„åˆ™æ ‘æ¨¡å‹ç»“æ„
<ul>
<li>æ¶µç›–ï¼šStrategyMapper, StrategyHandler /ËˆstrÃ¦tÉ™dÊ’i/ã€AbstractStrategyRouter&lt;T, D, R&gt;ã€‚ é€šè¿‡æ³›å‹è®¾è®¡å…è®¸ä½¿ç”¨æ–¹å¯ä»¥è‡ªå®šä¹‰å‡ºå…¥å‚å’ŒåŠ¨æ€ä¸Šä¸‹æ–‡ï¼Œè®©æŠ½è±¡æ¨¡æ¿æ¨¡å‹å…·æœ‰é€šç”¨æ€§ã€‚</li>
<li>ä¹‹åï¼Œç”±ä½¿ç”¨æ–¹è‡ªå®šä¹‰å‡ºå·¥å‚ã€åŠŸèƒ½æŠ½è±¡ç±»å’Œä¸€ä¸ªä¸ªæµç¨‹æµè½¬çš„èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<p><strong>ç¼–ç å®ç°</strong></p>
<p>é¡¹ç›®å·¥ç¨‹çš„Typesæ¨¡å—ä¸­ï¼Œæ·»åŠ é€šç”¨è®¾è®¡æ¨¡å¼æ¨¡æ¿</p>
<p><em>1.1 ç­–ç•¥æ˜ å°„å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm">     * è·å–å¾…æ‰§è¡Œç­–ç•¥
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="cm">     * @param requestParameter å…¥å‚
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="cm">     * @param dynamicContext   ä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="cm">     * @return è¿”å‚
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="cm">     * @throws Exception å¼‚å¸¸
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>ç”¨äºè·å–æ¯ä¸ªæ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œè´£ä»»é“¾åŠ å¼ºç‰ˆ</li>
<li>Tï¼ŒDï¼ŒRï¼šå…¥å‚ï¼Œä¸Šä¸‹æ–‡ï¼Œåå‚</li>
</ul>
<p><em>1.2 ç­–ç•¥å—ç†å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">DEFAULT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œåˆ©ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ç»™åé¢æ‰§è¡Œçš„èŠ‚ç‚¹ã€‚</li>
</ul>
<p><em>1.3 ç­–ç•¥è·¯ç”±å™¨</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Setter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="p">.</span><span class="na">DEFAULT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// ä¼ªä»£ç </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">StrategyHandler</span><span class="w"> </span><span class="n">strategyHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">strategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defaultStrategyHandler</span><span class="p">.</span><span class="na">apply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>æ‰§è¡Œå…·ä½“èŠ‚ç‚¹ï¼Œè½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…ä¼ é€’åˆ°é»˜è®¤èŠ‚ç‚¹ä¸­</li>
</ul>
<h3 id="ç¬¬2-3èŠ‚-å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">ç¬¬2-3èŠ‚ å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-3èŠ‚-å¤šçº¿ç¨‹å¼‚æ­¥æ•°æ®åŠ è½½">#</a></h3>
<p><strong>é¦–é¡µè¯•ç®—</strong></p>
<p>å½“ä¸€ä¸ªç”¨æˆ·è¿›å…¥åˆ°è´­ç‰©é¦–é¡µæŸ¥çœ‹å•†å“çš„ä¼˜æƒ ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹å®šä¹‰ä¸ºè¯•ç®—è¿‡ç¨‹ã€‚è¯•ç®—ï¼›è¯•è¯•ç®—ä¸€ä¸‹ï¼Œè¿™ä¸ªç”¨æˆ·è¿›å…¥åˆ°é¦–é¡µçœ‹è¿™ä¸ªå•†å“çš„æ—¶å€™ï¼Œå•†å“çš„è¥é”€ä¼˜æƒ ä¿¡æ¯ã€‚åŒ…æ‹¬ï¼šåŸå§‹ä»·æ ¼ã€æŠ˜æ‰£ä»·æ ¼ã€æ‹¼å›¢ç›®æ ‡ã€æ‹¼å›¢æ—¶æ•ˆã€æ˜¯å¦å¯è§ä¼˜æƒ ã€æ˜¯å¦å¯å‚ä¸æ‹¼å›¢ç­‰ï¼Œè¿™äº›ä¸œè¥¿éƒ½æ˜¯è¯•ç®—æ‹¿åˆ°çš„ç»“æœã€‚</p>
<p><strong>1. Modelå®šä¹‰å¯¹è±¡ï¼› 2. æœåŠ¡åŠŸèƒ½å®ç°ï¼Œtrialè¯•ç®—æ¨¡å—ï¼›3. ä¸šåŠ¡æµè½¬çš„åŠŸèƒ½èŠ‚ç‚¹</strong></p>
<img src="http://verification.longcoding.top/FmCp8w1NlRoVcELrPMSLgz_FOgTt" alt="image-20250323214143312" style="zoom:50%;" />
<p><strong>æ¨¡å‹é“¾è·¯</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">IIndexGroupBuyMarketService</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RootNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">|</span><span class="n">æ£€æŸ¥ä¿¡æ¯</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">MarketNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="err">â­</span><span class="n">å‰ç½®å¤„ç†</span><span class="err">â­</span><span class="n">æ‹¼å•è¯•ç®—</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">+</span><span class="n">è·¯ç”±</span><span class="o">]</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w">	</span><span class="o">=&gt;</span><span class="w"> </span><span class="n">multiThread</span><span class="o">[</span><span class="n">å‰ç½®å¤„ç†</span><span class="o">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">doApply</span><span class="o">[</span><span class="n">ä¸šåŠ¡</span><span class="o">|</span><span class="n">æ„å»ºç»“æœ</span><span class="o">]</span><span class="w">     
</span></span></span></code></pre></div><p><strong>è·¯ç”±ç­–ç•¥æ¨¡æ¿[èŠ‚ç‚¹æ¨¡æ¿]</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">StrategyMapper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">multiThread</span><span class="p">()</span><span class="w"> </span><span class="c1">// å‰ç½®å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doApply</span><span class="p">()</span><span class="w"> </span><span class="c1">// ä¸šåŠ¡é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractMultiThreadStrategyRouter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">IActivityRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">multiThread</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// ç©ºæ–¹æ³•ï¼Œéœ€è¦å®ç°çš„è¯ï¼Œè®©å­ç±»é‡å†™</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å…·ä½“èŠ‚ç‚¹å®ä¾‹</strong></p>
<p>å·¥ä½œæµï¼šå‰ç½®å¤„ç† =&gt; ä¸šåŠ¡é€»è¾‘ =&gt; è·¯ç”±</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RootNode</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractGroupBuyMarketSupport</span><span class="o">&lt;</span><span class="n">MarketProductEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">SwitchNode</span><span class="w"> </span><span class="n">nextNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ä¸šåŠ¡å¤„ç†&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w"> </span><span class="c1">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">StrategyHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">switchNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â­â­â­</p>
<p><em><strong>å¼‚æ­¥æ•°æ®åŠ è½½</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// å¼‚æ­¥æŸ¥è¯¢æ´»åŠ¨é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯ -</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="n">XXXThreadTask</span><span class="w"> </span><span class="n">taskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XXXThreadTask</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="n">FutureTask</span><span class="o">&lt;</span><span class="n">XXX</span><span class="o">&gt;</span><span class="w"> </span><span class="n">xxxFutureTaskB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FutureTask</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">XXXThreadTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="n">threadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">xxxFutureTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// å†™å…¥ä¸Šä¸‹æ–‡ï¼Œ å‰ç½®æŸ¥è¯¢æ•°æ® </span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXA</span><span class="p">(</span><span class="n">xxxFutureTaskA</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w"> </span><span class="c1">// é˜»å¡æŒ‡å®šæ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setXXXB</span><span class="p">(</span><span class="n">xxxFutureTaskB</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-4èŠ‚-ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">ç¬¬2-4èŠ‚ <strong>ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—</strong><a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-4èŠ‚-ç­–ç•¥æ¨¡å¼ä¼˜æƒ æŠ˜æ‰£è®¡ç®—">#</a></h3>
<p>ä¸åŒä¼˜æƒ æ¨¡å¼ =&gt; ç­–ç•¥æ¨¡å¼å®ç°</p>
<p><strong>å®šä¹‰æ¥å£</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æŠ½è±¡æ¨¡æ¿</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractDiscountCalculateService</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">calculate</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// 1. äººç¾¤æ ‡ç­¾è¿‡æ»¤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">IsFilter</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isCrowdRange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterTagId</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getTagId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isCrowdRange</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æŠ˜æ‰£ä¼˜æƒ è®¡ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">doCalculate</span><span class="p">(</span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="c1">// äººç¾¤è¿‡æ»¤ - é™å®šäººç¾¤ä¼˜æƒ </span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">filterTagId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// todo xiaofuge åç»­å¼€å‘è¿™éƒ¨åˆ†</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// å…·ä½“è®¡ç®—å‡½æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(...);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>æŠ˜æ‰£æ–¹æ³•</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;MJ&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// æ»¡å‡ä¼˜æƒ </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MJCalculateService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractDiscountCalculateService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="nf">doCalculate</span><span class="p">(</span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">,</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">GroupBuyDiscount</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ä¼˜æƒ ç­–ç•¥æŠ˜æ‰£è®¡ç®—:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getDiscountType</span><span class="p">().</span><span class="na">getCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="c1">// æŠ˜æ‰£è¡¨è¾¾å¼ - 100,10 æ»¡100å‡10å…ƒ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">marketExpr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketExpr</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">marketExpr</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">.</span><span class="na">trim</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// ä¸æ»¡è¶³æœ€ä½æ»¡å‡çº¦æŸï¼Œåˆ™æŒ‰ç…§åŸä»·</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">originalPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="c1">// æŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">.</span><span class="na">subtract</span><span class="p">(</span><span class="n">y</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// åˆ¤æ–­æŠ˜æ‰£åé‡‘é¢ï¼Œæœ€ä½æ”¯ä»˜1åˆ†é’±</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">.</span><span class="na">compareTo</span><span class="p">(</span><span class="n">BigDecimal</span><span class="p">.</span><span class="na">ZERO</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BigDecimal</span><span class="p">(</span><span class="s">&#34;0.01&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">deductionPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>è¥é”€è°ƒç”¨</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// MarketNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="w"> </span><span class="nf">doApply</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="n">groupBuyActivityDiscountVO</span><span class="p">.</span><span class="na">getGroupBuyDiscount</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="c1">// å…·ä½“çš„ç­–ç•¥ï¼Œä¼˜æƒ æ¨¡å¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">groupBuyDiscount</span><span class="p">.</span><span class="na">getMarketPlan</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;...&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">discountCalculateServiceMap</span><span class="p">.</span><span class="na">keys</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    	</span><span class="k">throw</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="c1">// æŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discountCalculateService</span><span class="p">.</span><span class="na">calculate</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">skuVO</span><span class="p">.</span><span class="na">getOriginalPrice</span><span class="p">(),</span><span class="w"> </span><span class="n">groupBuyDiscount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setDeductionPrice</span><span class="p">(</span><span class="n">deductionPrice</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å­¦ä¹ ç‚¹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Service</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">XXX</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="nd">@Resource</span><span class="w">   </span><span class="c1">// â­å…ˆæŒ‰åç§°ï¼Œæ‰¾ä¸åˆ°å†æŒ‰ç±»å‹æ³¨å…¥</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">IDiscountCalculateService</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discountCalculateServiceMap</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-5èŠ‚-äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">ç¬¬2-5èŠ‚ äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-5èŠ‚-äººç¾¤æ ‡ç­¾æ•°æ®é‡‡é›†">#</a></h3>
<p>ç²¾å‡†çš„å¯¹è¿™äº›ç”¨æˆ·åšå®šå‘æ´»åŠ¨æŠ•æ”¾ï¼Œæ¯”å¦‚ï¼›ç‰¹å®šçš„åˆ¸ã€ç‰¹å®šçš„é€šçŸ¥ç­‰ã€‚ä»¥æ­¤è¾¾åˆ°æ›´åŠ ç²¾å‡†çš„è¿è¥æ•ˆæœ</p>
<img src="http://verification.longcoding.top/Fl7ziKeBDxruQ3SdNIT9zf-9gfB5" alt="image-20250324161606013" style="zoom:50%;" />
<p>äººç¾¤æ ‡ç­¾æ˜¯æ ¹æ®ç”¨æˆ·ä¸šåŠ¡è¡Œä¸ºé‡‡é›†çš„</p>
<p><strong>æ•°æ®åº“è¡¨ï¼š</strong></p>
<p>crowd_tags ï¼šç»Ÿè®¡åŠŸèƒ½ï¼›</p>
<p>crowd_tags_detailï¼štag_id =&gt; user_id;  å…·ä½“æ¯ä¸ªäººç¾¤éƒ½æœ‰è°ï¼›</p>
<p>crowd_tags_jobï¼štag_id =&gt; batch_id, tag_relu:æ¶ˆè´¹è§„åˆ™;</p>
<p><img alt="image-20250324170251768" loading="lazy" src="http://verification.longcoding.top/FmlVSVsIZIR9I2OvUixXEBJMm5wu"></p>
<p>æµç¨‹ï¼š</p>
<ol>
<li>æ ¹æ®tag_id, batch_id æŸ¥è¯¢crowd_tags_jobå¾—åˆ°å¯¹åº”æ‰¹æ¬¡ä»»åŠ¡</li>
<li>é‡‡é›†ç”¨æˆ·æ•°æ®</li>
<li>æ•°æ®å†™å…¥è®°å½• // æš‚å­˜</li>
<li>æ•°æ®å†™å…¥æ•°æ®åº“  =&gt; crowd_tags_detail</li>
<li>æ›´æ–°äººç¾¤æ ‡ç­¾ç»Ÿè®¡ =&gt; crowd_tags</li>
</ol>
<p><strong>æ•°æ®å†™å…¥æ•°æ®åº“</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addCrowdTagsUserId</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">CrowdTagsDetail</span><span class="w"> </span><span class="n">crowdTagsDetailReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CrowdTagsDetail</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setTagId</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">crowdTagsDetailReq</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">crowdTagsDetailDao</span><span class="p">.</span><span class="na">addCrowdTagsUserId</span><span class="p">(</span><span class="n">crowdTagsDetailReq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w"> </span><span class="c1">// tagId:{userId, ...}:BitSet</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">bitSet</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">  </span><span class="c1">// Longç±»å‹å•¥çš„è½¬æ¢ä¸€ä¸‹è·Ÿbitseté•¿åº¦ä¸€è‡´ï¼Œå°½å¯èƒ½å‡åŒ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">DuplicateKeyException</span><span class="w"> </span><span class="n">ignore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// å¿½ç•¥å”¯ä¸€ç´¢å¼•å†²çª</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â—â—â—redisä¸­ BitSet å°±æ˜¯bitç±»å‹çš„hashtableï¼Œ è€Œ bitmapæ˜¯å­—ç¬¦ä¸²ï¼›</p>
<p>å¤§è‡´æ€è·¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// æ•°æ®å†™å…¥æ•°æ®åº“æ—¶ï¼ŒåŒæ—¶æŠŠbitsetä¸­ä½ç½®ç½®1ï¼Œè¡¨ç¤ºè¿™ä¸ªç”¨æˆ·å­˜åœ¨äºè¿™ä¸ªé›†åˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// æŸ¥è¯¢æ—¶ï¼Œæ ¹æ®ç”¨æˆ·Idï¼ŒæŸ¥bitset                    // è¿™é‡Œç”¨æˆ·ID=&gt;bitset:key, ä½¿ç”¨ä¸€ä¸ªè½¬æ¢å‡½æ•°ï¼Œä½¿å¾—æ•£åˆ—å°½å¯èƒ½å‡åŒ€</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-6èŠ‚-åº“è¡¨æ‹†åˆ†">ç¬¬2-6èŠ‚ åº“è¡¨æ‹†åˆ†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-6èŠ‚-åº“è¡¨æ‹†åˆ†">#</a></h3>
<p>å°†å•†å“SKUä¸æ´»åŠ¨è¡¨ è§£è€¦ =&gt; SKU&amp;Activityå…³è”è¡¨ã€‚ä½¿å¾—å¤šä¸ªå•†å“å¯ä»¥ç»‘å®šåŒä¸€ä¸ªæ´»åŠ¨ID(ä¼˜æƒ æ‹¼å›¢æ´»åŠ¨)</p>
<img src="http://verification.longcoding.top/Fpmlq6rL3i5VfewYyQm4iFQjKvGa" alt="image-20250324185432351" style="zoom: 67%;" />
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="err">#</span><span class="w"> </span><span class="n">MarketèŠ‚ç‚¹</span><span class="w"> </span><span class="n">åˆ¤æ–­</span><span class="w"> </span><span class="n">å•†å“æ˜¯å¦å­˜åœ¨ä¼˜æƒ æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ErrorNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">ä¸å­˜åœ¨ä¼˜æƒ æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">è¿”å›ä¼˜æƒ çš„è¯•ç®—ä»·æ ¼</span><span class="w">    
</span></span></span></code></pre></div><p>æµç¨‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// MarketNode =&gt; multi-thread æ£€æŸ¥æ˜¯å¦å­˜åœ¨å•†å“&lt;=&gt; æ´»åŠ¨å…³è”è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="nf">call</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="n">SCSkuActivityVO</span><span class="w"> </span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">querySCSkuActivityBySCGoodsId</span><span class="p">(</span><span class="n">goodsId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="c1">// log.error(JSON.toJSONString(scSkuActivityVO));</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">activityRepository</span><span class="p">.</span><span class="na">queryGroupBuyActivityDiscountVOById</span><span class="p">(</span><span class="n">scSkuActivityVO</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// marketNode è·¯ç”±</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">errorNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">tagNode</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ErrorNode åˆ¤æ–­ä¸Šä¸‹æ–‡ï¼ŒæŠ›å‡ºæ— æ‹¼å›¢é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢å•†å“æŸ¥è¯¢è¯•ç®—æœåŠ¡-NoMarketNode userId:{} requestParameter:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getSkuVO</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å•†å“æ— æ‹¼å›¢è¥é”€é…ç½® {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getGoodsId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">ILLEGAL_PARAMETER</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">TrialBalanceEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-7èŠ‚-äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">ç¬¬2-7èŠ‚ äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-7èŠ‚-äººç¾¤æ ‡ç­¾èŠ‚ç‚¹è¿‡æ»¤">#</a></h3>
<p>é™åˆ¶æ‹¼å›¢çš„äººç¾¤</p>
<img src="http://verification.longcoding.top/Fq0dYRQTWGX5WxsW8ayFT00f_f9c" alt="image-20250324214800601" style="zoom:67%;" />
<p>æµç¨‹1ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="n">MarketNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  </span><span class="n">TagNode</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">EndNode</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// TagNode æ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦ èƒ½çœ‹è§æ‹¼å›¢ï¼Œæ˜¯å¦å‚ä¸æ‹¼å›¢  tag_scope = {1,2} ç¬¬ä¸€ä½é™åˆ¶æ˜¯å¦å¯è§ï¼Œç¬¬äºŒä½æ˜¯å¦é™åˆ¶å‚ä¸</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// redis:bitset =&gt; tag_id:{...} å­˜æ”¾æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// è·å–æ‹¼å›¢ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="n">GroupBuyActivityDiscountVO</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivityDiscountVO</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">tagId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">getTagId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">visible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isVisible</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">activityDiscountVO</span><span class="p">.</span><span class="na">isEnable</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// æ— ç‰¹å®šäººç¾¤ä¿¡æ¯, äººäººèƒ½æ“ä½œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">tagId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// æ˜¯å¦åœ¨äººç¾¤èŒƒå›´å†…ï¼Œç‰¹å®šäººç¾¤èƒ½çœ‹</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">isWithin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">isTagCrowdRange</span><span class="p">(</span><span class="n">tagId</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setVisible</span><span class="p">(</span><span class="n">visible</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setEnable</span><span class="p">(</span><span class="n">enable</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">isWithin</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">router</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; isTagCrowdRange function</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w"></span><span class="c1">// xiaofugeã€liergouåœ¨é‡Œé¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="n">RBitSet</span><span class="w"> </span><span class="n">bitSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getBitSet</span><span class="p">(</span><span class="n">tagId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bitSet</span><span class="p">.</span><span class="na">isExists</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨äººç¾¤ä¸­</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w"></span><span class="k">return</span><span class="w"> </span><span class="n">bitSet</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">redisService</span><span class="p">.</span><span class="na">getIndexFromUserId</span><span class="p">(</span><span class="n">userId</span><span class="p">));</span><span class="w">    
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-8èŠ‚--åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">ç¬¬2-8èŠ‚  åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-8èŠ‚--åŠ¨æ€é…ç½®å¼€å…³æ“ä½œ">#</a></h3>
<p>ç›®çš„ï¼šå¦‚ä½•ä¸åœè½¦å°±ç»™æ±½è½¦æ¢ä¸ªè½®å­ï¼Ÿ</p>
<p>=&gt; åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç›´æ¥åŠ¨æ€å˜æ›´æŸäº›å±æ€§é…ç½®ã€‚è¿™äº›åŠ¨æ€å˜æ›´çš„é…ç½®åŒ…æ‹¬é™çº§å’Œåˆ‡é‡çš„å¼€å…³ï¼Œä¹ŸåŒ…æ‹¬ä¸€äº›åŠŸèƒ½ç¨‹åºçš„ç™½åå•ç”¨æˆ·æµ‹è¯•ã€‚</p>
<p><strong>ä½¿ç”¨Redisä½œä¸ºé›†ä¸­åŒ–å‚¨å­˜ç³»ç»Ÿçš„å¥½å¤„ï¼Œæ–¹ä¾¿ä¸€å¤„ä¿®æ”¹å˜é‡ï¼Œé€šçŸ¥æ‰€æœ‰çš„å®ä¾‹è¿›è¡Œå˜æ›´ï¼</strong></p>
<img src="http://verification.longcoding.top/FpD9HrVow32o0uQLmC8s38KAvj-m" alt="image-20250324220542463" style="zoom:50%;" />
<p><strong>æµé‡é™çº§æˆ–åˆ‡é‡</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// è‡ªå®šä¹‰æ³¨è§£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@Target</span><span class="p">(</span><span class="n">ElementType</span><span class="p">.</span><span class="na">FIELD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@Documented</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">DCCValue</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s">&#34;&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// åŠ¨æ€ä¸­å¿ƒæ§åˆ¶ -- ä½œç”¨äºé™çº§</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cm">     * é™çº§å¼€å…³ 0å…³é—­ 1å¼€å¯
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;downgradeSwitch:0&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">downgradeSwitch</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;cutRange:100&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cutRange</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isCutRange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// è®¡ç®—å“ˆå¸Œç çš„ç»å¯¹å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Math</span><span class="p">.</span><span class="na">abs</span><span class="p">(</span><span class="n">userId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–æœ€åä¸¤ä½</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashCode</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">100</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="c1">// åˆ¤æ–­æ˜¯å¦åœ¨åˆ‡é‡èŒƒå›´å†…</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lastTwoDigits</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">parseInt</span><span class="p">(</span><span class="n">cutRange</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">cutRange</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isDowngradeSwitch</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w"></span><span class="c1">// SwitchNodeä¸­ è¿›è¡Œæµé‡æ§åˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="c1">// æ ¹æ®ç”¨æˆ·IDåˆ‡é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦é™çº§</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">downgradeSwitch</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢æ´»åŠ¨é™çº§æ‹¦æˆª {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦åˆ‡é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">activityRepository</span><span class="p">.</span><span class="na">cutRange</span><span class="p">(</span><span class="n">userId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢æ´»åŠ¨åˆ‡é‡æ‹¦æˆª {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getCode</span><span class="p">(),</span><span class="w"> </span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0004</span><span class="p">.</span><span class="na">getInfo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>åˆ©ç”¨Redisçš„Topicäº‹ä»¶å‘å¸ƒè®¢é˜… è¿›è¡Œ ä¿®æ”¹</strong></p>
<p>BeanPostProcessor èƒ½å¤Ÿå½“SpringBeanåˆå§‹åŒ–å®Œæˆåå†æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// DCCValueBeanFactory implements BeanPostProcessor </span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;group_buy_market_dcc_&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">DCCValueBeanFactory</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">redissonClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;dccTopic&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">RTopic</span><span class="w"> </span><span class="nf">dccRedisTopicListener</span><span class="p">(</span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–Redis Topicç›‘å¬äº‹ä»¶ æµ‹è¯•è¿é€š{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="na">get</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// å‘å¸ƒè®¢é˜…æ¨¡å¼çš„Topicå®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">RTopic</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getTopic</span><span class="p">(</span><span class="s">&#34;group_buy_market_dcc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="c1">// æ¶ˆæ¯ç±»å‹ï¼Œå›è°ƒæ¥å£ï¼šTopicåç§°ï¼Œæ¥æ”¶çš„æ¶ˆæ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="n">topic</span><span class="p">.</span><span class="na">addListener</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">charSequence</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç›‘å¬åˆ°Redis Topicï¼š {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">charSequence</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">        </span><span class="c1">// è·å–å€¼</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">attribute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">attribute</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">        </span><span class="c1">// è®¾ç½®å€¼ =&gt; å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼ï¼ˆå¦‚ Stringã€Integerã€è‡ªå®šä¹‰å¯¹è±¡ç­‰ï¼‰ï¼ŒRedisson ä¼šè‡ªåŠ¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">objBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"> </span><span class="c1">// è·å–å†…å­˜ä¸­çš„å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">objBean</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="c1">// æ£€æŸ¥objBeanæ˜¯å¦ä¸ºä»£ç†å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">objBean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="n">objBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">objBean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">            </span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objBeanClass</span><span class="p">.</span><span class="na">getDeclaredField</span><span class="p">(</span><span class="n">attribute</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">objBean</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC èŠ‚ç‚¹ç›‘å¬ï¼ŒåŠ¨æ€è®¾ç½®å€¼ {} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="p">}));</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w"></span><span class="c1">// implements BeanPostProcessor é‡å†™æ–¹æ³•  -- å¹¶åœ¨æ¯ä¸ª bean åˆå§‹åŒ–å®Œæˆåè‡ªåŠ¨è°ƒç”¨è¯¥æ–¹æ³•ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">    </span><span class="c1">// æ³¨æ„ï¼šå¢åŠ  AOP ä»£ç†åï¼Œè·å¾—ç±»çš„æ–¹å¼è¦é€šè¿‡ AopProxyUtils.getTargetClass(bean); ä¸èƒ½ç›´æ¥ bean.class å› ä¸ºä»£ç†åç±»çš„ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™æ ·ä¸èƒ½è·å¾—è‡ªå·±çš„è‡ªå®šä¹‰æ³¨è§£äº†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">AopUtils</span><span class="p">.</span><span class="na">isAopProxy</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">        </span><span class="n">targetBeanClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopUtils</span><span class="p">.</span><span class="na">getTargetClass</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">        </span><span class="n">targetBeanObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AopProxyUtils</span><span class="p">.</span><span class="na">getSingletonTarget</span><span class="p">(</span><span class="n">bean</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">    </span><span class="c1">// è¿™é‡Œåˆ¤æ–­è¯¥ç±»æ˜¯å¦æœ‰å¯¹åº”çš„è‡ªå®šä¹‰æ³¨è§£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">    </span><span class="n">Field</span><span class="o">[]</span><span class="w"> </span><span class="n">fields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetBeanClass</span><span class="p">.</span><span class="na">getDeclaredFields</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Field</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">fields</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="p">.</span><span class="na">isAnnotationPresent</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">            </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="n">DCCValue</span><span class="w"> </span><span class="n">dccValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">field</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">DCCValue</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dccValue</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">field</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;@DCCValue is not config value config caseã€ŒisSwitch/isSwitch:1ã€&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">split</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BASE_CONFIG_PATH</span><span class="p">.</span><span class="na">concat</span><span class="p">(</span><span class="n">split</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="o">[</span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defaultValue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">&#34;dcc config error &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; is not null - è¯·é…ç½®é»˜è®¤å€¼ï¼&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">            </span><span class="n">RBucket</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBucket</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">isExists</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">                </span><span class="n">bucket</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">                </span><span class="n">setValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bucket</span><span class="p">.</span><span class="na">get</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">targetBeanObject</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">            </span><span class="n">field</span><span class="p">.</span><span class="na">setAccessible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;åˆå§‹åŒ–å€¼ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">setValue</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">        </span><span class="n">dccObjGroup</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">targetBeanObject</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Controller</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&#34;update_config&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">updateConfig</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´ key:{} value:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="n">dccTopic</span><span class="p">.</span><span class="na">publish</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;,&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">value</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;DCC åŠ¨æ€é…ç½®å€¼å˜æ›´å¤±è´¥ï¼ key:{} value:{} {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span><span class="n">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">code</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UN_ERROR</span><span class="p">.</span><span class="na">getInfo</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>â±ï¸25/3/24-23:34</p>
<h3 id="ç¬¬2-9èŠ‚-æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">ç¬¬2-9èŠ‚ æ‹¼å›¢äº¤æ˜“è¥é”€é”å•<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-9èŠ‚-æ‹¼å›¢äº¤æ˜“è¥é”€é”å•">#</a></h3>
<p>25/3/25/ 20:37</p>
<p>å®Œæ•´çš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<img src="http://verification.longcoding.top/Fn3pgRYz7BPBei64sWeiiob2YqQH" alt="image-20250325203753717" style="zoom: 80%;" />
<ul>
<li>é¦–å…ˆï¼Œå›¢è´­å•†å“ä¸‹å•ã€‚ä¸‹å•è¿‡ç¨‹åˆ†ä¸ºï¼šåˆ›å»ºæµæ°´å•ã€é”å®šè¥é”€ä¼˜æƒ ï¼ˆæ‹¼å›¢ã€ç§¯åˆ†ã€å·ï¼‰ï¼Œåˆ›å»ºæ”¯ä»˜è®¢å•ã€å”¤èµ·æ”¶é“¶å°æ”¯ä»˜ã€ç”¨æˆ·æ‰«ç æ”¯ä»˜ã€æ”¯ä»˜å®Œæˆæ ¸é”€ä¼˜æƒ ç­‰ã€‚</li>
<li>ç”¨æˆ·ä»¥æ‹¼å›¢çš„æ–¹å¼ä¸‹å•ï¼Œåˆ›å»ºæµæ°´å•å®Œæˆåï¼Œéœ€è¦ä¸æ‹¼å›¢ç³»ç»Ÿäº¤äº’ï¼Œé”å®šè¥é”€ä¼˜æƒ ã€‚æ›´æ–°æµæ°´å•ä¼˜æƒ é‡‘é¢å’Œæ”¯ä»˜é‡‘é¢ã€‚åˆ›å»ºè®¢å•ä½¿ç”¨æœ€ç»ˆçš„æ”¯ä»˜é‡‘é¢ã€‚</li>
<li>æ‹¼å›¢è¡¨(ç›®æ ‡é‡ã€å®Œæˆé‡ã€é”å•é‡)ï¼Œé”å•é‡è¾¾åˆ°ç›®æ ‡é‡åï¼Œä¸èƒ½å†å‚ä¸è¯¥æ‹¼å›¢ã€‚æ‹¼å›¢è¶…æ—¶ï¼Œé‡Šæ”¾ç©ºé—²ä½ç½®è®©å…¶ä»–ç”¨æˆ·å‚ä¸.</li>
</ul>
<p><em>Trade Repository  / rÉªËˆpÉ’zÉ™t(É™)ri /</em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// ç®€å•å®ç°æ­¥éª¤</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// OutTradeNO æ¨¡æ‹Ÿç”Ÿæˆ è®¢å•IDæ¨¡æ‹Ÿç”Ÿæˆ, TeamIDæ¨¡æ‹Ÿç”Ÿæˆ. ä¸¤å¼ è¡¨:1.è®°å½•æ‹¼å›¢ä¸­æ¯ä¸ªç”¨æˆ·çš„ä¿¡æ¯ 2. è®°å½•è¯¥æ‹¼å›¢ä¿¡æ¯.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// â­ä»“å‚¨ä¸šåŠ¡å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// åˆ¤æ–­æ˜¯å¦æœ‰å›¢  -- ä¸€è¡Œè®°å½•å­˜å‚¨æ¯ä¸ªæ‹¼å›¢çš„ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// é¦–æ¬¡åˆ™åˆ›å»ºæ‹¼å›¢è®¢å•. åˆå§‹åŒ–è¡¨2</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// å¦åˆ™åŠ å…¥å…¶ä»–äººçš„å›¢ è¡¨2 æ‹¼å›¢äººæ•°+1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// æ’å…¥è¯¥ç”¨æˆ·çš„æ‹¼å›¢ä¿¡æ¯åˆ°è¡¨1; æ¯ä¸ªç”¨æˆ·ä¸€è¡Œ</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// â­æ§åˆ¶å™¨ä¸šåŠ¡å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 2. æŸ¥è¯¢ç”¨æˆ·outTradeNoæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡,å¹‚ç­‰æ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// 3. æŸ¥è¯¢æ‹¼å›¢æ˜¯å¦äººæ•°å·²æ»¡è¶³</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// 4. è¥é”€ä¼˜æƒ è¯•ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">// 5. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½å¤Ÿçœ‹è§æ‹¼å›¢å’Œå‚ä¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">// 6. æ‹¼å›¢é”å• =&gt; ä»“å‚¨ä¸šåŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// 7. è¿”å›ç»“æœ</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-10èŠ‚-è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">ç¬¬2-10èŠ‚ è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-10èŠ‚-è´£ä»»é“¾æŠ½è±¡æ¨¡æ¿è®¾è®¡">#</a></h3>
<p>25/4/8/ 15:53</p>
<p>å…ˆå‰çš„è´£ä»»é“¾æ¨¡æ¿éƒ½æ˜¯å†™æ­»çš„ã€‚æœ¬ç« å†…å®¹ä¸ºï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘å’Œé“¾æ¥é€»è¾‘è§£è€¦ã€‚</p>
<p>æŠ½è±¡</p>
<p><img alt="image-20250408155522466" loading="lazy" src="http://verification.longcoding.top/FsBb-DMhMAt2eLcNHGwKRX-tpaAG"></p>
<p>ç®€å•çš„å•ä¾‹é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// 1. IlogicChainArmory:   è£…é…é“¾ï¼Œæä¾›æ·»åŠ èŠ‚ç‚¹æ–¹æ³•å’Œè·å–èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 		next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 2. ILogicLink extends IlogicChainArmory:  å¹¶æä¾›ä¸€ä¸ªå—ç†ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">//		apply()</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 3. AbstractLogicLink extends ILogicLink:  å°è£…æ·»åŠ èŠ‚ç‚¹å’Œæ‰§è¡Œ next ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">//      next()</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">//		appendNext()</span><span class="w">
</span></span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="w"></span><span class="c1">// 		apply()</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œæ˜¯ç”±ç»Ÿä¸€çš„<strong>ç±»</strong>ç»´æŠ¤è´£ä»»é“¾ï¼Œä¹Ÿå°±æ˜¯ä¸€ä»½è´£ä»»é“¾ã€‚å¦‚æœæœ‰2ä¸ªç‹¬ç«‹çš„é“¾è¦å¤„ç†ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°éå•ä¾‹çš„ç±»è¿›è¡Œå¡«å……ï¼Œå¦åˆ™ä¼šä¿®æ”¹åŒä¸€ä»½é“¾ã€‚ä¹Ÿå°±æ˜¯ <code>ILogicLink&lt;T, D, R&gt; next </code>è¢«å‡ ä»½é“¾åå¤è°ƒæ•´ï¼Œä¹Ÿå°±ä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„é“¾äº†ã€‚</p>
<p>å¤šä¾‹-é“¾è·¯æ¨¡å¼</p>
<p>å¤šä¾‹é“¾çš„è®¾è®¡è¦è§£è€¦é“¾è·¯å’Œæ‰§è¡Œï¼ŒæŠŠé“¾è·¯å½“åšä¸€ä¸ª LinkedList åˆ—è¡¨å¤„ç†ï¼Œä¹‹åæ‰§è¡Œå½“åšæ˜¯å•ç‹¬çš„ for å¾ªç¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// éœ€è¦è®¾è®¡çš„ç±»</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 1. Node &amp; LinkedList extends ILink</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// åŒå‘é“¾è¡¨èŠ‚ç‚¹ &amp; åŒå‘é“¾è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 2. BusinessLinkedList extends LinkedList</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// ä»å¤´åˆ°å°¾æ‰§è¡Œå„ä¸ªèŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 3. ILogicHandler  -- å®šä¹‰ä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 4. LinkArmory -- åˆ›å»ºé“¾è¡¨å¹¶è£…é…èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// public LinkArmory(String linkName, ILogicHandler&lt;T, D, R&gt;... logicHandlers)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// private final BusinessLinkedList&lt;T, D, R&gt; logicLink;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// ç”¨æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. å®šä¹‰ RuleLogicNode extends ILogicHandler</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. new LinkArmory&lt;&gt;(&#34;demo01&#34;, ruleLogic201, ruleLogic202, ...);</span><span class="w">
</span></span></span></code></pre></div><p>å…·ä½“ä¼ªä»£ç </p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILink</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="cm">     * è´£ä»»é“¾åç§°
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="cm">     * */</span><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="nd">@Getter</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w">    </span><span class="kd">transient</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkedList</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="c1">// å¤´æ’èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">        </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">        </span><span class="k">else</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">            </span><span class="n">f</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">    </span><span class="c1">// å°¾æ’æ³•</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">linkLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">newNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">        </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">            </span><span class="n">l</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newNode</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addFirst</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">        </span><span class="n">linkFirst</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">addLast</span><span class="p">(</span><span class="n">E</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w">        </span><span class="n">linkLast</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">remove</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">!=</span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">                    </span><span class="n">unlink</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w">    </span><span class="c1">// åˆ é™¤èŠ‚ç‚¹ï¼Œæ³¨æ„æ˜¯åŒå‘é“¾è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w">    </span><span class="n">E</span><span class="w"> </span><span class="nf">unlink</span><span class="p">(</span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="n">element</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="kd">final</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="c1">// xä¸ºå¤´èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">prev</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="n">prev</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">        </span><span class="c1">// xä¸ºæœ«å°¾</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">            </span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">            </span><span class="n">next</span><span class="p">.</span><span class="na">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">            </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">101</span><span class="cl"><span class="w">        </span><span class="n">x</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">102</span><span class="cl"><span class="w">        </span><span class="n">size</span><span class="o">--</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">element</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">104</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">105</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">106</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">107</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">108</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="na">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">109</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">	
</span></span></span><span class="line"><span class="ln">110</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">111</span><span class="cl"><span class="w">    </span><span class="c1">// æ ¹æ®indexï¼Œåˆ¤æ–­æ˜¯å‰å‘è¿˜æ˜¯åå‘</span><span class="w">
</span></span></span><span class="line"><span class="ln">112</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">113</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">115</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">117</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">118</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">119</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">120</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">121</span><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="o">-</span><span class="n">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">index</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">122</span><span class="cl"><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="na">prev</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">123</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">124</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">125</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">126</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">127</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">128</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">129</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">printLinkList</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">130</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">131</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span><span class="s">&#34;é“¾è¡¨ä¸ºç©º&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">132</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">133</span><span class="cl"><span class="w">            </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">134</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="s">&#34;ç›®å‰çš„åˆ—è¡¨ï¼Œå¤´èŠ‚ç‚¹ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">first</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; å°¾èŠ‚ç‚¹ï¼š&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">last</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; æ•´ä½“ï¼š&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">135</span><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">136</span><span class="cl"><span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">print</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="na">item</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;ï¼Œ&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">137</span><span class="cl"><span class="w">                </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">next</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">138</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">139</span><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">140</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">141</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">142</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="ç¬¬2-11èŠ‚-äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">ç¬¬2-11èŠ‚ äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-11èŠ‚-äº¤æ˜“è§„åˆ™è´£ä»»é“¾è¿‡æ»¤">#</a></h3>
<p>2025-4-8 17:30</p>
<p><img alt="image-20250408175143439" loading="lazy" src="http://verification.longcoding.top/Ft7mFa7SSNbeW7WIK6nSRUaiACK0"></p>
<p>è¯¥ç« èŠ‚è¡¥å……ï¼šè¿‡æ»¤æ‹¼å›¢æ´»åŠ¨é…ç½®çš„è§„åˆ™ã€‚åŒ…æ‹¬ï¼›æ´»åŠ¨çš„æœ‰æ•ˆæœŸã€çŠ¶æ€ï¼Œä»¥åŠä¸ªäººå‚ä¸æ‹¼å›¢çš„æ¬¡æ•°ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// Logic chain</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="c1">// 1. æ£€æŸ¥å‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// 2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨äº¤æ˜“è®°å½•ï¼Œæ ¹æ®å¤–éƒ¨OrderId</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="c1">// 3. åˆ¤æ–­æ‹¼å›¢æ´»åŠ¨æ˜¯å¦æ»¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// 4. è¥é”€è¯•ç®— -- ç»™å‡ºæŠ˜æ‰£ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="c1">// 5. äººç¾¤é™å®š -- ç‰¹å®šäººç¾¤æ‰èƒ½æ‹¼å›¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w"></span><span class="c1">// 6. æ‹¼å›¢é”å• -- 1. ä¿®æ”¹æ´»åŠ¨è¡¨å¯¹åº”çš„ä¿¡æ¯ 2. æ’å…¥ä¸€æ¡æ‹¼å›¢è®°å½•</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="c1">// 6.1. äº¤æ˜“è§„åˆ™è¿‡æ»¤  -- æ£€æŸ¥æ´»åŠ¨æ—¶é—´ + æ£€æŸ¥æ‹¼å›¢æ¬¡æ•°  â­æœ¬èŠ‚ä¸»è¦è¿™éƒ¨åˆ†</span><span class="w">
</span></span></span></code></pre></div><p>å…·ä½“å°±æ˜¯å®šä¹‰ä¸€äº› è´£ä»»é“¾èŠ‚ç‚¹(æ‹¦æˆªå™¨)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤-æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒ{} activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥è¯¢æ‹¼å›¢æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivityEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryGroupBuyActivityEntityByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="c1">// æ ¡éªŒï¼šæ´»åŠ¨çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">ActivityStatusEnumVO</span><span class="p">.</span><span class="na">EFFECTIVE</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStatus</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéç”Ÿæ•ˆçŠ¶æ€ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0101</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// æ ¡éªŒï¼›æ´»åŠ¨æ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Date</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="na">before</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getStartTime</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">now</span><span class="p">.</span><span class="na">after</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">.</span><span class="na">getEndTime</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ´»åŠ¨çš„å¯ç”¨æ€§æ ¡éªŒï¼Œéå¯å‚ä¸æ—¶é—´èŒƒå›´ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0102</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setGroupBuyActivity</span><span class="p">(</span><span class="n">groupBuyActivityEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// èµ°åˆ°ä¸‹ä¸€ä¸ªè´£ä»»é“¾èŠ‚ç‚¹</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤-ç”¨æˆ·å‚ä¸æ¬¡æ•°æ ¡éªŒ{} activityId{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryOrderCountByActivityId</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTakeLimitCount</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç”¨æˆ·å‚æ•°æ¬¡æ•°æ ¡éªŒï¼Œå·²è¾¾å¯å‚ä¸ä¸Šé™ activityId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0103</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userTakeOrderCount</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç»„è£…è´£ä»»é“¾  &ndash; BusinessLinkedList å…·ä½“ä¸šåŠ¡</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;tradeRuleFilter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nf">tradeRuleFilter</span><span class="p">(</span><span class="n">ActivityUsabilityRuleFilter</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">UserTakeLimitRuleFilter</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="c1">// ç»„è£…é“¾</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">LinkArmory</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkArmory</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“è§„åˆ™è¿‡æ»¤é“¾&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">activityUsabilityRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">userTakeLimitRuleFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">    </span><span class="c1">// é“¾å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">filter</span><span class="p">.</span><span class="na">getLogicLink</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>LinkArmory  &ndash; çœŸæ­£çš„æŠ½è±¡è£…é…è´£ä»»é“¾</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@SafeVarargs</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">LinkArmory</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">linkName</span><span class="p">,</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">logicLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">linkName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="n">logicHandler</span><span class="p">:</span><span class="w"> </span><span class="n">logicHandlers</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="n">logicLink</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">logicHandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">R</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getLogicLink</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">logicLink</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç”¨æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tradeRuleFilter</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="n">tradeRuleFilter</span><span class="p">.</span><span class="na">aaply</span><span class="p">(...)</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-12èŠ‚æ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">ç¬¬2-12èŠ‚ï¼šæ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-12èŠ‚æ‹¼å›¢ç»„é˜Ÿç»“ç®—ç»Ÿè®¡">#</a></h3>
<p>25/4/8 21:19</p>
<p><img alt="image-20250408224034286" loading="lazy" src="http://verification.longcoding.top/FibqNji0Ee0IfoFnGG-u4FK-BHvJ"></p>
<p>æ‹¼å›¢çš„è¿‡ç¨‹æ˜¯ç”¨æˆ·åœ¨å•†åŸä¸‹å•ï¼Œé”å®šæ‹¼å›¢ä¼˜æƒ ï¼ˆä¹Ÿå°±æ˜¯æ‹¼å›¢ç³»ç»Ÿé‡Œé”å•çš„è¿‡ç¨‹ï¼‰ã€‚ä¹‹åå°±æ˜¯ç”¨æˆ·ç»™è¿™ç¬”å•†å“å®Œæˆæ”¯ä»˜äº¤æ˜“ï¼Œäº¤æ˜“åä¸ä¼šç›´æ¥å‘è´§ï¼Œç›´è‡³æ‹¼å›¢ç»„é˜Ÿå®Œæˆåæ‰ä¼šå‘è´§ã€‚</p>
<p>é‚£ä¹ˆï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯æ”¯ä»˜å®Œæˆåï¼Œéœ€è¦åšæ‹¼å›¢æ•°é‡çš„ç»Ÿè®¡ç»“ç®—ã€‚å¦‚ï¼Œæ‹¼å›¢éœ€è¦3ä¸ªç”¨æˆ·ä¸€èµ·ä¸‹å•ï¼Œé‚£ä¹ˆæ¯å®Œæˆä¸€ç¬”æ”¯ä»˜ï¼Œå°±è¦ç»™æ‹¼å›¢çš„ç»„é˜ŸåŠ ä¸Šä¸€ç¬”è®°å½•ã€‚è¿™ä¸ªå°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„æµç¨‹ã€‚</p>
<p>â­â­â­ æ‰€æœ‰ç”¨æˆ·å®Œæˆæ”¯ä»˜å, æœ€åä¸€ä¸ªç”¨æˆ·çš„ç»“ç®—è§¦å‘å›è°ƒäº‹ä»¶!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Transactional</span><span class="p">(</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">500</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">settlementMarketPayOrder</span><span class="p">(</span><span class="n">GroupBuyTeamSettlementAggregate</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">UserEntity</span><span class="w"> </span><span class="n">userEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getUserEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getGroupBuyTeamEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">TradePaySuccessEntity</span><span class="w"> </span><span class="n">tradePaySuccessEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyTeamSettlementAggregate</span><span class="p">.</span><span class="na">getTradePaySuccessEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»†çŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyOrderList</span><span class="w"> </span><span class="n">groupBuyOrderList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GroupBuyOrderList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setUserId</span><span class="p">(</span><span class="n">userEntity</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="n">groupBuyOrderList</span><span class="p">.</span><span class="na">setOutTradeNo</span><span class="p">(</span><span class="n">tradePaySuccessEntity</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyOrderList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateOrderStatus2COMPLETE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="c1">// 2. æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">updateAddCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateAddCompleteCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">updateAddCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="c1">// 3. æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTargetCount</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getCompleteCount</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">updateOrderStatus2COMPLETE</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">UPDATE_ZERO</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">        </span><span class="c1">// æŸ¥è¯¢æ‹¼å›¢äº¤æ˜“å¤–éƒ¨è®¢å•å·åˆ—è¡¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">queryGroupBuyCompleteOrderOutTradeNoListByTeamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å›¢å®Œæˆå†™å…¥å›è°ƒä»»åŠ¡è®°å½•</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">        </span><span class="n">NotifyTask</span><span class="w"> </span><span class="n">notifyTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NotifyTask</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">teamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyUrl</span><span class="p">(</span><span class="s">&#34;æš‚æ— &#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyCount</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">notifyStatus</span><span class="p">(</span><span class="n">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="n">notifyTask</span><span class="p">.</span><span class="na">setParameterJson</span><span class="p">(</span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{{</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;teamId&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">            </span><span class="n">put</span><span class="p">(</span><span class="s">&#34;outTradeNoList&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">outOrderNoList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="p">}}));</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="n">notifyTaskDao</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œç®—æ˜¯æ”¯ä»˜æˆåŠŸåçš„å›è°ƒ</p>
<hr>
<h3 id="ç¬¬2-13èŠ‚äº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤"><strong>ç¬¬2-13èŠ‚ï¼šäº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤</strong><a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-13èŠ‚äº¤æ˜“ç»“ç®—è´£ä»»é“¾è¿‡æ»¤">#</a></h3>
<p>â±ï¸25/4/9 12:31</p>
<p><img alt="image-20250409152543493" loading="lazy" src="http://verification.longcoding.top/FpSGuYmWq4FZbzRFomQj6MM06Xvm"></p>
<p>æœ¬èŠ‚è¯‰æ±‚ï¼š</p>
<p>æ‹¼å›¢äº¤æ˜“ç»“ç®—çš„è¿‡ç¨‹ï¼Œéœ€è¦ä¸€äº›åˆ—çš„è§„åˆ™è¿‡æ»¤ã€‚åŒ…æ‹¬ï¼›æˆ‘ä»¬ä¸Šä¸€èŠ‚æåˆ°çš„æ ¡éªŒå¤–éƒ¨äº¤æ˜“å•çš„æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…ï¼ŒåŒæ—¶è¿˜æœ‰å…³äºè¿™ç¬”å¤–éƒ¨äº¤æ˜“å•æ˜¯å¦ä¸ºæœ‰æ•ˆçš„æ‹¼å›¢é”å•è®¢å•ã€‚å¦å¤–åƒæ˜¯ SC æ¸ é“çš„æœ‰æ•ˆæ€§ä¹Ÿéœ€è¦åœ¨ç»“ç®—æ—¶è¿›è¡Œæ ¡éªŒã€‚</p>
<p>æ‰€ä»¥ï¼Œæœ¬èŠ‚æˆ‘ä»¬éœ€è¦å®ç°ä¸€å¥—è§„åˆ™é“¾ï¼Œæ¥å¤„ç†è¿™äº›ä¸šåŠ¡è§„åˆ™ã€‚å› ä¸ºè§„åˆ™é“¾å·²ç»è¢«æŠ½å–ä¸ºé€šç”¨çš„æ¨¡æ¿äº†ï¼Œé‚£ä¹ˆæœ¬èŠ‚ä½¿ç”¨èµ·æ¥ä¼šéå¸¸å®¹æ˜“ã€‚</p>
<p>è´£ä»»é“¾æµç¨‹ï¼š1. æ ¡éªŒæ¸ é“æ˜¯å¦ä¸ºé»‘åå• 2. å¤–éƒ¨è®¢å•å·æ˜¯å¦æ­£ç¡® 3. äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæœŸå†… 4. æ‰“åŒ…ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡</p>
<p><em><strong>è´£ä»»é“¾åŒ…è£…å¯¹è±¡</strong></em></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Bean</span><span class="p">(</span><span class="s">&#34;tradeSettlementRuleFilter&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">BusinessLinkedList</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">tradeSettlementRuleFilter</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">SCRuleFilter</span><span class="w"> </span><span class="n">scRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">OutTradeNoRuleFilter</span><span class="w"> </span><span class="n">outTradeNoRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">SettableRuleFilter</span><span class="w"> </span><span class="n">settableRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">EndRuleFilter</span><span class="w"> </span><span class="n">endRuleFilter</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="n">LinkArmory</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w"> </span><span class="n">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tradeSettlementFilter</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">LinkArmory</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&#34;äº¤æ˜“ç»“ç®—è§„åˆ™è¿‡æ»¤é“¾&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">scRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">outTradeNoRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">settableRuleFilter</span><span class="p">,</span><span class="w"> </span><span class="n">endRuleFilter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">tradeSettlementFilter</span><span class="p">.</span><span class="na">getLogicLink</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>1 SCè¿‡æ»¤å™¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SCRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="c1">// 1. æ‰“å°å‡½æ•°æµç¨‹ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç»“ç®—è§„åˆ™è¿‡æ»¤-æ¸ é“é»‘åå•æ ¡éªŒ{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æ ¡éªŒé»‘åå•ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="n">Boolean</span><span class="w"> </span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">isSCBlackIntercept</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getSource</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getChannel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">intercept</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;{}-{} æ¸ é“é»‘åå•æ‹¦æˆª&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getSource</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getChannel</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0105</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>2 è®¢å•å·æ ¡éªŒè¿‡æ»¤å™¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OutTradeNoRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç»“ç®—è§„åˆ™è¿‡æ»¤-å¤–éƒ¨å•å·æ ¡éªŒ{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="n">MarketPayOrderEntity</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryMarketPayOrderEntityByOutTradeNo</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ä¸å­˜åœ¨çš„å¤–éƒ¨äº¤æ˜“å•å·æˆ–ç”¨æˆ·å·²é€€å•ï¼Œä¸éœ€è¦åšæ”¯ä»˜è®¢å•ç»“ç®—ï¼š{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0104</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setMarketPayOrderEntity</span><span class="p">(</span><span class="n">marketPayOrderEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>3 æœ‰æ•ˆæœŸæ ¡éªŒå™¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SettableRuleFilter</span><span class="w">  </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="nd">@Resource</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ITradeRepository</span><span class="w"> </span><span class="n">repository</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç»“ç®—è§„åˆ™è¿‡æ»¤-æœ‰æ•ˆæ—¶é—´æ ¡éªŒï¼š{}, {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">        </span><span class="c1">// 1. ä¸Šä¸‹æ–‡è·å–æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="n">MarketPayOrderEntity</span><span class="w"> </span><span class="n">marketPayOrderEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getMarketPayOrderEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="c1">// 2. æŸ¥è¯¢æ‹¼å›¢å¯¹è±¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryGroupBuyTeamByTeamId</span><span class="p">(</span><span class="n">marketPayOrderEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// 3. å¤–éƒ¨äº¤æ˜“æ—¶é—´ - æ”¯ä»˜æ—¶é—´éœ€è¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…å®Œæˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeTime</span><span class="p">().</span><span class="na">after</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidEndTime</span><span class="p">())){</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">            </span><span class="c1">// 4. åˆ¤æ–­ï¼Œå¤–éƒ¨äº¤æ˜“æ—¶é—´æ˜¯å¦å°äºæ‹¼å›¢ç»“æŸæ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;è®¢å•äº¤æ˜“æ—¶é—´ä¸åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´èŒƒå›´å†…&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">E0106</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="c1">// 5. è®¾ç½®ä¸Šä¸‹æ–‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">        </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">setGroupBuyTeamEntity</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">next</span><span class="p">(</span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>4 æ‰“åŒ…èŠ‚ç‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EndRuleFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ILogicHandler</span><span class="o">&lt;</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">        </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="n">TradeSettlementRuleCommandEntity</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">,</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterFactory</span><span class="p">.</span><span class="na">DynamicContext</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç»“ç®—è§„åˆ™è¿‡æ»¤-ç»“æŸèŠ‚ç‚¹{} outTradeNo:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getOutTradeNo</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">GroupBuyTeamEntity</span><span class="w"> </span><span class="n">groupBuyTeamEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyTeamEntity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TradeSettlementRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">teamId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getActivityId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">completeCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getCompleteCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">targetCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getTargetCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">validStartTime</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidStartTime</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">validEndTime</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getValidEndTime</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">lockCount</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getLockCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">groupBuyTeamEntity</span><span class="p">.</span><span class="na">getStatus</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>5 SCæ¥æºæ¸ é“é»‘åå•åŠ¨æ€é…ç½®</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Slf4j</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Service</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DCCService</span><span class="w"> 
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="nd">@DCCValue</span><span class="p">(</span><span class="s">&#34;scBlacklist:s02c02&#34;</span><span class="p">)</span><span class="w">  </span><span class="c1">// é»˜è®¤é»‘åå•æ¸ é“</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">scBlacklist</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Boolean</span><span class="w"> </span><span class="nf">isSCBlackIntercept</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arrays</span><span class="p">.</span><span class="na">asList</span><span class="p">(</span><span class="n">scBlacklist</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Constants</span><span class="p">.</span><span class="na">SPLIT</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="n">source</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">channel</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// Httpè¯·æ±‚key=scBlacklist&amp;value=s02c02;s03c03</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">// =&gt; Redis (scBlacklist) =&gt; scBlacklist,s02c02;s03c03 </span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="ç¬¬2-14èŠ‚æ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡"><strong>ç¬¬2-14èŠ‚ï¼šæ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡</strong><a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-14èŠ‚æ‹¼å›¢å›è°ƒé€šçŸ¥ä»»åŠ¡">#</a></h3>
<p>â±ï¸25/4/9 15:32</p>
<p>æ‹¼å›¢ç»„é˜Ÿäº¤æ˜“ç»“ç®—å®Œç»“åï¼Œå®ç°ä¸€ä¸ªå›è°ƒé€šçŸ¥çš„ä»»åŠ¡å¤„ç†ã€‚å‘ŠçŸ¥å¦å¤–çš„å¾®æœåŠ¡ç³»ç»Ÿå¯ä»¥è¿›è¡Œåç»­çš„æµç¨‹äº†ã€‚</p>
<p>RPCã€MQï¼Œè¿™ä¸€ç±»çš„éƒ½æ˜¯éœ€è¦æœ‰ä¸€ä¸ªå…¬ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼Œå®ƒçš„æŠ€æœ¯æ¶æ„æ¯”è¾ƒé€‚åˆäºå…¬å¸å†…éƒ¨çš„ç»Ÿä¸€ç³»ç»Ÿä½¿ç”¨ã€‚å¦‚æœæ˜¯æœ‰å’Œå¤–éƒ¨å…¶ä»–ç³»ç»Ÿçš„å¯¹æ¥ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šä½¿ç”¨ HTTP è¿™æ ·ç»Ÿä¸€æ ‡å‡†åè®®çš„æ¥å£è¿›è¡Œä½¿ç”¨ã€‚</p>
<p>æ³¨æ„ï¼šå¾®ä¿¡æ”¯ä»˜ï¼Œæ”¯ä»˜å®æ”¯ä»˜ï¼Œä¹Ÿæ˜¯åœ¨å®Œæˆæ”¯ä»˜åï¼Œåšçš„è¿™æ ·çš„å›è°ƒå¤„ç†ã€‚</p>
<p><img alt="image-20250409153440408" loading="lazy" src="http://verification.longcoding.top/FoxjZpAuwMdJMA1Pw0ySfe_zrWpx"></p>
<p>ğŸ’¡<strong>æµç¨‹é€»è¾‘ 1ï¼šé”å•</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. æ£€æŸ¥é”å•è¯·æ±‚ä¿¡æ¯ - è¯·æ±‚å‚æ•°æ˜¯å¦ä¸ºNull or ç©ºä¸²</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 2. æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å• - æ£€æŸ¥æ£€æŸ¥outTradeNoæ˜¯å¦é‡å¤é”å•æ˜¯å¦å­˜åœ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 3. æ‹¼å›¢æ˜¯å¦èƒ½å¤ŸåŠ å…¥ - åˆ¤æ–­æ‹¼å›¢å½“å‰äººæ•°å°äºç›®æ ‡äººæ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// 4. è¥é”€ä¼˜æƒ è¯•ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">// 	  4.1. RootNode =&gt; SwitchRoot =&gt; MarketNode =&gt; TagNode =&gt; EndNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">//                                              =&gt; ErrorNode</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.1 RootNodeæ£€æŸ¥ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.2 SwitchRoot é™çº§å’Œé™æµ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.3 MarketNode 1:å¼‚æ­¥æŸ¥è¯¢å•†å“ä¿¡æ¯+æ´»åŠ¨ä¿¡æ¯ 2:è¿›è¡ŒæŠ˜æ‰£éªŒç®—(æ ¹æ®Mapæ‹¿åˆ°å¯¹åº”çš„æŠ˜æ‰£å¯¹è±¡ - æ¯ä¸ªæŠ˜æ‰£å¯¹è±¡å®ç°åŒä¸€æ¥å£)</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.4-1 TagNodeï¼šæ ¹æ®bitsetï¼Œæ£€æŸ¥ç”¨æˆ·Idæ˜¯å¦æœ‰èµ„æ ¼å‚ä¸orå¯è§è¯¥æŠ˜æ‰£æ´»åŠ¨</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">//		4.1.4-2 ErrorNodeï¼šæ— æŠ˜æ‰£æ´»åŠ¨è¿”å›</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 		4.1.5 EndNode ç»„è£…è¯•ç®—ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 5. æ ¹æ®è¯•ç®—ç»“æœåˆ¤æ–­æ˜¯å¦å¯è§å’Œå¯å‚ä¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">// 6. è¿›è¡Œé”å•</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="c1">//	  6.1. äº¤æ˜“è§„åˆ™æ£€æŸ¥ - æ ¡éªŒæ´»åŠ¨çŠ¶æ€+æ´»åŠ¨æ—¶é—´ &amp;&amp; æ ¡éªŒå‚ä¸æ¬¡æ•°  -è´£ä»»é“¾</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="c1">//      LinkArmory(BusinessLinkedList:ActivityUsabilityRuleFilter+UserTakeLimitRuleFilter)</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w"></span><span class="c1">//		6.1.1 ActivityUsabilityRuleFilter: æ£€æŸ¥æ´»åŠ¨çŠ¶æ€å’Œæ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">//		6.1.2 UserTakeLimitRuleFilter:     æ£€æŸ¥ç”¨æˆ·å‚ä¸æ¬¡æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="c1">//    6.2. åˆ¤æ–­æ˜¯å¦æœ‰å›¢ - ç”Ÿæˆæ‹¼å›¢è®¢å• or åŠ å…¥åˆ«äººçš„è®¢å•  =&gt; æ’å…¥orä¿®æ”¹è®°å½• GroupBuyOrder</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="c1">//    6.3. ç”Ÿæˆè®¢å•æ˜ç»†  =&gt; æ’å…¥è®°å½•åˆ°GroupBuyOrderList</span><span class="w">
</span></span></span></code></pre></div><p><strong>ğŸ’¡æµç¨‹é€»è¾‘ 2ï¼šç»“ç®—</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// 1. æ£€æŸ¥æ‹¼å›¢ä¿¡æ¯ - ç»“ç®—è§„åˆ™</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 	  1.1 æ£€æŸ¥ æ¸ é“åˆæ³•æ€§=&gt;å¤–éƒ¨è®¢å•åˆæ³•æ€§=&gt;æ‹¼å›¢æ—¶é—´åˆæ³•æ€§=&gt;åŒ…è£…æ£€æŸ¥ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">//    		1.1.1 SCRuleFilter: æ£€æŸ¥sourceå’Œchannelæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼Œ@DCCValue(&#34;scBlacklist:s02c02&#34;), å¯åŠ¨æ€é…ç½®</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">//   		1.1.2 OutTradeNoRuleFilterï¼šæ£€æŸ¥OutTradeNoæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦GroupBuyOrderListå­˜åœ¨åˆå§‹é”å•çš„æ‹¼å›¢è®¢å• </span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="c1">//			(è¿™é‡Œï¼Œå¤–éƒ¨è¿›è¡Œäº†æ”¯ä»˜ï¼Œä½†æ˜¯ç³»ç»Ÿè¿˜æ²¡ä¿®æ”¹ç»“ç®—çŠ¶æ€å‘¢)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="c1">// 			1.1.3 SettableRuleFilterï¼šæ£€æŸ¥è®¢å•äº¤æ˜“æ—¶é—´æ˜¯å¦åœ¨æ‹¼å›¢æœ‰æ•ˆæ—¶é—´å†…</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="c1">// 			1.1.4 EndRuleFilterï¼šåŒ…è£…ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="c1">// 2. è¿›è¡Œæ‹¼å›¢ç»“ç®—</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="c1">// 	  2.1 æ›´æ–°æ‹¼å›¢è®¢å•æ˜ç»† =&gt; GroupBuyOrderListå¯¹åº”ç”¨æˆ·çš„å®ŒæˆçŠ¶æ€</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">//    2.2 æ›´æ–°æ‹¼å›¢è¾¾æˆæ•°é‡ =&gt; GroupBuyOrderå¯¹åº”çš„ç”¨æˆ·å®Œæˆæ”¯ä»˜æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">//    2.3 æ›´æ–°æ‹¼å›¢å®ŒæˆçŠ¶æ€ =&gt; æœ€åä¸€ä¸ªäººæ”¯ä»˜å®Œæˆè§¦å‘ =&gt; GroupBuyOrderæ‹¼å›¢ä¿¡æ¯çŠ¶æ€ =&gt; å†™å…¥å›è°ƒä»»åŠ¡è®°å½•(åŒ…è£…TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="c1">// 3. ç»„é˜Ÿå›è°ƒå¤„ç† - è¿™é‡Œæ˜¾ç¤ºçš„æ‰§è¡Œï¼Œä½¿å¾—å®æ—¶æ€§æ¯”è¾ƒå¥½ï¼Œåªæœ‰æœ€åä¸€ä¸ªäººå®Œæˆæ‰ä¼šæ‰§è¡ŒæˆåŠŸï¼Œä¸è¿‡æœ‰å®šæ—¶ä»»åŠ¡è¿›è¡Œå…œåº•</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="c1">// 	  3.1 å‘é€Httpè¿œç¨‹è°ƒç”¨ï¼Œå°†(TeamId+æ‰€æœ‰çš„å¤–éƒ¨è®¢å•ID)å‘é€ç»™ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œé€šçŸ¥å‘è´§orå…¶ä»–</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="c1">//    3.2 å®šæ—¶ä»»åŠ¡ï¼šæŸ¥è¯¢æ‰€æœ‰åˆå§‹çŠ¶æ€å’Œé‡è¯•çŠ¶æ€çš„ é€šçŸ¥ä»»åŠ¡</span><span class="w">
</span></span></span></code></pre></div><p>ğŸ·ï¸<strong>æœ¬ç« èŠ‚å®Œæˆ 3 è§¦å‘å›è°ƒéƒ¨åˆ†</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">  1</span><span class="cl"><span class="c1">// æŒ‡å®šè§¦å‘å›è°ƒé€šçŸ¥ä»»åŠ¡  - å®æ—¶æ€§</span><span class="w">
</span></span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w"> 
</span></span></span><span class="line"><span class="ln">  3</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥å›è°ƒï¼ŒæŒ‡å®š teamId:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntityList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryUnExecutedNotifyTaskList</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">execSettlementNotifyJob</span><span class="p">(</span><span class="n">notifyTaskEntityList</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 10</span><span class="cl"><span class="w"></span><span class="c1">// è¾…åŠ©å®šæ—¶æ‰«æï¼Œè¿›è¡Œé€šçŸ¥ - å…œåº•</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 11</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 13</span><span class="cl"><span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢äº¤æ˜“-æ‰§è¡Œç»“ç®—é€šçŸ¥ä»»åŠ¡&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 15</span><span class="cl"><span class="w">    </span><span class="c1">// æŸ¥è¯¢æœªæ‰§è¡Œä»»åŠ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 16</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">queryUnExecutedNotifyTaskList</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 18</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">execSettlementNotifyJob</span><span class="p">(</span><span class="n">notifyTaskEntities</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 19</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 20</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 21</span><span class="cl"><span class="w"></span><span class="c1">// å…¬ç”¨é€šçŸ¥å‡½æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 22</span><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">execSettlementNotifyJob</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">NotifyTaskEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 23</span><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">successCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">errorCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 24</span><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskEntity</span><span class="w"> </span><span class="n">notifyTask</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 25</span><span class="cl"><span class="w">        </span><span class="c1">// å›è°ƒå¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 26</span><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">port</span><span class="p">.</span><span class="na">groupBuyNotify</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 27</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 28</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 29</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusSuccess</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 30</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 31</span><span class="cl"><span class="w">                </span><span class="n">successCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 32</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 33</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">ERROR</span><span class="p">.</span><span class="na">getCode</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 34</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusError</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 35</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 36</span><span class="cl"><span class="w">                </span><span class="n">errorCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 37</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 38</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 39</span><span class="cl"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">updateNotifyTaskStatusRetry</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 40</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 41</span><span class="cl"><span class="w">                </span><span class="n">retryCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 42</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 43</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 44</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 45</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 46</span><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">resultMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 47</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;waitCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">notifyTaskEntities</span><span class="p">.</span><span class="na">size</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;successCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">successCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 49</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;errorCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">errorCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 50</span><span class="cl"><span class="w">    </span><span class="n">resultMap</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&#34;retryCount&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">retryCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 52</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">resultMap</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 53</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 54</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 55</span><span class="cl"><span class="w"></span><span class="c1">// è¿œç¨‹è°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 56</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 57</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">groupBuyNotify</span><span class="p">(</span><span class="n">NotifyTaskEntity</span><span class="w"> </span><span class="n">notifyTask</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 58</span><span class="cl"><span class="w">    </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">lockKey</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 59</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 60</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å›¢æœåŠ¡å™¨éƒ¨ç½²åœ¨å¤šå°åº”ç”¨æœåŠ¡å™¨ä¸Šï¼Œå¤šä»»åŠ¡æ‰§è¡Œï¼Œé¿å…ä»»åŠ¡è¢«å¤šæ¬¡æ‰§è¡Œï¼Œé”çš„ç²’åº¦ xxx:teamId</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 61</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 62</span><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 63</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">())</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s">&#34;æš‚æ— &#34;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 64</span><span class="cl"><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 65</span><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 66</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="err">â­</span><span class="n">groupBuyNotifyService</span><span class="p">.</span><span class="na">groupBuyNotify</span><span class="p">(</span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getNotifyUrl</span><span class="p">(),</span><span class="w"> </span><span class="n">notifyTask</span><span class="p">.</span><span class="na">getParameterJson</span><span class="p">());</span><span class="err">â­</span><span class="w"> </span><span class="c1">// è¿™é‡Œè¿›è¡Œè¿œç¨‹è°ƒç”¨</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 68</span><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isLocked</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 69</span><span class="cl"><span class="w">                    </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 70</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 71</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 72</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">NULL</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 73</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 74</span><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 75</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NotifyTaskHTTPEnumVO</span><span class="p">.</span><span class="na">NULL</span><span class="p">.</span><span class="na">getCode</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 76</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 77</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 79</span><span class="cl"><span class="w"></span><span class="c1">// OKHttpå‘é€è¯·æ±‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 80</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">groupBuyNotify</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">notifyRequestDTOJSON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 81</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="w">        </span><span class="c1">// 1. æ„å»ºå‚æ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 83</span><span class="cl"><span class="w">        </span><span class="n">MediaType</span><span class="w"> </span><span class="n">mediaType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="w">        </span><span class="n">RequestBody</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RequestBody</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">mediaType</span><span class="p">,</span><span class="w"> </span><span class="n">notifyRequestDTOJSON</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="w">        </span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Request</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">url</span><span class="p">(</span><span class="n">apiUrl</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">post</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 88</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">addHeader</span><span class="p">(</span><span class="s">&#34;content-type&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;application/json&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 89</span><span class="cl"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="w">        </span><span class="c1">// 2. è°ƒç”¨æ¥å£</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="w">        </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">okHttpClient</span><span class="p">.</span><span class="na">newCall</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="na">execute</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 94</span><span class="cl"><span class="w">        </span><span class="c1">// 3. è¿”å›ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 95</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">body</span><span class="p">().</span><span class="na">string</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 97</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;æ‹¼å›¢å›è°ƒ HTTP æ¥å£æœåŠ¡å¼‚å¸¸ {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">apiUrl</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 98</span><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AppException</span><span class="p">(</span><span class="n">ResponseCode</span><span class="p">.</span><span class="na">HTTP_EXCEPTION</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">100</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="å¾®ä¿¡æ‰«æç™»å½•æµç¨‹"><strong>å¾®ä¿¡æ‰«æç™»å½•æµç¨‹</strong><a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡æ‰«æç™»å½•æµç¨‹">#</a></h4>
<p><img alt="image-20250418182112507" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418182112507.png"></p>
<p><strong>access_tokenæ˜¯å…¬ä¼—å·</strong>çš„å…¨å±€å”¯ä¸€æ¥å£è°ƒç”¨å‡­æ®; å…¬ä¼—å·å’Œå°ç¨‹åºå‡å¯ä»¥ä½¿ç”¨AppIDå’ŒAppSecretè°ƒç”¨æœ¬æ¥å£æ¥è·å–access_tokenã€‚</p>
<ol>
<li>ç”¨æˆ·ç‚¹å‡»Webç™»å½•  =&gt; å•†æˆ·åç«¯ =&gt;  è·å–å…¬ä¼—å·ç™»å½•å‡­è¯(è¯·æ±‚å¾®ä¿¡äºŒç»´ç æ¥å£ï¼Œè·å–å¯¹åº”çš„ticketï¼Œç”¨äºè·å–å¾®ä¿¡å…¬ä¼—å·çš„äºŒç»´ç )</li>
<li>ç„¶åï¼Œå‰ç«¯æ ¹æ®ticketå»å¾®ä¿¡ç³»ç»Ÿè·å–å¯¹åº”çš„äºŒç»´ç ï¼Œè¿›è¡Œç™»å½•</li>
<li>ç™»å½•æˆåŠŸåï¼Œå¾®ä¿¡ä¼šå›è°ƒå…¬ä¼—å·å¯¹åº”çš„å›è°ƒæ¥å£ï¼Œè¿™æ—¶å€™ï¼Œåç«¯å¯ä»¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œæ¯”å¦‚&lt;ticketï¼Œ openid&gt; ï¼ˆopenidæ ‡è¯†ç”¨æˆ·ï¼‰</li>
<li>å‰ç«¯å†æ‹¿ticketè¿›è¡Œç™»å½•æ ¡éªŒï¼Œç™»å½•æˆåŠŸåï¼Œè¿”å›Tokenä»¤ç‰Œå°±å¥½äº†ã€‚</li>
</ol>
<p>â­</p>
<ul>
<li>éœ€è¦å®ç°è¯·æ±‚äºŒç»´ç ç™»å½•å‡­è¯çš„Apiæ¥å£ï¼›</li>
<li>éœ€è¦å®ç°å¾®ä¿¡ç™»å½•å›è°ƒçš„Apiæ¥å£ï¼Œä¿å­˜ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼›</li>
<li>éœ€è¦å®ç°ç”¨æˆ·ç™»å½•æ ¡éªŒçš„æ¥å£ï¼Œç”ŸæˆTokenä»¤ç‰Œï¼Œåç»­è¯·æ±‚ç”¨è¿™ä¸ªã€‚</li>
</ul>
<h4 id="å¾®ä¿¡æ”¯ä»˜æµç¨‹">å¾®ä¿¡æ”¯ä»˜æµç¨‹<a hidden class="anchor" aria-hidden="true" href="#å¾®ä¿¡æ”¯ä»˜æµç¨‹">#</a></h4>
<p><img alt="image-20250418181032363" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181032363.png"></p>
<ol>
<li>è¯·æ±‚ä¸‹å•æ¥å£ =&gt; åç«¯åˆ›å»ºè®¢å•(åˆ›å»º) =&gt; è¯·æ±‚å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿ(<strong>åˆ›å»ºæ”¯ä»˜è®¢å•</strong>),åç«¯è®¢å•(<strong>å¾…ä»˜æ¬¾</strong>)ï¼›æœ€åè¿”å›æ‹‰èµ·æ”¯ä»˜çš„å‚æ•°ï¼›</li>
</ol>
<p><img alt="image-20250418181230663" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181230663.png"></p>
<ol start="2">
<li>å°ç¨‹åºæ‹‰èµ·å¾®ä¿¡æ”¶é“¶å°</li>
</ol>
<p><img alt="image-20250418181257254" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418181257254.png"></p>
<ol start="3">
<li>å›è°ƒå°ç¨‹åºæ”¯ä»˜çŠ¶æ€ï¼Œå°ç¨‹åºæŸ¥è¯¢å•†æˆ·åç«¯è®¢å•çŠ¶æ€ =&gt; åç«¯æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜ç³»ç»Ÿ =&gt; &hellip; =&gt; è¿”å›æ”¯ä»˜çŠ¶æ€</li>
<li>ç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œä¼šå›è°ƒé€šçŸ¥å•†æˆ·åç«¯ã€‚â­éœ€è¦å®ç°å›è°ƒçš„æ¥å£ï¼Œä¿æŒæ”¯ä»˜é€šçŸ¥(æ”¹åç«¯è®¢å•çŠ¶æ€: <strong>å·²æ”¯ä»˜</strong>)</li>
<li>æœªæ”¶åˆ°å›è°ƒé€šçŸ¥ï¼Œéœ€è¦å•†æˆ·åç«¯ä¸»åŠ¨æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜çš„æŸ¥è¯¢æ¥å£ã€‚</li>
<li>è¶…æ—¶ =&gt; å•†æˆ·åç«¯ä¸»åŠ¨è°ƒç”¨å¾®ä¿¡å…³å•æ¥å£ (è®¢å•çŠ¶æ€ï¼š<strong>æ”¯ä»˜å¤±è´¥|è¶…æ—¶</strong>)</li>
<li>é€€æ¬¾ =&gt; å•†æˆ·åç«¯è¯·æ±‚å¾®ä¿¡æ”¯ä»˜é€€æ¬¾æ¥å£ (è®¢å•çŠ¶æ€ï¼š<strong>é€€æ¬¾</strong>)</li>
</ol>
<p>â­</p>
<p>éœ€è¦å®ç°çš„æ¥å£ï¼š</p>
<ul>
<li>å•†æˆ·åç«¯åˆ›å»ºåˆå§‹è®¢å•ï¼Œå¹¶è¯·æ±‚å¾®ä¿¡æ”¯ä»˜ç”Ÿæˆæ”¯ä»˜è®¢å•çš„Apiæ¥å£ï¼›(æ£€æŸ¥è®¢å•å¹‚ç­‰æ€§)</li>
<li>æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å›è°ƒçš„Apiæ¥å£ï¼Œä¿®æ”¹è®¢å•æ”¯ä»˜çŠ¶æ€ï¼›</li>
<li>ä¸»åŠ¨æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€çš„æ¥å£ï¼Œè°ƒç”¨å¾®ä¿¡æ”¯ä»˜çš„æŸ¥è¯¢æ¥å£ã€‚</li>
<li>è¶…æ—¶ =&gt; å•†æˆ·åç«¯ä¸»åŠ¨è°ƒç”¨å¾®ä¿¡å…³å•æ¥å£ (è®¢å•çŠ¶æ€ï¼š<strong>æ”¯ä»˜å¤±è´¥|è¶…æ—¶</strong>)çš„Apiæ¥å£</li>
<li>é€€æ¬¾ =&gt; å•†æˆ·åç«¯è¯·æ±‚å¾®ä¿¡æ”¯ä»˜é€€æ¬¾æ¥å£ (è®¢å•çŠ¶æ€ï¼š<strong>é€€æ¬¾</strong>)çš„Apiæ¥å£</li>
</ul>
<hr>
<h3 id="ç¬¬2-15èŠ‚æ ¹æ®uiå±•ç¤ºå°è£…æ¥å£">ç¬¬2-15èŠ‚ï¼šæ ¹æ®UIå±•ç¤ºå°è£…æ¥å£<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-15èŠ‚æ ¹æ®uiå±•ç¤ºå°è£…æ¥å£">#</a></h3>
<img src="http://verification.longcoding.top/FkdkTAEsaBL2GhNuwdj2tG7ffvcw" alt="image-20250409202305147" style="zoom:60%;" />
<img src="http://verification.longcoding.top/Fme4e2W89LK_zNSWZM_cgIPgFi5Q" alt="image-20250409202122844" style="zoom:50%;" />
<ul>
<li>
<p>ç´«è‰²åœˆï¼šæ‹¼å›¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼›</p>
</li>
<li>
<p>ç°è‰²åœˆï¼šå•†å“ä¿¡æ¯ï¼›</p>
</li>
<li>
<p>çº¢è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼ŒéšæœºæŒ‘é€‰å‡ ä¸ªå›¢ï¼›</p>
</li>
<li>
<p>ç»¿è‰²åœˆï¼šå‚ä¸æ‹¼å›¢ï¼›å•ç‹¬å¼€å§‹ä¸€ä¸ªæ–°çš„å›¢ï¼Œè¿˜æ˜¯å‚ä¸å…¶ä»–äººçš„å›¢</p>
</li>
<li>
<p>é»„è‰²åœˆï¼šæ‹¼å›¢ç»“ç®—ã€‚</p>
</li>
</ul>
<p><strong>ResponseDTO</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GoodsMarketResponseDTO</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Goods</span><span class="w"> </span><span class="n">goods</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Team</span><span class="o">&gt;</span><span class="w"> </span><span class="n">teamList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">TeamStatistic</span><span class="w"> </span><span class="n">teamStatistic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cm">     * å•†å“ä¿¡æ¯
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Goods</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">        </span><span class="c1">// å•†å“ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">goodsId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="c1">// åŸå§‹ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">originalPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="c1">// æŠ˜æ‰£é‡‘é¢</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">deductionPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">        </span><span class="c1">// æ”¯ä»˜ä»·æ ¼</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">BigDecimal</span><span class="w"> </span><span class="n">payPrice</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cm">     * ç»„é˜Ÿä¿¡æ¯
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Team</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="c1">// ç”¨æˆ·ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å•ç»„é˜ŸID</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">        </span><span class="c1">// æ´»åŠ¨ID</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">activityId</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">        </span><span class="c1">// ç›®æ ‡æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">targetCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">        </span><span class="c1">// å®Œæˆæ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">completeCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">        </span><span class="c1">// é”å•æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">lockCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å›¢å¼€å§‹æ—¶é—´ - å‚ä¸æ‹¼å›¢æ—¶é—´</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">        </span><span class="c1">// æ‹¼å›¢ç»“æŸæ—¶é—´ - æ‹¼å›¢æœ‰æ•ˆæ—¶é•¿</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span><span class="c1">// å€’è®¡æ—¶(å­—ç¬¦ä¸²) validEndTime - validStartTime</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">validTimeCountdown</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">        </span><span class="cm">/** å¤–éƒ¨äº¤æ˜“å•å·-ç¡®ä¿å¤–éƒ¨è°ƒç”¨å”¯ä¸€å¹‚ç­‰ */</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">outTradeNo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">differenceDateTime2Str</span><span class="p">(</span><span class="n">Date</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">,</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">validStartTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">validEndTime</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;æ— æ•ˆçš„æ—¶é—´&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">diffInMilliseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">validEndTime</span><span class="p">.</span><span class="na">getTime</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validStartTime</span><span class="p">.</span><span class="na">getTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="s">&#34;å·²ç»“æŸ&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">seconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toSeconds</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">60</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">minutes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toMinutes</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">60</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">hours</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toHours</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">24</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">days</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MILLISECONDS</span><span class="p">.</span><span class="na">toDays</span><span class="p">(</span><span class="n">diffInMilliseconds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&#34;%02d:%02d:%02d&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">hours</span><span class="p">,</span><span class="w"> </span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="n">seconds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="ln">81</span><span class="cl"><span class="cm">     * ç»„é˜Ÿç»Ÿè®¡
</span></span></span><span class="line"><span class="ln">82</span><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="ln">83</span><span class="cl"><span class="w">    </span><span class="nd">@Data</span><span class="w">
</span></span></span><span class="line"><span class="ln">84</span><span class="cl"><span class="w">    </span><span class="nd">@Builder</span><span class="w">
</span></span></span><span class="line"><span class="ln">85</span><span class="cl"><span class="w">    </span><span class="nd">@AllArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">86</span><span class="cl"><span class="w">    </span><span class="nd">@NoArgsConstructor</span><span class="w">
</span></span></span><span class="line"><span class="ln">87</span><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">TeamStatistic</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">88</span><span class="cl"><span class="w">        </span><span class="c1">// å¼€å›¢é˜Ÿä¼æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">89</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">90</span><span class="cl"><span class="w">        </span><span class="c1">// æˆå›¢é˜Ÿä¼æ•°é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln">91</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamCompleteCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">92</span><span class="cl"><span class="w">        </span><span class="c1">// å‚å›¢äººæ•°æ€»é‡ - ä¸€ä¸ªå•†å“çš„æ€»å‚å›¢äººæ•°</span><span class="w">
</span></span></span><span class="line"><span class="ln">93</span><span class="cl"><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">allTeamUserCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">94</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">95</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">96</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// å¢åˆ æ”¹æŸ¥</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// æ³¨æ„ï¼šTeamçš„æŸ¥è¯¢</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="c1">// 1. å…ˆæŸ¥è‡ªå·±çš„æ‹¼å›¢</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="c1">// 2. æŸ¥å…¶ä»–äººçš„æ‹¼å›¢ã€‚å¯¹åº”æ´»åŠ¨ï¼Œéå½“å‰ç”¨æˆ·ï¼ŒçŠ¶æ€ä¸ºå¯åŠ å…¥æ‹¼å›¢ï¼Œæ—¶é—´æœ‰æ•ˆï¼Œé˜Ÿä¼in(å¯¹åº”æ´»åŠ¨ï¼Œä¸”é”å•äººæ•°å°äºç›®æ ‡äººæ•°)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">UserGroupBuyOrderDetailEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">queryInProgressUserGroupBuyOrderDetailListByRandom</span><span class="p">(</span><span class="n">Long</span><span class="w"> </span><span class="n">activityId</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">userId</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">randomCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="c1">// 1. æ ¹æ®ç”¨æˆ·IDã€æ´»åŠ¨IDã€æŸ¥è¯¢éå½“å‰ç”¨æˆ·å‚ä¸çš„æ‹¼å›¢é˜Ÿä¼</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">    </span><span class="n">GroupBuyOrderList</span><span class="w"> </span><span class="n">buyOrderListReq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GroupBuyOrderList</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">activityId</span><span class="p">(</span><span class="n">activityId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="n">buyOrderListReq</span><span class="p">.</span><span class="na">setCount</span><span class="p">(</span><span class="n">randomCount</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// æŸ¥è¯¢ä¸¤å€çš„é‡ï¼Œå†éšæœºå–ä¸€åŠ</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 1. ==ActivityId; 2. !=userId 3; status == 0 or 1; 4. endTime &gt; now(); 5. teamId in (select teamId from group_buy_order where status = 0 and activity = #{activity})</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GroupBuyOrderList</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderListDao</span><span class="p">.</span><span class="na">queryInProgressUserGroupBuyOrderDetailListByRandom</span><span class="p">(</span><span class="n">buyOrderListReq</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="c1">// éšæœºé€‰ randomCount æ¡</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">randomCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">        </span><span class="n">Collections</span><span class="p">.</span><span class="na">shuffle</span><span class="p">(</span><span class="n">groupBuyOrderLists</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">        </span><span class="n">groupBuyOrderLists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">subList</span><span class="p">(</span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">randomCount</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="c1">// 2. è¿‡æ»¤é˜Ÿä¼è·å– TeamId</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w">    </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">teamIds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderLists</span><span class="p">.</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">GroupBuyOrderList</span><span class="p">::</span><span class="n">getTeamId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">teamId</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">teamId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">teamId</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toSet</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">    </span><span class="c1">// 3. æŸ¥è¯¢é˜Ÿä¼æ˜ç»†ï¼Œç»„è£…Mapç»“æ„</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">GroupBuyOrder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrderDao</span><span class="p">.</span><span class="na">queryGroupBuyProgressByTeamIds</span><span class="p">(</span><span class="n">teamIds</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">groupBuyOrders</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">GroupBuyOrder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">groupBuyOrderMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyOrders</span><span class="p">.</span><span class="na">stream</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toMap</span><span class="p">(</span><span class="n">GroupBuyOrder</span><span class="p">::</span><span class="n">getTeamId</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">order</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">    </span><span class="c1">// 4. è½¬æ¢æ•°æ®</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">    </span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">UserGroupBuyOrderDetailEntity</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userGroupBuyOrderDetailEntities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w"> 	</span><span class="c1">// ... æ ¹æ® groupBuyOrders å’Œ groupBuyOrderListsç»„è£…ç»“æœ</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">userGroupBuyOrderDetailEntities</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">// é”å• æ¥å£</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="err">â¬‡</span><span class="n">ï¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="c1">// outTradeNo - è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ç”Ÿæˆ</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w"></span><span class="err">â¬‡</span><span class="n">ï¸</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="c1">// ç»“ç®— æ¥å£</span><span class="w">
</span></span></span></code></pre></div><img src="http://verification.longcoding.top/FkDcIvtAlVhuiv8qwR_H_GNQcGtm" alt="image-20250410001830020" style="zoom:50%;" />
<hr>
<h3 id="ç¬¬2-16èŠ‚-ç‹¬å é”å’Œæ— é”åŒ–">ç¬¬2-16èŠ‚ ç‹¬å é”å’Œæ— é”åŒ–<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2-16èŠ‚-ç‹¬å é”å’Œæ— é”åŒ–">#</a></h3>
<p>ä¸€ä¸ªåº“å­˜ä¸€ä¸ªé”ï¼Œæœ€å°åŒ–é”çš„ç²’åº¦ï¼Œä½¿ç”¨occupyCount +  recoveryCount åˆ¤æ–­åº“å­˜ã€‚å› ä¸ºä¹‹å‰çš„çº¿ç¨‹æŠ¢å äº†åº“å­˜ï¼Œä½†æ˜¯æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦æ¢å¤è¢«æŠ¢å çš„åº“å­˜é‡ã€‚</p>
<p><img alt="image-20250418205449507" loading="lazy" src="c:\\Users\\éŸ¦é¾™\\AppData\\Roaming\\Typora\\typora-user-images\\image-20250418205449507.png"></p>
<p>**ç‹¬å é”ï¼š**å¤šä¸ªæœåŠ¡å‡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œä»…ä¸€ä¸ªæœåŠ¡æ‰§è¡Œå³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;0 0 0 * * ?&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">exec</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="s">&#34;group_buy_market_notify_job_exec&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">        </span><span class="c1">// ç­‰å¾…æ—¶é—´(è‹¥è¢«å ç”¨ç­‰å¾…3ç§’)ï¼Œé”çš„è¿‡æœŸæ—¶é—´(0è¡¨ç¤ºéœ€è¦æ‰‹åŠ¨é‡Šæ”¾)</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="n">3</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isLocked</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tradeSettlementOrderService</span><span class="p">.</span><span class="na">execSettlementNotifyJob</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;å®šæ—¶ä»»åŠ¡ï¼Œå›è°ƒé€šçŸ¥æ‹¼å›¢å®Œç»“ä»»åŠ¡ result:{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">JSON</span><span class="p">.</span><span class="na">toJSONString</span><span class="p">(</span><span class="n">result</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&#34;å®šæ—¶ä»»åŠ¡ï¼Œå›è°ƒé€šçŸ¥æ‹¼å›¢å®Œç»“ä»»åŠ¡å¤±è´¥&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isLocked</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">            </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>ä¹è§‚é”ï¼š</strong></p>
<p>å°†åº“å­˜çš„éš”ç¦»è¿›è¡Œåˆ†æ®µåŒ–ï¼Œä¸€ä¸ªåº“å­˜è¡¨ç¤ºä¸€ä¸ªé”</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="c1">// æ‹¼å›¢äººæ•°æ£€æŸ¥-æ˜¯å¦å·²æ»¡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="c1">// 1. teamId ä¸ºç©ºï¼Œåˆ™ä¸ºé¦–æ¬¡å¼€å›¢ï¼Œä¸åšæ‹¼å›¢ç»„é˜Ÿç›®æ ‡é‡åº“å­˜é™åˆ¶</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">teamId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">requestParameter</span><span class="p">.</span><span class="na">getTeamId</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">teamId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TradeLockRuleFilterBackEntity</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">userTakeOrderCount</span><span class="p">(</span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getUserTakeOrderCount</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w"></span><span class="c1">// 2. æŠ¢å åº“å­˜ï¼›é€šè¿‡æŠ¢å  Redis ç¼“å­˜åº“å­˜ï¼Œæ¥é™ä½å¯¹æ•°æ®åº“çš„æ“ä½œå‹åŠ›ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="c1">// ä¸Šä¸‹æ–‡ä¿¡æ¯</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="n">GroupBuyActivityEntity</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">getGroupBuyActivity</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getTarget</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w"></span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">groupBuyActivity</span><span class="p">.</span><span class="na">getValidTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">teamStockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">generateTeamStockKey</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dynamicContext</span><span class="p">.</span><span class="na">generateRecoveryTeamStockKey</span><span class="p">(</span><span class="n">teamId</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w"></span><span class="c1">// æŠ¢å åº“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="kt">boolean</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repository</span><span class="p">.</span><span class="na">occupyTeamStock</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">validTime</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æŠ¢å åº“å­˜</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">occupyTeamStock</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w">    </span><span class="c1">// å¤±è´¥æ¢å¤é‡</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">    </span><span class="n">Long</span><span class="w"> </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">getAtomicLong</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">recoveryCount</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">recoveryCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">    </span><span class="c1">// 1. incr å¾—åˆ°å€¼ï¼Œä¸æ€»é‡å’Œæ¢å¤é‡åšå¯¹æ¯”ã€‚æ¢å¤é‡ä¸ºç³»ç»Ÿå¤±è´¥æ—¶å€™è®°å½•çš„é‡ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">    </span><span class="c1">// 2. ä»æœ‰ç»„é˜Ÿé‡å¼€å§‹ï¼Œç›¸å½“äºå·²ç»æœ‰äº†ä¸€ä¸ªå ç”¨é‡ï¼Œæ‰€ä»¥è¦ +1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">occupy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">incr</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">occupy</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">recoveryCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">        </span><span class="n">redisService</span><span class="p">.</span><span class="na">setAtomicLong</span><span class="p">(</span><span class="n">teamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">    </span><span class="c1">// 1. ç»™æ¯ä¸ªäº§ç”Ÿçš„å€¼åŠ é”ä¸ºå…œåº•è®¾è®¡ï¼Œè™½ç„¶incræ“ä½œæ˜¯åŸå­çš„ï¼ŒåŸºæœ¬ä¸ä¼šäº§ç”Ÿä¸€æ ·çš„å€¼ã€‚ä½†åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œé‡åˆ°è¿‡é›†ç¾¤çš„è¿ç»´é…ç½®é—®é¢˜ï¼Œä»¥åŠä¸šåŠ¡è¿è¥é…ç½®æ•°æ®é—®é¢˜ï¼Œå¯¼è‡´incrå¾—åˆ°çš„å€¼ç›¸åŒã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">    </span><span class="c1">// 2. validTime + 60åˆ†é’Ÿï¼Œæ˜¯ä¸€ä¸ªå»¶åæ—¶é—´çš„è®¾è®¡ï¼Œè®©æ•°æ®ä¿ç•™æ—¶é—´ç¨å¾®é•¿ä¸€äº›ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">teamStockKey</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">UNDERLINE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">occupy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">    </span><span class="n">Boolean</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisService</span><span class="p">.</span><span class="na">setNx</span><span class="p">(</span><span class="n">lockKey</span><span class="p">,</span><span class="w"> </span><span class="n">validTime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">60</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">lock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&#34;ç»„é˜Ÿåº“å­˜åŠ é”å¤±è´¥ {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">lockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">lock</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ¢å¤åº“å­˜ &lt;= ä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦è¿›è¡Œåº“å­˜çš„æ¢å¤ï¼</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="ln">1</span><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">recoveryTeamStock</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">recoveryTeamStockKey</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">validTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="c1">// é¦–æ¬¡ç»„é˜Ÿæ‹¼å›¢ï¼Œæ˜¯æ²¡æœ‰ teamId çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦è¿™ä¸ªåšå¤„ç†ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">isBlank</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="n">redisService</span><span class="p">.</span><span class="na">incr</span><span class="p">(</span><span class="n">recoveryTeamStockKey</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://longcoding.top/tags/projects/">Projects</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://longcoding.top/posts/jobs/mq/">
    <span class="title">Â« Prev</span>
    <br>
    <span>æ¶ˆæ¯é˜Ÿåˆ—é¢è¯•é¢˜</span>
  </a>
  <a class="next" href="http://longcoding.top/posts/learning/common_commands/">
    <span class="title">Next Â»</span>
    <br>
    <span>Linux&amp;Docker&amp;Shellå‘½ä»¤</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://longcoding.top/">LongCoding&#39;s Blog</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
